<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_45.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-45 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The step-45 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_6.html">step-6</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Settingupperiodicityconstraintsondistributedtriangulations">Setting up periodicity constraints on distributed triangulations</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br />
</p>
<p><em>This program was contributed by Daniel Arndt and Matthias Maier.</em> <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>In this example we present how to use periodic boundary conditions in deal.II. Periodic boundary conditions are algebraic constraints that typically occur in computations on representative regions of a larger domain that repeat in one or more directions.</p>
<p>An example is the simulation of the electronic structure of photonic crystals, because they have a lattice-like structure and, thus, it often suffices to do the actual computation on only one box of the lattice. To be able to proceed this way one has to assume that the model can be periodically extended to the other boxes; this requires the solution to have a periodic structure.</p>
<p><a class="anchor" id="Procedure"></a> <a class="anchor" id="Procedure"></a></p><h1>Procedure</h1>
<p>deal.II provides a number of high level entry points to impose periodic boundary conditions. The general approach to apply periodic boundary conditions consists of three steps (see also the <a class="el" href="DEALGlossary.html#GlossPeriodicConstraints">Glossary entry on periodic boundary conditions</a>):</p><ol type="1">
<li>Create a mesh</li>
<li>Identify those pairs of faces on different parts of the boundary across which the solution should be symmetric, using <a class="el" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces()</a></li>
<li>Add the periodicity information to the mesh using <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html#aa7b797070e5443a18f03a4a7f0267453">parallel::distributed::Triangulation::add_periodicity()</a></li>
<li>Add periodicity constraints using <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints()</a></li>
</ol>
<p>The second and third step are necessary for parallel meshes using the <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a> class to ensure that cells on opposite sides of the domain but connected by periodic faces are part of the ghost layer if one of them is stored on the local processor. If the <a class="el" href="classTriangulation.html">Triangulation</a> is not a <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a>, these steps are not necessary.</p>
<p>The first step consists of collecting matching periodic faces and storing them in a <code>std::vector</code> of <a class="el" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>. This is done with the function <a class="el" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces()</a> that can be invoked for example like this: </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  b_id1,</div><div class="line">                                  b_id2,</div><div class="line">                                  direction,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  offset = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                                  <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                                  first_vector_components = &lt;<span class="keywordflow">default</span> value&gt;);</div></div><!-- fragment --><p>This call loops over all faces of the container dof_handler on the periodic boundaries with boundary indicator <code>b_id1</code> and <code>b_id2</code>, respectively. (You can assign these boundary indicators by hand after creating the coarse mesh, see <a class="el" href="DEALGlossary.html#GlossBoundaryIndicator">Boundary indicator</a>. Alternatively, you can also let many of the functions in namespace <a class="el" href="namespaceGridGenerator.html">GridGenerator</a> do this for if you specify the "colorize" flag; in that case, these functions will assign different boundary indicators to different parts of the boundary, with the details typically spelled out in the documentation of these functions.)</p>
<p>Concretely, if \(\text{vertices}_{1/2}\) are the vertices of two faces \(\text{face}_{1/2}\), then the function call above will match pairs of faces (and dofs) such that the difference between \(\text{vertices}_2\) and \(matrix\cdot \text{vertices}_1+\text{offset}\) vanishes in every component apart from direction and stores the resulting pairs with associated data in <code>matched_pairs</code>. (See <a class="el" href="namespaceGridTools.html#ac2a1903382c6cff07b33d456a641f6d9">GridTools::orthogonal_equality()</a> for detailed information about the matching process.)</p>
<p>Consider, for example, the colored unit square \(\Omega=[0,1]^2\) with boundary indicator 0 on the left, 1 on the right, 2 on the bottom and 3 on the top faces. (See the documentation of <a class="el" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube()</a> for this convention on how boundary indicators are assigned.) Then, </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*direction*/</span> 0,</div><div class="line">                                  matched_pairs);</div></div><!-- fragment --><p> would yield periodicity constraints such that \(u(0,y)=u(1,y)\) for all \(y\in[0,1]\).</p>
<p>If we instead consider the parallelogram given by the convex hull of \((0,0)\), \((1,1)\), \((1,2)\), \((0,1)\) we can achieve the constraints \(u(0,y)=u(1,y+1)\) by specifying an <code>offset:</code> </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*direction*/</span> 0,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, 2&gt;</a>(0.,1.));</div></div><!-- fragment --><p> or </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*arbitrary direction*/</span> 0,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, 2&gt;</a>(1.,1.));</div></div><!-- fragment --><p> Here, again, the assignment of boundary indicators 0 and 1 stems from what <a class="el" href="namespaceGridGenerator.html#a324b8447f05b148e2f58bdbcf89f5325">GridGenerator::parallelogram()</a> documents.</p>
<p>The resulting <code>matched_pairs</code> can be used in <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> for populating an <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object with periodicity constraints: </p><div class="fragment"><div class="line"><a class="code" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a>(matched_pairs, constraints);</div></div><!-- fragment --><p>Apart from this high level interface there are also variants of <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> available that combine those two steps (see the variants of DofTools::make_periodicity_constraints).</p>
<p>There is also a low level interface to <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> if more flexibility is needed. The low level variant allows to directly specify two faces that shall be constrained: </p><div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceDoFTools.html">DoFTools</a>;</div><div class="line"><a class="code" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">make_periodicity_constraints</a>(face_1,</div><div class="line">                             face_2,</div><div class="line">                             affine_constraints,</div><div class="line">                             component_mask = &lt;<span class="keywordflow">default</span> value&gt;;</div><div class="line">                             face_orientation = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             face_flip = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             face_rotation = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> = &lt;<span class="keywordflow">default</span> value&gt;);</div></div><!-- fragment --><p> Here, we need to specify the orientation of the two faces using <code>face_orientation</code>, <code>face_flip</code> and <code>face_orientation</code>. For a closer description have a look at the documentation of <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a>. The remaining parameters are the same as for the high level interface apart from the self-explaining <code>component_mask</code> and <code>affine_constraints</code>.</p>
<p><a class="anchor" id="problem"></a> <a class="anchor" id="Apracticalexample"></a></p><h1>A practical example</h1>
<p>In the following, we show how to use the above functions in a more involved example. The task is to enforce rotated periodicity constraints for the velocity component of a Stokes flow.</p>
<p>On a quarter-circle defined by \(\Omega=\{{\bf x}\in(0,1)^2:\|{\bf x}\|\in (0.5,1)\}\) we are going to solve the Stokes problem </p><p class="formulaDsp">
\begin{eqnarray*} -\Delta \; \textbf{u} + \nabla p &amp;=&amp; (\exp(-100\|{\bf x}-(.75,0.1)^T\|^2),0)^T, \\ -\textrm{div}\; \textbf{u}&amp;=&amp;0,\\ \textbf{u}|_{\Gamma_1}&amp;=&amp;{\bf 0}, \end{eqnarray*}
</p>
<p> where the boundary \(\Gamma_1\) is defined as \(\Gamma_1 \dealcoloneq \{x\in \partial\Omega: \|x\|\in\{0.5,1\}\}\). For the remaining parts of the boundary we are going to use periodic boundary conditions, i.e. </p><p class="formulaDsp">
\begin{align*} u_x(0,\nu)&amp;=-u_y(\nu,0)&amp;\nu&amp;\in[0,1]\\ u_y(0,\nu)&amp;=u_x(\nu,0)&amp;\nu&amp;\in[0,1]. \end{align*}
</p>
<p>The mesh will be generated by <a class="el" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell()</a>, which also documents how it assigns boundary indicators to its various boundaries if its <code>colorize</code> argument is set to <code>true</code>.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p>This example program is a slight modification of <a class="el" href="step_22.html">step-22</a> running in parallel using Trilinos to demonstrate the usage of periodic boundary conditions in deal.II. We thus omit to discuss the majority of the source code and only comment on the parts that deal with periodicity constraints. For the rest have a look at <a class="el" href="step_22.html">step-22</a> and the full source code at the bottom.</p>
<p>In order to implement periodic boundary conditions only two functions have to be modified:</p><ul>
<li><code>StokesProblem&lt;dim&gt;::setup_dofs()</code>: To populate an <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object with periodicity constraints</li>
<li><code>StokesProblem&lt;dim&gt;::create_mesh()</code>: To supply a distributed triangulation with periodicity information.</li>
</ul>
<p>The rest of the program is identical to <a class="el" href="step_22.html">step-22</a>, so let us skip this part and only show these two functions in the following. (The full program can be found in the "Plain program" section below, though.)</p>
<p><a class="anchor" id="Settingupperiodicityconstraintsondistributedtriangulations"></a> </p><h3>Setting up periodicity constraints on distributed triangulations</h3>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::create_mesh()</div><div class="line">{</div><div class="line">  <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> inner_radius = .5;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> outer_radius = 1.;</div><div class="line"></div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell</a>(</div><div class="line">    triangulation, center, inner_radius, outer_radius, 0, <span class="keyword">true</span>);</div></div><!-- fragment --><p>Before we can prescribe periodicity constraints, we need to ensure that cells on opposite sides of the domain but connected by periodic faces are part of the ghost layer if one of them is stored on the local processor. At this point we need to think about how we want to prescribe periodicity. The vertices \(\text{vertices}_2\) of a face on the left boundary should be matched to the vertices \(\text{vertices}_1\) of a face on the lower boundary given by \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) where the rotation matrix \(R\) and the offset \(b\) are given by </p><p class="formulaDsp">
\begin{align*} R=\begin{pmatrix} 0&amp;1\\-1&amp;0 \end{pmatrix}, \quad b=\begin{pmatrix}0&amp;0\end{pmatrix}. \end{align*}
</p>
<p> The data structure we are saving the resulting information into is here based on the <a class="el" href="classTriangulation.html">Triangulation</a>.</p>
<div class="fragment"><div class="line">std::vector&lt;<a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;</div><div class="line">  <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga48cef91f67c38d6ec17912922de00f90">parallel::distributed::Triangulation&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">  periodicity_vector;</div><div class="line"></div><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">rotation_matrix[0][1] = 1.;</div><div class="line">rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(triangulation,</div><div class="line">                                  2,</div><div class="line">                                  3,</div><div class="line">                                  1,</div><div class="line">                                  periodicity_vector,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(),</div><div class="line">                                  rotation_matrix);</div></div><!-- fragment --><p>Now telling the triangulation about the desired periodicity is particularly easy by just calling <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html#aa7b797070e5443a18f03a4a7f0267453">parallel::distributed::Triangulation::add_periodicity</a>.</p>
<div class="fragment"><div class="line">  triangulation.<a class="code" href="classTriangulation.html#adbf04756b28dae69194870812acaf941">add_periodicity</a>(periodicity_vector);</div><div class="line"></div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(4 - dim);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs()</div><div class="line">{</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">  std::vector&lt;unsigned int&gt; block_component(dim + 1, 0);</div><div class="line">  block_component[dim] = 1;</div><div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0], n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">  {</div><div class="line">    owned_partitioning.clear();</div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">    owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">    owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">    relevant_partitioning.<a class="code" href="classIndexSet.html#a8a3d75a9cba3f1a50866691327aa7609">clear</a>();</div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">    <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler,</div><div class="line">                                            locally_relevant_dofs);</div><div class="line">    relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">    relevant_partitioning.push_back(</div><div class="line">      locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">    constraints.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div><div class="line">    constraints.<a class="code" href="classAffineConstraints.html#a2c9d71b5b7e8851c25a411ccf34de986">reinit</a>(locally_relevant_dofs);</div><div class="line"></div><div class="line">    <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             0,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             1,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div></div><!-- fragment --><p>After we provided the mesh with the necessary information for the periodicity constraints, we are now able to actual create them. For describing the matching we are using the same approach as before, i.e., the \(\text{vertices}_2\) of a face on the left boundary should be matched to the vertices \(\text{vertices}_1\) of a face on the lower boundary given by \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) where the rotation matrix \(R\) and the offset \(b\) are given by </p><p class="formulaDsp">
\begin{align*} R=\begin{pmatrix} 0&amp;1\\-1&amp;0 \end{pmatrix}, \quad b=\begin{pmatrix}0&amp;0\end{pmatrix}. \end{align*}
</p>
<p> These two objects not only describe how faces should be matched but also in which sense the solution should be transformed from \(\text{face}_2\) to \(\text{face}_1\).</p>
<div class="fragment"><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">rotation_matrix[0][1] = 1.;</div><div class="line">rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line"><a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> offset;</div></div><!-- fragment --><p>For setting up the constraints, we first store the periodicity information in an auxiliary object of type <code>std::vector&lt;<a class="el" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;typename <a class="el" href="classDoFHandler.html">DoFHandler</a>&lt;dim&gt;::cell_iterator&gt; </code>. The periodic boundaries have the boundary indicators 2 (x=0) and 3 (y=0). All the other parameters we have set up before. In this case the direction does not matter. Due to \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) this is exactly what we want.</p>
<div class="fragment"><div class="line">std::vector&lt;</div><div class="line">  <a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">  periodicity_vector;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> direction = 1;</div><div class="line"></div><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  2,</div><div class="line">                                  3,</div><div class="line">                                  direction,</div><div class="line">                                  periodicity_vector,</div><div class="line">                                  offset,</div><div class="line">                                  rotation_matrix);</div></div><!-- fragment --><p>Next, we need to provide information on which vector valued components of the solution should be rotated. Since we choose here to just constraint the velocity and this starts at the first component of the solution vector, we simply insert a 0:</p>
<div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; first_vector_components;</div><div class="line">first_vector_components.push_back(0);</div></div><!-- fragment --><p>After setting up all the information in periodicity_vector all we have to do is to tell make_periodicity_constraints to create the desired constraints.</p>
<div class="fragment"><div class="line">    DoFTools::make_periodicity_constraints&lt;dim, dim&gt;(periodicity_vector,</div><div class="line">                                                     constraints,</div><div class="line">                                                     fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(</div><div class="line">                                                       velocities),</div><div class="line">                                                     first_vector_components);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             0,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             1,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">  }</div><div class="line"></div><div class="line">  constraints.close();</div><div class="line"></div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> bsp(owned_partitioning,</div><div class="line">                                               owned_partitioning,</div><div class="line">                                               relevant_partitioning,</div><div class="line">                                               mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">        <span class="keywordflow">if</span> (!((c == dim) &amp;&amp; (d == dim)))</div><div class="line">          coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    coupling,</div><div class="line">                                    bsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="keyword">false</span>,</div><div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                      mpi_communicator));</div><div class="line"></div><div class="line">    bsp.compress();</div><div class="line"></div><div class="line">    system_matrix.reinit(bsp);</div><div class="line">  }</div><div class="line"></div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> preconditioner_bsp(</div><div class="line">      owned_partitioning,</div><div class="line">      owned_partitioning,</div><div class="line">      relevant_partitioning,</div><div class="line">      mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(dim + 1, dim + 1);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">        <span class="keywordflow">if</span> ((c == dim) &amp;&amp; (d == dim))</div><div class="line">          preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    preconditioner_coupling,</div><div class="line">                                    preconditioner_bsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="keyword">false</span>,</div><div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                      mpi_communicator));</div><div class="line"></div><div class="line">    preconditioner_bsp.compress();</div><div class="line"></div><div class="line">    preconditioner_matrix.reinit(preconditioner_bsp);</div><div class="line">  }</div><div class="line"></div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">  solution.reinit(owned_partitioning,</div><div class="line">                  relevant_partitioning,</div><div class="line">                  mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>The rest of the program is then again identical to <a class="el" href="step_22.html">step-22</a>. We will omit it here now, but as before, you can find these parts in the "Plain program" section below.</p>
<p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>The created output is not very surprising. We simply see that the solution is periodic with respect to the left and lower boundary:</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-45.periodic.png"/>
</div>
<p>Without the periodicity constraints we would have ended up with the following solution:</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-45.non_periodic.png"/>
</div>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2008 - 2020 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Daniel Arndt, Matthias Maier, 2015</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Based on @ref step_22 &quot;step-22&quot; by Wolfgang Bangerth and Martin Kronbichler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__solver_8h.html">deal.II/lac/trilinos_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step45</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>StokesProblem</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree);</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> create_mesh();</div><div class="line">    <span class="keywordtype">void</span> setup_dofs();</div><div class="line">    <span class="keywordtype">void</span> assemble_system();</div><div class="line">    <span class="keywordtype">void</span> solve();</div><div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">void</span> refine_mesh();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree;</div><div class="line"></div><div class="line">    <a class="code" href="classMPI__Comm.html">MPI_Comm</a> mpi_communicator;</div><div class="line"></div><div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line">    std::vector&lt;IndexSet&gt;     owned_partitioning;</div><div class="line">    std::vector&lt;IndexSet&gt;     relevant_partitioning;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> system_matrix;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> solution;</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> system_rhs;</div><div class="line"></div><div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line"></div><div class="line">    <a class="code" href="classMappingQ.html">MappingQ&lt;dim&gt;</a> mapping;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>BoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BoundaryValues()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> BoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    (void)component;</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;n_components,</div><div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(component, 0, this-&gt;n_components));</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BoundaryValues&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                         Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div><div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>(c) = BoundaryValues&lt;dim&gt;::value(p, c);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>(0.75, 0.1);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>     r = (p - <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>).<a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (component == 0)</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="vectorization_8h.html#a19f846bda83b7e3f4531daacb40c64e1">std::exp</a>(-100. * r * r);</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div><div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>(c) = RightHandSide&lt;dim&gt;::value(p, c);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        m,</div><div class="line">                  <span class="keyword">const</span> PreconditionerType &amp;preconditioner,</div><div class="line">                  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;          locally_owned,</div><div class="line">                  <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;          mpi_communicator);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> vmult(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a>         <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const PreconditionerType&gt;</a> preconditioner;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> *                      mpi_communicator;</div><div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div><div class="line">    <span class="keyword">const</span> MatrixType &amp;        m,</div><div class="line">    <span class="keyword">const</span> PreconditionerType &amp;preconditioner,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;          locally_owned,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;          mpi_communicator)</div><div class="line">    : matrix(&amp;m)</div><div class="line">    , preconditioner(&amp;preconditioner)</div><div class="line">    , mpi_communicator(&amp;mpi_communicator)</div><div class="line">    , tmp(locally_owned, mpi_communicator)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keywordtype">void</span> InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult(</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>              solver_control(src.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a78fa29403bbd6da7795fd25700267d47">size</a>(), 1e-6 * src.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a5680a0f82a28f0b980d83f3443cc20ca">l2_norm</a>());</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1SolverCG.html">TrilinosWrappers::SolverCG</a> cg(solver_control,</div><div class="line">                                  <a class="code" href="structTrilinosWrappers_1_1SolverCG_1_1AdditionalData.html">TrilinosWrappers::SolverCG::AdditionalData</a>());</div><div class="line"></div><div class="line">    tmp = 0.;</div><div class="line">    cg.solve(*matrix, tmp, src, *preconditioner);</div><div class="line">    dst = tmp;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keyword">class </span>SchurComplement : <span class="keyword">public</span> TrilinosWrappers::SparseMatrix</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    SchurComplement(<span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;system_matrix,</div><div class="line">                    <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</div><div class="line">                                        PreconditionerType&gt; &amp;  A_inverse,</div><div class="line">                    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;                           owned_pres,</div><div class="line">                    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;mpi_communicator);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="structSUNDIALS_1_1SundialsPreconditioner.html#aff5a880cfa288ecdd2a83a876abacf0d">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a> system_matrix;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;</div><div class="line">      <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix, PreconditionerType&gt;&gt;</div><div class="line">                                          A_inverse;</div><div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp1, tmp2;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  SchurComplement&lt;PreconditionerType&gt;::SchurComplement(</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;system_matrix,</div><div class="line">    <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix, PreconditionerType&gt;</div><div class="line">      &amp;             A_inverse,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;owned_vel,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;mpi_communicator)</div><div class="line">    : system_matrix(&amp;system_matrix)</div><div class="line">    , A_inverse(&amp;A_inverse)</div><div class="line">    , tmp1(owned_vel, mpi_communicator)</div><div class="line">    , tmp2(tmp1)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keywordtype">void</span> SchurComplement&lt;PreconditionerType&gt;::vmult(</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    system_matrix-&gt;block(0, 1).vmult(tmp1, src);</div><div class="line">    A_inverse-&gt;vmult(tmp2, tmp1);</div><div class="line">    system_matrix-&gt;block(1, 0).vmult(dst, tmp2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  StokesProblem&lt;dim&gt;::StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree)</div><div class="line">    : degree(degree)</div><div class="line">    , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">    , triangulation(mpi_communicator)</div><div class="line">    , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(degree + 1), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(degree), 1)</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , pcout(<a class="code" href="namespacestd.html">std</a>::cout, <a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0)</div><div class="line">    , mapping(degree + 1)</div><div class="line">  {}</div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::create_mesh()</div><div class="line">  {</div><div class="line">    <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> inner_radius = .5;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> outer_radius = 1.;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell</a>(</div><div class="line">      triangulation, center, inner_radius, outer_radius, 0, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    std::vector&lt;<a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;</div><div class="line">      <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga48cef91f67c38d6ec17912922de00f90">parallel::distributed::Triangulation&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">      periodicity_vector;</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">    rotation_matrix[0][1] = 1.;</div><div class="line">    rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(triangulation,</div><div class="line">                                      2,</div><div class="line">                                      3,</div><div class="line">                                      1,</div><div class="line">                                      periodicity_vector,</div><div class="line">                                      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(),</div><div class="line">                                      rotation_matrix);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#adbf04756b28dae69194870812acaf941">add_periodicity</a>(periodicity_vector);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(4 - dim);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs()</div><div class="line">  {</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    std::vector&lt;unsigned int&gt; block_component(dim + 1, 0);</div><div class="line">    block_component[dim] = 1;</div><div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0], n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">    {</div><div class="line">      owned_partitioning.clear();</div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">      owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">      owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">      relevant_partitioning.<a class="code" href="classIndexSet.html#a8a3d75a9cba3f1a50866691327aa7609">clear</a>();</div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">      <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler,</div><div class="line">                                              locally_relevant_dofs);</div><div class="line">      relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">      relevant_partitioning.push_back(</div><div class="line">        locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">      constraints.clear();</div><div class="line">      constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               1,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"></div><div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">      rotation_matrix[0][1] = 1.;</div><div class="line">      rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line">      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> offset;</div><div class="line"></div><div class="line">      std::vector&lt;</div><div class="line">        <a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">        periodicity_vector;</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> direction = 1;</div><div class="line"></div><div class="line">      <a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                        2,</div><div class="line">                                        3,</div><div class="line">                                        direction,</div><div class="line">                                        periodicity_vector,</div><div class="line">                                        offset,</div><div class="line">                                        rotation_matrix);</div><div class="line"></div><div class="line">      std::vector&lt;unsigned int&gt; first_vector_components;</div><div class="line">      first_vector_components.push_back(0);</div><div class="line"></div><div class="line">      DoFTools::make_periodicity_constraints&lt;dim, dim&gt;(periodicity_vector,</div><div class="line">                                                       constraints,</div><div class="line">                                                       fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(</div><div class="line">                                                         velocities),</div><div class="line">                                                       first_vector_components);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               1,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    }</div><div class="line"></div><div class="line">    constraints.close();</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> bsp(owned_partitioning,</div><div class="line">                                                 owned_partitioning,</div><div class="line">                                                 relevant_partitioning,</div><div class="line">                                                 mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (!((c == dim) &amp;&amp; (d == dim)))</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                      coupling,</div><div class="line">                                      bsp,</div><div class="line">                                      constraints,</div><div class="line">                                      <span class="keyword">false</span>,</div><div class="line">                                      <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                        mpi_communicator));</div><div class="line"></div><div class="line">      bsp.compress();</div><div class="line"></div><div class="line">      system_matrix.reinit(bsp);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> preconditioner_bsp(</div><div class="line">        owned_partitioning,</div><div class="line">        owned_partitioning,</div><div class="line">        relevant_partitioning,</div><div class="line">        mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> ((c == dim) &amp;&amp; (d == dim))</div><div class="line">            preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                      preconditioner_coupling,</div><div class="line">                                      preconditioner_bsp,</div><div class="line">                                      constraints,</div><div class="line">                                      <span class="keyword">false</span>,</div><div class="line">                                      <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                        mpi_communicator));</div><div class="line"></div><div class="line">      preconditioner_bsp.compress();</div><div class="line"></div><div class="line">      preconditioner_matrix.reinit(preconditioner_bsp);</div><div class="line">    }</div><div class="line"></div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">    solution.reinit(owned_partitioning,</div><div class="line">                    relevant_partitioning,</div><div class="line">                    mpi_communicator);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">  {</div><div class="line">    system_matrix         = 0.;</div><div class="line">    system_rhs            = 0.;</div><div class="line">    preconditioner_matrix = 0.;</div><div class="line"></div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(degree + 2);</div><div class="line"></div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(mapping,</div><div class="line">                            fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_preconditioner_matrix(dofs_per_cell,</div><div class="line">                                                   dofs_per_cell);</div><div class="line">    Vector&lt;double&gt;     local_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, Vector&lt;double&gt;(dim + 1));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div><div class="line"></div><div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; symgrad_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;                  div_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;                  phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">        {</div><div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">          local_matrix                = 0;</div><div class="line">          local_preconditioner_matrix = 0;</div><div class="line">          local_rhs                   = 0;</div><div class="line"></div><div class="line">          right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                            rhs_values);</div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">                {</div><div class="line">                  symgrad_phi_u[k] =</div><div class="line">                    fe_values[velocities].symmetric_gradient(k, q);</div><div class="line">                  div_phi_u[k] = fe_values[velocities].divergence(k, q);</div><div class="line">                  phi_p[k]     = fe_values[pressure].value(k, q);</div><div class="line">                }</div><div class="line"></div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt;= i; ++j)</div><div class="line">                    {</div><div class="line">                      local_matrix(i, j) +=</div><div class="line">                        (symgrad_phi_u[i] * symgrad_phi_u[j] <span class="comment">// diffusion</span></div><div class="line">                         - div_phi_u[i] * phi_p[j]           <span class="comment">// pressure force</span></div><div class="line">                         - phi_p[i] * div_phi_u[j])          <span class="comment">// divergence</span></div><div class="line">                        * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                      local_preconditioner_matrix(i, j) +=</div><div class="line">                        (phi_p[i] * phi_p[j]) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                    }</div><div class="line"></div><div class="line">                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                    fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                  local_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q)  </div><div class="line">                                  * rhs_values[q](component_i) </div><div class="line">                                  * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = i + 1; j &lt; dofs_per_cell; ++j)</div><div class="line">              {</div><div class="line">                local_matrix(i, j) = local_matrix(j, i);</div><div class="line">                local_preconditioner_matrix(i, j) =</div><div class="line">                  local_preconditioner_matrix(j, i);</div><div class="line">              }</div><div class="line"></div><div class="line">          cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">          constraints.distribute_local_to_global(local_matrix,</div><div class="line">                                                 local_rhs,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 system_rhs);</div><div class="line">          constraints.distribute_local_to_global(local_preconditioner_matrix,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 preconditioner_matrix);</div><div class="line">        }</div><div class="line"></div><div class="line">    system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Computing preconditioner...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a> A_preconditioner;</div><div class="line">    A_preconditioner.<a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html#a89c6576dd9f2b29fc545f25f753d4579">initialize</a>(system_matrix.block(0, 0));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">TrilinosWrappers::SparseMatrix</a>,</div><div class="line">                        <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div><div class="line">      A_inverse(system_matrix.block(0, 0),</div><div class="line">                A_preconditioner,</div><div class="line">                owned_partitioning[0],</div><div class="line">                mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> tmp(owned_partitioning,</div><div class="line">                                           mpi_communicator);</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> schur_rhs(owned_partitioning[1],</div><div class="line">                                              mpi_communicator);</div><div class="line">      A_inverse.vmult(tmp.block(0), system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div><div class="line">      system_matrix.block(1, 0).vmult(schur_rhs, tmp.block(0));</div><div class="line">      schur_rhs -= system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1);</div><div class="line"></div><div class="line">      SchurComplement&lt;TrilinosWrappers::PreconditionJacobi&gt; <a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>(</div><div class="line">        system_matrix, A_inverse, owned_partitioning[0], mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(solution.block(1).size(),</div><div class="line">                                   1e-6 * schur_rhs.l2_norm());</div><div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line"></div><div class="line">      TrilinosWrappers::PreconditionAMG preconditioner;</div><div class="line">      preconditioner.<a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">initialize</a>(preconditioner_matrix.block(1, 1));</div><div class="line"></div><div class="line">      InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">TrilinosWrappers::SparseMatrix</a>,</div><div class="line">                    TrilinosWrappers::PreconditionAMG&gt;</div><div class="line">        m_inverse(preconditioner_matrix.block(1, 1),</div><div class="line">                  preconditioner,</div><div class="line">                  owned_partitioning[1],</div><div class="line">                  mpi_communicator);</div><div class="line"></div><div class="line">      cg.solve(<a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>, tmp.block(1), schur_rhs, preconditioner);</div><div class="line"></div><div class="line">      constraints.distribute(tmp);</div><div class="line">      solution.block(1) = tmp.block(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      system_matrix.block(0, 1).vmult(tmp.block(0), tmp.block(1));</div><div class="line">      tmp.block(0) *= -1;</div><div class="line">      tmp.block(0) += system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0);</div><div class="line"></div><div class="line">      A_inverse.vmult(tmp.block(0), tmp.block(0));</div><div class="line"></div><div class="line">      constraints.distribute(tmp);</div><div class="line">      solution.block(0) = tmp.block(0);</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line"></div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">      data_component_interpretation(</div><div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation.push_back(</div><div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(solution,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line">    Vector&lt;float&gt; subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(mapping, degree + 1);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, refinement_cycle, MPI_COMM_WORLD, 2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_mesh()</div><div class="line">  {</div><div class="line">    Vector&lt;float&gt; estimated_error_per_cell(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line"></div><div class="line">    <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div><div class="line">    <a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div><div class="line">      dof_handler,</div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(degree + 1),</div><div class="line">      std::map&lt;<a class="code" href="classunsigned_01int.html">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div><div class="line">      solution,</div><div class="line">      estimated_error_per_cell,</div><div class="line">      fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(pressure));</div><div class="line"></div><div class="line">    <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#aa2ffb707a796ae6dedb75036606ef2e6">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_number</a>(</div><div class="line">      triangulation, estimated_error_per_cell, 0.3, 0.0);</div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line">    create_mesh();</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 9;</div><div class="line">         ++refinement_cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div><div class="line">          refine_mesh();</div><div class="line"></div><div class="line">        setup_dofs();</div><div class="line"></div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div><div class="line">        assemble_system();</div><div class="line"></div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::flush;</div><div class="line">        solve();</div><div class="line"></div><div class="line">        output_results(refinement_cycle);</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">} <span class="comment">// namespace Step45</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step45;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line">      StokesProblem&lt;2&gt;                 flow_problem(1);</div><div class="line">      flow_problem.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>This tutorial depends on <a class="el" href="step_6.html">step-6</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Settingupperiodicityconstraintsondistributedtriangulations">Setting up periodicity constraints on distributed triangulations</a><a href="#Settingupperiodicityconstraintsondistributedtriangulations">Setting up periodicity constraints on distributed triangulations</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br />
 <em>This program was contributed by Daniel Arndt and Matthias Maier.</em><a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>In this example we present how to use periodic boundary conditions indeal.II. Periodic boundary conditions are algebraic constraints thattypically occur in computations on representative regions of a largerdomain that repeat in one or more directions. An example is the simulation of the electronic structure of photoniccrystals, because they have a lattice-like structure and, thus, it oftensuffices to do the actual computation on only one box of the lattice. Tobe able to proceed this way one has to assume that the model can beperiodically extended to the other boxes; this requires the solution tohave a periodic structure. <a class="anchor" id="Procedure"></a><a class="anchor" id="Procedure"></a></p><h1>Procedure</h1>
<p>deal.II provides a number of high level entry points to impose periodicboundary conditions.The general approach to apply periodic boundary conditions consists ofthree steps (see also the <a class="el" href="DEALGlossary.html#GlossPeriodicConstraints">Glossary entry on periodic boundary conditions</a>):</p>
<ul>
<li>Create a mesh</li>
<li>Identify those pairs of faces on different parts of the boundary across which the solution should be symmetric, using <a class="el" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces()</a></li>
<li>Add the periodicity information to the mesh using <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html#aa7b797070e5443a18f03a4a7f0267453">parallel::distributed::Triangulation::add_periodicity()</a></li>
<li>Add periodicity constraints using <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints()</a> The second and third step are necessary for parallel meshes using the <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a> classto ensure that cells on opposite sides of the domain but connected by periodicfaces are part of the ghost layer if one of them is stored on the local processor.If the <a class="el" href="classTriangulation.html">Triangulation</a> is not a <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a>, these steps are not necessary. The first step consists of collecting matching periodic faces and storing them ina <code>std::vector</code> of <a class="el" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>. This is done with thefunction <a class="el" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces()</a> that can be invoked for examplelike this: <div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  b_id1,</div><div class="line">                                  b_id2,</div><div class="line">                                  direction,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  offset = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                                  matrix = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                                  first_vector_components = &lt;<span class="keywordflow">default</span> value&gt;);</div></div><!-- fragment --></li>
</ul>
<p>This call loops over all faces of the container dof_handler on the periodicboundaries with boundary indicator <code>b_id1</code> and <code>b_id2</code>, respectively. (You can assign these boundary indicators by hand aftercreating the coarse mesh, see <a class="el" href="DEALGlossary.html#GlossBoundaryIndicator">Boundary indicator</a>. Alternatively, youcan also let many of the functions in namespace <a class="el" href="namespaceGridGenerator.html">GridGenerator</a> do thisfor if you specify the "colorize" flag; in that case, these functionswill assign different boundary indicators to different parts of theboundary, with the details typically spelled out in the documentationof these functions.) Concretely, if \(\text{vertices}_{1/2}\) are the vertices of two faces \(\text{face}_{1/2}\) , then the function call above will match pairs offaces (and dofs) such that the difference between \(\text{vertices}_2\) and \(matrix\cdot \text{vertices}_1+\text{offset}\) vanishes in everycomponent apart from direction and stores the resulting pairs withassociated data in <code>matched_pairs</code>. (See <a class="el" href="namespaceGridTools.html#ac2a1903382c6cff07b33d456a641f6d9">GridTools::orthogonal_equality()</a> for detailed information about thematching process.) Consider, for example, the colored unit square \(\Omega=[0,1]^2\) with boundaryindicator 0 on the left, 1 on the right, 2 on the bottom and 3 on the topfaces. (See the documentation of <a class="el" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube()</a> for thisconvention on how boundary indicators are assigned.) Then, </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                   <span class="comment">/*b_id1*/</span>  0,</div><div class="line">                                   <span class="comment">/*b_id2*/</span>  1,</div><div class="line">                                   <span class="comment">/*direction*/</span>  0,</div><div class="line">                                  matched_pairs);</div></div><!-- fragment --><p> would yield periodicity constraints such that \(u(0,y)=u(1,y)\) for all \(y\in[0,1]\) . If we instead consider the parallelogram given by the convex hull of \((0,0)\) , \((1,1)\) , \((1,2)\) , \((0,1)\) we can achieve the constraints \(u(0,y)=u(1,y+1)\) by specifying an <code>offset:</code> </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                   <span class="comment">/*b_id1*/</span>  0,</div><div class="line">                                   <span class="comment">/*b_id2*/</span>  1,</div><div class="line">                                   <span class="comment">/*direction*/</span>  0,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, 2&gt;</a>(0.,1.));</div></div><!-- fragment --><p> or </p><div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                   <span class="comment">/*b_id1*/</span>  0,</div><div class="line">                                   <span class="comment">/*b_id2*/</span>  1,</div><div class="line">                                   <span class="comment">/*arbitrary direction*/</span>  0,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, 2&gt;</a>(1.,1.));</div></div><!-- fragment --><p> Here, again, the assignment of boundary indicators 0 and 1 stems fromwhat <a class="el" href="namespaceGridGenerator.html#a324b8447f05b148e2f58bdbcf89f5325">GridGenerator::parallelogram()</a> documents. The resulting <code>matched_pairs</code> can be used in <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> for populating an AffineConstraintsobject with periodicity constraints: </p><div class="fragment"><div class="line"><a class="code" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a>(matched_pairs, constraints);</div></div><!-- fragment --><p>Apart from this high level interface there are also variants of <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> available that combine those twosteps (see the variants of DofTools::make_periodicity_constraints). There is also a low level interface to <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> if more flexibility is needed. Thelow level variant allows to directly specify two faces that shall beconstrained: </p><div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceDoFTools.html">DoFTools</a>;</div><div class="line"><a class="code" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">make_periodicity_constraints</a>(face_1,</div><div class="line">                             face_2,</div><div class="line">                             affine_constraints,</div><div class="line">                             component_mask = &lt;<span class="keywordflow">default</span> value&gt;;</div><div class="line">                             face_orientation = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             face_flip = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             face_rotation = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             matrix = &lt;<span class="keywordflow">default</span> value&gt;);</div></div><!-- fragment --><p> Here, we need to specify the orientation of the two faces using <code>face_orientation</code>, <code>face_flip</code> and <code>face_orientation</code>. For a closer descriptionhave a look at the documentation of <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a>. The remaining parameters are the same as for the high level interface apartfrom the self-explaining <code>component_mask</code> and <code>affine_constraints</code>.</p>
<p><a class="anchor" id="problem"></a><a class="anchor" id="Apracticalexample"></a></p><h1>A practical example</h1>
<p>In the following, we show how to use the above functions in a more involvedexample. The task is to enforce rotated periodicity constraints for thevelocity component of a Stokes flow. On a quarter-circle defined by \(\Omega=\{{\bf x}\in(0,1)^2:\|{\bf x}\|\in (0.5,1)\}\) we aregoing to solve the Stokes problem </p><p class="formulaDsp">
\begin{eqnarray*} -\Delta \; \textbf{u} + \nabla p &amp;=&amp; (\exp(-100\|{\bf x}-(.75,0.1)^T\|^2),0)^T, \\ -\textrm{div}\; \textbf{u}&amp;=&amp;0,\\ \textbf{u}|_{\Gamma_1}&amp;=&amp;{\bf 0}, \end{eqnarray*}
</p>
<p> where the boundary \(\Gamma_1\) is defined as \(\Gamma_1 \dealcoloneq \{x\in \partial\Omega: \|x\|\in\{0.5,1\}\}\) .For the remaining parts of the boundary we are going to use periodic boundary conditions, i.e. </p><p class="formulaDsp">
\begin{align*} u_x(0,\nu)&amp;=-u_y(\nu,0)&amp;\nu&amp;\in[0,1]\\ u_y(0,\nu)&amp;=u_x(\nu,0)&amp;\nu&amp;\in[0,1]. \end{align*}
</p>
<p>The mesh will be generated by <a class="el" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell()</a>, which also documents how it assigns boundary indicators to its variousboundaries if its <code>colorize</code> argument is set to <code>true</code>.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p>This example program is a slight modification of <a class="el" href="step_22.html">step-22</a> running in parallel using Trilinos to demonstrate the usage of periodic boundary conditions in deal.II. We thus omit to discuss the majority of the source code and only comment on the parts that deal with periodicity constraints. For the rest have a look at <a class="el" href="step_22.html">step-22</a> and the full source code at the bottom.</p>
<p>In order to implement periodic boundary conditions only two functions have to be modified:</p>
<ul>
<li><code>StokesProblem&lt;dim&gt;::setup_dofs()</code> : To populate an <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object with periodicity constraints</li>
<li><code>StokesProblem&lt;dim&gt;::create_mesh()</code> : To supply a distributed triangulation with periodicity information.</li>
</ul>
<p>The rest of the program is identical to <a class="el" href="step_22.html">step-22</a> , so let us skip this part and only show these two functions in the following. (The full program can be found in the "Plain program" section below, though.)</p>
<p><a class="anchor" id="Settingupperiodicityconstraintsondistributedtriangulations"></a> </p><h3>Setting up periodicity constraints on distributed triangulations</h3>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::create_mesh()</div><div class="line">{</div><div class="line">  <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> inner_radius = .5;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> outer_radius = 1.;</div><div class="line"></div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell</a>(</div><div class="line">    triangulation, center, inner_radius, outer_radius, 0, <span class="keyword">true</span>);</div></div><!-- fragment --><p>Before we can prescribe periodicity constraints, we need to ensure that cells on opposite sides of the domain but connected by periodic faces are part of the ghost layer if one of them is stored on the local processor. At this point we need to think about how we want to prescribe periodicity. The vertices \(\text{vertices}_2\) of a face on the left boundary should be matched to the vertices \(\text{vertices}_1\) of a face on the lower boundary given by \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) where the rotation matrix \(R\) and the offset \(b\) are given by</p>
<p class="formulaDsp">
\begin{align*} R=\begin{pmatrix} 0&amp;1\\-1&amp;0 \end{pmatrix}, \quad b=\begin{pmatrix}0&amp;0\end{pmatrix}. \end{align*}
</p>
<p> The data structure we are saving the resulting information into is here based on the <a class="el" href="classTriangulation.html">Triangulation</a>.</p>
<div class="fragment"><div class="line">     std::vector&lt;<a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;</div><div class="line">       <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga48cef91f67c38d6ec17912922de00f90">parallel::distributed::Triangulation&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">       periodicity_vector;</div><div class="line">  </div><div class="line">     <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">     rotation_matrix[0][1] = 1.;</div><div class="line">     rotation_matrix[1][0] =</div><div class="line">  </div><div class="line">-1.;</div><div class="line">  </div><div class="line">     <a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(triangulation,</div><div class="line">                                       2,</div><div class="line">                                       3,</div><div class="line">                                       1,</div><div class="line">                                       periodicity_vector,</div><div class="line">                                       <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(),</div><div class="line">                                       rotation_matrix);</div></div><!-- fragment --><p>Now telling the triangulation about the desired periodicity is particularly easy by just calling <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html#aa7b797070e5443a18f03a4a7f0267453">parallel::distributed::Triangulation::add_periodicity</a>.</p>
<div class="fragment"><div class="line">     triangulation.<a class="code" href="classTriangulation.html#adbf04756b28dae69194870812acaf941">add_periodicity</a>(periodicity_vector);</div><div class="line">  </div><div class="line">     triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(4</div><div class="line">  </div><div class="line">- dim);</div><div class="line">   }</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs()</div><div class="line">   {</div><div class="line">     dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line">  </div><div class="line">     std::vector&lt;unsigned int&gt; block_component(dim + 1, 0);</div><div class="line">     block_component[dim] = 1;</div><div class="line">     <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div><div class="line">  </div><div class="line">     <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">       <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div><div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0], n_p = dofs_per_block[1];</div><div class="line">  </div><div class="line">     {</div><div class="line">       owned_partitioning.clear();</div><div class="line">       <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">       owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">       owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line">  </div><div class="line">       relevant_partitioning.<a class="code" href="classIndexSet.html#a8a3d75a9cba3f1a50866691327aa7609">clear</a>();</div><div class="line">       <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">       <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler,</div><div class="line">                                               locally_relevant_dofs);</div><div class="line">       relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">       relevant_partitioning.push_back(</div><div class="line">         locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line">  </div><div class="line">       constraints.clear();</div><div class="line">       constraints.reinit(locally_relevant_dofs);</div><div class="line">  </div><div class="line">       <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">  </div><div class="line">       <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">       <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                                dof_handler,</div><div class="line">                                                0,</div><div class="line">                                                BoundaryValues&lt;dim&gt;(),</div><div class="line">                                                constraints,</div><div class="line">                                                fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">       <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                                dof_handler,</div><div class="line">                                                1,</div><div class="line">                                                BoundaryValues&lt;dim&gt;(),</div><div class="line">                                                constraints,</div><div class="line">                                                fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div></div><!-- fragment --><p>After we provided the mesh with the necessary information for the periodicity constraints, we are now able to actual create them. For describing the matching we are using the same approach as before, i.e., the \(\text{vertices}_2\) of a face on the left boundary should be matched to the vertices \(\text{vertices}_1\) of a face on the lower boundary given by \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) where the rotation matrix \(R\) and the offset \(b\) are given by</p>
<p class="formulaDsp">
\begin{align*} R=\begin{pmatrix} 0&amp;1\\-1&amp;0 \end{pmatrix}, \quad b=\begin{pmatrix}0&amp;0\end{pmatrix}. \end{align*}
</p>
<p> These two objects not only describe how faces should be matched but also in which sense the solution should be transformed from \(\text{face}_2\) to \(\text{face}_1\) .</p>
<div class="fragment"><div class="line">       <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">       rotation_matrix[0][1] = 1.;</div><div class="line">       rotation_matrix[1][0] =</div><div class="line">  </div><div class="line">-1.;</div><div class="line">  </div><div class="line">       <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> offset;</div></div><!-- fragment --><p>For setting up the constraints, we first store the periodicity information in an auxiliary object of type <code>std::vector&lt;<a class="el" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;typename <a class="el" href="classDoFHandler.html">DoFHandler</a>&lt;dim&gt;::cell_iterator&gt; </code>. The periodic boundaries have the boundary indicators 2 (x=0) and 3 (y=0). All the other parameters we have set up before. In this case the direction does not matter. Due to \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) this is exactly what we want.</p>
<div class="fragment"><div class="line">std::vector&lt;</div><div class="line">  <a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">  periodicity_vector;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> direction = 1;</div><div class="line"></div><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  2,</div><div class="line">                                  3,</div><div class="line">                                  direction,</div><div class="line">                                  periodicity_vector,</div><div class="line">                                  offset,</div><div class="line">                                  rotation_matrix);</div></div><!-- fragment --><p>Next, we need to provide information on which vector valued components of the solution should be rotated. Since we choose here to just constraint the velocity and this starts at the first component of the solution vector, we simply insert a 0:</p>
<div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; first_vector_components;</div><div class="line">first_vector_components.push_back(0);</div></div><!-- fragment --><p>After setting up all the information in periodicity_vector all we have to do is to tell make_periodicity_constraints to create the desired constraints.</p>
<div class="fragment"><div class="line">    DoFTools::make_periodicity_constraints&lt;dim, dim&gt;(periodicity_vector,</div><div class="line">                                                     constraints,</div><div class="line">                                                     fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(</div><div class="line">                                                       velocities),</div><div class="line">                                                     first_vector_components);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             0,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             1,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">  }</div><div class="line"></div><div class="line">  constraints.close();</div><div class="line"></div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> bsp(owned_partitioning,</div><div class="line">                                               owned_partitioning,</div><div class="line">                                               relevant_partitioning,</div><div class="line">                                               mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">        <span class="keywordflow">if</span> (!((c == dim) &amp;&amp; (d == dim)))</div><div class="line">          coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    coupling,</div><div class="line">                                    bsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="keyword">false</span>,</div><div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                      mpi_communicator));</div><div class="line"></div><div class="line">    bsp.compress();</div><div class="line"></div><div class="line">    system_matrix.reinit(bsp);</div><div class="line">  }</div><div class="line"></div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> preconditioner_bsp(</div><div class="line">      owned_partitioning,</div><div class="line">      owned_partitioning,</div><div class="line">      relevant_partitioning,</div><div class="line">      mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(dim + 1, dim + 1);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">        <span class="keywordflow">if</span> ((c == dim) &amp;&amp; (d == dim))</div><div class="line">          preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    preconditioner_coupling,</div><div class="line">                                    preconditioner_bsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="keyword">false</span>,</div><div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                      mpi_communicator));</div><div class="line"></div><div class="line">    preconditioner_bsp.compress();</div><div class="line"></div><div class="line">    preconditioner_matrix.reinit(preconditioner_bsp);</div><div class="line">  }</div><div class="line"></div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">  solution.reinit(owned_partitioning,</div><div class="line">                  relevant_partitioning,</div><div class="line">                  mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>The rest of the program is then again identical to <a class="el" href="step_22.html">step-22</a> . We will omit it here now, but as before, you can find these parts in the "Plain program" section below.</p>
<p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>The created output is not very surprising. We simply see that the solution isperiodic with respect to the left and lower boundary: </p><div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-45.periodic.png"/>
</div>
<p> Without the periodicity constraints we would have ended up with the following solution: </p><div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-45.non_periodic.png"/>
</div>
<p><a class="anchor" id="PlainProg"></a></p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2008 - 2020 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Daniel Arndt, Matthias Maier, 2015</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Based on @ref step_22 &quot;step-22&quot; by Wolfgang Bangerth and Martin Kronbichler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__solver_8h.html">deal.II/lac/trilinos_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step45</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>StokesProblem</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree);</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> create_mesh();</div><div class="line">    <span class="keywordtype">void</span> setup_dofs();</div><div class="line">    <span class="keywordtype">void</span> assemble_system();</div><div class="line">    <span class="keywordtype">void</span> solve();</div><div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">void</span> refine_mesh();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree;</div><div class="line"></div><div class="line">    <a class="code" href="classMPI__Comm.html">MPI_Comm</a> mpi_communicator;</div><div class="line"></div><div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line">    std::vector&lt;IndexSet&gt;     owned_partitioning;</div><div class="line">    std::vector&lt;IndexSet&gt;     relevant_partitioning;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> system_matrix;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> solution;</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> system_rhs;</div><div class="line"></div><div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line"></div><div class="line">    <a class="code" href="classMappingQ.html">MappingQ&lt;dim&gt;</a> mapping;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>BoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BoundaryValues()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> BoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    (void)component;</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;n_components,</div><div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(component, 0, this-&gt;n_components));</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BoundaryValues&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                         Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div><div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>(c) = BoundaryValues&lt;dim&gt;::value(p, c);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>(0.75, 0.1);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>     r = (p - <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>).<a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (component == 0)</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="vectorization_8h.html#a19f846bda83b7e3f4531daacb40c64e1">std::exp</a>(-100. * r * r);</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div><div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>(c) = RightHandSide&lt;dim&gt;::value(p, c);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        m,</div><div class="line">                  <span class="keyword">const</span> PreconditionerType &amp;preconditioner,</div><div class="line">                  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;          locally_owned,</div><div class="line">                  <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;          mpi_communicator);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> vmult(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a>         <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const PreconditionerType&gt;</a> preconditioner;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> *                      mpi_communicator;</div><div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div><div class="line">    <span class="keyword">const</span> MatrixType &amp;        m,</div><div class="line">    <span class="keyword">const</span> PreconditionerType &amp;preconditioner,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;          locally_owned,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;          mpi_communicator)</div><div class="line">    : matrix(&amp;m)</div><div class="line">    , preconditioner(&amp;preconditioner)</div><div class="line">    , mpi_communicator(&amp;mpi_communicator)</div><div class="line">    , tmp(locally_owned, mpi_communicator)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keywordtype">void</span> InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult(</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>              solver_control(src.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a78fa29403bbd6da7795fd25700267d47">size</a>(), 1e-6 * src.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a5680a0f82a28f0b980d83f3443cc20ca">l2_norm</a>());</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1SolverCG.html">TrilinosWrappers::SolverCG</a> cg(solver_control,</div><div class="line">                                  <a class="code" href="structTrilinosWrappers_1_1SolverCG_1_1AdditionalData.html">TrilinosWrappers::SolverCG::AdditionalData</a>());</div><div class="line"></div><div class="line">    tmp = 0.;</div><div class="line">    cg.solve(*matrix, tmp, src, *preconditioner);</div><div class="line">    dst = tmp;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keyword">class </span>SchurComplement : <span class="keyword">public</span> TrilinosWrappers::SparseMatrix</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    SchurComplement(<span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;system_matrix,</div><div class="line">                    <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</div><div class="line">                                        PreconditionerType&gt; &amp;  A_inverse,</div><div class="line">                    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;                           owned_pres,</div><div class="line">                    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;mpi_communicator);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="structSUNDIALS_1_1SundialsPreconditioner.html#aff5a880cfa288ecdd2a83a876abacf0d">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a> system_matrix;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;</div><div class="line">      <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix, PreconditionerType&gt;&gt;</div><div class="line">                                          A_inverse;</div><div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp1, tmp2;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  SchurComplement&lt;PreconditionerType&gt;::SchurComplement(</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;system_matrix,</div><div class="line">    <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix, PreconditionerType&gt;</div><div class="line">      &amp;             A_inverse,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;owned_vel,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;mpi_communicator)</div><div class="line">    : system_matrix(&amp;system_matrix)</div><div class="line">    , A_inverse(&amp;A_inverse)</div><div class="line">    , tmp1(owned_vel, mpi_communicator)</div><div class="line">    , tmp2(tmp1)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keywordtype">void</span> SchurComplement&lt;PreconditionerType&gt;::vmult(</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    system_matrix-&gt;block(0, 1).vmult(tmp1, src);</div><div class="line">    A_inverse-&gt;vmult(tmp2, tmp1);</div><div class="line">    system_matrix-&gt;block(1, 0).vmult(dst, tmp2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  StokesProblem&lt;dim&gt;::StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree)</div><div class="line">    : degree(degree)</div><div class="line">    , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">    , triangulation(mpi_communicator)</div><div class="line">    , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(degree + 1), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(degree), 1)</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , pcout(<a class="code" href="namespacestd.html">std</a>::cout, <a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0)</div><div class="line">    , mapping(degree + 1)</div><div class="line">  {}</div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::create_mesh()</div><div class="line">  {</div><div class="line">    <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> inner_radius = .5;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> outer_radius = 1.;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell</a>(</div><div class="line">      triangulation, center, inner_radius, outer_radius, 0, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    std::vector&lt;<a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;</div><div class="line">      <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga48cef91f67c38d6ec17912922de00f90">parallel::distributed::Triangulation&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">      periodicity_vector;</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">    rotation_matrix[0][1] = 1.;</div><div class="line">    rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(triangulation,</div><div class="line">                                      2,</div><div class="line">                                      3,</div><div class="line">                                      1,</div><div class="line">                                      periodicity_vector,</div><div class="line">                                      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(),</div><div class="line">                                      rotation_matrix);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#adbf04756b28dae69194870812acaf941">add_periodicity</a>(periodicity_vector);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(4 - dim);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs()</div><div class="line">  {</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    std::vector&lt;unsigned int&gt; block_component(dim + 1, 0);</div><div class="line">    block_component[dim] = 1;</div><div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0], n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">    {</div><div class="line">      owned_partitioning.clear();</div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">      owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">      owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">      relevant_partitioning.<a class="code" href="classIndexSet.html#a8a3d75a9cba3f1a50866691327aa7609">clear</a>();</div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">      <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler,</div><div class="line">                                              locally_relevant_dofs);</div><div class="line">      relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">      relevant_partitioning.push_back(</div><div class="line">        locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">      constraints.clear();</div><div class="line">      constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               1,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"></div><div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">      rotation_matrix[0][1] = 1.;</div><div class="line">      rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line">      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> offset;</div><div class="line"></div><div class="line">      std::vector&lt;</div><div class="line">        <a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">        periodicity_vector;</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> direction = 1;</div><div class="line"></div><div class="line">      <a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                        2,</div><div class="line">                                        3,</div><div class="line">                                        direction,</div><div class="line">                                        periodicity_vector,</div><div class="line">                                        offset,</div><div class="line">                                        rotation_matrix);</div><div class="line"></div><div class="line">      std::vector&lt;unsigned int&gt; first_vector_components;</div><div class="line">      first_vector_components.push_back(0);</div><div class="line"></div><div class="line">      DoFTools::make_periodicity_constraints&lt;dim, dim&gt;(periodicity_vector,</div><div class="line">                                                       constraints,</div><div class="line">                                                       fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(</div><div class="line">                                                         velocities),</div><div class="line">                                                       first_vector_components);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               1,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    }</div><div class="line"></div><div class="line">    constraints.close();</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> bsp(owned_partitioning,</div><div class="line">                                                 owned_partitioning,</div><div class="line">                                                 relevant_partitioning,</div><div class="line">                                                 mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (!((c == dim) &amp;&amp; (d == dim)))</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                      coupling,</div><div class="line">                                      bsp,</div><div class="line">                                      constraints,</div><div class="line">                                      <span class="keyword">false</span>,</div><div class="line">                                      <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                        mpi_communicator));</div><div class="line"></div><div class="line">      bsp.compress();</div><div class="line"></div><div class="line">      system_matrix.reinit(bsp);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> preconditioner_bsp(</div><div class="line">        owned_partitioning,</div><div class="line">        owned_partitioning,</div><div class="line">        relevant_partitioning,</div><div class="line">        mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> ((c == dim) &amp;&amp; (d == dim))</div><div class="line">            preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                      preconditioner_coupling,</div><div class="line">                                      preconditioner_bsp,</div><div class="line">                                      constraints,</div><div class="line">                                      <span class="keyword">false</span>,</div><div class="line">                                      <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                        mpi_communicator));</div><div class="line"></div><div class="line">      preconditioner_bsp.compress();</div><div class="line"></div><div class="line">      preconditioner_matrix.reinit(preconditioner_bsp);</div><div class="line">    }</div><div class="line"></div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">    solution.reinit(owned_partitioning,</div><div class="line">                    relevant_partitioning,</div><div class="line">                    mpi_communicator);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">  {</div><div class="line">    system_matrix         = 0.;</div><div class="line">    system_rhs            = 0.;</div><div class="line">    preconditioner_matrix = 0.;</div><div class="line"></div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(degree + 2);</div><div class="line"></div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(mapping,</div><div class="line">                            fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_preconditioner_matrix(dofs_per_cell,</div><div class="line">                                                   dofs_per_cell);</div><div class="line">    Vector&lt;double&gt;     local_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, Vector&lt;double&gt;(dim + 1));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div><div class="line"></div><div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; symgrad_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;                  div_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;                  phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">        {</div><div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">          local_matrix                = 0;</div><div class="line">          local_preconditioner_matrix = 0;</div><div class="line">          local_rhs                   = 0;</div><div class="line"></div><div class="line">          right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                            rhs_values);</div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">                {</div><div class="line">                  symgrad_phi_u[k] =</div><div class="line">                    fe_values[velocities].symmetric_gradient(k, q);</div><div class="line">                  div_phi_u[k] = fe_values[velocities].divergence(k, q);</div><div class="line">                  phi_p[k]     = fe_values[pressure].value(k, q);</div><div class="line">                }</div><div class="line"></div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt;= i; ++j)</div><div class="line">                    {</div><div class="line">                      local_matrix(i, j) +=</div><div class="line">                        (symgrad_phi_u[i] * symgrad_phi_u[j] <span class="comment">// diffusion</span></div><div class="line">                         - div_phi_u[i] * phi_p[j]           <span class="comment">// pressure force</span></div><div class="line">                         - phi_p[i] * div_phi_u[j])          <span class="comment">// divergence</span></div><div class="line">                        * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                      local_preconditioner_matrix(i, j) +=</div><div class="line">                        (phi_p[i] * phi_p[j]) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                    }</div><div class="line"></div><div class="line">                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                    fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                  local_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q)  </div><div class="line">                                  * rhs_values[q](component_i) </div><div class="line">                                  * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = i + 1; j &lt; dofs_per_cell; ++j)</div><div class="line">              {</div><div class="line">                local_matrix(i, j) = local_matrix(j, i);</div><div class="line">                local_preconditioner_matrix(i, j) =</div><div class="line">                  local_preconditioner_matrix(j, i);</div><div class="line">              }</div><div class="line"></div><div class="line">          cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">          constraints.distribute_local_to_global(local_matrix,</div><div class="line">                                                 local_rhs,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 system_rhs);</div><div class="line">          constraints.distribute_local_to_global(local_preconditioner_matrix,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 preconditioner_matrix);</div><div class="line">        }</div><div class="line"></div><div class="line">    system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Computing preconditioner...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a> A_preconditioner;</div><div class="line">    A_preconditioner.<a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html#a89c6576dd9f2b29fc545f25f753d4579">initialize</a>(system_matrix.block(0, 0));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">TrilinosWrappers::SparseMatrix</a>,</div><div class="line">                        <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div><div class="line">      A_inverse(system_matrix.block(0, 0),</div><div class="line">                A_preconditioner,</div><div class="line">                owned_partitioning[0],</div><div class="line">                mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> tmp(owned_partitioning,</div><div class="line">                                           mpi_communicator);</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> schur_rhs(owned_partitioning[1],</div><div class="line">                                              mpi_communicator);</div><div class="line">      A_inverse.vmult(tmp.block(0), system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div><div class="line">      system_matrix.block(1, 0).vmult(schur_rhs, tmp.block(0));</div><div class="line">      schur_rhs -= system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1);</div><div class="line"></div><div class="line">      SchurComplement&lt;TrilinosWrappers::PreconditionJacobi&gt; <a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>(</div><div class="line">        system_matrix, A_inverse, owned_partitioning[0], mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(solution.block(1).size(),</div><div class="line">                                   1e-6 * schur_rhs.l2_norm());</div><div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line"></div><div class="line">      TrilinosWrappers::PreconditionAMG preconditioner;</div><div class="line">      preconditioner.<a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">initialize</a>(preconditioner_matrix.block(1, 1));</div><div class="line"></div><div class="line">      InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">TrilinosWrappers::SparseMatrix</a>,</div><div class="line">                    TrilinosWrappers::PreconditionAMG&gt;</div><div class="line">        m_inverse(preconditioner_matrix.block(1, 1),</div><div class="line">                  preconditioner,</div><div class="line">                  owned_partitioning[1],</div><div class="line">                  mpi_communicator);</div><div class="line"></div><div class="line">      cg.solve(<a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>, tmp.block(1), schur_rhs, preconditioner);</div><div class="line"></div><div class="line">      constraints.distribute(tmp);</div><div class="line">      solution.block(1) = tmp.block(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      system_matrix.block(0, 1).vmult(tmp.block(0), tmp.block(1));</div><div class="line">      tmp.block(0) *= -1;</div><div class="line">      tmp.block(0) += system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0);</div><div class="line"></div><div class="line">      A_inverse.vmult(tmp.block(0), tmp.block(0));</div><div class="line"></div><div class="line">      constraints.distribute(tmp);</div><div class="line">      solution.block(0) = tmp.block(0);</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line"></div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">      data_component_interpretation(</div><div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation.push_back(</div><div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(solution,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line">    Vector&lt;float&gt; subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(mapping, degree + 1);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, refinement_cycle, MPI_COMM_WORLD, 2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_mesh()</div><div class="line">  {</div><div class="line">    Vector&lt;float&gt; estimated_error_per_cell(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line"></div><div class="line">    <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div><div class="line">    <a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div><div class="line">      dof_handler,</div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(degree + 1),</div><div class="line">      std::map&lt;<a class="code" href="classunsigned_01int.html">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div><div class="line">      solution,</div><div class="line">      estimated_error_per_cell,</div><div class="line">      fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(pressure));</div><div class="line"></div><div class="line">    <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#aa2ffb707a796ae6dedb75036606ef2e6">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_number</a>(</div><div class="line">      triangulation, estimated_error_per_cell, 0.3, 0.0);</div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line">    create_mesh();</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 9;</div><div class="line">         ++refinement_cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div><div class="line">          refine_mesh();</div><div class="line"></div><div class="line">        setup_dofs();</div><div class="line"></div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div><div class="line">        assemble_system();</div><div class="line"></div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::flush;</div><div class="line">        solve();</div><div class="line"></div><div class="line">        output_results(refinement_cycle);</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">} <span class="comment">// namespace Step45</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step45;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line">      StokesProblem&lt;2&gt;                 flow_problem(1);</div><div class="line">      flow_problem.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>This tutorial depends on <a class="el" href="step_6.html">step-6</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Settingupperiodicityconstraintsondistributedtriangulations">Setting up periodicity constraints on distributed triangulations</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 examples/step-45/doc/intro.dox</p>
<p><br />
</p>
<p>［<em>This program was contributed by Daniel Arndt and Matthias Maier.</em>］ ［<a class="anchor" id="Intro"></a>］</p>
<p><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>在这个例子中，我们介绍了如何在deal.II中使用周期性边界条件。周期性边界条件是代数约束，通常出现在一个大域的代表性区域的计算中，这些区域在一个或多个方向上重复。</p>
<p>一个例子是模拟光子晶体的电子结构，因为它们有一个类似格子的结构，因此，往往只需要在格子的一个盒子上进行实际计算。为了能够以这种方式进行，我们必须假设该模型可以周期性地扩展到其他盒子上；这要求解决方案具有周期性结构。</p>
<p><a class="anchor" id="Procedure"></a></p>
<p><a class="anchor" id="Procedure"></a></p><h1>Procedure</h1>
<p>deal.II提供了一些高水平的入口来施加周期性边界条件。应用周期性边界条件的一般方法包括三个步骤（也见 <a class="el" href="DEALGlossary.html#GlossPeriodicConstraints">关于周期性边界条件的词汇表条目</a>）。</p>
<ol type="1">
<li>创建一个网格</li>
<li>识别边界不同部分的那些面对，在这些面对上的解应该是对称的，使用 <a class="el" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces()</a> 。</li>
<li>使用 <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html#aa7b797070e5443a18f03a4a7f0267453">parallel::distributed::Triangulation::add_periodicity()</a> 将周期性信息添加到网格中。</li>
<li>使用 <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints()</a> 添加周期性约束。</li>
</ol>
<p>第二和第三步对于使用 <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a> 类的平行网格是必要的，以确保位于域的对面但由周期性面连接的单元是鬼层的一部分，如果它们中的一个存储在本地处理器上。如果三角结构不是 <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a>, 类，这些步骤就没有必要。</p>
<p>第一步包括收集匹配的周期性面，并将它们存储在 <code>std::vector</code> 的 <a class="el" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>. 中，这是通过函数 <a class="el" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces()</a> 来完成的，例如可以这样调用。</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  b_id1,</div><div class="line">                                  b_id2,</div><div class="line">                                  direction,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  offset = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                                  matrix = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                                  first_vector_components = &lt;<span class="keywordflow">default</span> value&gt;);</div></div><!-- fragment --><p>这个调用在周期性边界上的容器dof_handler的所有面进行循环，其边界指标分别为 <code>b_id1</code> 和 <code>b_id2</code>, 。(你可以在创建粗略网格后手工分配这些边界指标，见 <a class="el" href="DEALGlossary.html#GlossBoundaryIndicator">边界指标</a>。另外，如果你指定了 "着色 "标志，你也可以让命名空间GridGenerator中的许多函数来做这件事；在这种情况下，这些函数会给边界的不同部分分配不同的边界指标，细节通常在这些函数的文档中详细说明）。)</p>
<p>具体来说，如果 \(\text{vertices}_{1/2}\) 是两个面 \(\text{face}_{1/2}\) 的顶点，那么上面的函数调用将匹配成对的面（和道夫），使得 \(\text{vertices}_2\) 和 \(matrix\cdot \text{vertices}_1+\text{offset}\) 之间的差异在除方向之外的每个分量中都消失，并将产生的对与相关数据存储在 <code>matched_pairs</code>. 中（关于匹配过程的详细信息，见 <a class="el" href="namespaceGridTools.html#ac2a1903382c6cff07b33d456a641f6d9">GridTools::orthogonal_equality()</a> ）。</p>
<p>例如，考虑彩色单位方块 \(\Omega=[0,1]^2\) ，其边界指标0在左边，1在右边，2在下面，3在上面的面。参见 <a class="el" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube()</a> 的文件，了解这个关于如何分配边界指标的惯例）。然后。</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*direction*/</span> 0,</div><div class="line">                                  matched_pairs);</div></div><!-- fragment --><p>将产生周期性约束，使 \(u(0,y)=u(1,y)\) 为所有 \(y\in[0,1]\) 。</p>
<p>如果我们转而考虑由 \((0,0)\) , \((1,1)\) , \((1,2)\) , \((0,1)\) 的凸壳给出的平行四边形，我们可以通过指定一个 <code>offset:</code> 来实现约束 \(u(0,y)=u(1,y+1)\) 。</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*direction*/</span> 0,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, 2&gt;</a>(0.,1.));</div></div><!-- fragment --><p>或</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  <span class="comment">/*b_id1*/</span> 0,</div><div class="line">                                  <span class="comment">/*b_id2*/</span> 1,</div><div class="line">                                  <span class="comment">/*arbitrary direction*/</span> 0,</div><div class="line">                                  matched_pairs,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, 2&gt;</a>(1.,1.));</div></div><!-- fragment --><p>在这里，边界指标0和1的分配也是源于 <a class="el" href="namespaceGridGenerator.html#a324b8447f05b148e2f58bdbcf89f5325">GridGenerator::parallelogram()</a> 的文件。</p>
<p>由此产生的 <code>matched_pairs</code> 可以在 <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> 中使用，用于为AffineConstraints对象填充周期性约束。</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a>(matched_pairs, constraints);</div></div><!-- fragment --><p>除了这个高水平的接口外，还有结合这两个步骤的 <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> 的变体（见 DofTools::make_periodicity_constraints). 的变体）可用。</p>
<p>如果需要更多的灵活性，也有一个与 <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a> 的低级接口。该低级变体允许直接指定两个应被约束的面。</p>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceDoFTools.html">DoFTools</a>;</div><div class="line"><a class="code" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">make_periodicity_constraints</a>(face_1,</div><div class="line">                             face_2,</div><div class="line">                             affine_constraints,</div><div class="line">                             component_mask = &lt;<span class="keywordflow">default</span> value&gt;;</div><div class="line">                             face_orientation = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             face_flip = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             face_rotation = &lt;<span class="keywordflow">default</span> value&gt;,</div><div class="line">                             matrix = &lt;<span class="keywordflow">default</span> value&gt;);</div></div><!-- fragment --><p>在这里，我们需要使用 <code>face_orientation</code>, <code>face_flip</code> 和 <code>face_orientation</code>. 来指定两个面的方向。 要想了解更详细的描述，请看 <a class="el" href="namespaceDoFTools.html#a929249499b1e5624728d212e90a8e037">DoFTools::make_periodicity_constraints</a>. 的文档。除了自我解释的 <code>component_mask</code> 和 <code>affine_constraints</code>. 之外，其余的参数与高级接口相同。</p>
<p><a class="anchor" id="problem"></a></p>
<p><a class="anchor" id="Apracticalexample"></a></p><h1>A practical example</h1>
<p>在下文中，我们将展示如何在一个更复杂的例子中使用上述函数。任务是对斯托克斯流的速度分量实施旋转的周期性约束。</p>
<p>在由 \(\Omega=\{{\bf x}\in(0,1)^2:\|{\bf x}\|\in (0.5,1)\}\) 定义的四分之一圆上，我们要解决斯托克斯问题</p>
<p class="formulaDsp">
\begin{eqnarray*} -\Delta \; \textbf{u} + \nabla p &amp;=&amp; (\exp(-100\|{\bf x}-(.75,0.1)^T\|^2),0)^T, \\ -\textrm{div}\; \textbf{u}&amp;=&amp;0,\\ \textbf{u}|_{\Gamma_1}&amp;=&amp;{\bf 0}, \end{eqnarray*}
</p>
<p>其中边界 \(\Gamma_1\) 被定义为 \(\Gamma_1 \dealcoloneq \{x\in \partial\Omega: \|x\|\in\{0.5,1\}\}\) 。对于边界的其余部分，我们将使用周期性边界条件，即</p>
<p class="formulaDsp">
\begin{align*} u_x(0,\nu)&amp;=-u_y(\nu,0)&amp;\nu&amp;\in[0,1]\\ u_y(0,\nu)&amp;=u_x(\nu,0)&amp;\nu&amp;\in[0,1]. \end{align*}
</p>
<p>网格将由 <a class="el" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell()</a>, 生成，该文件还记录了如果其<code>colorize'参数设置为</code>true'，它是如何为其各种边界分配边界指标的。</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p>This example program is a slight modification of <a class="el" href="step_22.html">step-22</a> running in parallel using Trilinos to demonstrate the usage of periodic boundary conditions in deal.II. We thus omit to discuss the majority of the source code and only comment on the parts that deal with periodicity constraints. For the rest have a look at <a class="el" href="step_22.html">step-22</a> and the full source code at the bottom.</p>
<p>In order to implement periodic boundary conditions only two functions have to be modified:</p><ul>
<li><code>StokesProblem&lt;dim&gt;::setup_dofs()</code>: To populate an <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object with periodicity constraints</li>
<li><code>StokesProblem&lt;dim&gt;::create_mesh()</code>: To supply a distributed triangulation with periodicity information.</li>
</ul>
<p>The rest of the program is identical to <a class="el" href="step_22.html">step-22</a>, so let us skip this part and only show these two functions in the following. (The full program can be found in the "Plain program" section below, though.)</p>
<p><a class="anchor" id="Settingupperiodicityconstraintsondistributedtriangulations"></a> </p><h3>Setting up periodicity constraints on distributed triangulations</h3>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::create_mesh()</div><div class="line">{</div><div class="line">  <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> inner_radius = .5;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> outer_radius = 1.;</div><div class="line"></div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell</a>(</div><div class="line">    triangulation, center, inner_radius, outer_radius, 0, <span class="keyword">true</span>);</div></div><!-- fragment --><p>Before we can prescribe periodicity constraints, we need to ensure that cells on opposite sides of the domain but connected by periodic faces are part of the ghost layer if one of them is stored on the local processor. At this point we need to think about how we want to prescribe periodicity. The vertices \(\text{vertices}_2\) of a face on the left boundary should be matched to the vertices \(\text{vertices}_1\) of a face on the lower boundary given by \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) where the rotation matrix \(R\) and the offset \(b\) are given by </p><p class="formulaDsp">
\begin{align*} R=\begin{pmatrix} 0&amp;1\\-1&amp;0 \end{pmatrix}, \quad b=\begin{pmatrix}0&amp;0\end{pmatrix}. \end{align*}
</p>
<p> The data structure we are saving the resulting information into is here based on the <a class="el" href="classTriangulation.html">Triangulation</a>.</p>
<div class="fragment"><div class="line">std::vector&lt;<a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;</div><div class="line">  <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga48cef91f67c38d6ec17912922de00f90">parallel::distributed::Triangulation&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">  periodicity_vector;</div><div class="line"></div><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">rotation_matrix[0][1] = 1.;</div><div class="line">rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(triangulation,</div><div class="line">                                  2,</div><div class="line">                                  3,</div><div class="line">                                  1,</div><div class="line">                                  periodicity_vector,</div><div class="line">                                  <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(),</div><div class="line">                                  rotation_matrix);</div></div><!-- fragment --><p>Now telling the triangulation about the desired periodicity is particularly easy by just calling <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html#aa7b797070e5443a18f03a4a7f0267453">parallel::distributed::Triangulation::add_periodicity</a>.</p>
<div class="fragment"><div class="line">  triangulation.<a class="code" href="classTriangulation.html#adbf04756b28dae69194870812acaf941">add_periodicity</a>(periodicity_vector);</div><div class="line"></div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(4 - dim);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs()</div><div class="line">{</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">  std::vector&lt;unsigned int&gt; block_component(dim + 1, 0);</div><div class="line">  block_component[dim] = 1;</div><div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0], n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">  {</div><div class="line">    owned_partitioning.clear();</div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">    owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">    owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">    relevant_partitioning.<a class="code" href="classIndexSet.html#a8a3d75a9cba3f1a50866691327aa7609">clear</a>();</div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">    <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler,</div><div class="line">                                            locally_relevant_dofs);</div><div class="line">    relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">    relevant_partitioning.push_back(</div><div class="line">      locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">    constraints.clear();</div><div class="line">    constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">    <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             0,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             1,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div></div><!-- fragment --><p>After we provided the mesh with the necessary information for the periodicity constraints, we are now able to actual create them. For describing the matching we are using the same approach as before, i.e., the \(\text{vertices}_2\) of a face on the left boundary should be matched to the vertices \(\text{vertices}_1\) of a face on the lower boundary given by \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) where the rotation matrix \(R\) and the offset \(b\) are given by </p><p class="formulaDsp">
\begin{align*} R=\begin{pmatrix} 0&amp;1\\-1&amp;0 \end{pmatrix}, \quad b=\begin{pmatrix}0&amp;0\end{pmatrix}. \end{align*}
</p>
<p> These two objects not only describe how faces should be matched but also in which sense the solution should be transformed from \(\text{face}_2\) to \(\text{face}_1\).</p>
<div class="fragment"><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">rotation_matrix[0][1] = 1.;</div><div class="line">rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line"><a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> offset;</div></div><!-- fragment --><p>For setting up the constraints, we first store the periodicity information in an auxiliary object of type <code>std::vector&lt;<a class="el" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;typename <a class="el" href="classDoFHandler.html">DoFHandler</a>&lt;dim&gt;::cell_iterator&gt; </code>. The periodic boundaries have the boundary indicators 2 (x=0) and 3 (y=0). All the other parameters we have set up before. In this case the direction does not matter. Due to \(\text{vertices}_2=R\cdot \text{vertices}_1+b\) this is exactly what we want.</p>
<div class="fragment"><div class="line">std::vector&lt;</div><div class="line">  <a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">  periodicity_vector;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> direction = 1;</div><div class="line"></div><div class="line"><a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                  2,</div><div class="line">                                  3,</div><div class="line">                                  direction,</div><div class="line">                                  periodicity_vector,</div><div class="line">                                  offset,</div><div class="line">                                  rotation_matrix);</div></div><!-- fragment --><p>Next, we need to provide information on which vector valued components of the solution should be rotated. Since we choose here to just constraint the velocity and this starts at the first component of the solution vector, we simply insert a 0:</p>
<div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; first_vector_components;</div><div class="line">first_vector_components.push_back(0);</div></div><!-- fragment --><p>After setting up all the information in periodicity_vector all we have to do is to tell make_periodicity_constraints to create the desired constraints.</p>
<div class="fragment"><div class="line">    DoFTools::make_periodicity_constraints&lt;dim, dim&gt;(periodicity_vector,</div><div class="line">                                                     constraints,</div><div class="line">                                                     fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(</div><div class="line">                                                       velocities),</div><div class="line">                                                     first_vector_components);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             0,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                             dof_handler,</div><div class="line">                                             1,</div><div class="line">                                             BoundaryValues&lt;dim&gt;(),</div><div class="line">                                             constraints,</div><div class="line">                                             fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">  }</div><div class="line"></div><div class="line">  constraints.close();</div><div class="line"></div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> bsp(owned_partitioning,</div><div class="line">                                               owned_partitioning,</div><div class="line">                                               relevant_partitioning,</div><div class="line">                                               mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">        <span class="keywordflow">if</span> (!((c == dim) &amp;&amp; (d == dim)))</div><div class="line">          coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    coupling,</div><div class="line">                                    bsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="keyword">false</span>,</div><div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                      mpi_communicator));</div><div class="line"></div><div class="line">    bsp.compress();</div><div class="line"></div><div class="line">    system_matrix.reinit(bsp);</div><div class="line">  }</div><div class="line"></div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> preconditioner_bsp(</div><div class="line">      owned_partitioning,</div><div class="line">      owned_partitioning,</div><div class="line">      relevant_partitioning,</div><div class="line">      mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(dim + 1, dim + 1);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">        <span class="keywordflow">if</span> ((c == dim) &amp;&amp; (d == dim))</div><div class="line">          preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    preconditioner_coupling,</div><div class="line">                                    preconditioner_bsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="keyword">false</span>,</div><div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                      mpi_communicator));</div><div class="line"></div><div class="line">    preconditioner_bsp.compress();</div><div class="line"></div><div class="line">    preconditioner_matrix.reinit(preconditioner_bsp);</div><div class="line">  }</div><div class="line"></div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">  solution.reinit(owned_partitioning,</div><div class="line">                  relevant_partitioning,</div><div class="line">                  mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>The rest of the program is then again identical to <a class="el" href="step_22.html">step-22</a>. We will omit it here now, but as before, you can find these parts in the "Plain program" section below.</p>
<p>examples/step-45/doc/results.dox</p>
<p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>创建的输出结果并不十分令人惊讶。我们只是看到，相对于左、下边界而言，解决方案是周期性的。</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-45.periodic.png"/>
</div>
<p>如果没有周期性约束，我们最终会得到以下解决方案。</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-45.non_periodic.png"/>
</div>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2008 - 2020 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Daniel Arndt, Matthias Maier, 2015</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Based on @ref step_22 &quot;step-22&quot; by Wolfgang Bangerth and Martin Kronbichler</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__solver_8h.html">deal.II/lac/trilinos_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step45</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>StokesProblem</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree);</div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> create_mesh();</div><div class="line">    <span class="keywordtype">void</span> setup_dofs();</div><div class="line">    <span class="keywordtype">void</span> assemble_system();</div><div class="line">    <span class="keywordtype">void</span> solve();</div><div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div><div class="line">    <span class="keywordtype">void</span> refine_mesh();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree;</div><div class="line"></div><div class="line">    <a class="code" href="classMPI__Comm.html">MPI_Comm</a> mpi_communicator;</div><div class="line"></div><div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line">    std::vector&lt;IndexSet&gt;     owned_partitioning;</div><div class="line">    std::vector&lt;IndexSet&gt;     relevant_partitioning;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> system_matrix;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> solution;</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> system_rhs;</div><div class="line"></div><div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line"></div><div class="line">    <a class="code" href="classMappingQ.html">MappingQ&lt;dim&gt;</a> mapping;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>BoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BoundaryValues()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> BoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    (void)component;</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;n_components,</div><div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(component, 0, this-&gt;n_components));</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BoundaryValues&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                         Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div><div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>(c) = BoundaryValues&lt;dim&gt;::value(p, c);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>(0.75, 0.1);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>     r = (p - <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>).<a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (component == 0)</div><div class="line">      <span class="keywordflow">return</span> <a class="code" href="vectorization_8h.html#a19f846bda83b7e3f4531daacb40c64e1">std::exp</a>(-100. * r * r);</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div><div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>(c) = RightHandSide&lt;dim&gt;::value(p, c);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        m,</div><div class="line">                  <span class="keyword">const</span> PreconditionerType &amp;preconditioner,</div><div class="line">                  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;          locally_owned,</div><div class="line">                  <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;          mpi_communicator);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> vmult(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a>         <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const PreconditionerType&gt;</a> preconditioner;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> *                      mpi_communicator;</div><div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div><div class="line">    <span class="keyword">const</span> MatrixType &amp;        m,</div><div class="line">    <span class="keyword">const</span> PreconditionerType &amp;preconditioner,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;          locally_owned,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;          mpi_communicator)</div><div class="line">    : matrix(&amp;m)</div><div class="line">    , preconditioner(&amp;preconditioner)</div><div class="line">    , mpi_communicator(&amp;mpi_communicator)</div><div class="line">    , tmp(locally_owned, mpi_communicator)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keywordtype">void</span> InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult(</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>              solver_control(src.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a78fa29403bbd6da7795fd25700267d47">size</a>(), 1e-6 * src.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a5680a0f82a28f0b980d83f3443cc20ca">l2_norm</a>());</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1SolverCG.html">TrilinosWrappers::SolverCG</a> cg(solver_control,</div><div class="line">                                  <a class="code" href="structTrilinosWrappers_1_1SolverCG_1_1AdditionalData.html">TrilinosWrappers::SolverCG::AdditionalData</a>());</div><div class="line"></div><div class="line">    tmp = 0.;</div><div class="line">    cg.solve(*matrix, tmp, src, *preconditioner);</div><div class="line">    dst = tmp;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keyword">class </span>SchurComplement : <span class="keyword">public</span> TrilinosWrappers::SparseMatrix</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    SchurComplement(<span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;system_matrix,</div><div class="line">                    <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</div><div class="line">                                        PreconditionerType&gt; &amp;  A_inverse,</div><div class="line">                    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;                           owned_pres,</div><div class="line">                    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;mpi_communicator);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="structSUNDIALS_1_1SundialsPreconditioner.html#aff5a880cfa288ecdd2a83a876abacf0d">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a> system_matrix;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;</div><div class="line">      <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix, PreconditionerType&gt;&gt;</div><div class="line">                                          A_inverse;</div><div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp1, tmp2;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  SchurComplement&lt;PreconditionerType&gt;::SchurComplement(</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;system_matrix,</div><div class="line">    <span class="keyword">const</span> InverseMatrix&lt;TrilinosWrappers::SparseMatrix, PreconditionerType&gt;</div><div class="line">      &amp;             A_inverse,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;owned_vel,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classMPI__Comm.html">MPI_Comm</a> &amp;mpi_communicator)</div><div class="line">    : system_matrix(&amp;system_matrix)</div><div class="line">    , A_inverse(&amp;A_inverse)</div><div class="line">    , tmp1(owned_vel, mpi_communicator)</div><div class="line">    , tmp2(tmp1)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div><div class="line">  <span class="keywordtype">void</span> SchurComplement&lt;PreconditionerType&gt;::vmult(</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    system_matrix-&gt;block(0, 1).vmult(tmp1, src);</div><div class="line">    A_inverse-&gt;vmult(tmp2, tmp1);</div><div class="line">    system_matrix-&gt;block(1, 0).vmult(dst, tmp2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  StokesProblem&lt;dim&gt;::StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> degree)</div><div class="line">    : degree(degree)</div><div class="line">    , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">    , triangulation(mpi_communicator)</div><div class="line">    , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(degree + 1), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(degree), 1)</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , pcout(<a class="code" href="namespacestd.html">std</a>::cout, <a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0)</div><div class="line">    , mapping(degree + 1)</div><div class="line">  {}</div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::create_mesh()</div><div class="line">  {</div><div class="line">    <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>   <a class="code" href="data__out__base_8cc.html#a8188ef4709fc9a4cc076d37447783ba1">center</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> inner_radius = .5;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> outer_radius = 1.;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acd7c51b0e8032db65db9a5ff73ccca50">GridGenerator::quarter_hyper_shell</a>(</div><div class="line">      triangulation, center, inner_radius, outer_radius, 0, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    std::vector&lt;<a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair</a>&lt;</div><div class="line">      <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga48cef91f67c38d6ec17912922de00f90">parallel::distributed::Triangulation&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">      periodicity_vector;</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">    rotation_matrix[0][1] = 1.;</div><div class="line">    rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(triangulation,</div><div class="line">                                      2,</div><div class="line">                                      3,</div><div class="line">                                      1,</div><div class="line">                                      periodicity_vector,</div><div class="line">                                      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>(),</div><div class="line">                                      rotation_matrix);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#adbf04756b28dae69194870812acaf941">add_periodicity</a>(periodicity_vector);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(4 - dim);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs()</div><div class="line">  {</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    std::vector&lt;unsigned int&gt; block_component(dim + 1, 0);</div><div class="line">    block_component[dim] = 1;</div><div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0], n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">    {</div><div class="line">      owned_partitioning.clear();</div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div><div class="line">      owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">      owned_partitioning.push_back(locally_owned_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">      relevant_partitioning.<a class="code" href="classIndexSet.html#a8a3d75a9cba3f1a50866691327aa7609">clear</a>();</div><div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">      <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler,</div><div class="line">                                              locally_relevant_dofs);</div><div class="line">      relevant_partitioning.push_back(locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div><div class="line">      relevant_partitioning.push_back(</div><div class="line">        locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div><div class="line"></div><div class="line">      constraints.clear();</div><div class="line">      constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               1,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"></div><div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> rotation_matrix(dim);</div><div class="line">      rotation_matrix[0][1] = 1.;</div><div class="line">      rotation_matrix[1][0] = -1.;</div><div class="line"></div><div class="line">      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> offset;</div><div class="line"></div><div class="line">      std::vector&lt;</div><div class="line">        <a class="code" href="structGridTools_1_1PeriodicFacePair.html">GridTools::PeriodicFacePair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div><div class="line">        periodicity_vector;</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> direction = 1;</div><div class="line"></div><div class="line">      <a class="code" href="namespaceGridTools.html#a213a31f196cd53ccbcc809e567934442">GridTools::collect_periodic_faces</a>(dof_handler,</div><div class="line">                                        2,</div><div class="line">                                        3,</div><div class="line">                                        direction,</div><div class="line">                                        periodicity_vector,</div><div class="line">                                        offset,</div><div class="line">                                        rotation_matrix);</div><div class="line"></div><div class="line">      std::vector&lt;unsigned int&gt; first_vector_components;</div><div class="line">      first_vector_components.push_back(0);</div><div class="line"></div><div class="line">      DoFTools::make_periodicity_constraints&lt;dim, dim&gt;(periodicity_vector,</div><div class="line">                                                       constraints,</div><div class="line">                                                       fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(</div><div class="line">                                                         velocities),</div><div class="line">                                                       first_vector_components);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(mapping,</div><div class="line">                                               dof_handler,</div><div class="line">                                               1,</div><div class="line">                                               BoundaryValues&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">    }</div><div class="line"></div><div class="line">    constraints.close();</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> bsp(owned_partitioning,</div><div class="line">                                                 owned_partitioning,</div><div class="line">                                                 relevant_partitioning,</div><div class="line">                                                 mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (!((c == dim) &amp;&amp; (d == dim)))</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                      coupling,</div><div class="line">                                      bsp,</div><div class="line">                                      constraints,</div><div class="line">                                      <span class="keyword">false</span>,</div><div class="line">                                      <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                        mpi_communicator));</div><div class="line"></div><div class="line">      bsp.compress();</div><div class="line"></div><div class="line">      system_matrix.reinit(bsp);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> preconditioner_bsp(</div><div class="line">        owned_partitioning,</div><div class="line">        owned_partitioning,</div><div class="line">        relevant_partitioning,</div><div class="line">        mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> ((c == dim) &amp;&amp; (d == dim))</div><div class="line">            preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            preconditioner_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                      preconditioner_coupling,</div><div class="line">                                      preconditioner_bsp,</div><div class="line">                                      constraints,</div><div class="line">                                      <span class="keyword">false</span>,</div><div class="line">                                      <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div><div class="line">                                        mpi_communicator));</div><div class="line"></div><div class="line">      preconditioner_bsp.compress();</div><div class="line"></div><div class="line">      preconditioner_matrix.reinit(preconditioner_bsp);</div><div class="line">    }</div><div class="line"></div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">    solution.reinit(owned_partitioning,</div><div class="line">                    relevant_partitioning,</div><div class="line">                    mpi_communicator);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">  {</div><div class="line">    system_matrix         = 0.;</div><div class="line">    system_rhs            = 0.;</div><div class="line">    preconditioner_matrix = 0.;</div><div class="line"></div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(degree + 2);</div><div class="line"></div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(mapping,</div><div class="line">                            fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_preconditioner_matrix(dofs_per_cell,</div><div class="line">                                                   dofs_per_cell);</div><div class="line">    Vector&lt;double&gt;     local_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, Vector&lt;double&gt;(dim + 1));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div><div class="line"></div><div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; symgrad_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;                  div_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;                  phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">        {</div><div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">          local_matrix                = 0;</div><div class="line">          local_preconditioner_matrix = 0;</div><div class="line">          local_rhs                   = 0;</div><div class="line"></div><div class="line">          right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                            rhs_values);</div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">                {</div><div class="line">                  symgrad_phi_u[k] =</div><div class="line">                    fe_values[velocities].symmetric_gradient(k, q);</div><div class="line">                  div_phi_u[k] = fe_values[velocities].divergence(k, q);</div><div class="line">                  phi_p[k]     = fe_values[pressure].value(k, q);</div><div class="line">                }</div><div class="line"></div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt;= i; ++j)</div><div class="line">                    {</div><div class="line">                      local_matrix(i, j) +=</div><div class="line">                        (symgrad_phi_u[i] * symgrad_phi_u[j] <span class="comment">// diffusion</span></div><div class="line">                         - div_phi_u[i] * phi_p[j]           <span class="comment">// pressure force</span></div><div class="line">                         - phi_p[i] * div_phi_u[j])          <span class="comment">// divergence</span></div><div class="line">                        * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                      local_preconditioner_matrix(i, j) +=</div><div class="line">                        (phi_p[i] * phi_p[j]) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                    }</div><div class="line"></div><div class="line">                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                    fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                  local_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q)  </div><div class="line">                                  * rhs_values[q](component_i) </div><div class="line">                                  * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = i + 1; j &lt; dofs_per_cell; ++j)</div><div class="line">              {</div><div class="line">                local_matrix(i, j) = local_matrix(j, i);</div><div class="line">                local_preconditioner_matrix(i, j) =</div><div class="line">                  local_preconditioner_matrix(j, i);</div><div class="line">              }</div><div class="line"></div><div class="line">          cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">          constraints.distribute_local_to_global(local_matrix,</div><div class="line">                                                 local_rhs,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 system_rhs);</div><div class="line">          constraints.distribute_local_to_global(local_preconditioner_matrix,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 preconditioner_matrix);</div><div class="line">        }</div><div class="line"></div><div class="line">    system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Computing preconditioner...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a> A_preconditioner;</div><div class="line">    A_preconditioner.<a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html#a89c6576dd9f2b29fc545f25f753d4579">initialize</a>(system_matrix.block(0, 0));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">TrilinosWrappers::SparseMatrix</a>,</div><div class="line">                        <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div><div class="line">      A_inverse(system_matrix.block(0, 0),</div><div class="line">                A_preconditioner,</div><div class="line">                owned_partitioning[0],</div><div class="line">                mpi_communicator);</div><div class="line"></div><div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> tmp(owned_partitioning,</div><div class="line">                                           mpi_communicator);</div><div class="line"></div><div class="line">    {</div><div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> schur_rhs(owned_partitioning[1],</div><div class="line">                                              mpi_communicator);</div><div class="line">      A_inverse.vmult(tmp.block(0), system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div><div class="line">      system_matrix.block(1, 0).vmult(schur_rhs, tmp.block(0));</div><div class="line">      schur_rhs -= system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1);</div><div class="line"></div><div class="line">      SchurComplement&lt;TrilinosWrappers::PreconditionJacobi&gt; <a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>(</div><div class="line">        system_matrix, A_inverse, owned_partitioning[0], mpi_communicator);</div><div class="line"></div><div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(solution.block(1).size(),</div><div class="line">                                   1e-6 * schur_rhs.l2_norm());</div><div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line"></div><div class="line">      TrilinosWrappers::PreconditionAMG preconditioner;</div><div class="line">      preconditioner.<a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">initialize</a>(preconditioner_matrix.block(1, 1));</div><div class="line"></div><div class="line">      InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">TrilinosWrappers::SparseMatrix</a>,</div><div class="line">                    TrilinosWrappers::PreconditionAMG&gt;</div><div class="line">        m_inverse(preconditioner_matrix.block(1, 1),</div><div class="line">                  preconditioner,</div><div class="line">                  owned_partitioning[1],</div><div class="line">                  mpi_communicator);</div><div class="line"></div><div class="line">      cg.solve(<a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>, tmp.block(1), schur_rhs, preconditioner);</div><div class="line"></div><div class="line">      constraints.distribute(tmp);</div><div class="line">      solution.block(1) = tmp.block(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      system_matrix.block(0, 1).vmult(tmp.block(0), tmp.block(1));</div><div class="line">      tmp.block(0) *= -1;</div><div class="line">      tmp.block(0) += system_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0);</div><div class="line"></div><div class="line">      A_inverse.vmult(tmp.block(0), tmp.block(0));</div><div class="line"></div><div class="line">      constraints.distribute(tmp);</div><div class="line">      solution.block(0) = tmp.block(0);</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span></div><div class="line">  StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line"></div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">      data_component_interpretation(</div><div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation.push_back(</div><div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(solution,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line">    Vector&lt;float&gt; subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(mapping, degree + 1);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, refinement_cycle, MPI_COMM_WORLD, 2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_mesh()</div><div class="line">  {</div><div class="line">    Vector&lt;float&gt; estimated_error_per_cell(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line"></div><div class="line">    <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div><div class="line">    <a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div><div class="line">      dof_handler,</div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(degree + 1),</div><div class="line">      std::map&lt;<a class="code" href="classunsigned_01int.html">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div><div class="line">      solution,</div><div class="line">      estimated_error_per_cell,</div><div class="line">      fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(pressure));</div><div class="line"></div><div class="line">    <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#aa2ffb707a796ae6dedb75036606ef2e6">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_number</a>(</div><div class="line">      triangulation, estimated_error_per_cell, 0.3, 0.0);</div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line">    create_mesh();</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 9;</div><div class="line">         ++refinement_cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div><div class="line">          refine_mesh();</div><div class="line"></div><div class="line">        setup_dofs();</div><div class="line"></div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div><div class="line">        assemble_system();</div><div class="line"></div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::flush;</div><div class="line">        solve();</div><div class="line"></div><div class="line">        output_results(refinement_cycle);</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">} <span class="comment">// namespace Step45</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step45;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line">      StokesProblem&lt;2&gt;                 flow_problem(1);</div><div class="line">      flow_problem.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
