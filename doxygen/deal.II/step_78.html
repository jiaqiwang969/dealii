<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_78.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-78 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The step-78 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_26.html">step-26</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Particularitiesoftheequationsystem">Particularities of the equation system</a>
        <li><a href="#Schemeforthenumericalsolution">Scheme for the numerical solution</a>
        <li><a href="#TestCase">Test Case</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#SolutionClass">Solution Class</a>
        <li><a href="#EquationData">Equation Data</a>
        <li><a href="#ThecodeBlackScholescodeClass">The <code>BlackScholes</code> Class</a>
        <li><a href="#ThecodeBlackScholescodeImplementation">The <code>BlackScholes</code> Implementation</a>
      <ul>
        <li><a href="#codeBlackScholessetup_systemcode"><code>BlackScholes::setup_system</code></a>
        <li><a href="#codeBlackScholessolve_time_stepcode"><code>BlackScholes::solve_time_step</code></a>
        <li><a href="#codeBlackScholesadd_results_for_outputcode"><code>BlackScholes::add_results_for_output</code></a>
        <li><a href="#codeBlackScholesrefine_gridcode"><code>BlackScholes::refine_grid</code></a>
        <li><a href="#codeBlackScholesprocess_solutioncode"><code>BlackScholes::process_solution</code></a>
        <li><a href="#codeBlackScholeswrite_convergence_tablecode"><code>BlackScholes::write_convergence_table</code> </a>
        <li><a href="#codeBlackScholesruncode"><code>BlackScholes::run</code></a>
      </ul>
        <li><a href="#ThecodemaincodeFunction">The <code>main</code> Function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>The Black-Scholes equation is a partial differential equation that falls a bit out of the ordinary scheme. It describes what the fair price of a "European
call" stock option is. Without going into too much detail, a stock "option" is a contract one can buy from a bank that allows me, but not requires me, to buy a specific stock at a fixed price \(K\) at a fixed future time \(T\) in the future. The question one would then want to answer as a buyer of such an option is "How much do I think such a contract is worth?", or as the seller "How much do I need to charge for this contract?", both as a function of the time \(t&lt;T\) before the contract is up at time \(T\) and as a function of the stock price \(S\). Fischer Black and Myron Scholes derived a partial differential equation for the fair price \(V(S,t)\) for such options under the assumption that stock prices exhibit random price fluctuations with a given level of "volatility" plus a background exponential price increase (which one can think of as the inflation rate that simply devalues all money over time). For their work, Black and Scholes received the Nobel Prize in Economic Sciences in 1997, making this the first tutorial program dealing with a problem for which someone has gotten a Nobel Prize <b>[black1973pricing]</b>.</p>
<p>The equation reads as follows: </p><p class="formulaDsp">
\begin{align*} &amp;\frac{\partial V}{\partial t} + \frac{\sigma^2S^2}{2} \ \frac{\partial^2 V}{\partial S^2} + \ rS\frac{\partial V}{\partial S} - rV = 0, \ \quad\quad &amp;&amp;\forall S\in \Omega, t \in (0,T) \\ &amp;V(0,t) = 0, \ &amp;&amp;\forall t \in (0,T) \\ &amp;V(S,t) \rightarrow S, \ &amp;&amp; \text{as } S \rightarrow \infty, \forall t \in (0,T) \\ &amp;V(S,T) = \max(S-K,0) \ &amp;&amp;\forall S \in \Omega \end{align*}
</p>
<p> where </p><p class="formulaDsp">
\begin{align*} V(S,t): &amp;&amp; \text{Value of call option at time t and asset price S} \\ \sigma: &amp;&amp; \text{Volatility of the underlying asset} \\ r: &amp;&amp; \text{Risk free interest rate} \\ K : &amp;&amp; \text{Strike price for purchasing asset} \end{align*}
</p>
<p>The way we should interpret this equation is that it is a time-dependent partial differential equation of one "space" variable \(S\) as the price of the stock, and \(V(S,t)\) is the price of the option at time \(t\) if the stock price at that time were \(S\).</p>
<p><a class="anchor" id="Particularitiesoftheequationsystem"></a></p><h3>Particularities of the equation system</h3>
<p>There are a number of oddities in this equation that are worth discussing before moving on to its numerical solution. First, the "spatial" domain \(\Omega\subset\mathbb{R}\) is unbounded, and thus \(S\) can be unbounded in value. This is because there may be a practical upper bound for stock prices, but not a conceptual one. The boundary conditions \(V(S,t)\rightarrow S\) as \(S\rightarrow \infty\) can then be interpreted as follows: What is the value of an option that allows me to buy a stock at price \(K\) if the stock price (today or at time \(t=T\)) is \(S\gg K\)? One would expect that it is \(V\approx S-K\) plus some adjustment for inflation, or, if we really truly consider huge values of \(S\), we can neglect \(K\) and arrive at the statement that the boundary values at the infinite boundary should be of the form \(V\rightarrow S\) as stated above.</p>
<p>In practice, for us to use a finite element method to solve this, we are going to need to bound \(\Omega\). Since this equation describes prices, and it doesn't make sense to talk about prices being negative, we will set the lower bound of \(\Omega\) to be 0. Then, for an upper bound, we will choose a very large number, one that \(S\) is not very likely to ever get to. We will call this \(S_\text{max}\). So, \(\Omega=[0,S_\text{max}]\).</p>
<p>Second, after truncating the domain, we need to ask what boundary values we should pose at this now finite boundary. To take care of this, we use "put-call" parity <b>[stoll1969relationship]</b>. A "pull option" is one in which we are allowed, but not required, to <em>sell</em> a stock at price \(K\) to someone at a future time \(T\). This says </p><p class="formulaDsp">
\begin{align*} V(S,t)+Ke^{-r(T-t)}=P(S,t)+S \end{align*}
</p>
<p> where \(V(S,t)\) is the value of the call option, and \(P(S,t)\) is the value of the put option. Since we expect \(P(S,t) \rightarrow 0\) as \(S \rightarrow \infty\), this says </p><p class="formulaDsp">
\begin{align*} V(S,t) \rightarrow S-Ke^{-r(T-t)}, \end{align*}
</p>
<p> and we can use this as a reasonable boundary condition at our finite point \(S_\text{max}\).</p>
<p>The second complication of the Block-Scholes equation is that we are given a final condition, and not an initial condition. This is because we know what the option is worth at time \(t=T\): If the stock price at \(T\) is \(S&lt;K\), then we have no incentive to use our option of buying a price \(K\) because we can buy that stock for cheaper on the open market. So \(V(S,T)=0\) for \(S&lt;K\). On the other hand, if at time \(T\) we have \(S&gt;K\), then we can buy the stock at price \(K\) via the option and immediately sell it again on the market for price \(S\), giving me a profit of \(S-K\). In other words, \(V(S,T)=S-K\) for \(S&gt;K\). So, we only know values for \(V\) at the <em>end time</em> but not the initial time &ndash; in fact, finding out what a fair price at the current time (conventionally taken to be \(t=0\)) is what solving these equations is all about.</p>
<p>This means that this is not an equation that is posed going forward in time, but in fact going <em>backward</em> in time. Thus it makes sense to solve this problem in reverse by making the change of variables \(\tau=T-t\) where now \(\tau\) denotes the time before the strike time \(T\).</p>
<p>With all of this, we finally end up with the following problem: </p><p class="formulaDsp">
\begin{align*} &amp;-\frac{\partial V}{\partial \tau} + \frac{\sigma^2S^2}{2} \ \frac{\partial^2 V}{\partial S^2} + rS\frac{\partial V}{\partial S} - rV=0\ , \quad\quad &amp;&amp;\forall S\in [0,S_\text{max}], \tau \in [0,T] \\ &amp;V(0,\tau) = 0, \ &amp;&amp;\forall \tau \in [0,T] \\ &amp;V(S_\text{max},\tau)=S_\text{max}-Ke^{-r\tau}, \ &amp;&amp;\forall \tau \in [0,T] \\ &amp;V(S,0) = \max(S-K,0) \ &amp;&amp;\forall S \in [0,S_\text{max}] \end{align*}
</p>
<p>Conceptually, this is an advection-diffusion-reaction problem for the variable \(V\): There is both a second-order derivative diffusion term, a first-order derivative advection term, and a zeroth-order reaction term. We can expect this problem to be a little bit forgiving in practice because for realistic values of the coefficients, it is diffusive dominated. But, because of the advective terms in the problem, we will have to be careful with mesh refinement and time step choice. There is also the issue that the diffusion term is written in a non-conservative form and so integration by parts is not immediately obvious. This will be discussed in the next section.</p>
<p><a class="anchor" id="Schemeforthenumericalsolution"></a></p><h3>Scheme for the numerical solution</h3>
<p>We will solve this problem using an IMEX method. In particular, we first discretize in time with the theta method and will later pick different values of theta for the advective and diffusive terms. Let \(V^n(S)\) approximate \(V(S,\tau_n)\): </p><p class="formulaDsp">
\begin{align*} 0=&amp;-\frac{V^n(S)-V^{n-1}(S)}{k_n} \\ &amp;+\frac{\sigma^2S^2}{2}\left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right] \\ &amp;+rS\left[(1-\theta)\frac{dV^{n-1}(S)}{dS} + \ \theta\frac{dV^{n}(S)}{dS}\right] \\ &amp;-r\left[(1-\theta)V^{n-1}(S) + \theta V^n(S)\right] \end{align*}
</p>
<p> Here, \(k_n=\tau_n-\tau_{n-1}\) is the time step size. Given this time discretization, we can proceed to discretize space by multiplying with test functions and then integrating by parts. Because there are some interesting details in this due to the advective and non-advective terms in this equation, this process will be explained in detail.</p>
<p>So, we begin by multiplying by test functions, \(\{\phi_i(S)\}_{i\in\mathbb{N}}\): </p><p class="formulaDsp">
\begin{align*} 0=&amp;-\int_0^{S_\text{max}}\phi_i(S)\left[V^n(S)-V^{n-1}(S)\right]dS \\ &amp;+k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \ \left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;+k_n\int_0^{S_\text{max}}\phi_i(S)\left[rS\left[(1-\theta) \frac{dV^{n-1}(S)}{dS}\ + \theta\frac{dV^{n}(S)}{dS}\right]\right]dS \\ &amp;-k_n\int_0^{S_\text{max}}\phi_i(S)\left[r\left[(1-\theta)V^{n-1}(S)\ + \theta V^n(S)\right]\right]dS \end{align*}
</p>
<p>As usual, (1) becomes \(-\textbf{M}V^n+\textbf{M}V^{n-1}\) and (4) becomes \(k_n\left[-r(1-\theta)\textbf{M}V^{n-1} - \theta r\textbf{M}V^n\right]\), where \(\textbf{M}_{i,j}=\left(\phi_i(S),\phi_j(S)\right)\), and where we have taken the liberty of denoting by \(V\) not only the function \(V(S)\) but also the vector of nodal values after discretization.</p>
<p>The interesting parts come from (2) and (3).</p>
<p>For (2), we have: </p><p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \ \left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;=k_n(1-\theta)\int_0^{S_\text{max}}\phi_i(S)\frac{\sigma^2S^2}{2} \ \frac{d^2V^{n-1}(S)}{dS^2} \ +k_n\theta\int_0^{S_\text{max}}\phi_i(S)\frac{\sigma^2S^2}{2} \ \frac{d^2V^{n}(S)}{dS^2} \end{align*}
</p>
<p>There are two integrals here, that are more or less the same, with the differences being a slightly different coefficient in front of the integral, and a different time step for V. Therefore, we will outline this integral in the general case, and account for the differences at the end. So, consider the general integral, which we will solve using integration by parts: </p><p class="formulaDsp">
\begin{align*} &amp;\int_{0}^{S_\text{max}} \phi_i(S)\frac{\sigma^2S^2}{2} \frac{d^2V^n(S)}{dS^2}dS \\ &amp;= \phi_i(S)\frac{1}{2}\sigma^2S^2\frac{dV^n(S)}{dS}\Bigg|_0^{S_{max}} - \ \int_0^{S_\text{max}} \phi_i(S)\sigma^2S\frac{dV^n(S)}{dS}dS - \ \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2}\sigma^2S^2 \ \frac{dV^n(S)}{dS}dS \\ &amp;= -\int_0^{S_\text{max}} \phi_i(S)\sigma^2S\frac{dV^n(S)}{dS}dS - \ \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2}\sigma^2S^2 \ \frac{dV^n(S)}{dS}dS \\ &amp;= -\int_0^{S_\text{max}} \phi_i(S)\sigma^2S \sum_j V_j^n \frac{d\phi_j(S)}{dS}dS \ -\int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2} \ \sigma^2S^2 \sum_k V_k^n \frac{d\phi_k(S)}{dS}dS \\ &amp;= -\sum_j \sigma^2 \int_0^{S_\text{max}} \phi_i(S)S \frac{d\phi_j(S)}{dS}dS V_j^n\ - \sum_k \frac{1}{2}\sigma^2 \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}S^2\ \frac{d\phi_k}{dS}dS V_k^n \\ &amp;= -\sum_j \sigma^2 \left(\phi_i(S)S, \frac{d\phi_j(S)}{dS}\right) V_j^n \ - \sum_k \frac{1}{2}\sigma^2 \left(\frac{d\phi_i(S)}{dS}S^2,\ \frac{d\phi_k(S)}{dS}\right) V_k^n \\ &amp;= -\sigma^2\textbf{B}V^n - \frac{1}{2}\sigma^2\textbf{D}V^n, \quad\quad \ \textbf{B}_{i,j} = \left(\phi_i(S)S, \frac{d\phi_j(S)}{dS}\right),\ \textbf{D}_{i,j} = \left(\frac{d\phi_i(S)}{dS}S^2,\frac{d\phi_j(S)}{dS}\right) \end{align*}
</p>
<p>So, after adding in the constants and exchanging \(V^n\) for \(V^{n-1}\) where applicable, we arrive at the following for (2): </p><p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \left[(1-\theta)\ \frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;= k_n\left[-(1-\theta)\sigma^2\textbf{B}V^{n-1}\ -(1-\theta)\frac{1}{2}\sigma^2\textbf{D}V^{n-1} \ -\theta\sigma^2\textbf{B}V^{n} -\theta\frac{1}{2}\sigma^2\textbf{D}V^{n}\right] \end{align*}
</p>
<p> But, because the matrix \(\textbf{B}\) involves an advective term, we will choose \(\theta=0\) there &ndash; in other words, we use an explicit Euler method to treat advection. Conversely, since the matrix \(\textbf{D}\) involves the diffusive term, we will choose \(\theta=1/2\) there &ndash; i.e., we treat diffusion using the second order Crank-Nicolson method.</p>
<p>So, we arrive at the following: </p><p class="formulaDsp">
\begin{align*} k_n\left[-\frac{1}{4}\sigma^2\textbf{D}V^{n-1} \ -\frac{1}{4}\sigma^2\textbf{D}V^n \ - \sigma^2\textbf{B}V^{n-1}\right] \end{align*}
</p>
<p>Now, to handle (3). For this, we will again proceed by considering the general case like above.</p>
<p class="formulaDsp">
\begin{align*} &amp;\int_{0}^{S_\text{max}} \phi_i(S)rS\frac{dV^n}{dS}dS \\ &amp;= \phi_i(S)rSV^n\Bigg|_0^{S_\text{max}} - \int_0^{S_\text{max}} \left[r\phi_i(S) \ + r\frac{d\phi_i(S)}{dS}S \right]V^ndS \\ &amp;= -\int_0^{S_\text{max}} r\phi_i(S)V^ndS - \ \int_0^{S_\text{max}} r\frac{d\phi_i(S)}{dS}SV^ndS \\ &amp;= -\int_0^{S_\text{max}} r\phi_i(S) \sum_j V_j^n\phi_j(S)dS \ -\int_0^{S_\text{max}} rS\frac{d\phi_i(S)}{dS} \sum_k V_k\phi_k(S)dS \\ &amp;= -\sum_j r\left(\phi_i(S), \phi_j(S)\right) V_j^n -\ \sum_k r\left(S\frac{d\phi_i(S)}{dS}, \phi_k(S)\right)V_k^n \\ &amp;= -r\textbf{M}V^n -r\textbf{A}V^n, \quad\quad\ \textbf{M}_{i,j} = \left(\phi_i(S), \phi_j(S)\right),\ \textbf{A}_{i,j} = \left(S\frac{d\phi_i(S)}{dS}, \phi_j(S)\right) \end{align*}
</p>
<p>So, again after adding in the constants and exchanging \(V^n\) for \(V^{n-1}\) where applicable, we arrive at the following for (3): </p><p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[rS\left[(1-\theta) \frac{dV^{n-1}(S)}{dS} +\ \theta\frac{dV^{n}(S)}{dS}\right]\right]dS \\ &amp;= k_n\left[-(1-\theta)r\textbf{M}V^{n-1} -(1-\theta)r\textbf{A}V^{n-1}\ -\theta r\textbf{M}V^n -\theta r\textbf{A}V^n\right] \end{align*}
</p>
<p> Just as before, we will use \(\theta=0\) for the matrix \(\textbf{A}\) and \(\theta=\frac{1}{2}\) for the matrix \(\textbf{M}\). So, we arrive at the following for (3): </p><p class="formulaDsp">
\begin{align*} k_n\left[-\frac{1}{2}r\textbf{M}V^{n-1} - \frac{1}{2}r\textbf{M}V^n \ -r\textbf{A}V^{n-1}\right] \end{align*}
</p>
<p>Now, putting everything together, we obtain the following discrete form for the Black-Scholes Equation: </p><p class="formulaDsp">
\begin{align*} 0&amp;= \\ &amp;-\textbf{M}V^n+\textbf{M}V^{n-1} \\ &amp; +k_n\left[-\frac{1}{4}\sigma^2\textbf{D}V^{n-1} \ -\frac{1}{4}\sigma^2\textbf{D}V^n \ - \sigma^2\textbf{B}V^n \ -\frac{1}{2}r\textbf{M}V^{n-1} - \frac{1}{2}r\textbf{M}V^n \ -r\textbf{A}V^n \ -r\frac{1}{2}\textbf{M}V^{n-1} - \frac{1}{2} r\textbf{M}V^n\right] \\ &amp;= -\textbf{M}V^n + \textbf{M}V^{n-1} +\ k_n\left[- \frac{1}{4}\sigma^2\textbf{D}V^{n-1} -\ \frac{1}{4}\sigma^2\textbf{D}V^n - r\textbf{M}V^{n-1} -\ r\textbf{M}V^n - \sigma^2\textbf{B}V^{n-1} - r\textbf{A}V^{n-1}\right] \end{align*}
</p>
<p> So, altogether we have:</p>
<p class="formulaDsp">
\begin{equation} 0 = \textbf{M}V^n - \textbf{M}V^{n-1} +\ k_n\left[ \frac{1}{4}\sigma^2\textbf{D}V^{n-1} +\ \frac{1}{4}\sigma^2\textbf{D}V^n + r\textbf{M}V^{n-1} + r\textbf{M}V^n +\ \sigma^2\textbf{B}V^{n-1} + r\textbf{A}V^{n-1}\right]\tag{*} \end{equation}
</p>
<p>As usual, we can write this with the unknown quantities on the left and the known ones on the right. This leads to the following linear system that would have to be solved in each time step:</p>
<p class="formulaDsp">
\begin{align*} \left[\textbf{M}+\frac{1}{4}k_n\sigma^2\textbf{D}+k_nr\textbf{M}\right]V^n\ =\ \left[-\frac{1}{4}k_n\sigma^2\textbf{D}-\ k_nr\textbf{M}+k_n\sigma^2\textbf{B}-\ k_nr\textbf{A}+\textbf{M}\right]V^{n-1} \end{align*}
</p>
<p><a class="anchor" id="TestCase"></a></p><h3>Test Case</h3>
<p>For this program, we will use the Method of Manufactured Solutions (MMS) to test that it is working correctly. This means that we will choose our solution to be a certain function similar to <a class="el" href="step_7.html">step-7</a>. For our case, we will use: </p><p class="formulaDsp">
\begin{align*} V(S,\tau) = -\tau^2 - S^2 + 6\tag{**} \end{align*}
</p>
<p> This means that, using our PDE, we arrive at the following problem: </p><p class="formulaDsp">
\begin{align*} &amp;-\frac{\partial V}{\partial \tau} +\ \frac{\sigma^2S^2}{2}\frac{\partial^2 V}{\partial S^2} +\ rS\frac{\partial V}{\partial S} - rV = f(S,\tau) \\ &amp;V(0,\tau) = -\tau^2 + 6 \\ &amp;V(S_\text{max}, \tau) = -S_\text{max}^2 - \tau^2 + 6 \\ &amp;V(S, 0) = -S^2 + 6 \end{align*}
</p>
<p> Where, \(f(S,\tau) = 2\tau - \sigma^2S^2 - 2rS^2 - r(-\tau^2 - S^2 + 6)\). This set-up now has right hand sides for the equation itself and for the boundary conditions at \(S=0\) that we did not have before, along with "final" conditions (or, with \(\tau\)-time "initial conditions") that do not match the real situation. We will implement this in such a way in the code that it is easy to exchange &ndash; the introduction of the changes above is just meant to enable the use of a manufactured solution.</p>
<p>If the program is working correctly, then it should produce (**) as the solution. This does mean that we need to modify our variational form somewhat to account for the non-zero right hand side.</p>
<p>First, we define the following: </p><p class="formulaDsp">
\begin{align*} F^n_i = \left(\phi_i(S), f^n(S)\right), &amp;&amp; \text{where } f^n(S) =\ f(S,\tau_n) \end{align*}
</p>
<p> So, we arrive at the new equation:</p>
<p class="formulaDsp">
\begin{align*} \left[\textbf{M}+\frac{1}{4}k_n\sigma^2\textbf{D}+k_nr\textbf{M}\right]V^n\ =\ \left[-\frac{1}{4}k_n\sigma^2\textbf{D}-\ k_nr\textbf{M}+k_n\sigma^2\textbf{B}-\ k_nr\textbf{A}+\textbf{M}\right]V^{n-1} -\ k_n\left[\frac{1}{2}F^{n-1}+\frac{1}{2}F^n\right] \end{align*}
</p>
<p>We then solve this equation as outlined above.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The program starts with the usual include files, all of which you should have seen before by now:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="convergence__table_8h.html">deal.II/base/convergence_table.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__accessor_8h.html">deal.II/dofs/dof_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__accessor_8h.html">deal.II/grid/tria_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__iterator_8h.html">deal.II/grid/tria_iterator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="data__out__stack_8h.html">deal.II/numerics/data_out_stack.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div></div><!-- fragment --><p>Then the usual placing of all content of this program into a namespace and the importation of the deal.II namespace into the one we will work in. We also define an identifier to allow for the MMS code to be run when <code>MMS</code> is defined. Otherwise, the program solves the original problem:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>BlackScholesSolver</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#define MMS</span></div></div><!-- fragment --><p><a class="anchor" id="SolutionClass"></a> </p><h3>Solution Class</h3>
<p>This section creates a class for the known solution when testing using the MMS. Here we are using \(v(\tau,S) = -\tau^2 -S^2 + 6\) for the solution. We need to include the solution equation and the gradient for the H1 seminorm calculation.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>Solution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a></div><div class="line">  <a class="code" href="classFunction.html#a4b0aadc89a827b39c20f12889aa88625">gradient</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">Solution&lt;dim&gt;::Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time)</div><div class="line">  : maturity_time(maturity_time)</div><div class="line">{</div><div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> Solution&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">         Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> Solution&lt;dim&gt;::gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2 * p(component));</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="EquationData"></a> </p><h3>Equation Data</h3>
<p>In the following classes and functions, we implement the right hand side and boundary values that define this problem and for which we need function objects. The right hand side is chosen as discussed at the end of the introduction.</p>
<p>First, we handle the initial condition.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>InitialConditions : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  InitialConditions&lt;dim&gt;::InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price)</div><div class="line">    : strike_price(strike_price)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> InitialConditions&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(p(component) - strike_price, 0.);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">  }</span></div></div><!-- fragment --><p>Next, we handle the left boundary condition.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>LeftBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> LeftBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;,</div><div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="classFunctionTime.html#ae7d37ddb04314b38cf67c6cba22923f6">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> 0.;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">  }</span></div></div><!-- fragment --><p>Then, we handle the right boundary condition.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightBoundaryValues&lt;dim&gt;::RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price,</div><div class="line">                                                <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : strike_price(strike_price)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> (p(component) - strike_price) *</div><div class="line">           <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>((-interest_rate) * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()));</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">  }</span></div></div><!-- fragment --><p>Finally, we handle the right hand side.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightHandSide&lt;dim&gt;::RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : asset_volatility(asset_volatility)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> 2 * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(asset_volatility * p(component)) -</div><div class="line">           2 * interest_rate * Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           interest_rate *</div><div class="line">             (-Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">              Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    (void)p;</div><div class="line">    (void)component;</div><div class="line">    <span class="keywordflow">return</span> 0.0;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">  }</span></div></div><!-- fragment --><p><a class="anchor" id="ThecodeBlackScholescodeClass"></a> </p><h3>The <code>BlackScholes</code> Class</h3>
<p>The next piece is the declaration of the main class of this program. This is very similar to the <a class="el" href="step_26.html">step-26</a> tutorial, with some modifications. New matrices had to be added to calculate the A and B matrices, as well as the \(V_{diff}\) vector mentioned in the introduction. We also define the parameters used in the problem.</p>
<ul>
<li><code>maximum_stock_price</code>: The imposed upper bound on the spatial domain. This is the maximum allowed stock price.</li>
<li><code>maturity_time</code>: The upper bound on the time domain. This is when the option expires.<br />
</li>
<li><code>asset_volatility</code>: The volatility of the stock price.<br />
</li>
<li><code>interest_rate</code>: The risk free interest rate.<br />
</li>
<li><code>strike_price</code>: The agreed upon price that the buyer will have the option of purchasing the stocks at the expiration time.</li>
</ul>
<p>Some slight differences between this program and <a class="el" href="step_26.html">step-26</a> are the creation of the <code>a_matrix</code> and the <code>b_matrix</code>, which is described in the introduction. We then also need to store the current time, the size of the time step, and the number of the current time step. Next, we will store the output into a <code><a class="el" href="classDataOutStack.html">DataOutStack</a></code> variable because we will be layering the solution at each time on top of one another to create the solution manifold. Then, we have a variable that stores the current cycle and number of cycles that we will run when calculating the solution. The cycle is one full solution calculation given a mesh. We refine the mesh once in between each cycle to exhibit the convergence properties of our program. Finally, we store the convergence data into a convergence table.</p>
<p>As far as member functions are concerned, we have a function that calculates the convergence information for each cycle, called <code>process_solution</code>. This is just like what is done in <a class="el" href="step_7.html">step-7</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>BlackScholes</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  BlackScholes();</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> setup_system();</div><div class="line">  <span class="keywordtype">void</span> solve_time_step();</div><div class="line">  <span class="keywordtype">void</span> refine_grid();</div><div class="line">  <span class="keywordtype">void</span> process_solution();</div><div class="line">  <span class="keywordtype">void</span> add_results_for_output();</div><div class="line">  <span class="keywordtype">void</span> write_convergence_table();</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maximum_stock_price;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line"></div><div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div><div class="line"></div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div><div class="line">  SparseMatrix&lt;double&gt; <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div><div class="line">  SparseMatrix&lt;double&gt; laplace_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; a_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; b_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; system_matrix;</div><div class="line"></div><div class="line">  Vector&lt;double&gt; solution;</div><div class="line">  Vector&lt;double&gt; system_rhs;</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> time;</div><div class="line">  <span class="keywordtype">double</span> time_step;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       theta;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_time_steps;</div><div class="line"></div><div class="line">  <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;</a>        data_out_stack;</div><div class="line">  std::vector&lt;std::string&gt; solution_names;</div><div class="line"></div><div class="line">  <a class="code" href="classConvergenceTable.html">ConvergenceTable</a> convergence_table;</div><div class="line">};</div></div><!-- fragment --><p><a class="anchor" id="ThecodeBlackScholescodeImplementation"></a> </p><h3>The <code>BlackScholes</code> Implementation</h3>
<p>Now, we get to the implementation of the main class. We will set the values for the various parameters used in the problem. These were chosen because they are fairly normal values for these parameters. Although the stock price has no upper bound in reality (it is in fact infinite), we impose an upper bound that is twice the strike price. This is a somewhat arbitrary choice to be twice the strike price, but it is large enough to see the interesting parts of the solution.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">BlackScholes&lt;dim&gt;::BlackScholes()</div><div class="line">  : maximum_stock_price(1.)</div><div class="line">  , maturity_time(1.)</div><div class="line">  , asset_volatility(.2)</div><div class="line">  , interest_rate(0.05)</div><div class="line">  , strike_price(0.5)</div><div class="line">  , fe(1)</div><div class="line">  , dof_handler(triangulation)</div><div class="line">  , time(0.0)</div><div class="line">  , theta(0.5)</div><div class="line">  , n_cycles(4)</div><div class="line">  , n_time_steps(5000)</div><div class="line">{</div><div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholessetup_systemcode"></a> </p><h4><code>BlackScholes::setup_system</code></h4>
<p>The next function sets up the <a class="el" href="classDoFHandler.html">DoFHandler</a> object, computes the constraints, and sets the linear algebra objects to their correct sizes. We also compute the mass matrix here by calling a function from the library. We will compute the other 3 matrices next, because these need to be computed 'by hand'.</p>
<p>Note, that the time step is initialized here because the maturity time was needed to compute the time step.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::setup_system()</div><div class="line">{</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">  time_step = maturity_time / n_time_steps;</div><div class="line"></div><div class="line">  constraints.clear();</div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">  constraints.close();</div><div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                  dsp,</div><div class="line">                                  constraints,</div><div class="line">                                  <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">true</span>);</div><div class="line">  sparsity_pattern.<a class="code" href="classBlockSparsityPattern.html#a923288e4b4093f86b680e7045e9b4984">copy_from</a>(dsp);</div><div class="line"></div><div class="line">  mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a614ca8e186fe3c61e03a52369437157e">reinit</a>(sparsity_pattern);</div><div class="line">  laplace_matrix.reinit(sparsity_pattern);</div><div class="line">  a_matrix.reinit(sparsity_pattern);</div><div class="line">  b_matrix.reinit(sparsity_pattern);</div><div class="line">  system_matrix.reinit(sparsity_pattern);</div><div class="line"></div><div class="line">  <a class="code" href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a>(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    mass_matrix);</div></div><!-- fragment --><p>Below is the code to create the Laplace matrix with non-constant coefficients. This corresponds to the matrix D in the introduction. This non-constant coefficient is represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.dofs_per_cell;</div><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line"><a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>        quadrature_formula(fe.degree + 1);</div><div class="line"><a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>      fe_values(fe,</div><div class="line">                        quadrature_formula,</div><div class="line">                        <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line">std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">  {</div><div class="line">    cell_matrix = 0.;</div><div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> current_coefficient =</div><div class="line">          fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index).<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>();</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                (current_coefficient *              <span class="comment">// (x_q)^2</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) * <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) * <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));           <span class="comment">// dx</span></div><div class="line">          }</div><div class="line">      }</div><div class="line">    cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          laplace_matrix.add(local_dof_indices[i],</div><div class="line">                             local_dof_indices[j],</div><div class="line">                             cell_matrix(i, j));</div><div class="line">      }</div><div class="line">  }</div></div><!-- fragment --><p>Now we will create the A matrix. Below is the code to create the matrix A as discussed in the introduction. The non constant coefficient is again represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">  {</div><div class="line">    cell_matrix = 0.;</div><div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">          fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                  (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) *  <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(j, q_index) * <span class="comment">// phi_j(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">      }</div><div class="line">    cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          a_matrix.add(local_dof_indices[i],</div><div class="line">                       local_dof_indices[j],</div><div class="line">                       cell_matrix(i, j));</div><div class="line">      }</div><div class="line">  }</div></div><!-- fragment --><p>Finally we will create the matrix B. Below is the code to create the matrix B as discussed in the introduction. The non constant coefficient is again represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">    {</div><div class="line">      cell_matrix = 0.;</div><div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">        {</div><div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">            fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                  (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_index) * <span class="comment">// phi_i(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) *  <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">            }</div><div class="line">        }</div><div class="line">      cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">        {</div><div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">            b_matrix.add(local_dof_indices[i],</div><div class="line">                         local_dof_indices[j],</div><div class="line">                         cell_matrix(i, j));</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">  solution.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholessolve_time_stepcode"></a> </p><h4><code>BlackScholes::solve_time_step</code></h4>
<p>The next function is the one that solves the actual linear system for a single time step. The only interesting thing here is that the matrices we have built are symmetric positive definite, so we can use the conjugate gradient method.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::solve_time_step()</div><div class="line">{</div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>                          solver_control(1000, 1e-12);</div><div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt;               cg(solver_control);</div><div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div><div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#a7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.0);</div><div class="line">  cg.solve(system_matrix, solution, system_rhs, preconditioner);</div><div class="line">  constraints.distribute(solution);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesadd_results_for_outputcode"></a> </p><h4><code>BlackScholes::add_results_for_output</code></h4>
<p>This is simply the function to stitch the solution pieces together. For this, we create a new layer at each time, and then add the solution vector for that timestep. The function then stitches this together with the old solutions using 'build_patches'.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::add_results_for_output()</div><div class="line">{</div><div class="line">  data_out_stack.new_parameter_value(time, time_step);</div><div class="line">  data_out_stack.attach_dof_handler(dof_handler);</div><div class="line">  data_out_stack.add_data_vector(solution, solution_names);</div><div class="line">  data_out_stack.build_patches(2);</div><div class="line">  data_out_stack.finish_parameter_value();</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesrefine_gridcode"></a> </p><h4><code>BlackScholes::refine_grid</code></h4>
<p>It is somewhat unnecessary to have a function for the global refinement that we do. The reason for the function is to allow for the possibility of an adaptive refinement later.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::refine_grid()</div><div class="line">{</div><div class="line">  triangulation.refine_global(1);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesprocess_solutioncode"></a> </p><h4><code>BlackScholes::process_solution</code></h4>
<p>This is where we calculate the convergence and error data to evaluate the effectiveness of the program. Here, we calculate the \(L^2\), \(H^1\) and \(L^{\infty}\) norms.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::process_solution()</div><div class="line">{</div><div class="line">  Solution&lt;dim&gt; sol(maturity_time);</div><div class="line">  sol.set_time(time);</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> difference_per_cell(triangulation.n_active_cells());</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> L2_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> H1_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>  q_trapezoid;</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> q_iterated(q_trapezoid, fe.degree * 2 + 1);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    q_iterated,</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> Linfty_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_active_cells = triangulation.n_active_cells();</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs         = dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>();</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;cells&quot;</span>, n_active_cells);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;dofs&quot;</span>, n_dofs);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;L2&quot;</span>, L2_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;H1&quot;</span>, H1_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;Linfty&quot;</span>, Linfty_error);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholeswrite_convergence_tablecode"></a> </p><h4><code>BlackScholes::write_convergence_table</code> </h4>
<p>This next part is building the convergence and error tables. By this, we need to set the settings for how to output the data that was calculated during <code>BlackScholes::process_solution</code>. First, we will create the headings and set up the cells properly. During this, we will also prescribe the precision of our results. Then we will write the calculated errors based on the \(L^2\), \(H^1\), and \(L^{\infty}\) norms to the console and to the error LaTeX file.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::write_convergence_table()</div><div class="line">{</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;L2&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;H1&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;Linfty&quot;</span>, 3);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;L2&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;H1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;\\# cells&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;\\# dofs&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;L2&quot;</span>, <span class="stringliteral">&quot;@fL^2@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;H1&quot;</span>, <span class="stringliteral">&quot;@fH^1@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="stringliteral">&quot;@fL^\\infty@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_format(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">  convergence_table.set_tex_format(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">  std::cout &lt;&lt; std::endl;</div><div class="line">  convergence_table.write_text(std::cout);</div><div class="line">  std::string error_filename = <span class="stringliteral">&quot;error&quot;</span>;</div><div class="line">  error_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">  error_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">  std::ofstream error_table_file(error_filename);</div><div class="line">  convergence_table.write_tex(error_table_file);</div></div><!-- fragment --><p>Next, we will make the convergence table. We will again write this to the console and to the convergence LaTeX file.</p>
<div class="fragment"><div class="line">  convergence_table.add_column_to_supercolumn(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">  std::vector&lt;std::string&gt; new_order;</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;H1&quot;</span>);</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;L2&quot;</span>);</div><div class="line">  convergence_table.set_column_order(new_order);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">  std::cout &lt;&lt; std::endl;</div><div class="line">  convergence_table.write_text(std::cout);</div><div class="line">  std::string conv_filename = <span class="stringliteral">&quot;convergence&quot;</span>;</div><div class="line">  conv_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">  <span class="keywordflow">switch</span> (fe.degree)</div><div class="line">    {</div><div class="line">      <span class="keywordflow">case</span> 1:</div><div class="line">        conv_filename += <span class="stringliteral">&quot;-q1&quot;</span>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> 2:</div><div class="line">        conv_filename += <span class="stringliteral">&quot;-q2&quot;</span>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">    }</div><div class="line">  conv_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">  std::ofstream table_file(conv_filename);</div><div class="line">  convergence_table.write_tex(table_file);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesruncode"></a> </p><h4><code>BlackScholes::run</code></h4>
<p>Now we get to the main driver of the program. This is where we do all the work of looping through the time steps and calculating the solution vector each time. Here at the top, we set the initial refinement value and then create a mesh. Then we refine this mesh once. Next, we set up the data_out_stack object to store our solution. Finally, we start a for loop to loop through the cycles. This lets us recalculate a solution for each successive mesh refinement. At the beginning of each iteration, we need to reset the time and time step number. We introduce an if statement to accomplish this because we don't want to do this on the first iteration.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">BlackScholes&lt;dim&gt;::run</a>()</div><div class="line">{</div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, 0.0, maximum_stock_price, <span class="keyword">true</span>);</div><div class="line">  triangulation.refine_global(0);</div><div class="line"></div><div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;u&quot;</span>);</div><div class="line">  data_out_stack.declare_data_vector(solution_names,</div><div class="line">                                     <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;::dof_vector</a>);</div><div class="line"></div><div class="line">  Vector&lt;double&gt; vmult_result;</div><div class="line">  Vector&lt;double&gt; forcing_terms;</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; cycle++)</div><div class="line">    {</div><div class="line">      <span class="keywordflow">if</span> (cycle != 0)</div><div class="line">        {</div><div class="line">          refine_grid();</div><div class="line">          time = 0.0;</div><div class="line">        }</div><div class="line"></div><div class="line">      setup_system();</div><div class="line"></div><div class="line">      std::cout &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;===========================================&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span></div><div class="line">                &lt;&lt; triangulation.n_active_cells() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler,</div><div class="line">                               InitialConditions&lt;dim&gt;(strike_price),</div><div class="line">                               solution);</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">        {</div><div class="line">          add_results_for_output();</div><div class="line">        }</div></div><!-- fragment --><p>Next, we run the main loop which runs until we exceed the maturity time. We first compute the right hand side of the equation, which is described in the introduction. Recall that it contains the term \(\left[-\frac{1}{4}k_n\sigma^2\mathbf{D}-k_nr\mathbf{M}+k_n\sigma^2 \mathbf{B}-k_nr\mathbf{A}+\mathbf{M}\right]V^{n-1}\). We put these terms into the variable system_rhs, with the help of a temporary vector:</p>
<div class="fragment"><div class="line">vmult_result.<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">forcing_terms.<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number = 0; timestep_number &lt; n_time_steps;</div><div class="line">     ++timestep_number)</div><div class="line">  {</div><div class="line">    time += time_step;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (timestep_number % 1000 == 0)</div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Time step &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; at t=&quot;</span> &lt;&lt; time</div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(system_rhs, solution);</div><div class="line"></div><div class="line">    laplace_matrix.vmult(vmult_result, solution);</div><div class="line">    system_rhs.add(</div><div class="line">      (-1) * (1 - theta) * time_step *</div><div class="line">        Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">      vmult_result);</div><div class="line">    mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(vmult_result, solution);</div><div class="line"></div><div class="line">    system_rhs.add((-1) * (1 - theta) * time_step * interest_rate * 2,</div><div class="line">                   vmult_result);</div><div class="line"></div><div class="line">    a_matrix.vmult(vmult_result, solution);</div><div class="line">    system_rhs.add((-1) * time_step * interest_rate, vmult_result);</div><div class="line"></div><div class="line">    b_matrix.vmult(vmult_result, solution);</div><div class="line">    system_rhs.add(</div><div class="line">      (-1) * Utilities::fixed_power&lt;2, double&gt;(asset_volatility) *</div><div class="line">        time_step * 1,</div><div class="line">      vmult_result);</div></div><!-- fragment --><p>The second piece is to compute the contributions of the source terms. This corresponds to the term \(-k_n\left[\frac{1}{2}F^{n-1} +\frac{1}{2}F^n\right]\). The following code calls <a class="el" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a> to compute the vectors \(F\), where we set the time of the right hand side (source) function before we evaluate it. The result of this all ends up in the forcing_terms variable:</p>
<div class="fragment"><div class="line">RightHandSide&lt;dim&gt; rhs_function(asset_volatility, interest_rate);</div><div class="line">rhs_function.set_time(time);</div><div class="line"><a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    rhs_function,</div><div class="line">                                    forcing_terms);</div><div class="line">forcing_terms *= time_step * theta;</div><div class="line">system_rhs -= forcing_terms;</div><div class="line"></div><div class="line">rhs_function.set_time(time - time_step);</div><div class="line"><a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    rhs_function,</div><div class="line">                                    forcing_terms);</div><div class="line">forcing_terms *= time_step * (1 - theta);</div><div class="line">system_rhs -= forcing_terms;</div></div><!-- fragment --><p>Next, we add the forcing terms to the ones that come from the time stepping, and also build the matrix \(\left[\mathbf{M}+ \frac{1}{4}k_n\sigma^2\mathbf{D}+k_nr\mathbf{M}\right]\) that we have to invert in each time step. The final piece of these operations is to eliminate hanging node constrained degrees of freedom from the linear system:</p>
<div class="fragment"><div class="line">system_matrix.copy_from(mass_matrix);</div><div class="line">system_matrix.add(</div><div class="line">  (theta)*time_step *</div><div class="line">    Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">  laplace_matrix);</div><div class="line">system_matrix.add((time_step)*interest_rate * theta * (1 + 1),</div><div class="line">                  mass_matrix);</div><div class="line"></div><div class="line">constraints.condense(system_matrix, system_rhs);</div></div><!-- fragment --><p>There is one more operation we need to do before we can solve it: boundary values. To this end, we create a boundary value object, set the proper time to the one of the current time step, and evaluate it as we have done many times before. The result is used to also set the correct boundary values in the linear system:</p>
<div class="fragment"><div class="line">{</div><div class="line">  RightBoundaryValues&lt;dim&gt; right_boundary_function(strike_price,</div><div class="line">                                                   interest_rate);</div><div class="line">  LeftBoundaryValues&lt;dim&gt;  left_boundary_function;</div><div class="line">  right_boundary_function.set_time(time);</div><div class="line">  left_boundary_function.set_time(time);</div><div class="line">  std::map&lt;types::global_dof_index, double&gt; boundary_values;</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           0,</div><div class="line">                                           left_boundary_function,</div><div class="line">                                           boundary_values);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           1,</div><div class="line">                                           right_boundary_function,</div><div class="line">                                           boundary_values);</div><div class="line">  <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div><div class="line">                                     system_matrix,</div><div class="line">                                     solution,</div><div class="line">                                     system_rhs);</div><div class="line">}</div></div><!-- fragment --><p>With this out of the way, all we have to do is solve the system, generate graphical data on the last cycle, and create the convergence table data.</p>
<div class="fragment"><div class="line">            solve_time_step();</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">              {</div><div class="line">                add_results_for_output();</div><div class="line">              }</div><div class="line">          }</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">        process_solution();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::string filename = <span class="stringliteral">&quot;solution.vtk&quot;</span>;</div><div class="line">    std::ofstream     output(filename);</div><div class="line">    data_out_stack.write_vtk(output);</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    write_convergence_table();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line">} <span class="comment">// namespace BlackScholesSolver</span></div></div><!-- fragment --><p><a class="anchor" id="ThecodemaincodeFunction"></a> </p><h3>The <code>main</code> <a class="el" href="classFunction.html">Function</a></h3>
<p>Having made it this far, there is, again, nothing much to discuss for the main function of this program: it looks like all such functions since <a class="el" href="step_6.html">step-6</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span>BlackScholesSolver;</div><div class="line"></div><div class="line">      BlackScholes&lt;1&gt; black_scholes_solver;</div><div class="line">      black_scholes_solver.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>Below is the output of the program: </p><div class="fragment"><div class="line">===========================================</div><div class="line">Number of active cells: 1</div><div class="line">Number of degrees of freedom: 2</div><div class="line"></div><div class="line">Time step 0 at t=0.0002</div><div class="line">[...]</div><div class="line"></div><div class="line">Cycle 7:</div><div class="line">Number of active cells: 128</div><div class="line">Number of degrees of freedom: 129</div><div class="line"></div><div class="line">Time step 0 at t=0.0002</div><div class="line">Time step 1000 at t=0.2002</div><div class="line">Time step 2000 at t=0.4002</div><div class="line">Time step 3000 at t=0.6002</div><div class="line">Time step 4000 at t=0.8002</div><div class="line"></div><div class="line">cells dofs    <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">L2</a>        H1      Linfty</div><div class="line">    1    2 1.667e-01 5.774e-01 2.222e-01</div><div class="line">    2    3 3.906e-02 2.889e-01 5.380e-02</div><div class="line">    4    5 9.679e-03 1.444e-01 1.357e-02</div><div class="line">    8    9 2.405e-03 7.218e-02 3.419e-03</div><div class="line">   16   17 5.967e-04 3.609e-02 8.597e-04</div><div class="line">   32   33 1.457e-04 1.804e-02 2.155e-04</div><div class="line">   64   65 3.307e-05 9.022e-03 5.388e-05</div><div class="line">  128  129 5.016e-06 4.511e-03 1.342e-05</div><div class="line"></div><div class="line">n cells         H1                  <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">L2</a></div><div class="line">      1 5.774e-01    -    - 1.667e-01    -    -</div><div class="line">      2 2.889e-01 2.00 1.00 3.906e-02 4.27 2.09</div><div class="line">      4 1.444e-01 2.00 1.00 9.679e-03 4.04 2.01</div><div class="line">      8 7.218e-02 2.00 1.00 2.405e-03 4.02 2.01</div><div class="line">     16 3.609e-02 2.00 1.00 5.967e-04 4.03 2.01</div><div class="line">     32 1.804e-02 2.00 1.00 1.457e-04 4.10 2.03</div><div class="line">     64 9.022e-03 2.00 1.00 3.307e-05 4.41 2.14</div><div class="line">    128 4.511e-03 2.00 1.00 5.016e-06 6.59 2.72</div></div><!-- fragment --><p>What is more interesting is the output of the convergence tables. They are outputted into the console, as well into a LaTeX file. The convergence tables are shown above. Here, you can see that the the solution has a convergence rate of \(\mathcal{O}(h)\) with respect to the \(H^1\)-norm, and the solution has a convergence rate of \(\mathcal{O}(h^2)\) with respect to the \(L^2\)-norm.</p>
<p>Below is the visualization of the solution.</p>
<div style="text-align:center;"> <div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-78.mms-solution.png" alt="Solution of the MMS problem."/>
</div>
 </div><p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2021 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Tyler Anderson, Colorado State University, 2021</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="convergence__table_8h.html">deal.II/base/convergence_table.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__accessor_8h.html">deal.II/dofs/dof_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__accessor_8h.html">deal.II/grid/tria_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__iterator_8h.html">deal.II/grid/tria_iterator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="data__out__stack_8h.html">deal.II/numerics/data_out_stack.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>BlackScholesSolver</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#define MMS</span></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>Solution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a></div><div class="line">    gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  Solution&lt;dim&gt;::Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time)</div><div class="line">    : maturity_time(maturity_time)</div><div class="line">  {</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> Solution&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> Solution&lt;dim&gt;::gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2 * p(component));</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>InitialConditions : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  InitialConditions&lt;dim&gt;::InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price)</div><div class="line">    : strike_price(strike_price)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> InitialConditions&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(p(component) - strike_price, 0.);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>LeftBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> LeftBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;,</div><div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> 0.;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightBoundaryValues&lt;dim&gt;::RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price,</div><div class="line">                                                <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : strike_price(strike_price)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> (p(component) - strike_price) *</div><div class="line">           <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>((-interest_rate) * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()));</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightHandSide&lt;dim&gt;::RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : asset_volatility(asset_volatility)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> 2 * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(asset_volatility * p(component)) -</div><div class="line">           2 * interest_rate * Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           interest_rate *</div><div class="line">             (-Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">              Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    (void)p;</div><div class="line">    (void)component;</div><div class="line">    <span class="keywordflow">return</span> 0.0;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>BlackScholes</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BlackScholes();</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> setup_system();</div><div class="line">    <span class="keywordtype">void</span> solve_time_step();</div><div class="line">    <span class="keywordtype">void</span> refine_grid();</div><div class="line">    <span class="keywordtype">void</span> process_solution();</div><div class="line">    <span class="keywordtype">void</span> add_results_for_output();</div><div class="line">    <span class="keywordtype">void</span> write_convergence_table();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximum_stock_price;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line"></div><div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div><div class="line">    SparseMatrix&lt;double&gt; <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div><div class="line">    SparseMatrix&lt;double&gt; laplace_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; a_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; b_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; system_matrix;</div><div class="line"></div><div class="line">    Vector&lt;double&gt; solution;</div><div class="line">    Vector&lt;double&gt; system_rhs;</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> time;</div><div class="line">    <span class="keywordtype">double</span> time_step;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       theta;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_time_steps;</div><div class="line"></div><div class="line">    <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;</a>        data_out_stack;</div><div class="line">    std::vector&lt;std::string&gt; solution_names;</div><div class="line"></div><div class="line">    <a class="code" href="classConvergenceTable.html">ConvergenceTable</a> convergence_table;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  BlackScholes&lt;dim&gt;::BlackScholes()</div><div class="line">    : maximum_stock_price(1.)</div><div class="line">    , maturity_time(1.)</div><div class="line">    , asset_volatility(.2)</div><div class="line">    , interest_rate(0.05)</div><div class="line">    , strike_price(0.5)</div><div class="line">    , fe(1)</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , time(0.0)</div><div class="line">    , theta(0.5)</div><div class="line">    , n_cycles(4)</div><div class="line">    , n_time_steps(5000)</div><div class="line">  {</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::setup_system()</div><div class="line">  {</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    time_step = maturity_time / n_time_steps;</div><div class="line"></div><div class="line">    constraints.clear();</div><div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">    constraints.close();</div><div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    dsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">true</span>);</div><div class="line">    sparsity_pattern.<a class="code" href="classBlockSparsityPattern.html#a923288e4b4093f86b680e7045e9b4984">copy_from</a>(dsp);</div><div class="line"></div><div class="line">    mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a614ca8e186fe3c61e03a52369437157e">reinit</a>(sparsity_pattern);</div><div class="line">    laplace_matrix.reinit(sparsity_pattern);</div><div class="line">    a_matrix.reinit(sparsity_pattern);</div><div class="line">    b_matrix.reinit(sparsity_pattern);</div><div class="line">    system_matrix.reinit(sparsity_pattern);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a>(dof_handler,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      mass_matrix);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.dofs_per_cell;</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>        quadrature_formula(fe.degree + 1);</div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>      fe_values(fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index).<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>();</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                    (current_coefficient *              <span class="comment">// (x_q)^2</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) * <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) * <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));           <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              laplace_matrix.add(local_dof_indices[i],</div><div class="line">                                 local_dof_indices[j],</div><div class="line">                                 cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  {</div><div class="line">                    <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                      (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) *  <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(j, q_index) * <span class="comment">// phi_j(x_q)</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">                  }</div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              a_matrix.add(local_dof_indices[i],</div><div class="line">                           local_dof_indices[j],</div><div class="line">                           cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                    (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_index) * <span class="comment">// phi_i(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) *  <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              b_matrix.add(local_dof_indices[i],</div><div class="line">                           local_dof_indices[j],</div><div class="line">                           cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    solution.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">    system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::solve_time_step()</div><div class="line">  {</div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>                          solver_control(1000, 1e-12);</div><div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt;               cg(solver_control);</div><div class="line">    <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div><div class="line">    preconditioner.<a class="code" href="classPreconditionSSOR.html#a7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.0);</div><div class="line">    cg.solve(system_matrix, solution, system_rhs, preconditioner);</div><div class="line">    constraints.distribute(solution);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::add_results_for_output()</div><div class="line">  {</div><div class="line">    data_out_stack.new_parameter_value(time, time_step);</div><div class="line">    data_out_stack.attach_dof_handler(dof_handler);</div><div class="line">    data_out_stack.add_data_vector(solution, solution_names);</div><div class="line">    data_out_stack.build_patches(2);</div><div class="line">    data_out_stack.finish_parameter_value();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::refine_grid()</div><div class="line">  {</div><div class="line">    triangulation.refine_global(1);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::process_solution()</div><div class="line">  {</div><div class="line">    Solution&lt;dim&gt; sol(maturity_time);</div><div class="line">    sol.set_time(time);</div><div class="line">    Vector&lt;float&gt; difference_per_cell(triangulation.n_active_cells());</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> L2_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> H1_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>  q_trapezoid;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> q_iterated(q_trapezoid, fe.degree * 2 + 1);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      q_iterated,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> Linfty_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_active_cells = triangulation.n_active_cells();</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs         = dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>();</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;cells&quot;</span>, n_active_cells);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;dofs&quot;</span>, n_dofs);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;L2&quot;</span>, L2_error);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;H1&quot;</span>, H1_error);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;Linfty&quot;</span>, Linfty_error);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::write_convergence_table()</div><div class="line">  {</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;L2&quot;</span>, 3);</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;H1&quot;</span>, 3);</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;Linfty&quot;</span>, 3);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;L2&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;H1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;\\# cells&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;\\# dofs&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;L2&quot;</span>, <span class="stringliteral">&quot;@f@f$L^2@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;H1&quot;</span>, <span class="stringliteral">&quot;@f@f$H^1@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="stringliteral">&quot;@f@f$L^\\infty@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_format(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">    convergence_table.set_tex_format(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">    std::cout &lt;&lt; std::endl;</div><div class="line">    convergence_table.write_text(std::cout);</div><div class="line">    std::string error_filename = <span class="stringliteral">&quot;error&quot;</span>;</div><div class="line">    error_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">    error_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">    std::ofstream error_table_file(error_filename);</div><div class="line">    convergence_table.write_tex(error_table_file);</div><div class="line"></div><div class="line">    convergence_table.add_column_to_supercolumn(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">    std::vector&lt;std::string&gt; new_order;</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;H1&quot;</span>);</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;L2&quot;</span>);</div><div class="line">    convergence_table.set_column_order(new_order);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">    std::cout &lt;&lt; std::endl;</div><div class="line">    convergence_table.write_text(std::cout);</div><div class="line">    std::string conv_filename = <span class="stringliteral">&quot;convergence&quot;</span>;</div><div class="line">    conv_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">    <span class="keywordflow">switch</span> (fe.degree)</div><div class="line">      {</div><div class="line">        <span class="keywordflow">case</span> 1:</div><div class="line">          conv_filename += <span class="stringliteral">&quot;-q1&quot;</span>;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> 2:</div><div class="line">          conv_filename += <span class="stringliteral">&quot;-q2&quot;</span>;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">      }</div><div class="line">    conv_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">    std::ofstream table_file(conv_filename);</div><div class="line">    convergence_table.write_tex(table_file);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">BlackScholes&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, 0.0, maximum_stock_price, <span class="keyword">true</span>);</div><div class="line">    triangulation.refine_global(0);</div><div class="line"></div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;u&quot;</span>);</div><div class="line">    data_out_stack.declare_data_vector(solution_names,</div><div class="line">                                       <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;::dof_vector</a>);</div><div class="line"></div><div class="line">    Vector&lt;double&gt; vmult_result;</div><div class="line">    Vector&lt;double&gt; forcing_terms;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; cycle++)</div><div class="line">      {</div><div class="line">        <span class="keywordflow">if</span> (cycle != 0)</div><div class="line">          {</div><div class="line">            refine_grid();</div><div class="line">            time = 0.0;</div><div class="line">          }</div><div class="line"></div><div class="line">        setup_system();</div><div class="line"></div><div class="line">        std::cout &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;===========================================&quot;</span> &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span></div><div class="line">                  &lt;&lt; triangulation.n_active_cells() &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()</div><div class="line">                  &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler,</div><div class="line">                                 InitialConditions&lt;dim&gt;(strike_price),</div><div class="line">                                 solution);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">          {</div><div class="line">            add_results_for_output();</div><div class="line">          }</div><div class="line"></div><div class="line">        vmult_result.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">        forcing_terms.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number = 0; timestep_number &lt; n_time_steps;</div><div class="line">             ++timestep_number)</div><div class="line">          {</div><div class="line">            time += time_step;</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (timestep_number % 1000 == 0)</div><div class="line">              std::cout &lt;&lt; <span class="stringliteral">&quot;Time step &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; at t=&quot;</span> &lt;&lt; time</div><div class="line">                        &lt;&lt; std::endl;</div><div class="line"></div><div class="line">            mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(system_rhs, solution);</div><div class="line"></div><div class="line">            laplace_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add(</div><div class="line">              (-1) * (1 - theta) * time_step *</div><div class="line">                Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">              vmult_result);</div><div class="line">            mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(vmult_result, solution);</div><div class="line"></div><div class="line">            system_rhs.add((-1) * (1 - theta) * time_step * interest_rate * 2,</div><div class="line">                           vmult_result);</div><div class="line"></div><div class="line">            a_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add((-1) * time_step * interest_rate, vmult_result);</div><div class="line"></div><div class="line">            b_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add(</div><div class="line">              (-1) * Utilities::fixed_power&lt;2, double&gt;(asset_volatility) *</div><div class="line">                time_step * 1,</div><div class="line">              vmult_result);</div><div class="line"></div><div class="line">            RightHandSide&lt;dim&gt; rhs_function(asset_volatility, interest_rate);</div><div class="line">            rhs_function.set_time(time);</div><div class="line">            <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                                <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                                rhs_function,</div><div class="line">                                                forcing_terms);</div><div class="line">            forcing_terms *= time_step * theta;</div><div class="line">            system_rhs -= forcing_terms;</div><div class="line"></div><div class="line">            rhs_function.set_time(time - time_step);</div><div class="line">            <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                                <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                                rhs_function,</div><div class="line">                                                forcing_terms);</div><div class="line">            forcing_terms *= time_step * (1 - theta);</div><div class="line">            system_rhs -= forcing_terms;</div><div class="line"></div><div class="line">            system_matrix.copy_from(mass_matrix);</div><div class="line">            system_matrix.add(</div><div class="line">              (theta)*time_step *</div><div class="line">                Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">              laplace_matrix);</div><div class="line">            system_matrix.add((time_step)*interest_rate * theta * (1 + 1),</div><div class="line">                              mass_matrix);</div><div class="line"></div><div class="line">            constraints.condense(system_matrix, system_rhs);</div><div class="line"></div><div class="line">            {</div><div class="line">              RightBoundaryValues&lt;dim&gt; right_boundary_function(strike_price,</div><div class="line">                                                               interest_rate);</div><div class="line">              LeftBoundaryValues&lt;dim&gt;  left_boundary_function;</div><div class="line">              right_boundary_function.set_time(time);</div><div class="line">              left_boundary_function.set_time(time);</div><div class="line">              std::map&lt;types::global_dof_index, double&gt; boundary_values;</div><div class="line">              <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                                       0,</div><div class="line">                                                       left_boundary_function,</div><div class="line">                                                       boundary_values);</div><div class="line">              <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                                       1,</div><div class="line">                                                       right_boundary_function,</div><div class="line">                                                       boundary_values);</div><div class="line">              <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 solution,</div><div class="line">                                                 system_rhs);</div><div class="line">            }</div><div class="line"></div><div class="line">            solve_time_step();</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">              {</div><div class="line">                add_results_for_output();</div><div class="line">              }</div><div class="line">          }</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">        process_solution();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::string filename = <span class="stringliteral">&quot;solution.vtk&quot;</span>;</div><div class="line">    std::ofstream     output(filename);</div><div class="line">    data_out_stack.write_vtk(output);</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    write_convergence_table();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line">} <span class="comment">// namespace BlackScholesSolver</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span>BlackScholesSolver;</div><div class="line"></div><div class="line">      BlackScholes&lt;1&gt; black_scholes_solver;</div><div class="line">      black_scholes_solver.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>This tutorial depends on <a class="el" href="step_26.html">step-26</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Particularitiesoftheequationsystem">Particularities of the equation system</a><a href="#Particularitiesoftheequationsystem">Particularities of the equation system</a>
        <li><a href="#Schemeforthenumericalsolution">Scheme for the numerical solution</a><a href="#Schemeforthenumericalsolution">Scheme for the numerical solution</a>
        <li><a href="#TestCase">Test Case</a><a href="#TestCase">Test Case</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#SolutionClass">Solution Class</a><a href="#SolutionClass">Solution Class</a>
        <li><a href="#EquationData">Equation Data</a><a href="#EquationData">Equation Data</a>
        <li><a href="#ThecodeBlackScholescodeClass">The <code>BlackScholes</code> Class</a><a href="#ThecodeBlackScholescodeClass">The <code>BlackScholes</code> Class</a>
        <li><a href="#ThecodeBlackScholescodeImplementation">The <code>BlackScholes</code> Implementation</a><a href="#ThecodeBlackScholescodeImplementation">The <code>BlackScholes</code> Implementation</a>
      <ul>
        <li><a href="#codeBlackScholessetup_systemcode"><code>BlackScholes::setup_system</code></a><a href="#codeBlackScholessetup_systemcode"><code>BlackScholes::setup_system</code></a>
        <li><a href="#codeBlackScholessolve_time_stepcode"><code>BlackScholes::solve_time_step</code></a><a href="#codeBlackScholessolve_time_stepcode"><code>BlackScholes::solve_time_step</code></a>
        <li><a href="#codeBlackScholesadd_results_for_outputcode"><code>BlackScholes::add_results_for_output</code></a><a href="#codeBlackScholesadd_results_for_outputcode"><code>BlackScholes::add_results_for_output</code></a>
        <li><a href="#codeBlackScholesrefine_gridcode"><code>BlackScholes::refine_grid</code></a><a href="#codeBlackScholesrefine_gridcode"><code>BlackScholes::refine_grid</code></a>
        <li><a href="#codeBlackScholesprocess_solutioncode"><code>BlackScholes::process_solution</code></a><a href="#codeBlackScholesprocess_solutioncode"><code>BlackScholes::process_solution</code></a>
        <li><a href="#codeBlackScholeswrite_convergence_tablecode"><code>BlackScholes::write_convergence_table</code> </a><a href="#codeBlackScholeswrite_convergence_tablecode"><code>BlackScholes::write_convergence_table</code> </a>
        <li><a href="#codeBlackScholesruncode"><code>BlackScholes::run</code></a><a href="#codeBlackScholesruncode"><code>BlackScholes::run</code></a>
      </ul>
        <li><a href="#ThecodemaincodeFunction">The <code>main</code> Function</a><a href="#ThecodemaincodeFunction">The <code>main</code> Function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>The Black-Scholes equation is a partial differential equation that falls a bitout of the ordinary scheme. It describes what the fair price of a "Europeancall" stock option is. Without going into too much detail, a stock "option" isa contract one can buy from a bank that allows me, but not requires me, to buya specific stock at a fixed price \(K\) at a fixed future time \(T\) in thefuture. The question one would then want to answer as a buyer of such anoption is "How much do I think such a contract is worth?", or as the seller"How much do I need to charge for this contract?", both as a function of thetime \(t&lt;T\) before the contract is up at time \(T\) and as a function of the stockprice \(S\) . Fischer Black and Myron Scholes derived a partial differentialequation for the fair price \(V(S,t)\) for such options under the assumption thatstock prices exhibit random price fluctuations with a given level of"volatility" plus a background exponential price increase (which one can thinkof as the inflation rate that simply devalues all money over time). For theirwork, Black and Scholes received the Nobel Prize in Economic Sciences in 1997,making this the first tutorial program dealing with a problem for which someonehas gotten a Nobel Prize <b>[black1973pricing]</b> . The equation reads as follows: </p><p class="formulaDsp">
\begin{align*} &amp;\frac{\partial V}{\partial t} + \frac{\sigma^2S^2}{2} \ \frac{\partial^2 V}{\partial S^2} + \ rS\frac{\partial V}{\partial S} - rV = 0, \ \quad\quad &amp;&amp;\forall S\in \Omega, t \in (0,T) \\ &amp;V(0,t) = 0, \ &amp;&amp;\forall t \in (0,T) \\ &amp;V(S,t) \rightarrow S, \ &amp;&amp; \text{as } S \rightarrow \infty, \forall t \in (0,T) \\ &amp;V(S,T) = \max(S-K,0) \ &amp;&amp;\forall S \in \Omega \end{align*}
</p>
<p> where </p><p class="formulaDsp">
\begin{align*} V(S,t): &amp;&amp; \text{Value of call option at time t and asset price S} \\ \sigma: &amp;&amp; \text{Volatility of the underlying asset} \\ r: &amp;&amp; \text{Risk free interest rate} \\ K : &amp;&amp; \text{Strike price for purchasing asset} \end{align*}
</p>
<p>The way we should interpret this equation is that it is a time-dependent partialdifferential equation of one "space" variable \(S\) as the price of the stock, and \(V(S,t)\) is the price of the option at time \(t\) if the stock price at that time were \(S\) . <a class="anchor" id="Particularitiesoftheequationsystem"></a></p><h3>Particularities of the equation system</h3>
<p>There are a number of oddities in this equation that are worth discussing beforemoving on to its numerical solution. First, the "spatial" domain \(\Omega\subset\mathbb{R}\) is unbounded, and thus \(S\) can be unbounded in value.This is because there may be a practical upper bound for stock prices, but not aconceptual one. The boundary conditions \(V(S,t)\rightarrow S\) as \(S\rightarrow \infty\) can then be interpreted as follows: What is the value ofan option that allows me to buy a stock at price \(K\) if the stock price (todayor at time \(t=T\) ) is \(S\gg K\) ? One would expect that it is \(V\approx S-K\) plussome adjustment for inflation, or, if we really truly consider huge values of \(S\) , we can neglect \(K\) and arrive at the statement that the boundary values atthe infinite boundary should be of the form \(V\rightarrow S\) as stated above. In practice, for us to use a finite element method to solve this, we are goingto need to bound \(\Omega\) . Since this equation describes prices, and it doesn'tmake sense to talk about prices being negative, we will set the lower bound of \(\Omega\) to be 0. Then, for an upper bound, we will choose a very large number,one that \(S\) is not very likely to ever get to. We will call this \(S_\text{max}\) .So, \(\Omega=[0,S_\text{max}]\) . Second, after truncating the domain, we need to ask what boundary values weshould pose at this now finite boundary. To take care of this, we use "put-call"parity <b>[stoll1969relationship]</b> . A "pull option" is one in which we areallowed, but not required, tosell* a stock at price \(K\) to someone at a futuretime \(T\) . This says </p><p class="formulaDsp">
\begin{align*} V(S,t)+Ke^{-r(T-t)}=P(S,t)+S \end{align*}
</p>
<p> where \(V(S,t)\) is the value of the call option, and \(P(S,t)\) is the value of theput option. Since we expect \(P(S,t) \rightarrow 0\) as \(S \rightarrow \infty\) ,this says </p><p class="formulaDsp">
\begin{align*} V(S,t) \rightarrow S-Ke^{-r(T-t)}, \end{align*}
</p>
<p> and we can use this as a reasonable boundary condition at our finite point \(S_\text{max}\) . The second complication of the Block-Scholes equation is that we are given afinal condition, and not an initial condition. This is because we know what theoption is worth at time \(t=T\) : If the stock price at \(T\) is \(S&lt;K\) , then we haveno incentive to use our option of buying a price \(K\) because we can buy that stockfor cheaper on the open market. So \(V(S,T)=0\) for \(S&lt;K\) . On the other hand, ifat time \(T\) we have \(S&gt;K\) , then we can buy the stock at price \(K\) via the optionand immediately sell it again on the market for price \(S\) , giving me a profit of \(S-K\) . In other words, \(V(S,T)=S-K\) for \(S&gt;K\) . So, we only knowvalues for \(V\) at theend time* but not the initial time</p>
<ul>
<li>in fact, findingout what a fair price at the current time (conventionally taken to be \(t=0\) ) iswhat solving these equations is all about. This means that this is not an equation that is posed going forward intime, but in fact goingbackward* in time. Thus it makes sense to solve thisproblem in reverse by making the change of variables \(\tau=T-t\) where now \(\tau\) denotes the time before the strike time \(T\) . With all of this, we finally end up with the following problem: <p class="formulaDsp">
\begin{align*} &amp;-\frac{\partial V}{\partial \tau} + \frac{\sigma^2S^2}{2} \ \frac{\partial^2 V}{\partial S^2} + rS\frac{\partial V}{\partial S} - rV=0\ , \quad\quad &amp;&amp;\forall S\in [0,S_\text{max}], \tau \in [0,T] \\ &amp;V(0,\tau) = 0, \ &amp;&amp;\forall \tau \in [0,T] \\ &amp;V(S_\text{max},\tau)=S_\text{max}-Ke^{-r\tau}, \ &amp;&amp;\forall \tau \in [0,T] \\ &amp;V(S,0) = \max(S-K,0) \ &amp;&amp;\forall S \in [0,S_\text{max}] \end{align*}
</p>
</li>
</ul>
<p>Conceptually, this is an advection-diffusion-reaction problem for the variable \(V\) : There is both a second-order derivative diffusion term, a first-orderderivative advection term, and a zeroth-order reaction term.We can expect this problem to be a little bit forgiving in practice because forrealistic values of the coefficients, it is diffusive dominated. But, because ofthe advective terms in the problem, we will have to be careful with meshrefinement and time step choice. There is also the issue that the diffusion term is written in a non-conservative form and so integration by parts is not immediately obvious. This will be discussed in the next section. <a class="anchor" id="Schemeforthenumericalsolution"></a></p><h3>Scheme for the numerical solution</h3>
<p>We will solve this problem using an IMEX method. In particular, we first discretizein time with the theta method and will later pick different values of theta forthe advective and diffusive terms.Let \(V^n(S)\) approximate \(V(S,\tau_n)\) : </p><p class="formulaDsp">
\begin{align*} 0=&amp;-\frac{V^n(S)-V^{n-1}(S)}{k_n} \\ &amp;+\frac{\sigma^2S^2}{2}\left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right] \\ &amp;+rS\left[(1-\theta)\frac{dV^{n-1}(S)}{dS} + \ \theta\frac{dV^{n}(S)}{dS}\right] \\ &amp;-r\left[(1-\theta)V^{n-1}(S) + \theta V^n(S)\right] \end{align*}
</p>
<p> Here, \(k_n=\tau_n-\tau_{n-1}\) is the time step size. Given this timediscretization, we can proceed to discretize space by multiplying with testfunctions and then integrating by parts. Because there are some interestingdetails in this due to the advective and non-advective terms in this equation,this process will be explained in detail. So, we begin by multiplying by test functions, \(\{\phi_i(S)\}_{i\in\mathbb{N}}\) : </p><p class="formulaDsp">
\begin{align*} 0=&amp;-\int_0^{S_\text{max}}\phi_i(S)\left[V^n(S)-V^{n-1}(S)\right]dS \\ &amp;+k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \ \left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;+k_n\int_0^{S_\text{max}}\phi_i(S)\left[rS\left[(1-\theta) \frac{dV^{n-1}(S)}{dS}\ + \theta\frac{dV^{n}(S)}{dS}\right]\right]dS \\ &amp;-k_n\int_0^{S_\text{max}}\phi_i(S)\left[r\left[(1-\theta)V^{n-1}(S)\ + \theta V^n(S)\right]\right]dS \end{align*}
</p>
<p>As usual, (1) becomes \(-\textbf{M}V^n+\textbf{M}V^{n-1}\) and (4) becomes \(k_n\left[-r(1-\theta)\textbf{M}V^{n-1} - \theta r\textbf{M}V^n\right]\) , where \(\textbf{M}_{i,j}=\left(\phi_i(S),\phi_j(S)\right)\) , and where we have taken theliberty of denoting by \(V\) not only the function \(V(S)\) but also the vector ofnodal values after discretization. The interesting parts come from (2) and (3).</p>
<p>For (2), we have: </p><p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \ \left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;=k_n(1-\theta)\int_0^{S_\text{max}}\phi_i(S)\frac{\sigma^2S^2}{2} \ \frac{d^2V^{n-1}(S)}{dS^2} \ +k_n\theta\int_0^{S_\text{max}}\phi_i(S)\frac{\sigma^2S^2}{2} \ \frac{d^2V^{n}(S)}{dS^2} \end{align*}
</p>
<p>There are two integrals here, that are more or less the same, with thedifferences being a slightly different coefficient in front of the integral,and a different time step for V. Therefore, we will outline this integral in thegeneral case, and account for the differences at the end. So, consider thegeneral integral, which we will solve using integration by parts: </p><p class="formulaDsp">
\begin{align*} &amp;\int_{0}^{S_\text{max}} \phi_i(S)\frac{\sigma^2S^2}{2} \frac{d^2V^n(S)}{dS^2}dS \\ &amp;= \phi_i(S)\frac{1}{2}\sigma^2S^2\frac{dV^n(S)}{dS}\Bigg|_0^{S_{max}} - \ \int_0^{S_\text{max}} \phi_i(S)\sigma^2S\frac{dV^n(S)}{dS}dS - \ \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2}\sigma^2S^2 \ \frac{dV^n(S)}{dS}dS \\ &amp;= -\int_0^{S_\text{max}} \phi_i(S)\sigma^2S\frac{dV^n(S)}{dS}dS - \ \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2}\sigma^2S^2 \ \frac{dV^n(S)}{dS}dS \\ &amp;= -\int_0^{S_\text{max}} \phi_i(S)\sigma^2S \sum_j V_j^n \frac{d\phi_j(S)}{dS}dS \ -\int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2} \ \sigma^2S^2 \sum_k V_k^n \frac{d\phi_k(S)}{dS}dS \\ &amp;= -\sum_j \sigma^2 \int_0^{S_\text{max}} \phi_i(S)S \frac{d\phi_j(S)}{dS}dS V_j^n\ - \sum_k \frac{1}{2}\sigma^2 \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}S^2\ \frac{d\phi_k}{dS}dS V_k^n \\ &amp;= -\sum_j \sigma^2 \left(\phi_i(S)S, \frac{d\phi_j(S)}{dS}\right) V_j^n \ - \sum_k \frac{1}{2}\sigma^2 \left(\frac{d\phi_i(S)}{dS}S^2,\ \frac{d\phi_k(S)}{dS}\right) V_k^n \\ &amp;= -\sigma^2\textbf{B}V^n - \frac{1}{2}\sigma^2\textbf{D}V^n, \quad\quad \ \textbf{B}_{i,j} = \left(\phi_i(S)S, \frac{d\phi_j(S)}{dS}\right),\ \textbf{D}_{i,j} = \left(\frac{d\phi_i(S)}{dS}S^2,\frac{d\phi_j(S)}{dS}\right) \end{align*}
</p>
<p>So, after adding in the constants and exchanging \(V^n\) for \(V^{n-1}\) whereapplicable, we arrive at the following for (2): </p><p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \left[(1-\theta)\ \frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;= k_n\left[-(1-\theta)\sigma^2\textbf{B}V^{n-1}\ -(1-\theta)\frac{1}{2}\sigma^2\textbf{D}V^{n-1} \ -\theta\sigma^2\textbf{B}V^{n} -\theta\frac{1}{2}\sigma^2\textbf{D}V^{n}\right] \end{align*}
</p>
<p> But, because the matrix \(\textbf{B}\) involves an advective term, we will choose \(\theta=0\) there</p>
<ul>
<li>in other words, we use an explicit Euler method to treatadvection. Conversely, since the matrix \(\textbf{D}\) involves the diffusive term,we will choose \(\theta=1/2\) there</li>
<li>i.e., we treat diffusion using the secondorder Crank-Nicolson method. So, we arrive at the following: <p class="formulaDsp">
\begin{align*} k_n\left[-\frac{1}{4}\sigma^2\textbf{D}V^{n-1} \ -\frac{1}{4}\sigma^2\textbf{D}V^n \ - \sigma^2\textbf{B}V^{n-1}\right] \end{align*}
</p>
</li>
</ul>
<p>Now, to handle (3). For this, we will again proceed by considering the generalcase like above. </p><p class="formulaDsp">
\begin{align*} &amp;\int_{0}^{S_\text{max}} \phi_i(S)rS\frac{dV^n}{dS}dS \\ &amp;= \phi_i(S)rSV^n\Bigg|_0^{S_\text{max}} - \int_0^{S_\text{max}} \left[r\phi_i(S) \ + r\frac{d\phi_i(S)}{dS}S \right]V^ndS \\ &amp;= -\int_0^{S_\text{max}} r\phi_i(S)V^ndS - \ \int_0^{S_\text{max}} r\frac{d\phi_i(S)}{dS}SV^ndS \\ &amp;= -\int_0^{S_\text{max}} r\phi_i(S) \sum_j V_j^n\phi_j(S)dS \ -\int_0^{S_\text{max}} rS\frac{d\phi_i(S)}{dS} \sum_k V_k\phi_k(S)dS \\ &amp;= -\sum_j r\left(\phi_i(S), \phi_j(S)\right) V_j^n -\ \sum_k r\left(S\frac{d\phi_i(S)}{dS}, \phi_k(S)\right)V_k^n \\ &amp;= -r\textbf{M}V^n -r\textbf{A}V^n, \quad\quad\ \textbf{M}_{i,j} = \left(\phi_i(S), \phi_j(S)\right),\ \textbf{A}_{i,j} = \left(S\frac{d\phi_i(S)}{dS}, \phi_j(S)\right) \end{align*}
</p>
<p>So, again after adding in the constants and exchanging \(V^n\) for \(V^{n-1}\) whereapplicable, we arrive at the following for (3): </p><p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[rS\left[(1-\theta) \frac{dV^{n-1}(S)}{dS} +\ \theta\frac{dV^{n}(S)}{dS}\right]\right]dS \\ &amp;= k_n\left[-(1-\theta)r\textbf{M}V^{n-1} -(1-\theta)r\textbf{A}V^{n-1}\ -\theta r\textbf{M}V^n -\theta r\textbf{A}V^n\right] \end{align*}
</p>
<p> Just as before, we will use \(\theta=0\) for the matrix \(\textbf{A}\) and \(\theta=\frac{1}{2}\) for the matrix \(\textbf{M}\) . So, we arrive at thefollowing for (3): </p><p class="formulaDsp">
\begin{align*} k_n\left[-\frac{1}{2}r\textbf{M}V^{n-1} - \frac{1}{2}r\textbf{M}V^n \ -r\textbf{A}V^{n-1}\right] \end{align*}
</p>
<p>Now, putting everything together, we obtain the following discrete form for theBlack-Scholes Equation: </p><p class="formulaDsp">
\begin{align*} 0&amp;= \\ &amp;-\textbf{M}V^n+\textbf{M}V^{n-1} \\ &amp; +k_n\left[-\frac{1}{4}\sigma^2\textbf{D}V^{n-1} \ -\frac{1}{4}\sigma^2\textbf{D}V^n \ - \sigma^2\textbf{B}V^n \ -\frac{1}{2}r\textbf{M}V^{n-1} - \frac{1}{2}r\textbf{M}V^n \ -r\textbf{A}V^n \ -r\frac{1}{2}\textbf{M}V^{n-1} - \frac{1}{2} r\textbf{M}V^n\right] \\ &amp;= -\textbf{M}V^n + \textbf{M}V^{n-1} +\ k_n\left[- \frac{1}{4}\sigma^2\textbf{D}V^{n-1} -\ \frac{1}{4}\sigma^2\textbf{D}V^n - r\textbf{M}V^{n-1} -\ r\textbf{M}V^n - \sigma^2\textbf{B}V^{n-1} - r\textbf{A}V^{n-1}\right] \end{align*}
</p>
<p> So, altogether we have: </p><p class="formulaDsp">
\begin{equation} 0 = \textbf{M}V^n - \textbf{M}V^{n-1} +\ k_n\left[ \frac{1}{4}\sigma^2\textbf{D}V^{n-1} +\ \frac{1}{4}\sigma^2\textbf{D}V^n + r\textbf{M}V^{n-1} + r\textbf{M}V^n +\ \sigma^2\textbf{B}V^{n-1} + r\textbf{A}V^{n-1}\right]\tag{*} \end{equation}
</p>
<p>As usual, we can write this with the unknown quantities on the left and theknown ones on the right. This leads to the following linear system that wouldhave to be solved in each time step: </p><p class="formulaDsp">
\begin{align*} \left[\textbf{M}+\frac{1}{4}k_n\sigma^2\textbf{D}+k_nr\textbf{M}\right]V^n\ =\ \left[-\frac{1}{4}k_n\sigma^2\textbf{D}-\ k_nr\textbf{M}+k_n\sigma^2\textbf{B}-\ k_nr\textbf{A}+\textbf{M}\right]V^{n-1} \end{align*}
</p>
<p><a class="anchor" id="TestCase"></a></p><h3>Test Case</h3>
<p>For this program, we will use the Method of Manufactured Solutions (MMS) to test that it is working correctly. This means that we will choose our solution to be a certain function similar to <a class="el" href="step_7.html">step-7</a> . For our case, we will use: </p><p class="formulaDsp">
\begin{align*} V(S,\tau) = -\tau^2 - S^2 + 6\tag{**} \end{align*}
</p>
<p> This means that, using our PDE, we arrive at the following problem: </p><p class="formulaDsp">
\begin{align*} &amp;-\frac{\partial V}{\partial \tau} +\ \frac{\sigma^2S^2}{2}\frac{\partial^2 V}{\partial S^2} +\ rS\frac{\partial V}{\partial S} - rV = f(S,\tau) \\ &amp;V(0,\tau) = -\tau^2 + 6 \\ &amp;V(S_\text{max}, \tau) = -S_\text{max}^2 - \tau^2 + 6 \\ &amp;V(S, 0) = -S^2 + 6 \end{align*}
</p>
<p> Where, \(f(S,\tau) = 2\tau - \sigma^2S^2 - 2rS^2 - r(-\tau^2 - S^2 + 6)\) .This set-up now has right hand sides for the equation itself and for theboundary conditions at \(S=0\) that we did not have before, along with "final"conditions (or, with \(\tau\) -time "initial conditions") that do not match thereal situation. We will implement this in such a way in the code that it is easyto exchange</p>
<ul>
<li>the introduction of the changes above is just meant to enable the use of a manufactured solution. If the program is working correctly, then it should produce (**) as thesolution. This does mean that we need to modify our variational form somewhat toaccount for the non-zero right hand side. First, we define the following: <p class="formulaDsp">
\begin{align*} F^n_i = \left(\phi_i(S), f^n(S)\right), &amp;&amp; \text{where } f^n(S) =\ f(S,\tau_n) \end{align*}
</p>
 So, we arrive at the new equation: <p class="formulaDsp">
\begin{align*} \left[\textbf{M}+\frac{1}{4}k_n\sigma^2\textbf{D}+k_nr\textbf{M}\right]V^n\ =\ \left[-\frac{1}{4}k_n\sigma^2\textbf{D}-\ k_nr\textbf{M}+k_n\sigma^2\textbf{B}-\ k_nr\textbf{A}+\textbf{M}\right]V^{n-1} -\ k_n\left[\frac{1}{2}F^{n-1}+\frac{1}{2}F^n\right] \end{align*}
</p>
</li>
</ul>
<p>We then solve this equation as outlined above.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The program starts with the usual include files, all of which you should have seen before by now:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="convergence__table_8h.html">deal.II/base/convergence_table.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__accessor_8h.html">deal.II/dofs/dof_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__accessor_8h.html">deal.II/grid/tria_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__iterator_8h.html">deal.II/grid/tria_iterator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="data__out__stack_8h.html">deal.II/numerics/data_out_stack.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"> </div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div></div><!-- fragment --><p>Then the usual placing of all content of this program into a namespace and the importation of the deal.II namespace into the one we will work in. We also define an identifier to allow for the MMS code to be run when <code>MMS</code> is defined. Otherwise, the program solves the original problem:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>BlackScholesSolver</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"> </div><div class="line"><span class="preprocessor">#define MMS</span></div></div><!-- fragment --><p><a class="anchor" id="SolutionClass"></a> </p><h3>Solution Class</h3>
<p>This section creates a class for the known solution when testing using the MMS. Here we are using \(v(\tau,S) = -\tau^2 -S^2 + 6\) for the solution. We need to include the solution equation and the gradient for the H1 seminorm calculation.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keyword">class </span>Solution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">   {</div><div class="line">   <span class="keyword">public</span>:</div><div class="line">     Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time);</div><div class="line">  </div><div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  </div><div class="line">     <span class="keyword">virtual</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a></div><div class="line">     <a class="code" href="classFunction.html#a4b0aadc89a827b39c20f12889aa88625">gradient</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  </div><div class="line">   <span class="keyword">private</span>:</div><div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">   };</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   Solution&lt;dim&gt;::Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time)</div><div class="line">     : maturity_time(maturity_time)</div><div class="line">   {</div><div class="line">     <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">   }</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keywordtype">double</span> Solution&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                               <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">     <span class="keywordflow">return</span></div><div class="line">  </div><div class="line">-Utilities::fixed_power&lt;2, double&gt;(p(component))</div><div class="line">  </div><div class="line">-</div><div class="line">            Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line">   }</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> Solution&lt;dim&gt;::gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line">     <span class="keywordflow">return</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2 p(component));</div><div class="line">   }</div></div><!-- fragment --><p><a class="anchor" id="EquationData"></a> </p><h3>Equation Data</h3>
<p>In the following classes and functions, we implement the right hand side and boundary values that define this problem and for which we need function objects. The right hand side is chosen as discussed at the end of the introduction. First, we handle the initial condition.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keyword">class </span>InitialConditions : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">   {</div><div class="line">   <span class="keyword">public</span>:</div><div class="line">     InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price);</div><div class="line">  </div><div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  </div><div class="line">   <span class="keyword">private</span>:</div><div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">   };</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   InitialConditions&lt;dim&gt;::InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price)</div><div class="line">     : strike_price(strike_price)</div><div class="line">   {}</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keywordtype">double</span> InitialConditions&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line"><span class="preprocessor"> #ifdef MMS</span></div><div class="line">     <span class="keywordflow">return</span></div><div class="line">  </div><div class="line">-Utilities::fixed_power&lt;2, double&gt;(p(component)) + 6;</div><div class="line"><span class="preprocessor"> #else</span></div><div class="line">     <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(p(component)</div><div class="line">  </div><div class="line">- strike_price, 0.);</div><div class="line"><span class="preprocessor"> #endif</span></div><div class="line"><span class="preprocessor">   }</span></div></div><!-- fragment --><p>Next, we handle the left boundary condition.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keyword">class </span>LeftBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">   {</div><div class="line">   <span class="keyword">public</span>:</div><div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">   };</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keywordtype">double</span> LeftBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <span class="comment">/*component*/</span> )<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line"><span class="preprocessor"> #ifdef MMS</span></div><div class="line">     <span class="keywordflow">return</span></div><div class="line">  </div><div class="line">-Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="classFunctionTime.html#ae7d37ddb04314b38cf67c6cba22923f6">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor"> #else</span></div><div class="line">     <span class="keywordflow">return</span> 0.;</div><div class="line"><span class="preprocessor"> #endif</span></div><div class="line"><span class="preprocessor">   }</span></div></div><!-- fragment --><p>Then, we handle the right boundary condition.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keyword">class </span>RightBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">   {</div><div class="line">   <span class="keyword">public</span>:</div><div class="line">     RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line">  </div><div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  </div><div class="line">   <span class="keyword">private</span>:</div><div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">   };</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   RightBoundaryValues&lt;dim&gt;::RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price,</div><div class="line">                                                 <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">     : strike_price(strike_price)</div><div class="line">     , interest_rate(interest_rate)</div><div class="line">   {}</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keywordtype">double</span> RightBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line"><span class="preprocessor"> #ifdef MMS</span></div><div class="line">     <span class="keywordflow">return</span></div><div class="line">  </div><div class="line">-Utilities::fixed_power&lt;2, double&gt;(p(component))</div><div class="line">  </div><div class="line">-</div><div class="line">            Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor"> #else</span></div><div class="line">     <span class="keywordflow">return</span> (p(component)</div><div class="line">  </div><div class="line">- strike_price)</div><div class="line">            <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>((-interest_rate) (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()));</div><div class="line"><span class="preprocessor"> #endif</span></div><div class="line"><span class="preprocessor">   }</span></div></div><!-- fragment --><p>Finally, we handle the right hand side.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">   {</div><div class="line">   <span class="keyword">public</span>:</div><div class="line">     RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line">  </div><div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  </div><div class="line">   <span class="keyword">private</span>:</div><div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">   };</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   RightHandSide&lt;dim&gt;::RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility,</div><div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">     : asset_volatility(asset_volatility)</div><div class="line">     , interest_rate(interest_rate)</div><div class="line">   {}</div><div class="line">  </div><div class="line"> </div><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">   </span>{</div><div class="line"><span class="preprocessor"> #ifdef MMS</span></div><div class="line">     <span class="keywordflow">return</span> 2 (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>())</div><div class="line">  </div><div class="line">-</div><div class="line">            Utilities::fixed_power&lt;2, double&gt;(asset_volatility p(component))</div><div class="line">  </div><div class="line">-</div><div class="line">            2 interest_rate Utilities::fixed_power&lt;2, double&gt;(p(component))</div><div class="line">  </div><div class="line">-</div><div class="line">            interest_rate</div><div class="line">              (-Utilities::fixed_power&lt;2, double&gt;(p(component))</div><div class="line">  </div><div class="line">-</div><div class="line">               Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6);</div><div class="line"><span class="preprocessor"> #else</span></div><div class="line">     (void)p;</div><div class="line">     (void)component;</div><div class="line">     <span class="keywordflow">return</span> 0.0;</div><div class="line"><span class="preprocessor"> #endif</span></div><div class="line"><span class="preprocessor">   }</span></div></div><!-- fragment --><p><a class="anchor" id="ThecodeBlackScholescodeClass"></a> </p><h3>The <code>BlackScholes</code> Class</h3>
<p>The next piece is the declaration of the main class of this program. This is very similar to the <a class="el" href="step_26.html">step-26</a> tutorial, with some modifications. New matrices had to be added to calculate the A and B matrices, as well as the \(V_{diff}\) vector mentioned in the introduction. We also define the parameters used in the problem.</p>
<ul>
<li><code>maximum_stock_price</code> : The imposed upper bound on the spatial domain. This is the maximum allowed stock price.</li>
<li><code>maturity_time</code> : The upper bound on the time domain. This is when the option expires.<br />
</li>
<li><code>asset_volatility</code> : The volatility of the stock price.<br />
</li>
<li><code>interest_rate</code> : The risk free interest rate.<br />
</li>
<li><code>strike_price</code> : The agreed upon price that the buyer will have the option of purchasing the stocks at the expiration time. Some slight differences between this program and <a class="el" href="step_26.html">step-26</a> are the creation of the <code>a_matrix</code> and the <code>b_matrix</code> , which is described in the introduction. We then also need to store the current time, the size of the time step, and the number of the current time step. Next, we will store the output into a <code><a class="el" href="classDataOutStack.html">DataOutStack</a></code> variable because we will be layering the solution at each time on top of one another to create the solution manifold. Then, we have a variable that stores the current cycle and number of cycles that we will run when calculating the solution. The cycle is one full solution calculation given a mesh. We refine the mesh once in between each cycle to exhibit the convergence properties of our program. Finally, we store the convergence data into a convergence table. As far as member functions are concerned, we have a function that calculates the convergence information for each cycle, called <code>process_solution</code> . This is just like what is done in <a class="el" href="step_7.html">step-7</a> .</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>BlackScholes</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  BlackScholes();</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> setup_system();</div><div class="line">  <span class="keywordtype">void</span> solve_time_step();</div><div class="line">  <span class="keywordtype">void</span> refine_grid();</div><div class="line">  <span class="keywordtype">void</span> process_solution();</div><div class="line">  <span class="keywordtype">void</span> add_results_for_output();</div><div class="line">  <span class="keywordtype">void</span> write_convergence_table();</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maximum_stock_price;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line"></div><div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div><div class="line"></div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div><div class="line">  SparseMatrix&lt;double&gt; <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div><div class="line">  SparseMatrix&lt;double&gt; laplace_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; a_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; b_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; system_matrix;</div><div class="line"></div><div class="line">  Vector&lt;double&gt; solution;</div><div class="line">  Vector&lt;double&gt; system_rhs;</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> time;</div><div class="line">  <span class="keywordtype">double</span> time_step;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       theta;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_time_steps;</div><div class="line"></div><div class="line">  <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;</a>        data_out_stack;</div><div class="line">  std::vector&lt;std::string&gt; solution_names;</div><div class="line"></div><div class="line">  <a class="code" href="classConvergenceTable.html">ConvergenceTable</a> convergence_table;</div><div class="line">};</div></div><!-- fragment --><p><a class="anchor" id="ThecodeBlackScholescodeImplementation"></a> </p><h3>The <code>BlackScholes</code> Implementation</h3>
<p>Now, we get to the implementation of the main class. We will set the values for the various parameters used in the problem. These were chosen because they are fairly normal values for these parameters. Although the stock price has no upper bound in reality (it is in fact infinite), we impose an upper bound that is twice the strike price. This is a somewhat arbitrary choice to be twice the strike price, but it is large enough to see the interesting parts of the solution.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">BlackScholes&lt;dim&gt;::BlackScholes()</div><div class="line">  : maximum_stock_price(1.)</div><div class="line">  , maturity_time(1.)</div><div class="line">  , asset_volatility(.2)</div><div class="line">  , interest_rate(0.05)</div><div class="line">  , strike_price(0.5)</div><div class="line">  , fe(1)</div><div class="line">  , dof_handler(triangulation)</div><div class="line">  , time(0.0)</div><div class="line">  , theta(0.5)</div><div class="line">  , n_cycles(4)</div><div class="line">  , n_time_steps(5000)</div><div class="line">{</div><div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholessetup_systemcode"></a> </p><h4><code>BlackScholes::setup_system</code></h4>
<p>The next function sets up the <a class="el" href="classDoFHandler.html">DoFHandler</a> object, computes the constraints, and sets the linear algebra objects to their correct sizes. We also compute the mass matrix here by calling a function from the library. We will compute the other 3 matrices next, because these need to be computed 'by hand'. Note, that the time step is initialized here because the maturity time was needed to compute the time step.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::setup_system()</div><div class="line">{</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">  time_step = maturity_time / n_time_steps;</div><div class="line"></div><div class="line">  constraints.clear();</div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">  constraints.close();</div><div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                  dsp,</div><div class="line">                                  constraints,</div><div class="line">                                   <span class="comment">/*keep_constrained_dofs = */</span>  <span class="keyword">true</span>);</div><div class="line">  sparsity_pattern.<a class="code" href="classBlockSparsityPattern.html#a923288e4b4093f86b680e7045e9b4984">copy_from</a>(dsp);</div><div class="line"></div><div class="line">  mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a614ca8e186fe3c61e03a52369437157e">reinit</a>(sparsity_pattern);</div><div class="line">  laplace_matrix.reinit(sparsity_pattern);</div><div class="line">  a_matrix.reinit(sparsity_pattern);</div><div class="line">  b_matrix.reinit(sparsity_pattern);</div><div class="line">  system_matrix.reinit(sparsity_pattern);</div><div class="line"></div><div class="line">  <a class="code" href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a>(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    mass_matrix);</div></div><!-- fragment --><p>Below is the code to create the Laplace matrix with non-constant coefficients. This corresponds to the matrix D in the introduction. This non-constant coefficient is represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.dofs_per_cell;</div><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line"><a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>        quadrature_formula(fe.degree + 1);</div><div class="line"><a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>      fe_values(fe,</div><div class="line">                        quadrature_formula,</div><div class="line">                        <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line">std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">  {</div><div class="line">    cell_matrix = 0.;</div><div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> current_coefficient =</div><div class="line">          fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index).<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>();</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                (current_coefficient              <span class="comment">// (x_q)^2</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));           <span class="comment">// dx</span></div><div class="line">          }</div><div class="line">      }</div><div class="line">    cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          laplace_matrix.add(local_dof_indices[i],</div><div class="line">                             local_dof_indices[j],</div><div class="line">                             cell_matrix(i, j));</div><div class="line">      }</div><div class="line">  }</div></div><!-- fragment --><p>Now we will create the A matrix. Below is the code to create the matrix A as discussed in the introduction. The non constant coefficient is again represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">  {</div><div class="line">    cell_matrix = 0.;</div><div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">          fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                  (current_coefficient               <span class="comment">// x_q</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index)  <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(j, q_index) <span class="comment">// phi_j(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">      }</div><div class="line">    cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          a_matrix.add(local_dof_indices[i],</div><div class="line">                       local_dof_indices[j],</div><div class="line">                       cell_matrix(i, j));</div><div class="line">      }</div><div class="line">  }</div></div><!-- fragment --><p>Finally we will create the matrix B. Below is the code to create the matrix B as discussed in the introduction. The non constant coefficient is again represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">    {</div><div class="line">      cell_matrix = 0.;</div><div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">        {</div><div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">            fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                  (current_coefficient               <span class="comment">// x_q</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_index) <span class="comment">// phi_i(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index)  <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">            }</div><div class="line">        }</div><div class="line">      cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">        {</div><div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">            b_matrix.add(local_dof_indices[i],</div><div class="line">                         local_dof_indices[j],</div><div class="line">                         cell_matrix(i, j));</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">  solution.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholessolve_time_stepcode"></a> </p><h4><code>BlackScholes::solve_time_step</code></h4>
<p>The next function is the one that solves the actual linear system for a single time step. The only interesting thing here is that the matrices we have built are symmetric positive definite, so we can use the conjugate gradient method.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::solve_time_step()</div><div class="line">{</div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>                          solver_control(1000, 1e-12);</div><div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt;               cg(solver_control);</div><div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div><div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#a7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.0);</div><div class="line">  cg.solve(system_matrix, solution, system_rhs, preconditioner);</div><div class="line">  constraints.distribute(solution);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesadd_results_for_outputcode"></a> </p><h4><code>BlackScholes::add_results_for_output</code></h4>
<p>This is simply the function to stitch the solution pieces together. For this, we create a new layer at each time, and then add the solution vector for that timestep. The function then stitches this together with the old solutions using 'build_patches'.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::add_results_for_output()</div><div class="line">{</div><div class="line">  data_out_stack.new_parameter_value(time, time_step);</div><div class="line">  data_out_stack.attach_dof_handler(dof_handler);</div><div class="line">  data_out_stack.add_data_vector(solution, solution_names);</div><div class="line">  data_out_stack.build_patches(2);</div><div class="line">  data_out_stack.finish_parameter_value();</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesrefine_gridcode"></a> </p><h4><code>BlackScholes::refine_grid</code></h4>
<p>It is somewhat unnecessary to have a function for the global refinement that we do. The reason for the function is to allow for the possibility of an adaptive refinement later.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::refine_grid()</div><div class="line">{</div><div class="line">  triangulation.refine_global(1);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesprocess_solutioncode"></a> </p><h4><code>BlackScholes::process_solution</code></h4>
<p>This is where we calculate the convergence and error data to evaluate the effectiveness of the program. Here, we calculate the \(L^2\) , \(H^1\) and \(L^{\infty}\) norms.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::process_solution()</div><div class="line">{</div><div class="line">  Solution&lt;dim&gt; sol(maturity_time);</div><div class="line">  sol.set_time(time);</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> difference_per_cell(triangulation.n_active_cells());</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> L2_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> H1_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>  q_trapezoid;</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> q_iterated(q_trapezoid, fe.degree 2 + 1);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    q_iterated,</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> Linfty_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_active_cells = triangulation.n_active_cells();</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs         = dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>();</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;cells&quot;</span>, n_active_cells);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;dofs&quot;</span>, n_dofs);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;L2&quot;</span>, L2_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;H1&quot;</span>, H1_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;Linfty&quot;</span>, Linfty_error);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholeswrite_convergence_tablecode"></a> </p><h4><code>BlackScholes::write_convergence_table</code> </h4>
<p>This next part is building the convergence and error tables. By this, we need to set the settings for how to output the data that was calculated during <code>BlackScholes::process_solution</code> . First, we will create the headings and set up the cells properly. During this, we will also prescribe the precision of our results. Then we will write the calculated errors based on the \(L^2\) , \(H^1\) , and \(L^{\infty}\) norms to the console and to the error LaTeX file.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::write_convergence_table()</div><div class="line">{</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;L2&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;H1&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;Linfty&quot;</span>, 3);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;L2&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;H1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;\\# cells&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;\\# dofs&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;L2&quot;</span>, <span class="stringliteral">&quot;@fL^2@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;H1&quot;</span>, <span class="stringliteral">&quot;@fH^1@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="stringliteral">&quot;@fL^\\infty@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_format(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">  convergence_table.set_tex_format(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">  std::cout &lt;&lt; std::endl;</div><div class="line">  convergence_table.write_text(std::cout);</div><div class="line">  std::string error_filename = <span class="stringliteral">&quot;error&quot;</span>;</div><div class="line">  error_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">  error_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">  std::ofstream error_table_file(error_filename);</div><div class="line">  convergence_table.write_tex(error_table_file);</div></div><!-- fragment --><p>Next, we will make the convergence table. We will again write this to the console and to the convergence LaTeX file.</p>
<div class="fragment"><div class="line">  convergence_table.add_column_to_supercolumn(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">  std::vector&lt;std::string&gt; new_order;</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;H1&quot;</span>);</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;L2&quot;</span>);</div><div class="line">  convergence_table.set_column_order(new_order);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">  std::cout &lt;&lt; std::endl;</div><div class="line">  convergence_table.write_text(std::cout);</div><div class="line">  std::string conv_filename = <span class="stringliteral">&quot;convergence&quot;</span>;</div><div class="line">  conv_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">  <span class="keywordflow">switch</span> (fe.degree)</div><div class="line">    {</div><div class="line">      <span class="keywordflow">case</span> 1:</div><div class="line">        conv_filename += <span class="stringliteral">&quot;-q1&quot;</span>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> 2:</div><div class="line">        conv_filename += <span class="stringliteral">&quot;-q2&quot;</span>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">    }</div><div class="line">  conv_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">  std::ofstream table_file(conv_filename);</div><div class="line">  convergence_table.write_tex(table_file);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesruncode"></a> </p><h4><code>BlackScholes::run</code></h4>
<p>Now we get to the main driver of the program. This is where we do all the work of looping through the time steps and calculating the solution vector each time. Here at the top, we set the initial refinement value and then create a mesh. Then we refine this mesh once. Next, we set up the data_out_stack object to store our solution. Finally, we start a for loop to loop through the cycles. This lets us recalculate a solution for each successive mesh refinement. At the beginning of each iteration, we need to reset the time and time step number. We introduce an if statement to accomplish this because we don't want to do this on the first iteration.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">   <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">BlackScholes&lt;dim&gt;::run</a>()</div><div class="line">   {</div><div class="line">     <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, 0.0, maximum_stock_price, <span class="keyword">true</span>);</div><div class="line">     triangulation.refine_global(0);</div><div class="line">  </div><div class="line">     solution_names.emplace_back(<span class="stringliteral">&quot;u&quot;</span>);</div><div class="line">     data_out_stack.declare_data_vector(solution_names,</div><div class="line">                                        <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;::dof_vector</a>);</div><div class="line">  </div><div class="line">     Vector&lt;double&gt; vmult_result;</div><div class="line">     Vector&lt;double&gt; forcing_terms;</div><div class="line">  </div><div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; cycle++)</div><div class="line">       {</div><div class="line">         <span class="keywordflow">if</span> (cycle != 0)</div><div class="line">           {</div><div class="line">             refine_grid();</div><div class="line">             time = 0.0;</div><div class="line">           }</div><div class="line">  </div><div class="line">         setup_system();</div><div class="line">  </div><div class="line">         std::cout &lt;&lt; std::endl</div><div class="line">                   &lt;&lt; <span class="stringliteral">&quot;===========================================&quot;</span> &lt;&lt; std::endl</div><div class="line">                   &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl</div><div class="line">                   &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span></div><div class="line">                   &lt;&lt; triangulation.n_active_cells() &lt;&lt; std::endl</div><div class="line">                   &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()</div><div class="line">                   &lt;&lt; std::endl</div><div class="line">                   &lt;&lt; std::endl;</div><div class="line">  </div><div class="line">         <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler,</div><div class="line">                                  InitialConditions&lt;dim&gt;(strike_price),</div><div class="line">                                  solution);</div><div class="line">  </div><div class="line">         <span class="keywordflow">if</span> (cycle == (n_cycles</div><div class="line">  </div><div class="line">- 1))</div><div class="line">           {</div><div class="line">             add_results_for_output();</div><div class="line">           }</div></div><!-- fragment --><p>Next, we run the main loop which runs until we exceed the maturity time. We first compute the right hand side of the equation, which is described in the introduction. Recall that it contains the term \(\left[-\frac{1}{4}k_n\sigma^2\mathbf{D}-k_nr\mathbf{M}+k_n\sigma^2 \mathbf{B}-k_nr\mathbf{A}+\mathbf{M}\right]V^{n-1}\) . We put these terms into the variable system_rhs, with the help of a temporary vector:</p>
<div class="fragment"><div class="line">         vmult_result.<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">         forcing_terms.<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number = 0; timestep_number &lt; n_time_steps;</div><div class="line">              ++timestep_number)</div><div class="line">           {</div><div class="line">             time += time_step;</div><div class="line">  </div><div class="line">             <span class="keywordflow">if</span> (timestep_number % 1000 == 0)</div><div class="line">               std::cout &lt;&lt; <span class="stringliteral">&quot;Time step &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; at t=&quot;</span> &lt;&lt; time</div><div class="line">                         &lt;&lt; std::endl;</div><div class="line">  </div><div class="line">             mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(system_rhs, solution);</div><div class="line">  </div><div class="line">             laplace_matrix.vmult(vmult_result, solution);</div><div class="line">             system_rhs.add(</div><div class="line">               (-1) (1</div><div class="line">  </div><div class="line">- theta) time_step</div><div class="line">                 Utilities::fixed_power&lt;2, double&gt;(asset_volatility) 0.5,</div><div class="line">               vmult_result);</div><div class="line">             mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(vmult_result, solution);</div><div class="line">  </div><div class="line">             system_rhs.add((-1) (1</div><div class="line">  </div><div class="line">- theta) time_step interest_rate 2,</div><div class="line">                            vmult_result);</div><div class="line">  </div><div class="line">             a_matrix.vmult(vmult_result, solution);</div><div class="line">             system_rhs.add((-1) time_step interest_rate, vmult_result);</div><div class="line">  </div><div class="line">             b_matrix.vmult(vmult_result, solution);</div><div class="line">             system_rhs.add(</div><div class="line">               (-1) Utilities::fixed_power&lt;2, double&gt;(asset_volatility)</div><div class="line">                 time_step 1,</div><div class="line">               vmult_result);</div></div><!-- fragment --><p>The second piece is to compute the contributions of the source terms. This corresponds to the term \(-k_n\left[\frac{1}{2}F^{n-1} +\frac{1}{2}F^n\right]\) . The following code calls <a class="el" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a> to compute the vectors \(F\) , where we set the time of the right hand side (source) function before we evaluate it. The result of this all ends up in the forcing_terms variable:</p>
<div class="fragment"><div class="line">             RightHandSide&lt;dim&gt; rhs_function(asset_volatility, interest_rate);</div><div class="line">             rhs_function.set_time(time);</div><div class="line">             <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                                 <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                                 rhs_function,</div><div class="line">                                                 forcing_terms);</div><div class="line">             forcing_terms= time_step theta;</div><div class="line">             system_rhs</div><div class="line">  </div><div class="line">-= forcing_terms;</div><div class="line">  </div><div class="line">             rhs_function.set_time(time</div><div class="line">  </div><div class="line">- time_step);</div><div class="line">             <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                                 <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                                 rhs_function,</div><div class="line">                                                 forcing_terms);</div><div class="line">             forcing_terms= time_step (1</div><div class="line">  </div><div class="line">- theta);</div><div class="line">             system_rhs</div><div class="line">  </div><div class="line">-= forcing_terms;</div></div><!-- fragment --><p>Next, we add the forcing terms to the ones that come from the time stepping, and also build the matrix \(\left[\mathbf{M}+ \frac{1}{4}k_n\sigma^2\mathbf{D}+k_nr\mathbf{M}\right]\) that we have to invert in each time step. The final piece of these operations is to eliminate hanging node constrained degrees of freedom from the linear system:</p>
<div class="fragment"><div class="line">system_matrix.copy_from(mass_matrix);</div><div class="line">system_matrix.add(</div><div class="line">  (theta)*time_step</div><div class="line">    Utilities::fixed_power&lt;2, double&gt;(asset_volatility) 0.5,</div><div class="line">  laplace_matrix);</div><div class="line">system_matrix.add((time_step)*interest_rate theta (1 + 1),</div><div class="line">                  mass_matrix);</div><div class="line"></div><div class="line">constraints.condense(system_matrix, system_rhs);</div></div><!-- fragment --><p>There is one more operation we need to do before we can solve it: boundary values. To this end, we create a boundary value object, set the proper time to the one of the current time step, and evaluate it as we have done many times before. The result is used to also set the correct boundary values in the linear system:</p>
<div class="fragment"><div class="line">{</div><div class="line">  RightBoundaryValues&lt;dim&gt; right_boundary_function(strike_price,</div><div class="line">                                                   interest_rate);</div><div class="line">  LeftBoundaryValues&lt;dim&gt;  left_boundary_function;</div><div class="line">  right_boundary_function.set_time(time);</div><div class="line">  left_boundary_function.set_time(time);</div><div class="line">  std::map&lt;types::global_dof_index, double&gt; boundary_values;</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           0,</div><div class="line">                                           left_boundary_function,</div><div class="line">                                           boundary_values);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           1,</div><div class="line">                                           right_boundary_function,</div><div class="line">                                           boundary_values);</div><div class="line">  <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div><div class="line">                                     system_matrix,</div><div class="line">                                     solution,</div><div class="line">                                     system_rhs);</div><div class="line">}</div></div><!-- fragment --><p>With this out of the way, all we have to do is solve the system, generate graphical data on the last cycle, and create the convergence table data.</p>
<div class="fragment"><div class="line">             solve_time_step();</div><div class="line">  </div><div class="line">             <span class="keywordflow">if</span> (cycle == (n_cycles</div><div class="line">  </div><div class="line">- 1))</div><div class="line">               {</div><div class="line">                 add_results_for_output();</div><div class="line">               }</div><div class="line">           }</div><div class="line"><span class="preprocessor"> #ifdef MMS</span></div><div class="line">         process_solution();</div><div class="line"><span class="preprocessor"> #endif</span></div><div class="line">       }</div><div class="line">  </div><div class="line">     <span class="keyword">const</span> std::string filename = <span class="stringliteral">&quot;solution.vtk&quot;</span>;</div><div class="line">     std::ofstream     output(filename);</div><div class="line">     data_out_stack.write_vtk(output);</div><div class="line">  </div><div class="line"><span class="preprocessor"> #ifdef MMS</span></div><div class="line">     write_convergence_table();</div><div class="line"><span class="preprocessor"> #endif</span></div><div class="line">   }</div><div class="line">  </div><div class="line"> } <span class="comment">// namespace BlackScholesSolver</span></div></div><!-- fragment --><p><a class="anchor" id="ThecodemaincodeFunction"></a> </p><h3>The <code>main</code> <a class="el" href="classFunction.html">Function</a></h3>
<p>Having made it this far, there is, again, nothing much to discuss for the main function of this program: it looks like all such functions since <a class="el" href="step_6.html">step-6</a> .</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span>BlackScholesSolver;</div><div class="line"> </div><div class="line">      BlackScholes&lt;1&gt; black_scholes_solver;</div><div class="line">      black_scholes_solver.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>Below is the output of the program: </p><div class="fragment"><div class="line">===========================================</div><div class="line">Number of active cells: 1</div><div class="line">Number of degrees of freedom: 2</div><div class="line">  </div><div class="line">Time step 0 at t=0.0002</div><div class="line">[...]</div><div class="line">  </div><div class="line">Cycle 7:</div><div class="line">Number of active cells: 128</div><div class="line">Number of degrees of freedom: 129</div><div class="line">  </div><div class="line">Time step 0 at t=0.0002</div><div class="line">Time step 1000 at t=0.2002</div><div class="line">Time step 2000 at t=0.4002</div><div class="line">Time step 3000 at t=0.6002</div><div class="line">Time step 4000 at t=0.8002</div><div class="line">  </div><div class="line">cells dofs    <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">L2</a>        H1      Linfty</div><div class="line">    1    2 1.667e-01 5.774e-01 2.222e-01</div><div class="line">    2    3 3.906e-02 2.889e-01 5.380e-02</div><div class="line">    4    5 9.679e-03 1.444e-01 1.357e-02</div><div class="line">    8    9 2.405e-03 7.218e-02 3.419e-03</div><div class="line">   16   17 5.967e-04 3.609e-02 8.597e-04</div><div class="line">   32   33 1.457e-04 1.804e-02 2.155e-04</div><div class="line">   64   65 3.307e-05 9.022e-03 5.388e-05</div><div class="line">  128  129 5.016e-06 4.511e-03 1.342e-05</div><div class="line">  </div><div class="line">n cells         H1                  <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">L2</a></div><div class="line">      1 5.774e-01</div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line">-</div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line">- 1.667e-01</div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line">-</div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line"></div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line">-</div><div class="line">      2 2.889e-01 2.00 1.00 3.906e-02 4.27 2.09</div><div class="line">      4 1.444e-01 2.00 1.00 9.679e-03 4.04 2.01</div><div class="line">      8 7.218e-02 2.00 1.00 2.405e-03 4.02 2.01</div><div class="line">     16 3.609e-02 2.00 1.00 5.967e-04 4.03 2.01</div><div class="line">     32 1.804e-02 2.00 1.00 1.457e-04 4.10 2.03</div><div class="line">     64 9.022e-03 2.00 1.00 3.307e-05 4.41 2.14</div><div class="line">    128 4.511e-03 2.00 1.00 5.016e-06 6.59 2.72</div></div><!-- fragment --><p>What is more interesting is the output of the convergence tables. They areoutputted into the console, as well into a LaTeX file. The convergence tablesare shown above. Here, you can see that the the solution has a convergence rateof \(\mathcal{O}(h)\) with respect to the \(H^1\) -norm, and the solution has a convergence rateof \(\mathcal{O}(h^2)\) with respect to the \(L^2\) -norm.</p>
<p>Below is the visualization of the solution. </p><div style="text-align:center;"> <div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-78.mms-solution.png" alt="Solution of the MMS problem."/>
</div>
 </div><p><a class="anchor" id="PlainProg"></a></p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2021 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Tyler Anderson, Colorado State University, 2021</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="convergence__table_8h.html">deal.II/base/convergence_table.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__accessor_8h.html">deal.II/dofs/dof_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__accessor_8h.html">deal.II/grid/tria_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__iterator_8h.html">deal.II/grid/tria_iterator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="data__out__stack_8h.html">deal.II/numerics/data_out_stack.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>BlackScholesSolver</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#define MMS</span></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>Solution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a></div><div class="line">    gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  Solution&lt;dim&gt;::Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time)</div><div class="line">    : maturity_time(maturity_time)</div><div class="line">  {</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> Solution&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> Solution&lt;dim&gt;::gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2 * p(component));</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>InitialConditions : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  InitialConditions&lt;dim&gt;::InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price)</div><div class="line">    : strike_price(strike_price)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> InitialConditions&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(p(component) - strike_price, 0.);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>LeftBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> LeftBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;,</div><div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> 0.;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightBoundaryValues&lt;dim&gt;::RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price,</div><div class="line">                                                <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : strike_price(strike_price)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> (p(component) - strike_price) *</div><div class="line">           <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>((-interest_rate) * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()));</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightHandSide&lt;dim&gt;::RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : asset_volatility(asset_volatility)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> 2 * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(asset_volatility * p(component)) -</div><div class="line">           2 * interest_rate * Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           interest_rate *</div><div class="line">             (-Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">              Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    (void)p;</div><div class="line">    (void)component;</div><div class="line">    <span class="keywordflow">return</span> 0.0;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>BlackScholes</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BlackScholes();</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> setup_system();</div><div class="line">    <span class="keywordtype">void</span> solve_time_step();</div><div class="line">    <span class="keywordtype">void</span> refine_grid();</div><div class="line">    <span class="keywordtype">void</span> process_solution();</div><div class="line">    <span class="keywordtype">void</span> add_results_for_output();</div><div class="line">    <span class="keywordtype">void</span> write_convergence_table();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximum_stock_price;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line"></div><div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div><div class="line">    SparseMatrix&lt;double&gt; <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div><div class="line">    SparseMatrix&lt;double&gt; laplace_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; a_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; b_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; system_matrix;</div><div class="line"></div><div class="line">    Vector&lt;double&gt; solution;</div><div class="line">    Vector&lt;double&gt; system_rhs;</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> time;</div><div class="line">    <span class="keywordtype">double</span> time_step;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       theta;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_time_steps;</div><div class="line"></div><div class="line">    <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;</a>        data_out_stack;</div><div class="line">    std::vector&lt;std::string&gt; solution_names;</div><div class="line"></div><div class="line">    <a class="code" href="classConvergenceTable.html">ConvergenceTable</a> convergence_table;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  BlackScholes&lt;dim&gt;::BlackScholes()</div><div class="line">    : maximum_stock_price(1.)</div><div class="line">    , maturity_time(1.)</div><div class="line">    , asset_volatility(.2)</div><div class="line">    , interest_rate(0.05)</div><div class="line">    , strike_price(0.5)</div><div class="line">    , fe(1)</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , time(0.0)</div><div class="line">    , theta(0.5)</div><div class="line">    , n_cycles(4)</div><div class="line">    , n_time_steps(5000)</div><div class="line">  {</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::setup_system()</div><div class="line">  {</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    time_step = maturity_time / n_time_steps;</div><div class="line"></div><div class="line">    constraints.clear();</div><div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">    constraints.close();</div><div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    dsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">true</span>);</div><div class="line">    sparsity_pattern.<a class="code" href="classBlockSparsityPattern.html#a923288e4b4093f86b680e7045e9b4984">copy_from</a>(dsp);</div><div class="line"></div><div class="line">    mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a614ca8e186fe3c61e03a52369437157e">reinit</a>(sparsity_pattern);</div><div class="line">    laplace_matrix.reinit(sparsity_pattern);</div><div class="line">    a_matrix.reinit(sparsity_pattern);</div><div class="line">    b_matrix.reinit(sparsity_pattern);</div><div class="line">    system_matrix.reinit(sparsity_pattern);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a>(dof_handler,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      mass_matrix);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.dofs_per_cell;</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>        quadrature_formula(fe.degree + 1);</div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>      fe_values(fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index).<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>();</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                    (current_coefficient *              <span class="comment">// (x_q)^2</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) * <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) * <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));           <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              laplace_matrix.add(local_dof_indices[i],</div><div class="line">                                 local_dof_indices[j],</div><div class="line">                                 cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  {</div><div class="line">                    <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                      (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) *  <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(j, q_index) * <span class="comment">// phi_j(x_q)</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">                  }</div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              a_matrix.add(local_dof_indices[i],</div><div class="line">                           local_dof_indices[j],</div><div class="line">                           cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                    (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_index) * <span class="comment">// phi_i(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) *  <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              b_matrix.add(local_dof_indices[i],</div><div class="line">                           local_dof_indices[j],</div><div class="line">                           cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    solution.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">    system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::solve_time_step()</div><div class="line">  {</div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>                          solver_control(1000, 1e-12);</div><div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt;               cg(solver_control);</div><div class="line">    <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div><div class="line">    preconditioner.<a class="code" href="classPreconditionSSOR.html#a7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.0);</div><div class="line">    cg.solve(system_matrix, solution, system_rhs, preconditioner);</div><div class="line">    constraints.distribute(solution);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::add_results_for_output()</div><div class="line">  {</div><div class="line">    data_out_stack.new_parameter_value(time, time_step);</div><div class="line">    data_out_stack.attach_dof_handler(dof_handler);</div><div class="line">    data_out_stack.add_data_vector(solution, solution_names);</div><div class="line">    data_out_stack.build_patches(2);</div><div class="line">    data_out_stack.finish_parameter_value();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::refine_grid()</div><div class="line">  {</div><div class="line">    triangulation.refine_global(1);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::process_solution()</div><div class="line">  {</div><div class="line">    Solution&lt;dim&gt; sol(maturity_time);</div><div class="line">    sol.set_time(time);</div><div class="line">    Vector&lt;float&gt; difference_per_cell(triangulation.n_active_cells());</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> L2_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> H1_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>  q_trapezoid;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> q_iterated(q_trapezoid, fe.degree * 2 + 1);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      q_iterated,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> Linfty_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_active_cells = triangulation.n_active_cells();</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs         = dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>();</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;cells&quot;</span>, n_active_cells);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;dofs&quot;</span>, n_dofs);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;L2&quot;</span>, L2_error);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;H1&quot;</span>, H1_error);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;Linfty&quot;</span>, Linfty_error);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::write_convergence_table()</div><div class="line">  {</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;L2&quot;</span>, 3);</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;H1&quot;</span>, 3);</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;Linfty&quot;</span>, 3);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;L2&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;H1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;\\# cells&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;\\# dofs&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;L2&quot;</span>, <span class="stringliteral">&quot;@f@f$L^2@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;H1&quot;</span>, <span class="stringliteral">&quot;@f@f$H^1@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="stringliteral">&quot;@f@f$L^\\infty@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_format(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">    convergence_table.set_tex_format(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">    std::cout &lt;&lt; std::endl;</div><div class="line">    convergence_table.write_text(std::cout);</div><div class="line">    std::string error_filename = <span class="stringliteral">&quot;error&quot;</span>;</div><div class="line">    error_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">    error_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">    std::ofstream error_table_file(error_filename);</div><div class="line">    convergence_table.write_tex(error_table_file);</div><div class="line"></div><div class="line">    convergence_table.add_column_to_supercolumn(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">    std::vector&lt;std::string&gt; new_order;</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;H1&quot;</span>);</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;L2&quot;</span>);</div><div class="line">    convergence_table.set_column_order(new_order);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">    std::cout &lt;&lt; std::endl;</div><div class="line">    convergence_table.write_text(std::cout);</div><div class="line">    std::string conv_filename = <span class="stringliteral">&quot;convergence&quot;</span>;</div><div class="line">    conv_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">    <span class="keywordflow">switch</span> (fe.degree)</div><div class="line">      {</div><div class="line">        <span class="keywordflow">case</span> 1:</div><div class="line">          conv_filename += <span class="stringliteral">&quot;-q1&quot;</span>;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> 2:</div><div class="line">          conv_filename += <span class="stringliteral">&quot;-q2&quot;</span>;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">      }</div><div class="line">    conv_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">    std::ofstream table_file(conv_filename);</div><div class="line">    convergence_table.write_tex(table_file);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">BlackScholes&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, 0.0, maximum_stock_price, <span class="keyword">true</span>);</div><div class="line">    triangulation.refine_global(0);</div><div class="line"></div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;u&quot;</span>);</div><div class="line">    data_out_stack.declare_data_vector(solution_names,</div><div class="line">                                       <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;::dof_vector</a>);</div><div class="line"></div><div class="line">    Vector&lt;double&gt; vmult_result;</div><div class="line">    Vector&lt;double&gt; forcing_terms;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; cycle++)</div><div class="line">      {</div><div class="line">        <span class="keywordflow">if</span> (cycle != 0)</div><div class="line">          {</div><div class="line">            refine_grid();</div><div class="line">            time = 0.0;</div><div class="line">          }</div><div class="line"></div><div class="line">        setup_system();</div><div class="line"></div><div class="line">        std::cout &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;===========================================&quot;</span> &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span></div><div class="line">                  &lt;&lt; triangulation.n_active_cells() &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()</div><div class="line">                  &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler,</div><div class="line">                                 InitialConditions&lt;dim&gt;(strike_price),</div><div class="line">                                 solution);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">          {</div><div class="line">            add_results_for_output();</div><div class="line">          }</div><div class="line"></div><div class="line">        vmult_result.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">        forcing_terms.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number = 0; timestep_number &lt; n_time_steps;</div><div class="line">             ++timestep_number)</div><div class="line">          {</div><div class="line">            time += time_step;</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (timestep_number % 1000 == 0)</div><div class="line">              std::cout &lt;&lt; <span class="stringliteral">&quot;Time step &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; at t=&quot;</span> &lt;&lt; time</div><div class="line">                        &lt;&lt; std::endl;</div><div class="line"></div><div class="line">            mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(system_rhs, solution);</div><div class="line"></div><div class="line">            laplace_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add(</div><div class="line">              (-1) * (1 - theta) * time_step *</div><div class="line">                Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">              vmult_result);</div><div class="line">            mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(vmult_result, solution);</div><div class="line"></div><div class="line">            system_rhs.add((-1) * (1 - theta) * time_step * interest_rate * 2,</div><div class="line">                           vmult_result);</div><div class="line"></div><div class="line">            a_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add((-1) * time_step * interest_rate, vmult_result);</div><div class="line"></div><div class="line">            b_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add(</div><div class="line">              (-1) * Utilities::fixed_power&lt;2, double&gt;(asset_volatility) *</div><div class="line">                time_step * 1,</div><div class="line">              vmult_result);</div><div class="line"></div><div class="line">            RightHandSide&lt;dim&gt; rhs_function(asset_volatility, interest_rate);</div><div class="line">            rhs_function.set_time(time);</div><div class="line">            <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                                <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                                rhs_function,</div><div class="line">                                                forcing_terms);</div><div class="line">            forcing_terms *= time_step * theta;</div><div class="line">            system_rhs -= forcing_terms;</div><div class="line"></div><div class="line">            rhs_function.set_time(time - time_step);</div><div class="line">            <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                                <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                                rhs_function,</div><div class="line">                                                forcing_terms);</div><div class="line">            forcing_terms *= time_step * (1 - theta);</div><div class="line">            system_rhs -= forcing_terms;</div><div class="line"></div><div class="line">            system_matrix.copy_from(mass_matrix);</div><div class="line">            system_matrix.add(</div><div class="line">              (theta)*time_step *</div><div class="line">                Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">              laplace_matrix);</div><div class="line">            system_matrix.add((time_step)*interest_rate * theta * (1 + 1),</div><div class="line">                              mass_matrix);</div><div class="line"></div><div class="line">            constraints.condense(system_matrix, system_rhs);</div><div class="line"></div><div class="line">            {</div><div class="line">              RightBoundaryValues&lt;dim&gt; right_boundary_function(strike_price,</div><div class="line">                                                               interest_rate);</div><div class="line">              LeftBoundaryValues&lt;dim&gt;  left_boundary_function;</div><div class="line">              right_boundary_function.set_time(time);</div><div class="line">              left_boundary_function.set_time(time);</div><div class="line">              std::map&lt;types::global_dof_index, double&gt; boundary_values;</div><div class="line">              <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                                       0,</div><div class="line">                                                       left_boundary_function,</div><div class="line">                                                       boundary_values);</div><div class="line">              <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                                       1,</div><div class="line">                                                       right_boundary_function,</div><div class="line">                                                       boundary_values);</div><div class="line">              <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 solution,</div><div class="line">                                                 system_rhs);</div><div class="line">            }</div><div class="line"></div><div class="line">            solve_time_step();</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">              {</div><div class="line">                add_results_for_output();</div><div class="line">              }</div><div class="line">          }</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">        process_solution();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::string filename = <span class="stringliteral">&quot;solution.vtk&quot;</span>;</div><div class="line">    std::ofstream     output(filename);</div><div class="line">    data_out_stack.write_vtk(output);</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    write_convergence_table();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line">} <span class="comment">// namespace BlackScholesSolver</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span>BlackScholesSolver;</div><div class="line"></div><div class="line">      BlackScholes&lt;1&gt; black_scholes_solver;</div><div class="line">      black_scholes_solver.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>This tutorial depends on <a class="el" href="step_26.html">step-26</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Particularitiesoftheequationsystem">Particularities of the equation system</a>
        <li><a href="#Schemeforthenumericalsolution">Scheme for the numerical solution</a>
        <li><a href="#TestCase">Test Case</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#SolutionClass">Solution Class</a>
        <li><a href="#EquationData">Equation Data</a>
        <li><a href="#ThecodeBlackScholescodeClass">The <code>BlackScholes</code> Class</a>
        <li><a href="#ThecodeBlackScholescodeImplementation">The <code>BlackScholes</code> Implementation</a>
      <ul>
        <li><a href="#codeBlackScholessetup_systemcode"><code>BlackScholes::setup_system</code></a>
        <li><a href="#codeBlackScholessolve_time_stepcode"><code>BlackScholes::solve_time_step</code></a>
        <li><a href="#codeBlackScholesadd_results_for_outputcode"><code>BlackScholes::add_results_for_output</code></a>
        <li><a href="#codeBlackScholesrefine_gridcode"><code>BlackScholes::refine_grid</code></a>
        <li><a href="#codeBlackScholesprocess_solutioncode"><code>BlackScholes::process_solution</code></a>
        <li><a href="#codeBlackScholeswrite_convergence_tablecode"><code>BlackScholes::write_convergence_table</code> </a>
        <li><a href="#codeBlackScholesruncode"><code>BlackScholes::run</code></a>
      </ul>
        <li><a href="#ThecodemaincodeFunction">The <code>main</code> Function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 examples/step-78/doc/intro.dox</p>
<p><a class="anchor" id="Intro"></a></p>
<p><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>- " " " " \(T\)  \(K\) """" \(t&lt;T\)  \(S\) -- "" \(V(S,t)\) 1997 <b>[black1973pricing]</b> </p>
<p></p>
<p class="formulaDsp">
\begin{align*} &amp;\frac{\partial V}{\partial t} + \frac{\sigma^2S^2}{2} \ \frac{\partial^2 V}{\partial S^2} + \ rS\frac{\partial V}{\partial S} - rV = 0, \ \quad\quad &amp;&amp;\forall S\in \Omega, t \in (0,T) \\ &amp;V(0,t) = 0, \ &amp;&amp;\forall t \in (0,T) \\ &amp;V(S,t) \rightarrow S, \ &amp;&amp; \text{as } S \rightarrow \infty, \forall t \in (0,T) \\ &amp;V(S,T) = \max(S-K,0) \ &amp;&amp;\forall S \in \Omega \end{align*}
</p>
<p></p>
<p class="formulaDsp">
\begin{align*} V(S,t): &amp;&amp; \text{Value of call option at time t and asset price S} \\ \sigma: &amp;&amp; \text{Volatility of the underlying asset} \\ r: &amp;&amp; \text{Risk free interest rate} \\ K : &amp;&amp; \text{Strike price for purchasing asset} \end{align*}
</p>
<p> " " \(S\)  \(V(S,t)\)  \(t\)  \(S\) </p>
<p><a class="anchor" id="Particularitiesoftheequationsystem"></a></p><h3>Particularities of the equation system</h3>
<p>" " \(\Omega\subset\mathbb{R}\)  \(S\)  \(V(S,t)\rightarrow S\)  \(S\rightarrow \infty\)  \(t=T\)  \(S\gg K\)  \(K\)  \(V\approx S-K\)  \(S\)  \(K\)  \(V\rightarrow S\) </p>
<p> \(\Omega\)  \(\Omega\) 0 \(S\)  \(S_\text{max}\)  \(\Omega=[0,S_\text{max}]\) </p>
<p> "- " <b>[stoll1969relationship]</b>  " " \(K\) * \(T\) </p>
<p class="formulaDsp">
\begin{align*} V(S,t)+Ke^{-r(T-t)}=P(S,t)+S \end{align*}
</p>
<p> \(V(S,t)\)  \(P(S,t)\)  \(P(S,t) \rightarrow 0\)  \(S \rightarrow \infty\) </p>
<p class="formulaDsp">
\begin{align*} V(S,t) \rightarrow S-Ke^{-r(T-t)}, \end{align*}
</p>
<p> \(S_\text{max}\) </p>
<p>Block-Scholes  \(t=T\)  \(T\)  \(S&lt;K\)  \(K\)  \(V(S,T)=0\)  \(S&lt;K\)  \(T\)  \(S&gt;K\)  \(K\)  \(S\)  \(S-K\)  \(V(S,T)=S-K\)  \(S&gt;K\) ** \(V\) &ndash; \(t=0\) </p>
<p>* \(\tau=T-t\)  \(\tau\)  \(T\) </p>
<p></p>
<p class="formulaDsp">
\begin{align*} &amp;-\frac{\partial V}{\partial \tau} + \frac{\sigma^2S^2}{2} \ \frac{\partial^2 V}{\partial S^2} + rS\frac{\partial V}{\partial S} - rV=0\ , \quad\quad &amp;&amp;\forall S\in [0,S_\text{max}], \tau \in [0,T] \\ &amp;V(0,\tau) = 0, \ &amp;&amp;\forall \tau \in [0,T] \\ &amp;V(S_\text{max},\tau)=S_\text{max}-Ke^{-r\tau}, \ &amp;&amp;\forall \tau \in [0,T] \\ &amp;V(S,0) = \max(S-K,0) \ &amp;&amp;\forall S \in [0,S_\text{max}] \end{align*}
</p>
<p> \(V\) --</p>
<p><a class="anchor" id="Schemeforthenumericalsolution"></a></p><h3>Scheme for the numerical solution</h3>
<p>IMEXthetatheta \(V^n(S)\)  \(V(S,\tau_n)\) </p>
<p class="formulaDsp">
\begin{align*} 0=&amp;-\frac{V^n(S)-V^{n-1}(S)}{k_n} \\ &amp;+\frac{\sigma^2S^2}{2}\left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right] \\ &amp;+rS\left[(1-\theta)\frac{dV^{n-1}(S)}{dS} + \ \theta\frac{dV^{n}(S)}{dS}\right] \\ &amp;-r\left[(1-\theta)V^{n-1}(S) + \theta V^n(S)\right] \end{align*}
</p>
<p> \(k_n=\tau_n-\tau_{n-1}\) </p>
<p> \(\{\phi_i(S)\}_{i\in\mathbb{N}}\) </p>
<p class="formulaDsp">
\begin{align*} 0=&amp;-\int_0^{S_\text{max}}\phi_i(S)\left[V^n(S)-V^{n-1}(S)\right]dS \\ &amp;+k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \ \left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;+k_n\int_0^{S_\text{max}}\phi_i(S)\left[rS\left[(1-\theta) \frac{dV^{n-1}(S)}{dS}\ + \theta\frac{dV^{n}(S)}{dS}\right]\right]dS \\ &amp;-k_n\int_0^{S_\text{max}}\phi_i(S)\left[r\left[(1-\theta)V^{n-1}(S)\ + \theta V^n(S)\right]\right]dS \end{align*}
</p>
<p>1 \(-\textbf{M}V^n+\textbf{M}V^{n-1}\) 4 \(k_n\left[-r(1-\theta)\textbf{M}V^{n-1} - \theta r\textbf{M}V^n\right]\)  \(\textbf{M}_{i,j}=\left(\phi_i(S),\phi_j(S)\right)\)  \(V\)  \(V(S)\) </p>
<p>23</p>
<p>2</p>
<p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \ \left[(1-\theta)\frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;=k_n(1-\theta)\int_0^{S_\text{max}}\phi_i(S)\frac{\sigma^2S^2}{2} \ \frac{d^2V^{n-1}(S)}{dS^2} \ +k_n\theta\int_0^{S_\text{max}}\phi_i(S)\frac{\sigma^2S^2}{2} \ \frac{d^2V^{n}(S)}{dS^2} \end{align*}
</p>
<p>V</p>
<p class="formulaDsp">
\begin{align*} &amp;\int_{0}^{S_\text{max}} \phi_i(S)\frac{\sigma^2S^2}{2} \frac{d^2V^n(S)}{dS^2}dS \\ &amp;= \phi_i(S)\frac{1}{2}\sigma^2S^2\frac{dV^n(S)}{dS}\Bigg|_0^{S_{max}} - \ \int_0^{S_\text{max}} \phi_i(S)\sigma^2S\frac{dV^n(S)}{dS}dS - \ \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2}\sigma^2S^2 \ \frac{dV^n(S)}{dS}dS \\ &amp;= -\int_0^{S_\text{max}} \phi_i(S)\sigma^2S\frac{dV^n(S)}{dS}dS - \ \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2}\sigma^2S^2 \ \frac{dV^n(S)}{dS}dS \\ &amp;= -\int_0^{S_\text{max}} \phi_i(S)\sigma^2S \sum_j V_j^n \frac{d\phi_j(S)}{dS}dS \ -\int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}\frac{1}{2} \ \sigma^2S^2 \sum_k V_k^n \frac{d\phi_k(S)}{dS}dS \\ &amp;= -\sum_j \sigma^2 \int_0^{S_\text{max}} \phi_i(S)S \frac{d\phi_j(S)}{dS}dS V_j^n\ - \sum_k \frac{1}{2}\sigma^2 \int_0^{S_\text{max}} \frac{d\phi_i(S)}{dS}S^2\ \frac{d\phi_k}{dS}dS V_k^n \\ &amp;= -\sum_j \sigma^2 \left(\phi_i(S)S, \frac{d\phi_j(S)}{dS}\right) V_j^n \ - \sum_k \frac{1}{2}\sigma^2 \left(\frac{d\phi_i(S)}{dS}S^2,\ \frac{d\phi_k(S)}{dS}\right) V_k^n \\ &amp;= -\sigma^2\textbf{B}V^n - \frac{1}{2}\sigma^2\textbf{D}V^n, \quad\quad \ \textbf{B}_{i,j} = \left(\phi_i(S)S, \frac{d\phi_j(S)}{dS}\right),\ \textbf{D}_{i,j} = \left(\frac{d\phi_i(S)}{dS}S^2,\frac{d\phi_j(S)}{dS}\right) \end{align*}
</p>
<p> \(V^n\)  \(V^{n-1}\) 2</p>
<p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[\frac{\sigma^2S^2}{2} \left[(1-\theta)\ \frac{d^2V^{n-1}(S)}{dS^2} + \ \theta \frac{d^2V^{n}(S)}{dS^2}\right]\right]dS \\ &amp;= k_n\left[-(1-\theta)\sigma^2\textbf{B}V^{n-1}\ -(1-\theta)\frac{1}{2}\sigma^2\textbf{D}V^{n-1} \ -\theta\sigma^2\textbf{B}V^{n} -\theta\frac{1}{2}\sigma^2\textbf{D}V^{n}\right] \end{align*}
</p>
<p> \(\textbf{B}\)  \(\theta=0\) &ndash; \(\textbf{D}\)  \(\theta=1/2\) &ndash;Crank-Nicolson</p>
<p></p>
<p class="formulaDsp">
\begin{align*} k_n\left[-\frac{1}{4}\sigma^2\textbf{D}V^{n-1} \ -\frac{1}{4}\sigma^2\textbf{D}V^n \ - \sigma^2\textbf{B}V^{n-1}\right] \end{align*}
</p>
<p>3</p>
<p class="formulaDsp">
\begin{align*} &amp;\int_{0}^{S_\text{max}} \phi_i(S)rS\frac{dV^n}{dS}dS \\ &amp;= \phi_i(S)rSV^n\Bigg|_0^{S_\text{max}} - \int_0^{S_\text{max}} \left[r\phi_i(S) \ + r\frac{d\phi_i(S)}{dS}S \right]V^ndS \\ &amp;= -\int_0^{S_\text{max}} r\phi_i(S)V^ndS - \ \int_0^{S_\text{max}} r\frac{d\phi_i(S)}{dS}SV^ndS \\ &amp;= -\int_0^{S_\text{max}} r\phi_i(S) \sum_j V_j^n\phi_j(S)dS \ -\int_0^{S_\text{max}} rS\frac{d\phi_i(S)}{dS} \sum_k V_k\phi_k(S)dS \\ &amp;= -\sum_j r\left(\phi_i(S), \phi_j(S)\right) V_j^n -\ \sum_k r\left(S\frac{d\phi_i(S)}{dS}, \phi_k(S)\right)V_k^n \\ &amp;= -r\textbf{M}V^n -r\textbf{A}V^n, \quad\quad\ \textbf{M}_{i,j} = \left(\phi_i(S), \phi_j(S)\right),\ \textbf{A}_{i,j} = \left(S\frac{d\phi_i(S)}{dS}, \phi_j(S)\right) \end{align*}
</p>
<p> \(V^n\)  \(V^{n-1}\) 3</p>
<p class="formulaDsp">
\begin{align*} &amp;k_n\int_0^{S_\text{max}}\phi_i(S)\left[rS\left[(1-\theta) \frac{dV^{n-1}(S)}{dS} +\ \theta\frac{dV^{n}(S)}{dS}\right]\right]dS \\ &amp;= k_n\left[-(1-\theta)r\textbf{M}V^{n-1} -(1-\theta)r\textbf{A}V^{n-1}\ -\theta r\textbf{M}V^n -\theta r\textbf{A}V^n\right] \end{align*}
</p>
<p> \(\theta=0\)  \(\textbf{A}\)  \(\theta=\frac{1}{2}\)  \(\textbf{M}\) 3</p>
<p class="formulaDsp">
\begin{align*} k_n\left[-\frac{1}{2}r\textbf{M}V^{n-1} - \frac{1}{2}r\textbf{M}V^n \ -r\textbf{A}V^{n-1}\right] \end{align*}
</p>
<p>-</p>
<p class="formulaDsp">
\begin{align*} 0&amp;= \\ &amp;-\textbf{M}V^n+\textbf{M}V^{n-1} \\ &amp; +k_n\left[-\frac{1}{4}\sigma^2\textbf{D}V^{n-1} \ -\frac{1}{4}\sigma^2\textbf{D}V^n \ - \sigma^2\textbf{B}V^n \ -\frac{1}{2}r\textbf{M}V^{n-1} - \frac{1}{2}r\textbf{M}V^n \ -r\textbf{A}V^n \ -r\frac{1}{2}\textbf{M}V^{n-1} - \frac{1}{2} r\textbf{M}V^n\right] \\ &amp;= -\textbf{M}V^n + \textbf{M}V^{n-1} +\ k_n\left[- \frac{1}{4}\sigma^2\textbf{D}V^{n-1} -\ \frac{1}{4}\sigma^2\textbf{D}V^n - r\textbf{M}V^{n-1} -\ r\textbf{M}V^n - \sigma^2\textbf{B}V^{n-1} - r\textbf{A}V^{n-1}\right] \end{align*}
</p>
<p></p>
<p class="formulaDsp">
\begin{equation} 0 = \textbf{M}V^n - \textbf{M}V^{n-1} +\ k_n\left[ \frac{1}{4}\sigma^2\textbf{D}V^{n-1} +\ \frac{1}{4}\sigma^2\textbf{D}V^n + r\textbf{M}V^{n-1} + r\textbf{M}V^n +\ \sigma^2\textbf{B}V^{n-1} + r\textbf{A}V^{n-1}\right]\tag{*} \end{equation}
</p>
<p></p>
<p class="formulaDsp">
\begin{align*} \left[\textbf{M}+\frac{1}{4}k_n\sigma^2\textbf{D}+k_nr\textbf{M}\right]V^n\ =\ \left[-\frac{1}{4}k_n\sigma^2\textbf{D}-\ k_nr\textbf{M}+k_n\sigma^2\textbf{B}-\ k_nr\textbf{A}+\textbf{M}\right]V^{n-1} \end{align*}
</p>
<p><a class="anchor" id="TestCase"></a></p><h3>Test Case</h3>
<p>MMS7</p>
<p class="formulaDsp">
\begin{align*} V(S,\tau) = -\tau^2 - S^2 + 6\tag{**} \end{align*}
</p>
<p>PDE</p>
<p class="formulaDsp">
\begin{align*} &amp;-\frac{\partial V}{\partial \tau} +\ \frac{\sigma^2S^2}{2}\frac{\partial^2 V}{\partial S^2} +\ rS\frac{\partial V}{\partial S} - rV = f(S,\tau) \\ &amp;V(0,\tau) = -\tau^2 + 6 \\ &amp;V(S_\text{max}, \tau) = -S_\text{max}^2 - \tau^2 + 6 \\ &amp;V(S, 0) = -S^2 + 6 \end{align*}
</p>
<p> \(f(S,\tau) = 2\tau - \sigma^2S^2 - 2rS^2 - r(-\tau^2 - S^2 + 6)\)  \(S=0\)  " " \(\tau\) - "" &ndash; </p>
<p>**</p>
<p></p>
<p class="formulaDsp">
\begin{align*} F^n_i = \left(\phi_i(S), f^n(S)\right), &amp;&amp; \text{where } f^n(S) =\ f(S,\tau_n) \end{align*}
</p>
<p></p>
<p class="formulaDsp">
\begin{align*} \left[\textbf{M}+\frac{1}{4}k_n\sigma^2\textbf{D}+k_nr\textbf{M}\right]V^n\ =\ \left[-\frac{1}{4}k_n\sigma^2\textbf{D}-\ k_nr\textbf{M}+k_n\sigma^2\textbf{B}-\ k_nr\textbf{A}+\textbf{M}\right]V^{n-1} -\ k_n\left[\frac{1}{2}F^{n-1}+\frac{1}{2}F^n\right] \end{align*}
</p>
<p></p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The program starts with the usual include files, all of which you should have seen before by now:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="convergence__table_8h.html">deal.II/base/convergence_table.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__accessor_8h.html">deal.II/dofs/dof_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__accessor_8h.html">deal.II/grid/tria_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__iterator_8h.html">deal.II/grid/tria_iterator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="data__out__stack_8h.html">deal.II/numerics/data_out_stack.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div></div><!-- fragment --><p>Then the usual placing of all content of this program into a namespace and the importation of the deal.II namespace into the one we will work in. We also define an identifier to allow for the MMS code to be run when <code>MMS</code> is defined. Otherwise, the program solves the original problem:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>BlackScholesSolver</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#define MMS</span></div></div><!-- fragment --><p><a class="anchor" id="SolutionClass"></a> </p><h3>Solution Class</h3>
<p>This section creates a class for the known solution when testing using the MMS. Here we are using \(v(\tau,S) = -\tau^2 -S^2 + 6\) for the solution. We need to include the solution equation and the gradient for the H1 seminorm calculation.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>Solution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time);</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a></div><div class="line">  <a class="code" href="classFunction.html#a4b0aadc89a827b39c20f12889aa88625">gradient</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">Solution&lt;dim&gt;::Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time)</div><div class="line">  : maturity_time(maturity_time)</div><div class="line">{</div><div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">double</span> Solution&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">         Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> Solution&lt;dim&gt;::gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keywordflow">return</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2 * p(component));</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="EquationData"></a> </p><h3>Equation Data</h3>
<p>In the following classes and functions, we implement the right hand side and boundary values that define this problem and for which we need function objects. The right hand side is chosen as discussed at the end of the introduction.</p>
<p>First, we handle the initial condition.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>InitialConditions : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  InitialConditions&lt;dim&gt;::InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price)</div><div class="line">    : strike_price(strike_price)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> InitialConditions&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(p(component) - strike_price, 0.);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">  }</span></div></div><!-- fragment --><p>Next, we handle the left boundary condition.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>LeftBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> LeftBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;,</div><div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="classFunctionTime.html#ae7d37ddb04314b38cf67c6cba22923f6">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> 0.;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">  }</span></div></div><!-- fragment --><p>Then, we handle the right boundary condition.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightBoundaryValues&lt;dim&gt;::RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price,</div><div class="line">                                                <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : strike_price(strike_price)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> (p(component) - strike_price) *</div><div class="line">           <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>((-interest_rate) * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()));</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">  }</span></div></div><!-- fragment --><p>Finally, we handle the right hand side.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightHandSide&lt;dim&gt;::RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : asset_volatility(asset_volatility)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> 2 * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(asset_volatility * p(component)) -</div><div class="line">           2 * interest_rate * Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           interest_rate *</div><div class="line">             (-Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">              Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    (void)p;</div><div class="line">    (void)component;</div><div class="line">    <span class="keywordflow">return</span> 0.0;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">  }</span></div></div><!-- fragment --><p><a class="anchor" id="ThecodeBlackScholescodeClass"></a> </p><h3>The <code>BlackScholes</code> Class</h3>
<p>The next piece is the declaration of the main class of this program. This is very similar to the <a class="el" href="step_26.html">step-26</a> tutorial, with some modifications. New matrices had to be added to calculate the A and B matrices, as well as the \(V_{diff}\) vector mentioned in the introduction. We also define the parameters used in the problem.</p>
<ul>
<li><code>maximum_stock_price</code>: The imposed upper bound on the spatial domain. This is the maximum allowed stock price.</li>
<li><code>maturity_time</code>: The upper bound on the time domain. This is when the option expires.<br />
</li>
<li><code>asset_volatility</code>: The volatility of the stock price.<br />
</li>
<li><code>interest_rate</code>: The risk free interest rate.<br />
</li>
<li><code>strike_price</code>: The agreed upon price that the buyer will have the option of purchasing the stocks at the expiration time.</li>
</ul>
<p>Some slight differences between this program and <a class="el" href="step_26.html">step-26</a> are the creation of the <code>a_matrix</code> and the <code>b_matrix</code>, which is described in the introduction. We then also need to store the current time, the size of the time step, and the number of the current time step. Next, we will store the output into a <code><a class="el" href="classDataOutStack.html">DataOutStack</a></code> variable because we will be layering the solution at each time on top of one another to create the solution manifold. Then, we have a variable that stores the current cycle and number of cycles that we will run when calculating the solution. The cycle is one full solution calculation given a mesh. We refine the mesh once in between each cycle to exhibit the convergence properties of our program. Finally, we store the convergence data into a convergence table.</p>
<p>As far as member functions are concerned, we have a function that calculates the convergence information for each cycle, called <code>process_solution</code>. This is just like what is done in <a class="el" href="step_7.html">step-7</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>BlackScholes</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  BlackScholes();</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> setup_system();</div><div class="line">  <span class="keywordtype">void</span> solve_time_step();</div><div class="line">  <span class="keywordtype">void</span> refine_grid();</div><div class="line">  <span class="keywordtype">void</span> process_solution();</div><div class="line">  <span class="keywordtype">void</span> add_results_for_output();</div><div class="line">  <span class="keywordtype">void</span> write_convergence_table();</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maximum_stock_price;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line"></div><div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div><div class="line"></div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div><div class="line">  SparseMatrix&lt;double&gt; <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div><div class="line">  SparseMatrix&lt;double&gt; laplace_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; a_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; b_matrix;</div><div class="line">  SparseMatrix&lt;double&gt; system_matrix;</div><div class="line"></div><div class="line">  Vector&lt;double&gt; solution;</div><div class="line">  Vector&lt;double&gt; system_rhs;</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> time;</div><div class="line">  <span class="keywordtype">double</span> time_step;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       theta;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_time_steps;</div><div class="line"></div><div class="line">  <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;</a>        data_out_stack;</div><div class="line">  std::vector&lt;std::string&gt; solution_names;</div><div class="line"></div><div class="line">  <a class="code" href="classConvergenceTable.html">ConvergenceTable</a> convergence_table;</div><div class="line">};</div></div><!-- fragment --><p><a class="anchor" id="ThecodeBlackScholescodeImplementation"></a> </p><h3>The <code>BlackScholes</code> Implementation</h3>
<p>Now, we get to the implementation of the main class. We will set the values for the various parameters used in the problem. These were chosen because they are fairly normal values for these parameters. Although the stock price has no upper bound in reality (it is in fact infinite), we impose an upper bound that is twice the strike price. This is a somewhat arbitrary choice to be twice the strike price, but it is large enough to see the interesting parts of the solution.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">BlackScholes&lt;dim&gt;::BlackScholes()</div><div class="line">  : maximum_stock_price(1.)</div><div class="line">  , maturity_time(1.)</div><div class="line">  , asset_volatility(.2)</div><div class="line">  , interest_rate(0.05)</div><div class="line">  , strike_price(0.5)</div><div class="line">  , fe(1)</div><div class="line">  , dof_handler(triangulation)</div><div class="line">  , time(0.0)</div><div class="line">  , theta(0.5)</div><div class="line">  , n_cycles(4)</div><div class="line">  , n_time_steps(5000)</div><div class="line">{</div><div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholessetup_systemcode"></a> </p><h4><code>BlackScholes::setup_system</code></h4>
<p>The next function sets up the <a class="el" href="classDoFHandler.html">DoFHandler</a> object, computes the constraints, and sets the linear algebra objects to their correct sizes. We also compute the mass matrix here by calling a function from the library. We will compute the other 3 matrices next, because these need to be computed 'by hand'.</p>
<p>Note, that the time step is initialized here because the maturity time was needed to compute the time step.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::setup_system()</div><div class="line">{</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">  time_step = maturity_time / n_time_steps;</div><div class="line"></div><div class="line">  constraints.clear();</div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">  constraints.close();</div><div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                  dsp,</div><div class="line">                                  constraints,</div><div class="line">                                  <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">true</span>);</div><div class="line">  sparsity_pattern.<a class="code" href="classBlockSparsityPattern.html#a923288e4b4093f86b680e7045e9b4984">copy_from</a>(dsp);</div><div class="line"></div><div class="line">  mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a614ca8e186fe3c61e03a52369437157e">reinit</a>(sparsity_pattern);</div><div class="line">  laplace_matrix.reinit(sparsity_pattern);</div><div class="line">  a_matrix.reinit(sparsity_pattern);</div><div class="line">  b_matrix.reinit(sparsity_pattern);</div><div class="line">  system_matrix.reinit(sparsity_pattern);</div><div class="line"></div><div class="line">  <a class="code" href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a>(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    mass_matrix);</div></div><!-- fragment --><p>Below is the code to create the Laplace matrix with non-constant coefficients. This corresponds to the matrix D in the introduction. This non-constant coefficient is represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.dofs_per_cell;</div><div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line"><a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>        quadrature_formula(fe.degree + 1);</div><div class="line"><a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>      fe_values(fe,</div><div class="line">                        quadrature_formula,</div><div class="line">                        <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line">std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">  {</div><div class="line">    cell_matrix = 0.;</div><div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> current_coefficient =</div><div class="line">          fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index).<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>();</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                (current_coefficient *              <span class="comment">// (x_q)^2</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) * <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) * <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                 fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));           <span class="comment">// dx</span></div><div class="line">          }</div><div class="line">      }</div><div class="line">    cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          laplace_matrix.add(local_dof_indices[i],</div><div class="line">                             local_dof_indices[j],</div><div class="line">                             cell_matrix(i, j));</div><div class="line">      }</div><div class="line">  }</div></div><!-- fragment --><p>Now we will create the A matrix. Below is the code to create the matrix A as discussed in the introduction. The non constant coefficient is again represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">  {</div><div class="line">    cell_matrix = 0.;</div><div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">          fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                  (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) *  <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(j, q_index) * <span class="comment">// phi_j(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">      }</div><div class="line">    cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">      {</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          a_matrix.add(local_dof_indices[i],</div><div class="line">                       local_dof_indices[j],</div><div class="line">                       cell_matrix(i, j));</div><div class="line">      }</div><div class="line">  }</div></div><!-- fragment --><p>Finally we will create the matrix B. Below is the code to create the matrix B as discussed in the introduction. The non constant coefficient is again represented in the <code>current_coefficient</code> variable.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">    {</div><div class="line">      cell_matrix = 0.;</div><div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">        {</div><div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">            fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                  (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_index) * <span class="comment">// phi_i(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) *  <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                   fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">            }</div><div class="line">        }</div><div class="line">      cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">        {</div><div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">            b_matrix.add(local_dof_indices[i],</div><div class="line">                         local_dof_indices[j],</div><div class="line">                         cell_matrix(i, j));</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">  solution.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholessolve_time_stepcode"></a> </p><h4><code>BlackScholes::solve_time_step</code></h4>
<p>The next function is the one that solves the actual linear system for a single time step. The only interesting thing here is that the matrices we have built are symmetric positive definite, so we can use the conjugate gradient method.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::solve_time_step()</div><div class="line">{</div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>                          solver_control(1000, 1e-12);</div><div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt;               cg(solver_control);</div><div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div><div class="line">  preconditioner.<a class="code" href="classPreconditionSSOR.html#a7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.0);</div><div class="line">  cg.solve(system_matrix, solution, system_rhs, preconditioner);</div><div class="line">  constraints.distribute(solution);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesadd_results_for_outputcode"></a> </p><h4><code>BlackScholes::add_results_for_output</code></h4>
<p>This is simply the function to stitch the solution pieces together. For this, we create a new layer at each time, and then add the solution vector for that timestep. The function then stitches this together with the old solutions using 'build_patches'.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::add_results_for_output()</div><div class="line">{</div><div class="line">  data_out_stack.new_parameter_value(time, time_step);</div><div class="line">  data_out_stack.attach_dof_handler(dof_handler);</div><div class="line">  data_out_stack.add_data_vector(solution, solution_names);</div><div class="line">  data_out_stack.build_patches(2);</div><div class="line">  data_out_stack.finish_parameter_value();</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesrefine_gridcode"></a> </p><h4><code>BlackScholes::refine_grid</code></h4>
<p>It is somewhat unnecessary to have a function for the global refinement that we do. The reason for the function is to allow for the possibility of an adaptive refinement later.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::refine_grid()</div><div class="line">{</div><div class="line">  triangulation.refine_global(1);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesprocess_solutioncode"></a> </p><h4><code>BlackScholes::process_solution</code></h4>
<p>This is where we calculate the convergence and error data to evaluate the effectiveness of the program. Here, we calculate the \(L^2\), \(H^1\) and \(L^{\infty}\) norms.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::process_solution()</div><div class="line">{</div><div class="line">  Solution&lt;dim&gt; sol(maturity_time);</div><div class="line">  sol.set_time(time);</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> difference_per_cell(triangulation.n_active_cells());</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> L2_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> H1_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>  q_trapezoid;</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> q_iterated(q_trapezoid, fe.degree * 2 + 1);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                    solution,</div><div class="line">                                    sol,</div><div class="line">                                    difference_per_cell,</div><div class="line">                                    q_iterated,</div><div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> Linfty_error =</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_active_cells = triangulation.n_active_cells();</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs         = dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>();</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;cells&quot;</span>, n_active_cells);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;dofs&quot;</span>, n_dofs);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;L2&quot;</span>, L2_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;H1&quot;</span>, H1_error);</div><div class="line">  convergence_table.add_value(<span class="stringliteral">&quot;Linfty&quot;</span>, Linfty_error);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholeswrite_convergence_tablecode"></a> </p><h4><code>BlackScholes::write_convergence_table</code> </h4>
<p>This next part is building the convergence and error tables. By this, we need to set the settings for how to output the data that was calculated during <code>BlackScholes::process_solution</code>. First, we will create the headings and set up the cells properly. During this, we will also prescribe the precision of our results. Then we will write the calculated errors based on the \(L^2\), \(H^1\), and \(L^{\infty}\) norms to the console and to the error LaTeX file.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::write_convergence_table()</div><div class="line">{</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;L2&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;H1&quot;</span>, 3);</div><div class="line">  convergence_table.set_precision(<span class="stringliteral">&quot;Linfty&quot;</span>, 3);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;L2&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;H1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_scientific(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;\\# cells&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;\\# dofs&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;L2&quot;</span>, <span class="stringliteral">&quot;@fL^2@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;H1&quot;</span>, <span class="stringliteral">&quot;@fH^1@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_caption(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="stringliteral">&quot;@fL^\\infty@f-error&quot;</span>);</div><div class="line">  convergence_table.set_tex_format(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">  convergence_table.set_tex_format(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">  std::cout &lt;&lt; std::endl;</div><div class="line">  convergence_table.write_text(std::cout);</div><div class="line">  std::string error_filename = <span class="stringliteral">&quot;error&quot;</span>;</div><div class="line">  error_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">  error_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">  std::ofstream error_table_file(error_filename);</div><div class="line">  convergence_table.write_tex(error_table_file);</div></div><!-- fragment --><p>Next, we will make the convergence table. We will again write this to the console and to the convergence LaTeX file.</p>
<div class="fragment"><div class="line">  convergence_table.add_column_to_supercolumn(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">  std::vector&lt;std::string&gt; new_order;</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;H1&quot;</span>);</div><div class="line">  new_order.emplace_back(<span class="stringliteral">&quot;L2&quot;</span>);</div><div class="line">  convergence_table.set_column_order(new_order);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">  convergence_table.evaluate_convergence_rates(</div><div class="line">    <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">  std::cout &lt;&lt; std::endl;</div><div class="line">  convergence_table.write_text(std::cout);</div><div class="line">  std::string conv_filename = <span class="stringliteral">&quot;convergence&quot;</span>;</div><div class="line">  conv_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">  <span class="keywordflow">switch</span> (fe.degree)</div><div class="line">    {</div><div class="line">      <span class="keywordflow">case</span> 1:</div><div class="line">        conv_filename += <span class="stringliteral">&quot;-q1&quot;</span>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">case</span> 2:</div><div class="line">        conv_filename += <span class="stringliteral">&quot;-q2&quot;</span>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">    }</div><div class="line">  conv_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">  std::ofstream table_file(conv_filename);</div><div class="line">  convergence_table.write_tex(table_file);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="codeBlackScholesruncode"></a> </p><h4><code>BlackScholes::run</code></h4>
<p>Now we get to the main driver of the program. This is where we do all the work of looping through the time steps and calculating the solution vector each time. Here at the top, we set the initial refinement value and then create a mesh. Then we refine this mesh once. Next, we set up the data_out_stack object to store our solution. Finally, we start a for loop to loop through the cycles. This lets us recalculate a solution for each successive mesh refinement. At the beginning of each iteration, we need to reset the time and time step number. We introduce an if statement to accomplish this because we don't want to do this on the first iteration.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">BlackScholes&lt;dim&gt;::run</a>()</div><div class="line">{</div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, 0.0, maximum_stock_price, <span class="keyword">true</span>);</div><div class="line">  triangulation.refine_global(0);</div><div class="line"></div><div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;u&quot;</span>);</div><div class="line">  data_out_stack.declare_data_vector(solution_names,</div><div class="line">                                     <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;::dof_vector</a>);</div><div class="line"></div><div class="line">  Vector&lt;double&gt; vmult_result;</div><div class="line">  Vector&lt;double&gt; forcing_terms;</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; cycle++)</div><div class="line">    {</div><div class="line">      <span class="keywordflow">if</span> (cycle != 0)</div><div class="line">        {</div><div class="line">          refine_grid();</div><div class="line">          time = 0.0;</div><div class="line">        }</div><div class="line"></div><div class="line">      setup_system();</div><div class="line"></div><div class="line">      std::cout &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;===========================================&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span></div><div class="line">                &lt;&lt; triangulation.n_active_cells() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler,</div><div class="line">                               InitialConditions&lt;dim&gt;(strike_price),</div><div class="line">                               solution);</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">        {</div><div class="line">          add_results_for_output();</div><div class="line">        }</div></div><!-- fragment --><p>Next, we run the main loop which runs until we exceed the maturity time. We first compute the right hand side of the equation, which is described in the introduction. Recall that it contains the term \(\left[-\frac{1}{4}k_n\sigma^2\mathbf{D}-k_nr\mathbf{M}+k_n\sigma^2 \mathbf{B}-k_nr\mathbf{A}+\mathbf{M}\right]V^{n-1}\). We put these terms into the variable system_rhs, with the help of a temporary vector:</p>
<div class="fragment"><div class="line">vmult_result.<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">forcing_terms.<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number = 0; timestep_number &lt; n_time_steps;</div><div class="line">     ++timestep_number)</div><div class="line">  {</div><div class="line">    time += time_step;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (timestep_number % 1000 == 0)</div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Time step &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; at t=&quot;</span> &lt;&lt; time</div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(system_rhs, solution);</div><div class="line"></div><div class="line">    laplace_matrix.vmult(vmult_result, solution);</div><div class="line">    system_rhs.add(</div><div class="line">      (-1) * (1 - theta) * time_step *</div><div class="line">        Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">      vmult_result);</div><div class="line">    mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(vmult_result, solution);</div><div class="line"></div><div class="line">    system_rhs.add((-1) * (1 - theta) * time_step * interest_rate * 2,</div><div class="line">                   vmult_result);</div><div class="line"></div><div class="line">    a_matrix.vmult(vmult_result, solution);</div><div class="line">    system_rhs.add((-1) * time_step * interest_rate, vmult_result);</div><div class="line"></div><div class="line">    b_matrix.vmult(vmult_result, solution);</div><div class="line">    system_rhs.add(</div><div class="line">      (-1) * Utilities::fixed_power&lt;2, double&gt;(asset_volatility) *</div><div class="line">        time_step * 1,</div><div class="line">      vmult_result);</div></div><!-- fragment --><p>The second piece is to compute the contributions of the source terms. This corresponds to the term \(-k_n\left[\frac{1}{2}F^{n-1} +\frac{1}{2}F^n\right]\). The following code calls <a class="el" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a> to compute the vectors \(F\), where we set the time of the right hand side (source) function before we evaluate it. The result of this all ends up in the forcing_terms variable:</p>
<div class="fragment"><div class="line">RightHandSide&lt;dim&gt; rhs_function(asset_volatility, interest_rate);</div><div class="line">rhs_function.set_time(time);</div><div class="line"><a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    rhs_function,</div><div class="line">                                    forcing_terms);</div><div class="line">forcing_terms *= time_step * theta;</div><div class="line">system_rhs -= forcing_terms;</div><div class="line"></div><div class="line">rhs_function.set_time(time - time_step);</div><div class="line"><a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                    rhs_function,</div><div class="line">                                    forcing_terms);</div><div class="line">forcing_terms *= time_step * (1 - theta);</div><div class="line">system_rhs -= forcing_terms;</div></div><!-- fragment --><p>Next, we add the forcing terms to the ones that come from the time stepping, and also build the matrix \(\left[\mathbf{M}+ \frac{1}{4}k_n\sigma^2\mathbf{D}+k_nr\mathbf{M}\right]\) that we have to invert in each time step. The final piece of these operations is to eliminate hanging node constrained degrees of freedom from the linear system:</p>
<div class="fragment"><div class="line">system_matrix.copy_from(mass_matrix);</div><div class="line">system_matrix.add(</div><div class="line">  (theta)*time_step *</div><div class="line">    Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">  laplace_matrix);</div><div class="line">system_matrix.add((time_step)*interest_rate * theta * (1 + 1),</div><div class="line">                  mass_matrix);</div><div class="line"></div><div class="line">constraints.condense(system_matrix, system_rhs);</div></div><!-- fragment --><p>There is one more operation we need to do before we can solve it: boundary values. To this end, we create a boundary value object, set the proper time to the one of the current time step, and evaluate it as we have done many times before. The result is used to also set the correct boundary values in the linear system:</p>
<div class="fragment"><div class="line">{</div><div class="line">  RightBoundaryValues&lt;dim&gt; right_boundary_function(strike_price,</div><div class="line">                                                   interest_rate);</div><div class="line">  LeftBoundaryValues&lt;dim&gt;  left_boundary_function;</div><div class="line">  right_boundary_function.set_time(time);</div><div class="line">  left_boundary_function.set_time(time);</div><div class="line">  std::map&lt;types::global_dof_index, double&gt; boundary_values;</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           0,</div><div class="line">                                           left_boundary_function,</div><div class="line">                                           boundary_values);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           1,</div><div class="line">                                           right_boundary_function,</div><div class="line">                                           boundary_values);</div><div class="line">  <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div><div class="line">                                     system_matrix,</div><div class="line">                                     solution,</div><div class="line">                                     system_rhs);</div><div class="line">}</div></div><!-- fragment --><p>With this out of the way, all we have to do is solve the system, generate graphical data on the last cycle, and create the convergence table data.</p>
<div class="fragment"><div class="line">            solve_time_step();</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">              {</div><div class="line">                add_results_for_output();</div><div class="line">              }</div><div class="line">          }</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">        process_solution();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::string filename = <span class="stringliteral">&quot;solution.vtk&quot;</span>;</div><div class="line">    std::ofstream     output(filename);</div><div class="line">    data_out_stack.write_vtk(output);</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    write_convergence_table();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line">} <span class="comment">// namespace BlackScholesSolver</span></div></div><!-- fragment --><p><a class="anchor" id="ThecodemaincodeFunction"></a> </p><h3>The <code>main</code> <a class="el" href="classFunction.html">Function</a></h3>
<p>Having made it this far, there is, again, nothing much to discuss for the main function of this program: it looks like all such functions since <a class="el" href="step_6.html">step-6</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span>BlackScholesSolver;</div><div class="line"></div><div class="line">      BlackScholes&lt;1&gt; black_scholes_solver;</div><div class="line">      black_scholes_solver.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> examples/step-78/doc/results.dox</p>
<p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p></p>
<div class="fragment"><div class="line">===========================================</div><div class="line">Number of active cells: 1</div><div class="line">Number of degrees of freedom: 2</div><div class="line"></div><div class="line"></div><div class="line">Time step 0 at t=0.0002</div><div class="line">[...]</div><div class="line"></div><div class="line"></div><div class="line">Cycle 7:</div><div class="line">Number of active cells: 128</div><div class="line">Number of degrees of freedom: 129</div><div class="line"></div><div class="line"></div><div class="line">Time step 0 at t=0.0002</div><div class="line">Time step 1000 at t=0.2002</div><div class="line">Time step 2000 at t=0.4002</div><div class="line">Time step 3000 at t=0.6002</div><div class="line">Time step 4000 at t=0.8002</div><div class="line"></div><div class="line"></div><div class="line">cells dofs    <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">L2</a>        H1      Linfty</div><div class="line">    1    2 1.667e-01 5.774e-01 2.222e-01</div><div class="line">    2    3 3.906e-02 2.889e-01 5.380e-02</div><div class="line">    4    5 9.679e-03 1.444e-01 1.357e-02</div><div class="line">    8    9 2.405e-03 7.218e-02 3.419e-03</div><div class="line">   16   17 5.967e-04 3.609e-02 8.597e-04</div><div class="line">   32   33 1.457e-04 1.804e-02 2.155e-04</div><div class="line">   64   65 3.307e-05 9.022e-03 5.388e-05</div><div class="line">  128  129 5.016e-06 4.511e-03 1.342e-05</div><div class="line"></div><div class="line"></div><div class="line">n cells         H1                  <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a0a7d7409a5f53485a841a33fda68d916">L2</a></div><div class="line">      1 5.774e-01    -    - 1.667e-01    -    -</div><div class="line">      2 2.889e-01 2.00 1.00 3.906e-02 4.27 2.09</div><div class="line">      4 1.444e-01 2.00 1.00 9.679e-03 4.04 2.01</div><div class="line">      8 7.218e-02 2.00 1.00 2.405e-03 4.02 2.01</div><div class="line">     16 3.609e-02 2.00 1.00 5.967e-04 4.03 2.01</div><div class="line">     32 1.804e-02 2.00 1.00 1.457e-04 4.10 2.03</div><div class="line">     64 9.022e-03 2.00 1.00 3.307e-05 4.41 2.14</div><div class="line">    128 4.511e-03 2.00 1.00 5.016e-06 6.59 2.72</div></div><!-- fragment --><p>LaTeX \(H^1\) -norm \(\mathcal{O}(h)\)  \(L^2\) -norm \(\mathcal{O}(h^2)\) </p>
<p></p>
<div style="text-align:center;"> <div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-78.mms-solution.png" alt="MMS"/>
</div>
 </div><p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2021 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Tyler Anderson, Colorado State University, 2021</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="convergence__table_8h.html">deal.II/base/convergence_table.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__accessor_8h.html">deal.II/dofs/dof_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__accessor_8h.html">deal.II/grid/tria_accessor.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tria__iterator_8h.html">deal.II/grid/tria_iterator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="data__out__stack_8h.html">deal.II/numerics/data_out_stack.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>BlackScholesSolver</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#define MMS</span></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>Solution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a></div><div class="line">    gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  Solution&lt;dim&gt;::Solution(<span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time)</div><div class="line">    : maturity_time(maturity_time)</div><div class="line">  {</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> Solution&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> Solution&lt;dim&gt;::gradient(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2 * p(component));</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>InitialConditions : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  InitialConditions&lt;dim&gt;::InitialConditions(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price)</div><div class="line">    : strike_price(strike_price)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> InitialConditions&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(p(component) - strike_price, 0.);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>LeftBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> LeftBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;,</div><div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> 0.;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightBoundaryValues&lt;dim&gt;::RightBoundaryValues(<span class="keyword">const</span> <span class="keywordtype">double</span> strike_price,</div><div class="line">                                                <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : strike_price(strike_price)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> -Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">return</span> (p(component) - strike_price) *</div><div class="line">           <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>((-interest_rate) * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()));</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility, <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate);</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  RightHandSide&lt;dim&gt;::RightHandSide(<span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility,</div><div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate)</div><div class="line">    : asset_volatility(asset_volatility)</div><div class="line">    , interest_rate(interest_rate)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    <span class="keywordflow">return</span> 2 * (this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) -</div><div class="line">           Utilities::fixed_power&lt;2, double&gt;(asset_volatility * p(component)) -</div><div class="line">           2 * interest_rate * Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">           interest_rate *</div><div class="line">             (-Utilities::fixed_power&lt;2, double&gt;(p(component)) -</div><div class="line">              Utilities::fixed_power&lt;2, double&gt;(this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>()) + 6);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    (void)p;</div><div class="line">    (void)component;</div><div class="line">    <span class="keywordflow">return</span> 0.0;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>BlackScholes</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BlackScholes();</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> setup_system();</div><div class="line">    <span class="keywordtype">void</span> solve_time_step();</div><div class="line">    <span class="keywordtype">void</span> refine_grid();</div><div class="line">    <span class="keywordtype">void</span> process_solution();</div><div class="line">    <span class="keywordtype">void</span> add_results_for_output();</div><div class="line">    <span class="keywordtype">void</span> write_convergence_table();</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximum_stock_price;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maturity_time;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> asset_volatility;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> interest_rate;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> strike_price;</div><div class="line"></div><div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div><div class="line">    SparseMatrix&lt;double&gt; <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div><div class="line">    SparseMatrix&lt;double&gt; laplace_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; a_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; b_matrix;</div><div class="line">    SparseMatrix&lt;double&gt; system_matrix;</div><div class="line"></div><div class="line">    Vector&lt;double&gt; solution;</div><div class="line">    Vector&lt;double&gt; system_rhs;</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> time;</div><div class="line">    <span class="keywordtype">double</span> time_step;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       theta;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_time_steps;</div><div class="line"></div><div class="line">    <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;</a>        data_out_stack;</div><div class="line">    std::vector&lt;std::string&gt; solution_names;</div><div class="line"></div><div class="line">    <a class="code" href="classConvergenceTable.html">ConvergenceTable</a> convergence_table;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  BlackScholes&lt;dim&gt;::BlackScholes()</div><div class="line">    : maximum_stock_price(1.)</div><div class="line">    , maturity_time(1.)</div><div class="line">    , asset_volatility(.2)</div><div class="line">    , interest_rate(0.05)</div><div class="line">    , strike_price(0.5)</div><div class="line">    , fe(1)</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , time(0.0)</div><div class="line">    , theta(0.5)</div><div class="line">    , n_cycles(4)</div><div class="line">    , n_time_steps(5000)</div><div class="line">  {</div><div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::setup_system()</div><div class="line">  {</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    time_step = maturity_time / n_time_steps;</div><div class="line"></div><div class="line">    constraints.clear();</div><div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">    constraints.close();</div><div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div><div class="line">                                    dsp,</div><div class="line">                                    constraints,</div><div class="line">                                    <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">true</span>);</div><div class="line">    sparsity_pattern.<a class="code" href="classBlockSparsityPattern.html#a923288e4b4093f86b680e7045e9b4984">copy_from</a>(dsp);</div><div class="line"></div><div class="line">    mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a614ca8e186fe3c61e03a52369437157e">reinit</a>(sparsity_pattern);</div><div class="line">    laplace_matrix.reinit(sparsity_pattern);</div><div class="line">    a_matrix.reinit(sparsity_pattern);</div><div class="line">    b_matrix.reinit(sparsity_pattern);</div><div class="line">    system_matrix.reinit(sparsity_pattern);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a>(dof_handler,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      mass_matrix);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.dofs_per_cell;</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>        quadrature_formula(fe.degree + 1);</div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>      fe_values(fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index).<a class="code" href="classPoint.html#a859ea7f3bf3e64be2e0f5ed1bfcc8550">square</a>();</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                    (current_coefficient *              <span class="comment">// (x_q)^2</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) * <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) * <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));           <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              laplace_matrix.add(local_dof_indices[i],</div><div class="line">                                 local_dof_indices[j],</div><div class="line">                                 cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  {</div><div class="line">                    <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                      (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(i, q_index) *  <span class="comment">// grad phi_i(x_q)</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(j, q_index) * <span class="comment">// phi_j(x_q)</span></div><div class="line">                       fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">                  }</div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              a_matrix.add(local_dof_indices[i],</div><div class="line">                           local_dof_indices[j],</div><div class="line">                           cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      {</div><div class="line">        cell_matrix = 0.;</div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> current_coefficient =</div><div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_index);</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">                  <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                    (current_coefficient *               <span class="comment">// x_q</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q_index) * <span class="comment">// phi_i(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#a46aefdb527125dafb59dcba92a0f256e">shape_grad</a>(j, q_index) *  <span class="comment">// grad phi_j(x_q)</span></div><div class="line">                     fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q_index));            <span class="comment">// dx</span></div><div class="line">              }</div><div class="line">          }</div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j : fe_values.<a class="code" href="classFEValuesBase.html#a93872d888911cda7e2e716168afc1b3f">dof_indices</a>())</div><div class="line">              b_matrix.add(local_dof_indices[i],</div><div class="line">                           local_dof_indices[j],</div><div class="line">                           cell_matrix(i, j));</div><div class="line">          }</div><div class="line">      }</div><div class="line"></div><div class="line">    solution.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">    system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::solve_time_step()</div><div class="line">  {</div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>                          solver_control(1000, 1e-12);</div><div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt;               cg(solver_control);</div><div class="line">    <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div><div class="line">    preconditioner.<a class="code" href="classPreconditionSSOR.html#a7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.0);</div><div class="line">    cg.solve(system_matrix, solution, system_rhs, preconditioner);</div><div class="line">    constraints.distribute(solution);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::add_results_for_output()</div><div class="line">  {</div><div class="line">    data_out_stack.new_parameter_value(time, time_step);</div><div class="line">    data_out_stack.attach_dof_handler(dof_handler);</div><div class="line">    data_out_stack.add_data_vector(solution, solution_names);</div><div class="line">    data_out_stack.build_patches(2);</div><div class="line">    data_out_stack.finish_parameter_value();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::refine_grid()</div><div class="line">  {</div><div class="line">    triangulation.refine_global(1);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::process_solution()</div><div class="line">  {</div><div class="line">    Solution&lt;dim&gt; sol(maturity_time);</div><div class="line">    sol.set_time(time);</div><div class="line">    Vector&lt;float&gt; difference_per_cell(triangulation.n_active_cells());</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> L2_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> H1_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a1048f76e7fb0aea6e654ff1cf036a65f">VectorTools::H1_seminorm</a>);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>  q_trapezoid;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> q_iterated(q_trapezoid, fe.degree * 2 + 1);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      solution,</div><div class="line">                                      sol,</div><div class="line">                                      difference_per_cell,</div><div class="line">                                      q_iterated,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> Linfty_error =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        difference_per_cell,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a0532fa97d3218aed4fa2e7fb0a2017e4">VectorTools::Linfty_norm</a>);</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_active_cells = triangulation.n_active_cells();</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs         = dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>();</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;cells&quot;</span>, n_active_cells);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;dofs&quot;</span>, n_dofs);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;L2&quot;</span>, L2_error);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;H1&quot;</span>, H1_error);</div><div class="line">    convergence_table.add_value(<span class="stringliteral">&quot;Linfty&quot;</span>, Linfty_error);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> BlackScholes&lt;dim&gt;::write_convergence_table()</div><div class="line">  {</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;L2&quot;</span>, 3);</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;H1&quot;</span>, 3);</div><div class="line">    convergence_table.set_precision(<span class="stringliteral">&quot;Linfty&quot;</span>, 3);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;L2&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;H1&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_scientific(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="keyword">true</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;\\# cells&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;\\# dofs&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;L2&quot;</span>, <span class="stringliteral">&quot;@f@f$L^2@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;H1&quot;</span>, <span class="stringliteral">&quot;@f@f$H^1@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_caption(<span class="stringliteral">&quot;Linfty&quot;</span>, <span class="stringliteral">&quot;@f@f$L^\\infty@f@f$-error&quot;</span>);</div><div class="line">    convergence_table.set_tex_format(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">    convergence_table.set_tex_format(<span class="stringliteral">&quot;dofs&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">    std::cout &lt;&lt; std::endl;</div><div class="line">    convergence_table.write_text(std::cout);</div><div class="line">    std::string error_filename = <span class="stringliteral">&quot;error&quot;</span>;</div><div class="line">    error_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">    error_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">    std::ofstream error_table_file(error_filename);</div><div class="line">    convergence_table.write_tex(error_table_file);</div><div class="line"></div><div class="line">    convergence_table.add_column_to_supercolumn(<span class="stringliteral">&quot;cells&quot;</span>, <span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">    std::vector&lt;std::string&gt; new_order;</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;n cells&quot;</span>);</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;H1&quot;</span>);</div><div class="line">    new_order.emplace_back(<span class="stringliteral">&quot;L2&quot;</span>);</div><div class="line">    convergence_table.set_column_order(new_order);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;L2&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba7eb96994a8f6f2903e0d68ccae4c5a72">ConvergenceTable::reduction_rate</a>);</div><div class="line">    convergence_table.evaluate_convergence_rates(</div><div class="line">      <span class="stringliteral">&quot;H1&quot;</span>, <a class="code" href="classConvergenceTable.html#ae1ef1c23deebd739950f52b0740ecaaba322af8094a35219c384ae2d343905e9c">ConvergenceTable::reduction_rate_log2</a>);</div><div class="line">    std::cout &lt;&lt; std::endl;</div><div class="line">    convergence_table.write_text(std::cout);</div><div class="line">    std::string conv_filename = <span class="stringliteral">&quot;convergence&quot;</span>;</div><div class="line">    conv_filename += <span class="stringliteral">&quot;-global&quot;</span>;</div><div class="line">    <span class="keywordflow">switch</span> (fe.degree)</div><div class="line">      {</div><div class="line">        <span class="keywordflow">case</span> 1:</div><div class="line">          conv_filename += <span class="stringliteral">&quot;-q1&quot;</span>;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> 2:</div><div class="line">          conv_filename += <span class="stringliteral">&quot;-q2&quot;</span>;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line">      }</div><div class="line">    conv_filename += <span class="stringliteral">&quot;.tex&quot;</span>;</div><div class="line">    std::ofstream table_file(conv_filename);</div><div class="line">    convergence_table.write_tex(table_file);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">BlackScholes&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, 0.0, maximum_stock_price, <span class="keyword">true</span>);</div><div class="line">    triangulation.refine_global(0);</div><div class="line"></div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;u&quot;</span>);</div><div class="line">    data_out_stack.declare_data_vector(solution_names,</div><div class="line">                                       <a class="code" href="classDataOutStack.html">DataOutStack&lt;dim&gt;::dof_vector</a>);</div><div class="line"></div><div class="line">    Vector&lt;double&gt; vmult_result;</div><div class="line">    Vector&lt;double&gt; forcing_terms;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; cycle++)</div><div class="line">      {</div><div class="line">        <span class="keywordflow">if</span> (cycle != 0)</div><div class="line">          {</div><div class="line">            refine_grid();</div><div class="line">            time = 0.0;</div><div class="line">          }</div><div class="line"></div><div class="line">        setup_system();</div><div class="line"></div><div class="line">        std::cout &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;===========================================&quot;</span> &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span></div><div class="line">                  &lt;&lt; triangulation.n_active_cells() &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()</div><div class="line">                  &lt;&lt; std::endl</div><div class="line">                  &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler,</div><div class="line">                                 InitialConditions&lt;dim&gt;(strike_price),</div><div class="line">                                 solution);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">          {</div><div class="line">            add_results_for_output();</div><div class="line">          }</div><div class="line"></div><div class="line">        vmult_result.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">        forcing_terms.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number = 0; timestep_number &lt; n_time_steps;</div><div class="line">             ++timestep_number)</div><div class="line">          {</div><div class="line">            time += time_step;</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (timestep_number % 1000 == 0)</div><div class="line">              std::cout &lt;&lt; <span class="stringliteral">&quot;Time step &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; at t=&quot;</span> &lt;&lt; time</div><div class="line">                        &lt;&lt; std::endl;</div><div class="line"></div><div class="line">            mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(system_rhs, solution);</div><div class="line"></div><div class="line">            laplace_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add(</div><div class="line">              (-1) * (1 - theta) * time_step *</div><div class="line">                Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">              vmult_result);</div><div class="line">            mass_matrix.<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html#a4aedd84e99cda48dce634a2bbf8763fd">vmult</a>(vmult_result, solution);</div><div class="line"></div><div class="line">            system_rhs.add((-1) * (1 - theta) * time_step * interest_rate * 2,</div><div class="line">                           vmult_result);</div><div class="line"></div><div class="line">            a_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add((-1) * time_step * interest_rate, vmult_result);</div><div class="line"></div><div class="line">            b_matrix.vmult(vmult_result, solution);</div><div class="line">            system_rhs.add(</div><div class="line">              (-1) * Utilities::fixed_power&lt;2, double&gt;(asset_volatility) *</div><div class="line">                time_step * 1,</div><div class="line">              vmult_result);</div><div class="line"></div><div class="line">            RightHandSide&lt;dim&gt; rhs_function(asset_volatility, interest_rate);</div><div class="line">            rhs_function.set_time(time);</div><div class="line">            <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                                <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                                rhs_function,</div><div class="line">                                                forcing_terms);</div><div class="line">            forcing_terms *= time_step * theta;</div><div class="line">            system_rhs -= forcing_terms;</div><div class="line"></div><div class="line">            rhs_function.set_time(time - time_step);</div><div class="line">            <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div><div class="line">                                                <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div><div class="line">                                                rhs_function,</div><div class="line">                                                forcing_terms);</div><div class="line">            forcing_terms *= time_step * (1 - theta);</div><div class="line">            system_rhs -= forcing_terms;</div><div class="line"></div><div class="line">            system_matrix.copy_from(mass_matrix);</div><div class="line">            system_matrix.add(</div><div class="line">              (theta)*time_step *</div><div class="line">                Utilities::fixed_power&lt;2, double&gt;(asset_volatility) * 0.5,</div><div class="line">              laplace_matrix);</div><div class="line">            system_matrix.add((time_step)*interest_rate * theta * (1 + 1),</div><div class="line">                              mass_matrix);</div><div class="line"></div><div class="line">            constraints.condense(system_matrix, system_rhs);</div><div class="line"></div><div class="line">            {</div><div class="line">              RightBoundaryValues&lt;dim&gt; right_boundary_function(strike_price,</div><div class="line">                                                               interest_rate);</div><div class="line">              LeftBoundaryValues&lt;dim&gt;  left_boundary_function;</div><div class="line">              right_boundary_function.set_time(time);</div><div class="line">              left_boundary_function.set_time(time);</div><div class="line">              std::map&lt;types::global_dof_index, double&gt; boundary_values;</div><div class="line">              <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                                       0,</div><div class="line">                                                       left_boundary_function,</div><div class="line">                                                       boundary_values);</div><div class="line">              <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                                       1,</div><div class="line">                                                       right_boundary_function,</div><div class="line">                                                       boundary_values);</div><div class="line">              <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 solution,</div><div class="line">                                                 system_rhs);</div><div class="line">            }</div><div class="line"></div><div class="line">            solve_time_step();</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (cycle == (n_cycles - 1))</div><div class="line">              {</div><div class="line">                add_results_for_output();</div><div class="line">              }</div><div class="line">          }</div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">        process_solution();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      }</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::string filename = <span class="stringliteral">&quot;solution.vtk&quot;</span>;</div><div class="line">    std::ofstream     output(filename);</div><div class="line">    data_out_stack.write_vtk(output);</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef MMS</span></div><div class="line">    write_convergence_table();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  }</div><div class="line"></div><div class="line">} <span class="comment">// namespace BlackScholesSolver</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span>BlackScholesSolver;</div><div class="line"></div><div class="line">      BlackScholes&lt;1&gt; black_scholes_solver;</div><div class="line">      black_scholes_solver.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
