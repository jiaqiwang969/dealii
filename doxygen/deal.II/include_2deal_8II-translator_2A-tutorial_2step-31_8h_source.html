<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/include_2deal_8II-translator_2A-tutorial_2step-31_8h_source.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: include/deal.II-translator/A-tutorial/step-31.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d44c64559bbebec7f509842c48db8b23.html">include</a></li><li class="navelem"><a class="el" href="dir_386d89ad50a3909c2af5a93b48d2c3ff.html">deal.II-translator</a></li><li class="navelem"><a class="el" href="dir_7812fe2bbb6fb6db2d3962cae8700ca0.html">A-tutorial</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">step-31.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="include_2deal_8II-translator_2A-tutorial_2step-31_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160; ,</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <span class="comment">/*component*/</span>  = 0) <span class="keyword">const</span> <span class="keyword">override</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;       {</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;         <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;       }</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;* </div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;       <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                                 <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value)<span class="keyword"> const override</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;<span class="keyword">       </span>{</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;           value(c) = TemperatureInitialValues&lt;dim&gt;::value(p, c);</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;       }</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;     };</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;* </div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160; </div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;* </div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;     <span class="keyword">class </span>TemperatureRightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;     {</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;     <span class="keyword">public</span>:</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;       TemperatureRightHandSide()</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;         : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(1)</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;       {}</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;* </div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;       <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0)<span class="keyword"> const override</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="keyword">       </span>{</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;         (void)component;</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;         <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component == 0,</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Invalid operation for a scalar function.&quot;</span>));</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;* </div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;         <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((dim == 2) || (dim == 3), <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;* </div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;         <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> source_centers[3] = {</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;           (dim == 2 ? <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(.3, .1) : <a class="code" href="classPoint.html">Point</a>&lt;dim&gt;(.3, .5, .1)),</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;           (dim == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;dim&gt;(.45, .1) : <a class="code" href="classPoint.html">Point</a>&lt;dim&gt;(.45, .5, .1)),</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;           (dim == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;dim&gt;(.75, .1) : <a class="code" href="classPoint.html">Point</a>&lt;dim&gt;(.75, .5, .1))};</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> source_radius = (dim == 2 ? 1. / 32 : 1. / 8);</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;* </div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;         <span class="keywordflow">return</span> ((source_centers[0].distance(p) &lt; source_radius) ||</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                     (source_centers[1].<a class="code" href="classPoint.html#a3df8e6ab311dab9337c8d7b039c7b815">distance</a>(p) &lt; source_radius) ||</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                     (source_centers[2].distance(p) &lt; source_radius) ?</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                   1 :</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                   0);</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;       }</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;* </div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;       <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;                                 <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value)<span class="keyword"> const override</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;<span class="keyword">       </span>{</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;<a class="code" href="classFunction.html#a7248c7e11dc434fb7d16cdc5e41e3770">n_components</a>; ++c)</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;           <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(c) = TemperatureRightHandSide&lt;dim&gt;::value(p, c);</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;       }</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;     };</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;   } <span class="comment">// namespace EquationData</span></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;* </div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160; </div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;* </div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;* </div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;Linearsolversandpreconditioners&quot;</span>&gt;&lt;/a&gt;  &lt;h3&gt;Linear solvers and preconditioners&lt;/h3&gt;</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;* </div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;* </div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;*  This section introduces some objects that are used <span class="keywordflow">for</span> the solution of the linear equations of the Stokes system that we need to solve in each time step. Many of the ideas used here are the same as in   @ref step_20 <span class="stringliteral">&quot;step-20&quot;</span>  , where Schur complement based preconditioners and solvers have been introduced, with the actual <span class="keyword">interface </span>taken from   @ref step_22 &quot;step-22&quot;   (in particular the discussion in the &quot;Results&quot; section of   @ref step_22 &quot;step-22&quot;  , in which we introduce alternatives to the direct Schur complement approach). Note, however, that here we don&#39;t use the Schur complement to solve the Stokes equations, though an <a class="code" href="namespaceDerivativeApproximation_1_1internal.html#a4bea05d5ab84ca1e802db9a0217d1d6c">approximate</a> Schur complement (the mass <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> on the pressure space) appears in the preconditioner.</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;* </div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;* </div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;* @code</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;   <span class="keyword">namespace </span>LinearSolvers</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;   {</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;* </div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;ThecodeInverseMatrixcodeclasstemplate&quot;</span>&gt;&lt;/a&gt;  &lt;h4&gt;The &lt;code&gt;InverseMatrix&lt;/code&gt; <span class="keyword">class </span>template&lt;/h4&gt;</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;* </div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;* </div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;*  This <span class="keyword">class </span>is an interface to calculate the action of an &quot;inverted&quot; <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> on a vector (using the   &lt;code&gt;vmult&lt;/code&gt;   operation) in the same way as the corresponding class in   @ref step_22 &quot;step-22&quot;  : when the product of an object of this class is requested, we solve a linear equation system with that <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> using the CG method, accelerated by a preconditioner of (templated) class   &lt;code&gt;PreconditionerType&lt;/code&gt;  .     </div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;*   In a minor deviation from the implementation of the same class in   @ref step_22 &quot;step-22&quot;  , we make the   &lt;code&gt;vmult&lt;/code&gt;   function take any kind of vector type (it will yield compiler errors, however, if the matrix does not allow a matrix-vector product with this kind of vector).     </div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;*   Secondly, we catch any exceptions that the solver may have thrown. The reason is as follows: When debugging a program like this <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> occasionally makes a mistake of passing an indefinite or nonsymmetric <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> or preconditioner to the current class. The solver will, in that case, not converge and throw a <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>-time exception. If not caught here it will propagate up the <a class="code" href="namespaceThreads_1_1internal.html#a8d237a30d09b13e0b5adbe0fd1dfb188">call</a> stack and may <a class="code" href="namespaceTrilinosWrappers_1_1internal.html#aee42c8e3004e2e81eac3c3356d3ec46b">end</a> up in   &lt;code&gt;main()&lt;/code&gt;   where we output an error message that will say that the CG solver failed. The question then becomes: Which CG solver? The <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> that inverted the mass <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>? The <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> that inverted the top left block with the Laplace operator? Or a CG solver in <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> of the several other nested places where we use linear solvers in the current code? No indication about this is present in a <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>-time exception because it doesn&#39;t store the stack of calls through which we got to the place where the exception was generated.     </div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;*   So rather than letting the exception propagate freely up to   &lt;code&gt;main()&lt;/code&gt;   we realize that there is little that an outer function can do if the inner solver fails and rather convert the <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>-time exception into an assertion that fails and triggers a <a class="code" href="namespaceThreads_1_1internal.html#a8d237a30d09b13e0b5adbe0fd1dfb188">call</a> to   &lt;code&gt;<a class="code" href="namespacedeal__II__exceptions_1_1internals.html#a600f8f191a6ce368afda0074dd7ea1dc">abort</a>()&lt;/code&gt;  , allowing us to <a class="code" href="symmetric__tensor_8h.html#a4248760c880275bab1f288fc80f27039">trace</a> back in a debugger how we got to the current place.</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;* </div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;* </div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;* @code</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;     template &lt;class MatrixType, class PreconditionerType&gt;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;     class InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;     {</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;     <span class="keyword">public</span>:</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;       InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        m,</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                     <span class="keyword">const</span> PreconditionerType &amp;preconditioner);</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;* </div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160; </div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;       <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;       <span class="keywordtype">void</span> vmult(<a class="code" href="classVectorType.html">VectorType</a> &amp;dst, <span class="keyword">const</span> <a class="code" href="classVectorType.html">VectorType</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;* </div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;     <span class="keyword">private</span>:</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;       <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;       <span class="keyword">const</span> PreconditionerType &amp;           preconditioner;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;     };</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;* </div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160; </div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;     <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;     InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;       <span class="keyword">const</span> MatrixType &amp;        m,</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;       <span class="keyword">const</span> PreconditionerType &amp;preconditioner)</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;       : <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>(&amp;m)</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;       , preconditioner(preconditioner)</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;     {}</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;* </div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160; </div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;* </div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;     <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;     <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;     <span class="keywordtype">void</span> InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult(</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;       <a class="code" href="classVectorType.html">VectorType</a> &amp;      dst,</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;       <span class="keyword">const</span> <a class="code" href="classVectorType.html">VectorType</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="keyword">     </span>{</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;       <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-7 src.l2_norm());</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;       <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;* </div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;       dst = 0;</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;* </div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;       <span class="keywordflow">try</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;         {</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;           cg.solve(*<a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>, dst, src, preconditioner);</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;         }</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;       <span class="keywordflow">catch</span> (std::exception &amp;<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>)</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;         {</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;           <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(e.what()));</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;         }</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;     }</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;* </div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;* </div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;Schurcomplementpreconditioner&quot;</span>&gt;&lt;/a&gt;  &lt;h4&gt;Schur complement preconditioner&lt;/h4&gt;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;* </div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;* </div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;*  This is the implementation of the Schur complement preconditioner as described in detail in the introduction. As opposed to   @ref step_20 <span class="stringliteral">&quot;step-20&quot;</span>   and   @ref step_22 <span class="stringliteral">&quot;step-22&quot;</span>  , we solve the block system all-at-once <span class="keyword">using</span> GMRES, and use the Schur complement of the block structured <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> to build a good preconditioner instead.     </div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;*   Let<span class="stringliteral">&#39;s have a look at the ideal preconditioner matrix   @f$P=\left(\begin{array}{cc} A &amp; 0 \\ B &amp;</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="stringliteral">-S \end{array}\right)@f$   described in the introduction. If we apply this matrix in the solution of a linear system, convergence of an iterative GMRES solver will be governed by the matrix @f{eqnarray*} P^{-1}\left(\begin{array}{cc} A &amp;</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="stringliteral"> B^T \\ B &amp; 0 \end{array}\right) = \left(\begin{array}{cc} I &amp; A^{-1}</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;<span class="stringliteral"> B^T \\ 0 &amp; I \end{array}\right), @f} which indeed is very simple. A GMRES solver based on exact matrices would converge in one iteration, since all eigenvalues are equal (any Krylov method takes at most as many iterations as there are distinct eigenvalues). Such a preconditioner for the blocked Stokes system has been proposed by Silvester and Wathen (&quot;Fast iterative solution of stabilised Stokes systems part II.  Using general block preconditioners&quot;, SIAM J. Numer. Anal., 31 (1994), pp. 1352-1367).     </span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="stringliteral">*   Replacing   @f$P@f$   by   @f$\tilde{P}@f$   keeps that spirit alive: the product   @f$P^{-1} A@f$   will still be close to a matrix with eigenvalues 1 with a distribution that does not depend on the problem size. This lets us hope to be able to get a number of GMRES iterations that is problem-size independent.     </span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;<span class="stringliteral">*   The deal.II users who have already gone through the   @ref step_20 &quot;step-20&quot;   and   @ref step_22 &quot;step-22&quot;   tutorials can certainly imagine how we&#39;</span>re going to implement this.  We replace the exact inverse matrices in   @f$P^{-1}@f$   by some <a class="code" href="namespaceDerivativeApproximation_1_1internal.html#a4bea05d5ab84ca1e802db9a0217d1d6c">approximate</a> inverses built from the InverseMatrix <span class="keyword">class</span>, and the inverse Schur complement will be approximated by the pressure mass <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>   @f$M_p@f$   (weighted by   @f$\eta^{-1}@f$   as mentioned in the introduction). As pointed out in the results section of   @ref step_22 <span class="stringliteral">&quot;step-22&quot;</span>  , we can replace the exact inverse of   @f$A@f$   by just the application of a preconditioner, in <span class="keyword">this</span> <span class="keywordflow">case</span> on a vector Laplace <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> as was explained in the introduction. This does increase the number of (outer) GMRES iterations, but is still significantly cheaper than an exact inverse, which would require between 20 and 35 CG iterations for   &lt;em&gt;  each  &lt;/em&gt;   outer solver step (<span class="keyword">using</span> the AMG preconditioner).     </div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;*   Having the above explanations in mind, we define a preconditioner <span class="keyword">class </span>with a   &lt;code&gt;vmult&lt;/code&gt;   functionality, which is all we need for the interaction with the usual solver <a class="code" href="namespaceinternal_1_1p4est.html#a4b980c7b4b4d9984e93d73c7d30173ea">functions</a> further below in the program code.     </div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;*   First the declarations. These are similar to the definition of the Schur complement in   @ref step_20 <span class="stringliteral">&quot;step-20&quot;</span>  , with the difference that we need some more preconditioners in the constructor and that the matrices we use here are built upon Trilinos:</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;* </div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;* </div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;* @code</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;     <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;     <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;     {</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;     <span class="keyword">public</span>:</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;       BlockSchurPreconditioner(</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;         <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;         <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                             PreconditionerTypeMp&gt; &amp;Mpinv,</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;         <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;* </div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;       <span class="keywordtype">void</span> vmult(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      dst,</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;                  <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;* </div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;     <span class="keyword">private</span>:</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;       <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;         stokes_matrix;</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;       <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">TrilinosWrappers::SparseMatrix</a>,</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;                                              PreconditionerTypeMp&gt;&gt;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                                  m_inverse;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;       <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;* </div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;       <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;     };</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;* </div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160; </div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;* </div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;* </div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;*  When <span class="keyword">using</span> a   <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>   or a   <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">TrilinosWrappers::MPI::BlockVector</a>,   the <a class="code" href="classVector.html">Vector</a> is initialized <span class="keyword">using</span> an <a class="code" href="classIndexSet.html">IndexSet</a>. <a class="code" href="classIndexSet.html">IndexSet</a> is used not only to resize the   <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>   but it also associates an index in the   <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a>   with a degree of freedom (see   @ref step_40 <span class="stringliteral">&quot;step-40&quot;</span>   <span class="keywordflow">for</span> a more detailed explanation). The <span class="keyword">function</span> <a class="code" href="index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>() creates an <a class="code" href="classIndexSet.html">IndexSet</a> where every <a class="code" href="namespaceIteratorState.html#a4e92f4a9d339ff987cc3eb5b0a1ac507a457da025bc5a3a2231a667bd5c6f3c92">valid</a> index is part of the <a class="code" href="group__CUDAWrappers.html#gabb7130e2cea54654455ca41ef304f939">set</a>. Note that this program can only be <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a> sequentially and will throw an exception if used in <a class="code" href="namespaceparallel.html">parallel</a>.</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;* </div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;* </div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;* @code</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;     template &lt;class PreconditionerTypeA, class PreconditionerTypeMp&gt;</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;     BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;       BlockSchurPreconditioner(</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;         const <a class="code" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a>::<a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix</a> &amp;S,</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;         const InverseMatrix&lt;<a class="code" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a>::<a class="code" href="classSparseMatrix.html">SparseMatrix</a>,</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                             PreconditionerTypeMp&gt; &amp;Mpinv,</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;         const PreconditionerTypeA &amp;                Apreconditioner)</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;       : stokes_matrix(&amp;S)</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;       , m_inverse(&amp;Mpinv)</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;       , a_preconditioner(Apreconditioner)</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;       , tmp(<a class="code" href="index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(stokes_matrix-&gt;block(1, 1).m()))</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;     {}</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;* </div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160; </div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;* </div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;*  Next is the   &lt;code&gt;vmult&lt;/code&gt;   <span class="keyword">function</span>. We implement the action of   @f$P^{-1}@f$   as described above in three successive steps.  In formulas, we want to compute   @f$Y=P^{-1}X@f$   where   @f$X,Y@f$   are both vectors with two block components.     </div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;*   The <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> step multiplies the velocity part of the vector by a preconditioner of the <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>   @f$A@f$  , i.e., we compute   @f$Y_0={\tilde</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160; <a class="code" href="namespaceLAPACKSupport.html#a40707d49114d54318c823f3b750e89a4">A</a>}^{-1}X_0@f$  .  The resulting velocity vector is then multiplied by   @f$B@f$   and subtracted from the pressure, i.e., we want to compute   @f$X_1-BY_0@f$  . This <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> step only acts on the pressure vector and is accomplished by the residual <span class="keyword">function</span> of our <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> classes, except that the <a class="code" href="namespaceDifferentiation_1_1SD.html#aa55d50a1ffa79c27f9bd9ea104f15158">sign</a> is wrong. Consequently, we change the <a class="code" href="namespaceDifferentiation_1_1SD.html#aa55d50a1ffa79c27f9bd9ea104f15158">sign</a> in the temporary pressure vector and <span class="keywordflow">finally</span> multiply by the inverse pressure mass <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> to <span class="keyword">get</span> the <span class="keyword">final</span> pressure vector, completing our work on the Stokes preconditioner:</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;* </div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;* </div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;* @code</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;     <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;     <span class="keywordtype">void</span></div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;     BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult(</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;       TrilinosWrappers::MPI::BlockVector &amp;      dst,</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;       <span class="keyword">const</span> TrilinosWrappers::MPI::BlockVector &amp;src)<span class="keyword"> const</span></div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="keyword">     </span>{</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;       a_preconditioner.vmult(dst.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;       stokes_matrix-&gt;block(1, 0).residual(tmp, dst.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;       tmp=</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;* </div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;-1;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;       m_inverse-&gt;vmult(dst.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1), tmp);</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;     }</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;   } <span class="comment">// namespace LinearSolvers</span></div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;* </div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160; </div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;* </div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;* </div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;ThecodeBoussinesqFlowProblemcodeclasstemplate&quot;</span>&gt;&lt;/a&gt;  &lt;h3&gt;The &lt;code&gt;BoussinesqFlowProblem&lt;/code&gt; <span class="keyword">class </span>template&lt;/h3&gt;</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;* </div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;* </div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;*  The definition of the <span class="keyword">class </span>that defines the top-<a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a> logic of solving the time-dependent Boussinesq problem is mainly based on the   @ref step_22 &quot;step-22&quot;   tutorial program. The main differences are that now we also have to solve for the temperature equation, which forces us to have a <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> <a class="code" href="classDoFHandler.html">DoFHandler</a> object for the temperature variable as well as matrices, right hand sides, and solution vectors for the current and previous time steps. As mentioned in the introduction, all linear algebra objects are going to use wrappers of the corresponding Trilinos functionality.   </div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;*   The member <a class="code" href="namespaceinternal_1_1p4est.html#a4b980c7b4b4d9984e93d73c7d30173ea">functions</a> of <span class="keyword">this</span> <span class="keyword">class </span>are reminiscent of   @ref step_21 &quot;step-21&quot;  , where we also used a staggered scheme that <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> solve the flow equations (here the Stokes equations, in   @ref step_21 &quot;step-21&quot;   Darcy flow) and then update the advected quantity (here the temperature, there the saturation). The <a class="code" href="namespaceinternal_1_1p4est.html#a4b980c7b4b4d9984e93d73c7d30173ea">functions</a> that are new are mainly concerned with determining the time step, as well as the proper size of the artificial viscosity stabilization.   </div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;*   The last three variables indicate whether the various matrices or preconditioners need to be rebuilt the next time the corresponding build <a class="code" href="namespaceinternal_1_1p4est.html#a4b980c7b4b4d9984e93d73c7d30173ea">functions</a> are called. This allows us to move the corresponding   &lt;code&gt;<span class="keywordflow">if</span>&lt;/code&gt;   into the respective <span class="keyword">function</span> and thereby keeping our main   &lt;code&gt;<a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>()&lt;/code&gt;   <span class="keyword">function</span> clean and easy to read.</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;* </div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;* </div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;* @code</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;   <span class="keyword">class </span>BoussinesqFlowProblem</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;   {</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;   <span class="keyword">public</span>:</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;     BoussinesqFlowProblem();</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;     <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;* </div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;   <span class="keyword">private</span>:</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;     <span class="keywordtype">void</span>   setup_dofs();</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;     <span class="keywordtype">void</span>   assemble_stokes_preconditioner();</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;     <span class="keywordtype">void</span>   build_stokes_preconditioner();</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;     <span class="keywordtype">void</span>   assemble_stokes_system();</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;     <span class="keywordtype">void</span>   assemble_temperature_system(<span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity);</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;     <span class="keywordtype">void</span>   assemble_temperature_matrix();</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;     <span class="keywordtype">double</span> get_maximal_velocity() <span class="keyword">const</span>;</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;     std::pair&lt;double, double&gt; get_extrapolated_temperature_range() <span class="keyword">const</span>;</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;     <span class="keywordtype">void</span>                      solve();</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;     <span class="keywordtype">void</span>                      output_results() <span class="keyword">const</span>;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;     <span class="keywordtype">void</span>                      refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;* </div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;     <span class="keywordtype">double</span> compute_viscosity(</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;       <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;       <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;       <span class="keyword">const</span> std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;       <span class="keyword">const</span> std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;       <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;       <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;       <span class="keyword">const</span> std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;       <span class="keyword">const</span> std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;       <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;       <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;       <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;       <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;* </div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160; </div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;     <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;     <span class="keywordtype">double</span>             global_Omega_diameter;</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;* </div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        stokes_degree;</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;     <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             stokes_fe;</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;     <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           stokes_dof_handler;</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;     <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> stokes_constraints;</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;* </div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;     std::vector&lt;IndexSet&gt;               stokes_partitioning;</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_matrix;</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_preconditioner_matrix;</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;* </div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;     TrilinosWrappers::MPI::BlockVector stokes_solution;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;     TrilinosWrappers::MPI::BlockVector old_stokes_solution;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;     TrilinosWrappers::MPI::BlockVector stokes_rhs;</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;* </div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160; </div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        temperature_degree;</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;     <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 temperature_fe;</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;     <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           temperature_dof_handler;</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;     <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> temperature_constraints;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;* </div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_mass_matrix;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_stiffness_matrix;</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_matrix;</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;* </div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_solution;</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_temperature_solution;</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_temperature_solution;</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;     <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_rhs;</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;* </div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160; </div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;     <span class="keywordtype">double</span>       time_step;</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;     <span class="keywordtype">double</span>       old_time_step;</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;* </div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;     std::shared_ptr&lt;TrilinosWrappers::PreconditionAMG&gt; Amg_preconditioner;</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;     std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt;  Mp_preconditioner;</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;* </div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;     <span class="keywordtype">bool</span> rebuild_stokes_matrix;</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;     <span class="keywordtype">bool</span> rebuild_temperature_matrices;</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;     <span class="keywordtype">bool</span> rebuild_stokes_preconditioner;</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;   };</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;* </div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160; </div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;* </div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;BoussinesqFlowProblemclassimplementation&quot;</span>&gt;&lt;/a&gt;  &lt;h3&gt;BoussinesqFlowProblem <span class="keyword">class </span>implementation&lt;/h3&gt;</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;* </div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;* </div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;BoussinesqFlowProblemBoussinesqFlowProblem&quot;</span>&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::BoussinesqFlowProblem&lt;/h4&gt;   </div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;*   The constructor of <span class="keyword">this</span> <span class="keyword">class </span>is an extension of the constructor in   @ref step_22 &quot;step-22&quot;  . We need to add the various variables that concern the temperature. As discussed in the introduction, we are going to use   @f$Q_2\times Q_1@f$   (Taylor-Hood) elements again for the Stokes part, and   @f$Q_2@f$   elements for the temperature. However, by using variables that store the polynomial degree of the Stokes and temperature finite elements, it is easy to consistently modify the degree of the elements as well as all quadrature formulas used on them <a class="code" href="namespaceDoFRenumbering.html#a59c1a183ef6288e6bb061eb738b84380">downstream</a>. Moreover, we initialize the time stepping as well as the options for <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> assembly and preconditioning:</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;* </div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;* </div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;* @code</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;   template &lt;int dim&gt;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;   BoussinesqFlowProblem&lt;dim&gt;::BoussinesqFlowProblem()</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;     : <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>(Triangulation&lt;dim&gt;::maximum_smoothing)</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;     , global_Omega_diameter(std::numeric_limits&lt;double&gt;::quiet_NaN())</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;     , stokes_degree(1)</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;     , stokes_fe(FE_Q&lt;dim&gt;(stokes_degree + 1), dim, FE_Q&lt;dim&gt;(stokes_degree), 1)</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;     , stokes_dof_handler(triangulation)</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;     ,</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;* </div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;     temperature_degree(2)</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;     , temperature_fe(temperature_degree)</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;     , temperature_dof_handler(triangulation)</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;     ,</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;* </div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;     time_step(0)</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;     , old_time_step(0)</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;     , timestep_number(0)</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;     , rebuild_stokes_matrix(true)</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;     , rebuild_temperature_matrices(true)</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;     , rebuild_stokes_preconditioner(true)</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;   {}</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;* </div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160; </div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;* </div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;* </div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;BoussinesqFlowProblemget_maximal_velocity&quot;</span>&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::get_maximal_velocity&lt;/h4&gt;</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;* </div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;* </div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;*  Starting the real functionality of <span class="keyword">this</span> <span class="keyword">class </span>is a helper function that determines the maximum (  @f$L_\infty@f$  ) velocity in the domain (at the quadrature points, in fact). How it works should be relatively obvious to all who have gotten to this <a class="code" href="namespaceOpenCASCADE.html#a9509efa83e3b2fa42616fe0623cba696">point</a> of the tutorial. Note that since we are only interested in the velocity, rather than using   &lt;code&gt;stokes_fe_values.get_function_values&lt;/code&gt;   to get the <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a> of the entire Stokes solution (velocities and pressures) we use   &lt;code&gt;stokes_fe_values[velocities].get_function_values&lt;/code&gt;   to <a class="code" href="namespaceTensorAccessors.html#a5798da96660fa8e6798917501d65dbd8">extract</a> only the velocities part. This has the additional benefit that we get it as a <a class="code" href="classTensor.html">Tensor</a>&lt;1,dim&gt;, rather than some components in a <a class="code" href="classVector.html">Vector</a>&lt;<a class="code" href="classdouble.html">double</a>&gt;, allowing us to process it right away using the   &lt;code&gt;<a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>()&lt;/code&gt;   function to get the magnitude of the velocity.   </div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;*   The only <a class="code" href="namespaceOpenCASCADE.html#a9509efa83e3b2fa42616fe0623cba696">point</a> worth thinking about a bit is how to choose the quadrature points we use here. Since the goal of <span class="keyword">this</span> <span class="keyword">function</span> is to find the maximal velocity over a domain by looking at quadrature points on each cell. So we should ask how we should best choose these quadrature points on each cell. To <span class="keyword">this</span> <a class="code" href="namespaceTrilinosWrappers_1_1internal.html#aee42c8e3004e2e81eac3c3356d3ec46b">end</a>, recall that <span class="keywordflow">if</span> we had a single   @f$Q_1@f$   field (rather than the vector-valued field of higher order) then the maximum would be attained at a vertex of the mesh. In other words, we should use the <a class="code" href="classQTrapezoid.html">QTrapezoid</a> <span class="keyword">class </span>that has quadrature points only at the <a class="code" href="data__out__base_8cc.html#accc45da40beb7ae1b485306984e904a2">vertices</a> of cells.   </div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;*   For higher order shape <a class="code" href="namespaceinternal_1_1p4est.html#a4b980c7b4b4d9984e93d73c7d30173ea">functions</a>, the situation is more complicated: the maxima and minima may be attained at points between the support points of shape <a class="code" href="namespaceinternal_1_1p4est.html#a4b980c7b4b4d9984e93d73c7d30173ea">functions</a> (<span class="keywordflow">for</span> the usual   @f$Q_p@f$   elements the support points are the equidistant Lagrange interpolation points); furthermore, since we are looking <span class="keywordflow">for</span> the maximum magnitude of a vector-valued quantity, we can even less say with certainty where the <span class="keyword">set</span> of potential maximal points are. Nevertheless, intuitively <span class="keywordflow">if</span> not provably, the Lagrange interpolation points appear to be a better choice than the Gauss points.   </div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;*   There are now different methods to produce a quadrature formula with quadrature points <a class="code" href="vectorization_8h.html#a31b02447b71a04a1ec9bdd1358751e45a465289687a70db7aa7217cc240c29f0f">equal</a> to the interpolation points of the finite element. One option would be to use the   <a class="code" href="classFiniteElement.html#a5b35a290aa7dd7562911a92a13b11fee">FiniteElement::get_unit_support_points</a>()   function, <a class="code" href="namespaceUtilities_1_1MPI.html#a9e963546bd81b0cdd88e1840cfa8f227">reduce</a> the output to a unique <a class="code" href="group__CUDAWrappers.html#gabb7130e2cea54654455ca41ef304f939">set</a> of points to avoid duplicate function evaluations, and create a <a class="code" href="classQuadrature.html">Quadrature</a> <span class="keywordtype">object</span> using these points. Another option, chosen here, is to use the <a class="code" href="classQTrapezoid.html">QTrapezoid</a> class and combine it with the <a class="code" href="classQIterated.html">QIterated</a> class that repeats the <a class="code" href="classQTrapezoid.html">QTrapezoid</a> formula on a number of sub-cells in each coordinate direction. To cover all support points, we need to iterate it   &lt;code&gt;stokes_degree+1&lt;/code&gt;   times since this is the polynomial degree of the Stokes element in use:</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;* </div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;* </div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;* @code</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;   template &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;   <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_maximal_velocity()<span class="keyword"> const</span></div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;<span class="keyword">   </span>{</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;     <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(), stokes_degree + 1);</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   n_q_points = quadrature_formula.size();</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;* </div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(stokes_fe, quadrature_formula, <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;     std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(n_q_points);</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;     <span class="keywordtype">double</span>                      max_velocity = 0;</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;* </div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;     <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;* </div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : stokes_dof_handler.active_cell_iterators())</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;       {</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;         fe_values.reinit(cell);</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;         fe_values[velocities].get_function_values(stokes_solution,</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;                                                   velocity_values);</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;* </div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;           max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(max_velocity, velocity_values[q].<a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>());</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;       }</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;* </div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;     <span class="keywordflow">return</span> max_velocity;</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;   }</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;* </div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160; </div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;* </div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;* </div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;BoussinesqFlowProblemget_extrapolated_temperature_range&quot;</span>&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::get_extrapolated_temperature_range&lt;/h4&gt;</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;* </div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;* </div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;*  Next a <span class="keyword">function</span> that determines the minimum and maximum temperature at quadrature points inside   @f$\Omega@f$   when extrapolated from the two previous time steps to the current <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a>. We need <span class="keyword">this</span> information in the computation of the artificial viscosity parameter   @f$\nu@f$   as discussed in the introduction.   </div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;*   The formula <span class="keywordflow">for</span> the extrapolated temperature is   @f$\left(1+\frac{k_n}{k_{n-1}} \right)<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>^{n-1} + \frac{k_n}{k_{n-1}}</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160; <a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>^{n-2}@f$  . The way to compute it is to <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> over all quadrature points and update the maximum and minimum value <span class="keywordflow">if</span> the current value is bigger/smaller than the previous <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a>. We initialize the variables that store the <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">max</a> and <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc">min</a> before the <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> over all quadrature points by the smallest and the largest number representable as a <span class="keywordtype">double</span>. Then we know <span class="keywordflow">for</span> a fact that it is larger/smaller than the minimum/maximum and that the <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> over all quadrature points is ultimately going to update the <a class="code" href="namespaceAlgorithms_1_1Events.html#a15a12dfdadd39a026d192ad96cb6207b">initial</a> value with the correct <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a>.   </div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;*   The only other complication worth mentioning here is that in the <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> time step,   @f$T^{k-2}@f$   is not yet available of course. In that <span class="keywordflow">case</span>, we can only use   @f$T^{k-1}@f$   which we have from the <a class="code" href="namespaceAlgorithms_1_1Events.html#a15a12dfdadd39a026d192ad96cb6207b">initial</a> temperature. As quadrature points, we use the same choice as in the previous <span class="keyword">function</span> though with the difference that now the number of repetitions is determined by the polynomial degree of the temperature field.</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;* </div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;* </div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;* @code</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;   std::pair&lt;double, double&gt;</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;   BoussinesqFlowProblem&lt;dim&gt;::get_extrapolated_temperature_range()<span class="keyword"> const</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="keyword">   </span>{</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;     <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;                                             temperature_degree);</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   n_q_points = quadrature_formula.size();</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;* </div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(temperature_fe, quadrature_formula, <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;     std::vector&lt;double&gt; old_temperature_values(n_q_points);</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;     std::vector&lt;double&gt; old_old_temperature_values(n_q_points);</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;* </div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;     <span class="keywordflow">if</span> (timestep_number != 0)</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;       {</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;         <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::numeric_limits&lt;double&gt;::max</a>(),</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;                max_temperature =</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;* </div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::numeric_limits&lt;double&gt;::max</a>();</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;* </div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : temperature_dof_handler.active_cell_iterators())</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;           {</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;             fe_values.reinit(cell);</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;             fe_values.get_function_values(old_temperature_solution,</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;                                           old_temperature_values);</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;             fe_values.get_function_values(old_old_temperature_solution,</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;                                           old_old_temperature_values);</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;* </div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;               {</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;                 <span class="keyword">const</span> <span class="keywordtype">double</span> temperature =</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;                   (1. + time_step / old_time_step) old_temperature_values[q]</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;* </div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;-</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;                   time_step / old_time_step old_old_temperature_values[q];</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;* </div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                 min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc">std::min</a>(min_temperature, temperature);</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;                 max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(max_temperature, temperature);</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;               }</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;           }</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;* </div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;         <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;       }</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;     <span class="keywordflow">else</span></div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;       {</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;         <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::numeric_limits&lt;double&gt;::max</a>(),</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;                max_temperature =</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;* </div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::numeric_limits&lt;double&gt;::max</a>();</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;* </div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : temperature_dof_handler.active_cell_iterators())</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;           {</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;             fe_values.reinit(cell);</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;             fe_values.get_function_values(old_temperature_solution,</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;                                           old_temperature_values);</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;* </div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;               {</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;                 <span class="keyword">const</span> <span class="keywordtype">double</span> temperature = old_temperature_values[q];</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;* </div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;                 min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc">std::min</a>(min_temperature, temperature);</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;                 max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(max_temperature, temperature);</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;               }</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;           }</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;* </div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;         <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;       }</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;   }</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;* </div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160; </div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;* </div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;* </div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;BoussinesqFlowProblemcompute_viscosity&quot;</span>&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::compute_viscosity&lt;/h4&gt;</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;* </div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;* </div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;*  The last of the tool functions computes the artificial viscosity parameter   @f$\nu|_K@f$   on a cell   @f$K@f$   as a <span class="keyword">function</span> of the extrapolated temperature, its <a class="code" href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaae2b6dfb8a5c48206992d8310d176c37c">gradient</a> and Hessian (<a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> derivatives), the velocity, the right hand side   @f$<a class="code" href="namespaceinternal_1_1QGaussLobatto.html#ac1aec52fdbb26c78e2d32fc0bed659c7">\gamma</a>@f$   all on the quadrature points of the current cell, and various other parameters as described in detail in the introduction.   </div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;*   There are some universal constants worth mentioning here. First, we need to fix   @f$\beta@f$  ; we choose   @f$\beta=0.017\cdot dim@f$  , a choice discussed in detail in the results section of <span class="keyword">this</span> tutorial program. The <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> is the exponent   @f$\alpha@f$  ;   @f$\alpha=1@f$   appears to work fine <span class="keywordflow">for</span> the current program, even though some additional benefit might be expected from choosing   @f$\alpha = 2@f$  . Finally, there is <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> thing that requires special casing: In the <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> time step, the velocity equals <a class="code" href="namespaceLAPACKSupport.html#a0d8802698d585eec62a2a54e6387b05b">zero</a>, and the formula <span class="keywordflow">for</span>   @f$\nu|_K@f$   is not defined. In that <span class="keywordflow">case</span>, we <span class="keywordflow">return</span>   @f$\nu|_K=5\cdot 10^3</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160; \cdot h_K@f$  , a choice admittedly more motivated by heuristics than anything <span class="keywordflow">else</span> (it is in the same order of magnitude, however, as the value returned <span class="keywordflow">for</span> most cells on the <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> time step).   </div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;*   The rest of the <span class="keyword">function</span> should be mostly obvious based on the material discussed in the introduction:</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;* </div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;* </div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;* @code</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;   <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::compute_viscosity(</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;     <span class="keyword">const</span> std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;     <span class="keyword">const</span> std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;     <span class="keyword">const</span> std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;     <span class="keyword">const</span> std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;<span class="keyword">   </span>{</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;     constexpr <span class="keywordtype">double</span> beta  = 0.017 dim;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;     constexpr <span class="keywordtype">double</span> alpha = 1.0;</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;* </div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;     <span class="keywordflow">if</span> (global_u_infty == 0)</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;       <span class="keywordflow">return</span> 5e-3 cell_diameter;</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;* </div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = old_temperature.size();</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;* </div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;     <span class="keywordtype">double</span> max_residual = 0;</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;     <span class="keywordtype">double</span> max_velocity = 0;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;* </div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;       {</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;         <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u =</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;           (old_velocity_values[q] + old_old_velocity_values[q]) / 2;</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;* </div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;         <span class="keyword">const</span> <span class="keywordtype">double</span> dT_dt =</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;           (old_temperature[q]</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;* </div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;- old_old_temperature[q]) / old_time_step;</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;         <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_T =</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;           u (old_temperature_grads[q] + old_old_temperature_grads[q]) / 2;</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;* </div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;         <span class="keyword">const</span> <span class="keywordtype">double</span> kappa_Delta_T =</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;           EquationData::kappa</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;           (old_temperature_laplacians[q] + old_old_temperature_laplacians[q]) /</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;           2;</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;* </div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;         <span class="keyword">const</span> <span class="keywordtype">double</span> residual =</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;           <a class="code" href="vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dT_dt + u_grad_T</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;* </div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;- kappa_Delta_T</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;* </div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;- gamma_values[q])</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;                    std::pow((old_temperature[q] + old_old_temperature[q]) / 2,</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;                             alpha</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;* </div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;- 1.));</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;* </div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;         max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(residual, max_residual);</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;         max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(std::sqrt(u u), max_velocity);</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;       }</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;* </div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = <a class="code" href="vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(2., (4.</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;* </div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;- 2 alpha) / dim);</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R global_u_infty global_T_variation</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;                                   <a class="code" href="vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(global_Omega_diameter, alpha</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;* </div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;- 2.);</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;* </div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;     <span class="keywordflow">return</span> (</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;       beta max_velocity</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;       <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc">std::min</a>(cell_diameter,</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;                std::pow(cell_diameter, alpha) max_residual / global_scaling));</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;   }</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;* </div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160; </div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;* </div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;* </div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;BoussinesqFlowProblemsetup_dofs&quot;</span>&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::setup_dofs&lt;/h4&gt;   </div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;*   This is the <span class="keyword">function</span> that sets up the <a class="code" href="classDoFHandler.html">DoFHandler</a> objects we have here (<a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> <span class="keywordflow">for</span> the Stokes part and <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> <span class="keywordflow">for</span> the temperature part) as well as <span class="keyword">set</span> to the right sizes the various objects required <span class="keywordflow">for</span> the linear algebra in <span class="keyword">this</span> program. Its basic operations are similar to what we <span class="keywordflow">do</span> in   @ref step_22 <span class="stringliteral">&quot;step-22&quot;</span>  .   </div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;*   The body of the <span class="keyword">function</span> <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> enumerates all degrees of freedom <span class="keywordflow">for</span> the Stokes and temperature systems. For the Stokes part, degrees of freedom are then sorted to ensure that velocities precede pressure DoFs so that we can <a class="code" href="namespaceSparsityTools.html#a452753b6ffdf31b33f2bcd792b05df93">partition</a> the Stokes <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> into a   @f$2\times 2@f$   <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>. As a difference to   @ref step_22 <span class="stringliteral">&quot;step-22&quot;</span>  , we <span class="keywordflow">do</span> not perform any additional DoF renumbering. In that program, it paid off since our solver was heavily dependent on ILU<span class="stringliteral">&#39;s, whereas we use AMG here which is not sensitive to the DoF numbering. The IC preconditioner for the inversion of the pressure mass matrix would of course take advantage of a Cuthill-McKee like renumbering, but its costs are low compared to the velocity portion, so the additional work does not pay off.   </span></div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;<span class="stringliteral">*   We then proceed with the generation of the hanging node constraints that arise from adaptive grid refinement for both DoFHandler objects. For the velocity, we impose no-flux boundary conditions   @f$\mathbf{u}\cdot</span></div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;<span class="stringliteral"> \mathbf{n}=0@f$   by adding constraints to the object that already stores the hanging node constraints matrix. The second parameter in the function describes the first of the velocity components in the total dof vector, which is zero here. The variable   &lt;code&gt;no_normal_flux_boundaries&lt;/code&gt;   denotes the boundary indicators for which to set the no flux boundary conditions; here, this is boundary indicator zero.   </span></div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;<span class="stringliteral">*   After having done so, we count the number of degrees of freedom in the various blocks:</span></div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;<span class="stringliteral">   template &lt;int dim&gt;</span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;<span class="stringliteral">   void BoussinesqFlowProblem&lt;dim&gt;::setup_dofs()</span></div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;<span class="stringliteral">   {</span></div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;<span class="stringliteral">     std::vector&lt;unsigned int&gt; stokes_sub_blocks(dim + 1, 0);</span></div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;<span class="stringliteral">     stokes_sub_blocks[dim] = 1;</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;<span class="stringliteral">     {</span></div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;<span class="stringliteral">       stokes_dof_handler.distribute_dofs(stokes_fe);</span></div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;<span class="stringliteral">       DoFRenumbering::component_wise(stokes_dof_handler, stokes_sub_blocks);</span></div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;<span class="stringliteral">       stokes_constraints.clear();</span></div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;<span class="stringliteral">       DoFTools::make_hanging_node_constraints(stokes_dof_handler,</span></div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;<span class="stringliteral">                                               stokes_constraints);</span></div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;<span class="stringliteral">       std::set&lt;types::boundary_id&gt; no_normal_flux_boundaries;</span></div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;<span class="stringliteral">       no_normal_flux_boundaries.insert(0);</span></div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;<span class="stringliteral">       VectorTools::compute_no_normal_flux_constraints(stokes_dof_handler,</span></div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;<span class="stringliteral">                                                       0,</span></div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;<span class="stringliteral">                                                       no_normal_flux_boundaries,</span></div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;<span class="stringliteral">                                                       stokes_constraints);</span></div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;<span class="stringliteral">       stokes_constraints.close();</span></div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;<span class="stringliteral">     }</span></div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;<span class="stringliteral">     {</span></div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="stringliteral">       temperature_dof_handler.distribute_dofs(temperature_fe);</span></div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="stringliteral">       temperature_constraints.clear();</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="stringliteral">       DoFTools::make_hanging_node_constraints(temperature_dof_handler,</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;<span class="stringliteral">                                               temperature_constraints);</span></div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;<span class="stringliteral">       temperature_constraints.close();</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;<span class="stringliteral">     }</span></div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;<span class="stringliteral">     const std::vector&lt;types::global_dof_index&gt; stokes_dofs_per_block =</span></div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;<span class="stringliteral">       DoFTools::count_dofs_per_fe_block(stokes_dof_handler, stokes_sub_blocks);</span></div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;<span class="stringliteral">     const unsigned int n_u = stokes_dofs_per_block[0],</span></div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;<span class="stringliteral">                        n_p = stokes_dofs_per_block[1],</span></div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;<span class="stringliteral">                        n_T = temperature_dof_handler.n_dofs();</span></div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;<span class="stringliteral">     std::cout &lt;&lt; &quot;Number of active cells: &quot; &lt;&lt; triangulation.n_active_cells()</span></div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;<span class="stringliteral">               &lt;&lt; &quot; (on &quot; &lt;&lt; triangulation.n_levels() &lt;&lt; &quot; levels)&quot; &lt;&lt; std::endl</span></div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="stringliteral">               &lt;&lt; &quot;Number of degrees of freedom: &quot; &lt;&lt; n_u + n_p + n_T &lt;&lt; &quot; (&quot;</span></div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;<span class="stringliteral">               &lt;&lt; n_u &lt;&lt; &#39;</span>+<span class="stringliteral">&#39; &lt;&lt; n_p &lt;&lt; &#39;</span>+<span class="stringliteral">&#39; &lt;&lt; n_T &lt;&lt; &#39;</span>)<span class="stringliteral">&#39; &lt;&lt; std::endl</span></div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;<span class="stringliteral">               &lt;&lt; std::endl;</span></div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="stringliteral">*  The next step is to create the sparsity pattern for the Stokes and temperature system matrices as well as the preconditioner matrix from which we build the Stokes preconditioner. As in   @ref step_22 &quot;step-22&quot;  , we choose to create the pattern by using the blocked version of DynamicSparsityPattern.     </span></div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="stringliteral">*   So, we first release the memory stored in the matrices, then set up an object of type BlockDynamicSparsityPattern consisting of   @f$2\times 2@f$   blocks (for the Stokes system matrix and preconditioner) or DynamicSparsityPattern (for the temperature part). We then fill these objects with the nonzero pattern, taking into account that for the Stokes system matrix, there are no entries in the pressure-pressure block (but all velocity vector components couple with each other and with the pressure). Similarly, in the Stokes preconditioner matrix, only the diagonal blocks are nonzero, since we use the vector Laplacian as discussed in the introduction. This operator only couples each vector component of the Laplacian with itself, but not with the other vector components. (Application of the constraints resulting from the no-flux boundary conditions will couple vector components at the boundary again, however.)     </span></div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;<span class="stringliteral">*   When generating the sparsity pattern, we directly apply the constraints from hanging nodes and no-flux boundary conditions. This approach was already used in   @ref step_27 &quot;step-27&quot;  , but is different from the one in early tutorial programs where we first built the original sparsity pattern and only then added the entries resulting from constraints. The reason for doing so is that later during assembly we are going to distribute the constraints immediately when transferring local to global dofs. Consequently, there will be no data written at positions of constrained degrees of freedom, so we can let the   DoFTools::make_sparsity_pattern   function omit these entries by setting the last Boolean flag to   &lt;code&gt;false&lt;/code&gt;  . Once the sparsity pattern is ready, we can use it to initialize the Trilinos matrices. Since the Trilinos matrices store the sparsity pattern internally, there is no need to keep the sparsity pattern around after the initialization of the matrix.</span></div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;<span class="stringliteral">     stokes_partitioning.resize(2);</span></div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="stringliteral">     stokes_partitioning[0] = complete_index_set(n_u);</span></div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;<span class="stringliteral">     stokes_partitioning[1] = complete_index_set(n_p);</span></div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;<span class="stringliteral">     {</span></div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;<span class="stringliteral">       stokes_matrix.clear();</span></div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;<span class="stringliteral">       BlockDynamicSparsityPattern dsp(2, 2);</span></div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;<span class="stringliteral">       dsp.block(0, 0).reinit(n_u, n_u);</span></div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;<span class="stringliteral">       dsp.block(0, 1).reinit(n_u, n_p);</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;<span class="stringliteral">       dsp.block(1, 0).reinit(n_p, n_u);</span></div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;<span class="stringliteral">       dsp.block(1, 1).reinit(n_p, n_p);</span></div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;<span class="stringliteral">       dsp.collect_sizes();</span></div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;<span class="stringliteral">       Table&lt;2, DoFTools::Coupling&gt; coupling(dim + 1, dim + 1);</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;<span class="stringliteral">       for (unsigned int c = 0; c &lt; dim + 1; ++c)</span></div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;<span class="stringliteral">         for (unsigned int d = 0; d &lt; dim + 1; ++d)</span></div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;<span class="stringliteral">           if (!((c == dim) &amp;&amp; (d == dim)))</span></div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;<span class="stringliteral">             coupling[c][d] = DoFTools::always;</span></div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;<span class="stringliteral">           else</span></div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;<span class="stringliteral">             coupling[c][d] = DoFTools::none;</span></div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="stringliteral">       DoFTools::make_sparsity_pattern(</span></div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;<span class="stringliteral">         stokes_dof_handler, coupling, dsp, stokes_constraints, false);</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="stringliteral">       stokes_matrix.reinit(dsp);</span></div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;<span class="stringliteral">     }</span></div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;<span class="stringliteral">     {</span></div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;<span class="stringliteral">       Amg_preconditioner.reset();</span></div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;<span class="stringliteral">       Mp_preconditioner.reset();</span></div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;<span class="stringliteral">       stokes_preconditioner_matrix.clear();</span></div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;<span class="stringliteral">       BlockDynamicSparsityPattern dsp(2, 2);</span></div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;<span class="stringliteral">       dsp.block(0, 0).reinit(n_u, n_u);</span></div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;<span class="stringliteral">       dsp.block(0, 1).reinit(n_u, n_p);</span></div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;<span class="stringliteral">       dsp.block(1, 0).reinit(n_p, n_u);</span></div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;<span class="stringliteral">       dsp.block(1, 1).reinit(n_p, n_p);</span></div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;<span class="stringliteral">       dsp.collect_sizes();</span></div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;<span class="stringliteral">       Table&lt;2, DoFTools::Coupling&gt; coupling(dim + 1, dim + 1);</span></div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;<span class="stringliteral">       for (unsigned int c = 0; c &lt; dim + 1; ++c)</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;<span class="stringliteral">         for (unsigned int d = 0; d &lt; dim + 1; ++d)</span></div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;<span class="stringliteral">           if (c == d)</span></div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;<span class="stringliteral">             coupling[c][d] = DoFTools::always;</span></div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;<span class="stringliteral">           else</span></div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;<span class="stringliteral">             coupling[c][d] = DoFTools::none;</span></div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;<span class="stringliteral">       DoFTools::make_sparsity_pattern(</span></div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="stringliteral">         stokes_dof_handler, coupling, dsp, stokes_constraints, false);</span></div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;<span class="stringliteral">       stokes_preconditioner_matrix.reinit(dsp);</span></div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="stringliteral">     }</span></div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="stringliteral">*  The creation of the temperature matrix (or, rather, matrices, since we provide a temperature mass matrix and a temperature stiffness matrix, that will be added together for time discretization) follows the generation of the Stokes matrix &amp;ndash; except that it is much easier here since we do not need to take care of any blocks or coupling between components. Note how we initialize the three temperature matrices: We only use the sparsity pattern for reinitialization of the first matrix, whereas we use the previously generated matrix for the two remaining reinits. The reason for doing so is that reinitialization from an already generated matrix allows Trilinos to reuse the sparsity pattern instead of generating a new one for each copy. This saves both some time and memory.</span></div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="stringliteral">     {</span></div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;<span class="stringliteral">       temperature_mass_matrix.clear();</span></div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;<span class="stringliteral">       temperature_stiffness_matrix.clear();</span></div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="stringliteral">       temperature_matrix.clear();</span></div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;<span class="stringliteral">       DynamicSparsityPattern dsp(n_T, n_T);</span></div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;<span class="stringliteral">       DoFTools::make_sparsity_pattern(temperature_dof_handler,</span></div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;<span class="stringliteral">                                       dsp,</span></div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;<span class="stringliteral">                                       temperature_constraints,</span></div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;<span class="stringliteral">                                       false);</span></div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;<span class="stringliteral">       temperature_matrix.reinit(dsp);</span></div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;<span class="stringliteral">       temperature_mass_matrix.reinit(temperature_matrix);</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;<span class="stringliteral">       temperature_stiffness_matrix.reinit(temperature_matrix);</span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;<span class="stringliteral">     }</span></div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;<span class="stringliteral">*  Lastly, we set the vectors for the Stokes solutions   @f$\mathbf u^{n-1}@f$   and   @f$\mathbf u^{n-2}@f$  , as well as for the temperatures   @f$T^{n}@f$  ,   @f$T^{n-1}@f$   and   @f$T^{n-2}@f$   (required for time stepping) and all the system right hand sides to their correct sizes and block structure:</span></div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;<span class="stringliteral">     IndexSet temperature_partitioning = complete_index_set(n_T);</span></div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;<span class="stringliteral">     stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</span></div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;<span class="stringliteral">     old_stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;<span class="stringliteral">     stokes_rhs.reinit(stokes_partitioning, MPI_COMM_WORLD);</span></div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;<span class="stringliteral">     temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</span></div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;<span class="stringliteral">     old_temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</span></div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;<span class="stringliteral">     old_old_temperature_solution.reinit(temperature_partitioning,</span></div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;<span class="stringliteral">                                         MPI_COMM_WORLD);</span></div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;<span class="stringliteral">     temperature_rhs.reinit(temperature_partitioning, MPI_COMM_WORLD);</span></div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;<span class="stringliteral">   }</span></div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;<span class="stringliteral"> </span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;<span class="stringliteral">*   &lt;a name=&quot;BoussinesqFlowProblemassemble_stokes_preconditioner&quot;&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::assemble_stokes_preconditioner&lt;/h4&gt;   </span></div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;<span class="stringliteral">*   This function assembles the matrix we use for preconditioning the Stokes system. What we need are a vector Laplace matrix on the velocity components and a mass matrix weighted by   @f$\eta^{-1}@f$   on the pressure component. We start by generating a quadrature object of appropriate order, the FEValues object that can give values and gradients at the quadrature points (together with quadrature weights). Next we create data structures for the cell matrix and the relation between local and global DoFs. The vectors   &lt;code&gt;grad_phi_u&lt;/code&gt; and &lt;code&gt;phi_p&lt;/code&gt;   are going to hold the values of the basis functions in order to faster build up the local matrices, as was already done in   @ref step_22 &quot;step-22&quot;  . Before we start the loop over all active cells, we have to specify which components are pressure and which are velocity.</span></div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;<span class="stringliteral">   template &lt;int dim&gt;</span></div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;<span class="stringliteral">   void BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_preconditioner()</span></div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;<span class="stringliteral">   {</span></div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;<span class="stringliteral">     stokes_preconditioner_matrix = 0;</span></div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;<span class="stringliteral">     const QGauss&lt;dim&gt; quadrature_formula(stokes_degree + 2);</span></div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;<span class="stringliteral">     FEValues&lt;dim&gt;     stokes_fe_values(stokes_fe,</span></div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;<span class="stringliteral">                                    quadrature_formula,</span></div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;<span class="stringliteral">                                    update_JxW_values | update_values |</span></div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;<span class="stringliteral">                                      update_gradients);</span></div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="stringliteral">     const unsigned int dofs_per_cell = stokes_fe.n_dofs_per_cell();</span></div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;<span class="stringliteral">     const unsigned int n_q_points    = quadrature_formula.size();</span></div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;<span class="stringliteral">     FullMatrix&lt;double&gt; local_matrix(dofs_per_cell, dofs_per_cell);</span></div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;<span class="stringliteral">     std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</span></div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="stringliteral">     std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(dofs_per_cell);</span></div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;<span class="stringliteral">     std::vector&lt;double&gt;         phi_p(dofs_per_cell);</span></div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;<span class="stringliteral">     const FEValuesExtractors::Vector velocities(0);</span></div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;<span class="stringliteral">     const FEValuesExtractors::Scalar pressure(dim);</span></div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="stringliteral">     for (const auto &amp;cell : stokes_dof_handler.active_cell_iterators())</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;<span class="stringliteral">       {</span></div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="stringliteral">         stokes_fe_values.reinit(cell);</span></div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;<span class="stringliteral">         local_matrix = 0;</span></div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="stringliteral">*  The creation of the local matrix is rather simple. There are only a Laplace term (on the velocity) and a mass matrix weighted by   @f$\eta^{-1}@f$   to be generated, so the creation of the local matrix is done in two lines. Once the local matrix is ready (loop over rows and columns in the local matrix on each quadrature point), we get the local DoF indices and write the local information into the global matrix. We do this as in   @ref step_27 &quot;step-27&quot;  , i.e., we directly apply the constraints from hanging nodes locally. By doing so, we don&#39;</span>t have to <span class="keywordflow">do</span> that afterwards, and we don<span class="stringliteral">&#39;t also write into entries of the matrix that will actually be set to zero again later when eliminating constraints.</span></div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="stringliteral">         for (unsigned int q = 0; q &lt; n_q_points; ++q)</span></div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="stringliteral">           {</span></div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;<span class="stringliteral">             for (unsigned int k = 0; k &lt; dofs_per_cell; ++k)</span></div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;<span class="stringliteral">               {</span></div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;<span class="stringliteral">                 grad_phi_u[k] = stokes_fe_values[velocities].gradient(k, q);</span></div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;<span class="stringliteral">                 phi_p[k]      = stokes_fe_values[pressure].value(k, q);</span></div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;<span class="stringliteral">               }</span></div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;<span class="stringliteral">             for (unsigned int i = 0; i &lt; dofs_per_cell; ++i)</span></div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;<span class="stringliteral">               for (unsigned int j = 0; j &lt; dofs_per_cell; ++j)</span></div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="stringliteral">                 local_matrix(i, j) +=</span></div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;<span class="stringliteral">                   (EquationData::eta</span></div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;<span class="stringliteral">                      scalar_product(grad_phi_u[i], grad_phi_u[j]) +</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="stringliteral">                    (1. / EquationData::eta) phi_p[i] phi_p[j])</span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="stringliteral">                   stokes_fe_values.JxW(q);</span></div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;<span class="stringliteral">           }</span></div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;<span class="stringliteral">         cell-&gt;get_dof_indices(local_dof_indices);</span></div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;<span class="stringliteral">         stokes_constraints.distribute_local_to_global(</span></div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;<span class="stringliteral">           local_matrix, local_dof_indices, stokes_preconditioner_matrix);</span></div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;<span class="stringliteral">       }</span></div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;<span class="stringliteral">   }</span></div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<span class="stringliteral"> </span></div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;<span class="stringliteral">*   &lt;a name=&quot;BoussinesqFlowProblembuild_stokes_preconditioner&quot;&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::build_stokes_preconditioner&lt;/h4&gt;   </span></div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;<span class="stringliteral">*   This function generates the inner preconditioners that are going to be used for the Schur complement block preconditioner. Since the preconditioners need only to be regenerated when the matrices change, this function does not have to do anything in case the matrices have not changed (i.e., the flag   &lt;code&gt;rebuild_stokes_preconditioner&lt;/code&gt;   has the value   &lt;code&gt;false&lt;/code&gt;  ). Otherwise its first task is to call   &lt;code&gt;assemble_stokes_preconditioner&lt;/code&gt;   to generate the preconditioner matrices.   </span></div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;<span class="stringliteral">*   Next, we set up the preconditioner for the velocity-velocity matrix   @f$A@f$  . As explained in the introduction, we are going to use an AMG preconditioner based on a vector Laplace matrix   @f$\hat{A}@f$   (which is spectrally close to the Stokes matrix   @f$A@f$  ). Usually, the   TrilinosWrappers::PreconditionAMG   class can be seen as a good black-box preconditioner which does not need any special knowledge. In this case, however, we have to be careful: since we build an AMG for a vector problem, we have to tell the preconditioner setup which dofs belong to which vector component. We do this using the function   DoFTools::extract_constant_modes,   a function that generates a set of   &lt;code&gt;dim&lt;/code&gt;   vectors, where each one has ones in the respective component of the vector problem and zeros elsewhere. Hence, these are the constant modes on each component, which explains the name of the variable.</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;<span class="stringliteral">   template &lt;int dim&gt;</span></div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;<span class="stringliteral">   void BoussinesqFlowProblem&lt;dim&gt;::build_stokes_preconditioner()</span></div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;<span class="stringliteral">   {</span></div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;<span class="stringliteral">     if (rebuild_stokes_preconditioner == false)</span></div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;<span class="stringliteral">       return;</span></div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;<span class="stringliteral">     std::cout &lt;&lt; &quot;   Rebuilding Stokes preconditioner...&quot; &lt;&lt; std::flush;</span></div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;<span class="stringliteral">     assemble_stokes_preconditioner();</span></div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;<span class="stringliteral">     Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionAMG&gt;();</span></div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;<span class="stringliteral">     std::vector&lt;std::vector&lt;bool&gt;&gt; constant_modes;</span></div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;<span class="stringliteral">     FEValuesExtractors::Vector     velocity_components(0);</span></div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;<span class="stringliteral">     DoFTools::extract_constant_modes(stokes_dof_handler,</span></div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;<span class="stringliteral">                                      stokes_fe.component_mask(</span></div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;<span class="stringliteral">                                        velocity_components),</span></div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="stringliteral">                                      constant_modes);</span></div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;<span class="stringliteral">     TrilinosWrappers::PreconditionAMG::AdditionalData amg_data;</span></div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;<span class="stringliteral">     amg_data.constant_modes = constant_modes;</span></div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;<span class="stringliteral">*  Next, we set some more options of the AMG preconditioner. In particular, we need to tell the AMG setup that we use quadratic basis functions for the velocity matrix (this implies more nonzero elements in the matrix, so that a more robust algorithm needs to be chosen internally). Moreover, we want to be able to control how the coarsening structure is build up. The way the Trilinos smoothed aggregation AMG does this is to look which matrix entries are of similar size as the diagonal entry in order to algebraically build a coarse-grid structure. By setting the parameter   &lt;code&gt;aggregation_threshold&lt;/code&gt;   to 0.02, we specify that all entries that are more than two percent of size of some diagonal pivots in that row should form one coarse grid point. This parameter is rather ad hoc, and some fine-tuning of it can influence the performance of the preconditioner. As a rule of thumb, larger values of   &lt;code&gt;aggregation_threshold&lt;/code&gt;   will decrease the number of iterations, but increase the costs per iteration. A look at the Trilinos documentation will provide more information on these parameters. With this data set, we then initialize the preconditioner with the matrix we want it to apply to.     </span></div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;<span class="stringliteral">*   Finally, we also initialize the preconditioner for the inversion of the pressure mass matrix. This matrix is symmetric and well-behaved, so we can chose a simple preconditioner. We stick with an incomplete Cholesky (IC) factorization preconditioner, which is designed for symmetric matrices. We could have also chosen an SSOR preconditioner with relaxation factor around 1.2, but IC is cheaper for our example. We wrap the preconditioners into a   &lt;code&gt;std::shared_ptr&lt;/code&gt;   pointer, which makes it easier to recreate the preconditioner next time around since we do not have to care about destroying the previously used object.</span></div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;<span class="stringliteral">     amg_data.elliptic              = true;</span></div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;<span class="stringliteral">     amg_data.higher_order_elements = true;</span></div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;<span class="stringliteral">     amg_data.smoother_sweeps       = 2;</span></div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;<span class="stringliteral">     amg_data.aggregation_threshold = 0.02;</span></div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;<span class="stringliteral">     Amg_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(0, 0),</span></div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;<span class="stringliteral">                                    amg_data);</span></div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;<span class="stringliteral">     Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</span></div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;<span class="stringliteral">     Mp_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(1, 1));</span></div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;<span class="stringliteral">     std::cout &lt;&lt; std::endl;</span></div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;<span class="stringliteral">     rebuild_stokes_preconditioner = false;</span></div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;<span class="stringliteral">   }</span></div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;<span class="stringliteral"> </span></div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;<span class="stringliteral">*   &lt;a name=&quot;BoussinesqFlowProblemassemble_stokes_system&quot;&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::assemble_stokes_system&lt;/h4&gt;   </span></div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;<span class="stringliteral">*   The time lag scheme we use for advancing the coupled Stokes-temperature system forces us to split up the assembly (and the solution of linear systems) into two step. The first one is to create the Stokes system matrix and right hand side, and the second is to create matrix and right hand sides for the temperature dofs, which depends on the result of the linear system for the velocity.   </span></div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;<span class="stringliteral">*   This function is called at the beginning of each time step. In the first time step or if the mesh has changed, indicated by the   &lt;code&gt;rebuild_stokes_matrix&lt;/code&gt;  , we need to assemble the Stokes matrix; on the other hand, if the mesh hasn&#39;</span>t changed and the <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> is already available, <span class="keyword">this</span> is not necessary and all we need to <span class="keywordflow">do</span> is <a class="code" href="namespaceinternal.html#a2b3d48efdf7c94da455dc6a3553bab79">assemble</a> the right hand side vector which changes in each time step.   </div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;*   Regarding the technical details of implementation, not much has changed from   @ref step_22 <span class="stringliteral">&quot;step-22&quot;</span>  . We reset <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> and vector, create a quadrature formula on the cells, and then create the respective <a class="code" href="classFEValues.html">FEValues</a> <span class="keywordtype">object</span>. For the update flags, we require basis <span class="keyword">function</span> derivatives only in <span class="keywordflow">case</span> of a full assembly, since they are not needed <span class="keywordflow">for</span> the right hand side; as <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">always</a>, choosing the minimal <span class="keyword">set</span> of flags depending on what is currently needed makes the <a class="code" href="namespaceThreads_1_1internal.html#a8d237a30d09b13e0b5adbe0fd1dfb188">call</a> to   <a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a>   further down in the program more efficient.   </div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;*   There is <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> thing that needs to be commented &amp;ndash; since we have a separate finite element and <a class="code" href="classDoFHandler.html">DoFHandler</a> <span class="keywordflow">for</span> the temperature, we need to generate a <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> <a class="code" href="classFEValues.html">FEValues</a> <span class="keywordtype">object</span> <span class="keywordflow">for</span> the proper evaluation of the temperature solution. This isn<span class="stringliteral">&#39;t too complicated to realize here: just use the temperature structures and set an update flag for the basis function values which we need for evaluation of the temperature solution. The only important part to remember here is that the same quadrature formula is used for both FEValues objects to ensure that we get matching information when we loop over the quadrature points of the two objects.   </span></div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;<span class="stringliteral">*   The declarations proceed with some shortcuts for array sizes, the creation of the local matrix and right hand side as well as the vector for the indices of the local dofs compared to the global system.</span></div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;<span class="stringliteral">   template &lt;int dim&gt;</span></div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;<span class="stringliteral">   void BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_system()</span></div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;<span class="stringliteral">   {</span></div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;<span class="stringliteral">     std::cout &lt;&lt; &quot;   Assembling...&quot; &lt;&lt; std::flush;</span></div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;<span class="stringliteral">     if (rebuild_stokes_matrix == true)</span></div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;<span class="stringliteral">       stokes_matrix = 0;</span></div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;<span class="stringliteral">     stokes_rhs = 0;</span></div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;<span class="stringliteral">     const QGauss&lt;dim&gt; quadrature_formula(stokes_degree + 2);</span></div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;<span class="stringliteral">     FEValues&lt;dim&gt;     stokes_fe_values(</span></div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;<span class="stringliteral">       stokes_fe,</span></div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;<span class="stringliteral">       quadrature_formula,</span></div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;<span class="stringliteral">       update_values | update_quadrature_points | update_JxW_values |</span></div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;<span class="stringliteral">         (rebuild_stokes_matrix == true ? update_gradients : UpdateFlags(0)));</span></div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="stringliteral">     FEValues&lt;dim&gt; temperature_fe_values(temperature_fe,</span></div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;<span class="stringliteral">                                         quadrature_formula,</span></div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;<span class="stringliteral">                                         update_values);</span></div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;<span class="stringliteral">     const unsigned int dofs_per_cell = stokes_fe.n_dofs_per_cell();</span></div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;<span class="stringliteral">     const unsigned int n_q_points    = quadrature_formula.size();</span></div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;<span class="stringliteral">     FullMatrix&lt;double&gt; local_matrix(dofs_per_cell, dofs_per_cell);</span></div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;<span class="stringliteral">     Vector&lt;double&gt;     local_rhs(dofs_per_cell);</span></div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;<span class="stringliteral">     std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</span></div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;<span class="stringliteral">*  Next we need a vector that will contain the values of the temperature solution at the previous time level at the quadrature points to assemble the source term in the right hand side of the momentum equation. Let&#39;</span>s <a class="code" href="namespaceThreads_1_1internal.html#a8d237a30d09b13e0b5adbe0fd1dfb188">call</a> <span class="keyword">this</span> vector   &lt;code&gt;old_solution_values&lt;/code&gt;  .     </div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;*   The <span class="keyword">set</span> of vectors we create next hold the evaluations of the basis functions as well as their <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">gradients</a> and symmetrized <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">gradients</a> that will be used <span class="keywordflow">for</span> creating the matrices. Putting these into their own arrays rather than asking the <a class="code" href="classFEValues.html">FEValues</a> <span class="keywordtype">object</span> <span class="keywordflow">for</span> <span class="keyword">this</span> information each time it is needed is an optimization to accelerate the assembly process, see   @ref step_22 <span class="stringliteral">&quot;step-22&quot;</span>   <span class="keywordflow">for</span> details.     </div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;*   The last two declarations are used to <a class="code" href="namespaceTensorAccessors.html#a5798da96660fa8e6798917501d65dbd8">extract</a> the individual blocks (velocity, pressure, temperature) from the total FE system.</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;* </div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;* </div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;* @code</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;     std::vector&lt;double&gt; old_temperature_values(n_q_points);</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;* </div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;     std::vector&lt;Tensor&lt;1, dim&gt;&gt;          phi_u(dofs_per_cell);</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;     std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; grads_phi_u(dofs_per_cell);</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;     std::vector&lt;double&gt;                  div_phi_u(dofs_per_cell);</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;     std::vector&lt;double&gt;                  phi_p(dofs_per_cell);</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;* </div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;     <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;     <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;* </div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;* </div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;*  Now start the <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> over all cells in the problem. We are working on two different DoFHandlers <span class="keywordflow">for</span> <span class="keyword">this</span> assembly routine, so we must have two different cell iterators <span class="keywordflow">for</span> the two objects in use. This might seem a bit peculiar, since both the Stokes system and the temperature system use the same grid, but that<span class="stringliteral">&#39;s the only way to keep degrees of freedom in sync. The first statements within the loop are again all very familiar, doing the update of the finite element data as specified by the update flags, zeroing out the local arrays and getting the values of the old solution at the quadrature points. Then we are ready to loop over the quadrature points on the cell.</span></div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;<span class="stringliteral">     auto       cell             = stokes_dof_handler.begin_active();</span></div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="stringliteral">     const auto endc             = stokes_dof_handler.end();</span></div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;<span class="stringliteral">     auto       temperature_cell = temperature_dof_handler.begin_active();</span></div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;<span class="stringliteral">     for (; cell != endc; ++cell, ++temperature_cell)</span></div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;<span class="stringliteral">       {</span></div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;<span class="stringliteral">         stokes_fe_values.reinit(cell);</span></div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;<span class="stringliteral">         temperature_fe_values.reinit(temperature_cell);</span></div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;<span class="stringliteral">         local_matrix = 0;</span></div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="stringliteral">         local_rhs    = 0;</span></div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;<span class="stringliteral">         temperature_fe_values.get_function_values(old_temperature_solution,</span></div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="stringliteral">                                                   old_temperature_values);</span></div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;<span class="stringliteral">         for (unsigned int q = 0; q &lt; n_q_points; ++q)</span></div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;<span class="stringliteral">           {</span></div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="stringliteral">             const double old_temperature = old_temperature_values[q];</span></div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;<span class="stringliteral">*  Next we extract the values and gradients of basis functions relevant to the terms in the inner products. As shown in   @ref step_22 &quot;step-22&quot;   this helps accelerate assembly.             </span></div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;<span class="stringliteral">*   Once this is done, we start the loop over the rows and columns of the local matrix and feed the matrix with the relevant products. The right hand side is filled with the forcing term driven by temperature in direction of gravity (which is vertical in our example).  Note that the right hand side term is always generated, whereas the matrix contributions are only updated when it is requested by the   &lt;code&gt;rebuild_matrices&lt;/code&gt;   flag.</span></div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;<span class="stringliteral">             for (unsigned int k = 0; k &lt; dofs_per_cell; ++k)</span></div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;<span class="stringliteral">               {</span></div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;<span class="stringliteral">                 phi_u[k] = stokes_fe_values[velocities].value(k, q);</span></div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;<span class="stringliteral">                 if (rebuild_stokes_matrix)</span></div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;<span class="stringliteral">                   {</span></div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;<span class="stringliteral">                     grads_phi_u[k] =</span></div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;<span class="stringliteral">                       stokes_fe_values[velocities].symmetric_gradient(k, q);</span></div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;<span class="stringliteral">                     div_phi_u[k] =</span></div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;<span class="stringliteral">                       stokes_fe_values[velocities].divergence(k, q);</span></div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;<span class="stringliteral">                     phi_p[k] = stokes_fe_values[pressure].value(k, q);</span></div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;<span class="stringliteral">                   }</span></div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;<span class="stringliteral">               }</span></div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;<span class="stringliteral">             if (rebuild_stokes_matrix)</span></div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;<span class="stringliteral">               for (unsigned int i = 0; i &lt; dofs_per_cell; ++i)</span></div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;<span class="stringliteral">                 for (unsigned int j = 0; j &lt; dofs_per_cell; ++j)</span></div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;<span class="stringliteral">                   local_matrix(i, j) +=</span></div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;<span class="stringliteral">                     (EquationData::eta 2 (grads_phi_u[i] grads_phi_u[j])</span></div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;<span class="stringliteral">-</span></div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;<span class="stringliteral">                      div_phi_u[i] phi_p[j]</span></div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;<span class="stringliteral">- phi_p[i] div_phi_u[j])</span></div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;<span class="stringliteral">                     stokes_fe_values.JxW(q);</span></div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;<span class="stringliteral">             const Point&lt;dim&gt; gravity =</span></div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;<span class="stringliteral">-((dim == 2) ? (Point&lt;dim&gt;(0, 1)) : (Point&lt;dim&gt;(0, 0, 1)));</span></div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;<span class="stringliteral">             for (unsigned int i = 0; i &lt; dofs_per_cell; ++i)</span></div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;<span class="stringliteral">               local_rhs(i) += (-EquationData::density EquationData::beta</span></div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;<span class="stringliteral">                                gravity phi_u[i] old_temperature)</span></div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;<span class="stringliteral">                               stokes_fe_values.JxW(q);</span></div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;<span class="stringliteral">           }</span></div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;<span class="stringliteral">*  The last step in the loop over all cells is to enter the local contributions into the global matrix and vector structures to the positions specified in   &lt;code&gt;local_dof_indices&lt;/code&gt;  .  Again, we let the AffineConstraints class do the insertion of the cell matrix elements to the global matrix, which already condenses the hanging node constraints.</span></div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;<span class="stringliteral">         cell-&gt;get_dof_indices(local_dof_indices);</span></div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;<span class="stringliteral">         if (rebuild_stokes_matrix == true)</span></div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;<span class="stringliteral">           stokes_constraints.distribute_local_to_global(local_matrix,</span></div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;<span class="stringliteral">                                                         local_rhs,</span></div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;<span class="stringliteral">                                                         local_dof_indices,</span></div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;<span class="stringliteral">                                                         stokes_matrix,</span></div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;<span class="stringliteral">                                                         stokes_rhs);</span></div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;<span class="stringliteral">         else</span></div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;<span class="stringliteral">           stokes_constraints.distribute_local_to_global(local_rhs,</span></div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;<span class="stringliteral">                                                         local_dof_indices,</span></div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;<span class="stringliteral">                                                         stokes_rhs);</span></div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;<span class="stringliteral">       }</span></div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;<span class="stringliteral">     rebuild_stokes_matrix = false;</span></div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;<span class="stringliteral">     std::cout &lt;&lt; std::endl;</span></div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;<span class="stringliteral">   }</span></div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;<span class="stringliteral"> </span></div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;<span class="stringliteral">*   &lt;a name=&quot;BoussinesqFlowProblemassemble_temperature_matrix&quot;&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::assemble_temperature_matrix&lt;/h4&gt;   </span></div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;<span class="stringliteral">*   This function assembles the matrix in the temperature equation. The temperature matrix consists of two parts, a mass matrix and the time step size times a stiffness matrix given by a Laplace term times the amount of diffusion. Since the matrix depends on the time step size (which varies from one step to another), the temperature matrix needs to be updated every time step. We could simply regenerate the matrices in every time step, but this is not really efficient since mass and Laplace matrix do only change when we change the mesh. Hence, we do this more efficiently by generating two separate matrices in this function, one for the mass matrix and one for the stiffness (diffusion) matrix. We will then sum up the matrix plus the stiffness matrix times the time step size once we know the actual time step.   </span></div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;<span class="stringliteral">*   So the details for this first step are very simple. In case we need to rebuild the matrix (i.e., the mesh has changed), we zero the data structures, get a quadrature formula and a FEValues object, and create local matrices, local dof indices and evaluation structures for the basis functions.</span></div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;<span class="stringliteral">   template &lt;int dim&gt;</span></div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;<span class="stringliteral">   void BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_matrix()</span></div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;<span class="stringliteral">   {</span></div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;<span class="stringliteral">     if (rebuild_temperature_matrices == false)</span></div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;<span class="stringliteral">       return;</span></div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;<span class="stringliteral">     temperature_mass_matrix      = 0;</span></div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;<span class="stringliteral">     temperature_stiffness_matrix = 0;</span></div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;<span class="stringliteral">     QGauss&lt;dim&gt;   quadrature_formula(temperature_degree + 2);</span></div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;<span class="stringliteral">     FEValues&lt;dim&gt; temperature_fe_values(temperature_fe,</span></div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;<span class="stringliteral">                                         quadrature_formula,</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="stringliteral">                                         update_values | update_gradients |</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;<span class="stringliteral">                                           update_JxW_values);</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="stringliteral">     const unsigned int dofs_per_cell = temperature_fe.n_dofs_per_cell();</span></div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;<span class="stringliteral">     const unsigned int n_q_points    = quadrature_formula.size();</span></div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;<span class="stringliteral">     FullMatrix&lt;double&gt; local_mass_matrix(dofs_per_cell, dofs_per_cell);</span></div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;<span class="stringliteral">     FullMatrix&lt;double&gt; local_stiffness_matrix(dofs_per_cell, dofs_per_cell);</span></div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;<span class="stringliteral">     std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</span></div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;<span class="stringliteral">     std::vector&lt;double&gt;         phi_T(dofs_per_cell);</span></div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;<span class="stringliteral">     std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(dofs_per_cell);</span></div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;<span class="stringliteral">*  Now, let&#39;</span>s start the <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> over all cells in the <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>. We need to zero out the local matrices, update the finite element evaluations, and then <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> over the rows and columns of the matrices on each quadrature <a class="code" href="namespaceOpenCASCADE.html#a9509efa83e3b2fa42616fe0623cba696">point</a>, where we then create the mass <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> and the stiffness <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> (Laplace terms times the diffusion   &lt;code&gt;EquationData::kappa&lt;/code&gt;  . Finally, we let the constraints <span class="keywordtype">object</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81">insert</a> these <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a> into the global <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>, and directly condense the constraints into the matrix.</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;* </div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;* </div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;* @code</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;     for (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : temperature_dof_handler.active_cell_iterators())</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;       {</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;         local_mass_matrix      = 0;</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;         local_stiffness_matrix = 0;</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;* </div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;         temperature_fe_values.reinit(cell);</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;* </div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;           {</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;               {</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;                 grad_phi_T[k] = temperature_fe_values.shape_grad(k, q);</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;                 phi_T[k]      = temperature_fe_values.shape_value(k, q);</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;               }</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;* </div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;               <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                 {</div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;                   local_mass_matrix(i, j) +=</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;                     (phi_T[i] phi_T[j] temperature_fe_values.JxW(q));</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;                   local_stiffness_matrix(i, j) +=</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;                     (EquationData::kappa grad_phi_T[i] grad_phi_T[j]</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;                      temperature_fe_values.JxW(q));</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;                 }</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;           }</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;* </div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;         cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;* </div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;         temperature_constraints.distribute_local_to_global(</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;           local_mass_matrix, local_dof_indices, temperature_mass_matrix);</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;         temperature_constraints.distribute_local_to_global(</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;           local_stiffness_matrix,</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;           local_dof_indices,</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;           temperature_stiffness_matrix);</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;       }</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;* </div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;     rebuild_temperature_matrices = <span class="keyword">false</span>;</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;   }</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;* </div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160; </div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;* </div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;* </div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;*   &lt;a name=<span class="stringliteral">&quot;BoussinesqFlowProblemassemble_temperature_system&quot;</span>&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::assemble_temperature_system&lt;/h4&gt;   </div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;*   This <span class="keyword">function</span> does the <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> part of the assembly work on the temperature <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>, the actual addition of pressure mass and stiffness <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> (where the time step size comes into play), as well as the creation of the velocity-dependent right hand side. The declarations <span class="keywordflow">for</span> the right hand side assembly in <span class="keyword">this</span> <span class="keyword">function</span> are pretty much the same as the ones used in the other assembly routines, except that we restrict ourselves to vectors <span class="keyword">this</span> time. We are going to calculate residuals on the temperature system, which means that we have to evaluate <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> derivatives, specified by the update flag   &lt;code&gt;<a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a>&lt;/code&gt;  .   </div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;*   The temperature equation is coupled to the Stokes system by means of the fluid velocity. These two parts of the solution are associated with different DoFHandlers, so we again need to create a <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> <a class="code" href="classFEValues.html">FEValues</a> <span class="keywordtype">object</span> <span class="keywordflow">for</span> the evaluation of the velocity at the quadrature points.</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;* </div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;* </div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;* @code</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;   <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_system(</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity)</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;   {</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;* </div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;     <span class="keywordflow">if</span> (use_bdf2_scheme == <span class="keyword">true</span>)</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;       {</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;         temperature_matrix.copy_from(temperature_mass_matrix);</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;         temperature_matrix=</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;           (2 time_step + old_time_step) / (time_step + old_time_step);</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;         temperature_matrix.add(time_step, temperature_stiffness_matrix);</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;       }</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;     <span class="keywordflow">else</span></div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;       {</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;         temperature_matrix.copy_from(temperature_mass_matrix);</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;         temperature_matrix.add(time_step, temperature_stiffness_matrix);</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;       }</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;* </div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;     temperature_rhs = 0;</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;* </div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;     <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(temperature_degree + 2);</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     temperature_fe_values(temperature_fe,</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;                                         quadrature_formula,</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;                                         <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;                                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> |</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;                                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;                                           <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;                                    quadrature_formula,</div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;                                    <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;* </div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = temperature_fe.n_dofs_per_cell();</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.size();</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;* </div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;     <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(dofs_per_cell);</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;* </div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;     std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;* </div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;* </div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;*  Next comes the declaration of vectors to hold the old and older solution <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a> (as a notation <span class="keywordflow">for</span> time levels   @f$n-1@f$   and   @f$n-2@f$  , respectively) and <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">gradients</a> at quadrature points of the current cell. We also declare an <span class="keywordtype">object</span> to hold the temperature right hand side <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a> (  &lt;code&gt;gamma_values&lt;/code&gt;  ), and we again use shortcuts <span class="keywordflow">for</span> the temperature basis functions. Eventually, we need to find the temperature extrema and the <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">diameter</a> of the computational domain which will be used <span class="keywordflow">for</span> the definition of the stabilization parameter (we got the maximal velocity as an input to <span class="keyword">this</span> <span class="keyword">function</span>).</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;* </div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;* </div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;* @code</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;     std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_velocity_values(n_q_points);</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;     std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_velocity_values(n_q_points);</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;     std::vector&lt;double&gt;         old_temperature_values(n_q_points);</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;     std::vector&lt;double&gt;         old_old_temperature_values(n_q_points);</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;     std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_temperature_grads(n_q_points);</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;     std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_temperature_grads(n_q_points);</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;     std::vector&lt;double&gt;         old_temperature_laplacians(n_q_points);</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;     std::vector&lt;double&gt;         old_old_temperature_laplacians(n_q_points);</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;* </div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;     EquationData::TemperatureRightHandSide&lt;dim&gt; temperature_right_hand_side;</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;     std::vector&lt;double&gt;                         gamma_values(n_q_points);</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;* </div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;     std::vector&lt;double&gt;         phi_T(dofs_per_cell);</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;     std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(dofs_per_cell);</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;* </div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;     <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range =</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;       get_extrapolated_temperature_range();</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;* </div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;     <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;* </div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;* </div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;*  Now, let<span class="stringliteral">&#39;s start the loop over all cells in the triangulation. Again, we need two cell iterators that walk in parallel through the cells of the two involved DoFHandler objects for the Stokes and temperature part. Within the loop, we first set the local rhs to zero, and then get the values and derivatives of the old solution functions at the quadrature points, since they are going to be needed for the definition of the stabilization parameters and as coefficients in the equation, respectively. Note that since the temperature has its own DoFHandler and FEValues object we get the entire solution at the quadrature point (which is the scalar temperature field only anyway) whereas for the Stokes part we restrict ourselves to extracting the velocity part (and ignoring the pressure part) by using   &lt;code&gt;stokes_fe_values[velocities].get_function_values&lt;/code&gt;  .</span></div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;<span class="stringliteral">     auto       cell        = temperature_dof_handler.begin_active();</span></div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;<span class="stringliteral">     const auto endc        = temperature_dof_handler.end();</span></div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="stringliteral">     auto       stokes_cell = stokes_dof_handler.begin_active();</span></div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="stringliteral">     for (; cell != endc; ++cell, ++stokes_cell)</span></div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;<span class="stringliteral">       {</span></div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;<span class="stringliteral">         local_rhs = 0;</span></div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;<span class="stringliteral">         temperature_fe_values.reinit(cell);</span></div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;<span class="stringliteral">         stokes_fe_values.reinit(stokes_cell);</span></div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="stringliteral">         temperature_fe_values.get_function_values(old_temperature_solution,</span></div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;<span class="stringliteral">                                                   old_temperature_values);</span></div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;<span class="stringliteral">         temperature_fe_values.get_function_values(old_old_temperature_solution,</span></div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;<span class="stringliteral">                                                   old_old_temperature_values);</span></div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;<span class="stringliteral">         temperature_fe_values.get_function_gradients(old_temperature_solution,</span></div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;<span class="stringliteral">                                                      old_temperature_grads);</span></div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;<span class="stringliteral">         temperature_fe_values.get_function_gradients(</span></div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;<span class="stringliteral">           old_old_temperature_solution, old_old_temperature_grads);</span></div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;<span class="stringliteral">         temperature_fe_values.get_function_laplacians(</span></div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;<span class="stringliteral">           old_temperature_solution, old_temperature_laplacians);</span></div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;<span class="stringliteral">         temperature_fe_values.get_function_laplacians(</span></div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;<span class="stringliteral">           old_old_temperature_solution, old_old_temperature_laplacians);</span></div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;<span class="stringliteral">         temperature_right_hand_side.value_list(</span></div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;<span class="stringliteral">           temperature_fe_values.get_quadrature_points(), gamma_values);</span></div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;<span class="stringliteral">         stokes_fe_values[velocities].get_function_values(stokes_solution,</span></div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;<span class="stringliteral">                                                          old_velocity_values);</span></div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;<span class="stringliteral">         stokes_fe_values[velocities].get_function_values(</span></div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;<span class="stringliteral">           old_stokes_solution, old_old_velocity_values);</span></div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;<span class="stringliteral">*  Next, we calculate the artificial viscosity for stabilization according to the discussion in the introduction using the dedicated function. With that at hand, we can get into the loop over quadrature points and local rhs vector components. The terms here are quite lengthy, but their definition follows the time-discrete system developed in the introduction of this program. The BDF-2 scheme needs one more term from the old time step (and involves more complicated factors) than the backward Euler scheme that is used for the first time step. When all this is done, we distribute the local vector into the global one (including hanging node constraints).</span></div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;<span class="stringliteral">         const double nu =</span></div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;<span class="stringliteral">           compute_viscosity(old_temperature_values,</span></div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;<span class="stringliteral">                             old_old_temperature_values,</span></div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;<span class="stringliteral">                             old_temperature_grads,</span></div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;<span class="stringliteral">                             old_old_temperature_grads,</span></div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;<span class="stringliteral">                             old_temperature_laplacians,</span></div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;<span class="stringliteral">                             old_old_temperature_laplacians,</span></div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;<span class="stringliteral">                             old_velocity_values,</span></div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;<span class="stringliteral">                             old_old_velocity_values,</span></div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;<span class="stringliteral">                             gamma_values,</span></div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;<span class="stringliteral">                             maximal_velocity,</span></div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;<span class="stringliteral">                             global_T_range.second</span></div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;<span class="stringliteral">- global_T_range.first,</span></div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;<span class="stringliteral">                             cell-&gt;diameter());</span></div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;<span class="stringliteral">         for (unsigned int q = 0; q &lt; n_q_points; ++q)</span></div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;<span class="stringliteral">           {</span></div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;<span class="stringliteral">             for (unsigned int k = 0; k &lt; dofs_per_cell; ++k)</span></div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="stringliteral">               {</span></div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;<span class="stringliteral">                 grad_phi_T[k] = temperature_fe_values.shape_grad(k, q);</span></div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;<span class="stringliteral">                 phi_T[k]      = temperature_fe_values.shape_value(k, q);</span></div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;<span class="stringliteral">               }</span></div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;<span class="stringliteral">             const double T_term_for_rhs =</span></div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;<span class="stringliteral">               (use_bdf2_scheme ?</span></div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;<span class="stringliteral">                  (old_temperature_values[q] (1 + time_step / old_time_step)</span></div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;<span class="stringliteral">-</span></div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;<span class="stringliteral">                   old_old_temperature_values[q] (time_step time_step) /</span></div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;<span class="stringliteral">                     (old_time_step (time_step + old_time_step))) :</span></div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;<span class="stringliteral">                  old_temperature_values[q]);</span></div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;<span class="stringliteral">             const Tensor&lt;1, dim&gt; ext_grad_T =</span></div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;<span class="stringliteral">               (use_bdf2_scheme ?</span></div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;<span class="stringliteral">                  (old_temperature_grads[q] (1 + time_step / old_time_step)</span></div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;<span class="stringliteral">-</span></div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;<span class="stringliteral">                   old_old_temperature_grads[q] time_step / old_time_step) :</span></div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;<span class="stringliteral">                  old_temperature_grads[q]);</span></div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;<span class="stringliteral">             const Tensor&lt;1, dim&gt; extrapolated_u =</span></div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;<span class="stringliteral">               (use_bdf2_scheme ?</span></div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;<span class="stringliteral">                  (old_velocity_values[q] (1 + time_step / old_time_step)</span></div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;<span class="stringliteral">-</span></div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;<span class="stringliteral">                   old_old_velocity_values[q] time_step / old_time_step) :</span></div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;<span class="stringliteral">                  old_velocity_values[q]);</span></div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;<span class="stringliteral">             for (unsigned int i = 0; i &lt; dofs_per_cell; ++i)</span></div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="stringliteral">               local_rhs(i) +=</span></div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;<span class="stringliteral">                 (T_term_for_rhs phi_T[i]</span></div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;<span class="stringliteral">-</span></div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;<span class="stringliteral">                  time_step extrapolated_u ext_grad_T phi_T[i]</span></div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;<span class="stringliteral">-</span></div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;<span class="stringliteral">                  time_step nu ext_grad_T grad_phi_T[i] +</span></div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;<span class="stringliteral">                  time_step gamma_values[q] phi_T[i])</span></div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;<span class="stringliteral">                 temperature_fe_values.JxW(q);</span></div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;<span class="stringliteral">           }</span></div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;<span class="stringliteral">         cell-&gt;get_dof_indices(local_dof_indices);</span></div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;<span class="stringliteral">         temperature_constraints.distribute_local_to_global(local_rhs,</span></div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;<span class="stringliteral">                                                            local_dof_indices,</span></div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;<span class="stringliteral">                                                            temperature_rhs);</span></div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;<span class="stringliteral">       }</span></div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;<span class="stringliteral">   }</span></div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;<span class="stringliteral"> </span></div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;<span class="stringliteral">*   &lt;a name=&quot;BoussinesqFlowProblemsolve&quot;&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::solve&lt;/h4&gt;   </span></div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;<span class="stringliteral">*   This function solves the linear systems of equations. Following the introduction, we start with the Stokes system, where we need to generate our block Schur preconditioner. Since all the relevant actions are implemented in the class   &lt;code&gt;BlockSchurPreconditioner&lt;/code&gt;  , all we have to do is to initialize the class appropriately. What we need to pass down is an   &lt;code&gt;InverseMatrix&lt;/code&gt;   object for the pressure mass matrix, which we set up using the respective class together with the IC preconditioner we already generated, and the AMG preconditioner for the velocity-velocity matrix. Note that both   &lt;code&gt;Mp_preconditioner&lt;/code&gt;   and   &lt;code&gt;Amg_preconditioner&lt;/code&gt;   are only pointers, so we use   &lt;code&gt;*&lt;/code&gt;   to pass down the actual preconditioner objects.   </span></div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="stringliteral">*   Once the preconditioner is ready, we create a GMRES solver for the block system. Since we are working with Trilinos data structures, we have to set the respective template argument in the solver. GMRES needs to internally store temporary vectors for each iteration (see the discussion in the results section of   @ref step_22 &quot;step-22&quot;  ) &amp;ndash; the more vectors it can use, the better it will generally perform. To keep memory demands in check, we set the number of vectors to 100. This means that up to 100 solver iterations, every temporary vector can be stored. If the solver needs to iterate more often to get the specified tolerance, it will work on a reduced set of vectors by restarting at every 100 iterations.   </span></div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;<span class="stringliteral">*   With this all set up, we solve the system and distribute the constraints in the Stokes system, i.e., hanging nodes and no-flux boundary condition, in order to have the appropriate solution values even at constrained dofs. Finally, we write the number of iterations to the screen.</span></div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;<span class="stringliteral">   template &lt;int dim&gt;</span></div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;<span class="stringliteral">   void BoussinesqFlowProblem&lt;dim&gt;::solve()</span></div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;<span class="stringliteral">   {</span></div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;<span class="stringliteral">     std::cout &lt;&lt; &quot;   Solving...&quot; &lt;&lt; std::endl;</span></div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;<span class="stringliteral">     {</span></div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;<span class="stringliteral">       const LinearSolvers::InverseMatrix&lt;TrilinosWrappers::SparseMatrix,</span></div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;<span class="stringliteral">                                          TrilinosWrappers::PreconditionIC&gt;</span></div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;<span class="stringliteral">         mp_inverse(stokes_preconditioner_matrix.block(1, 1),</span></div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;<span class="stringliteral">                   Mp_preconditioner);</span></div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;<span class="stringliteral">       const LinearSolvers::BlockSchurPreconditioner&lt;</span></div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="stringliteral">         TrilinosWrappers::PreconditionAMG,</span></div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;<span class="stringliteral">         TrilinosWrappers::PreconditionIC&gt;</span></div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;<span class="stringliteral">         preconditioner(stokes_matrix, mp_inverse,Amg_preconditioner);</span></div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;<span class="stringliteral">       SolverControl solver_control(stokes_matrix.m(),</span></div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;<span class="stringliteral">                                    1e-6 stokes_rhs.l2_norm());</span></div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;<span class="stringliteral">       SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt; gmres(</span></div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;<span class="stringliteral">         solver_control,</span></div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;<span class="stringliteral">         SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData(100));</span></div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;<span class="stringliteral">       for (unsigned int i = 0; i &lt; stokes_solution.size(); ++i)</span></div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;<span class="stringliteral">         if (stokes_constraints.is_constrained(i))</span></div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;<span class="stringliteral">           stokes_solution(i) = 0;</span></div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;<span class="stringliteral">       gmres.solve(stokes_matrix, stokes_solution, stokes_rhs, preconditioner);</span></div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;<span class="stringliteral">       stokes_constraints.distribute(stokes_solution);</span></div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;<span class="stringliteral">       std::cout &lt;&lt; &quot;   &quot; &lt;&lt; solver_control.last_step()</span></div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;<span class="stringliteral">                 &lt;&lt; &quot; GMRES iterations for Stokes subsystem.&quot; &lt;&lt; std::endl;</span></div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;<span class="stringliteral">     }</span></div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;<span class="stringliteral">*  Once we know the Stokes solution, we can determine the new time step from the maximal velocity. We have to do this to satisfy the CFL condition since convection terms are treated explicitly in the temperature equation, as discussed in the introduction. The exact form of the formula used here for the time step is discussed in the results section of this program.     </span></div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;<span class="stringliteral">*   There is a snatch here. The formula contains a division by the maximum value of the velocity. However, at the start of the computation, we have a constant temperature field (we start with a constant temperature, and it will be nonconstant only after the first time step during which the source acts). Constant temperature means that no buoyancy acts, and so the velocity is zero. Dividing by it will not likely lead to anything good.     </span></div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;<span class="stringliteral">*   To avoid the resulting infinite time step, we ask whether the maximal velocity is very small (in particular smaller than the values we encounter during any of the following time steps) and if so rather than dividing by zero we just divide by a small value, resulting in a large but finite time step.</span></div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;<span class="stringliteral">     old_time_step                 = time_step;</span></div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;<span class="stringliteral">     const double maximal_velocity = get_maximal_velocity();</span></div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;<span class="stringliteral">     if (maximal_velocity &gt;= 0.01)</span></div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;<span class="stringliteral">       time_step = 1. / (1.7 dim std::sqrt(1. dim)) / temperature_degree</span></div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;<span class="stringliteral">                   GridTools::minimal_cell_diameter(triangulation) /</span></div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;<span class="stringliteral">                   maximal_velocity;</span></div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;<span class="stringliteral">     else</span></div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;<span class="stringliteral">       time_step = 1. / (1.7 dim std::sqrt(1. dim)) / temperature_degree</span></div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;<span class="stringliteral">                   GridTools::minimal_cell_diameter(triangulation) / .01;</span></div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;<span class="stringliteral">     std::cout &lt;&lt; &quot;   &quot;</span></div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;<span class="stringliteral">               &lt;&lt; &quot;Time step: &quot; &lt;&lt; time_step &lt;&lt; std::endl;</span></div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;<span class="stringliteral">     temperature_solution = old_temperature_solution;</span></div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;<span class="stringliteral">*  Next we set up the temperature system and the right hand side using the function   &lt;code&gt;assemble_temperature_system()&lt;/code&gt;  .  Knowing the matrix and right hand side of the temperature equation, we set up a preconditioner and a solver. The temperature matrix is a mass matrix (with eigenvalues around one) plus a Laplace matrix (with eigenvalues between zero and   @f$ch^{-2}@f$  ) times a small number proportional to the time step   @f$k_n@f$  . Hence, the resulting symmetric and positive definite matrix has eigenvalues in the range   @f$[1,1+k_nh^{-2}]@f$   (up to constants). This matrix is only moderately ill conditioned even for small mesh sizes and we get a reasonably good preconditioner by simple means, for example with an incomplete Cholesky decomposition preconditioner (IC) as we also use for preconditioning the pressure mass matrix solver. As a solver, we choose the conjugate gradient method CG. As before, we tell the solver to use Trilinos vectors via the template argument   &lt;code&gt;TrilinosWrappers::MPI::Vector&lt;/code&gt;  . Finally, we solve, distribute the hanging node constraints and write out the number of iterations.</span></div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;<span class="stringliteral">     assemble_temperature_system(maximal_velocity);</span></div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;<span class="stringliteral">     {</span></div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;<span class="stringliteral">       SolverControl solver_control(temperature_matrix.m(),</span></div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;<span class="stringliteral">                                    1e-8 temperature_rhs.l2_norm());</span></div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="stringliteral">       SolverCG&lt;TrilinosWrappers::MPI::Vector&gt; cg(solver_control);</span></div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;<span class="stringliteral">       TrilinosWrappers::PreconditionIC preconditioner;</span></div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;<span class="stringliteral">       preconditioner.initialize(temperature_matrix);</span></div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;<span class="stringliteral">       cg.solve(temperature_matrix,</span></div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;<span class="stringliteral">                temperature_solution,</span></div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;<span class="stringliteral">                temperature_rhs,</span></div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;<span class="stringliteral">                preconditioner);</span></div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;<span class="stringliteral">       temperature_constraints.distribute(temperature_solution);</span></div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;<span class="stringliteral">       std::cout &lt;&lt; &quot;   &quot; &lt;&lt; solver_control.last_step()</span></div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;<span class="stringliteral">                 &lt;&lt; &quot; CG iterations for temperature.&quot; &lt;&lt; std::endl;</span></div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;<span class="stringliteral">*  At the end of this function, we step through the vector and read out the maximum and minimum temperature value, which we also want to output. This will come in handy when determining the correct constant in the choice of time step as discuss in the results section of this program.</span></div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;<span class="stringliteral">       double min_temperature = temperature_solution(0),</span></div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;<span class="stringliteral">              max_temperature = temperature_solution(0);</span></div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;<span class="stringliteral">       for (unsigned int i = 0; i &lt; temperature_solution.size(); ++i)</span></div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;<span class="stringliteral">         {</span></div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;<span class="stringliteral">           min_temperature =</span></div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;<span class="stringliteral">             std::min&lt;double&gt;(min_temperature, temperature_solution(i));</span></div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;<span class="stringliteral">           max_temperature =</span></div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;<span class="stringliteral">             std::max&lt;double&gt;(max_temperature, temperature_solution(i));</span></div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;<span class="stringliteral">         }</span></div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;<span class="stringliteral">       std::cout &lt;&lt; &quot;   Temperature range: &quot; &lt;&lt; min_temperature &lt;&lt; &#39;</span> <span class="stringliteral">&#39;</span></div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;<span class="stringliteral">                 &lt;&lt; max_temperature &lt;&lt; std::endl;</span></div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;<span class="stringliteral">     }</span></div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;<span class="stringliteral">   }</span></div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;<span class="stringliteral"> </span></div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;<span class="stringliteral">*   &lt;a name=&quot;BoussinesqFlowProblemoutput_results&quot;&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::output_results&lt;/h4&gt;   </span></div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;<span class="stringliteral">*   This function writes the solution to a VTK output file for visualization, which is done every tenth time step. This is usually quite a simple task, since the deal.II library provides functions that do almost all the job for us. There is one new function compared to previous examples: We want to visualize both the Stokes solution and the temperature as one data set, but we have done all the calculations based on two different DoFHandler objects. Luckily, the DataOut class is prepared to deal with it. All we have to do is to not attach one single DoFHandler at the beginning and then use that for all added vector, but specify the DoFHandler to each vector separately. The rest is done as in   @ref step_22 &quot;step-22&quot;  . We create solution names (that are going to appear in the visualization program for the individual components). The first   &lt;code&gt;dim&lt;/code&gt;   components are the vector velocity, and then we have pressure for the Stokes part, whereas temperature is scalar. This information is read out using the DataComponentInterpretation helper class. Next, we actually attach the data vectors with their DoFHandler objects, build patches according to the degree of freedom, which are (sub-) elements that describe the data for visualization programs. Finally, we open a file (that includes the time step number) and write the vtk data into it.</span></div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;<span class="stringliteral">   template &lt;int dim&gt;</span></div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;<span class="stringliteral">   void BoussinesqFlowProblem&lt;dim&gt;::output_results() const</span></div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;<span class="stringliteral">   {</span></div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;<span class="stringliteral">     if (timestep_number % 10 != 0)</span></div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;<span class="stringliteral">       return;</span></div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;<span class="stringliteral">     std::vector&lt;std::string&gt; stokes_names(dim, &quot;velocity&quot;);</span></div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;<span class="stringliteral">     stokes_names.emplace_back(&quot;p&quot;);</span></div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;<span class="stringliteral">     std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</span></div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;<span class="stringliteral">       stokes_component_interpretation(</span></div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;<span class="stringliteral">         dim + 1, DataComponentInterpretation::component_is_scalar);</span></div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;<span class="stringliteral">     for (unsigned int i = 0; i &lt; dim; ++i)</span></div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;<span class="stringliteral">       stokes_component_interpretation[i] =</span></div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;<span class="stringliteral">         DataComponentInterpretation::component_is_part_of_vector;</span></div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;<span class="stringliteral">     DataOut&lt;dim&gt; data_out;</span></div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;<span class="stringliteral">     data_out.add_data_vector(stokes_dof_handler,</span></div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;<span class="stringliteral">                              stokes_solution,</span></div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;<span class="stringliteral">                              stokes_names,</span></div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;<span class="stringliteral">                              stokes_component_interpretation);</span></div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;<span class="stringliteral">     data_out.add_data_vector(temperature_dof_handler,</span></div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;<span class="stringliteral">                              temperature_solution,</span></div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;<span class="stringliteral">                              &quot;T&quot;);</span></div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;<span class="stringliteral">     data_out.build_patches(std::min(stokes_degree, temperature_degree));</span></div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;<span class="stringliteral">     std::ofstream output(&quot;solution-&quot; +</span></div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;<span class="stringliteral">                          Utilities::int_to_string(timestep_number, 4) + &quot;.vtk&quot;);</span></div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;<span class="stringliteral">     data_out.write_vtk(output);</span></div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;<span class="stringliteral">   }</span></div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;<span class="stringliteral"> </span></div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;<span class="stringliteral">*   &lt;a name=&quot;BoussinesqFlowProblemrefine_mesh&quot;&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::refine_mesh&lt;/h4&gt;   </span></div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;<span class="stringliteral">*   This function takes care of the adaptive mesh refinement. The three tasks this function performs is to first find out which cells to refine/coarsen, then to actually do the refinement and eventually transfer the solution vectors between the two different grids. The first task is simply achieved by using the well-established Kelly error estimator on the temperature (it is the temperature we&#39;</span>re mainly interested in <span class="keywordflow">for</span> <span class="keyword">this</span> program, and we need to be accurate in regions of high temperature <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">gradients</a>, also to not have too much numerical diffusion). The <a class="code" href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a> task is to actually <span class="keywordflow">do</span> the remeshing. That involves only basic functions as well, such as the   &lt;code&gt;refine_and_coarsen_fixed_fraction&lt;/code&gt;   that refines those cells with the largest estimated error that together make up 80 per cent of the error, and coarsens those cells with the smallest error that make up <span class="keywordflow">for</span> a combined 10 per cent of the error.   </div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;*   If implemented like <span class="keyword">this</span>, we would <span class="keyword">get</span> a program that will not make much progress: Remember that we expect temperature fields that are nearly discontinuous (the diffusivity   @f$\kappa@f$   is very small after all) and consequently we can expect that a freely adapted mesh will <a class="code" href="namespaceGridRefinement.html#a1cf30058b31ce7f9b389e8310bb9fc54">refine</a> further and further into the areas of large gradients. This decrease in mesh size will then be accompanied by a decrease in time step, requiring an exceedingly large number of time steps to solve to a given <span class="keyword">final</span> time. It will also lead to meshes that are much better at resolving discontinuities after several mesh refinement cycles than in the beginning.   </div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;*   In particular to prevent the decrease in time step size and the correspondingly large number of time steps, we limit the maximal refinement <a class="code" href="data__out__base_8cc.html#a845896541a0621f5fbd11f0d115ce463">depth</a> of the mesh. To <span class="keyword">this</span> <a class="code" href="namespaceTrilinosWrappers_1_1internal.html#aee42c8e3004e2e81eac3c3356d3ec46b">end</a>, after the refinement indicator has been applied to the cells, we simply <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> over all cells on the finest <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a> and unselect them from refinement <span class="keywordflow">if</span> they would result in too high a mesh <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>.</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;* </div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;</div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;* </div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;* @code</div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;   <span class="keywordtype">void</span></div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;   BoussinesqFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;   {</div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;     <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;* </div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;     <a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>(temperature_dof_handler,</div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;                                        <a class="code" href="classQGauss.html">QGauss</a>&lt;dim</div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;* </div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;- 1&gt;(temperature_degree + 1),</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;                                        {},</div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;                                        temperature_solution,</div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;                                        estimated_error_per_cell);</div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;* </div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;     <a class="code" href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>,</div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;                                                       estimated_error_per_cell,</div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;                                                       0.8,</div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;                                                       0.1);</div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;     <span class="keywordflow">if</span> (<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_levels() &gt; max_grid_level)</div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;       <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;cell :</div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;            <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators_on_level(max_grid_level))</div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;         cell-&gt;clear_refine_flag();</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;* </div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;* </div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;*  As part of mesh refinement we need to transfer the solution vectors from the old mesh to the <span class="keyword">new</span> <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a>. To <span class="keyword">this</span> end we use the <a class="code" href="classSolutionTransfer.html">SolutionTransfer</a> <span class="keyword">class </span>and we have to prepare the solution vectors that should be transferred to the new grid (we will lose the old grid once we have done the refinement so the transfer has to happen concurrently with refinement). What we definitely need are the current and the old temperature (BDF-2 time stepping requires two old solutions). Since the <a class="code" href="classSolutionTransfer.html">SolutionTransfer</a> objects only support to transfer <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> object per dof handler, we need to collect the two temperature solutions in <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> data structure. Moreover, we choose to transfer the Stokes solution, too, since we need the velocity at two previous time steps, of which only <a class="code" href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">one</a> is calculated on the fly.     </div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;*   Consequently, we initialize two <a class="code" href="classSolutionTransfer.html">SolutionTransfer</a> objects <span class="keywordflow">for</span> the Stokes and temperature <a class="code" href="classDoFHandler.html">DoFHandler</a> objects, by attaching them to the old dof handlers. With <span class="keyword">this</span> at place, we can prepare the <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a> and the data vectors <span class="keywordflow">for</span> refinement (in <span class="keyword">this</span> order).</div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;* </div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;* </div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;* @code</div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;     std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_temperature(2);</div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;     x_temperature[0]                            = temperature_solution;</div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;     x_temperature[1]                            = old_temperature_solution;</div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;     TrilinosWrappers::MPI::BlockVector x_stokes = stokes_solution;</div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;* </div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;     <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> temperature_trans(</div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;       temperature_dof_handler);</div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;     <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> stokes_trans(</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;       stokes_dof_handler);</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;* </div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;     <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.prepare_coarsening_and_refinement();</div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;     temperature_trans.prepare_for_coarsening_and_refinement(x_temperature);</div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;     stokes_trans.prepare_for_coarsening_and_refinement(x_stokes);</div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;* </div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;* </div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;*  Now everything is ready, so <span class="keywordflow">do</span> the refinement and recreate the dof structure on the <span class="keyword">new</span> grid, and initialize the matrix structures and the <span class="keyword">new</span> vectors in the   &lt;code&gt;setup_dofs&lt;/code&gt;   <span class="keyword">function</span>. Next, we actually perform the interpolation of the solutions between the grids. We create another <a class="code" href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">copy</a> of temporary vectors <span class="keywordflow">for</span> temperature (now corresponding to the <span class="keyword">new</span> grid), and let the <a class="code" href="namespaceFETools.html#ad29759cb8c51f8d369a371f63be8dde0">interpolate</a> <span class="keyword">function</span> <span class="keywordflow">do</span> the job. Then, the resulting array of vectors is written into the respective vector member variables.     </div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;*   Remember that the <span class="keyword">set</span> of constraints will be updated <span class="keywordflow">for</span> the <span class="keyword">new</span> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a> in the setup_dofs() <a class="code" href="namespaceThreads_1_1internal.html#a8d237a30d09b13e0b5adbe0fd1dfb188">call</a>.</div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;* </div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;* </div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;* @code</div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;     <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;     setup_dofs();</div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;* </div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;     <a class="code" href="namespacestd.html">std</a>::vector&lt;<a class="code" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a>::MPI::<a class="code" href="classVector.html">Vector</a>&gt; tmp(2);</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;     tmp[0].<a class="code" href="namespaceinternal.html#a38181f4582ff69679bda7d8e31c37291">reinit</a>(temperature_solution);</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;     tmp[1].<a class="code" href="namespaceinternal.html#a38181f4582ff69679bda7d8e31c37291">reinit</a>(temperature_solution);</div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;     temperature_trans.<a class="code" href="namespaceFETools.html#ad29759cb8c51f8d369a371f63be8dde0">interpolate</a>(x_temperature, tmp);</div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;* </div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;     temperature_solution     = tmp[0];</div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;     old_temperature_solution = tmp[1];</div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;* </div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160; @endcode</div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;* </div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;*  After the solution has been transferred we then enforce the constraints on the transferred solution.</div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;* </div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;</div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;* </div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;* @code</div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;     temperature_constraints.distribute(temperature_solution);</div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;     temperature_constraints.distribute(old_temperature_solution);</div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;* </div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160; @endcode</div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;* </div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;*  For the Stokes vector, everything is just the same &amp;ndash; except that we do not need another temporary vector since we just <a class="code" href="namespaceFETools.html#ad29759cb8c51f8d369a371f63be8dde0">interpolate</a> a single vector. In the end, we have to tell the program that the matrices and preconditioners need to be regenerated, since the mesh has changed.</div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;* </div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;</div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;* </div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;* @code</div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;     stokes_trans.<a class="code" href="namespaceFETools.html#ad29759cb8c51f8d369a371f63be8dde0">interpolate</a>(x_stokes, stokes_solution);</div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;* </div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;     stokes_constraints.distribute(stokes_solution);</div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;* </div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;     rebuild_stokes_matrix         = true;</div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;     rebuild_temperature_matrices  = true;</div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;     rebuild_stokes_preconditioner = true;</div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;   }</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;* </div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160; </div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;* </div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160; @endcode</div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;* </div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;*   &lt;a name=&quot;BoussinesqFlowProblemrun&quot;&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::<a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>&lt;/h4&gt;   </div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;*   This function performs all the essential steps in the Boussinesq program. It starts by setting up a grid (depending on the spatial dimension, we choose some different <a class="code" href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a> of <a class="code" href="namespaceAlgorithms_1_1Events.html#a15a12dfdadd39a026d192ad96cb6207b">initial</a> refinement and additional adaptive refinement steps, and then create a cube in   &lt;code&gt;dim&lt;/code&gt;   dimensions and <a class="code" href="group__CUDAWrappers.html#gabb7130e2cea54654455ca41ef304f939">set</a> up the dofs for the <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> time. Since we want to start the time stepping already with an adaptively refined grid, we perform some pre-refinement steps, consisting of all assembly, solution and refinement, but without actually advancing in time. Rather, we use the vilified   &lt;code&gt;goto&lt;/code&gt;   statement to jump out of the time <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> right after mesh refinement to start all over again on the new mesh beginning at the   &lt;code&gt;start_time_iteration&lt;/code&gt;   label. (The use of the   &lt;code&gt;goto&lt;/code&gt;   is discussed in   @ref step_26 &quot;step-26&quot;  .)   </div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;*   Before we start, we <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">project</a> the <a class="code" href="namespaceAlgorithms_1_1Events.html#a15a12dfdadd39a026d192ad96cb6207b">initial</a> <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a> to the grid and obtain the <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> data for the   &lt;code&gt;old_temperature_solution&lt;/code&gt;   vector. Then, we initialize time step number and time step and start the time <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a>.</div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;* </div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;</div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;* </div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;* @code</div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;   template &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;   <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::<a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>()</div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;   {</div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (dim == 2 ? 4 : 2);</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (dim == 2 ? 4 : 3);</div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;* </div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160; </div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;     <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>);</div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;     global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>);</div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;* </div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;     <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.refine_global(initial_refinement);</div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;* </div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;     setup_dofs();</div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;* </div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;* </div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;   start_time_iteration:</div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;* </div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;     <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(temperature_dof_handler,</div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;                          temperature_constraints,</div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;                          <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(temperature_degree + 2),</div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;                          EquationData::TemperatureInitialValues&lt;dim&gt;(),</div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;                          old_temperature_solution);</div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;* </div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;     timestep_number = 0;</div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;     time_step = old_time_step = 0;</div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;* </div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;     <span class="keywordtype">double</span> time = 0;</div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;* </div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;     <span class="keywordflow">do</span></div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;       {</div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;         std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; time</div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;                   &lt;&lt; std::endl;</div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;* </div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;* </div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;*  The <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> steps in the time <a class="code" href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">loop</a> are all obvious &amp;ndash; we <a class="code" href="namespaceinternal.html#a2b3d48efdf7c94da455dc6a3553bab79">assemble</a> the Stokes system, the preconditioner, the temperature <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a> (matrices and preconditioner <span class="keywordflow">do</span> actually only change in <span class="keywordflow">case</span> we<span class="stringliteral">&#39;ve remeshed before), and then do the solve. Before going on with the next time step, we have to check whether we should first finish the pre-refinement steps or if we should remesh (every fifth time step), refining up to a level that is consistent with initial refinement and pre-refinement steps. Last in the loop is to advance the solutions, i.e., to copy the solutions to the next &quot;older&quot; time level.</span></div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;<span class="stringliteral">         assemble_stokes_system();</span></div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;<span class="stringliteral">         build_stokes_preconditioner();</span></div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;<span class="stringliteral">         assemble_temperature_matrix();</span></div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;<span class="stringliteral">         solve();</span></div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;<span class="stringliteral">         output_results();</span></div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;<span class="stringliteral">         std::cout &lt;&lt; std::endl;</span></div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;<span class="stringliteral">         if ((timestep_number == 0) &amp;&amp;</span></div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;<span class="stringliteral">             (pre_refinement_step &lt; n_pre_refinement_steps))</span></div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;<span class="stringliteral">           {</span></div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;<span class="stringliteral">             refine_mesh(initial_refinement + n_pre_refinement_steps);</span></div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;<span class="stringliteral">             ++pre_refinement_step;</span></div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;<span class="stringliteral">             goto start_time_iteration;</span></div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;<span class="stringliteral">           }</span></div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;<span class="stringliteral">         else if ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 5 == 0))</span></div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;<span class="stringliteral">           refine_mesh(initial_refinement + n_pre_refinement_steps);</span></div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;<span class="stringliteral">         time += time_step;</span></div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;<span class="stringliteral">         ++timestep_number;</span></div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;<span class="stringliteral">         old_stokes_solution          = stokes_solution;</span></div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;<span class="stringliteral">         old_old_temperature_solution = old_temperature_solution;</span></div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;<span class="stringliteral">         old_temperature_solution     = temperature_solution;</span></div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;<span class="stringliteral">       }</span></div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;<span class="stringliteral">*  Do all the above until we arrive at time 100.</span></div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;<span class="stringliteral">* @code</span></div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;<span class="stringliteral">     while (time &lt;= 100);</span></div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;<span class="stringliteral">   }</span></div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;<span class="stringliteral"> } // namespace Step31</span></div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;<span class="stringliteral"> </span></div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;<span class="stringliteral"> @endcode</span></div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;<span class="stringliteral">*   &lt;a name=&quot;Thecodemaincodefunction&quot;&gt;&lt;/a&gt;  &lt;h3&gt;The &lt;code&gt;main&lt;/code&gt; function&lt;/h3&gt;</span></div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;<span class="stringliteral">*  The main function looks almost the same as in all other programs.</span></div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;<span class="stringliteral">*  There is one difference we have to be careful about. This program uses Trilinos and, typically, Trilinos is configured so that it can run in %parallel using MPI. This doesn&#39;</span>t <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a485d4198c1f422388b80cadb98af1f27">mean</a> that it &lt;i&gt;has&lt;/i&gt; to run in %<a class="code" href="namespaceparallel.html">parallel</a>, and in fact <span class="keyword">this</span> program (unlike   @ref step_32 <span class="stringliteral">&quot;step-32&quot;</span>  ) makes no attempt at all to <span class="keywordflow">do</span> anything in %parallel <span class="keyword">using</span> MPI. Nevertheless, Trilinos wants the MPI system to be initialized. We <span class="keywordflow">do</span> that be creating an <span class="keywordtype">object</span> of type   <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a>   that initializes MPI (<span class="keywordflow">if</span> available) <span class="keyword">using</span> the arguments given to main() (i.e.,   &lt;code&gt;argc&lt;/code&gt;   and   &lt;code&gt;argv&lt;/code&gt;  ) and de-initializes it again when the <span class="keywordtype">object</span> goes out of scope.</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;* </div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;* </div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;* @code</div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160; <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, charargv[])</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160; {</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;   <span class="keywordflow">try</span></div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;     {</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;       <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;       <span class="keyword">using namespace </span>Step31;</div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;* </div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;       <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;         argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;* </div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;* </div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;*  This program can only be run in serial. Otherwise, <span class="keywordflow">throw</span> an exception.</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;* </div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;</div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;* </div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;* @code</div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;       <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;                   <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;                     <span class="stringliteral">&quot;This program can only be run in serial, use ./step-31&quot;</span>));</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;* </div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;       BoussinesqFlowProblem&lt;2&gt; flow_problem;</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;       flow_problem.run();</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;     }</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;   <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;     {</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;       std::cerr &lt;&lt; std::endl</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;                 &lt;&lt; std::endl</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;                 &lt;&lt; std::endl;</div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;       std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;                 &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;                 &lt;&lt; std::endl;</div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;* </div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;       <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;     }</div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;   <span class="keywordflow">catch</span> (...)</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;     {</div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;       std::cerr &lt;&lt; std::endl</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;                 &lt;&lt; std::endl</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;                 &lt;&lt; std::endl;</div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;       std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;                 &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;                 &lt;&lt; std::endl;</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;       <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;     }</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;* </div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;   <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160; }</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160; <span class="keyword">@end</span>code</div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;* &lt;a name=<span class="stringliteral">&quot;Results&quot;</span>&gt;&lt;/a&gt;&lt;h1&gt;Results&lt;/h1&gt;</div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;* </div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;* &lt;a name=<span class="stringliteral">&quot;Resultsin2d&quot;</span>&gt;&lt;/a&gt;&lt;h3&gt; Results in 2<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt;/h3&gt;</div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;* </div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;* When you run the program in 2<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>, the output will look something likethis:&lt;code&gt;&lt;pre&gt;Number of active cells: 256 (on 5 levels)Number of degrees of freedom: 3556 (2178+289+1089)</div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.919118   9 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;* </div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;*  - .16687 1.30011</div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;* Number of active cells: 280 (on 6 levels)Number of degrees of freedom: 4062 (2490+327+1245)</div><div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.459559   9 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;* </div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;*  - .0982971 0.598503</div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;* Number of active cells: 520 (on 7 levels)Number of degrees of freedom: 7432 (4562+589+2281)</div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.229779   9 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;* </div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;*  - .0551098 0.294493</div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;* Number of active cells: 1072 (on 8 levels)Number of degrees of freedom: 15294 (9398+1197+4699)</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.11489   9 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;* </div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;*  - .0273524 0.156861</div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;* Number of active cells: 2116 (on 9 levels)Number of degrees of freedom: 30114 (18518+2337+9259)</div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.0574449   9 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;* </div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;*  - .014993 0.0738328</div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;* Timestep 1:  t=0.0574449   Assembling...   Solving...   56 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.0574449   9 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;* </div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;*  - .0273934 0.14488</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;* ...&lt;/pre&gt;&lt;/code&gt;</div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;* In the beginning we <a class="code" href="namespaceGridRefinement.html#a1cf30058b31ce7f9b389e8310bb9fc54">refine</a> the mesh several times adaptively andalways <span class="keywordflow">return</span> to time step zero to restart on the newly refinedmesh. Only then <span class="keywordflow">do</span> we start the actual time iteration.</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;* The program runs <span class="keywordflow">for</span> a <span class="keywordflow">while</span>. The temperature field <span class="keywordflow">for</span> time steps 0,500, 1000, 1500, 2000, 3000, 4000, and 5000 looks like <span class="keyword">this</span> (note thatthe color <a class="code" href="namespaceGridTools.html#a0967563badadd81f77f62622dd8bc2cd">scale</a> used <span class="keywordflow">for</span> the temperature is not always the same):</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;*   &lt;table align=<span class="stringliteral">&quot;center&quot;</span> <span class="keyword">class</span>=<span class="stringliteral">&quot;doxtable&quot;</span>&gt;</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;  &lt;tr&gt;</div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.solution.00.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.solution.01.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.solution.02.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.solution.03.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;  &lt;/tr&gt;</div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;  &lt;tr&gt;</div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.solution.04.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.solution.05.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.solution.06.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.solution.07.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;  &lt;/tr&gt;</div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;&lt;/table&gt;  </div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;* The visualizations shown here were generated <span class="keyword">using</span> a version of the examplewhich did not enforce the constraints after transferring the mesh.</div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;* As can be seen, we have three heat sources that heat fluid andtherefore produce a buoyancy effect that lets hots pockets of fluidrise up and swirl around. By a chimney effect, the three streams arepressed together by fluid that comes from the outside and wants tojoin the updraft party. Note that because the fluid is initially atrest, those parts of the fluid that were initially over the sourcesreceive a longer heating time than that fluid that is later draggedover the source by the fully developed flow field. It is thereforehotter, a fact that can be seen in the red tips of the threeplumes. Note also the relatively fine features of the flow field, aresult of the sophisticated transport stabilization of the temperatureequation we have chosen.</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;* In addition to the pictures above, the following ones show theadaptive mesh and the flow field at the same time steps:</div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;*   &lt;table align=<span class="stringliteral">&quot;center&quot;</span> <span class="keyword">class</span>=<span class="stringliteral">&quot;doxtable&quot;</span>&gt;</div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;  &lt;tr&gt;</div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.grid.00.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.grid.01.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.grid.02.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.grid.03.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;  &lt;/tr&gt;</div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;  &lt;tr&gt;</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.grid.04.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.grid.05.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.grid.06.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.2d.grid.07.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;  &lt;/tr&gt;</div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;&lt;/table&gt;  </div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;* </div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;</div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;* &lt;a name=<span class="stringliteral">&quot;Resultsin3d&quot;</span>&gt;&lt;/a&gt;&lt;h3&gt; Results in 3d &lt;/h3&gt;</div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;* </div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;</div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;* The same thing can of course be done in 3d by changing the templateparameter to the BoussinesqFlowProblem <span class="keywordtype">object</span> in   &lt;code&gt;main()&lt;/code&gt;  from 2 to 3, so that the output now looks like follows:</div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;* &lt;code&gt;&lt;pre&gt;Number of active cells: 64 (on 3 levels)Number of degrees of freedom: 3041 (2187+125+729)</div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 2.45098   9 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;* </div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;*  - .675683 4.94725</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;* Number of active cells: 288 (on 4 levels)Number of degrees of freedom: 12379 (8943+455+2981)</div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 1.22549   9 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;* </div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;*  - .527701 2.25764</div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;* Number of active cells: 1296 (on 5 levels)Number of degrees of freedom: 51497 (37305+1757+12435)</div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.612745   10 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;* </div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;*  - .496942 0.847395</div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;* Number of active cells: 5048 (on 6 levels)Number of degrees of freedom: 192425 (139569+6333+46523)</div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;* Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.306373   10 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;* </div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;*  - .267683 0.497739</div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;* Timestep 1:  t=0.306373   Assembling...   Solving...   27 GMRES iterations <span class="keywordflow">for</span> Stokes subsystem.   Time step: 0.306373   10 CG iterations <span class="keywordflow">for</span> temperature.   Temperature range:</div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;* </div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;*  - .461787 0.958679</div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;* ...&lt;/pre&gt;&lt;/code&gt;</div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;* Visualizing the temperature isocontours at time steps 0,50, 100, 150, 200, 300, 400, 500, 600, 700, and 800 yields thefollowing plots:</div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;*   &lt;table align=<span class="stringliteral">&quot;center&quot;</span> <span class="keyword">class</span>=<span class="stringliteral">&quot;doxtable&quot;</span>&gt;</div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;  &lt;tr&gt;</div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.00.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.01.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.02.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.03.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;  &lt;/tr&gt;</div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;  &lt;tr&gt;</div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.04.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.05.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.06.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.07.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;  &lt;/tr&gt;</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;  &lt;tr&gt;</div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.08.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.09.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;        &lt;img src=<span class="stringliteral">&quot;https://www.dealii.org/images/steps/developer/step-31.3d.solution.10.png&quot;</span> alt=<span class="stringliteral">&quot;&quot;</span>&gt;</div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;    &lt;td&gt;</div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;    &lt;/td&gt;</div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;  &lt;/tr&gt;</div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;&lt;/table&gt;  </div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;* That the <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> picture looks like three hedgehogs stems from the fact that ourscheme essentially projects the source times the <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> time step size onto themesh to obtain the temperature field in the <a class="code" href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a> time step. Since the sourcefunction is discontinuous, we need to expect over- and undershoots from thisproject. This is in fact what happens (it<span class="stringliteral">&#39;s easier to check this in 2d) andleads to the crumpled appearance of the isosurfaces.  The visualizations shownhere were generated using a version of the example which did not enforce theconstraints after transferring the mesh.</span></div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;<span class="stringliteral">* &lt;a name=&quot;Numericalexperimentstodetermineoptimalparameters&quot;&gt;&lt;/a&gt;&lt;h3&gt; Numerical experiments to determine optimal parameters &lt;/h3&gt;</span></div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;<span class="stringliteral">* The program as is has three parameters that we don&#39;</span>t have much of atheoretical handle on how to choose in an optimal way. These are:  &lt;ul&gt;      &lt;li&gt;  The time step must satisfy a CFL condition        @f$k\le \min_K \frac{c_kh_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  . Here,   @f$c_k@f$   is      dimensionless, but what is the right value?    &lt;li&gt;  In the computation of the artificial viscosity,@f{eqnarray*}</div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;  \nu_\alpha(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>)|_K</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;  =</div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;  \beta</div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;  \|\mathbf{u}\|_{<a class="code" href="namespaceLAPACKSupport.html#a0a1f0b9f7bb0b746b8f27d7f297ed7fe">L</a>^\infty(K)}</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;  \min\left\{</div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;    h_K,</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;    h_K^\alpha</div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;    \frac{\|R_\alpha(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>)\|_{<a class="code" href="namespaceLAPACKSupport.html#a0a1f0b9f7bb0b746b8f27d7f297ed7fe">L</a>^\infty(K)}}{c(\mathbf{u},<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>)}</div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;  \right\},</div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;@f}</div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;*       with   @f$c(\mathbf{u},<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>) =</div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;      c_R\ \|\mathbf{u}\|_{<a class="code" href="namespaceLAPACKSupport.html#a0a1f0b9f7bb0b746b8f27d7f297ed7fe">L</a>^\infty(\Omega)} \ \mathrm{var}(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>)</div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;      \ |\mathrm{diam}(\Omega)|^{\alpha-2}@f$  .      Here, the choice of the dimensionless %<a class="code" href="namespacenumbers.html">numbers</a>   @f$\beta,c_R@f$   is of      interest.  &lt;/ul&gt;  In all of these cases, we will have to expect that the correct choice of eachvalue depends on that of the others, and most likely also on the spacedimension and polynomial degree of the finite element used <span class="keywordflow">for</span> thetemperature. Below we<span class="stringliteral">&#39;ll discuss a few numerical experiments to chooseconstants   @f$c_k@f$   and   @f$\beta@f$  .</span></div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;<span class="stringliteral">* Below, we will not discuss the choice of   @f$c_R@f$  . In the program, we setit to   @f$c_R=2^{\frac{4-2\alpha}{d}}@f$  . The reason for this value is abit complicated and has more to do with the history of the programthan reasoning: while the correct formula for the global scalingparameter   @f$c(\mathbf{u},T)@f$   is shown above, the program (including theversion shipped with deal.II 6.2) initially had a bug in that wecomputed  @f$c(\mathbf{u},T) =</span></div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;<span class="stringliteral">      \|\mathbf{u}\|_{L^\infty(\Omega)} \ \mathrm{var}(T)</span></div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;<span class="stringliteral">      \ \frac{1}{|\mathrm{diam}(\Omega)|^{\alpha-2}}@f$   instead, wherewe had set the scaling parameter to one. Since we only computed on theunit square/cube where   @f$\mathrm{diam}(\Omega)=2^{1/d}@f$  , this wasentirely equivalent to using the correct formula with  @f$c_R=\left(2^{1/d}\right)^{4-2\alpha}=2^{\frac{4-2\alpha}{d}}@f$  . Sincethis value for   @f$c_R@f$   appears to work just fine for the currentprogram, we corrected the formula in the program and set   @f$c_R@f$   to avalue that reproduces exactly the results we had before. We will,however, revisit this issue again in   @ref step_32 &quot;step-32&quot;  .</span></div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;<span class="stringliteral">* Now, however, back to the discussion of what values of   @f$c_k@f$   and  @f$\beta@f$   to choose:</span></div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;<span class="stringliteral">* &lt;a name=&quot;Choosingicsubksubiandbeta&quot;&gt;&lt;/a&gt;&lt;h4&gt; Choosing &lt;i&gt;c&lt;sub&gt;k&lt;/sub&gt;&lt;/i&gt;&lt;i&gt;c&lt;sub&gt;k&lt;/sub&gt;&lt;/i&gt; and beta &lt;/h4&gt;</span></div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;<span class="stringliteral">* These two constants are definitely linked in some way. The reason is easy tosee: In the case of a pure advection problem,  @f$\frac{\partial T}{\partial t} + \mathbf{u}\cdot\nabla T = \gamma@f$  , anyexplicit scheme has to satisfy a CFL condition of the form  @f$k\le \min_K \frac{c_k^a h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  . On the other hand,for a pure diffusion problem,  @f$\frac{\partial T}{\partial t} + \nu \Delta T = \gamma@f$  ,explicit schemes need to satisfy a condition  @f$k\le \min_K \frac{c_k^d h_K^2}{\nu}@f$  . So given the form of   @f$\nu@f$   above, anadvection diffusion problem like the one we have to solve here will result ina condition of the form  @f$</span></div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;<span class="stringliteral">k\le \min_K \min \left\{</span></div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;<span class="stringliteral">  \frac{c_k^a h_K}{\|\mathbf{u}\|_{L^\infty(K)}},</span></div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;<span class="stringliteral">  \frac{c_k^d h_K^2}{\beta \|\mathbf{u}\|_{L^\infty(K)} h_K}\right\}</span></div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;<span class="stringliteral">  =</span></div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;<span class="stringliteral">  \min_K \left( \min \left\{</span></div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;<span class="stringliteral">  c_k^a,</span></div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;<span class="stringliteral">  \frac{c_k^d}{\beta}\right\}</span></div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;<span class="stringliteral">  \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}} \right)</span></div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;<span class="stringliteral">@f$  .It follows that we have to face the fact that we might want to choose   @f$\beta@f$  larger to improve the stability of the numerical scheme (by increasing theamount of artificial diffusion), but we have to pay a price in the form ofsmaller, and consequently more time steps. In practice, one would thereforelike to choose   @f$\beta@f$   as small as possible to keep the transport problemsufficiently stabilized while at the same time trying to choose the time stepas large as possible to reduce the overall amount of work.</span></div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;<span class="stringliteral">* The find the right balance, the only way is to do a few computationalexperiments. Here&#39;</span>s what we did: We modified the program slightly to allowless mesh refinement (so we don<span class="stringliteral">&#39;t always have to wait that long) and to choose  @f$</span></div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;<span class="stringliteral">  \nu(T)|_K</span></div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;<span class="stringliteral">  =</span></div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;<span class="stringliteral">  \beta</span></div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;<span class="stringliteral">  \|\mathbf{u}\|_{L^\infty(K)} h_K</span></div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;<span class="stringliteral">@f$   to eliminate the effect of the constant   @f$c_R@f$   (we know thatsolutions are stable by using this version of   @f$\nu(T)@f$   as an artificialviscosity, but that we can improve things</span></div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;<span class="stringliteral">*  -  i.e. make the solutionsharper</span></div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;<span class="stringliteral">*  -  by using the more complicated formula for this artificialviscosity). We then run the programfor different values   @f$c_k,\beta@f$   and observe maximal and minimal temperaturesin the domain. What we expect to see is this: If we choose the time step toobig (i.e. choose a   @f$c_k@f$   bigger than theoretically allowed) then we will getexponential growth of the temperature. If we choose   @f$\beta@f$   too small, thenthe transport stabilization becomes insufficient and the solution will showsignificant oscillations but not exponential growth.</span></div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;<span class="stringliteral">* &lt;a name=&quot;ResultsforQsub1subelements&quot;&gt;&lt;/a&gt;&lt;h5&gt;Results for Q&lt;sub&gt;1&lt;/sub&gt; elements&lt;/h5&gt;</span></div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;<span class="stringliteral">* Here is what we get for  @f$\beta=0.01, \beta=0.1@f$  , and   @f$\beta=0.5@f$  , different choices of   @f$c_k@f$  , andbilinear elements (  &lt;code&gt;temperature_degree=1&lt;/code&gt;  ) in 2d:</span></div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;<span class="stringliteral">*   &lt;table align=&quot;center&quot; class=&quot;doxtable&quot;&gt;</span></div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;<span class="stringliteral">  &lt;tr&gt;</span></div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;<span class="stringliteral">    &lt;td&gt;</span></div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;<span class="stringliteral">        &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.01.png&quot; alt=&quot;&quot;&gt;</span></div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;<span class="stringliteral">    &lt;/td&gt;</span></div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;<span class="stringliteral">    &lt;td&gt;</span></div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;<span class="stringliteral">        &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.03.png&quot; alt=&quot;&quot;&gt;</span></div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;<span class="stringliteral">    &lt;/td&gt;</span></div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;<span class="stringliteral">  &lt;/tr&gt;</span></div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;<span class="stringliteral">  &lt;tr&gt;</span></div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;<span class="stringliteral">    &lt;td&gt;</span></div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;<span class="stringliteral">        &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.1.png&quot; alt=&quot;&quot;&gt;</span></div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;<span class="stringliteral">    &lt;/td&gt;</span></div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;<span class="stringliteral">    &lt;td&gt;</span></div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;<span class="stringliteral">        &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.5.png&quot; alt=&quot;&quot;&gt;</span></div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;<span class="stringliteral">    &lt;/td&gt;</span></div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;<span class="stringliteral">  &lt;/tr&gt;</span></div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;<span class="stringliteral">&lt;/table&gt;  </span></div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;<span class="stringliteral">* The way to interpret these graphs goes like this: for   @f$\beta=0.01@f$   and  @f$c_k=\frac 12,\frac 14@f$  , we see exponential growth or at least largevariations, but if we choose  @f$k=\frac 18\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  or smaller, then the scheme isstable though a bit wobbly. For more artificial diffusion, we can choose  @f$k=\frac 14\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  or smaller for   @f$\beta=0.03@f$  ,  @f$k=\frac 13\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  or smaller for   @f$\beta=0.1@f$  , and again need  @f$k=\frac 1{15}\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  for   @f$\beta=0.5@f$   (this time because much diffusion requires a small timestep).</span></div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;<span class="stringliteral">* So how to choose? If we were simply interested in a large time step, then wewould go with   @f$\beta=0.1@f$   and  @f$k=\frac 13\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  .On the other hand, we&#39;</span>re also interested in accuracy and here it may be ofinterest to actually investigate what these curves show. To <span class="keyword">this</span> end note thatwe start with a zero temperature and that our sources are positive &amp;mdash; sowe would intuitively expect that the temperature can never drop belowzero. But it does, a consequence of Gibb<span class="stringliteral">&#39;s phenomenon when using continuouselements to approximate a discontinuous solution. We can therefore see thatchoosing   @f$\beta@f$   too small is bad: too little artificial diffusion leads toover- and undershoots that aren&#39;</span>t diffused away. On the other hand, <span class="keywordflow">for</span> large  @f$\beta@f$  , the minimum temperature drops below zero at the beginning but thenquickly diffuses back to zero.</div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;* On the other hand, let<span class="stringliteral">&#39;s also look at the maximum temperature. Watching themovie of the solution, we see that initially the fluid is at rest. The sourcekeeps heating the same volume of fluid whose temperature increases linearly atthe beginning until its buoyancy is able to move it upwards. The hottest partof the fluid is therefore transported away from the solution and fluid takingits place is heated for only a short time before being moved out of the sourceregion, therefore remaining cooler than the initial bubble. If   @f$\kappa=0@f$  (in the program it is nonzero but very small) then the hottest part of thefluid should be advected along with the flow with its temperatureconstant. That&#39;</span>s what we can see in the graphs with the smallest   @f$\beta@f$  : Oncethe maximum temperature is reached, it hardly changes any more. On the otherhand, the larger the artificial diffusion, the more the hot spot isdiffused. Note that <span class="keywordflow">for</span> <span class="keyword">this</span> criterion, the time step size does not play asignificant role.</div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;* So to <a class="code" href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">sum</a> up, likely the best choice would appear to be   @f$\beta=0.03@f$  and   @f$k=\frac 14\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  . The curve isa bit wobbly, but overall pictures looks pretty reasonable with theexception of some over and undershoots close to the start time due toGibb<span class="stringliteral">&#39;s phenomenon.</span></div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;<span class="stringliteral">* &lt;a name=&quot;ResultsforQsub2subelements&quot;&gt;&lt;/a&gt;&lt;h5&gt;Results for Q&lt;sub&gt;2&lt;/sub&gt; elements&lt;/h5&gt;</span></div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;<span class="stringliteral">* One can repeat the same sequence of experiments for higher orderelements as well. Here are the graphs for bi-quadratic shape functions(  &lt;code&gt;temperature_degree=2&lt;/code&gt;  ) for the temperature, while weretain the   @f$Q_2/Q_1@f$   stable Taylor-Hood element for the Stokes system:</span></div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;<span class="stringliteral">*   &lt;table align=&quot;center&quot; class=&quot;doxtable&quot;&gt;</span></div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;<span class="stringliteral">  &lt;tr&gt;</span></div><div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;<span class="stringliteral">    &lt;td&gt;</span></div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;<span class="stringliteral">        &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.01.png&quot; alt=&quot;&quot;&gt;</span></div><div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;<span class="stringliteral">    &lt;/td&gt;</span></div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;<span class="stringliteral">    &lt;td&gt;</span></div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;<span class="stringliteral">        &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.03.png&quot; alt=&quot;&quot;&gt;</span></div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;<span class="stringliteral">    &lt;/td&gt;</span></div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;<span class="stringliteral">  &lt;/tr&gt;</span></div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;<span class="stringliteral">  &lt;tr&gt;</span></div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;<span class="stringliteral">    &lt;td&gt;</span></div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;<span class="stringliteral">        &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.1.png&quot; alt=&quot;&quot;&gt;</span></div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;<span class="stringliteral">    &lt;/td&gt;</span></div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;<span class="stringliteral">  &lt;/tr&gt;</span></div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;<span class="stringliteral">&lt;/table&gt;  </span></div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;<span class="stringliteral">* Again, small values of   @f$\beta@f$   lead to less diffusion but we have tochoose the time step very small to keep things under control. Toolarge values of   @f$\beta@f$   make for more diffusion, but again requiresmall time steps. The best value would appear to be   @f$\beta=0.03@f$  , asfor the   @f$Q_1@f$   element, and then we have to choose  @f$k=\frac 18\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$   &amp;mdash; exactlyhalf the size for the   @f$Q_1@f$   element, a fact that may not be surprisingif we state the CFL condition as the requirement that the time step besmall enough so that the distance transport advects in each time stepis no longer than one &lt;i&gt;grid point&lt;/i&gt; away (which for   @f$Q_1@f$   elementsis   @f$h_K@f$  , but for   @f$Q_2@f$   elements is   @f$h_K/2@f$  ). It turns out that   @f$\beta@f$  needs to be slightly larger for obtaining stable results also late inthe simulation at times larger than 60, so we actually choose it as  @f$\beta = 0.034@f$   in the code.</span></div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;<span class="stringliteral">* &lt;a name=&quot;Resultsfor3d&quot;&gt;&lt;/a&gt;&lt;h5&gt;Results for 3d&lt;/h5&gt;</span></div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;<span class="stringliteral">* One can repeat these experiments in 3d and find the optimal time stepfor each value of   @f$\beta@f$   and find the best value of   @f$\beta@f$  . What onefinds is that for the same   @f$\beta@f$   already used in 2d, the time stepsneeds to be a bit smaller, by around a factor of 1.2 or so. This iseasily explained: the time step restriction is  @f$k=\min_K \frac{ch_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$   where   @f$h_K@f$   isthe &lt;i&gt;diameter&lt;/i&gt; of the cell. However, what is really needed is thedistance between mesh points, which is   @f$\frac{h_K}{\sqrt{d}}@f$  . So amore appropriate form would be  @f$k=\min_K \frac{ch_K}{\|\mathbf{u}\|_{L^\infty(K)}\sqrt{d}}@f$  .</span></div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;<span class="stringliteral">* The second find is that one needs to choose   @f$\beta@f$   slightly bigger(about   @f$\beta=0.05@f$   or so). This then again reduces the time step wecan take.</span></div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;<span class="stringliteral">* &lt;a name=&quot;Conclusions&quot;&gt;&lt;/a&gt;&lt;h5&gt;Conclusions&lt;/h5&gt;</span></div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;<span class="stringliteral">* Concluding, from the simple computations above,   @f$\beta=0.034@f$   appears to be agood choice for the stabilization parameter in 2d, and   @f$\beta=0.05@f$   in 3d. Ina dimension independent way, we can model this as   @f$\beta=0.017d@f$  . If one doeslonger computations (several thousand time steps) on finer meshes, onerealizes that the time step size is not quite small enough and that forstability one will have to reduce the above values a bit more (by about afactor of   @f$\frac 78@f$  ).</span></div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;<span class="stringliteral">* As a consequence, a formula that reconciles 2d, 3d, and variable polynomialdegree and takes all factors in account reads as follows:@f{eqnarray*}</span></div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;<span class="stringliteral">  k =</span></div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;<span class="stringliteral">  \frac 1{2 \cdot 1.7} \frac 1{\sqrt{d}}</span></div><div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;<span class="stringliteral">  \frac 2d</span></div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;<span class="stringliteral">  \frac 1{q_T}</span></div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;<span class="stringliteral">  \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}</span></div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;<span class="stringliteral">  =</span></div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;<span class="stringliteral">  \frac 1{1.7 d\sqrt{d}}</span></div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;<span class="stringliteral">  \frac 1{q_T}</span></div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;<span class="stringliteral">  \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}.</span></div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;<span class="stringliteral">@f}</span></div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;<span class="stringliteral">* In the first form (in the center of the equation),   @f$\frac</span></div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;<span class="stringliteral">1{2 \cdot 1.7}@f$   is a universal constant,   @f$\frac 1{\sqrt{d}}@f$  is the factor that accounts for the difference between cell diameterand grid point separation,  @f$\frac 2d@f$   accounts for the increase in   @f$\beta@f$   with space dimension,  @f$\frac 1{q_T}@f$   accounts for the distance between grid points forhigher order elements, and   @f$\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}@f$  for the local speed of transport relative to the cell size. This isthe formula that we use in the program.</span></div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;<span class="stringliteral">* As for the question of whether to use   @f$Q_1@f$   or   @f$Q_2@f$   elements for thetemperature, the following considerations may be useful: First,solving the temperature equation is hardly a factor in the overallscheme since almost the entire compute time goes into solving theStokes system in each time step. Higher order elements for thetemperature equation are therefore not a significant drawback. On theother hand, if one compares the size of the over- and undershoots thesolution produces due to the discontinuous source description, onenotices that for the choice of   @f$\beta@f$   and   @f$k@f$   as above, the   @f$Q_1@f$  solution dips down to around   @f$-0.47@f$  , whereas the   @f$Q_2@f$   solution onlygoes to   @f$-0.13@f$   (remember that the exact solution should never becomenegative at all. This means that the   @f$Q_2@f$   solution is significantlymore accurate; the program therefore uses these higher order elements,despite the penalty we pay in terms of smaller time steps.</span></div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;<span class="stringliteral">* &lt;a name=&quot;Possibilitiesforextensions&quot;&gt;&lt;/a&gt;&lt;h3&gt; Possibilities for extensions &lt;/h3&gt;</span></div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;<span class="stringliteral">* </span></div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;<span class="stringliteral">* There are various ways to extend the current program. Of particular interestis, of course, to make it faster and/or increase the resolution of theprogram, in particular in 3d. This is the topic of the   @ref step_32 &quot;step-32&quot;  tutorial program which will implement strategies to solve this problem in%parallel on a cluster. It is also the basis of the much larger opensource code ASPECT (see https://aspect.geodynamics.org/ ) that can solve realisticproblems and that constitutes the further development of   @ref step_32 &quot;step-32&quot;  .</span></div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;<span class="stringliteral">* Another direction would be to make the fluid flow more realistic. The programwas initially written to simulate various cases simulating the convection ofmaterial in the earth&#39;</span>s mantle, i.e. the zone between the outer earth core andthe solid earth crust: there, material is heated from below and cooled fromabove, leading to thermal convection. The physics of <span class="keyword">this</span> fluid are much morecomplicated than shown in <span class="keyword">this</span> program, however: The viscosity of mantlematerial is strongly dependent on the temperature, i.e.   @f$\eta=\eta(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>)@f$  , withthe dependency frequently modeled as a viscosity that is reduced exponentiallywith rising temperature. Secondly, much of the dynamics of the mantle isdetermined by chemical reactions, primarily phase changes of the variouscrystals that make up the mantle; the buoyancy term on the right hand side ofthe Stokes equations then depends not only on the temperature, but also on thechemical composition at a given location which is advected by the flow fieldbut also changes as a <span class="keyword">function</span> of pressure and temperature. We willinvestigate some of these effects in later tutorial programs as well.</div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;* </div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;</div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;* &lt;a name=<span class="stringliteral">&quot;PlainProg&quot;</span>&gt;&lt;/a&gt;&lt;h1&gt; The plain program&lt;/h1&gt;  @include <span class="stringliteral">&quot;step-31.cc&quot;</span>  </div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;*</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;*/</div><div class="ttc" id="group__feaccess_html_ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdoc">Transformed quadrature weights. </div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00103">fe_update_flags.h:103</a></div></div>
<div class="ttc" id="group__feaccess_html_ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdoc">Shape function values. </div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00062">fe_update_flags.h:62</a></div></div>
<div class="ttc" id="group__MeshWorker_html_gad10f528ab87f39fbb0531d24f238b2f3"><div class="ttname"><a href="group__MeshWorker.html#gad10f528ab87f39fbb0531d24f238b2f3">MeshWorker::loop</a></div><div class="ttdeci">void loop(ITERATOR begin, typename identity&lt; ITERATOR &gt;::type end, DOFINFO &amp;dinfo, INFOBOX &amp;info, const std::function&lt; void(DOFINFO &amp;, typename INFOBOX::CellInfo &amp;)&gt; &amp;cell_worker, const std::function&lt; void(DOFINFO &amp;, typename INFOBOX::CellInfo &amp;)&gt; &amp;boundary_worker, const std::function&lt; void(DOFINFO &amp;, DOFINFO &amp;, typename INFOBOX::CellInfo &amp;, typename INFOBOX::CellInfo &amp;)&gt; &amp;face_worker, ASSEMBLER &amp;assembler, const LoopControl &amp;lctrl=LoopControl())</div><div class="ttdef"><b>Definition:</b> <a href="loop_8h_source.html#l00449">loop.h:449</a></div></div>
<div class="ttc" id="namespaceDifferentiation_1_1SD_html_aa55d50a1ffa79c27f9bd9ea104f15158"><div class="ttname"><a href="namespaceDifferentiation_1_1SD.html#aa55d50a1ffa79c27f9bd9ea104f15158">Differentiation::SD::sign</a></div><div class="ttdeci">Expression sign(const Expression &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="symengine__math_8cc_source.html#l00280">symengine_math.cc:280</a></div></div>
<div class="ttc" id="namespacenumbers_html_a8ae36952c7e0cc778b47b5371b3aeff1"><div class="ttname"><a href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a></div><div class="ttdeci">static const unsigned int invalid_unsigned_int</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00167">types.h:167</a></div></div>
<div class="ttc" id="namespaceinternal_html_a38181f4582ff69679bda7d8e31c37291"><div class="ttname"><a href="namespaceinternal.html#a38181f4582ff69679bda7d8e31c37291">internal::reinit</a></div><div class="ttdeci">void reinit(MatrixBlock&lt; MatrixType &gt; &amp;v, const BlockSparsityPattern &amp;p)</div><div class="ttdef"><b>Definition:</b> <a href="matrix__block_8h_source.html#l00575">matrix_block.h:575</a></div></div>
<div class="ttc" id="classFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00116">function.h:116</a></div></div>
<div class="ttc" id="namespaceLAPACKSupport_html_a0a1f0b9f7bb0b746b8f27d7f297ed7fe"><div class="ttname"><a href="namespaceLAPACKSupport.html#a0a1f0b9f7bb0b746b8f27d7f297ed7fe">LAPACKSupport::L</a></div><div class="ttdeci">static const char L</div><div class="ttdef"><b>Definition:</b> <a href="lapack__support_8h_source.html#l00183">lapack_support.h:183</a></div></div>
<div class="ttc" id="classFunction_html_a7248c7e11dc434fb7d16cdc5e41e3770"><div class="ttname"><a href="classFunction.html#a7248c7e11dc434fb7d16cdc5e41e3770">Function::n_components</a></div><div class="ttdeci">const unsigned int n_components</div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00132">function.h:132</a></div></div>
<div class="ttc" id="namespaceGridTools_html_acd5ccc543d561cfb086b571d1f7818cb"><div class="ttname"><a href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a></div><div class="ttdeci">double diameter(const Triangulation&lt; dim, spacedim &gt; &amp;tria)</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools_8cc_source.html#l00081">grid_tools.cc:81</a></div></div>
<div class="ttc" id="classSmartPointer_html"><div class="ttname"><a href="classSmartPointer.html">SmartPointer</a></div><div class="ttdef"><b>Definition:</b> <a href="smartpointer_8h_source.html#l00060">smartpointer.h:60</a></div></div>
<div class="ttc" id="namespaceLAPACKSupport_html_a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003"><div class="ttname"><a href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">LAPACKSupport::matrix</a></div><div class="ttdoc">Contents is actually a matrix. </div><div class="ttdef"><b>Definition:</b> <a href="lapack__support_8h_source.html#l00060">lapack_support.h:60</a></div></div>
<div class="ttc" id="namespacePhysics_1_1Elasticity_1_1Kinematics_html_a9587d5229555daa5b1fa1ba2f8a40adb"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">Physics::Elasticity::Kinematics::e</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; e(const Tensor&lt; 2, dim, Number &gt; &amp;F)</div></div>
<div class="ttc" id="namespaceGridRefinement_html_ae90dc87c4db158b8d01f6d564ac614e5"><div class="ttname"><a href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a></div><div class="ttdeci">void refine_and_coarsen_fixed_fraction(Triangulation&lt; dim, spacedim &gt; &amp;tria, const Vector&lt; Number &gt; &amp;criteria, const double top_fraction, const double bottom_fraction, const unsigned int max_n_cells=std::numeric_limits&lt; unsigned int &gt;::max(), const VectorTools::NormType norm_type=VectorTools::NormType::L1_norm)</div><div class="ttdef"><b>Definition:</b> <a href="grid_2grid__refinement_8cc_source.html#l00390">grid_refinement.cc:390</a></div></div>
<div class="ttc" id="classVector_html"><div class="ttname"><a href="classVector.html">Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="mapping__q1__eulerian_8h_source.html#l00033">mapping_q1_eulerian.h:33</a></div></div>
<div class="ttc" id="classAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="namespaceGridTools_html_a0967563badadd81f77f62622dd8bc2cd"><div class="ttname"><a href="namespaceGridTools.html#a0967563badadd81f77f62622dd8bc2cd">GridTools::scale</a></div><div class="ttdeci">void scale(const double scaling_factor, Triangulation&lt; dim, spacedim &gt; &amp;triangulation)</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools_8cc_source.html#l02042">grid_tools.cc:2042</a></div></div>
<div class="ttc" id="classTrilinosWrappers_1_1MPI_1_1Vector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="trilinos__vector_8h_source.html#l00262">trilinos_vector.h:262</a></div></div>
<div class="ttc" id="namespaceLocalIntegrators_1_1Divergence_html_a8bcfc37d2a2be8faa18628a601ecf112"><div class="ttname"><a href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">LocalIntegrators::Divergence::norm</a></div><div class="ttdeci">double norm(const FEValuesBase&lt; dim &gt; &amp;fe, const ArrayView&lt; const std::vector&lt; Tensor&lt; 1, dim &gt;&gt;&gt; &amp;Du)</div><div class="ttdef"><b>Definition:</b> <a href="divergence_8h_source.html#l00462">divergence.h:462</a></div></div>
<div class="ttc" id="namespacestd_html"><div class="ttname"><a href="namespacestd.html">std</a></div><div class="ttdoc">STL namespace. </div></div>
<div class="ttc" id="namespaceLAPACKSupport_html_aceda56512460bbad2f9fdb8a3d0e1e51"><div class="ttname"><a href="namespaceLAPACKSupport.html#aceda56512460bbad2f9fdb8a3d0e1e51">LAPACKSupport::one</a></div><div class="ttdeci">static const types::blas_int one</div><div class="ttdef"><b>Definition:</b> <a href="lapack__support_8h_source.html#l00198">lapack_support.h:198</a></div></div>
<div class="ttc" id="classdouble_html"><div class="ttname"><a href="classdouble.html">double</a></div></div>
<div class="ttc" id="group__feaccess_html_ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdoc">Transformed quadrature points. </div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00097">fe_update_flags.h:97</a></div></div>
<div class="ttc" id="namespaceDoFRenumbering_html_a59c1a183ef6288e6bb061eb738b84380"><div class="ttname"><a href="namespaceDoFRenumbering.html#a59c1a183ef6288e6bb061eb738b84380">DoFRenumbering::downstream</a></div><div class="ttdeci">void downstream(DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const Tensor&lt; 1, spacedim &gt; &amp;direction, const bool dof_wise_renumbering=false)</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering_8cc_source.html#l01741">dof_renumbering.cc:1741</a></div></div>
<div class="ttc" id="group__Exceptions_html_gafc0ca7ad85b3ebd64e8e51689ac85caf"><div class="ttname"><a href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a></div><div class="ttdeci">#define AssertThrow(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01519">exceptions.h:1519</a></div></div>
<div class="ttc" id="grid__out_8cc_html_a2cc229a4f1ffc75e83ed269d5f725729"><div class="ttname"><a href="grid__out_8cc.html#a2cc229a4f1ffc75e83ed269d5f725729">second</a></div><div class="ttdeci">Point&lt; 2 &gt; second</div><div class="ttdef"><b>Definition:</b> <a href="grid__out_8cc_source.html#l04588">grid_out.cc:4588</a></div></div>
<div class="ttc" id="classQIterated_html"><div class="ttname"><a href="classQIterated.html">QIterated</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2quadrature_8h_source.html#l00313">quadrature.h:313</a></div></div>
<div class="ttc" id="namespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc">VectorTools::EvaluationFlags::min</a></div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__evaluate_8h_source.html#l00063">vector_tools_evaluate.h:63</a></div></div>
<div class="ttc" id="classPoint_html"><div class="ttname"><a href="classPoint.html">Point&lt; dim &gt;</a></div></div>
<div class="ttc" id="namespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">VectorTools::EvaluationFlags::max</a></div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__evaluate_8h_source.html#l00057">vector_tools_evaluate.h:57</a></div></div>
<div class="ttc" id="namespaceFETools_html_ad29759cb8c51f8d369a371f63be8dde0"><div class="ttname"><a href="namespaceFETools.html#ad29759cb8c51f8d369a371f63be8dde0">FETools::interpolate</a></div><div class="ttdeci">void interpolate(const DoFHandler&lt; dim, spacedim &gt; &amp;dof1, const InVector &amp;u1, const DoFHandler&lt; dim, spacedim &gt; &amp;dof2, OutVector &amp;u2)</div></div>
<div class="ttc" id="namespaceparallel_html"><div class="ttname"><a href="namespaceparallel.html">parallel</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2distributed_8h_source.html#l00150">distributed.h:150</a></div></div>
<div class="ttc" id="data__out__base_8cc_html_a845896541a0621f5fbd11f0d115ce463"><div class="ttname"><a href="data__out__base_8cc.html#a845896541a0621f5fbd11f0d115ce463">depth</a></div><div class="ttdeci">float depth</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l00181">data_out_base.cc:181</a></div></div>
<div class="ttc" id="classSolutionTransfer_html"><div class="ttname"><a href="classSolutionTransfer.html">SolutionTransfer</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2solution__transfer_8h_source.html#l00228">solution_transfer.h:228</a></div></div>
<div class="ttc" id="namespaceThreads_1_1internal_html_a8d237a30d09b13e0b5adbe0fd1dfb188"><div class="ttname"><a href="namespaceThreads_1_1internal.html#a8d237a30d09b13e0b5adbe0fd1dfb188">Threads::internal::call</a></div><div class="ttdeci">void call(const std::function&lt; RT()&gt; &amp;function, internal::return_value&lt; RT &gt; &amp;ret_val)</div><div class="ttdef"><b>Definition:</b> <a href="thread__management_8h_source.html#l00346">thread_management.h:346</a></div></div>
<div class="ttc" id="classQuadrature_html"><div class="ttname"><a href="classQuadrature.html">Quadrature</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2quadrature_8h_source.html#l00058">quadrature.h:58</a></div></div>
<div class="ttc" id="classQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8h_source.html#l00039">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="vectorization_8h_html_a31b02447b71a04a1ec9bdd1358751e45a465289687a70db7aa7217cc240c29f0f"><div class="ttname"><a href="vectorization_8h.html#a31b02447b71a04a1ec9bdd1358751e45a465289687a70db7aa7217cc240c29f0f">SIMDComparison::equal</a></div></div>
<div class="ttc" id="group__Exceptions_html_gae9a45f517af1401c50811a11083f9114"><div class="ttname"><a href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">StandardExceptions::ExcMessage</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcMessage(std::string arg1)</div></div>
<div class="ttc" id="classSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="solver__control_8h_source.html#l00047">solver_control.h:47</a></div></div>
<div class="ttc" id="classFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__q_8h_source.html#l00554">fe_q.h:554</a></div></div>
<div class="ttc" id="namespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81">VectorTools::EvaluationFlags::insert</a></div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__evaluate_8h_source.html#l00068">vector_tools_evaluate.h:68</a></div></div>
<div class="ttc" id="namespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a></div><div class="ttdef"><b>Definition:</b> <a href="evaluation__flags_8h_source.html#l00059">evaluation_flags.h:59</a></div></div>
<div class="ttc" id="namespaceLAPACKSupport_html_a8cac1e477eff052db622c8a9a9426ea3"><div class="ttname"><a href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">LAPACKSupport::T</a></div><div class="ttdeci">static const char T</div><div class="ttdef"><b>Definition:</b> <a href="lapack__support_8h_source.html#l00173">lapack_support.h:173</a></div></div>
<div class="ttc" id="namespaceUtilities_1_1MPI_html_ab544a3bf3301a6dd3e705ee352c5551b"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a></div><div class="ttdeci">T sum(const T &amp;t, const MPI_Comm &amp;mpi_communicator)</div></div>
<div class="ttc" id="namespaceTensorAccessors_html_a5798da96660fa8e6798917501d65dbd8"><div class="ttname"><a href="namespaceTensorAccessors.html#a5798da96660fa8e6798917501d65dbd8">TensorAccessors::extract</a></div><div class="ttdeci">constexpr ReturnType&lt; rank, T &gt;::value_type &amp; extract(T &amp;t, const ArrayType &amp;indices)</div><div class="ttdef"><b>Definition:</b> <a href="tensor__accessors_8h_source.html#l00244">tensor_accessors.h:244</a></div></div>
<div class="ttc" id="namespaceSparsityTools_html_a452753b6ffdf31b33f2bcd792b05df93"><div class="ttname"><a href="namespaceSparsityTools.html#a452753b6ffdf31b33f2bcd792b05df93">SparsityTools::partition</a></div><div class="ttdeci">void partition(const SparsityPattern &amp;sparsity_pattern, const unsigned int n_partitions, std::vector&lt; unsigned int &gt; &amp;partition_indices, const Partitioner partitioner=Partitioner::metis)</div><div class="ttdef"><b>Definition:</b> <a href="sparsity__tools_8cc_source.html#l00399">sparsity_tools.cc:399</a></div></div>
<div class="ttc" id="namespaceLinearAlgebraDealII_html_aa4543bb429e129431d48d18c1bfebae3"><div class="ttname"><a href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LinearAlgebraDealII::BlockVector</a></div><div class="ttdeci">BlockVector&lt; double &gt; BlockVector</div><div class="ttdef"><b>Definition:</b> <a href="generic__linear__algebra_8h_source.html#l00050">generic_linear_algebra.h:50</a></div></div>
<div class="ttc" id="group__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01415">exceptions.h:1415</a></div></div>
<div class="ttc" id="structFEValuesExtractors_1_1Vector_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__values__extractors_8h_source.html#l00114">fe_values_extractors.h:114</a></div></div>
<div class="ttc" id="classFESystem_html"><div class="ttname"><a href="classFESystem.html">FESystem</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2fe_2fe_8h_source.html#l00045">fe.h:45</a></div></div>
<div class="ttc" id="classTrilinosWrappers_1_1MPI_1_1BlockVector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a></div><div class="ttdef"><b>Definition:</b> <a href="trilinos__parallel__block__vector_8h_source.html#l00069">trilinos_parallel_block_vector.h:69</a></div></div>
<div class="ttc" id="namespaceinternal_html_aa5bef221c94bc6b9c5441c306a72cdbaae2b6dfb8a5c48206992d8310d176c37c"><div class="ttname"><a href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaae2b6dfb8a5c48206992d8310d176c37c">internal::EvaluatorQuantity::gradient</a></div></div>
<div class="ttc" id="classSparseMatrix_html"><div class="ttname"><a href="classSparseMatrix.html">SparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="sparse__matrix_8h_source.html#l00479">sparse_matrix.h:479</a></div></div>
<div class="ttc" id="namespaceVectorTools_html_a69967cb7a148a7169963126249213db1a485d4198c1f422388b80cadb98af1f27"><div class="ttname"><a href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1a485d4198c1f422388b80cadb98af1f27">VectorTools::mean</a></div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__common_8h_source.html#l00066">vector_tools_common.h:66</a></div></div>
<div class="ttc" id="namespacedeal__II__exceptions_1_1internals_html_a600f8f191a6ce368afda0074dd7ea1dc"><div class="ttname"><a href="namespacedeal__II__exceptions_1_1internals.html#a600f8f191a6ce368afda0074dd7ea1dc">deal_II_exceptions::internals::abort</a></div><div class="ttdeci">void abort(const ExceptionBase &amp;exc) noexcept</div><div class="ttdef"><b>Definition:</b> <a href="base_2exceptions_8cc_source.html#l00449">exceptions.cc:449</a></div></div>
<div class="ttc" id="grid__out_8cc_html_a9082f945c1d289684d0bcd51ee08e11e"><div class="ttname"><a href="grid__out_8cc.html#a9082f945c1d289684d0bcd51ee08e11e">level</a></div><div class="ttdeci">unsigned int level</div><div class="ttdef"><b>Definition:</b> <a href="grid__out_8cc_source.html#l04590">grid_out.cc:4590</a></div></div>
<div class="ttc" id="classSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="solver__cg_8h_source.html#l00078">solver_cg.h:78</a></div></div>
<div class="ttc" id="namespaceTrilinosWrappers_1_1internal_html_aee42c8e3004e2e81eac3c3356d3ec46b"><div class="ttname"><a href="namespaceTrilinosWrappers_1_1internal.html#aee42c8e3004e2e81eac3c3356d3ec46b">TrilinosWrappers::internal::end</a></div><div class="ttdeci">VectorType::value_type * end(VectorType &amp;V)</div><div class="ttdef"><b>Definition:</b> <a href="trilinos__sparse__matrix_8cc_source.html#l00067">trilinos_sparse_matrix.cc:67</a></div></div>
<div class="ttc" id="data__out__base_8cc_html_accc45da40beb7ae1b485306984e904a2"><div class="ttname"><a href="data__out__base_8cc.html#accc45da40beb7ae1b485306984e904a2">vertices</a></div><div class="ttdeci">Point&lt; 3 &gt; vertices[4]</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l00175">data_out_base.cc:175</a></div></div>
<div class="ttc" id="classTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation&lt; dim &gt;</a></div></div>
<div class="ttc" id="classTrilinosWrappers_1_1SparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="trilinos__sparse__matrix_8h_source.html#l00470">trilinos_sparse_matrix.h:470</a></div></div>
<div class="ttc" id="classIndexSet_html"><div class="ttname"><a href="classIndexSet.html">IndexSet</a></div><div class="ttdef"><b>Definition:</b> <a href="index__set_8h_source.html#l00063">index_set.h:63</a></div></div>
<div class="ttc" id="classFunction_html_ae316ebc05d21989d573024f8a23c49cb"><div class="ttname"><a href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">Function::vector_value</a></div><div class="ttdeci">virtual void vector_value(const Point&lt; dim &gt; &amp;p, Vector&lt; RangeNumberType &gt; &amp;values) const</div></div>
<div class="ttc" id="group__feaccess_html_ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719"><div class="ttname"><a href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a></div><div class="ttdoc">Second derivatives of shape functions. </div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00074">fe_update_flags.h:74</a></div></div>
<div class="ttc" id="namespacePhysics_1_1Elasticity_1_1Kinematics_html_a15728437b942dab0b0042eb06a407d2c"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">Physics::Elasticity::Kinematics::d</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; d(const Tensor&lt; 2, dim, Number &gt; &amp;F, const Tensor&lt; 2, dim, Number &gt; &amp;dF_dt)</div></div>
<div class="ttc" id="structFEValuesExtractors_1_1Scalar_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__values__extractors_8h_source.html#l00078">fe_values_extractors.h:78</a></div></div>
<div class="ttc" id="namespaceinternal_html_a2b3d48efdf7c94da455dc6a3553bab79"><div class="ttname"><a href="namespaceinternal.html#a2b3d48efdf7c94da455dc6a3553bab79">internal::assemble</a></div><div class="ttdeci">void assemble(const MeshWorker::DoFInfoBox&lt; dim, DOFINFO &gt; &amp;dinfo, A *assembler)</div><div class="ttdef"><b>Definition:</b> <a href="loop_8h_source.html#l00073">loop.h:73</a></div></div>
<div class="ttc" id="classPoint_html_a3df8e6ab311dab9337c8d7b039c7b815"><div class="ttname"><a href="classPoint.html#a3df8e6ab311dab9337c8d7b039c7b815">Point::distance</a></div><div class="ttdeci">numbers::NumberTraits&lt; Number &gt;::real_type distance(const Point&lt; dim, Number &gt; &amp;p) const</div></div>
<div class="ttc" id="namespaceLinearAlgebraDealII_html_a912abe2208022aec6753876bcc72f6bf"><div class="ttname"><a href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LinearAlgebraDealII::SparseMatrix</a></div><div class="ttdeci">SparseMatrix&lt; double &gt; SparseMatrix</div><div class="ttdef"><b>Definition:</b> <a href="generic__linear__algebra_8h_source.html#l00056">generic_linear_algebra.h:56</a></div></div>
<div class="ttc" id="namespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a></div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8h_source.html#l00154">dof_tools.h:154</a></div></div>
<div class="ttc" id="namespaceUtilities_1_1MPI_html_ac26de0c059200523177bb1d92cc25d00"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a></div><div class="ttdeci">unsigned int n_mpi_processes(const MPI_Comm &amp;mpi_communicator)</div><div class="ttdef"><b>Definition:</b> <a href="mpi_8cc_source.html#l00117">mpi.cc:117</a></div></div>
<div class="ttc" id="classKellyErrorEstimator_html_ae2269e1c9903e9d863b7abd54948af00"><div class="ttname"><a href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator::estimate</a></div><div class="ttdeci">static void estimate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim - 1 &gt; &amp;quadrature, const std::map&lt; types::boundary_id, const Function&lt; spacedim, typename InputVector::value_type &gt; *&gt; &amp;neumann_bc, const InputVector &amp;solution, Vector&lt; float &gt; &amp;error, const ComponentMask &amp;component_mask=ComponentMask(), const Function&lt; spacedim &gt; *coefficients=nullptr, const unsigned int n_threads=numbers::invalid_unsigned_int, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id, const types::material_id material_id=numbers::invalid_material_id, const Strategy strategy=cell_diameter_over_24)</div></div>
<div class="ttc" id="grid__out_8cc_html_a827a345f29da7caeb588b11013869a01"><div class="ttname"><a href="grid__out_8cc.html#a827a345f29da7caeb588b11013869a01">first</a></div><div class="ttdeci">Point&lt; 2 &gt; first</div><div class="ttdef"><b>Definition:</b> <a href="grid__out_8cc_source.html#l04587">grid_out.cc:4587</a></div></div>
<div class="ttc" id="namespaceAlgorithms_1_1Events_html_a15a12dfdadd39a026d192ad96cb6207b"><div class="ttname"><a href="namespaceAlgorithms_1_1Events.html#a15a12dfdadd39a026d192ad96cb6207b">Algorithms::Events::initial</a></div><div class="ttdeci">const Event initial</div><div class="ttdef"><b>Definition:</b> <a href="event_8cc_source.html#l00065">event.cc:65</a></div></div>
<div class="ttc" id="classBlockSparseMatrix_html"><div class="ttname"><a href="classBlockSparseMatrix.html">BlockSparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="block__sparse__matrix_8h_source.html#l00049">block_sparse_matrix.h:49</a></div></div>
<div class="ttc" id="classFiniteElement_html_a5b35a290aa7dd7562911a92a13b11fee"><div class="ttname"><a href="classFiniteElement.html#a5b35a290aa7dd7562911a92a13b11fee">FiniteElement::get_unit_support_points</a></div><div class="ttdeci">const std::vector&lt; Point&lt; dim &gt; &gt; &amp; get_unit_support_points() const</div><div class="ttdef"><b>Definition:</b> <a href="fe_8cc_source.html#l01049">fe.cc:1049</a></div></div>
<div class="ttc" id="namespaceLAPACKSupport_html_a40707d49114d54318c823f3b750e89a4"><div class="ttname"><a href="namespaceLAPACKSupport.html#a40707d49114d54318c823f3b750e89a4">LAPACKSupport::A</a></div><div class="ttdeci">static const char A</div><div class="ttdef"><b>Definition:</b> <a href="lapack__support_8h_source.html#l00158">lapack_support.h:158</a></div></div>
<div class="ttc" id="index__set_8h_html_ad28b2e725afda38ffdef1bf61d5cadd4"><div class="ttname"><a href="index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a></div><div class="ttdeci">IndexSet complete_index_set(const IndexSet::size_type N)</div><div class="ttdef"><b>Definition:</b> <a href="index__set_8h_source.html#l00995">index_set.h:995</a></div></div>
<div class="ttc" id="classVectorType_html"><div class="ttname"><a href="classVectorType.html">VectorType</a></div></div>
<div class="ttc" id="group__CUDAWrappers_html_gabb7130e2cea54654455ca41ef304f939"><div class="ttname"><a href="group__CUDAWrappers.html#gabb7130e2cea54654455ca41ef304f939">LinearAlgebra::CUDAWrappers::kernel::set</a></div><div class="ttdeci">__global__ void set(Number *val, const Number s, const size_type N)</div></div>
<div class="ttc" id="vectorization_8h_html_ae5c8b2cd70b2640bab8f1ee4ccb7f4cc"><div class="ttname"><a href="vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; pow(const ::VectorizedArray&lt; Number, width &gt; &amp;x, const ::VectorizedArray&lt; Number, width &gt; &amp;p)</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l05480">vectorization.h:5480</a></div></div>
<div class="ttc" id="classTensor_html"><div class="ttname"><a href="classTensor.html">Tensor&lt; 1, dim &gt;</a></div></div>
<div class="ttc" id="group__feaccess_html_ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdoc">Shape function gradients. </div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00068">fe_update_flags.h:68</a></div></div>
<div class="ttc" id="classTrilinosWrappers_1_1BlockSparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="trilinos__block__sparse__matrix_8h_source.html#l00062">trilinos_block_sparse_matrix.h:62</a></div></div>
<div class="ttc" id="classUtilities_1_1MPI_1_1MPI__InitFinalize_html"><div class="ttname"><a href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a></div><div class="ttdef"><b>Definition:</b> <a href="mpi_8h_source.html#l00742">mpi.h:742</a></div></div>
<div class="ttc" id="classDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00184">dof_handler.h:184</a></div></div>
<div class="ttc" id="namespaceGridGenerator_html_acea0cbcd68e52ce8113d1134b87de403"><div class="ttname"><a href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a></div><div class="ttdeci">void hyper_cube(Triangulation&lt; dim, spacedim &gt; &amp;tria, const double left=0., const double right=1., const bool colorize=false)</div></div>
<div class="ttc" id="namespacenumbers_html"><div class="ttname"><a href="namespacenumbers.html">numbers</a></div><div class="ttdef"><b>Definition:</b> <a href="numbers_8h_source.html#l00187">numbers.h:187</a></div></div>
<div class="ttc" id="classFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="symmetric__tensor_8h_html_a4248760c880275bab1f288fc80f27039"><div class="ttname"><a href="symmetric__tensor_8h.html#a4248760c880275bab1f288fc80f27039">trace</a></div><div class="ttdeci">constexpr Number trace(const SymmetricTensor&lt; 2, dim2, Number &gt; &amp;)</div></div>
<div class="ttc" id="group__Exceptions_html_ga7b52b286796c23ef9ff178faf7a4b68f"><div class="ttname"><a href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">StandardExceptions::ExcNotImplemented</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcNotImplemented()</div></div>
<div class="ttc" id="namespaceIteratorState_html_a4e92f4a9d339ff987cc3eb5b0a1ac507a457da025bc5a3a2231a667bd5c6f3c92"><div class="ttname"><a href="namespaceIteratorState.html#a4e92f4a9d339ff987cc3eb5b0a1ac507a457da025bc5a3a2231a667bd5c6f3c92">IteratorState::valid</a></div><div class="ttdoc">Iterator points to a valid object. </div><div class="ttdef"><b>Definition:</b> <a href="tria__iterator__base_8h_source.html#l00041">tria_iterator_base.h:41</a></div></div>
<div class="ttc" id="namespaceOpenCASCADE_html_a9509efa83e3b2fa42616fe0623cba696"><div class="ttname"><a href="namespaceOpenCASCADE.html#a9509efa83e3b2fa42616fe0623cba696">OpenCASCADE::point</a></div><div class="ttdeci">Point&lt; spacedim &gt; point(const gp_Pnt &amp;p, const double tolerance=1e-10)</div><div class="ttdef"><b>Definition:</b> <a href="opencascade_2utilities_8cc_source.html#l00188">utilities.cc:188</a></div></div>
<div class="ttc" id="namespaceLAPACKSupport_html_a0d8802698d585eec62a2a54e6387b05b"><div class="ttname"><a href="namespaceLAPACKSupport.html#a0d8802698d585eec62a2a54e6387b05b">LAPACKSupport::zero</a></div><div class="ttdeci">static const types::blas_int zero</div><div class="ttdef"><b>Definition:</b> <a href="lapack__support_8h_source.html#l00193">lapack_support.h:193</a></div></div>
<div class="ttc" id="namespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a></div><div class="ttdef"><b>Definition:</b> <a href="evaluation__flags_8h_source.html#l00054">evaluation_flags.h:54</a></div></div>
<div class="ttc" id="p4est__wrappers_8cc_html_ace00f2f80d9780ef9aa1007e1c22c6a4"><div class="ttname"><a href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a></div><div class="ttdeci">const ::parallel::distributed::Triangulation&lt; dim, spacedim &gt; * triangulation</div><div class="ttdef"><b>Definition:</b> <a href="p4est__wrappers_8cc_source.html#l00069">p4est_wrappers.cc:69</a></div></div>
<div class="ttc" id="classSubscriptor_html"><div class="ttname"><a href="classSubscriptor.html">Subscriptor</a></div><div class="ttdef"><b>Definition:</b> <a href="subscriptor_8h_source.html#l00050">subscriptor.h:50</a></div></div>
<div class="ttc" id="namespaceUtilities_1_1MPI_html_a9e963546bd81b0cdd88e1840cfa8f227"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#a9e963546bd81b0cdd88e1840cfa8f227">Utilities::MPI::reduce</a></div><div class="ttdeci">T reduce(const T &amp;local_value, const MPI_Comm &amp;comm, const std::function&lt; T(const T &amp;, const T &amp;)&gt; &amp;combiner, const unsigned int root_process=0)</div></div>
<div class="ttc" id="namespaceTrilinosWrappers_html"><div class="ttname"><a href="namespaceTrilinosWrappers.html">TrilinosWrappers</a></div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00137">types.h:137</a></div></div>
<div class="ttc" id="classFunction_html_acbfcab66b2fc63bfea59268f40772bb4"><div class="ttname"><a href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">Function::value</a></div><div class="ttdeci">virtual RangeNumberType value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const</div></div>
<div class="ttc" id="namespaceinternal_1_1QGaussLobatto_html_ac1aec52fdbb26c78e2d32fc0bed659c7"><div class="ttname"><a href="namespaceinternal_1_1QGaussLobatto.html#ac1aec52fdbb26c78e2d32fc0bed659c7">internal::QGaussLobatto::gamma</a></div><div class="ttdeci">long double gamma(const unsigned int n)</div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8cc_source.html#l00096">quadrature_lib.cc:96</a></div></div>
<div class="ttc" id="namespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2namespace__dealii_8h_source.html#l00024">namespace_dealii.h:24</a></div></div>
<div class="ttc" id="classBlockVectorBase_html_ae05a0e26814f032473ed2ef66da018bd"><div class="ttname"><a href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">BlockVectorBase::block</a></div><div class="ttdeci">BlockType &amp; block(const unsigned int i)</div></div>
<div class="ttc" id="classQTrapezoid_html"><div class="ttname"><a href="classQTrapezoid.html">QTrapezoid</a></div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8h_source.html#l00112">quadrature_lib.h:112</a></div></div>
<div class="ttc" id="namespaceinternal_1_1VectorOperations_html_a40c8daa0881cff0123fbaeb08929f5cb"><div class="ttname"><a href="namespaceinternal_1_1VectorOperations.html#a40c8daa0881cff0123fbaeb08929f5cb">internal::VectorOperations::copy</a></div><div class="ttdeci">void copy(const T *begin, const T *end, U *dest)</div><div class="ttdef"><b>Definition:</b> <a href="vector__operations__internal_8h_source.html#l00069">vector_operations_internal.h:69</a></div></div>
<div class="ttc" id="vectorization_8h_html_aafbdfdd72b6cfe4eae5fa7a16385582f"><div class="ttname"><a href="vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; abs(const ::VectorizedArray&lt; Number, width &gt; &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l05502">vectorization.h:5502</a></div></div>
<div class="ttc" id="namespaceVectorTools_html_ac6b404bf03cb2a742b290421cc2789fe"><div class="ttname"><a href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a></div><div class="ttdeci">void project(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const AffineConstraints&lt; typename VectorType::value_type &gt; &amp;constraints, const Quadrature&lt; dim &gt; &amp;quadrature, const Function&lt; spacedim, typename VectorType::value_type &gt; &amp;function, VectorType &amp;vec, const bool enforce_zero_boundary=false, const Quadrature&lt; dim - 1 &gt; &amp;q_boundary=(dim &gt; 1 ? QGauss&lt; dim - 1 &gt;(2) :Quadrature&lt; dim - 1 &gt;(0)), const bool project_to_boundary_first=false)</div></div>
<div class="ttc" id="namespaceGridRefinement_html_a1cf30058b31ce7f9b389e8310bb9fc54"><div class="ttname"><a href="namespaceGridRefinement.html#a1cf30058b31ce7f9b389e8310bb9fc54">GridRefinement::refine</a></div><div class="ttdeci">void refine(Triangulation&lt; dim, spacedim &gt; &amp;tria, const Vector&lt; Number &gt; &amp;criteria, const double threshold, const unsigned int max_to_mark=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="grid_2grid__refinement_8cc_source.html#l00168">grid_refinement.cc:168</a></div></div>
<div class="ttc" id="namespaceinternal_1_1p4est_html_a4b980c7b4b4d9984e93d73c7d30173ea"><div class="ttname"><a href="namespaceinternal_1_1p4est.html#a4b980c7b4b4d9984e93d73c7d30173ea">internal::p4est::functions</a></div><div class="ttdeci">int(&amp;) functions(const void *v1, const void *v2)</div><div class="ttdef"><b>Definition:</b> <a href="p4est__wrappers_8cc_source.html#l00339">p4est_wrappers.cc:339</a></div></div>
<div class="ttc" id="namespaceWorkStream_1_1internal_1_1tbb__no__coloring_html_a8673698a405bf47aa24002aeb6d76d70"><div class="ttname"><a href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">WorkStream::internal::tbb_no_coloring::run</a></div><div class="ttdeci">void run(const Iterator &amp;begin, const typename identity&lt; Iterator &gt;::type &amp;end, Worker worker, Copier copier, const ScratchData &amp;sample_scratch_data, const CopyData &amp;sample_copy_data, const unsigned int queue_length, const unsigned int chunk_size)</div><div class="ttdef"><b>Definition:</b> <a href="work__stream_8h_source.html#l00562">work_stream.h:562</a></div></div>
<div class="ttc" id="namespaceDerivativeApproximation_1_1internal_html_a4bea05d5ab84ca1e802db9a0217d1d6c"><div class="ttname"><a href="namespaceDerivativeApproximation_1_1internal.html#a4bea05d5ab84ca1e802db9a0217d1d6c">DerivativeApproximation::internal::approximate</a></div><div class="ttdeci">void approximate(SynchronousIterators&lt; std::tuple&lt; typename DoFHandler&lt; dim, spacedim &gt;::active_cell_iterator, Vector&lt; float &gt;::iterator &gt;&gt; const &amp;cell, const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const InputVector &amp;solution, const unsigned int component)</div><div class="ttdef"><b>Definition:</b> <a href="derivative__approximation_8cc_source.html#l00918">derivative_approximation.cc:918</a></div></div>
<div class="ttc" id="classFEValues_html_a21f914e63d588e2652a9514620653d77"><div class="ttname"><a href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell)</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8cc_source.html#l04515">fe_values.cc:4515</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
