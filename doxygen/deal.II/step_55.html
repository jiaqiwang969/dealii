<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_55.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-55 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The step-55 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_40.html">step-40</a>, <a class="el" href="step_22.html">step-22</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Optimalpreconditioners">Optimal preconditioners</a>
        <li><a href="#Thesolverandpreconditioner">The solver and preconditioner</a>
        <li><a href="#Thetestcase">The testcase</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a>
        <li><a href="#Problemsetup">Problem setup</a>
        <li><a href="#Themainprogram">The main program</a>
        <li><a href="#SystemSetup">System Setup</a>
        <li><a href="#Assembly">Assembly</a>
        <li><a href="#Solving">Solving</a>
        <li><a href="#Therest">The rest</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
      <ul>
        <li><a href="#InvestigateTrilinositerations">Investigate Trilinos iterations</a>
        <li><a href="#SolvetheOseenprobleminsteadoftheStokessystem">Solve the Oseen problem instead of the Stokes system</a>
        <li><a href="#Adaptiverefinement">Adaptive refinement</a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br />
</p>
<p><em>This program was contributed by Timo Heister. Special thanks to Sander Rhebergen for the inspiration to finally write this tutorial.</em></p>
<p><em>This material is based upon work partially supported by National Science Foundation grant DMS1522191 and the Computational Infrastructure in Geodynamics initiative (CIG), through the National Science Foundation under Award No. EAR-0949446 and The University of California-Davis.</em></p>
<p><em>The authors would like to thank the Isaac Newton Institute for Mathematical Sciences, Cambridge, for support and hospitality during the programme Melt in the Mantle where work on this tutorial was undertaken. This work was supported by EPSRC grant no EP/K032208/1. </em></p>
<dl class="section note"><dt>Note</dt><dd>As a prerequisite of this program, you need to have PETSc or Trilinos and the p4est library installed. The installation of deal.II together with these additional libraries is described in the <a href="../../readme.html" target="body">README</a> file.</dd></dl>
<p><a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>Building on <a class="el" href="step_40.html">step-40</a>, this tutorial shows how to solve linear PDEs with several components in parallel using MPI with PETSc or Trilinos for the linear algebra. For this, we return to the Stokes equations as discussed in <a class="el" href="step_22.html">step-22</a>. The motivation for writing this tutorial is to provide an intermediate step (pun intended) between <a class="el" href="step_40.html">step-40</a> (parallel Laplace) and <a class="el" href="step_32.html">step-32</a> (parallel coupled Stokes with Boussinesq for a time dependent problem).</p>
<p>The learning outcomes for this tutorial are:</p>
<ul>
<li>You are able to solve PDEs with several variables in parallel and can apply this to different problems.</li>
<li>You understand the concept of optimal preconditioners and are able to check this for a particular problem.</li>
<li>You are able to construct manufactured solutions using the free computer algreba system SymPy (<a href="https://sympy.org">https://sympy.org</a>).</li>
<li>You can implement various other tasks for parallel programs: error computation, writing graphical output, etc.</li>
<li>You can visualize vector fields, stream lines, and contours of vector quantities.</li>
</ul>
<p>We are solving for a velocity \(\textbf{u}\) and pressure \(p\) that satisfy the Stokes equation, which reads </p><p class="formulaDsp">
\begin{eqnarray*} - \triangle \textbf{u} + \nabla p &amp;=&amp; \textbf{f}, \\ -\textrm{div}\; \textbf{u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p><a class="anchor" id="Optimalpreconditioners"></a></p><h3>Optimal preconditioners</h3>
<p>Make sure that you read (even better: try) what is described in "Block Schur
complement preconditioner" in the "Possible Extensions" section in <a class="el" href="step_22.html">step-22</a>. Like described there, we are going to solve the block system using a Krylov method and a block preconditioner.</p>
<p>Our goal here is to construct a very simple (maybe the simplest?) optimal preconditioner for the linear system. A preconditioner is called "optimal" or "of optimal complexity", if the number of iterations of the preconditioned system is independent of the mesh size \(h\). You can extend that definition to also require indepence of the number of processors used (we will discuss that in the results section), the computational domain and the mesh quality, the test case itself, the polynomial degree of the finite element space, and more.</p>
<p>Why is a constant number of iterations considered to be "optimal"? Assume the discretized PDE gives a linear system with N unknowns. Because the matrix coming from the FEM discretization is sparse, a matrix-vector product can be done in O(N) time. A preconditioner application can also only be O(N) at best (for example doable with multigrid methods). If the number of iterations required to solve the linear system is independent of \(h\) (and therefore N), the total cost of solving the system will be O(N). It is not possible to beat this complexity, because even looking at all the entries of the right-hand side already takes O(N) time. For more information see <b>[elman2005]</b>, Chapter 2.5 (<a class="el" href="classMultigrid.html">Multigrid</a>).</p>
<p>The preconditioner described here is even simpler than the one described in <a class="el" href="step_22.html">step-22</a> and will typically require more iterations and consequently time to solve. When considering preconditioners, optimality is not the only important metric. But an optimal and expensive preconditioner is typically more desirable than a cheaper, non-optimal one. This is because, eventually, as the mesh size becomes smaller and smaller and linear problems become bigger and bigger, the former will eventually beat the latter.</p>
<p><a class="anchor" id="Thesolverandpreconditioner"></a></p><h3>The solver and preconditioner</h3>
<p>We precondition the linear system </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{c} U \\ P \end{array}\right) = \left(\begin{array}{c} F \\ 0 \end{array}\right), \end{eqnarray*}
</p>
<p>with the block diagonal preconditioner </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1} = \left(\begin{array}{cc} A &amp; 0 \\ 0 &amp; S \end{array}\right) ^{-1}, = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ 0 &amp; S^{-1} \end{array}\right), \end{eqnarray*}
</p>
<p> where \(S=-BA^{-1} B^T\) is the Schur complement.</p>
<p>With this choice of \(P\), assuming that we handle \(A^{-1}\) and \(S^{-1}\) exactly (which is an "idealized" situation), the preconditioned linear system has three distinct eigenvalues independent of \(h\) and is therefore "optimal". See section 6.2.1 (especially p. 292) in <b>[elman2005]</b>. For comparison, using the ideal version of the upper block-triangular preconditioner in <a class="el" href="step_22.html">step-22</a> (also used in <a class="el" href="step_56.html">step-56</a>) would have all eigenvalues be equal to one.</p>
<p>We will use approximations of the inverse operations in \(P^{-1}\) that are (nearly) independent of \(h\). In this situation, one can again show, that the eigenvalues are independent of \(h\). For the Krylov method we choose MINRES, which is attractive for the analysis (iteration count is proven to be independent of \(h\), see the remainder of the chapter 6.2.1 in the book mentioned above), great from the computational standpoint (simpler and cheaper than GMRES for example), and applicable (matrix and preconditioner are symmetric).</p>
<p>For the approximations we will use a CG solve with the mass matrix in the pressure space for approximating the action of \(S^{-1}\). Note that the mass matrix is spectrally equivalent to \(S\). We can expect the number of CG iterations to be independent of \(h\), even with a simple preconditioner like ILU.</p>
<p>For the approximation of the velocity block \(A\) we will perform a single AMG V-cycle. In practice this choice is not exactly independent of \(h\), which can explain the slight increase in iteration numbers. A possible explanation is that the coarsest level will be solved exactly and the number of levels and size of the coarsest matrix is not predictable.</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>We will construct a manufactured solution based on the classical Kovasznay problem, see <b>[kovasznay1948laminar]</b>. Here is an image of the solution colored by the x velocity including streamlines of the velocity:</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-55.solution.png"/>
</div>
<p>We have to cheat here, though, because we are not solving the non-linear Navier-Stokes equations, but the linear Stokes system without convective term. Therefore, to recreate the exact same solution, we use the method of manufactured solutions with the solution of the Kovasznay problem. This will effectively move the convective term into the right-hand side \(f\).</p>
<p>The right-hand side is computed using the script "reference.py" and we use the exact solution for boundary conditions and error computation.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div></div><!-- fragment --><p>The following chunk out code is identical to <a class="el" href="step_40.html">step-40</a> and allows switching between PETSc and Trilinos:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="generic__linear__algebra_8h.html">deal.II/lac/generic_linear_algebra.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">// #define FORCE_USE_OF_TRILINOS </span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>LA</div><div class="line">{</div><div class="line"><span class="preprocessor">#if defined(DEAL_II_WITH_PETSC) &amp;&amp; !defined(DEAL_II_PETSC_WITH_COMPLEX) &amp;&amp; \</span></div><div class="line"><span class="preprocessor">  !(defined(DEAL_II_WITH_TRILINOS) &amp;&amp; defined(FORCE_USE_OF_TRILINOS))</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraPETSc;</div><div class="line"><span class="preprocessor">#  define USE_PETSC_LA</span></div><div class="line"><span class="preprocessor">#elif defined(DEAL_II_WITH_TRILINOS)</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraTrilinos;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">#  error DEAL_II_WITH_PETSC or DEAL_II_WITH_TRILINOS required</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">} <span class="comment">// namespace LA</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__minres_8h.html">deal.II/lac/solver_minres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__sparse__matrix_8h.html">deal.II/lac/petsc_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__vector_8h.html">deal.II/lac/petsc_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__solver_8h.html">deal.II/lac/petsc_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__precondition_8h.html">deal.II/lac/petsc_precondition.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparsity__tools_8h.html">deal.II/lac/sparsity_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step55</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div></div><!-- fragment --><p><a class="anchor" id="Linearsolversandpreconditioners"></a> </p><h3>Linear solvers and preconditioners</h3>
<p>We need a few helper classes to represent our solver strategy described in the introduction.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>LinearSolvers</div><div class="line">{</div></div><!-- fragment --><p>This class exposes the action of applying the inverse of a giving matrix via the function InverseMatrix::vmult(). Internally, the inverse is not formed explicitly. Instead, a linear solver with CG is performed. This class extends the InverseMatrix class in <a class="el" href="step_22.html">step-22</a> with an option to specify a preconditioner, and to allow for different vector types in the vmult function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line"><span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  InverseMatrix(<span class="keyword">const</span> Matrix &amp;m, <span class="keyword">const</span> Preconditioner &amp;preconditioner);</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">  <span class="keywordtype">void</span> vmult(VectorType &amp;dst, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const Matrix&gt;</a> <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">  <span class="keyword">const</span> Preconditioner &amp;           preconditioner;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">InverseMatrix&lt;Matrix, Preconditioner&gt;::InverseMatrix(</div><div class="line">  <span class="keyword">const</span> Matrix &amp;        m,</div><div class="line">  <span class="keyword">const</span> Preconditioner &amp;preconditioner)</div><div class="line">  : matrix(&amp;m)</div><div class="line">  , preconditioner(preconditioner)</div><div class="line">{}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line"><span class="keywordtype">void</span></div><div class="line">InverseMatrix&lt;Matrix, Preconditioner&gt;::vmult(VectorType &amp;      dst,</div><div class="line">                                             <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(src.size(), 1e-8 * src.l2_norm());</div><div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;LA::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line">  dst = 0;</div><div class="line"></div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      cg.solve(*matrix, dst, src, preconditioner);</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;e)</div><div class="line">    {</div><div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(e.what()));</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>The class A template class for a simple block diagonal preconditioner for 2x2 matrices.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  <span class="keyword">class </span>BlockDiagonalPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> vmult(<a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> PreconditionerA &amp;preconditioner_A;</div><div class="line">    <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S;</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::</div><div class="line">    BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S)</div><div class="line">    : preconditioner_A(preconditioner_A)</div><div class="line">    , preconditioner_S(preconditioner_S)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  <span class="keywordtype">void</span> BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::vmult(</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    preconditioner_A.vmult(dst.block(0), src.block(0));</div><div class="line">    preconditioner_S.<a class="code" href="classPreconditionIdentity.html#a5cb13bb838919dd8b1ba531f20f21955">vmult</a>(dst.block(1), src.block(1));</div><div class="line">  }</div><div class="line"></div><div class="line">} <span class="comment">// namespace LinearSolvers</span></div></div><!-- fragment --><p><a class="anchor" id="Problemsetup"></a> </p><h3>Problem setup</h3>
<p>The following classes represent the right hand side and the exact solution for the test problem.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  RightHandSide()</div><div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">  values[0] =</div><div class="line">    -1.0L / 2.0L * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0) *</div><div class="line">      <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">    0.4 * pi2 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) +</div><div class="line">    0.1 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 2) *</div><div class="line">      <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi);</div><div class="line">  values[1] = 0.2 * pi * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">                <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) -</div><div class="line">              0.05 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 3) *</div><div class="line">                <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">                pi;</div><div class="line">  values[2] = 0;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>ExactSolution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ExactSolution()</div><div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ExactSolution&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">  values[0] =</div><div class="line">    -<a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) + 1;</div><div class="line">  values[1] = (1.0L / 2.0L) * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">              <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">              pi;</div><div class="line">  values[2] =</div><div class="line">    -1.0L / 2.0L * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">    2.0 *</div><div class="line">      (-6538034.74494422 +</div><div class="line">       0.0134758939981709 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(4 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">      (-80.0 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">       16.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) -</div><div class="line">    1634508.68623606 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">      (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">    (-0.00673794699908547 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">     3269017.37247211 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">      (-8 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 40.0) +</div><div class="line">    0.00336897349954273 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(1.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">      (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2));</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Themainprogram"></a> </p><h3>The main program</h3>
<p>The main class is very similar to <a class="el" href="step_40.html">step-40</a>, except that matrices and vectors are now block versions, and we store a std::vector&lt;IndexSet&gt; for owned and relevant DoFs instead of a single <a class="el" href="classIndexSet.html">IndexSet</a>. We have exactly two IndexSets, one for all velocity unknowns and one for all pressure unknowns.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>StokesProblem</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree);</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> make_grid();</div><div class="line">  <span class="keywordtype">void</span> setup_system();</div><div class="line">  <span class="keywordtype">void</span> assemble_system();</div><div class="line">  <span class="keywordtype">void</span> solve();</div><div class="line">  <span class="keywordtype">void</span> refine_grid();</div><div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree;</div><div class="line">  <span class="keywordtype">double</span>       viscosity;</div><div class="line">  <a class="code" href="classMPI__Comm.html">MPI_Comm</a>     mpi_communicator;</div><div class="line"></div><div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">  <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">  std::vector&lt;IndexSet&gt; owned_partitioning;</div><div class="line">  std::vector&lt;IndexSet&gt; relevant_partitioning;</div><div class="line"></div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> system_matrix;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       locally_relevant_solution;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       system_rhs;</div><div class="line"></div><div class="line">  <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line">  <a class="code" href="classTimerOutput.html">TimerOutput</a>        computing_timer;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">StokesProblem&lt;dim&gt;::StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree)</div><div class="line">  : velocity_degree(velocity_degree)</div><div class="line">  , viscosity(0.1)</div><div class="line">  , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">  , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree - 1), 1)</div><div class="line">  , triangulation(mpi_communicator,</div><div class="line">                  typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::MeshSmoothing(</div><div class="line">                    <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_refinement |</div><div class="line">                    <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_coarsening))</div><div class="line">  , dof_handler(triangulation)</div><div class="line">  , pcout(<a class="code" href="namespacestd.html">std</a>::cout,</div><div class="line">          (<a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0))</div><div class="line">  , computing_timer(mpi_communicator,</div><div class="line">                    pcout,</div><div class="line">                    <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div><div class="line">                    <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div><div class="line">{}</div></div><!-- fragment --><p>The Kovasnay flow is defined on the domain [-0.5, 1.5]^2, which we create by passing the min and max values to <a class="el" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::make_grid()</div><div class="line">{</div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, -0.5, 1.5);</div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(3);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="SystemSetup"></a> </p><h3>System Setup</h3>
<p>The construction of the block matrices and vectors is new compared to <a class="el" href="step_40.html">step-40</a> and is different compared to serial codes like <a class="el" href="step_22.html">step-22</a>, because we need to supply the set of rows that belong to our processor.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_system()</div><div class="line">{</div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;setup&quot;</span>);</div><div class="line"></div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div></div><!-- fragment --><p>Put all dim velocities into block 0 and the pressure into block 1, then reorder the unknowns by block. Finally count how many unknowns we have per block.</p>
<div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; stokes_sub_blocks(dim + 1, 0);</div><div class="line">stokes_sub_blocks[dim] = 1;</div><div class="line"><a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line"><span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">  <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div><div class="line">      &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div></div><!-- fragment --><p>We split up the <a class="el" href="classIndexSet.html">IndexSet</a> for locally owned and locally relevant DoFs into two IndexSets based on how we want to create the block matrices and vectors.</p>
<div class="fragment"><div class="line">owned_partitioning.resize(2);</div><div class="line">owned_partitioning[0] = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">owned_partitioning[1] =</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line"><a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line"><a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div><div class="line">relevant_partitioning.resize(2);</div><div class="line">relevant_partitioning[0] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">relevant_partitioning[1] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div></div><!-- fragment --><p>Setting up the constraints for boundary conditions and hanging nodes is identical to <a class="el" href="step_40.html">step-40</a>. Even though we don't have any hanging nodes because we only perform global refinement, it is still a good idea to put this function call in, in case adaptive refinement gets introduced later.</p>
<div class="fragment"><div class="line">{</div><div class="line">  constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           0,</div><div class="line">                                           ExactSolution&lt;dim&gt;(),</div><div class="line">                                           constraints,</div><div class="line">                                           fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">  constraints.close();</div><div class="line">}</div></div><!-- fragment --><p>Now we create the system matrix based on a <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a>. We know that we won't have coupling between different velocity components (because we use the laplace and not the deformation tensor) and no coupling between pressure with its test functions, so we use a <a class="el" href="classTable.html">Table</a> to communicate this coupling information to <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>.</p>
<div class="fragment"><div class="line">{</div><div class="line">  system_matrix.clear();</div><div class="line"></div><div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">      <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == dim || d == dim || c == d)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">      <span class="keywordflow">else</span></div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">    dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">  <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">    dsp,</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>(),</div><div class="line">    mpi_communicator,</div><div class="line">    locally_relevant_dofs);</div><div class="line"></div><div class="line">  system_matrix.reinit(owned_partitioning, dsp, mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>The preconditioner matrix has a different coupling (we only fill in the 1,1 block with the mass matrix), otherwise this code is identical to the construction of the system_matrix above.</p>
<div class="fragment"><div class="line">{</div><div class="line">  preconditioner_matrix.clear();</div><div class="line"></div><div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">      <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">      <span class="keywordflow">else</span></div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">    dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line">  <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">    dsp,</div><div class="line">    <a class="code" href="namespaceUtilities_1_1MPI.html#ac5a7433f594a19070add2afa0f769efb">Utilities::MPI::all_gather</a>(mpi_communicator,</div><div class="line">                               dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>()),</div><div class="line">    mpi_communicator,</div><div class="line">    locally_relevant_dofs);</div><div class="line">  preconditioner_matrix.reinit(owned_partitioning,</div></div><!-- fragment --><p>owned_partitioning,</p>
<div class="fragment"><div class="line">                               dsp,</div><div class="line">                               mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>Finally, we construct the block vectors with the right sizes. The function call with two std::vector&lt;IndexSet&gt; will create a ghosted vector.</p>
<div class="fragment"><div class="line">  locally_relevant_solution.reinit(owned_partitioning,</div><div class="line">                                   relevant_partitioning,</div><div class="line">                                   mpi_communicator);</div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Assembly"></a> </p><h3>Assembly</h3>
<p>This function assembles the system matrix, the preconditioner matrix, and the right hand side. The code is pretty standard.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">{</div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div><div class="line"></div><div class="line">  system_matrix         = 0;</div><div class="line">  preconditioner_matrix = 0;</div><div class="line">  system_rhs            = 0;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(velocity_degree + 1);</div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div><div class="line">                          quadrature_formula,</div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> cell_matrix2(dofs_per_cell, dofs_per_cell);</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(dim + 1));</div><div class="line"></div><div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(dofs_per_cell);</div><div class="line">  std::vector&lt;double&gt;         div_phi_u(dofs_per_cell);</div><div class="line">  std::vector&lt;double&gt;         phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocities(0);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a>     pressure(dim);</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">    <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">      {</div><div class="line">        cell_matrix  = 0;</div><div class="line">        cell_matrix2 = 0;</div><div class="line">        cell_rhs     = 0;</div><div class="line"></div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                          rhs_values);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">              {</div><div class="line">                grad_phi_u[k] = fe_values[velocities].gradient(k, q);</div><div class="line">                div_phi_u[k]  = fe_values[velocities].divergence(k, q);</div><div class="line">                phi_p[k]      = fe_values[pressure].value(k, q);</div><div class="line">              }</div><div class="line"></div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line">                  {</div><div class="line">                    <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                      (viscosity *</div><div class="line">                         <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[i], grad_phi_u[j]) -</div><div class="line">                       div_phi_u[i] * phi_p[j] - phi_p[i] * div_phi_u[j]) *</div><div class="line">                      fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                    cell_matrix2(i, j) += 1.0 / viscosity * phi_p[i] *</div><div class="line">                                          phi_p[j] * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                  }</div><div class="line"></div><div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                  fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                cell_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q) *</div><div class="line">                               rhs_values[q](component_i) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">              }</div><div class="line">          }</div><div class="line"></div><div class="line"></div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        constraints.distribute_local_to_global(cell_matrix,</div><div class="line">                                               cell_rhs,</div><div class="line">                                               local_dof_indices,</div><div class="line">                                               system_matrix,</div><div class="line">                                               system_rhs);</div><div class="line"></div><div class="line">        constraints.distribute_local_to_global(cell_matrix2,</div><div class="line">                                               local_dof_indices,</div><div class="line">                                               preconditioner_matrix);</div><div class="line">      }</div><div class="line"></div><div class="line">  system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  preconditioner_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Solving"></a> </p><h3>Solving</h3>
<p>This function solves the linear system with MINRES with a block diagonal preconditioner and AMG for the two diagonal blocks as described in the introduction. The preconditioner applies a v cycle to the 0,0 block and a CG with the mass matrix for the 1,1 block (the Schur complement).</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;solve&quot;</span>);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a> prec_A;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_A.initialize(system_matrix.block(0, 0), data);</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a> prec_S;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_S.<a class="code" href="classPETScWrappers_1_1PreconditionBoomerAMG.html#a3c82672eac786d7f369b296439859ff2">initialize</a>(preconditioner_matrix.block(1, 1), data);</div><div class="line">    }</div></div><!-- fragment --><p>The InverseMatrix is used to solve for the mass matrix:</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> mp_inverse_t = LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LA::MPI::SparseMatrix</a>,</div><div class="line">                                                  <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>&gt;;</div><div class="line"><span class="keyword">const</span> mp_inverse_t mp_inverse(preconditioner_matrix.block(1, 1), prec_S);</div></div><!-- fragment --><p>This constructs the block preconditioner based on the preconditioners for the individual blocks defined above.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> LinearSolvers::BlockDiagonalPreconditioner&lt;<a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>,</div><div class="line">                                                 mp_inverse_t&gt;</div><div class="line">  preconditioner(prec_A, mp_inverse);</div></div><!-- fragment --><p>With that, we can finally set up the linear solver and solve the system:</p>
<div class="fragment"><div class="line"><a class="code" href="classSolverControl.html">SolverControl</a> solver_control(system_matrix.m(),</div><div class="line">                             1e-10 * system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>());</div><div class="line"></div><div class="line"><a class="code" href="classSolverMinRes.html">SolverMinRes&lt;LA::MPI::BlockVector&gt;</a> solver(solver_control);</div><div class="line"></div><div class="line"><a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> distributed_solution(owned_partitioning,</div><div class="line">                                          mpi_communicator);</div><div class="line"></div><div class="line">constraints.set_zero(distributed_solution);</div><div class="line"></div><div class="line">solver.solve(system_matrix,</div><div class="line">             distributed_solution,</div><div class="line">             system_rhs,</div><div class="line">             preconditioner);</div><div class="line"></div><div class="line">pcout &lt;&lt; <span class="stringliteral">&quot;   Solved in &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span></div><div class="line">      &lt;&lt; std::endl;</div><div class="line"></div><div class="line">constraints.distribute(distributed_solution);</div></div><!-- fragment --><p>Like in <a class="el" href="step_56.html">step-56</a>, we subtract the mean pressure to allow error computations against our reference solution, which has a mean value of zero.</p>
<div class="fragment"><div class="line">  locally_relevant_solution = distributed_solution;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> mean_pressure =</div><div class="line">    VectorTools::compute_mean_value(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(velocity_degree + 2),</div><div class="line">                                    locally_relevant_solution,</div><div class="line">                                    dim);</div><div class="line">  distributed_solution.block(1).add(-mean_pressure);</div><div class="line">  locally_relevant_solution.block(1) = distributed_solution.block(1);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Therest"></a> </p><h3>The rest</h3>
<p>The remainder of the code that deals with mesh refinement, output, and the main loop is pretty standard.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_grid()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;refine&quot;</span>);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    {</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> pressure_mask(dim, dim + 1);</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> velocity_mask(std::make_pair(0, dim),</div><div class="line">                                                       dim + 1);</div><div class="line"></div><div class="line">      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> cellwise_errors(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>    quadrature(velocity_degree + 2);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;velocity_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_u_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;pressure_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_p_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;error: u_0: &quot;</span> &lt;&lt; error_u_l2 &lt;&lt; <span class="stringliteral">&quot; p_0: &quot;</span> &lt;&lt; error_p_l2</div><div class="line">            &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">      data_component_interpretation(</div><div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation.push_back(</div><div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_solution,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated;</div><div class="line">    interpolated.reinit(owned_partitioning, MPI_COMM_WORLD);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler, ExactSolution&lt;dim&gt;(), interpolated);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated_relevant(owned_partitioning,</div><div class="line">                                               relevant_partitioning,</div><div class="line">                                               MPI_COMM_WORLD);</div><div class="line">    interpolated_relevant = interpolated;</div><div class="line">    {</div><div class="line">      std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;ref_u&quot;</span>);</div><div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;ref_p&quot;</span>);</div><div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(interpolated_relevant,</div><div class="line">                               solution_names,</div><div class="line">                               <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                               data_component_interpretation);</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using PETSc.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using Trilinos.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles = 5;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; ++cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == 0)</div><div class="line">          make_grid();</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          refine_grid();</div><div class="line"></div><div class="line">        setup_system();</div><div class="line"></div><div class="line">        assemble_system();</div><div class="line">        solve();</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(mpi_communicator) &lt;= 32)</div><div class="line">          {</div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;output&quot;</span>);</div><div class="line">            output_results(cycle);</div><div class="line">          }</div><div class="line"></div><div class="line">        computing_timer.print_summary();</div><div class="line">        computing_timer.reset();</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">} <span class="comment">// namespace Step55</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step55;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line"></div><div class="line">      StokesProblem&lt;2&gt; problem(2);</div><div class="line">      problem.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>As expected from the discussion above, the number of iterations is independent of the number of processors and only very slightly dependent on \(h\):</p>
<table class="doxtable">
<tr>
<th colspan="2">PETSc </th><th colspan="8">number of processors  </th></tr>
<tr>
<th>cycle </th><th>dofs </th><th>1 </th><th>2 </th><th>4 </th><th>8 </th><th>16 </th><th>32 </th><th>64 </th><th>128  </th></tr>
<tr>
<td>0 </td><td>659 </td><td>49 </td><td>49 </td><td>49 </td><td>51 </td><td>51 </td><td>51 </td><td>49 </td><td>49  </td></tr>
<tr>
<td>1 </td><td>2467 </td><td>52 </td><td>52 </td><td>52 </td><td>52 </td><td>52 </td><td>54 </td><td>54 </td><td>53  </td></tr>
<tr>
<td>2 </td><td>9539 </td><td>56 </td><td>56 </td><td>56 </td><td>54 </td><td>56 </td><td>56 </td><td>54 </td><td>56  </td></tr>
<tr>
<td>3 </td><td>37507 </td><td>57 </td><td>57 </td><td>57 </td><td>57 </td><td>57 </td><td>56 </td><td>57 </td><td>56  </td></tr>
<tr>
<td>4 </td><td>148739 </td><td>58 </td><td>59 </td><td>57 </td><td>59 </td><td>57 </td><td>57 </td><td>57 </td><td>57  </td></tr>
<tr>
<td>5 </td><td>592387 </td><td>60 </td><td>60 </td><td>59 </td><td>59 </td><td>59 </td><td>59 </td><td>59 </td><td>59  </td></tr>
<tr>
<td>6 </td><td>2364419 </td><td>62 </td><td>62 </td><td>61 </td><td>61 </td><td>61 </td><td>61 </td><td>61 </td><td>61  </td></tr>
</table>
<table class="doxtable">
<tr>
<th colspan="2">Trilinos </th><th colspan="8">number of processors  </th></tr>
<tr>
<th>cycle </th><th>dofs </th><th>1 </th><th>2 </th><th>4 </th><th>8 </th><th>16 </th><th>32 </th><th>64 </th><th>128  </th></tr>
<tr>
<td>0 </td><td>659 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37  </td></tr>
<tr>
<td>1 </td><td>2467 </td><td>92 </td><td>89 </td><td>89 </td><td>82 </td><td>86 </td><td>81 </td><td>78 </td><td>78  </td></tr>
<tr>
<td>2 </td><td>9539 </td><td>102 </td><td>99 </td><td>96 </td><td>95 </td><td>95 </td><td>88 </td><td>83 </td><td>95  </td></tr>
<tr>
<td>3 </td><td>37507 </td><td>107 </td><td>105 </td><td>104 </td><td>99 </td><td>100 </td><td>96 </td><td>96 </td><td>90  </td></tr>
<tr>
<td>4 </td><td>148739 </td><td>112 </td><td>112 </td><td>111 </td><td>111 </td><td>127 </td><td>126 </td><td>115 </td><td>117  </td></tr>
<tr>
<td>5 </td><td>592387 </td><td>116 </td><td>115 </td><td>114 </td><td>112 </td><td>118 </td><td>120 </td><td>131 </td><td>130  </td></tr>
<tr>
<td>6 </td><td>2364419 </td><td>130 </td><td>126 </td><td>120 </td><td>120 </td><td>121 </td><td>122 </td><td>121 </td><td>123  </td></tr>
</table>
<p>While the PETSc results show a constant number of iterations, the iterations increase when using Trilinos. This is likely because of the different settings used for the AMG preconditioner. For performance reasons we do not allow coarsening below a couple thousand unknowns. As the coarse solver is an exact solve (we are using LU by default), a change in number of levels will influence the quality of a V-cycle. Therefore, a V-cycle is closer to an exact solver for smaller problem sizes.</p>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p><a class="anchor" id="InvestigateTrilinositerations"></a></p><h4>Investigate Trilinos iterations</h4>
<p>Play with the smoothers, smoothing steps, and other properties for the Trilinos AMG to achieve an optimal preconditioner.</p>
<p><a class="anchor" id="SolvetheOseenprobleminsteadoftheStokessystem"></a></p><h4>Solve the Oseen problem instead of the Stokes system</h4>
<p>This change requires changing the outer solver to GMRES or BiCGStab, because the system is no longer symmetric.</p>
<p>You can prescribe the exact flow solution as \(b\) in the convective term \(b \cdot \nabla u\). This should give the same solution as the original problem, if you set the right hand side to zero.</p>
<p><a class="anchor" id="Adaptiverefinement"></a></p><h4>Adaptive refinement</h4>
<p>So far, this tutorial program refines the mesh globally in each step. Replacing the code in StokesProblem::refine_grid() by something like </p><div class="fragment"><div class="line"><a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line"></div><div class="line"><a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"><a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div><div class="line">  dof_handler,</div><div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div><div class="line">  std::map&lt;<a class="code" href="classunsigned_01int.html">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div><div class="line">  locally_relevant_solution,</div><div class="line">  estimated_error_per_cell,</div><div class="line">  fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"><a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#aa2ffb707a796ae6dedb75036606ef2e6">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_number</a>(</div><div class="line">  triangulation, estimated_error_per_cell, 0.3, 0.0);</div><div class="line">triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>();</div></div><!-- fragment --><p> makes it simple to explore adaptive mesh refinement.</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2016 - 2021 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Timo Heister, Clemson University, 2016</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="generic__linear__algebra_8h.html">deal.II/lac/generic_linear_algebra.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* #define FORCE_USE_OF_TRILINOS */</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>LA</div><div class="line">{</div><div class="line"><span class="preprocessor">#if defined(DEAL_II_WITH_PETSC) &amp;&amp; !defined(DEAL_II_PETSC_WITH_COMPLEX) &amp;&amp; \</span></div><div class="line"><span class="preprocessor">  !(defined(DEAL_II_WITH_TRILINOS) &amp;&amp; defined(FORCE_USE_OF_TRILINOS))</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraPETSc;</div><div class="line"><span class="preprocessor">#  define USE_PETSC_LA</span></div><div class="line"><span class="preprocessor">#elif defined(DEAL_II_WITH_TRILINOS)</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraTrilinos;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">#  error DEAL_II_WITH_PETSC or DEAL_II_WITH_TRILINOS required</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">} <span class="comment">// namespace LA</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__minres_8h.html">deal.II/lac/solver_minres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__sparse__matrix_8h.html">deal.II/lac/petsc_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__vector_8h.html">deal.II/lac/petsc_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__solver_8h.html">deal.II/lac/petsc_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__precondition_8h.html">deal.II/lac/petsc_precondition.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparsity__tools_8h.html">deal.II/lac/sparsity_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step55</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">namespace </span>LinearSolvers</div><div class="line">  {</div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">    {</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">      InverseMatrix(<span class="keyword">const</span> Matrix &amp;m, <span class="keyword">const</span> Preconditioner &amp;preconditioner);</div><div class="line"></div><div class="line">      <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">      <span class="keywordtype">void</span> vmult(VectorType &amp;dst, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const Matrix&gt;</a> <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">      <span class="keyword">const</span> Preconditioner &amp;           preconditioner;</div><div class="line">    };</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    InverseMatrix&lt;Matrix, Preconditioner&gt;::InverseMatrix(</div><div class="line">      <span class="keyword">const</span> Matrix &amp;        m,</div><div class="line">      <span class="keyword">const</span> Preconditioner &amp;preconditioner)</div><div class="line">      : matrix(&amp;m)</div><div class="line">      , preconditioner(preconditioner)</div><div class="line">    {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">    <span class="keywordtype">void</span></div><div class="line">    InverseMatrix&lt;Matrix, Preconditioner&gt;::vmult(VectorType &amp;      dst,</div><div class="line">                                                 <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">    </span>{</div><div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(src.size(), 1e-8 * src.l2_norm());</div><div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;LA::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line">      dst = 0;</div><div class="line"></div><div class="line">      <span class="keywordflow">try</span></div><div class="line">        {</div><div class="line">          cg.solve(*matrix, dst, src, preconditioner);</div><div class="line">        }</div><div class="line">      <span class="keywordflow">catch</span> (std::exception &amp;e)</div><div class="line">        {</div><div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(e.what()));</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    <span class="keyword">class </span>BlockDiagonalPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">    {</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">      BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                  <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S);</div><div class="line"></div><div class="line">      <span class="keywordtype">void</span> <a class="code" href="structSUNDIALS_1_1SundialsPreconditioner.html#aff5a880cfa288ecdd2a83a876abacf0d">vmult</a>(<a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">                 <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">      <span class="keyword">const</span> PreconditionerA &amp;preconditioner_A;</div><div class="line">      <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S;</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::</div><div class="line">      BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                  <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S)</div><div class="line">      : preconditioner_A(preconditioner_A)</div><div class="line">      , preconditioner_S(preconditioner_S)</div><div class="line">    {}</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    <span class="keywordtype">void</span> BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::vmult(</div><div class="line">      <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">    </span>{</div><div class="line">      preconditioner_A.vmult(dst.block(0), src.block(0));</div><div class="line">      preconditioner_S.<a class="code" href="classPreconditionIdentity.html#a5cb13bb838919dd8b1ba531f20f21955">vmult</a>(dst.block(1), src.block(1));</div><div class="line">    }</div><div class="line"></div><div class="line">  } <span class="comment">// namespace LinearSolvers</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">    values[0] =</div><div class="line">      -1.0L / 2.0L * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0) *</div><div class="line">        <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">      0.4 * pi2 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) +</div><div class="line">      0.1 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 2) *</div><div class="line">        <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi);</div><div class="line">    values[1] = 0.2 * pi * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">                  <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) -</div><div class="line">                0.05 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 3) *</div><div class="line">                  <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">                  pi;</div><div class="line">    values[2] = 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>ExactSolution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    ExactSolution()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> ExactSolution&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">    values[0] =</div><div class="line">      -<a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) + 1;</div><div class="line">    values[1] = (1.0L / 2.0L) * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">                <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">                pi;</div><div class="line">    values[2] =</div><div class="line">      -1.0L / 2.0L * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">      2.0 *</div><div class="line">        (-6538034.74494422 +</div><div class="line">         0.0134758939981709 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(4 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">        (-80.0 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">         16.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) -</div><div class="line">      1634508.68623606 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">        (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">      (-0.00673794699908547 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">       3269017.37247211 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">        (-8 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 40.0) +</div><div class="line">      0.00336897349954273 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(1.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">        (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2));</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>StokesProblem</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> make_grid();</div><div class="line">    <span class="keywordtype">void</span> setup_system();</div><div class="line">    <span class="keywordtype">void</span> assemble_system();</div><div class="line">    <span class="keywordtype">void</span> solve();</div><div class="line">    <span class="keywordtype">void</span> refine_grid();</div><div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree;</div><div class="line">    <span class="keywordtype">double</span>       viscosity;</div><div class="line">    <a class="code" href="classMPI__Comm.html">MPI_Comm</a>     mpi_communicator;</div><div class="line"></div><div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">    std::vector&lt;IndexSet&gt; owned_partitioning;</div><div class="line">    std::vector&lt;IndexSet&gt; relevant_partitioning;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> system_matrix;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       locally_relevant_solution;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       system_rhs;</div><div class="line"></div><div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line">    <a class="code" href="classTimerOutput.html">TimerOutput</a>        computing_timer;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  StokesProblem&lt;dim&gt;::StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree)</div><div class="line">    : velocity_degree(velocity_degree)</div><div class="line">    , viscosity(0.1)</div><div class="line">    , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">    , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree - 1), 1)</div><div class="line">    , triangulation(mpi_communicator,</div><div class="line">                    typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::MeshSmoothing(</div><div class="line">                      <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_refinement |</div><div class="line">                      <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_coarsening))</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , pcout(<a class="code" href="namespacestd.html">std</a>::cout,</div><div class="line">            (<a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0))</div><div class="line">    , computing_timer(mpi_communicator,</div><div class="line">                      pcout,</div><div class="line">                      <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div><div class="line">                      <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::make_grid()</div><div class="line">  {</div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, -0.5, 1.5);</div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(3);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_system()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;setup&quot;</span>);</div><div class="line"></div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    std::vector&lt;unsigned int&gt; stokes_sub_blocks(dim + 1, 0);</div><div class="line">    stokes_sub_blocks[dim] = 1;</div><div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div><div class="line">          &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    owned_partitioning.resize(2);</div><div class="line">    owned_partitioning[0] = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">    owned_partitioning[1] =</div><div class="line">      dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">    <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div><div class="line">    relevant_partitioning.resize(2);</div><div class="line">    relevant_partitioning[0] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">    relevant_partitioning[1] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line">    {</div><div class="line">      constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               ExactSolution&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      constraints.close();</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      system_matrix.clear();</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line">          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == dim || d == dim || c == d)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">        dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">        dsp,</div><div class="line">        dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>(),</div><div class="line">        mpi_communicator,</div><div class="line">        locally_relevant_dofs);</div><div class="line"></div><div class="line">      system_matrix.reinit(owned_partitioning, dsp, mpi_communicator);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      preconditioner_matrix.clear();</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">        dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line">      <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">        dsp,</div><div class="line">        <a class="code" href="namespaceUtilities_1_1MPI.html#ac5a7433f594a19070add2afa0f769efb">Utilities::MPI::all_gather</a>(mpi_communicator,</div><div class="line">                                   dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>()),</div><div class="line">        mpi_communicator,</div><div class="line">        locally_relevant_dofs);</div><div class="line">      preconditioner_matrix.reinit(owned_partitioning,</div><div class="line">                                   dsp,</div><div class="line">                                   mpi_communicator);</div><div class="line">    }</div><div class="line"></div><div class="line">    locally_relevant_solution.reinit(owned_partitioning,</div><div class="line">                                     relevant_partitioning,</div><div class="line">                                     mpi_communicator);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div><div class="line"></div><div class="line">    system_matrix         = 0;</div><div class="line">    preconditioner_matrix = 0;</div><div class="line">    system_rhs            = 0;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(velocity_degree + 1);</div><div class="line"></div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> cell_matrix2(dofs_per_cell, dofs_per_cell);</div><div class="line">    Vector&lt;double&gt;     cell_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, Vector&lt;double&gt;(dim + 1));</div><div class="line"></div><div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;         div_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;         phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocities(0);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a>     pressure(dim);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">        {</div><div class="line">          cell_matrix  = 0;</div><div class="line">          cell_matrix2 = 0;</div><div class="line">          cell_rhs     = 0;</div><div class="line"></div><div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">          right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                            rhs_values);</div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">                {</div><div class="line">                  grad_phi_u[k] = fe_values[velocities].gradient(k, q);</div><div class="line">                  div_phi_u[k]  = fe_values[velocities].divergence(k, q);</div><div class="line">                  phi_p[k]      = fe_values[pressure].value(k, q);</div><div class="line">                }</div><div class="line"></div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line">                    {</div><div class="line">                      <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                        (viscosity *</div><div class="line">                           <a class="code" href="symmetric__tensor_8h.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[i], grad_phi_u[j]) -</div><div class="line">                         div_phi_u[i] * phi_p[j] - phi_p[i] * div_phi_u[j]) *</div><div class="line">                        fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                      cell_matrix2(i, j) += 1.0 / viscosity * phi_p[i] *</div><div class="line">                                            phi_p[j] * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                    }</div><div class="line"></div><div class="line">                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                    fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                  cell_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q) *</div><div class="line">                                 rhs_values[q](component_i) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line"></div><div class="line">          cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">          constraints.distribute_local_to_global(cell_matrix,</div><div class="line">                                                 cell_rhs,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 system_rhs);</div><div class="line"></div><div class="line">          constraints.distribute_local_to_global(cell_matrix2,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 preconditioner_matrix);</div><div class="line">        }</div><div class="line"></div><div class="line">    system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    preconditioner_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;solve&quot;</span>);</div><div class="line"></div><div class="line">    LA::MPI::PreconditionAMG prec_A;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_A.initialize(system_matrix.block(0, 0), data);</div><div class="line">    }</div><div class="line"></div><div class="line">    LA::MPI::PreconditionAMG prec_S;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_S.initialize(preconditioner_matrix.block(1, 1), data);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">using</span> mp_inverse_t = LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LA::MPI::SparseMatrix</a>,</div><div class="line">                                                      LA::MPI::PreconditionAMG&gt;;</div><div class="line">    <span class="keyword">const</span> mp_inverse_t mp_inverse(preconditioner_matrix.block(1, 1), prec_S);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> LinearSolvers::BlockDiagonalPreconditioner&lt;<a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>,</div><div class="line">                                                     mp_inverse_t&gt;</div><div class="line">      preconditioner(prec_A, mp_inverse);</div><div class="line"></div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(system_matrix.m(),</div><div class="line">                                 1e-10 * system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>());</div><div class="line"></div><div class="line">    <a class="code" href="classSolverMinRes.html">SolverMinRes&lt;LA::MPI::BlockVector&gt;</a> solver(solver_control);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> distributed_solution(owned_partitioning,</div><div class="line">                                              mpi_communicator);</div><div class="line"></div><div class="line">    constraints.set_zero(distributed_solution);</div><div class="line"></div><div class="line">    solver.solve(system_matrix,</div><div class="line">                 distributed_solution,</div><div class="line">                 system_rhs,</div><div class="line">                 preconditioner);</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Solved in &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span></div><div class="line">          &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    constraints.distribute(distributed_solution);</div><div class="line"></div><div class="line">    locally_relevant_solution = distributed_solution;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> mean_pressure =</div><div class="line">      VectorTools::compute_mean_value(dof_handler,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(velocity_degree + 2),</div><div class="line">                                      locally_relevant_solution,</div><div class="line">                                      dim);</div><div class="line">    distributed_solution.block(1).add(-mean_pressure);</div><div class="line">    locally_relevant_solution.block(1) = distributed_solution.block(1);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_grid()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;refine&quot;</span>);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    {</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> pressure_mask(dim, dim + 1);</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> velocity_mask(std::make_pair(0, dim),</div><div class="line">                                                       dim + 1);</div><div class="line"></div><div class="line">      Vector&lt;double&gt; cellwise_errors(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>    quadrature(velocity_degree + 2);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;velocity_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_u_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;pressure_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_p_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;error: u_0: &quot;</span> &lt;&lt; error_u_l2 &lt;&lt; <span class="stringliteral">&quot; p_0: &quot;</span> &lt;&lt; error_p_l2</div><div class="line">            &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">      data_component_interpretation(</div><div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation.push_back(</div><div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_solution,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated;</div><div class="line">    interpolated.reinit(owned_partitioning, MPI_COMM_WORLD);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler, ExactSolution&lt;dim&gt;(), interpolated);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated_relevant(owned_partitioning,</div><div class="line">                                               relevant_partitioning,</div><div class="line">                                               MPI_COMM_WORLD);</div><div class="line">    interpolated_relevant = interpolated;</div><div class="line">    {</div><div class="line">      std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;ref_u&quot;</span>);</div><div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;ref_p&quot;</span>);</div><div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(interpolated_relevant,</div><div class="line">                               solution_names,</div><div class="line">                               <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                               data_component_interpretation);</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    Vector&lt;float&gt; subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using PETSc.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using Trilinos.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles = 5;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; ++cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == 0)</div><div class="line">          make_grid();</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          refine_grid();</div><div class="line"></div><div class="line">        setup_system();</div><div class="line"></div><div class="line">        assemble_system();</div><div class="line">        solve();</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(mpi_communicator) &lt;= 32)</div><div class="line">          {</div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;output&quot;</span>);</div><div class="line">            output_results(cycle);</div><div class="line">          }</div><div class="line"></div><div class="line">        computing_timer.print_summary();</div><div class="line">        computing_timer.reset();</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">} <span class="comment">// namespace Step55</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step55;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line"></div><div class="line">      StokesProblem&lt;2&gt; problem(2);</div><div class="line">      problem.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>This tutorial depends on <a class="el" href="step_40.html">step-40</a> , <a class="el" href="step_22.html">step-22</a> . <table
 class="tutorial" width="50%"> <tr><th colspan="2"><b><small>Table of
 contents</small></b><b><small>Table of contents</small></b></th></tr>
 <tr><td width="50%" valign="top">
 <ol>
 <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro"
 class=bold>Introduction</a>
 <ul>
 <li><a href="#Optimalpreconditioners">Optimal preconditioners</a><a
 href="#Optimalpreconditioners">Optimal preconditioners</a>
 <li><a href="#Thesolverandpreconditioner">The solver and
 preconditioner</a><a href="#Thesolverandpreconditioner">The solver and
 preconditioner</a>
 <li><a href="#Thetestcase">The testcase</a><a href="#Thetestcase">The
 testcase</a>
 </ul>
 <li> <a href="#CommProg" class=bold>The commented program</a><a
 href="#CommProg" class=bold>The commented program</a>
 <ul>
 <li><a href="#Linearsolversandpreconditioners">Linear solvers and
 preconditioners</a><a href="#Linearsolversandpreconditioners">Linear
 solvers and preconditioners</a>
 <li><a href="#Problemsetup">Problem setup</a><a
 href="#Problemsetup">Problem setup</a>
 <li><a href="#Themainprogram">The main program</a><a
 href="#Themainprogram">The main program</a>
 <li><a href="#SystemSetup">System Setup</a><a href="#SystemSetup">System
 Setup</a>
 <li><a href="#Assembly">Assembly</a><a href="#Assembly">Assembly</a>
 <li><a href="#Solving">Solving</a><a href="#Solving">Solving</a>
 <li><a href="#Therest">The rest</a><a href="#Therest">The rest</a>
 </ul>
 </ol></td><td width="50%" valign="top"><ol>
 <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results"
 class=bold>Results</a>
 <ul>
 <li><a href="#Possibilitiesforextensions">Possibilities for
 extensions</a><a href="#Possibilitiesforextensions">Possibilities for
 extensions</a>
 <ul>
 <li><a href="#InvestigateTrilinositerations">Investigate Trilinos
 iterations</a><a href="#InvestigateTrilinositerations">Investigate Trilinos
 iterations</a>
 <li><a href="#SolvetheOseenprobleminsteadoftheStokessystem">Solve the Oseen
 problem instead of the Stokes system</a><a
 href="#SolvetheOseenprobleminsteadoftheStokessystem">Solve the Oseen
 problem instead of the Stokes system</a>
 <li><a href="#Adaptiverefinement">Adaptive refinement</a><a
 href="#Adaptiverefinement">Adaptive refinement</a>
 </ul>
 </ul>
 <li> <a href="#PlainProg" class=bold>The plain program</a><a
 href="#PlainProg" class=bold>The plain program</a>
 </ol> </td> </tr> </table>
  <br />
 <em>This program was contributed by Timo Heister. Special thanks to Sander Rhebergen for the inspiration to finally write this tutorial.</em></p>
<p><em> This material is based upon work partially supported by National Science Foundation grant DMS1522191 and the Computational Infrastructure in Geodynamics initiative (CIG), through the National Science Foundation under Award No. EAR-0949446 and The University of California-Davis.</em></p>
<p><em> The authors would like to thank the Isaac Newton Institute for Mathematical Sciences, Cambridge, for support and hospitality during the programme Melt in the Mantle where work on this tutorial was undertaken. This work was supported by EPSRC grant no EP/K032208/1. </em></p>
<dl class="section note"><dt>Note</dt><dd>As a prerequisite of this program, you need to have PETSc or Trilinosand the p4est library installed. The installation of deal.II together withthese additional libraries is described in the <a href="../../readme.html" target="body">README</a> file. <a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a><h1>Introduction</h1>
</dd></dl>
<p>Building on <a class="el" href="step_40.html">step-40</a> , this tutorial shows how to solve linear PDEs with severalcomponents in parallel using MPI with PETSc or Trilinos for the linearalgebra. For this, we return to the Stokes equations as discussed in <a class="el" href="step_22.html">step-22</a> . The motivation for writing this tutorial is to provide anintermediate step (pun intended) between <a class="el" href="step_40.html">step-40</a> (parallel Laplace) and <a class="el" href="step_32.html">step-32</a> (parallel coupled Stokes with Boussinesq for a time dependentproblem). The learning outcomes for this tutorial are:</p>
<ul>
<li>You are able to solve PDEs with several variables in parallel and can apply this to different problems.</li>
<li>You understand the concept of optimal preconditioners and are able to check this for a particular problem.</li>
<li>You are able to construct manufactured solutions using the free computer algreba system SymPy (<a href="https://sympy.org">https://sympy.org</a>).</li>
<li>You can implement various other tasks for parallel programs: error computation, writing graphical output, etc.</li>
<li>You can visualize vector fields, stream lines, and contours of vector quantities. We are solving for a velocity \(\textbf{u}\) and pressure \(p\) that satisfy theStokes equation, which reads <p class="formulaDsp">
\begin{eqnarray*} - \triangle \textbf{u} + \nabla p &amp;=&amp; \textbf{f}, \\ -\textrm{div}\; \textbf{u} &amp;=&amp; 0. \end{eqnarray*}
</p>
</li>
</ul>
<p><a class="anchor" id="Optimalpreconditioners"></a></p><h3>Optimal preconditioners</h3>
<p>Make sure that you read (even better: try) what is described in "Block
 Schurcomplement preconditioner" in the "Possible Extensions" section in <a class="el" href="step_22.html">step-22</a> .Like described there, we are going to solve the block system using a Krylovmethod and a block preconditioner. Our goal here is to construct a very simple (maybe the simplest?) optimalpreconditioner for the linear system. A preconditioner is called "optimal" or"of optimal
 complexity", if the number of iterations of the preconditionedsystem is independent of the mesh size \(h\) . You can extend that definition toalso require indepence of the number of processors used (we will discuss thatin the results section), the computational domain and the mesh quality, thetest case itself, the polynomial degree of the finite element space, and more. Why is a constant number of iterations considered to be "optimal"? Assume thediscretized PDE gives a linear system with N unknowns. Because the matrixcoming from the FEM discretization is sparse, a matrix-vector product can bedone in O(N) time. A preconditioner application can also only be O(N) at best(for example doable with multigrid methods). If the number of iterationsrequired to solve the linear system is independent of \(h\) (and therefore N),the total cost of solving the system will be O(N). It is not possible to beatthis complexity, because even looking at all the entries of the right-handside already takes O(N) time. For more information see <b>[elman2005]</b> ,Chapter 2.5 (<a class="el" href="classMultigrid.html">Multigrid</a>). The preconditioner described here is even simpler than the one described in <a class="el" href="step_22.html">step-22</a> and will typically require more iterations and consequently time tosolve. When considering preconditioners, optimality is not the only importantmetric. But an optimal and expensive preconditioner is typically moredesirable than a cheaper, non-optimal one. This is because, eventually, as themesh size becomes smaller and smaller and linear problems become bigger andbigger, the former will eventually beat the latter. <a class="anchor" id="Thesolverandpreconditioner"></a></p><h3>The solver and preconditioner</h3>
<p>We precondition the linear system </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{c} U \\ P \end{array}\right) = \left(\begin{array}{c} F \\ 0 \end{array}\right), \end{eqnarray*}
</p>
<p>with the block diagonal preconditioner </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1} = \left(\begin{array}{cc} A &amp; 0 \\ 0 &amp; S \end{array}\right) ^{-1}, = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ 0 &amp; S^{-1} \end{array}\right), \end{eqnarray*}
</p>
<p> where \(S=-BA^{-1} B^T\) is the Schur complement. With this choice of \(P\) , assuming that we handle \(A^{-1}\) and \(S^{-1}\) exactly(which is an "idealized" situation), the preconditioned linear system hasthree distinct eigenvalues independent of \(h\) and is therefore "optimal". Seesection 6.2.1 (especially p. 292) in <b>[elman2005]</b> . For comparison,using the ideal version of the upper block-triangular preconditioner in <a class="el" href="step_22.html">step-22</a> (also used in <a class="el" href="step_56.html">step-56</a> ) would have all eigenvalues be equal to one. We will use approximations of the inverse operations in \(P^{-1}\) that are(nearly) independent of \(h\) . In this situation, one can again show, that theeigenvalues are independent of \(h\) . For the Krylov method we choose MINRES,which is attractive for the analysis (iteration count is proven to beindependent of \(h\) , see the remainder of the chapter 6.2.1 in the bookmentioned above), great from the computational standpoint (simpler and cheaperthan GMRES for example), and applicable (matrix and preconditioner aresymmetric). For the approximations we will use a CG solve with the mass matrix in thepressure space for approximating the action of \(S^{-1}\) . Note that the massmatrix is spectrally equivalent to \(S\) . We can expect the number of CGiterations to be independent of \(h\) , even with a simple preconditioner likeILU. For the approximation of the velocity block \(A\) we will perform a single AMGV-cycle. In practice this choice is not exactly independent of \(h\) , which canexplain the slight increase in iteration numbers. A possible explanation isthat the coarsest level will be solved exactly and the number of levels andsize of the coarsest matrix is not predictable.</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>We will construct a manufactured solution based on the classical Kovasznay problem,see <b>[kovasznay1948laminar]</b> . Hereis an image of the solution colored by the x velocity includingstreamlines of the velocity: </p><div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-55.solution.png"/>
</div>
<p> We have to cheat here, though, because we are not solving the non-linearNavier-Stokes equations, but the linear Stokes system without convectiveterm. Therefore, to recreate the exact same solution, we use the method ofmanufactured solutions with the solution of the Kovasznay problem. This willeffectively move the convective term into the right-hand side \(f\) . The right-hand side is computed using the script "reference.py" and we usethe exact solution for boundary conditions and error computation.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div></div><!-- fragment --><p>The following chunk out code is identical to <a class="el" href="step_40.html">step-40</a> and allows switching between PETSc and Trilinos:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="generic__linear__algebra_8h.html">deal.II/lac/generic_linear_algebra.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">// #define FORCE_USE_OF_TRILINOS</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>LA</div><div class="line">{</div><div class="line"><span class="preprocessor">#if defined(DEAL_II_WITH_PETSC) &amp;&amp; !defined(DEAL_II_PETSC_WITH_COMPLEX) &amp;&amp; \</span></div><div class="line"><span class="preprocessor">!(defined(DEAL_II_WITH_TRILINOS) &amp;&amp; defined(FORCE_USE_OF_TRILINOS))</span></div><div class="line"><span class="keyword">using namespace </span>dealii::LinearAlgebraPETSc;</div><div class="line"><span class="preprocessor">#  define USE_PETSC_LA</span></div><div class="line"><span class="preprocessor">#elif defined(DEAL_II_WITH_TRILINOS)</span></div><div class="line"><span class="keyword">using namespace </span>dealii::LinearAlgebraTrilinos;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">#  error DEAL_II_WITH_PETSC or DEAL_II_WITH_TRILINOS required</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">} <span class="comment">// namespace LA</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__minres_8h.html">deal.II/lac/solver_minres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__sparse__matrix_8h.html">deal.II/lac/petsc_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__vector_8h.html">deal.II/lac/petsc_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__solver_8h.html">deal.II/lac/petsc_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__precondition_8h.html">deal.II/lac/petsc_precondition.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparsity__tools_8h.html">deal.II/lac/sparsity_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step55</div><div class="line">{</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div></div><!-- fragment --><p><a class="anchor" id="Linearsolversandpreconditioners"></a> </p><h3>Linear solvers and preconditioners</h3>
<p>We need a few helper classes to represent our solver strategy described in the introduction.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>LinearSolvers</div><div class="line">{</div></div><!-- fragment --><p>This class exposes the action of applying the inverse of a giving matrix via the function InverseMatrix::vmult(). Internally, the inverse is not formed explicitly. Instead, a linear solver with CG is performed. This class extends the InverseMatrix class in <a class="el" href="step_22.html">step-22</a> with an option to specify a preconditioner, and to allow for different vector types in the vmult function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line"><span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  InverseMatrix(<span class="keyword">const</span> Matrix &amp;m, <span class="keyword">const</span> Preconditioner &amp;preconditioner);</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">  <span class="keywordtype">void</span> vmult(VectorType &amp;dst, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const Matrix&gt;</a> <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">  <span class="keyword">const</span> Preconditioner &amp;           preconditioner;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">InverseMatrix&lt;Matrix, Preconditioner&gt;::InverseMatrix(</div><div class="line">  <span class="keyword">const</span> Matrix &amp;        m,</div><div class="line">  <span class="keyword">const</span> Preconditioner &amp;preconditioner)</div><div class="line">  : matrix(&amp;m)</div><div class="line">  , preconditioner(preconditioner)</div><div class="line">{}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line"><span class="keywordtype">void</span></div><div class="line">InverseMatrix&lt;Matrix, Preconditioner&gt;::vmult(VectorType &amp;      dst,</div><div class="line">                                             <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(src.size(), 1e-8 src.l2_norm());</div><div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;LA::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line">  dst = 0;</div><div class="line"></div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      cg.solve(*matrix, dst, src, preconditioner);</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;e)</div><div class="line">    {</div><div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(e.what()));</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>The class A template class for a simple block diagonal preconditioner for 2x2 matrices.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  <span class="keyword">class </span>BlockDiagonalPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> vmult(<a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> PreconditionerA &amp;preconditioner_A;</div><div class="line">    <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S;</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::</div><div class="line">    BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S)</div><div class="line">    : preconditioner_A(preconditioner_A)</div><div class="line">    , preconditioner_S(preconditioner_S)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  <span class="keywordtype">void</span> BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::vmult(</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    preconditioner_A.vmult(dst.block(0), src.block(0));</div><div class="line">    preconditioner_S.<a class="code" href="classPreconditionIdentity.html#a5cb13bb838919dd8b1ba531f20f21955">vmult</a>(dst.block(1), src.block(1));</div><div class="line">  }</div><div class="line"></div><div class="line">} <span class="comment">// namespace LinearSolvers</span></div></div><!-- fragment --><p><a class="anchor" id="Problemsetup"></a> </p><h3>Problem setup</h3>
<p>The following classes represent the right hand side and the exact solution for the test problem.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  RightHandSide()</div><div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi pi;</div><div class="line">  values[0] =</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">-1.0L / 2.0L (-2 <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 pi2) + 10.0)</div><div class="line">      <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x (-2 <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 pi2) + 10.0))</div><div class="line"></div><div class="line">-</div><div class="line">    0.4 pi2 <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 pi2) + 5.0)) cos(2 R_y pi) +</div><div class="line">    0.1 pow(-sqrt(25.0 + 4 pi2) + 5.0, 2)</div><div class="line">      exp(R_x (-sqrt(25.0 + 4 pi2) + 5.0)) cos(2 R_y pi);</div><div class="line">  values[1] = 0.2 pi (-sqrt(25.0 + 4 pi2) + 5.0)</div><div class="line">                exp(R_x (-sqrt(25.0 + 4 pi2) + 5.0)) sin(2 R_y pi)</div><div class="line"></div><div class="line">-</div><div class="line">              0.05 pow(-sqrt(25.0 + 4 pi2) + 5.0, 3)</div><div class="line">                exp(R_x (-sqrt(25.0 + 4 pi2) + 5.0)) sin(2 R_y pi) /</div><div class="line">                pi;</div><div class="line">  values[2] = 0;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">template &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">class ExactSolution : public <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ExactSolution()</div><div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ExactSolution&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi pi;</div><div class="line">  values[0] =</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">-<a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 pi2) + 5.0)) cos(2 R_y pi) + 1;</div><div class="line">  values[1] = (1.0<a class="code" href="namespaceLAPACKSupport.html#a0a1f0b9f7bb0b746b8f27d7f297ed7fe">L</a> / 2.0<a class="code" href="namespaceLAPACKSupport.html#a0a1f0b9f7bb0b746b8f27d7f297ed7fe">L</a>) (-sqrt(25.0 + 4 pi2) + 5.0)</div><div class="line">              exp(R_x (-sqrt(25.0 + 4 pi2) + 5.0)) sin(2 R_y pi) /</div><div class="line">              pi;</div><div class="line">  values[2] =</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">-1.0<a class="code" href="namespaceLAPACKSupport.html#a0a1f0b9f7bb0b746b8f27d7f297ed7fe">L</a> / 2.0<a class="code" href="namespaceLAPACKSupport.html#a0a1f0b9f7bb0b746b8f27d7f297ed7fe">L</a> exp(R_x (-2 sqrt(25.0 + 4 pi2) + 10.0))</div><div class="line"></div><div class="line">-</div><div class="line">    2.0</div><div class="line">      (-6538034.74494422 +</div><div class="line">       0.0134758939981709 exp(4 sqrt(25.0 + 4 pi2))) /</div><div class="line">      (-80.0 exp(3 sqrt(25.0 + 4 pi2)) +</div><div class="line">       16.0 sqrt(25.0 + 4 pi2) exp(3 sqrt(25.0 + 4 pi2)))</div><div class="line"></div><div class="line">-</div><div class="line">    1634508.68623606 exp(-3.0 sqrt(25.0 + 4 pi2)) /</div><div class="line">      (-10.0 + 2.0 sqrt(25.0 + 4 pi2)) +</div><div class="line">    (-0.00673794699908547 exp(sqrt(25.0 + 4 pi2)) +</div><div class="line">     3269017.37247211 exp(-3 sqrt(25.0 + 4 pi2))) /</div><div class="line">      (-8 sqrt(25.0 + 4 pi2) + 40.0) +</div><div class="line">    0.00336897349954273 exp(1.0 sqrt(25.0 + 4 pi2)) /</div><div class="line">      (-10.0 + 2.0 sqrt(25.0 + 4 pi2));</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Themainprogram"></a> </p><h3>The main program</h3>
<p>The main class is very similar to <a class="el" href="step_40.html">step-40</a> , except that matrices and vectors are now block versions, and we store a std::vector&lt;IndexSet&gt; for owned and relevant DoFs instead of a single <a class="el" href="classIndexSet.html">IndexSet</a>. We have exactly two IndexSets, one for all velocity unknowns and one for all pressure unknowns.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>StokesProblem</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree);</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> make_grid();</div><div class="line">  <span class="keywordtype">void</span> setup_system();</div><div class="line">  <span class="keywordtype">void</span> assemble_system();</div><div class="line">  <span class="keywordtype">void</span> solve();</div><div class="line">  <span class="keywordtype">void</span> refine_grid();</div><div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree;</div><div class="line">  <span class="keywordtype">double</span>       viscosity;</div><div class="line">  <a class="code" href="classMPI__Comm.html">MPI_Comm</a>     mpi_communicator;</div><div class="line"></div><div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">  <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">  std::vector&lt;IndexSet&gt; owned_partitioning;</div><div class="line">  std::vector&lt;IndexSet&gt; relevant_partitioning;</div><div class="line"></div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> system_matrix;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       locally_relevant_solution;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       system_rhs;</div><div class="line"></div><div class="line">  <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line">  <a class="code" href="classTimerOutput.html">TimerOutput</a>        computing_timer;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">StokesProblem&lt;dim&gt;::StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree)</div><div class="line">  : velocity_degree(velocity_degree)</div><div class="line">  , viscosity(0.1)</div><div class="line">  , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">  , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree</div><div class="line"></div><div class="line">- 1), 1)</div><div class="line">  , triangulation(mpi_communicator,</div><div class="line">                  typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::MeshSmoothing(</div><div class="line">                    <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_refinement |</div><div class="line">                    <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_coarsening))</div><div class="line">  , dof_handler(triangulation)</div><div class="line">  , pcout(<a class="code" href="namespacestd.html">std</a>::cout,</div><div class="line">          (<a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0))</div><div class="line">  , computing_timer(mpi_communicator,</div><div class="line">                    pcout,</div><div class="line">                    <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div><div class="line">                    <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div><div class="line">{}</div></div><!-- fragment --><p>The Kovasnay flow is defined on the domain [-0.5, 1.5]^2, which we create by passing the min and max values to <a class="el" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::make_grid()</div><div class="line">{</div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation,</div><div class="line"></div><div class="line">-0.5, 1.5);</div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(3);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="SystemSetup"></a> </p><h3>System Setup</h3>
<p>The construction of the block matrices and vectors is new compared to <a class="el" href="step_40.html">step-40</a> and is different compared to serial codes like <a class="el" href="step_22.html">step-22</a> , because we need to supply the set of rows that belong to our processor.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_system()</div><div class="line">{</div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;setup&quot;</span>);</div><div class="line"></div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div></div><!-- fragment --><p>Put all dim velocities into block 0 and the pressure into block 1, then reorder the unknowns by block. Finally count how many unknowns we have per block.</p>
<div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; stokes_sub_blocks(dim + 1, 0);</div><div class="line">stokes_sub_blocks[dim] = 1;</div><div class="line"><a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line"><span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">  <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div><div class="line">      &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div></div><!-- fragment --><p>We split up the <a class="el" href="classIndexSet.html">IndexSet</a> for locally owned and locally relevant DoFs into two IndexSets based on how we want to create the block matrices and vectors.</p>
<div class="fragment"><div class="line">owned_partitioning.resize(2);</div><div class="line">owned_partitioning[0] = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">owned_partitioning[1] =</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line"><a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line"><a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div><div class="line">relevant_partitioning.resize(2);</div><div class="line">relevant_partitioning[0] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">relevant_partitioning[1] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div></div><!-- fragment --><p>Setting up the constraints for boundary conditions and hanging nodes is identical to <a class="el" href="step_40.html">step-40</a> . Even though we don't have any hanging nodes because we only perform global refinement, it is still a good idea to put this function call in, in case adaptive refinement gets introduced later.</p>
<div class="fragment"><div class="line">{</div><div class="line">  constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           0,</div><div class="line">                                           ExactSolution&lt;dim&gt;(),</div><div class="line">                                           constraints,</div><div class="line">                                           fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">  constraints.close();</div><div class="line">}</div></div><!-- fragment --><p>Now we create the system matrix based on a <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a>. We know that we won't have coupling between different velocity components (because we use the laplace and not the deformation tensor) and no coupling between pressure with its test functions, so we use a <a class="el" href="classTable.html">Table</a> to communicate this coupling information to <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>.</p>
<div class="fragment"><div class="line">{</div><div class="line">  system_matrix.clear();</div><div class="line"></div><div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">      <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == dim || d == dim || c == d)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">      <span class="keywordflow">else</span></div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">    dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">  <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">    dsp,</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>(),</div><div class="line">    mpi_communicator,</div><div class="line">    locally_relevant_dofs);</div><div class="line"></div><div class="line">  system_matrix.reinit(owned_partitioning, dsp, mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>The preconditioner matrix has a different coupling (we only fill in the 1,1 block with the mass matrix), otherwise this code is identical to the construction of the system_matrix above.</p>
<div class="fragment"><div class="line">{</div><div class="line">  preconditioner_matrix.clear();</div><div class="line"></div><div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">      <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">      <span class="keywordflow">else</span></div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">    dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line">  <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">    dsp,</div><div class="line">    <a class="code" href="namespaceUtilities_1_1MPI.html#ac5a7433f594a19070add2afa0f769efb">Utilities::MPI::all_gather</a>(mpi_communicator,</div><div class="line">                               dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>()),</div><div class="line">    mpi_communicator,</div><div class="line">    locally_relevant_dofs);</div><div class="line">  preconditioner_matrix.reinit(owned_partitioning,</div></div><!-- fragment --><p>owned_partitioning,</p>
<div class="fragment"><div class="line">                               dsp,</div><div class="line">                               mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>Finally, we construct the block vectors with the right sizes. The function call with two std::vector&lt;IndexSet&gt; will create a ghosted vector.</p>
<div class="fragment"><div class="line">  locally_relevant_solution.reinit(owned_partitioning,</div><div class="line">                                   relevant_partitioning,</div><div class="line">                                   mpi_communicator);</div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Assembly"></a> </p><h3>Assembly</h3>
<p>This function assembles the system matrix, the preconditioner matrix, and the right hand side. The code is pretty standard.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">{</div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div><div class="line"></div><div class="line">  system_matrix         = 0;</div><div class="line">  preconditioner_matrix = 0;</div><div class="line">  system_rhs            = 0;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(velocity_degree + 1);</div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div><div class="line">                          quadrature_formula,</div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> cell_matrix2(dofs_per_cell, dofs_per_cell);</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(dim + 1));</div><div class="line"></div><div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(dofs_per_cell);</div><div class="line">  std::vector&lt;double&gt;         div_phi_u(dofs_per_cell);</div><div class="line">  std::vector&lt;double&gt;         phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocities(0);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a>     pressure(dim);</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">    <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">      {</div><div class="line">        cell_matrix  = 0;</div><div class="line">        cell_matrix2 = 0;</div><div class="line">        cell_rhs     = 0;</div><div class="line"></div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                          rhs_values);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">              {</div><div class="line">                grad_phi_u[k] = fe_values[velocities].gradient(k, q);</div><div class="line">                div_phi_u[k]  = fe_values[velocities].divergence(k, q);</div><div class="line">                phi_p[k]      = fe_values[pressure].value(k, q);</div><div class="line">              }</div><div class="line"></div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line">                  {</div><div class="line">                    <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                      (viscosity</div><div class="line">                         <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[i], grad_phi_u[j])</div><div class="line"></div><div class="line">-</div><div class="line">                       div_phi_u[i] phi_p[j]</div><div class="line"></div><div class="line">- phi_p[i] div_phi_u[j])</div><div class="line">                      fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                    cell_matrix2(i, j) += 1.0 / viscosity phi_p[i]</div><div class="line">                                          phi_p[j] fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                  }</div><div class="line"></div><div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                  fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                cell_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q)</div><div class="line">                               rhs_values[q](component_i) fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">              }</div><div class="line">          }</div><div class="line"></div><div class="line"></div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        constraints.distribute_local_to_global(cell_matrix,</div><div class="line">                                               cell_rhs,</div><div class="line">                                               local_dof_indices,</div><div class="line">                                               system_matrix,</div><div class="line">                                               system_rhs);</div><div class="line"></div><div class="line">        constraints.distribute_local_to_global(cell_matrix2,</div><div class="line">                                               local_dof_indices,</div><div class="line">                                               preconditioner_matrix);</div><div class="line">      }</div><div class="line"></div><div class="line">  system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  preconditioner_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Solving"></a> </p><h3>Solving</h3>
<p>This function solves the linear system with MINRES with a block diagonal preconditioner and AMG for the two diagonal blocks as described in the introduction. The preconditioner applies a v cycle to the 0,0 block and a CG with the mass matrix for the 1,1 block (the Schur complement).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">{</div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;solve&quot;</span>);</div><div class="line"></div><div class="line">  LA::MPI::PreconditionAMG prec_A;</div><div class="line">  {</div><div class="line">    LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">    data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    prec_A.initialize(system_matrix.block(0, 0), data);</div><div class="line">  }</div><div class="line"></div><div class="line">  LA::MPI::PreconditionAMG prec_S;</div><div class="line">  {</div><div class="line">    LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">    data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    prec_S.initialize(preconditioner_matrix.block(1, 1), data);</div><div class="line">  }</div></div><!-- fragment --><p>The InverseMatrix is used to solve for the mass matrix:</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> mp_inverse_t = LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LA::MPI::SparseMatrix</a>,</div><div class="line">                                                  LA::MPI::PreconditionAMG&gt;;</div><div class="line"><span class="keyword">const</span> mp_inverse_t mp_inverse(preconditioner_matrix.block(1, 1), prec_S);</div></div><!-- fragment --><p>This constructs the block preconditioner based on the preconditioners for the individual blocks defined above.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> LinearSolvers::BlockDiagonalPreconditioner&lt;<a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>,</div><div class="line">                                                 mp_inverse_t&gt;</div><div class="line">  preconditioner(prec_A, mp_inverse);</div></div><!-- fragment --><p>With that, we can finally set up the linear solver and solve the system:</p>
<div class="fragment"><div class="line"><a class="code" href="classSolverControl.html">SolverControl</a> solver_control(system_matrix.m(),</div><div class="line">                             1e-10 system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>());</div><div class="line"></div><div class="line"><a class="code" href="classSolverMinRes.html">SolverMinRes&lt;LA::MPI::BlockVector&gt;</a> solver(solver_control);</div><div class="line"></div><div class="line"><a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> distributed_solution(owned_partitioning,</div><div class="line">                                          mpi_communicator);</div><div class="line"></div><div class="line">constraints.set_zero(distributed_solution);</div><div class="line"></div><div class="line">solver.solve(system_matrix,</div><div class="line">             distributed_solution,</div><div class="line">             system_rhs,</div><div class="line">             preconditioner);</div><div class="line"></div><div class="line">pcout &lt;&lt; <span class="stringliteral">&quot;   Solved in &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span></div><div class="line">      &lt;&lt; std::endl;</div><div class="line"></div><div class="line">constraints.distribute(distributed_solution);</div></div><!-- fragment --><p>Like in <a class="el" href="step_56.html">step-56</a> , we subtract the mean pressure to allow error computations against our reference solution, which has a mean value of zero.</p>
<div class="fragment"><div class="line">  locally_relevant_solution = distributed_solution;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> mean_pressure =</div><div class="line">    VectorTools::compute_mean_value(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(velocity_degree + 2),</div><div class="line">                                    locally_relevant_solution,</div><div class="line">                                    dim);</div><div class="line">  distributed_solution.block(1).add(-mean_pressure);</div><div class="line">  locally_relevant_solution.block(1) = distributed_solution.block(1);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Therest"></a> </p><h3>The rest</h3>
<p>The remainder of the code that deals with mesh refinement, output, and the main loop is pretty standard.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_grid()</div><div class="line">{</div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;refine&quot;</span>);</div><div class="line"></div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>();</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  {</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> pressure_mask(dim, dim + 1);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> velocity_mask(std::make_pair(0, dim),</div><div class="line">                                                     dim + 1);</div><div class="line"></div><div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> cellwise_errors(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>    quadrature(velocity_degree + 2);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      locally_relevant_solution,</div><div class="line">                                      ExactSolution&lt;dim&gt;(),</div><div class="line">                                      cellwise_errors,</div><div class="line">                                      quadrature,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                      &amp;velocity_mask);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> error_u_l2 =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                      locally_relevant_solution,</div><div class="line">                                      ExactSolution&lt;dim&gt;(),</div><div class="line">                                      cellwise_errors,</div><div class="line">                                      quadrature,</div><div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                      &amp;pressure_mask);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> error_p_l2 =</div><div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;error: u_0: &quot;</span> &lt;&lt; error_u_l2 &lt;&lt; <span class="stringliteral">&quot; p_0: &quot;</span> &lt;&lt; error_p_l2</div><div class="line">          &lt;&lt; std::endl;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">    data_component_interpretation(</div><div class="line">      dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">  data_component_interpretation.push_back(</div><div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_solution,</div><div class="line">                           solution_names,</div><div class="line">                           <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                           data_component_interpretation);</div><div class="line"></div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated;</div><div class="line">  interpolated.reinit(owned_partitioning, MPI_COMM_WORLD);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler, ExactSolution&lt;dim&gt;(), interpolated);</div><div class="line"></div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated_relevant(owned_partitioning,</div><div class="line">                                             relevant_partitioning,</div><div class="line">                                             MPI_COMM_WORLD);</div><div class="line">  interpolated_relevant = interpolated;</div><div class="line">  {</div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;ref_u&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;ref_p&quot;</span>);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(interpolated_relevant,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">    subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line"></div><div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div><div class="line"></div><div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">    <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">{</div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;Running using PETSc.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;Running using Trilinos.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles = 5;</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; ++cycle)</div><div class="line">    {</div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (cycle == 0)</div><div class="line">        make_grid();</div><div class="line">      <span class="keywordflow">else</span></div><div class="line">        refine_grid();</div><div class="line"></div><div class="line">      setup_system();</div><div class="line"></div><div class="line">      assemble_system();</div><div class="line">      solve();</div><div class="line"></div><div class="line">      <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(mpi_communicator) &lt;= 32)</div><div class="line">        {</div><div class="line">          <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;output&quot;</span>);</div><div class="line">          output_results(cycle);</div><div class="line">        }</div><div class="line"></div><div class="line">      computing_timer.print_summary();</div><div class="line">      computing_timer.reset();</div><div class="line"></div><div class="line">      pcout &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line">}</div><div class="line">} <span class="comment">// namespace Step55</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, charargv[])</div><div class="line">{</div><div class="line"><span class="keywordflow">try</span></div><div class="line">  {</div><div class="line">    <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">    <span class="keyword">using namespace </span>Step55;</div><div class="line"></div><div class="line">    <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line"></div><div class="line">    StokesProblem&lt;2&gt; problem(2);</div><div class="line">    problem.run();</div><div class="line">  }</div><div class="line"><span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">  {</div><div class="line">    std::cerr &lt;&lt; std::endl</div><div class="line">              &lt;&lt; std::endl</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">              &lt;&lt; std::endl;</div><div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">              &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">              &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">  }</div><div class="line"><span class="keywordflow">catch</span> (...)</div><div class="line">  {</div><div class="line">    std::cerr &lt;&lt; std::endl</div><div class="line">              &lt;&lt; std::endl</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">              &lt;&lt; std::endl;</div><div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">              &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">              &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">  }</div><div class="line"></div><div class="line"><span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>As expected from the discussion above, the number of iterations is independentof the number of processors and only very slightly dependent on \(h\) : </p><table class="doxtable">
<tr>
<th colspan="2">PETSc </th><th colspan="8">number of processors  </th></tr>
<tr>
<th>cycle </th><th>dofs </th><th>1 </th><th>2 </th><th>4 </th><th>8 </th><th>16 </th><th>32 </th><th>64 </th><th>128  </th></tr>
<tr>
<td>0 </td><td>659 </td><td>49 </td><td>49 </td><td>49 </td><td>51 </td><td>51 </td><td>51 </td><td>49 </td><td>49  </td></tr>
<tr>
<td>1 </td><td>2467 </td><td>52 </td><td>52 </td><td>52 </td><td>52 </td><td>52 </td><td>54 </td><td>54 </td><td>53  </td></tr>
<tr>
<td>2 </td><td>9539 </td><td>56 </td><td>56 </td><td>56 </td><td>54 </td><td>56 </td><td>56 </td><td>54 </td><td>56  </td></tr>
<tr>
<td>3 </td><td>37507 </td><td>57 </td><td>57 </td><td>57 </td><td>57 </td><td>57 </td><td>56 </td><td>57 </td><td>56  </td></tr>
<tr>
<td>4 </td><td>148739 </td><td>58 </td><td>59 </td><td>57 </td><td>59 </td><td>57 </td><td>57 </td><td>57 </td><td>57  </td></tr>
<tr>
<td>5 </td><td>592387 </td><td>60 </td><td>60 </td><td>59 </td><td>59 </td><td>59 </td><td>59 </td><td>59 </td><td>59  </td></tr>
<tr>
<td>6 </td><td>2364419 </td><td>62 </td><td>62 </td><td>61 </td><td>61 </td><td>61 </td><td>61 </td><td>61 </td><td>61  </td></tr>
</table>
<table class="doxtable">
<tr>
<th colspan="2">Trilinos </th><th colspan="8">number of processors  </th></tr>
<tr>
<th>cycle </th><th>dofs </th><th>1 </th><th>2 </th><th>4 </th><th>8 </th><th>16 </th><th>32 </th><th>64 </th><th>128  </th></tr>
<tr>
<td>0 </td><td>659 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37  </td></tr>
<tr>
<td>1 </td><td>2467 </td><td>92 </td><td>89 </td><td>89 </td><td>82 </td><td>86 </td><td>81 </td><td>78 </td><td>78  </td></tr>
<tr>
<td>2 </td><td>9539 </td><td>102 </td><td>99 </td><td>96 </td><td>95 </td><td>95 </td><td>88 </td><td>83 </td><td>95  </td></tr>
<tr>
<td>3 </td><td>37507 </td><td>107 </td><td>105 </td><td>104 </td><td>99 </td><td>100 </td><td>96 </td><td>96 </td><td>90  </td></tr>
<tr>
<td>4 </td><td>148739 </td><td>112 </td><td>112 </td><td>111 </td><td>111 </td><td>127 </td><td>126 </td><td>115 </td><td>117  </td></tr>
<tr>
<td>5 </td><td>592387 </td><td>116 </td><td>115 </td><td>114 </td><td>112 </td><td>118 </td><td>120 </td><td>131 </td><td>130  </td></tr>
<tr>
<td>6 </td><td>2364419 </td><td>130 </td><td>126 </td><td>120 </td><td>120 </td><td>121 </td><td>122 </td><td>121 </td><td>123  </td></tr>
</table>
<p>While the PETSc results show a constant number of iterations, the iterationsincrease when using Trilinos. This is likely because of the different settingsused for the AMG preconditioner. For performance reasons we do not allowcoarsening below a couple thousand unknowns. As the coarse solver is an exactsolve (we are using LU by default), a change in number of levels willinfluence the quality of a V-cycle. Therefore, a V-cycle is closer to an exactsolver for smaller problem sizes. <a class="anchor" id="extensions"></a><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p><a class="anchor" id="InvestigateTrilinositerations"></a></p><h4>Investigate Trilinos iterations</h4>
<p>Play with the smoothers, smoothing steps, and other properties for theTrilinos AMG to achieve an optimal preconditioner. <a class="anchor" id="SolvetheOseenprobleminsteadoftheStokessystem"></a></p><h4>Solve the Oseen problem instead of the Stokes system</h4>
<p>This change requires changing the outer solver to GMRES or BiCGStab, becausethe system is no longer symmetric. You can prescribe the exact flow solution as \(b\) in the convective term \(b \cdot \nabla u\) . This should give the same solution as the original problem,if you set the right hand side to zero. <a class="anchor" id="Adaptiverefinement"></a></p><h4>Adaptive refinement</h4>
<p>So far, this tutorial program refines the mesh globally in each step.Replacing the code in StokesProblem::refine_grid() by something like </p><div class="fragment"><div class="line"><a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line"></div><div class="line"><a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"><a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div><div class="line">dof_handler,</div><div class="line"><a class="code" href="classQGauss.html">QGauss</a>&lt;dim</div><div class="line"></div><div class="line">- 1&gt;(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div><div class="line">std::map&lt;<a class="code" href="classunsigned_01int.html">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a>&gt;(),</div><div class="line">locally_relevant_solution,</div><div class="line">estimated_error_per_cell,</div><div class="line">fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"><a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#aa2ffb707a796ae6dedb75036606ef2e6">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_number</a>(</div><div class="line">triangulation, estimated_error_per_cell, 0.3, 0.0);</div><div class="line">triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>();</div></div><!-- fragment --><p> makes it simple to explore adaptive mesh refinement.</p>
<p><a class="anchor" id="PlainProg"></a></p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2016 - 2021 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Timo Heister, Clemson University, 2016</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="generic__linear__algebra_8h.html">deal.II/lac/generic_linear_algebra.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* #define FORCE_USE_OF_TRILINOS */</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>LA</div><div class="line">{</div><div class="line"><span class="preprocessor">#if defined(DEAL_II_WITH_PETSC) &amp;&amp; !defined(DEAL_II_PETSC_WITH_COMPLEX) &amp;&amp; \</span></div><div class="line"><span class="preprocessor">  !(defined(DEAL_II_WITH_TRILINOS) &amp;&amp; defined(FORCE_USE_OF_TRILINOS))</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraPETSc;</div><div class="line"><span class="preprocessor">#  define USE_PETSC_LA</span></div><div class="line"><span class="preprocessor">#elif defined(DEAL_II_WITH_TRILINOS)</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraTrilinos;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">#  error DEAL_II_WITH_PETSC or DEAL_II_WITH_TRILINOS required</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">} <span class="comment">// namespace LA</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__minres_8h.html">deal.II/lac/solver_minres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__sparse__matrix_8h.html">deal.II/lac/petsc_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__vector_8h.html">deal.II/lac/petsc_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__solver_8h.html">deal.II/lac/petsc_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__precondition_8h.html">deal.II/lac/petsc_precondition.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparsity__tools_8h.html">deal.II/lac/sparsity_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step55</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">namespace </span>LinearSolvers</div><div class="line">  {</div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">    {</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">      InverseMatrix(<span class="keyword">const</span> Matrix &amp;m, <span class="keyword">const</span> Preconditioner &amp;preconditioner);</div><div class="line"></div><div class="line">      <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">      <span class="keywordtype">void</span> vmult(VectorType &amp;dst, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const Matrix&gt;</a> <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">      <span class="keyword">const</span> Preconditioner &amp;           preconditioner;</div><div class="line">    };</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    InverseMatrix&lt;Matrix, Preconditioner&gt;::InverseMatrix(</div><div class="line">      <span class="keyword">const</span> Matrix &amp;        m,</div><div class="line">      <span class="keyword">const</span> Preconditioner &amp;preconditioner)</div><div class="line">      : matrix(&amp;m)</div><div class="line">      , preconditioner(preconditioner)</div><div class="line">    {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">    <span class="keywordtype">void</span></div><div class="line">    InverseMatrix&lt;Matrix, Preconditioner&gt;::vmult(VectorType &amp;      dst,</div><div class="line">                                                 <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">    </span>{</div><div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(src.size(), 1e-8 * src.l2_norm());</div><div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;LA::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line">      dst = 0;</div><div class="line"></div><div class="line">      <span class="keywordflow">try</span></div><div class="line">        {</div><div class="line">          cg.solve(*matrix, dst, src, preconditioner);</div><div class="line">        }</div><div class="line">      <span class="keywordflow">catch</span> (std::exception &amp;e)</div><div class="line">        {</div><div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(e.what()));</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    <span class="keyword">class </span>BlockDiagonalPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">    {</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">      BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                  <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S);</div><div class="line"></div><div class="line">      <span class="keywordtype">void</span> <a class="code" href="structSUNDIALS_1_1SundialsPreconditioner.html#aff5a880cfa288ecdd2a83a876abacf0d">vmult</a>(<a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">                 <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">      <span class="keyword">const</span> PreconditionerA &amp;preconditioner_A;</div><div class="line">      <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S;</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::</div><div class="line">      BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                  <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S)</div><div class="line">      : preconditioner_A(preconditioner_A)</div><div class="line">      , preconditioner_S(preconditioner_S)</div><div class="line">    {}</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    <span class="keywordtype">void</span> BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::vmult(</div><div class="line">      <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">    </span>{</div><div class="line">      preconditioner_A.vmult(dst.block(0), src.block(0));</div><div class="line">      preconditioner_S.<a class="code" href="classPreconditionIdentity.html#a5cb13bb838919dd8b1ba531f20f21955">vmult</a>(dst.block(1), src.block(1));</div><div class="line">    }</div><div class="line"></div><div class="line">  } <span class="comment">// namespace LinearSolvers</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">    values[0] =</div><div class="line">      -1.0L / 2.0L * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0) *</div><div class="line">        <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">      0.4 * pi2 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) +</div><div class="line">      0.1 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 2) *</div><div class="line">        <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi);</div><div class="line">    values[1] = 0.2 * pi * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">                  <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) -</div><div class="line">                0.05 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 3) *</div><div class="line">                  <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">                  pi;</div><div class="line">    values[2] = 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>ExactSolution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    ExactSolution()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> ExactSolution&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">    values[0] =</div><div class="line">      -<a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) + 1;</div><div class="line">    values[1] = (1.0L / 2.0L) * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">                <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">                pi;</div><div class="line">    values[2] =</div><div class="line">      -1.0L / 2.0L * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">      2.0 *</div><div class="line">        (-6538034.74494422 +</div><div class="line">         0.0134758939981709 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(4 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">        (-80.0 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">         16.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) -</div><div class="line">      1634508.68623606 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">        (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">      (-0.00673794699908547 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">       3269017.37247211 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">        (-8 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 40.0) +</div><div class="line">      0.00336897349954273 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(1.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">        (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2));</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>StokesProblem</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> make_grid();</div><div class="line">    <span class="keywordtype">void</span> setup_system();</div><div class="line">    <span class="keywordtype">void</span> assemble_system();</div><div class="line">    <span class="keywordtype">void</span> solve();</div><div class="line">    <span class="keywordtype">void</span> refine_grid();</div><div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree;</div><div class="line">    <span class="keywordtype">double</span>       viscosity;</div><div class="line">    <a class="code" href="classMPI__Comm.html">MPI_Comm</a>     mpi_communicator;</div><div class="line"></div><div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">    std::vector&lt;IndexSet&gt; owned_partitioning;</div><div class="line">    std::vector&lt;IndexSet&gt; relevant_partitioning;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> system_matrix;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       locally_relevant_solution;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       system_rhs;</div><div class="line"></div><div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line">    <a class="code" href="classTimerOutput.html">TimerOutput</a>        computing_timer;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  StokesProblem&lt;dim&gt;::StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree)</div><div class="line">    : velocity_degree(velocity_degree)</div><div class="line">    , viscosity(0.1)</div><div class="line">    , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">    , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree - 1), 1)</div><div class="line">    , triangulation(mpi_communicator,</div><div class="line">                    typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::MeshSmoothing(</div><div class="line">                      <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_refinement |</div><div class="line">                      <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_coarsening))</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , pcout(<a class="code" href="namespacestd.html">std</a>::cout,</div><div class="line">            (<a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0))</div><div class="line">    , computing_timer(mpi_communicator,</div><div class="line">                      pcout,</div><div class="line">                      <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div><div class="line">                      <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::make_grid()</div><div class="line">  {</div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, -0.5, 1.5);</div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(3);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_system()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;setup&quot;</span>);</div><div class="line"></div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    std::vector&lt;unsigned int&gt; stokes_sub_blocks(dim + 1, 0);</div><div class="line">    stokes_sub_blocks[dim] = 1;</div><div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div><div class="line">          &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    owned_partitioning.resize(2);</div><div class="line">    owned_partitioning[0] = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">    owned_partitioning[1] =</div><div class="line">      dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">    <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div><div class="line">    relevant_partitioning.resize(2);</div><div class="line">    relevant_partitioning[0] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">    relevant_partitioning[1] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line">    {</div><div class="line">      constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               ExactSolution&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      constraints.close();</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      system_matrix.clear();</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line">          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == dim || d == dim || c == d)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">        dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">        dsp,</div><div class="line">        dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>(),</div><div class="line">        mpi_communicator,</div><div class="line">        locally_relevant_dofs);</div><div class="line"></div><div class="line">      system_matrix.reinit(owned_partitioning, dsp, mpi_communicator);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      preconditioner_matrix.clear();</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">        dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line">      <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">        dsp,</div><div class="line">        <a class="code" href="namespaceUtilities_1_1MPI.html#ac5a7433f594a19070add2afa0f769efb">Utilities::MPI::all_gather</a>(mpi_communicator,</div><div class="line">                                   dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>()),</div><div class="line">        mpi_communicator,</div><div class="line">        locally_relevant_dofs);</div><div class="line">      preconditioner_matrix.reinit(owned_partitioning,</div><div class="line">                                   dsp,</div><div class="line">                                   mpi_communicator);</div><div class="line">    }</div><div class="line"></div><div class="line">    locally_relevant_solution.reinit(owned_partitioning,</div><div class="line">                                     relevant_partitioning,</div><div class="line">                                     mpi_communicator);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div><div class="line"></div><div class="line">    system_matrix         = 0;</div><div class="line">    preconditioner_matrix = 0;</div><div class="line">    system_rhs            = 0;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(velocity_degree + 1);</div><div class="line"></div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> cell_matrix2(dofs_per_cell, dofs_per_cell);</div><div class="line">    Vector&lt;double&gt;     cell_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, Vector&lt;double&gt;(dim + 1));</div><div class="line"></div><div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;         div_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;         phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocities(0);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a>     pressure(dim);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">        {</div><div class="line">          cell_matrix  = 0;</div><div class="line">          cell_matrix2 = 0;</div><div class="line">          cell_rhs     = 0;</div><div class="line"></div><div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">          right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                            rhs_values);</div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">                {</div><div class="line">                  grad_phi_u[k] = fe_values[velocities].gradient(k, q);</div><div class="line">                  div_phi_u[k]  = fe_values[velocities].divergence(k, q);</div><div class="line">                  phi_p[k]      = fe_values[pressure].value(k, q);</div><div class="line">                }</div><div class="line"></div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line">                    {</div><div class="line">                      <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                        (viscosity *</div><div class="line">                           <a class="code" href="symmetric__tensor_8h.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[i], grad_phi_u[j]) -</div><div class="line">                         div_phi_u[i] * phi_p[j] - phi_p[i] * div_phi_u[j]) *</div><div class="line">                        fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                      cell_matrix2(i, j) += 1.0 / viscosity * phi_p[i] *</div><div class="line">                                            phi_p[j] * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                    }</div><div class="line"></div><div class="line">                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                    fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                  cell_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q) *</div><div class="line">                                 rhs_values[q](component_i) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line"></div><div class="line">          cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">          constraints.distribute_local_to_global(cell_matrix,</div><div class="line">                                                 cell_rhs,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 system_rhs);</div><div class="line"></div><div class="line">          constraints.distribute_local_to_global(cell_matrix2,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 preconditioner_matrix);</div><div class="line">        }</div><div class="line"></div><div class="line">    system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    preconditioner_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;solve&quot;</span>);</div><div class="line"></div><div class="line">    LA::MPI::PreconditionAMG prec_A;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_A.initialize(system_matrix.block(0, 0), data);</div><div class="line">    }</div><div class="line"></div><div class="line">    LA::MPI::PreconditionAMG prec_S;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_S.initialize(preconditioner_matrix.block(1, 1), data);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">using</span> mp_inverse_t = LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LA::MPI::SparseMatrix</a>,</div><div class="line">                                                      LA::MPI::PreconditionAMG&gt;;</div><div class="line">    <span class="keyword">const</span> mp_inverse_t mp_inverse(preconditioner_matrix.block(1, 1), prec_S);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> LinearSolvers::BlockDiagonalPreconditioner&lt;<a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>,</div><div class="line">                                                     mp_inverse_t&gt;</div><div class="line">      preconditioner(prec_A, mp_inverse);</div><div class="line"></div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(system_matrix.m(),</div><div class="line">                                 1e-10 * system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>());</div><div class="line"></div><div class="line">    <a class="code" href="classSolverMinRes.html">SolverMinRes&lt;LA::MPI::BlockVector&gt;</a> solver(solver_control);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> distributed_solution(owned_partitioning,</div><div class="line">                                              mpi_communicator);</div><div class="line"></div><div class="line">    constraints.set_zero(distributed_solution);</div><div class="line"></div><div class="line">    solver.solve(system_matrix,</div><div class="line">                 distributed_solution,</div><div class="line">                 system_rhs,</div><div class="line">                 preconditioner);</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Solved in &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span></div><div class="line">          &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    constraints.distribute(distributed_solution);</div><div class="line"></div><div class="line">    locally_relevant_solution = distributed_solution;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> mean_pressure =</div><div class="line">      VectorTools::compute_mean_value(dof_handler,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(velocity_degree + 2),</div><div class="line">                                      locally_relevant_solution,</div><div class="line">                                      dim);</div><div class="line">    distributed_solution.block(1).add(-mean_pressure);</div><div class="line">    locally_relevant_solution.block(1) = distributed_solution.block(1);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_grid()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;refine&quot;</span>);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    {</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> pressure_mask(dim, dim + 1);</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> velocity_mask(std::make_pair(0, dim),</div><div class="line">                                                       dim + 1);</div><div class="line"></div><div class="line">      Vector&lt;double&gt; cellwise_errors(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>    quadrature(velocity_degree + 2);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;velocity_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_u_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;pressure_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_p_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;error: u_0: &quot;</span> &lt;&lt; error_u_l2 &lt;&lt; <span class="stringliteral">&quot; p_0: &quot;</span> &lt;&lt; error_p_l2</div><div class="line">            &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">      data_component_interpretation(</div><div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation.push_back(</div><div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_solution,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated;</div><div class="line">    interpolated.reinit(owned_partitioning, MPI_COMM_WORLD);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler, ExactSolution&lt;dim&gt;(), interpolated);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated_relevant(owned_partitioning,</div><div class="line">                                               relevant_partitioning,</div><div class="line">                                               MPI_COMM_WORLD);</div><div class="line">    interpolated_relevant = interpolated;</div><div class="line">    {</div><div class="line">      std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;ref_u&quot;</span>);</div><div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;ref_p&quot;</span>);</div><div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(interpolated_relevant,</div><div class="line">                               solution_names,</div><div class="line">                               <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                               data_component_interpretation);</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    Vector&lt;float&gt; subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using PETSc.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using Trilinos.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles = 5;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; ++cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == 0)</div><div class="line">          make_grid();</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          refine_grid();</div><div class="line"></div><div class="line">        setup_system();</div><div class="line"></div><div class="line">        assemble_system();</div><div class="line">        solve();</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(mpi_communicator) &lt;= 32)</div><div class="line">          {</div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;output&quot;</span>);</div><div class="line">            output_results(cycle);</div><div class="line">          }</div><div class="line"></div><div class="line">        computing_timer.print_summary();</div><div class="line">        computing_timer.reset();</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">} <span class="comment">// namespace Step55</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step55;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line"></div><div class="line">      StokesProblem&lt;2&gt; problem(2);</div><div class="line">      problem.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>This tutorial depends on <a class="el" href="step_40.html">step-40</a>, <a class="el" href="step_22.html">step-22</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Optimalpreconditioners">Optimal preconditioners</a>
        <li><a href="#Thesolverandpreconditioner">The solver and preconditioner</a>
        <li><a href="#Thetestcase">The testcase</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a>
        <li><a href="#Problemsetup">Problem setup</a>
        <li><a href="#Themainprogram">The main program</a>
        <li><a href="#SystemSetup">System Setup</a>
        <li><a href="#Assembly">Assembly</a>
        <li><a href="#Solving">Solving</a>
        <li><a href="#Therest">The rest</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
      <ul>
        <li><a href="#InvestigateTrilinositerations">Investigate Trilinos iterations</a>
        <li><a href="#SolvetheOseenprobleminsteadoftheStokessystem">Solve the Oseen problem instead of the Stokes system</a>
        <li><a href="#Adaptiverefinement">Adaptive refinement</a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 examples/step-55/doc/intro.dox</p>
<p><br />
</p>
<p><em>This program was contributed by Timo Heister. Special thanks to Sander Rhebergen for the inspiration to finally write this tutorial.</em></p>
<p><em>This material is based upon work partially supported by National Science Foundation grant DMS1522191 and the Computational Infrastructure in Geodynamics initiative (CIG), through the National Science Foundation under Award No. EAR-0949446 and The University of California-Davis.</em></p>
<p><em>The authors would like to thank the Isaac Newton Institute for Mathematical Sciences, Cambridge, for support and hospitality during the programme Melt in the Mantle where work on this tutorial was undertaken. This work was supported by EPSRC grant no EP/K032208/1. </em></p>
<dl class="section note"><dt>Note</dt><dd>作为这个程序的前提条件，你需要安装PETSc或Trilinos和p4est库。在<a href="../../readme.html" target="body">README</a>文件中描述了deal.II与这些附加库的安装情况。</dd></dl>
<p><a class="anchor" id="Intro"></a></p>
<p><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>在第40步的基础上，本教程展示了如何使用MPI与PETSc或Trilinos进行线性代数，并行解决具有多个组件的线性PDEs。为此，我们返回到步骤22中讨论的斯托克斯方程。编写本教程的动机是在第40步（并行拉普拉斯）和第32步（针对时间相关问题的并行耦合斯托克斯与布西尼斯克）之间提供一个中间步骤（双关）。</p>
<p>本教程的学习成果是。</p>
<ul>
<li>你能够并行地解决有多个变量的PDEs，并能将其应用于不同的问题。</li>
<li>你了解最佳预处理程序的概念，并能对某一特定问题进行检查。</li>
<li>你能够使用免费的计算机algreba系统SymPy（https://sympy.org）来构建制造的解决方案。</li>
<li>你可以为并行程序实现各种其他任务：错误计算、编写图形输出等。</li>
<li>你可以将矢量场、流线和矢量的轮廓可视化。</li>
</ul>
<p>我们要解决的是满足斯托克斯方程的速度 \(\textbf{u}\) 和压力 \(p\) ，其内容为</p>
<p class="formulaDsp">
\begin{eqnarray*} - \triangle \textbf{u} + \nabla p &amp;=&amp; \textbf{f}, \\ -\textrm{div}\; \textbf{u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p><a class="anchor" id="Optimalpreconditioners"></a></p><h3>Optimal preconditioners</h3>
<p>请确保你阅读（甚至更好：尝试）步骤22中 "可能的扩展 "部分的 "块舒尔补码预处理 "所描述的内容。就像那里描述的那样，我们将使用Krylov方法和块状预处理程序来解决块状系统。</p>
<p>我们的目标是为线性系统构造一个非常简单的（也许是最简单的）最优预处理。如果预处理系统的迭代次数与网格大小无关，则该预处理程序被称为 "最优 "或 "最优复杂性" \(h\) 。你可以把这个定义扩展到要求与使用的处理器数量无关（我们将在结果部分讨论这个问题），计算域和网格质量，测试案例本身，有限元空间的多项式程度，等等。</p>
<p>为什么恒定的迭代次数被认为是 "最佳 "的？假设离散化的PDE给出一个有N个未知数的线性系统。因为来自有限元离散化的矩阵是稀疏的，矩阵-向量乘积可以在O(N)时间内完成。先决条件的应用充其量也只能是O(N)（例如可以用多网格方法来做）。如果解决线性系统所需的迭代次数与 \(h\) 无关（因此也与N无关），那么解决该系统的总成本将是O(N)。不可能战胜这个复杂度，因为即使是查看右手边的所有条目也已经需要O(N)的时间。更多信息见 <b>[elman2005]</b> ，第2.5章（多网格）。</p>
<p>这里描述的预处理程序甚至比步骤22中描述的更简单，通常需要更多的迭代，因此需要更多的时间来解决。在考虑预处理程序时，最优性并不是唯一重要的衡量标准。但是一个最优的、昂贵的预处理程序通常比一个更便宜的、非最优的预处理程序更可取。这是因为，最终，随着网格尺寸越来越小，线性问题越来越大，前者将最终击败后者。</p>
<p><a class="anchor" id="Thesolverandpreconditioner"></a></p><h3>The solver and preconditioner</h3>
<p>我们对线性系统进行预处理</p>
<p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{c} U \\ P \end{array}\right) = \left(\begin{array}{c} F \\ 0 \end{array}\right), \end{eqnarray*}
</p>
<p>块状对角线预处理器</p>
<p class="formulaDsp">
\begin{eqnarray*} P^{-1} = \left(\begin{array}{cc} A &amp; 0 \\ 0 &amp; S \end{array}\right) ^{-1}, = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ 0 &amp; S^{-1} \end{array}\right), \end{eqnarray*}
</p>
<p>其中 \(S=-BA^{-1} B^T\) 是舒尔补。</p>
<p>对于 \(P\) 的这种选择，假设我们准确地处理了 \(A^{-1}\) 和 \(S^{-1}\) （这是一种 "理想化 "的情况），预处理的线性系统有三个独立于 \(h\) 的特征值，因此是 "最优 "的。 见 <b>[elman2005]</b> 中的6.2.1节（特别是第292页）。作为比较，在第22步中使用理想版的上块三角预处理（也用于第56步）会使所有的特征值都等于1。</p>
<p>我们将使用 \(P^{-1}\) 中的逆运算的近似值，它（几乎）独立于 \(h\) 。在这种情况下，我们可以再次证明，特征值是独立于 \(h\) 的。对于Krylov方法，我们选择MINRES，它对分析很有吸引力（迭代次数被证明与 \(h\) 无关，见上述书中第6.2.1章的其余部分），从计算的角度看很好（例如比GMRES更简单、更便宜），而且适用（矩阵和预处理器是对称的）。</p>
<p>对于近似，我们将使用压力空间中的质量矩阵的CG解来近似 \(S^{-1}\) 的作用。请注意，质量矩阵在光谱上等同于 \(S\) 。我们可以预期CG迭代的数量与 \(h\) 无关，即使使用ILU这样的简单预处理程序。</p>
<p>对于速度块 \(A\) 的近似，我们将执行一个单一的AMG V-循环。在实践中，这种选择并不完全独立于 \(h\) ，这可以解释迭代数的轻微增加。一个可能的解释是，最粗的层次将被精确解决，而最粗的矩阵的层次数和大小是不可预测的。</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>我们将根据经典的Kovasznay问题构建一个制造的解决方案，见 <b>[kovasznay1948laminar]</b> 。这里是一个由x速度着色的解决方案的图像，包括速度的流线。</p>
<div class="image">
<img src="https://www.dealii.org/images/steps/developer/step-55.solution.png"/>
</div>
<p>不过，我们在这里必须作弊，因为我们不是在解决非线性的纳维-斯托克斯方程，而是解决没有对流项的线性斯托克斯系统。因此，为了重现完全相同的解，我们用科瓦兹内问题的解来制造解的方法。这将有效地把对流项移到右手边 \(f\) 。</p>
<p>右手边是用脚本 "reference.py "计算的，我们使用精确的解决方案来计算边界条件和误差。</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div></div><!-- fragment --><p>The following chunk out code is identical to <a class="el" href="step_40.html">step-40</a> and allows switching between PETSc and Trilinos:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="generic__linear__algebra_8h.html">deal.II/lac/generic_linear_algebra.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* #define FORCE_USE_OF_TRILINOS */</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>LA</div><div class="line">{</div><div class="line"><span class="preprocessor">#if defined(DEAL_II_WITH_PETSC) &amp;&amp; !defined(DEAL_II_PETSC_WITH_COMPLEX) &amp;&amp; \</span></div><div class="line"><span class="preprocessor">  !(defined(DEAL_II_WITH_TRILINOS) &amp;&amp; defined(FORCE_USE_OF_TRILINOS))</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraPETSc;</div><div class="line"><span class="preprocessor">#  define USE_PETSC_LA</span></div><div class="line"><span class="preprocessor">#elif defined(DEAL_II_WITH_TRILINOS)</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraTrilinos;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">#  error DEAL_II_WITH_PETSC or DEAL_II_WITH_TRILINOS required</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">} <span class="comment">// namespace LA</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__minres_8h.html">deal.II/lac/solver_minres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__sparse__matrix_8h.html">deal.II/lac/petsc_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__vector_8h.html">deal.II/lac/petsc_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__solver_8h.html">deal.II/lac/petsc_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__precondition_8h.html">deal.II/lac/petsc_precondition.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparsity__tools_8h.html">deal.II/lac/sparsity_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step55</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div></div><!-- fragment --><p><a class="anchor" id="Linearsolversandpreconditioners"></a> </p><h3>Linear solvers and preconditioners</h3>
<p>We need a few helper classes to represent our solver strategy described in the introduction.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>LinearSolvers</div><div class="line">{</div></div><!-- fragment --><p>This class exposes the action of applying the inverse of a giving matrix via the function InverseMatrix::vmult(). Internally, the inverse is not formed explicitly. Instead, a linear solver with CG is performed. This class extends the InverseMatrix class in <a class="el" href="step_22.html">step-22</a> with an option to specify a preconditioner, and to allow for different vector types in the vmult function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line"><span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  InverseMatrix(<span class="keyword">const</span> Matrix &amp;m, <span class="keyword">const</span> Preconditioner &amp;preconditioner);</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">  <span class="keywordtype">void</span> vmult(VectorType &amp;dst, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const Matrix&gt;</a> <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">  <span class="keyword">const</span> Preconditioner &amp;           preconditioner;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">InverseMatrix&lt;Matrix, Preconditioner&gt;::InverseMatrix(</div><div class="line">  <span class="keyword">const</span> Matrix &amp;        m,</div><div class="line">  <span class="keyword">const</span> Preconditioner &amp;preconditioner)</div><div class="line">  : matrix(&amp;m)</div><div class="line">  , preconditioner(preconditioner)</div><div class="line">{}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line"><span class="keywordtype">void</span></div><div class="line">InverseMatrix&lt;Matrix, Preconditioner&gt;::vmult(VectorType &amp;      dst,</div><div class="line">                                             <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(src.size(), 1e-8 * src.l2_norm());</div><div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;LA::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line">  dst = 0;</div><div class="line"></div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      cg.solve(*matrix, dst, src, preconditioner);</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;e)</div><div class="line">    {</div><div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(e.what()));</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>The class A template class for a simple block diagonal preconditioner for 2x2 matrices.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  <span class="keyword">class </span>BlockDiagonalPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> vmult(<a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">               <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> PreconditionerA &amp;preconditioner_A;</div><div class="line">    <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S;</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::</div><div class="line">    BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S)</div><div class="line">    : preconditioner_A(preconditioner_A)</div><div class="line">    , preconditioner_S(preconditioner_S)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">  <span class="keywordtype">void</span> BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::vmult(</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">    <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    preconditioner_A.vmult(dst.block(0), src.block(0));</div><div class="line">    preconditioner_S.<a class="code" href="classPreconditionIdentity.html#a5cb13bb838919dd8b1ba531f20f21955">vmult</a>(dst.block(1), src.block(1));</div><div class="line">  }</div><div class="line"></div><div class="line">} <span class="comment">// namespace LinearSolvers</span></div></div><!-- fragment --><p><a class="anchor" id="Problemsetup"></a> </p><h3>Problem setup</h3>
<p>The following classes represent the right hand side and the exact solution for the test problem.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  RightHandSide()</div><div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">  values[0] =</div><div class="line">    -1.0L / 2.0L * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0) *</div><div class="line">      <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">    0.4 * pi2 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) +</div><div class="line">    0.1 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 2) *</div><div class="line">      <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi);</div><div class="line">  values[1] = 0.2 * pi * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">                <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) -</div><div class="line">              0.05 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 3) *</div><div class="line">                <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">                pi;</div><div class="line">  values[2] = 0;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>ExactSolution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ExactSolution()</div><div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">  {}</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> ExactSolution&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword"></span>{</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">  values[0] =</div><div class="line">    -<a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) + 1;</div><div class="line">  values[1] = (1.0L / 2.0L) * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">              <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">              pi;</div><div class="line">  values[2] =</div><div class="line">    -1.0L / 2.0L * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">    2.0 *</div><div class="line">      (-6538034.74494422 +</div><div class="line">       0.0134758939981709 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(4 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">      (-80.0 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">       16.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) -</div><div class="line">    1634508.68623606 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">      (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">    (-0.00673794699908547 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">     3269017.37247211 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">      (-8 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 40.0) +</div><div class="line">    0.00336897349954273 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(1.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">      (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2));</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Themainprogram"></a> </p><h3>The main program</h3>
<p>The main class is very similar to <a class="el" href="step_40.html">step-40</a>, except that matrices and vectors are now block versions, and we store a std::vector&lt;IndexSet&gt; for owned and relevant DoFs instead of a single <a class="el" href="classIndexSet.html">IndexSet</a>. We have exactly two IndexSets, one for all velocity unknowns and one for all pressure unknowns.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keyword">class </span>StokesProblem</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree);</div><div class="line"></div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> make_grid();</div><div class="line">  <span class="keywordtype">void</span> setup_system();</div><div class="line">  <span class="keywordtype">void</span> assemble_system();</div><div class="line">  <span class="keywordtype">void</span> solve();</div><div class="line">  <span class="keywordtype">void</span> refine_grid();</div><div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree;</div><div class="line">  <span class="keywordtype">double</span>       viscosity;</div><div class="line">  <a class="code" href="classMPI__Comm.html">MPI_Comm</a>     mpi_communicator;</div><div class="line"></div><div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">  <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">  std::vector&lt;IndexSet&gt; owned_partitioning;</div><div class="line">  std::vector&lt;IndexSet&gt; relevant_partitioning;</div><div class="line"></div><div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> system_matrix;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       locally_relevant_solution;</div><div class="line">  <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       system_rhs;</div><div class="line"></div><div class="line">  <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line">  <a class="code" href="classTimerOutput.html">TimerOutput</a>        computing_timer;</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">StokesProblem&lt;dim&gt;::StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree)</div><div class="line">  : velocity_degree(velocity_degree)</div><div class="line">  , viscosity(0.1)</div><div class="line">  , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">  , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree - 1), 1)</div><div class="line">  , triangulation(mpi_communicator,</div><div class="line">                  typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::MeshSmoothing(</div><div class="line">                    <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_refinement |</div><div class="line">                    <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_coarsening))</div><div class="line">  , dof_handler(triangulation)</div><div class="line">  , pcout(<a class="code" href="namespacestd.html">std</a>::cout,</div><div class="line">          (<a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0))</div><div class="line">  , computing_timer(mpi_communicator,</div><div class="line">                    pcout,</div><div class="line">                    <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div><div class="line">                    <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div><div class="line">{}</div></div><!-- fragment --><p>The Kovasnay flow is defined on the domain [-0.5, 1.5]^2, which we create by passing the min and max values to <a class="el" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::make_grid()</div><div class="line">{</div><div class="line">  <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, -0.5, 1.5);</div><div class="line">  triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(3);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="SystemSetup"></a> </p><h3>System Setup</h3>
<p>The construction of the block matrices and vectors is new compared to <a class="el" href="step_40.html">step-40</a> and is different compared to serial codes like <a class="el" href="step_22.html">step-22</a>, because we need to supply the set of rows that belong to our processor.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_system()</div><div class="line">{</div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;setup&quot;</span>);</div><div class="line"></div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div></div><!-- fragment --><p>Put all dim velocities into block 0 and the pressure into block 1, then reorder the unknowns by block. Finally count how many unknowns we have per block.</p>
<div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; stokes_sub_blocks(dim + 1, 0);</div><div class="line">stokes_sub_blocks[dim] = 1;</div><div class="line"><a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line"><span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">  <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div><div class="line">      &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div></div><!-- fragment --><p>We split up the <a class="el" href="classIndexSet.html">IndexSet</a> for locally owned and locally relevant DoFs into two IndexSets based on how we want to create the block matrices and vectors.</p>
<div class="fragment"><div class="line">owned_partitioning.resize(2);</div><div class="line">owned_partitioning[0] = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">owned_partitioning[1] =</div><div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line"><a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line"><a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div><div class="line">relevant_partitioning.resize(2);</div><div class="line">relevant_partitioning[0] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">relevant_partitioning[1] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div></div><!-- fragment --><p>Setting up the constraints for boundary conditions and hanging nodes is identical to <a class="el" href="step_40.html">step-40</a>. Even though we don't have any hanging nodes because we only perform global refinement, it is still a good idea to put this function call in, in case adaptive refinement gets introduced later.</p>
<div class="fragment"><div class="line">{</div><div class="line">  constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">  <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                           0,</div><div class="line">                                           ExactSolution&lt;dim&gt;(),</div><div class="line">                                           constraints,</div><div class="line">                                           fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">  constraints.close();</div><div class="line">}</div></div><!-- fragment --><p>Now we create the system matrix based on a <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a>. We know that we won't have coupling between different velocity components (because we use the laplace and not the deformation tensor) and no coupling between pressure with its test functions, so we use a <a class="el" href="classTable.html">Table</a> to communicate this coupling information to <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>.</p>
<div class="fragment"><div class="line">{</div><div class="line">  system_matrix.clear();</div><div class="line"></div><div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">      <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == dim || d == dim || c == d)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">      <span class="keywordflow">else</span></div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">    dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">  <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">    dsp,</div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>(),</div><div class="line">    mpi_communicator,</div><div class="line">    locally_relevant_dofs);</div><div class="line"></div><div class="line">  system_matrix.reinit(owned_partitioning, dsp, mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>The preconditioner matrix has a different coupling (we only fill in the 1,1 block with the mass matrix), otherwise this code is identical to the construction of the system_matrix above.</p>
<div class="fragment"><div class="line">{</div><div class="line">  preconditioner_matrix.clear();</div><div class="line"></div><div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">      <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">      <span class="keywordflow">else</span></div><div class="line">        coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">    dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line">  <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">    dsp,</div><div class="line">    <a class="code" href="namespaceUtilities_1_1MPI.html#ac5a7433f594a19070add2afa0f769efb">Utilities::MPI::all_gather</a>(mpi_communicator,</div><div class="line">                               dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>()),</div><div class="line">    mpi_communicator,</div><div class="line">    locally_relevant_dofs);</div><div class="line">  preconditioner_matrix.reinit(owned_partitioning,</div></div><!-- fragment --><p>owned_partitioning,</p>
<div class="fragment"><div class="line">                               dsp,</div><div class="line">                               mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p>Finally, we construct the block vectors with the right sizes. The function call with two std::vector&lt;IndexSet&gt; will create a ghosted vector.</p>
<div class="fragment"><div class="line">  locally_relevant_solution.reinit(owned_partitioning,</div><div class="line">                                   relevant_partitioning,</div><div class="line">                                   mpi_communicator);</div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Assembly"></a> </p><h3>Assembly</h3>
<p>This function assembles the system matrix, the preconditioner matrix, and the right hand side. The code is pretty standard.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">{</div><div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div><div class="line"></div><div class="line">  system_matrix         = 0;</div><div class="line">  preconditioner_matrix = 0;</div><div class="line">  system_rhs            = 0;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(velocity_degree + 1);</div><div class="line"></div><div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div><div class="line">                          quadrature_formula,</div><div class="line">                          <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> cell_matrix2(dofs_per_cell, dofs_per_cell);</div><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(dim + 1));</div><div class="line"></div><div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(dofs_per_cell);</div><div class="line">  std::vector&lt;double&gt;         div_phi_u(dofs_per_cell);</div><div class="line">  std::vector&lt;double&gt;         phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocities(0);</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a>     pressure(dim);</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">    <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">      {</div><div class="line">        cell_matrix  = 0;</div><div class="line">        cell_matrix2 = 0;</div><div class="line">        cell_rhs     = 0;</div><div class="line"></div><div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">        right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                          rhs_values);</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">          {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">              {</div><div class="line">                grad_phi_u[k] = fe_values[velocities].gradient(k, q);</div><div class="line">                div_phi_u[k]  = fe_values[velocities].divergence(k, q);</div><div class="line">                phi_p[k]      = fe_values[pressure].value(k, q);</div><div class="line">              }</div><div class="line"></div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">              {</div><div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line">                  {</div><div class="line">                    <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                      (viscosity *</div><div class="line">                         <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[i], grad_phi_u[j]) -</div><div class="line">                       div_phi_u[i] * phi_p[j] - phi_p[i] * div_phi_u[j]) *</div><div class="line">                      fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                    cell_matrix2(i, j) += 1.0 / viscosity * phi_p[i] *</div><div class="line">                                          phi_p[j] * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                  }</div><div class="line"></div><div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                  fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                cell_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q) *</div><div class="line">                               rhs_values[q](component_i) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">              }</div><div class="line">          }</div><div class="line"></div><div class="line"></div><div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">        constraints.distribute_local_to_global(cell_matrix,</div><div class="line">                                               cell_rhs,</div><div class="line">                                               local_dof_indices,</div><div class="line">                                               system_matrix,</div><div class="line">                                               system_rhs);</div><div class="line"></div><div class="line">        constraints.distribute_local_to_global(cell_matrix2,</div><div class="line">                                               local_dof_indices,</div><div class="line">                                               preconditioner_matrix);</div><div class="line">      }</div><div class="line"></div><div class="line">  system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  preconditioner_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Solving"></a> </p><h3>Solving</h3>
<p>This function solves the linear system with MINRES with a block diagonal preconditioner and AMG for the two diagonal blocks as described in the introduction. The preconditioner applies a v cycle to the 0,0 block and a CG with the mass matrix for the 1,1 block (the Schur complement).</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;solve&quot;</span>);</div><div class="line"></div><div class="line">    LA::MPI::PreconditionAMG prec_A;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_A.initialize(system_matrix.block(0, 0), data);</div><div class="line">    }</div><div class="line"></div><div class="line">    LA::MPI::PreconditionAMG prec_S;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_S.initialize(preconditioner_matrix.block(1, 1), data);</div><div class="line">    }</div></div><!-- fragment --><p>The InverseMatrix is used to solve for the mass matrix:</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> mp_inverse_t = LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LA::MPI::SparseMatrix</a>,</div><div class="line">                                                  LA::MPI::PreconditionAMG&gt;;</div><div class="line"><span class="keyword">const</span> mp_inverse_t mp_inverse(preconditioner_matrix.block(1, 1), prec_S);</div></div><!-- fragment --><p>This constructs the block preconditioner based on the preconditioners for the individual blocks defined above.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> LinearSolvers::BlockDiagonalPreconditioner&lt;<a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>,</div><div class="line">                                                 mp_inverse_t&gt;</div><div class="line">  preconditioner(prec_A, mp_inverse);</div></div><!-- fragment --><p>With that, we can finally set up the linear solver and solve the system:</p>
<div class="fragment"><div class="line"><a class="code" href="classSolverControl.html">SolverControl</a> solver_control(system_matrix.m(),</div><div class="line">                             1e-10 * system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>());</div><div class="line"></div><div class="line"><a class="code" href="classSolverMinRes.html">SolverMinRes&lt;LA::MPI::BlockVector&gt;</a> solver(solver_control);</div><div class="line"></div><div class="line"><a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> distributed_solution(owned_partitioning,</div><div class="line">                                          mpi_communicator);</div><div class="line"></div><div class="line">constraints.set_zero(distributed_solution);</div><div class="line"></div><div class="line">solver.solve(system_matrix,</div><div class="line">             distributed_solution,</div><div class="line">             system_rhs,</div><div class="line">             preconditioner);</div><div class="line"></div><div class="line">pcout &lt;&lt; <span class="stringliteral">&quot;   Solved in &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span></div><div class="line">      &lt;&lt; std::endl;</div><div class="line"></div><div class="line">constraints.distribute(distributed_solution);</div></div><!-- fragment --><p>Like in <a class="el" href="step_56.html">step-56</a>, we subtract the mean pressure to allow error computations against our reference solution, which has a mean value of zero.</p>
<div class="fragment"><div class="line">  locally_relevant_solution = distributed_solution;</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> mean_pressure =</div><div class="line">    VectorTools::compute_mean_value(dof_handler,</div><div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(velocity_degree + 2),</div><div class="line">                                    locally_relevant_solution,</div><div class="line">                                    dim);</div><div class="line">  distributed_solution.block(1).add(-mean_pressure);</div><div class="line">  locally_relevant_solution.block(1) = distributed_solution.block(1);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="Therest"></a> </p><h3>The rest</h3>
<p>The remainder of the code that deals with mesh refinement, output, and the main loop is pretty standard.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_grid()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;refine&quot;</span>);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    {</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> pressure_mask(dim, dim + 1);</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> velocity_mask(std::make_pair(0, dim),</div><div class="line">                                                       dim + 1);</div><div class="line"></div><div class="line">      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> cellwise_errors(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>    quadrature(velocity_degree + 2);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;velocity_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_u_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;pressure_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_p_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;error: u_0: &quot;</span> &lt;&lt; error_u_l2 &lt;&lt; <span class="stringliteral">&quot; p_0: &quot;</span> &lt;&lt; error_p_l2</div><div class="line">            &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">      data_component_interpretation(</div><div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation.push_back(</div><div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_solution,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated;</div><div class="line">    interpolated.reinit(owned_partitioning, MPI_COMM_WORLD);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler, ExactSolution&lt;dim&gt;(), interpolated);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated_relevant(owned_partitioning,</div><div class="line">                                               relevant_partitioning,</div><div class="line">                                               MPI_COMM_WORLD);</div><div class="line">    interpolated_relevant = interpolated;</div><div class="line">    {</div><div class="line">      std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;ref_u&quot;</span>);</div><div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;ref_p&quot;</span>);</div><div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(interpolated_relevant,</div><div class="line">                               solution_names,</div><div class="line">                               <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                               data_component_interpretation);</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using PETSc.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using Trilinos.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles = 5;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; ++cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == 0)</div><div class="line">          make_grid();</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          refine_grid();</div><div class="line"></div><div class="line">        setup_system();</div><div class="line"></div><div class="line">        assemble_system();</div><div class="line">        solve();</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(mpi_communicator) &lt;= 32)</div><div class="line">          {</div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;output&quot;</span>);</div><div class="line">            output_results(cycle);</div><div class="line">          }</div><div class="line"></div><div class="line">        computing_timer.print_summary();</div><div class="line">        computing_timer.reset();</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">} <span class="comment">// namespace Step55</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step55;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line"></div><div class="line">      StokesProblem&lt;2&gt; problem(2);</div><div class="line">      problem.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> examples/step-55/doc/results.dox</p>
<p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>正如上面的讨论所预期的那样，迭代次数与处理器的数量无关，只与 \(h\) 有非常小的关系。</p>
<table class="doxtable">
<tr>
<th colspan="2">PETSc </th><th colspan="8">number of processors  </th></tr>
<tr>
<th>cycle </th><th>dofs </th><th>1 </th><th>2 </th><th>4 </th><th>8 </th><th>16 </th><th>32 </th><th>64 </th><th>128  </th></tr>
<tr>
<td>0 </td><td>659 </td><td>49 </td><td>49 </td><td>49 </td><td>51 </td><td>51 </td><td>51 </td><td>49 </td><td>49  </td></tr>
<tr>
<td>1 </td><td>2467 </td><td>52 </td><td>52 </td><td>52 </td><td>52 </td><td>52 </td><td>54 </td><td>54 </td><td>53  </td></tr>
<tr>
<td>2 </td><td>9539 </td><td>56 </td><td>56 </td><td>56 </td><td>54 </td><td>56 </td><td>56 </td><td>54 </td><td>56  </td></tr>
<tr>
<td>3 </td><td>37507 </td><td>57 </td><td>57 </td><td>57 </td><td>57 </td><td>57 </td><td>56 </td><td>57 </td><td>56  </td></tr>
<tr>
<td>4 </td><td>148739 </td><td>58 </td><td>59 </td><td>57 </td><td>59 </td><td>57 </td><td>57 </td><td>57 </td><td>57  </td></tr>
<tr>
<td>5 </td><td>592387 </td><td>60 </td><td>60 </td><td>59 </td><td>59 </td><td>59 </td><td>59 </td><td>59 </td><td>59  </td></tr>
<tr>
<td>6 </td><td>2364419 </td><td>62 </td><td>62 </td><td>61 </td><td>61 </td><td>61 </td><td>61 </td><td>61 </td><td>61  </td></tr>
</table>
<table class="doxtable">
<tr>
<th colspan="2">Trilinos </th><th colspan="8">number of processors  </th></tr>
<tr>
<th>cycle </th><th>dofs </th><th>1 </th><th>2 </th><th>4 </th><th>8 </th><th>16 </th><th>32 </th><th>64 </th><th>128  </th></tr>
<tr>
<td>0 </td><td>659 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37 </td><td>37  </td></tr>
<tr>
<td>1 </td><td>2467 </td><td>92 </td><td>89 </td><td>89 </td><td>82 </td><td>86 </td><td>81 </td><td>78 </td><td>78  </td></tr>
<tr>
<td>2 </td><td>9539 </td><td>102 </td><td>99 </td><td>96 </td><td>95 </td><td>95 </td><td>88 </td><td>83 </td><td>95  </td></tr>
<tr>
<td>3 </td><td>37507 </td><td>107 </td><td>105 </td><td>104 </td><td>99 </td><td>100 </td><td>96 </td><td>96 </td><td>90  </td></tr>
<tr>
<td>4 </td><td>148739 </td><td>112 </td><td>112 </td><td>111 </td><td>111 </td><td>127 </td><td>126 </td><td>115 </td><td>117  </td></tr>
<tr>
<td>5 </td><td>592387 </td><td>116 </td><td>115 </td><td>114 </td><td>112 </td><td>118 </td><td>120 </td><td>131 </td><td>130  </td></tr>
<tr>
<td>6 </td><td>2364419 </td><td>130 </td><td>126 </td><td>120 </td><td>120 </td><td>121 </td><td>122 </td><td>121 </td><td>123  </td></tr>
</table>
<p>虽然PETSc的结果显示迭代次数不变，但使用Trilinos时，迭代次数增加。这可能是由于AMG预处理程序的不同设置造成的。出于性能方面的考虑，我们不允许在几千个未知数以下进行粗化。由于粗解器是精确求解（我们默认使用LU），层数的变化将影响V型循环的质量。因此，对于较小的问题规模，V型循环更接近于精确求解器。</p>
<p><a class="anchor" id="extensions"></a></p>
<p><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p><a class="anchor" id="InvestigateTrilinositerations"></a></p><h4>Investigate Trilinos iterations</h4>
<p>玩弄平滑器、平滑步骤和Trilinos AMG的其他属性，以实现最佳预处理。</p>
<p><a class="anchor" id="SolvetheOseenprobleminsteadoftheStokessystem"></a></p><h4>Solve the Oseen problem instead of the Stokes system</h4>
<p>这一变化需要将外部求解器改为GMRES或BiCGStab，因为系统不再是对称的了。</p>
<p>你可以在对流项 \(b \cdot \nabla u\) 中规定精确的流动解，即 \(b\) 。如果你把右手边设置为零，这应该可以得到与原问题相同的解。</p>
<p><a class="anchor" id="Adaptiverefinement"></a></p><h4>Adaptive refinement</h4>
<p>到目前为止，这个教程程序在每一步都会对网格进行全局细化。将 StokesProblem::refine_grid() 中的代码替换为如下内容</p>
<div class="fragment"><div class="line"><a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line"></div><div class="line"></div><div class="line"><a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line"><a class="code" href="classKellyErrorEstimator.html#ae2269e1c9903e9d863b7abd54948af00">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div><div class="line">  dof_handler,</div><div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div><div class="line">  std::map&lt;<a class="code" href="classunsigned_01int.html">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div><div class="line">  locally_relevant_solution,</div><div class="line">  estimated_error_per_cell,</div><div class="line">  fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line"><a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#aa2ffb707a796ae6dedb75036606ef2e6">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_number</a>(</div><div class="line">  triangulation, estimated_error_per_cell, 0.3, 0.0);</div><div class="line">triangulation.<a class="code" href="classTriangulation.html#ac8b4fbb207303ec7f5ef758821ecd8cb">execute_coarsening_and_refinement</a>();</div></div><!-- fragment --><p>使得探索自适应网格细化变得简单。</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2016 - 2021 by the deal.II authors</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div><div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div><div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div><div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div><div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div><div class="line"><span class="comment"> * the top level directory of deal.II.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Author: Timo Heister, Clemson University, 2016</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="generic__linear__algebra_8h.html">deal.II/lac/generic_linear_algebra.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* #define FORCE_USE_OF_TRILINOS */</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>LA</div><div class="line">{</div><div class="line"><span class="preprocessor">#if defined(DEAL_II_WITH_PETSC) &amp;&amp; !defined(DEAL_II_PETSC_WITH_COMPLEX) &amp;&amp; \</span></div><div class="line"><span class="preprocessor">  !(defined(DEAL_II_WITH_TRILINOS) &amp;&amp; defined(FORCE_USE_OF_TRILINOS))</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraPETSc;</div><div class="line"><span class="preprocessor">#  define USE_PETSC_LA</span></div><div class="line"><span class="preprocessor">#elif defined(DEAL_II_WITH_TRILINOS)</span></div><div class="line">  <span class="keyword">using namespace </span>dealii::LinearAlgebraTrilinos;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">#  error DEAL_II_WITH_PETSC or DEAL_II_WITH_TRILINOS required</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">} <span class="comment">// namespace LA</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__minres_8h.html">deal.II/lac/solver_minres.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__sparse__matrix_8h.html">deal.II/lac/petsc_sparse_matrix.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__vector_8h.html">deal.II/lac/petsc_vector.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__solver_8h.html">deal.II/lac/petsc_solver.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="petsc__precondition_8h.html">deal.II/lac/petsc_precondition.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparsity__tools_8h.html">deal.II/lac/sparsity_tools.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>Step55</div><div class="line">{</div><div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">namespace </span>LinearSolvers</div><div class="line">  {</div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">    {</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">      InverseMatrix(<span class="keyword">const</span> Matrix &amp;m, <span class="keyword">const</span> Preconditioner &amp;preconditioner);</div><div class="line"></div><div class="line">      <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">      <span class="keywordtype">void</span> vmult(VectorType &amp;dst, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const Matrix&gt;</a> <a class="code" href="namespaceLAPACKSupport.html#a1a9009db0d9a77923a7031b549b9b638a5bc7c54a9c20485772672825c6a73003">matrix</a>;</div><div class="line">      <span class="keyword">const</span> Preconditioner &amp;           preconditioner;</div><div class="line">    };</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    InverseMatrix&lt;Matrix, Preconditioner&gt;::InverseMatrix(</div><div class="line">      <span class="keyword">const</span> Matrix &amp;        m,</div><div class="line">      <span class="keyword">const</span> Preconditioner &amp;preconditioner)</div><div class="line">      : matrix(&amp;m)</div><div class="line">      , preconditioner(preconditioner)</div><div class="line">    {}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> Matrix, <span class="keyword">class</span> Preconditioner&gt;</div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div><div class="line">    <span class="keywordtype">void</span></div><div class="line">    InverseMatrix&lt;Matrix, Preconditioner&gt;::vmult(VectorType &amp;      dst,</div><div class="line">                                                 <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">    </span>{</div><div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(src.size(), 1e-8 * src.l2_norm());</div><div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;LA::MPI::Vector&gt;</a> cg(solver_control);</div><div class="line">      dst = 0;</div><div class="line"></div><div class="line">      <span class="keywordflow">try</span></div><div class="line">        {</div><div class="line">          cg.solve(*matrix, dst, src, preconditioner);</div><div class="line">        }</div><div class="line">      <span class="keywordflow">catch</span> (std::exception &amp;e)</div><div class="line">        {</div><div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(e.what()));</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    <span class="keyword">class </span>BlockDiagonalPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div><div class="line">    {</div><div class="line">    <span class="keyword">public</span>:</div><div class="line">      BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                  <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S);</div><div class="line"></div><div class="line">      <span class="keywordtype">void</span> <a class="code" href="structSUNDIALS_1_1SundialsPreconditioner.html#aff5a880cfa288ecdd2a83a876abacf0d">vmult</a>(<a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">                 <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span>:</div><div class="line">      <span class="keyword">const</span> PreconditionerA &amp;preconditioner_A;</div><div class="line">      <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S;</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::</div><div class="line">      BlockDiagonalPreconditioner(<span class="keyword">const</span> PreconditionerA &amp;preconditioner_A,</div><div class="line">                                  <span class="keyword">const</span> PreconditionerS &amp;preconditioner_S)</div><div class="line">      : preconditioner_A(preconditioner_A)</div><div class="line">      , preconditioner_S(preconditioner_S)</div><div class="line">    {}</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerS&gt;</div><div class="line">    <span class="keywordtype">void</span> BlockDiagonalPreconditioner&lt;PreconditionerA, PreconditionerS&gt;::vmult(</div><div class="line">      <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;      dst,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div><div class="line"><span class="keyword">    </span>{</div><div class="line">      preconditioner_A.vmult(dst.block(0), src.block(0));</div><div class="line">      preconditioner_S.<a class="code" href="classPreconditionIdentity.html#a5cb13bb838919dd8b1ba531f20f21955">vmult</a>(dst.block(1), src.block(1));</div><div class="line">    }</div><div class="line"></div><div class="line">  } <span class="comment">// namespace LinearSolvers</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    RightHandSide()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> RightHandSide&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">    values[0] =</div><div class="line">      -1.0L / 2.0L * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0) *</div><div class="line">        <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">      0.4 * pi2 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) +</div><div class="line">      0.1 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 2) *</div><div class="line">        <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi);</div><div class="line">    values[1] = 0.2 * pi * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">                  <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) -</div><div class="line">                0.05 * <a class="code" href="numbers_8h.html#af44aee1db5cdcd0bab54e3c011d2be66">pow</a>(-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0, 3) *</div><div class="line">                  <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">                  pi;</div><div class="line">    values[2] = 0;</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>ExactSolution : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    ExactSolution()</div><div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1)</div><div class="line">    {}</div><div class="line"></div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                              Vector&lt;double&gt; &amp;  value) <span class="keyword">const override</span>;</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> ExactSolution&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div><div class="line">                                        Vector&lt;double&gt; &amp;  values)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_x = p[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> R_y = p[1];</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi  = <a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a>;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> pi2 = pi * pi;</div><div class="line">    values[0] =</div><div class="line">      -<a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(2 * R_y * pi) + 1;</div><div class="line">    values[1] = (1.0L / 2.0L) * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0) *</div><div class="line">                <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 5.0)) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">sin</a>(2 * R_y * pi) /</div><div class="line">                pi;</div><div class="line">    values[2] =</div><div class="line">      -1.0L / 2.0L * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(R_x * (-2 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 10.0)) -</div><div class="line">      2.0 *</div><div class="line">        (-6538034.74494422 +</div><div class="line">         0.0134758939981709 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(4 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">        (-80.0 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">         16.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) -</div><div class="line">      1634508.68623606 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">        (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">      (-0.00673794699908547 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(<a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) +</div><div class="line">       3269017.37247211 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(-3 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2))) /</div><div class="line">        (-8 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2) + 40.0) +</div><div class="line">      0.00336897349954273 * <a class="code" href="numbers_8h.html#a372e01cd9d1d07fdf136f4f40975d5cf">exp</a>(1.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2)) /</div><div class="line">        (-10.0 + 2.0 * <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">sqrt</a>(25.0 + 4 * pi2));</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keyword">class </span>StokesProblem</div><div class="line">  {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree);</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    <span class="keywordtype">void</span> make_grid();</div><div class="line">    <span class="keywordtype">void</span> setup_system();</div><div class="line">    <span class="keywordtype">void</span> assemble_system();</div><div class="line">    <span class="keywordtype">void</span> solve();</div><div class="line">    <span class="keywordtype">void</span> refine_grid();</div><div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree;</div><div class="line">    <span class="keywordtype">double</span>       viscosity;</div><div class="line">    <a class="code" href="classMPI__Comm.html">MPI_Comm</a>     mpi_communicator;</div><div class="line"></div><div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>                             fe;</div><div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div><div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>                           dof_handler;</div><div class="line"></div><div class="line">    std::vector&lt;IndexSet&gt; owned_partitioning;</div><div class="line">    std::vector&lt;IndexSet&gt; relevant_partitioning;</div><div class="line"></div><div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> system_matrix;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#a34f060e2c5e047fdc12c76d047c7c098">LA::MPI::BlockSparseMatrix</a> preconditioner_matrix;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       locally_relevant_solution;</div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a>       system_rhs;</div><div class="line"></div><div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div><div class="line">    <a class="code" href="classTimerOutput.html">TimerOutput</a>        computing_timer;</div><div class="line">  };</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  StokesProblem&lt;dim&gt;::StokesProblem(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> velocity_degree)</div><div class="line">    : velocity_degree(velocity_degree)</div><div class="line">    , viscosity(0.1)</div><div class="line">    , mpi_communicator(MPI_COMM_WORLD)</div><div class="line">    , fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree), dim, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(velocity_degree - 1), 1)</div><div class="line">    , triangulation(mpi_communicator,</div><div class="line">                    typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::MeshSmoothing(</div><div class="line">                      <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_refinement |</div><div class="line">                      <a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::smoothing_on_coarsening))</div><div class="line">    , dof_handler(triangulation)</div><div class="line">    , pcout(<a class="code" href="namespacestd.html">std</a>::cout,</div><div class="line">            (<a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0))</div><div class="line">    , computing_timer(mpi_communicator,</div><div class="line">                      pcout,</div><div class="line">                      <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div><div class="line">                      <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div><div class="line">  {}</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::make_grid()</div><div class="line">  {</div><div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(triangulation, -0.5, 1.5);</div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>(3);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_system()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;setup&quot;</span>);</div><div class="line"></div><div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div><div class="line"></div><div class="line">    std::vector&lt;unsigned int&gt; stokes_sub_blocks(dim + 1, 0);</div><div class="line">    stokes_sub_blocks[dim] = 1;</div><div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div><div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, stokes_sub_blocks);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div><div class="line">          &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    owned_partitioning.resize(2);</div><div class="line">    owned_partitioning[0] = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">    owned_partitioning[1] =</div><div class="line">      dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>().<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div><div class="line">    <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div><div class="line">    relevant_partitioning.resize(2);</div><div class="line">    relevant_partitioning[0] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u);</div><div class="line">    relevant_partitioning[1] = locally_relevant_dofs.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p);</div><div class="line"></div><div class="line">    {</div><div class="line">      constraints.reinit(locally_relevant_dofs);</div><div class="line"></div><div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div><div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div><div class="line">      <a class="code" href="namespaceVectorTools.html#af27ac28c698a9ed0199faed50a204538">VectorTools::interpolate_boundary_values</a>(dof_handler,</div><div class="line">                                               0,</div><div class="line">                                               ExactSolution&lt;dim&gt;(),</div><div class="line">                                               constraints,</div><div class="line">                                               fe.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(velocities));</div><div class="line">      constraints.close();</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      system_matrix.clear();</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line">          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == dim || d == dim || c == d)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">        dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">        dsp,</div><div class="line">        dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>(),</div><div class="line">        mpi_communicator,</div><div class="line">        locally_relevant_dofs);</div><div class="line"></div><div class="line">      system_matrix.reinit(owned_partitioning, dsp, mpi_communicator);</div><div class="line">    }</div><div class="line"></div><div class="line">    {</div><div class="line">      preconditioner_matrix.clear();</div><div class="line"></div><div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(dim + 1, dim + 1);</div><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; dim + 1; ++c)</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d = 0; d &lt; dim + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div><div class="line">          <span class="keywordflow">if</span> (c == dim &amp;&amp; d == dim)</div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div><div class="line">          <span class="keywordflow">else</span></div><div class="line">            coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a193fa079dee88a75524f669136d6faba">DoFTools::none</a>;</div><div class="line"></div><div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(dofs_per_block, dofs_per_block);</div><div class="line"></div><div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div><div class="line">        dof_handler, coupling, dsp, constraints, <span class="keyword">false</span>);</div><div class="line">      <a class="code" href="namespaceSparsityTools.html#afbc0c7a206ced91b154666215ea3c218">SparsityTools::distribute_sparsity_pattern</a>(</div><div class="line">        dsp,</div><div class="line">        <a class="code" href="namespaceUtilities_1_1MPI.html#ac5a7433f594a19070add2afa0f769efb">Utilities::MPI::all_gather</a>(mpi_communicator,</div><div class="line">                                   dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>()),</div><div class="line">        mpi_communicator,</div><div class="line">        locally_relevant_dofs);</div><div class="line">      preconditioner_matrix.reinit(owned_partitioning,</div><div class="line">                                   dsp,</div><div class="line">                                   mpi_communicator);</div><div class="line">    }</div><div class="line"></div><div class="line">    locally_relevant_solution.reinit(owned_partitioning,</div><div class="line">                                     relevant_partitioning,</div><div class="line">                                     mpi_communicator);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(owned_partitioning, mpi_communicator);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div><div class="line"></div><div class="line">    system_matrix         = 0;</div><div class="line">    preconditioner_matrix = 0;</div><div class="line">    system_rhs            = 0;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(velocity_degree + 1);</div><div class="line"></div><div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div><div class="line">                            quadrature_formula,</div><div class="line">                            <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div><div class="line">                              <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="group__feaccess.html#ggaa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div><div class="line"></div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div><div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> cell_matrix2(dofs_per_cell, dofs_per_cell);</div><div class="line">    Vector&lt;double&gt;     cell_rhs(dofs_per_cell);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> RightHandSide&lt;dim&gt;    right_hand_side;</div><div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(n_q_points, Vector&lt;double&gt;(dim + 1));</div><div class="line"></div><div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;         div_phi_u(dofs_per_cell);</div><div class="line">    std::vector&lt;double&gt;         phi_p(dofs_per_cell);</div><div class="line"></div><div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocities(0);</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a>     pressure(dim);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gacdb6d3adec96a13a7079f6c893e1d3ff">active_cell_iterators</a>())</div><div class="line">      <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div><div class="line">        {</div><div class="line">          cell_matrix  = 0;</div><div class="line">          cell_matrix2 = 0;</div><div class="line">          cell_rhs     = 0;</div><div class="line"></div><div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(cell);</div><div class="line">          right_hand_side.vector_value_list(fe_values.<a class="code" href="classFEValuesBase.html#ae41b67cfd48e02f6035e39c84f0fb47a">get_quadrature_points</a>(),</div><div class="line">                                            rhs_values);</div><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div><div class="line">            {</div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div><div class="line">                {</div><div class="line">                  grad_phi_u[k] = fe_values[velocities].gradient(k, q);</div><div class="line">                  div_phi_u[k]  = fe_values[velocities].divergence(k, q);</div><div class="line">                  phi_p[k]      = fe_values[pressure].value(k, q);</div><div class="line">                }</div><div class="line"></div><div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div><div class="line">                {</div><div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div><div class="line">                    {</div><div class="line">                      <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div><div class="line">                        (viscosity *</div><div class="line">                           <a class="code" href="symmetric__tensor_8h.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[i], grad_phi_u[j]) -</div><div class="line">                         div_phi_u[i] * phi_p[j] - phi_p[i] * div_phi_u[j]) *</div><div class="line">                        fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line"></div><div class="line">                      cell_matrix2(i, j) += 1.0 / viscosity * phi_p[i] *</div><div class="line">                                            phi_p[j] * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                    }</div><div class="line"></div><div class="line">                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div><div class="line">                    fe.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(i).first;</div><div class="line">                  cell_rhs(i) += fe_values.<a class="code" href="classFEValuesBase.html#a1dd48cb744013c448d57f8f77640c08d">shape_value</a>(i, q) *</div><div class="line">                                 rhs_values[q](component_i) * fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line"></div><div class="line">          cell-&gt;get_dof_indices(local_dof_indices);</div><div class="line">          constraints.distribute_local_to_global(cell_matrix,</div><div class="line">                                                 cell_rhs,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 system_matrix,</div><div class="line">                                                 system_rhs);</div><div class="line"></div><div class="line">          constraints.distribute_local_to_global(cell_matrix2,</div><div class="line">                                                 local_dof_indices,</div><div class="line">                                                 preconditioner_matrix);</div><div class="line">        }</div><div class="line"></div><div class="line">    system_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    preconditioner_matrix.compress(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">    system_rhs.<a class="code" href="classBlockVector.html#ad581edc4d3b86a88c4277117c4fae57a">compress</a>(<a class="code" href="structVectorOperation.html#a40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::solve()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;solve&quot;</span>);</div><div class="line"></div><div class="line">    LA::MPI::PreconditionAMG prec_A;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_A.initialize(system_matrix.block(0, 0), data);</div><div class="line">    }</div><div class="line"></div><div class="line">    LA::MPI::PreconditionAMG prec_S;</div><div class="line">    {</div><div class="line">      LA::MPI::PreconditionAMG::AdditionalData data;</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">      data.symmetric_operator = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">      prec_S.initialize(preconditioner_matrix.block(1, 1), data);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">using</span> mp_inverse_t = LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a912abe2208022aec6753876bcc72f6bf">LA::MPI::SparseMatrix</a>,</div><div class="line">                                                      LA::MPI::PreconditionAMG&gt;;</div><div class="line">    <span class="keyword">const</span> mp_inverse_t mp_inverse(preconditioner_matrix.block(1, 1), prec_S);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> LinearSolvers::BlockDiagonalPreconditioner&lt;<a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a41f11f7a1992c6d6aa9367b12c68f791">LA::MPI::PreconditionAMG</a>,</div><div class="line">                                                     mp_inverse_t&gt;</div><div class="line">      preconditioner(prec_A, mp_inverse);</div><div class="line"></div><div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(system_matrix.m(),</div><div class="line">                                 1e-10 * system_rhs.<a class="code" href="classBlockVectorBase.html#ac718033fc083f27c45c6bfb4ac780360">l2_norm</a>());</div><div class="line"></div><div class="line">    <a class="code" href="classSolverMinRes.html">SolverMinRes&lt;LA::MPI::BlockVector&gt;</a> solver(solver_control);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> distributed_solution(owned_partitioning,</div><div class="line">                                              mpi_communicator);</div><div class="line"></div><div class="line">    constraints.set_zero(distributed_solution);</div><div class="line"></div><div class="line">    solver.solve(system_matrix,</div><div class="line">                 distributed_solution,</div><div class="line">                 system_rhs,</div><div class="line">                 preconditioner);</div><div class="line"></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Solved in &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span></div><div class="line">          &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    constraints.distribute(distributed_solution);</div><div class="line"></div><div class="line">    locally_relevant_solution = distributed_solution;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> mean_pressure =</div><div class="line">      VectorTools::compute_mean_value(dof_handler,</div><div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(velocity_degree + 2),</div><div class="line">                                      locally_relevant_solution,</div><div class="line">                                      dim);</div><div class="line">    distributed_solution.block(1).add(-mean_pressure);</div><div class="line">    locally_relevant_solution.block(1) = distributed_solution.block(1);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_grid()</div><div class="line">  {</div><div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;refine&quot;</span>);</div><div class="line"></div><div class="line">    triangulation.<a class="code" href="classTriangulation.html#a6ad0b3fb24aae17f4668427a433dea19">refine_global</a>();</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div><div class="line"><span class="keyword">  </span>{</div><div class="line">    {</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> pressure_mask(dim, dim + 1);</div><div class="line">      <span class="keyword">const</span> <a class="code" href="classComponentSelectFunction.html">ComponentSelectFunction&lt;dim&gt;</a> velocity_mask(std::make_pair(0, dim),</div><div class="line">                                                       dim + 1);</div><div class="line"></div><div class="line">      Vector&lt;double&gt; cellwise_errors(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>    quadrature(velocity_degree + 2);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;velocity_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_u_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div><div class="line">                                        locally_relevant_solution,</div><div class="line">                                        ExactSolution&lt;dim&gt;(),</div><div class="line">                                        cellwise_errors,</div><div class="line">                                        quadrature,</div><div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>,</div><div class="line">                                        &amp;pressure_mask);</div><div class="line"></div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> error_p_l2 =</div><div class="line">        <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(triangulation,</div><div class="line">                                          cellwise_errors,</div><div class="line">                                          <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div><div class="line"></div><div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;error: u_0: &quot;</span> &lt;&lt; error_u_l2 &lt;&lt; <span class="stringliteral">&quot; p_0: &quot;</span> &lt;&lt; error_p_l2</div><div class="line">            &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div><div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div><div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div><div class="line">      data_component_interpretation(</div><div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div><div class="line">    data_component_interpretation.push_back(</div><div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div><div class="line"></div><div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_solution,</div><div class="line">                             solution_names,</div><div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                             data_component_interpretation);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated;</div><div class="line">    interpolated.reinit(owned_partitioning, MPI_COMM_WORLD);</div><div class="line">    <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler, ExactSolution&lt;dim&gt;(), interpolated);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceLinearAlgebraDealII.html#aa4543bb429e129431d48d18c1bfebae3">LA::MPI::BlockVector</a> interpolated_relevant(owned_partitioning,</div><div class="line">                                               relevant_partitioning,</div><div class="line">                                               MPI_COMM_WORLD);</div><div class="line">    interpolated_relevant = interpolated;</div><div class="line">    {</div><div class="line">      std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;ref_u&quot;</span>);</div><div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;ref_p&quot;</span>);</div><div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(interpolated_relevant,</div><div class="line">                               solution_names,</div><div class="line">                               <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div><div class="line">                               data_component_interpretation);</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    Vector&lt;float&gt; subdomain(triangulation.<a class="code" href="classTriangulation.html#a5ea5c9957dbb566a562bbe2c0f3971e9">n_active_cells</a>());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; subdomain.size(); ++i)</div><div class="line">      subdomain(i) = triangulation.<a class="code" href="classTriangulation.html#a44ea82a097d8317c98fa422307aff874">locally_owned_subdomain</a>();</div><div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(subdomain, <span class="stringliteral">&quot;subdomain&quot;</span>);</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div><div class="line"></div><div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div><div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2);</div><div class="line">  }</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">StokesProblem&lt;dim&gt;::run</a>()</div><div class="line">  {</div><div class="line"><span class="preprocessor">#ifdef USE_PETSC_LA</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using PETSc.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Running using Trilinos.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_cycles = 5;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; n_cycles; ++cycle)</div><div class="line">      {</div><div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (cycle == 0)</div><div class="line">          make_grid();</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">          refine_grid();</div><div class="line"></div><div class="line">        setup_system();</div><div class="line"></div><div class="line">        assemble_system();</div><div class="line">        solve();</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(mpi_communicator) &lt;= 32)</div><div class="line">          {</div><div class="line">            <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(computing_timer, <span class="stringliteral">&quot;output&quot;</span>);</div><div class="line">            output_results(cycle);</div><div class="line">          }</div><div class="line"></div><div class="line">        computing_timer.print_summary();</div><div class="line">        computing_timer.reset();</div><div class="line"></div><div class="line">        pcout &lt;&lt; std::endl;</div><div class="line">      }</div><div class="line">  }</div><div class="line">} <span class="comment">// namespace Step55</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  <span class="keywordflow">try</span></div><div class="line">    {</div><div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div><div class="line">      <span class="keyword">using namespace </span>Step55;</div><div class="line"></div><div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(argc, argv, 1);</div><div class="line"></div><div class="line">      StokesProblem&lt;2&gt; problem(2);</div><div class="line">      problem.run();</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line"></div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">  <span class="keywordflow">catch</span> (...)</div><div class="line">    {</div><div class="line">      std::cerr &lt;&lt; std::endl</div><div class="line">                &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div><div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div><div class="line">                &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
