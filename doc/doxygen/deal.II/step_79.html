<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_79.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-79 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-79 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_8.html">step-8</a>, <a class="el" href="step_15.html">step-15</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#SolidIsotropicMaterialwithPenalization">Solid Isotropic Material with Penalization</a>
        <li><a href="#ElasticityEquation">Elasticity Equation</a>
        <li><a href="#Makingthesolutionmeshindependent">Making the solution mesh-independent</a>
        <li><a href="#CompleteProblemFormulation">Complete Problem Formulation</a>
        <li><a href="#Solutionprocedure">Solution procedure</a>
        <li><a href="#Discretization">Discretization</a>
        <li><a href="#NonlinearAlgorithm">Nonlinear Algorithm</a>
        <li><a href="#MeritFunction">Merit Function</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Preliminaries">Preliminaries</a>
        <li><a href="#TheSANDTopOptmainclass">The SANDTopOpt main class</a>
        <li><a href="#Constructorandsetupfunctions">Constructor and set-up functions</a>
        <li><a href="#Settingupblockmatricesandvectors">Setting up block matrices and vectors</a>
        <li><a href="#Creatingthefiltermatrix">Creating the filter matrix</a>
        <li><a href="#AssemblingtheNewtonmatrix">Assembling the Newton matrix</a>
        <li><a href="#SolvingtheNewtonlinearsystem">Solving the Newton linear system</a>
        <li><a href="#Detailsoftheoptimizationalgorithm">Details of the optimization algorithm</a>
      <ul>
        <li><a href="#Computingsteplengths">Computing step lengths</a>
        <li><a href="#Computingresiduals">Computing residuals</a>
        <li><a href="#Computingthemeritfunction">Computing the merit function</a>
        <li><a href="#Findingasearchdirection">Finding a search direction</a>
        <li><a href="#Computingascaledstep">Computing a scaled step</a>
        <li><a href="#Checkingforconvergence">Checking for convergence</a>
      </ul>
        <li><a href="#Postprocessingthesolution">Postprocessing the solution</a>
        <li><a href="#Therunfunctiondrivingtheoverallalgorithm">The run() function driving the overall algorithm</a>
        <li><a href="#Themainfunction">The main function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#TestProblem">Test Problem</a>
      <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>Topology Optimization of Elastic Media is a technique used to optimize a structure that is bearing some load. Ideally, we would like to minimize the maximum stress placed on a structure by selecting a region \(E\) where material is placed. In other words, </p><p class="formulaDsp">
\[ \text{minimize}\| \boldsymbol{\sigma} (\mathbf{u}) \|_\infty \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } |E|\leq V_{\max}, \]
</p>
 <p class="formulaDsp">
\[ \text{and } \nabla \cdot \boldsymbol{\sigma} + \mathbf{F} = \mathbf{0}. \]
</p>
<p>Here, \(\boldsymbol{\sigma} = \mathbf{C} : \boldsymbol{\varepsilon}(\mathbf{u})\) is the stress within the body that is caused by the external forces \(\mathbf F\), where we have for simplicity assumed that the material is linear-elastic and so \(\mathbf{C}\) is the stress-strain tensor and \(\boldsymbol{\varepsilon}(\mathbf{u})=\frac{1}{2} (\nabla \mathbf{u} + (\nabla\mathbf{u})^T)\) is the small-deformation strain as a function of the displacement \(\mathbf{u}\) &ndash; see <a class="el" href="step_8.html">step-8</a> and <a class="el" href="step_17.html">step-17</a> for more on linear elasticity. In the formulation above, \(V_\text{max}\) is the maximal amount of material we are willing to provide to build the object. The last of the constraints is the partial differential equation that relates stress \(\boldsymbol{\sigma}\) and forces \(\mathbf F\) and is simply the steady-state force balance.</p>
<p>That said, the infinity norm above creates a problem: As a function of location of material, this objective function is necessarily not differentiable, making prospects of optimization rather bleak. So instead, a common approach in topology optimization is to find an approximate solution by optimizing a related problem: We would like to minimize the strain energy. This is a measure of the potential energy stored in an object due to its deformation, but also works as a measure of total deformation over the structure.</p>
<p class="formulaDsp">
\[ \text{minimize } \int_E \frac{1}{2}\boldsymbol{\sigma} : \boldsymbol{\varepsilon} dV \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } \|E\| \leq V_{\max} \]
</p>
 <p class="formulaDsp">
\[ \text{and } \nabla \cdot \boldsymbol{\sigma} + \mathbf{F} = \mathbf{0} \]
</p>
<p>The value of the objective function is calculated using a finite element method, where the solution is the displacements. This is placed inside of a nonlinear solver loop that solves for a vector denoting placement of material.</p>
<p><a class="anchor" id="SolidIsotropicMaterialwithPenalization"></a></p><h3>Solid Isotropic Material with Penalization</h3>
<p>In actual practice, we can only build objects in which the material is either present, or not present, at any given point &ndash; i.e., we would have an indicator function \(\rho_E(\mathbf{x})\in \{0,1\}\) that describes the material-filled region and that we want to find through the optimization problem. In this case, the optimization problem becomes combinatorial, and very expensive to solve. Instead, we use an approach called Solid Isotropic Material with Penalization, or SIMP. <b>[Bendse2004]</b></p>
<p>The SIMP method is based on an idea of allowing the material to exist in a location with a density \(\rho\) between 0 and 1. A density of 0 suggests the material is not there, and it is not a part of the structure, while a density of 1 suggests the material is present. Values between 0 and 1 do not reflect a design we can create in the real-world, but allow us to turn the combinatorial problem into a continuous one. One then looks at density values \(\rho\), with the constraint that \(0 &lt; \rho_{\min} \leq \rho \leq 1\). The minimum value \(\rho_{\min}\), typically chosen to be around \(10^{-3}\), avoids the possibility of having an infinite strain energy, but is small enough to provide accurate results.</p>
<p>The straightforward application of the effect of this "density" on the elasticity of the media would be to simply multiply the stiffness tensor \(\mathbf{C}_0\) of the medium by the given density, that is, \(\mathbf{C} = \rho \mathbf{C}_0\). However, this approach often gives optimal solutions where density values are far from both 0 and 1. As one wants to find a real-world solution, meaning the material either is present or it is not, a penalty is applied to these in-between values. A simple and effective way to do this is to multiply the stiffness tensor by the density raised to some integer power penalty parameter \(p\), so that \(\mathbf{C} = \rho^p \mathbf{C}_0\). This makes density values farther away from 0 or 1 less effective. It has been shown that using \(p=3\) is sufficiently high to create 'black-and-white' solutions: that is, one gets optimal solutions in which material is either present or not present at all points.</p>
<p>More material should always provide a structure with a lower strain energy, and so the inequality constraint can be viewed as an equality where the total volume used is the maximum volume.</p>
<p>Using this density idea also allows us to reframe the volume constraint on the optimization problem. Use of SIMP then turns the optimization problem into the following:</p>
<p class="formulaDsp">
\[ \text{minimize } \int_\Omega \frac{1}{2}\boldsymbol{\sigma}(\rho) : \boldsymbol{\varepsilon}(\rho) d\Omega \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } \int_\Omega \rho(x) d\Omega= V_{\max}, \]
</p>
 <p class="formulaDsp">
\[ 0&lt;\rho_{\min}\leq \rho(x) \leq 1, \]
</p>
 <p class="formulaDsp">
\[ \nabla \cdot \boldsymbol{\sigma}(\rho) + \mathbf{F} = 0 \quad \text{on } \Omega \]
</p>
<p> The final constraint, the balance of linear momentum (which we will refer to as the elasticity equation), gives a method for finding \(\boldsymbol{\sigma}\) and \(\boldsymbol{\varepsilon}\) given the density \(\rho\).</p>
<p><a class="anchor" id="ElasticityEquation"></a></p><h3>Elasticity Equation</h3>
<p>The elasticity equation in the time independent limit reads </p><p class="formulaDsp">
\[ \nabla \cdot \boldsymbol{\sigma} + \mathbf{F} = \mathbf{0} . \]
</p>
<p> In the situations we will care about, we will assume that the medium has a linear material response and in that case, we have that </p><p class="formulaDsp">
\[ \boldsymbol{\sigma} = \mathbf{C} : \boldsymbol{\varepsilon} = \rho^p \mathbf{C}_0 : \boldsymbol{\varepsilon}(\mathbf{u}) = \rho^p \mathbf{C}_0 : \left[\frac{1}{2} (\nabla \mathbf{u} + (\nabla \mathbf{u})^T) \right] . \]
</p>
<p> In everything we will do below, we will always consider the displacement field \(\mathbf{u}\) as the only solution variable, rather than considering \(\mathbf{u}\) and \(\boldsymbol{\sigma}\) as solution variables (as is done in mixed formulations).</p>
<p>Furthermore, we will make the assumption that the material is linear isotropic, in which case the stress-strain tensor can be expressed in terms of the Lam&eacute; parameters \(\lambda,\mu\) such that </p><p class="formulaDsp">
\begin{align} \boldsymbol{\sigma} &amp;= \rho^p (\lambda \text{tr}(\boldsymbol{\varepsilon}) \mathbf{I} + 2 \mu \boldsymbol{\varepsilon}) , \\ \sigma_{i,j} &amp;= \rho^p (\lambda \varepsilon_{k,k} \delta_{i,j} + 2 \mu \varepsilon_{i,j}) . \end{align}
</p>
<p> See <a class="el" href="step_8.html">step-8</a> for how this transformation works.</p>
<p>Integrating the objective function by parts gives </p><p class="formulaDsp">
\[ \int_\Omega \boldsymbol{\sigma}(\rho) : (\nabla \mathbf{u} + (\nabla \mathbf{u}))^T d\Omega+ \int_\Omega (\nabla \cdot \boldsymbol{\sigma}(\rho)) \cdot \mathbf{u} d\Omega= \int_{\partial \Omega} \mathbf{t} \cdot \mathbf{u} d\partial\Omega , \]
</p>
<p> into which the linear elasticity equation can then be substituted, giving </p><p class="formulaDsp">
\[ \int_\Omega \boldsymbol{\sigma}(\rho) : (\nabla \mathbf{u} + (\nabla \mathbf{u})^T) d\Omega = \int_\Omega \mathbf{F}\cdot \mathbf{u} d\Omega+ \int_{\partial \Omega} \mathbf{t} \cdot \mathbf{u} d\partial\Omega . \]
</p>
<p> Because we are assuming no body forces, this simplifies further to </p><p class="formulaDsp">
\[ \int_\Omega \boldsymbol{\sigma}(\rho) : (\nabla \mathbf{u} + (\nabla \mathbf{u})^T) d\Omega = \int_{\partial \Omega} \mathbf{t} \cdot \mathbf{u} d\partial\Omega, \]
</p>
<p> which is the final form of the governing equation that we'll be considering from this point forward.</p>
<p><a class="anchor" id="Makingthesolutionmeshindependent"></a></p><h3>Making the solution mesh-independent</h3>
<p>Typically, the solutions to topology optimization problems are mesh-dependent, and as such the problem is ill-posed. This is because fractal structures are often formed as the mesh is refined further. As the mesh gains resolution, the optimal solution typically gains smaller and smaller structures. There are a few competing workarounds to this issue, but the most popular for first order optimization is the sensitivity filter, while second order optimization methods tend to prefer use of a density filter.</p>
<p>As the filters affect the gradient and Hessian of the strain energy (i.e., the objective function), the choice of filter has an effect on the solution of the problem. The density filter as part of a second order method works by introducing an unfiltered density, which we refer to as \(\varrho\), and then requiring that the density be a convolution of the unfiltered density: </p><p class="formulaDsp">
\[ \rho = H(\varrho). \]
</p>
<p> Here, \(H\) is an operator so that \(\rho(\mathbf{x})\) is some kind of average of the values of \(\varrho\) in the area around \(\mathbf{x}\) &ndash; i.e., it is a smoothed version of \(\varrho\).</p>
<p>This prevents checkerboarding; the radius of the filter allows the user to define an effective minimal beam width for the optimal structures we seek to find.</p>
<div style="text-align:center;"> <img src="https://www.dealii.org/images/steps/developer/step-79.checkerboard.png" alt="Checkerboarding occurring in an MBB Beam" class="inline"/> </div><p><a class="anchor" id="CompleteProblemFormulation"></a></p><h3>Complete Problem Formulation</h3>
<p>The minimization problem is now </p><p class="formulaDsp">
\[ \min_{\rho,\varrho,\mathbf{u}} \int_{\partial\Omega} \mathbf{u} \cdot \mathbf{t} d\partial\Omega \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } \rho = H(\varrho) \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega \rho^p \left(\frac{\mu}{2}\left(\boldsymbol{\varepsilon}(\mathbf{v}): \boldsymbol{\varepsilon}(\mathbf{u})) \right) + \lambda \left( \nabla \cdot \mathbf{u} \nabla \cdot \mathbf{v} \right) \right) d\Omega = \int_{\partial \Omega} \mathbf{v} \cdot \mathbf{t} d\partial\Omega \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega \rho d\Omega= V \]
</p>
 <p class="formulaDsp">
\[ 0\leq \varrho \leq 1 \]
</p>
<p>The inequality constraints are dealt with by first introducing slack variables, and second using log barriers to ensure that we obtain an interior-point method. The penalty parameter is going to be \(\alpha\), and the following slack variables are </p><ol>
<li>
\(s_1\) - a slack variable corresponding to the lower bound </li>
<li>
\(s_2\) - a slack variable corresponding to the upper bound. </li>
</ol>
<p>This now gives the following problem: </p><p class="formulaDsp">
\[ \min_{\rho,\varrho,\mathbf{u}, s_1, s_2} \int_{\partial\Omega} \mathbf{u} \cdot \mathbf{t} d\partial\Omega- \alpha \int_\Omega \left(\log(s_1) + \log(s_2)\right) d\Omega \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } \rho = H(\varrho) \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega \rho^p \left(\frac{\mu}{2}\left(\boldsymbol{\varepsilon}(\mathbf{v}): \boldsymbol{\varepsilon}(\mathbf{u})) \right) + \lambda \left( \nabla \cdot \mathbf{u} \nabla \cdot \mathbf{v} \right) \right) d\Omega = \int_{\partial \Omega} \mathbf{v} \cdot \mathbf{t} d\partial\Omega \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega \rho d\Omega = V \]
</p>
 <p class="formulaDsp">
\[ \varrho = s_1 \]
</p>
 <p class="formulaDsp">
\[ 1-\varrho = s_2 \]
</p>
<p>With these variables in place, we can then follow the usual approach to solving constrained optimization problems: We introduce a Lagrangian in which we combine the objective function and the constraints by multiplying the constraints by Lagrange multipliers. Specifically, we will use the following symbols for the Lagrange multipliers for the various constraints: </p><ol>
<li>
\(\mathbf{y}_1 \): a Lagrange multiplier corresponding to the elasticity constraint,  </li>
<li>
\(y_2\): a Lagrange multiplier corresponding to the convolution filter constraint,  </li>
<li>
\(z_1\): a Lagrange multiplier corresponding to the lower slack variable, and  </li>
<li>
\(z_2\): a Lagrange multiplier corresponding to the upper slack variable.  </li>
</ol>
<p>With these variables, the Lagrangian function reads as follows:</p>
<p class="formulaDsp">
\begin{align} \mathcal{L} =&amp; \int_{\partial\Omega} \mathbf{u} \cdot \mathbf{t} d\partial\Omega - \alpha \int_\Omega \left(\log(s_1) + \log(s_2)\right) d\Omega- \int_\Omega \rho^p \left(\frac{\mu}{2}\left(\boldsymbol{\varepsilon}(\mathbf{y}_1):\boldsymbol{\varepsilon}(\mathbf{u})) \right) + \lambda \left( \nabla \cdot \mathbf{u} \nabla \cdot \mathbf{y}_1 \right)\right) d\Omega - \int_{\partial \Omega} \mathbf{y}_1 \cdot \mathbf{t} d\partial\Omega \\ &amp; -\int_\Omega y_2 (\rho - H(\varrho)) d\Omega - \int_\Omega z_1 (\varrho-s_1) d\Omega - \int_\Omega z_2 (1 - s_2 -\varrho) d\Omega \end{align}
</p>
<p>The solution of the optimization problem then needs to satisfy what are known as the <a href="https://en.wikipedia.org/wiki/Karush%E2%80%93Kuhn%E2%80%93Tucker_conditions">Karush-Kuhn-Tucker (KKT) conditions</a>: The derivatives of the Lagrangian with respect to all of its arguments need to be equal to zero, and because we have inequality constraints, we also have "complementarity" conditions. Since we here have an infinite-dimensional problem, these conditions all involve directional derivatives of the Lagrangian with regard to certain test functions &ndash; in other words, all of these conditions have to be stated in weak form as is typically the basis for finite element methods anyway.</p>
<p>The barrier method allows us to initially weaken the "complementary slackness" as required by the typical KKT conditions. Typically, we would require that \(s_i z_i = 0\), but the barrier formulations give KKT conditions where \(s_i z_i = \alpha\), where \(\alpha\) is our barrier parameter. As part of the barrier method, this parameter must be driven close to 0 to give a good approximation of the original problem.</p>
<p>In the following, let us state all of these conditions where \(d_{\{\bullet\}}\) is a test function that is naturally paired with variational derivatives of the Lagrangian with respect to the \(\{\bullet\}\) function. For simplicity, we introduce \(\Gamma\) to indicate the portion of the boundary where forces are applied, and Neumann boundary conditions are used.</p>
<ol>
<li>
Stationarity: <p class="formulaDsp">
\[ \int_\Omega - d_\rho y_2 + p\rho^{p-1}d_\rho \left[\lambda (\nabla \cdot \mathbf{y}_1) (\nabla \cdot \mathbf{u}) + \mu \boldsymbol{\varepsilon}(\mathbf{u}):\boldsymbol{\varepsilon}(\mathbf{y}_1)\right] d\Omega=0\;\; \forall d_\rho \]
</p>
 <p class="formulaDsp">
\[ \int_\Gamma \mathbf d_\mathbf{u} \cdot \mathbf{t} d\partial\Omega+ \int_\Omega p\rho^{p} \left[\lambda (\nabla \cdot \mathbf d_\mathbf{u})( \nabla \cdot \mathbf{y}_1) + \mu \boldsymbol{\varepsilon}(\mathbf d_\mathbf{u}):\boldsymbol{\varepsilon}(\mathbf{y}_1)\right] d\Omega=0\;\; \forall \mathbf{d}_\mathbf{u} \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega -d_\varrho z_1 + d_\varrho z_2 + H(d_\varrho)y_2 d\Omega= 0\;\;\forall d_\varrho \]
</p>
  </li>
<li>
Primal Feasibility: <p class="formulaDsp">
\[ \int_\Omega \rho^{p}\lambda (\nabla \cdot \mathbf d_{\mathbf{y}_1}) (\nabla \cdot \mathbf{u}) + \rho^{p}\mu \boldsymbol{\varepsilon}(\mathbf d_{\mathbf{y}_1}) : \boldsymbol{\varepsilon}(\mathbf{u}) d\Omega - \int_\Gamma \mathbf d_{\mathbf{y}_1} \cdot \mathbf{t} d\partial\Omega =0 \;\;\forall \mathbf{d}_{\mathbf{y}_1} \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega d_{z_1}(\varrho - s_1) d\Omega = 0\;\;\forall d_{z_1} \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega d_{z_z}(1-\varrho-s_2) d\Omega = 0\;\;\forall d_{z_2} \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega d_{y_2}(\rho - H(\varrho)) d\Omega = 0\;\;\forall d_{y_2} \]
</p>
  </li>
<li>
Complementary Slackness: <p class="formulaDsp">
\[ \int_\Omega d_{s_1}(s_1z_1 - \alpha) d\Omega = 0 \;\;\forall d_{s_1} ,\;\;\; \alpha \to 0 \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega d_{s_2}(s_2z_2 - \alpha) d\Omega = 0 \;\;\forall d_{s_2} ,\;\;\; \alpha \to 0 \]
</p>
  </li>
<li>
Dual Feasibility: <p class="formulaDsp">
\[ s_{1,i},s_{2,i},z_{1,i},z_{2,i} \geq 0 \;\;\;\; \forall i \]
</p>
  </li>
</ol>
<p><a class="anchor" id="Solutionprocedure"></a></p><h3>Solution procedure</h3>
<p>The optimality conditions above are, in addition to being convoluted, of a kind that is not easy to solve: They are generally nonlinear, and some of the relationships are also inequalities. We will address the nonlinearity using a Newton method to compute search directions, and come back to how to deal with the inequalities below when talking about step length procedures.</p>
<p>Newton's method applied to the equations above results in the system of equations listed below. Therein, variational derivatives with respect to the \(\{\bullet\}\) variable are taken in the \(c_{\{\bullet\}}\) direction.</p>
<ol>
<li>
<p class="startli">Stationarity: These equations ensure we are at a critical point of the objective function when constrained.</p>
<p class="interli">Equation 1 </p><p class="formulaDsp">
\begin{align} &amp;\int_\Omega-d_\rho c_{y_2} + p(p-1) \rho^{p-2} d_\rho c_\rho [\lambda \nabla \cdot \mathbf{y}_1 \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{y}_1)] + p \rho^{p-1} d_\rho[\lambda \nabla \cdot \mathbf{c}_{\mathbf{y}_1} \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon} (\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{c}_{\mathbf{y}_1})] + p \rho^{p-1} d_\rho [\lambda \nabla \cdot {\mathbf{y}_1} \nabla \cdot \mathbf{c}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{c}_\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{y}_1)] d\Omega \\ &amp;= -\int_\Omega -d_\rho z_1 + d_\rho z_2 - d_\rho y_2 + p\rho^{p-1}d_\rho [\lambda \nabla \cdot \mathbf{y}_1 \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon} (\mathbf{u})\boldsymbol{\varepsilon}(\mathbf{y}_1)] d\Omega \end{align}
</p>
<p class="interli">Equation 2 </p><p class="formulaDsp">
\begin{align} &amp;\int_\Omega p \rho^{p-1} c_\rho [\lambda \nabla \cdot {\mathbf{y}_1} \nabla \cdot \mathbf{d}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{d}_\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{y})] + \rho^{p} [\lambda \nabla \cdot \mathbf{c}_{\mathbf{y}_1} \nabla \cdot \mathbf{d}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{d}_\mathbf{u})\boldsymbol{\varepsilon}(\mathbf{c}_{\mathbf{y}_1})] d\Omega \\ &amp;= -\int_\Gamma \mathbf{d}_\mathbf{u} \cdot \mathbf{t} -\int_\Omega \rho^{p} [\lambda \nabla \cdot \mathbf{y} \nabla \cdot \mathbf{d}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(d_\mathbf{u})\boldsymbol{\varepsilon}(\mathbf{y}_1)] d\Omega \end{align}
</p>
<p class="interli">Equation 3 </p><p class="formulaDsp">
\[ \int_\Omega - d_\varrho c_{z_1} +d_\varrho c_{z_2} + H(d_\varrho)c_{y_2} d\Omega = -\int_\Omega -d_\varrho z_1 + d_\varrho z_2 + H(d_\varrho)y_2 d\Omega \]
</p>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Primal Feasibility: These equations ensure the equality constraints are met.</p>
<p class="interli">Equation 4 </p><p class="formulaDsp">
\begin{align} &amp;\int_\Omega p \rho^{p-1} c_p[\lambda \nabla \cdot \mathbf{d}_{\mathbf{y}_1} \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{d}_{\mathbf{y}_1})] + \rho^{p}[\lambda \nabla \cdot \mathbf{d}_{\mathbf{y}_1} \nabla \cdot \mathbf{c}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{c}_\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{d}_{\mathbf{y}_1})] d\Omega \\ &amp;= -\int_\Omega \rho^{p}[\lambda \nabla \cdot \mathbf{d}_{\mathbf{y}_1} \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{u}) \boldsymbol{\varepsilon} (\mathbf{d}_{\mathbf{y}_1})] + \int_\Gamma \mathbf{d}_{\mathbf{y}_1} \cdot \mathbf{t} d\partial\Omega \end{align}
</p>
<p class="interli">Equation 5 </p><p class="formulaDsp">
\[ -\int_\Omega d_{z_1}(c_\varrho - c_{s_1}) d\Omega=\int_\Omega d_{z_1} (\varrho - s_1) d\Omega \]
</p>
<p class="interli">Equation 6 </p><p class="formulaDsp">
\[ -\int_\Omega d_{z_2}(-c_\varrho-c_{s_2}) d\Omega= \int_\Omega d_{z_2} (1-\varrho-s_2) d\Omega \]
</p>
<p class="interli">Equation 7 </p><p class="formulaDsp">
\[ -\int_\Omega d_{y_2}(c_\rho - H(c_\varrho)) d\Omega=\int_\Omega d_{y_2} (\rho - H(\varrho)) d\Omega \]
</p>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Complementary Slackness: These equations essentially ensure the barrier is met - in the final solution, we need \(s^T z = 0\).</p>
<p class="interli">Equation 8 </p><p class="formulaDsp">
\[ \int_\Omega d_{s_1}(c_{s_1}z_1/s_1 + c_{z_1} ) d\Omega=-\int_\Omega d_{s_1} (z_1 - \alpha/s_1) d\Omega ,\;\;\; \alpha \to 0 \]
</p>
<p class="interli">Equation 9 </p><p class="formulaDsp">
\[ \int_\Omega d_{s_2} (c_{s_2}z_2/s_2 + c_{z_2} ) d\Omega=-\int_\Omega d_{s_2} (z_2 - \alpha/s_2) d\Omega,\;\;\; \alpha \to 0 \]
</p>
 <p class="endli"></p>
</li>
<li>
Dual Feasibility: The Lagrange multiplier on slacks and slack variables must be kept greater than 0. (This is the only part not implemented in the <code>SANDTopOpt::assemble_system()</code> function.) <p class="formulaDsp">
\[ s,z \geq 0 \]
</p>
  </li>
</ol>
<p><a class="anchor" id="Discretization"></a></p><h3>Discretization</h3>
<p>We use a quadrilateral mesh with \(Q_1\) elements to discretize the displacement and displacement Lagrange multiplier. Piecewise constant \(DGQ_0\) elements are used to discretize the density, unfiltered density, density slack variables, and multipliers for the slack variables and filter constraint.</p>
<p><a class="anchor" id="NonlinearAlgorithm"></a></p><h3>Nonlinear Algorithm</h3>
<p>While most of the discussion above follows traditional and well-known approaches to solving nonlinear optimization problems, it turns out that the problem is actually quite difficult to solve in practice. In particular, it is quite nonlinear and an important question is not just to find search directions \(c_{\{\bullet\}}\) as discussed above based on a Newton method, but that one needs to spend quite a lot of attention to how far one wants to go in this direction. This is often called "line search" and comes down to the question of how to choose the step length \(\alpha_k \in (0,1]\) so that we move from the current iterate \(\mathbf{x}_k\) to the next iterate \(\mathbf{x}_{k+1}=\mathbf{x}_k+\alpha_k \mathbf{x}_k\) in as efficient a way as possible. It is well understood that we need to eventually choose \(\alpha_k=1\) to realize the Newton's method's quadratic convergence; however, in the early iterations, taking such a long step might actually make things worse, either by leading to a point that has a worse objective function or at which the constraints are satisfied less well than they are at \(\mathbf{x}_k\).</p>
<p>Very complex algorithms have been proposed to deal with this issue <b>[Nocedal2009]</b> <b>[Waechter2005]</b>. Here, we implement a watchdog-search algorithm <b>[Nocedal2006]</b>. When discussing this algorithm, we will use the vector \(\mathbf{x}\) to represent all primal variables - the filtered and unfiltered densities, slack variables and displacement - and use the vector \(\mathbf{y}\) to represent all of the dual vectors. The (incremental) solution to the nonlinear system of equations stated above will now be referred to as \(\Delta \mathbf{x}\) and \(\Delta \mathbf{y}\) instead of \(c_{\{\bullet\}}\). A merit function (explained in more detail later) is referred to here as \(\phi(\mathbf{x,\mathbf{y}})\).</p>
<p>The watchdog algorithm applied to a subproblem with a given barrier parameter works in the following way: First, the current iteration is saved as a "watchdog" state, and the merit of the watchdog state is recorded. A maximal feasible Newton step is then taken. If the merit sufficiently decreased from the first step, this new step is accepted. If not, another maximal feasible Newton step is taken, and the merit is again compared to the watchdog merit. If after some number (typically between 5 and 8) of Newton steps, the merit did not adequately decrease, the algorithm takes a scaled Newton step from either the watchdog state or the last iteration that guarantees a sufficient decrease of the merit, and that step is accepted. Once a step is accepted, the norm of the KKT error is measured, and if it is sufficiently small, the barrier value is decreased. If it is not sufficiently small, the last accepted step is taken to be the new watchdog step, and the process is repeated.</p>
<p>Above, the "maximal feasible step" is a scaling of the Newton step in both the primal and dual variables given by</p>
<p class="formulaDsp">
\[ \beta^\mathbf{y} = \min\{1,\max \beta \text{ such that }\left(\mathbf{z}_{k+i} + \beta^\mathbf{z}_{k+i} \Delta \mathbf{z}_{k+i}\right)_j \geq \zeta \mathbf{z}_{k+i,j} \forall j\} \]
</p>
 <p class="formulaDsp">
\[ \beta^\mathbf{x} = \min\{1,\max \beta \text{ such that }\left(\mathbf{s}_{k+i} + \beta^\mathbf{s}_{k+i} \Delta \mathbf{s}_{k+i}\right)_j \geq \zeta \mathbf{s}_{k+i,j} \forall j\} \]
</p>
<p>Above, \(\zeta\) is the "fraction to boundary" that is allowed on any step. Because the derivatives become ill-conditioned near the boundary, this technique stands in for a <a href="https://en.wikipedia.org/wiki/Trust_region">trust region</a> and is necessary to ensure good approximations in the future. \(\zeta\) is taken to be \(\max\{0.8, 1-\alpha\}\), which allows movement closer to the boundary as the barrier becomes smaller. In the future, when implementing the LOQO algorithm for barrier reduction, this must be kept to 0.8 as the barrier parameter can vary wildly.</p>
<p>Separately, we need to deal with the log-barrier that we have used to enforce the positivity constraint on the slack variables \(s_1,s_2\): In the statement of the final optimization problem we solve, we have added the term </p><p class="formulaDsp">
\[ -\alpha \int_\Omega (\log(s_1) + \log(s_2)) d\Omega. \]
</p>
<p> The question is how we should choose the penalty factor \(\alpha\). As with all penalty methods, we are in reality only interested in the limit as \(\alpha\to 0\), since this is then the problem we really wanted to solve, subject to the positivity constraints on the slack variables. On the other hand, we need to choose \(\alpha\) large enough to make the problem solvable in practice. Actual implementations therefore start with a larger value of \(\alpha\) and gradually decrease it as the outer iterations proceed.</p>
<p>In the monotone method implemented here, the barrier parameter is updated whenever some level of convergence is achieved at the current barrier parameter. We use the \(l_\infty\) norm of the KKT conditions to check for convergence at each barrier size. The requirement is that \(\|KKT\|_{l_\infty} &lt; c \cdot \alpha\) where \(c\) is a constant over any barrier size and \(\alpha\) is the barrier parameter. This forces better convergence in later iterations, and is the same requirement as is used in <a href="https://coin-or.github.io/Ipopt/">IPOPT</a> (an open source software package for large-scale nonlinear optimization).</p>
<p>Here, the barrier is reduced linearly at larger values, and superlinearly at smaller values. At larger values, it is multiplied by a constant (around 0.6), and at lower values the barrier value is replaced by the barrier value raised to some exponent (around 1.2). This method has proven to be effective at keeping the subproblem solvable at large barrier values, while still allowing superlinear convergence at smaller barrier values. In practice, this looks like the following: </p><p class="formulaDsp">
\[ \alpha_{k+1} = \min\{\alpha_k^{1.2},0.6\alpha_k\} \]
</p>
<p>While taking large steps at reducing the barrier size when convergence is reached is widely used, more recent research has shown that it is typically faster to use algorithms that adaptively update barrier each iteration, i.e., methods in which we use concrete criteria at the end of each iteration to determine what the penalty parameter should be in the next iteration, rather than using reduction factors that are independent of the current solution. That said, such methods are also more complicated and we will not do this here.</p>
<p><a class="anchor" id="MeritFunction"></a></p><h3>Merit Function</h3>
<p>The algorithm outlined above makes use of a "merit function". Merit functions are used to determine whether a step from \(x_k\) to a proposed point \(x_{k+1}\) is beneficial. In unconstrained optimization problems, one can simply check this with the objective function we try to minimize, and typically uses conditions such as the <a href="https://en.wikipedia.org/wiki/Wolfe_conditions">Wolfe and Goldstein conditions</a>.</p>
<p>In constrained optimization problems, the question is how to balance reduction in the objective function against a possible increase in the violation of constraints: A proposed step might make the objective function smaller but be further away from the set of points that satisfy the constraints &ndash; or the other way around. This trade-off is typically resolved by using a merit function that combines the two criteria.</p>
<p>Here, we use an exact \(l_1\) merit function to test the steps: </p><p class="formulaDsp">
\begin{align} \phi(\mathbf{x},\mathbf{y}) =&amp; \int_{\partial \Omega} \mathbf{u}\cdot \mathbf{t} d\partial\Omega- \alpha \int_\Omega (\log(s_1) + \log(s_2)) + p \sum_i\left| \int_\Omega y_{2,i}(H(\varrho) - \rho) d\Omega \right| \\ &amp; + p \sum_i\left| \int_{\partial \Omega} \mathbf{y}_{1,i}\cdot \mathbf{t} d\partial\Omega - \int_\Omega \rho^p[\lambda \nabla \cdot \mathbf{u} \nabla \cdot \mathbf{y}_{1,i} + \mu \boldsymbol{\varepsilon}{\mathbf{u}}\boldsymbol{\varepsilon}{\mathbf{y}_{1,i}}] d\Omega \right| + p \sum_i\left| \int_\Omega z_{1,i}(s_1 - \varrho) d\Omega\right| + p \sum_i\left| \int_\Omega z_{2,i}(1-\varrho - s_2) d\Omega\right| \end{align}
</p>
<p>Here, \(p\) is a penalty parameter. This merit function being exact means that there exists some \(p_0\) so that for any \(p &gt; p_0\), the merit function has its minima at the same location as the original problem. This penalty parameter is updated (by recommendation of Nocedal and Wright <b>[Benson2002]</b>) as follows: </p><p class="formulaDsp">
\[ p &gt; \frac{\frac{1}{2} \mathbf{x}^T \cdot \mathbf{H} \cdot \mathbf{x} - \mathbf{x}^T \cdot \nabla f}{\|c_i\|_{l_\infty}} \quad , i \in \mathcal{E}, \]
</p>
<p> where \(\mathbf{H}\) is the Hessian of the objective function, \(\mathbf{x}\) is a vector of our decision (primal) variables, \(f\) is the objective function, and \(c_i\) is the error on a current equality constraint.</p>
<p>Our use of this method is partially due to already having most of the necessary parts calculated in finding the right hand side, but also the use of an exact merit function ensures that it is minimized in the same location as the overall problem. Recent research has shown that one can replace merit functions by what are called "filter methods", and one should consider using these instead as they prove to be more efficient.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Preliminaries"></a> </p><h3>Preliminaries</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2tensor_8h.html">deal.II/base/tensor.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2signaling__nan_8h.html">deal.II/base/signaling_nan.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparse__matrix_8h.html">deal.II/lac/block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2linear__operator_8h.html">deal.II/lac/linear_operator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2packaged__operation_8h.html">deal.II/lac/packaged_operation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgq_8h.html">deal.II/fe/fe_dgq.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
</div><!-- fragment --><p>Above are fairly common files to include. These also include the one for the sparse direct class <a class="el" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a>. This is not the most efficient way to solve large linear problems, but it will do for now.</p>
<p>As usual, we put everything into a common namespace. We then start by declaring a number of symbolic names for constants that will be used throughout this tutorial. Specifically, we have a <em>lot</em> of variables in this program (of course the density and the displacement, but also the unfiltered density and quite a number of Lagrange multipliers). It is easy to forget which of these variables is at which position in the solution vector, and trying to use numbers for these vector components is a prescription for bugs. Rather, we define static variables that can be used in all of these places and that have to be initialized only once. In practice, this will lead to some lengthy expressions, but they are more readable and less likely to be wrong.</p>
<p>A similar issue arises with the ordering of blocks in the system matrix and in vectors. The matrices have \(9\times 9\) blocks, and it's difficult to remember which is which. It is far easier to just use symbolic names for those as well.</p>
<p>Finally, while we're at it, we introduce symbolic names also for the boundary indicators we will use, in the same spirit as was done in <a class="el" href="step_19.html">step-19</a>.</p>
<p>In all of these cases, we declare these variables as members in a namespace. In the case of the solution components, the concrete values of these variables depend on the space dimension, so we use <a href="https://en.cppreference.com/w/cpp/language/variable_template">template variables</a> to make the value of the variable depend on a template argument in the same way as we often use template functions.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceSAND.html">SAND</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p>This namespace keeps track of the first component in our finite element system that corresponds to each variable.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>SolutionComponents</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a> = 0;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">displacement</a> = 1;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a> = 1 + <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">displacement_multiplier</a> = 2 + <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a> = 2 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a> = 3 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a> = 4 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a> = 5 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a> = 6 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">} <span class="comment">// namespace SolutionComponents</span></div>
</div><!-- fragment --><p>This is the namespace which keeps track of which block corresponds to which variable.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>SolutionBlocks</div>
<div class="line">{</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>                        = 0;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">displacement</a>                   = 1;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a>             = 2;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">displacement_multiplier</a>        = 3;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a>  = 4;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a>            = 5;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a> = 6;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a>            = 7;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a> = 8;</div>
<div class="line">} <span class="comment">// namespace SolutionBlocks</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>BoundaryIds</div>
<div class="line">{</div>
<div class="line">  constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">down_force</a> = 101;</div>
<div class="line">  constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">no_force</a>   = 102;</div>
<div class="line">} <span class="comment">// namespace BoundaryIds</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>ValueExtractors</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ac221049fbb9ba83a17d1078474c4a747">densities</a>(SolutionComponents::density&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a8cd7076dfb3722290a423c54fc25f28d">displacements</a>(SolutionComponents::displacement&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ae502a219c72947e0c0abc6bc5d318a11">unfiltered_densities</a>(SolutionComponents::unfiltered_density&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a75b37471806be11bfd15238908ef2570">displacement_multipliers</a>(</div>
<div class="line">    SolutionComponents::displacement_multiplier&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a07e1e8cad70f4d40499893eb4e603205">unfiltered_density_multipliers</a>(</div>
<div class="line">    SolutionComponents::unfiltered_density_multiplier&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a149b969d62b110112ced6d4a4a467494">density_lower_slacks</a>(SolutionComponents::density_lower_slack&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ada143f177c93011d19b9753f7af32d57">density_lower_slack_multipliers</a>(</div>
<div class="line">    SolutionComponents::density_lower_slack_multiplier&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a30f363fe7c63c168353b72e3a2dd28c4">density_upper_slacks</a>(SolutionComponents::density_upper_slack&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#af74f3b334f9c0a375c5b7afd07335505">density_upper_slack_multipliers</a>(</div>
<div class="line">    SolutionComponents::density_upper_slack_multiplier&lt;dim&gt;);</div>
<div class="line">} <span class="comment">// namespace ValueExtractors</span></div>
</div><!-- fragment --><p><a class="anchor" id="TheSANDTopOptmainclass"></a> </p><h3>The SANDTopOpt main class</h3>
<p>Next up is the main class for this problem. The majority of functions follow the usual naming schemes of tutorial programs, though there are a couple that have been broken out of what is usually called the <code>setup_system()</code> function because of their length, and there are also a number that deal with various aspects of the optimization algorithm.</p>
<p>As an added bonus, the program writes the computed design as an STL file that one can, for example, send to a 3d printer.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>SANDTopOpt</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SANDTopOpt();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">create_triangulation</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> setup_boundary_values();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> setup_block_system();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> setup_filter_matrix();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">  std::pair&lt;double, double&gt;</div>
<div class="line">  calculate_max_step_size(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                          <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a></div>
<div class="line">  calculate_test_rhs(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> calculate_exact_merit(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> find_max_step();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> compute_scaled_step(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                                          <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>,</div>
<div class="line">                                          <span class="keyword">const</span> <span class="keywordtype">double</span> descent_requirement);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> check_convergence(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> write_as_stl();</div>
<div class="line"> </div>
<div class="line">  std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt;</div>
<div class="line">  find_relevant_neighbors(</div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) <span class="keyword">const</span>;</div>
</div><!-- fragment --><p>Most of the member variables are also standard. There are, however, a number of variables that are specifically related to the optimization algorithm (such the various scalar factors below) as well as the filter matrix to ensure that the design remains smooth.</p>
<div class="fragment"><div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">  std::map&lt;types::global_dof_index, double&gt; boundary_values;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line">  <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      filter_sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> filter_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> system_rhs;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> nonlinear_solution;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> density_ratio;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> density_penalty_exponent;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> filter_r;</div>
<div class="line">  <span class="keywordtype">double</span>       penalty_multiplier;</div>
<div class="line">  <span class="keywordtype">double</span>       barrier_size;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTimerOutput.html">TimerOutput</a> timer;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="Constructorandsetupfunctions"></a> </p><h3>Constructor and set-up functions</h3>
<p>We initialize a <a class="el" href="classFESystem.html">FESystem</a> composed of 2 \(\times\)dim <code><a class="el" href="classFE__Q.html">FE_Q(1)</a></code> elements for the displacement variable and its Lagrange multiplier, and 7 <code><a class="el" href="classFE__DGQ.html">FE_DGQ(0)</a></code> elements. These piecewise constant functions are for density-related variables: the density itself, the unfiltered density, the slack variables for the lower and upper bounds on the unfiltered density, and then Lagrange multipliers for the connection between filtered and unfiltered densities as well as for the inequality constraints.</p>
<p>The order in which these elements appear is documented above.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">SANDTopOpt&lt;dim&gt;::SANDTopOpt()</div>
<div class="line">  : <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(<a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">       1,</div>
<div class="line">       (<a class="code" href="classFESystem.html">FESystem</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1) ^ <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)),</div>
<div class="line">       1,</div>
<div class="line">       <a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">       1,</div>
<div class="line">       (<a class="code" href="classFESystem.html">FESystem</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1) ^ <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)),</div>
<div class="line">       1,</div>
<div class="line">       <a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">       5)</div>
<div class="line">  , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  , density_ratio(.5)</div>
<div class="line">  , density_penalty_exponent(3)</div>
<div class="line">  , filter_r(.251)</div>
<div class="line">  , penalty_multiplier(1)</div>
<div class="line">  , timer(std::cout, <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary, <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> &gt; 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">}</div>
</div><!-- fragment --><p>The first step then is to create the triangulation that matches the problem description in the introduction &ndash; a 6-by-1 rectangle (or a 6-by-1-by-1 box in 3d) where a force will be applied in the top center. This triangulation is then uniformly refined a number of times.</p>
<p>In contrast to nearly the entire rest of this program, this function specifically assumes that we are in 2d and will require changes if we wanted to move to 3d simulations. We ensure that nobody tries to accidentally run in 3d without such modifications through an assertion at the top of the function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">SANDTopOpt&lt;dim&gt;::create_triangulation</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                            {6, 1},</div>
<div class="line">                                            <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 0),</div>
<div class="line">                                            <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(6, 1));</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(3);</div>
</div><!-- fragment --><p>The second step is to apply boundary indicators to parts of the boundary. The following code assigns boundary indicators to the bottom, top, left, and right boundaries of the box, respectively. The center region of the top boundary is given a separate boundary indicator: This is where we will apply the down force.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a> = <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center();</div>
<div class="line">              <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(1) - 1) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                {</div>
<div class="line">                  <span class="keywordflow">if</span> ((<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(0) - 3) &lt; .3))</div>
<div class="line">                    <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>);</div>
<div class="line">                  <span class="keywordflow">else</span></div>
<div class="line">                    <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">BoundaryIds::no_force</a>);</div>
<div class="line">                }</div>
<div class="line">              <span class="keywordflow">else</span></div>
<div class="line">                <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">BoundaryIds::no_force</a>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Next, determine the constraints due to boundary values. The bottom corners of the domain are kept in place in the \(y\) direction &ndash; the bottom left also in the \(x\) direction. deal.II generally thinks of boundary values as attached to pieces of the boundary, i.e., faces, rather than individual vertices. Indeed, mathematically speaking, one can not assign boundary values to individual points for the infinite-dimensional partial differential equation. But, since we are trying to reproduce a widely used benchmark, we will do so anyway and keep in mind that we have a finite-dimensional problem for which imposing boundary conditions at a single node is valid.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_boundary_values()</div>
<div class="line">{</div>
<div class="line">  boundary_values.clear();</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a> = <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center();</div>
</div><!-- fragment --><p>Check whether the current face is on the bottom boundary, and if it is whether one of its vertices might be the bottom left or bottom right vertex:</p>
<div class="fragment"><div class="line">              <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                {</div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> vertex_number : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_indices())</div>
<div class="line">                    {</div>
<div class="line">                      <span class="keyword">const</span> <span class="keyword">auto</span> vert = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(vertex_number);</div>
<div class="line"> </div>
<div class="line">                      <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(0) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 &amp;&amp;</div>
<div class="line">                          <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                        {</div>
<div class="line">                          <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> x_displacement =</div>
<div class="line">                            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 0);</div>
<div class="line">                          <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement =</div>
<div class="line">                            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 1);</div>
<div class="line">                          <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> x_displacement_multiplier =</div>
<div class="line">                            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 2);</div>
<div class="line">                          <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement_multiplier =</div>
<div class="line">                            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 3);</div>
<div class="line"> </div>
<div class="line">                          boundary_values[x_displacement]            = 0;</div>
<div class="line">                          boundary_values[y_displacement]            = 0;</div>
<div class="line">                          boundary_values[x_displacement_multiplier] = 0;</div>
<div class="line">                          boundary_values[y_displacement_multiplier] = 0;</div>
<div class="line">                        }</div>
<div class="line"> </div>
<div class="line">                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(0) - 6) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 &amp;&amp;</div>
<div class="line">                               <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                        {</div>
<div class="line">                          <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement =</div>
<div class="line">                            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 1);</div>
<div class="line">                          <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement_multiplier =</div>
<div class="line">                            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 3);</div>
<div class="line"> </div>
<div class="line">                          boundary_values[y_displacement]            = 0;</div>
<div class="line">                          boundary_values[y_displacement_multiplier] = 0;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Settingupblockmatricesandvectors"></a> </p><h3>Setting up block matrices and vectors</h3>
<p>The next function makes a giant 9-by-9 block matrix, and also sets up the necessary block vectors. The sparsity pattern for this matrix includes the sparsity pattern for the filter matrix. It also initializes any block vectors we will use.</p>
<p>Setting up the blocks by themselves is not overly complicated and follows what is already done in programs such as <a class="el" href="step_22.html">step-22</a>, for example.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_block_system()</div>
<div class="line">{</div>
<div class="line">  std::vector&lt;unsigned int&gt; block_component(9, 2);</div>
<div class="line">  block_component[0] = 0;</div>
<div class="line">  block_component[1] = 1;</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a>                     n_p = dofs_per_block[0];</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a>                     n_u = dofs_per_block[1];</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebra_1_1CUDAWrappers_1_1kernel.html#aa63f11d31d19bd16be69280eac69dd10">std::vector&lt;BlockVector&lt;double&gt;::size_type</a>&gt; block_sizes = {</div>
<div class="line">    n_p, n_u, n_p, n_u, n_p, n_p, n_p, n_p, n_p};</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(9, 9);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; 9; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; 9; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">      dsp.block(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(block_sizes[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>], block_sizes[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]);</div>
<div class="line">  dsp.collect_sizes();</div>
</div><!-- fragment --><p>The bulk of the function is in setting up which of these blocks will actually contain anything, i.e., which variables couple with which other variables. This is cumbersome but necessary to ensure that we don't just allocate a very large number of entries for our matrix that will then end up being zero.</p>
<p>The concrete pattern you see below is something one probably has to draw once on a piece of paper, but follows in an otherwise relatively straightforward way from looking through the many terms of the bilinear form we will have to assemble in each nonlinear iteration.</p>
<p>The use of the symbolic names defined in namespace <code>SolutionComponents</code> helps understand what each of the following terms corresponds to, but it also makes the expressions lengthy and unwieldy: A term such as <code>coupling[SolutionComponents::density_upper_slack_multiplier&lt;dim&gt;][SolutionComponents::density&lt;dim&gt;]</code> just doesn't read very well, and would either have to be split over several lines or run off the right edge of nearly every screen. As a consequence, we open a curly-brace enclosed code block in which we temporarily make the names in namespace <code>SolutionComponents</code> available without the namespace qualifier, by saying <code>using namespace SolutionComponents</code>.</p>
<div class="fragment"><div class="line"><a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 7, 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 7);</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span>SolutionComponents;</div>
<div class="line"> </div>
<div class="line">  coupling[density&lt;dim&gt;][density&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      coupling[density&lt;dim&gt;][displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][density&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      coupling[density&lt;dim&gt;][displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][density&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  coupling[density&lt;dim&gt;][unfiltered_density_multiplier&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[unfiltered_density_multiplier&lt;dim&gt;][density&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Coupling for displacement */</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">        {</div>
<div class="line">          coupling[displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">                  [displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          coupling[displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]</div>
<div class="line">                  [displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Coupling for slack variables */</span></div>
<div class="line">  coupling[density_lower_slack&lt;dim&gt;][density_lower_slack&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[density_lower_slack&lt;dim&gt;][density_upper_slack&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[density_upper_slack&lt;dim&gt;][density_lower_slack&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">  coupling[density_lower_slack_multiplier&lt;dim&gt;]</div>
<div class="line">          [density_lower_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[density_lower_slack_multiplier&lt;dim&gt;]</div>
<div class="line">          [density_upper_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[density_upper_slack_multiplier&lt;dim&gt;]</div>
<div class="line">          [density_lower_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Before we can create the sparsity pattern, we also have to set up constraints. Since this program does not adaptively refine the mesh, the only constraint we have is one that couples all density variables to enforce the volume constraint. This will ultimately lead to a dense sub-block of the matrix, but there is little we can do about that.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classComponentMask.html">ComponentMask</a> density_mask =</div>
<div class="line">  <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(ValueExtractors::densities&lt;dim&gt;);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> density_dofs =</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#a45f4d01f1c4c6337e4be6f10a81fbdab">DoFTools::extract_dofs</a>(dof_handler, density_mask);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> last_density_dof =</div>
<div class="line">  density_dofs.<a class="code" href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">nth_index_in_set</a>(density_dofs.<a class="code" href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">n_elements</a>() - 1);</div>
<div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">add_line</a>(last_density_dof);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; density_dofs.<a class="code" href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">n_elements</a>() - 1; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a2b7756e9cb8e53553211add5426f8e50">add_entry</a>(last_density_dof,</div>
<div class="line">                        density_dofs.<a class="code" href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">nth_index_in_set</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>),</div>
<div class="line">                        -1);</div>
<div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">set_inhomogeneity</a>(last_density_dof, 0);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
</div><!-- fragment --><p>We can now finally create the sparsity pattern for the matrix, taking into account which variables couple with which other variables, and the constraints we have on the density.</p>
<div class="fragment"><div class="line"><a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, coupling, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
</div><!-- fragment --><p>The only part of the matrix we have not dealt with is the filter matrix and its transpose. These are non-local (integral) operators for which deal.II does not currently have functions. What we will ultimately need to do is go over all cells and couple the unfiltered density on this cell to all filtered densities of neighboring cells that are less than a threshold distance away, and the other way around; for the moment, we are only concerned with building the sparsity pattern that would correspond to this kind of matrix, so we perform the equivalent loop and where later on we would write into an entry of the matrix, we now simply add an entry to the sparsity matrix:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell : find_relevant_neighbors(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(check_cell-&gt;center());</div>
<div class="line">        <span class="keywordflow">if</span> (distance &lt; filter_r)</div>
<div class="line">          {</div>
<div class="line">            dsp</div>
<div class="line">              .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                     <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)</div>
<div class="line">              .<a class="code" href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">add</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, check_cell-&gt;active_cell_index());</div>
<div class="line">            dsp</div>
<div class="line">              .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">                     <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)</div>
<div class="line">              .<a class="code" href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">add</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, check_cell-&gt;active_cell_index());</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Having so generated the "dynamic" sparsity pattern, we can finally copy it to the structure that is used to associate matrices with a sparsity pattern. Because the sparsity pattern is large and complex, we also output it into a file of its own for visualization purposes &ndash; in other words, for "visual debugging".</p>
<div class="fragment"><div class="line"><a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">std::ofstream <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>(<span class="stringliteral">&quot;sparsity.plt&quot;</span>);</div>
<div class="line"><a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.print_gnuplot(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>);</div>
<div class="line"> </div>
<div class="line">system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
</div><!-- fragment --><p>What is left is to correctly size the various vectors and their blocks, as well as setting initial guesses for some of the components of the (nonlinear) solution vector. We here use the symbolic component names for individual blocks of the solution vector and, for brevity, use the same trick with <code>using namespace</code> as above:</p>
<div class="fragment"><div class="line">  nonlinear_solution.reinit(block_sizes);</div>
<div class="line">  system_rhs.reinit(block_sizes);</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">using namespace </span>SolutionBlocks;</div>
<div class="line">    nonlinear_solution.block(<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>).add(density_ratio);</div>
<div class="line">    nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a>).add(density_ratio);</div>
<div class="line">    nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a>)</div>
<div class="line">      .add(density_ratio);</div>
<div class="line">    nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a>).add(density_ratio);</div>
<div class="line">    nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a>).add(50);</div>
<div class="line">    nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a>).add(1 - density_ratio);</div>
<div class="line">    nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a>).add(50);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Creatingthefiltermatrix"></a> </p><h3>Creating the filter matrix</h3>
<p>Next up, a function that is used once at the beginning of the program: It creates a matrix \(H\) so that the filtered density vector equals \(H\) times the unfiltered density. The creation of this matrix is non-trivial, and it is used in every iteration, and so rather than reforming it as we do with the Newton matrix, it is made only once and stored separately.</p>
<p>The way this matrix is computed follows the outline used above already to form its sparsity pattern. We repeat this process here for the sparsity pattern of this separately formed matrix, and then actually build the matrix itself. You may want to check the definition of this matrix in the introduction to this program.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_filter_matrix()</div>
<div class="line">{</div>
</div><!-- fragment --><p>The sparsity pattern of the filter has already been determined and implemented in the setup_system() function. We copy the structure from the appropriate block and use it again here.</p>
<div class="fragment"><div class="line">filter_sparsity_pattern.copy_from(</div>
<div class="line">  <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                         <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line">filter_matrix.reinit(filter_sparsity_pattern);</div>
</div><!-- fragment --><p>Having so built the sparsity pattern, now we re-do all of these loops to actually compute the necessary values of the matrix entries:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell : find_relevant_neighbors(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(check_cell-&gt;center());</div>
<div class="line">        <span class="keywordflow">if</span> (distance &lt; filter_r)</div>
<div class="line">          {</div>
<div class="line">            filter_matrix.add(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                              check_cell-&gt;active_cell_index(),</div>
<div class="line">                              filter_r - distance);</div>
<div class="line">            </div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
</div><!-- fragment --><p>The final step is to normalize the matrix so that for each row, the sum of entries equals one.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; filter_matrix.m(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> denominator = 0;</div>
<div class="line">      <span class="keywordflow">for</span> (<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;::iterator</a> iter = filter_matrix.<a class="code" href="classSparseMatrix.html#a419e25c734b10802f9c7f59d652f84ca">begin</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter++)</div>
<div class="line">        denominator = denominator + iter-&gt;value();</div>
<div class="line">      <span class="keywordflow">for</span> (<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;::iterator</a> iter = filter_matrix.<a class="code" href="classSparseMatrix.html#a419e25c734b10802f9c7f59d652f84ca">begin</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter++)</div>
<div class="line">        iter-&gt;value() = iter-&gt;value() / denominator;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>This function is used for building the filter matrix. We create a set of all the cell iterators within a certain radius of the cell that is input. These are the neighboring cells that will be relevant for the filter.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt;</div>
<div class="line">SANDTopOpt&lt;dim&gt;::find_relevant_neighbors(</div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::set&lt;unsigned int&gt;                               neighbor_ids;</div>
<div class="line">  std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt; cells_to_check;</div>
<div class="line"> </div>
<div class="line">  neighbor_ids.insert(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index());</div>
<div class="line">  cells_to_check.insert(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> new_neighbors_found;</div>
<div class="line">  <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">      new_neighbors_found = <span class="keyword">false</span>;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell :</div>
<div class="line">           <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a>&gt;(</div>
<div class="line">             cells_to_check.begin(), cells_to_check.end()))</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a> : check_cell-&gt;face_indices())</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">if</span> (!(check_cell-&gt;face(<a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a>)-&gt;at_boundary()))</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <span class="keyword">auto</span> &amp; <a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a> = check_cell-&gt;neighbor(<a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a>);</div>
<div class="line">                  <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">                    <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;center());</div>
<div class="line">                  <span class="keywordflow">if</span> ((distance &lt; filter_r) &amp;&amp;</div>
<div class="line">                      !(neighbor_ids.count(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;active_cell_index())))</div>
<div class="line">                    {</div>
<div class="line">                      cells_to_check.insert(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>);</div>
<div class="line">                      neighbor_ids.insert(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;active_cell_index());</div>
<div class="line">                      new_neighbors_found = <span class="keyword">true</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">while</span> (new_neighbors_found);</div>
<div class="line">  <span class="keywordflow">return</span> cells_to_check;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="AssemblingtheNewtonmatrix"></a> </p><h3>Assembling the Newton matrix</h3>
<p>Whereas the setup_filter_matrix function built a matrix that is the same as long as the mesh does not change (which we don't do anyway in this program), the next function builds the matrix to be solved in each iteration. This is where the magic happens. The components of the system of linear equations describing Newton's method for finding the solution of the KKT conditions are implemented here.</p>
<p>The top of the function is as in most of these functions and just sets up all sorts of variables necessary for the actual assembly, including a whole bunch of extractors. The entire set up should look familiar, though somewhat lengthier, if you've previously looked at <a class="el" href="step_22.html">step-22</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::assemble_system()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  system_matrix = 0;</div>
<div class="line">  system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a> <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>          quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt;      face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>        fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>    fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                   <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                   face_quadrature_formula,</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     dummy_cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt;                    lambda_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt;                    mu_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(1.);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="namespacemu.html">mu</a>(1.);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt;            rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
</div><!-- fragment --><p>At this point, we apply the filter to the unfiltered density, and apply the adjoint (transpose) operation to the unfiltered density multiplier, both to the current best guess for the nonlinear solution. We use this later to tell us how far off our filtered density is from the filter applied to the unfiltered density. That is because while at the solution of the nonlinear problem, we have \(\rho=H\varrho\), but at intermediate iterations, we in general have \(\rho^k\neq H\varrho^k\) and the "residual" \(\rho^k-H\varrho^k\) will then appear as the right hand side of one of the Newton update equations that we compute below.</p>
<div class="fragment"><div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filtered_unfiltered_density_solution =</div>
<div class="line">  nonlinear_solution;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filter_adjoint_unfiltered_density_multiplier_solution =</div>
<div class="line">  nonlinear_solution;</div>
<div class="line"> </div>
<div class="line">filter_matrix.vmult(filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>),</div>
<div class="line">                    nonlinear_solution.block(</div>
<div class="line">                      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>));</div>
<div class="line">filter_matrix.Tvmult(</div>
<div class="line">  filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">    <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>),</div>
<div class="line">  nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::vector&lt;double&gt;                  old_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt;          old_displacement_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;                  old_displacement_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_symmgrads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_displacement_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_displacement_multiplier_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_multiplier_symmgrads(</div>
<div class="line">  <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_lower_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_upper_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_lower_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_upper_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_unfiltered_density_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; filtered_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; filter_adjoint_unfiltered_density_multiplier_values(</div>
<div class="line">  <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>ValueExtractors;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.value_list(fe_values.get_quadrature_points(), lambda_values);</div>
<div class="line">    <a class="code" href="namespacemu.html">mu</a>.value_list(fe_values.get_quadrature_points(), mu_values);</div>
</div><!-- fragment --><p>As part of the construction of our system matrix, we need to retrieve values from our current guess at the solution. The following lines of code retrieve the needed values.</p>
<div class="fragment"><div class="line">fe_values[densities&lt;dim&gt;].get_function_values(nonlinear_solution,</div>
<div class="line">                                              old_density_values);</div>
<div class="line">fe_values[displacements&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_displacement_values);</div>
<div class="line">fe_values[displacements&lt;dim&gt;].get_function_divergences(</div>
<div class="line">  nonlinear_solution, old_displacement_divs);</div>
<div class="line">fe_values[displacements&lt;dim&gt;].get_function_symmetric_gradients(</div>
<div class="line">  nonlinear_solution, old_displacement_symmgrads);</div>
<div class="line">fe_values[displacement_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_displacement_multiplier_values);</div>
<div class="line">fe_values[displacement_multipliers&lt;dim&gt;].get_function_divergences(</div>
<div class="line">  nonlinear_solution, old_displacement_multiplier_divs);</div>
<div class="line">fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">  .get_function_symmetric_gradients(</div>
<div class="line">    nonlinear_solution, old_displacement_multiplier_symmgrads);</div>
<div class="line">fe_values[density_lower_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_lower_slack_values);</div>
<div class="line">fe_values[density_lower_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_lower_slack_multiplier_values);</div>
<div class="line">fe_values[density_upper_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_upper_slack_values);</div>
<div class="line">fe_values[density_upper_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_upper_slack_multiplier_values);</div>
<div class="line">fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_unfiltered_density_values);</div>
<div class="line">fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_unfiltered_density_multiplier_values);</div>
<div class="line">fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">  filtered_unfiltered_density_solution,</div>
<div class="line">  filtered_unfiltered_density_values);</div>
<div class="line">fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  filter_adjoint_unfiltered_density_multiplier_solution,</div>
<div class="line">  filter_adjoint_unfiltered_density_multiplier_values);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">  {</div>
</div><!-- fragment --><p>We need several more values corresponding to the test functions coming from the first derivatives taken from the Lagrangian, that is the \(d_{\bullet}\) functions. These are calculated here:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_i_symmgrad =</div>
<div class="line">      fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_i_div =</div>
<div class="line">      fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">      displacement_multiplier_phi_i_symmgrad =</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].symmetric_gradient(</div>
<div class="line">          <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_i_div =</div>
<div class="line">      fe_values[displacement_multipliers&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                          q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_i =</div>
<div class="line">      fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_i =</div>
<div class="line">      fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_i =</div>
<div class="line">      fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                           q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_i =</div>
<div class="line">      fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">        <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_i =</div>
<div class="line">      fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_i =</div>
<div class="line">      fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_i =</div>
<div class="line">      fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">        <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> : fe_values.dof_indices())</div>
<div class="line">      {</div>
</div><!-- fragment --><p>Finally, we need values that come from the second round of derivatives taken from the Lagrangian, the \(c_{\bullet}\) functions. These are calculated here:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_j_symmgrad =</div>
<div class="line">  fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>,</div>
<div class="line">                                                   q_point);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_j_div =</div>
<div class="line">  fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">  displacement_multiplier_phi_j_symmgrad =</div>
<div class="line">    fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">      .symmetric_gradient(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_j_div =</div>
<div class="line">  fe_values[displacement_multipliers&lt;dim&gt;].divergence(</div>
<div class="line">    <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_j =</div>
<div class="line">  fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_j =</div>
<div class="line">  fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_j =</div>
<div class="line">  fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(</div>
<div class="line">    <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_j =</div>
<div class="line">  fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_j =</div>
<div class="line">  fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_j =</div>
<div class="line">  fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">    <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_j =</div>
<div class="line">  fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">    <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
</div><!-- fragment --><p>This is where the actual work starts. In the following, we will build all of the terms of the matrix &ndash; they are numerous and not entirely self-explanatory, also depending on the previous solutions and its derivatives (which we have already evaluated above and put into the variables called <code>old_*</code>). To understand what each of these terms corresponds to, you will want to look at the explicit form of these terms in the introduction above.</p>
<p>The right hand sides of the equations being driven to 0 give all the KKT conditions for finding a local minimum &ndash; the descriptions of what each individual equation are given with the computations of the right hand side.</p>
<div class="fragment"><div class="line">          <span class="comment">/* Equation 1 */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            fe_values.JxW(q_point) *</div>
<div class="line">            (</div>
<div class="line"> </div>
<div class="line">              -density_phi_i * unfiltered_density_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line">              + density_penalty_exponent *</div>
<div class="line">                  (density_penalty_exponent - 1) *</div>
<div class="line">                  std::pow(old_density_values[q_point],</div>
<div class="line">                           density_penalty_exponent - 2) *</div>
<div class="line">                  density_phi_i * density_phi_j *</div>
<div class="line">                  (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                     old_displacement_divs[q_point] *</div>
<div class="line">                     lambda_values[q_point] +</div>
<div class="line">                   2 * mu_values[q_point] *</div>
<div class="line">                     (old_displacement_symmgrads[q_point] *</div>
<div class="line">                      old_displacement_multiplier_symmgrads[q_point]))</div>
<div class="line"> </div>
<div class="line">              + density_penalty_exponent *</div>
<div class="line">                  <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                           density_penalty_exponent - 1) *</div>
<div class="line">                  density_phi_i *</div>
<div class="line">                  (displacement_multiplier_phi_j_div *</div>
<div class="line">                     old_displacement_divs[q_point] *</div>
<div class="line">                     lambda_values[q_point] +</div>
<div class="line">                   2 * mu_values[q_point] *</div>
<div class="line">                     (old_displacement_symmgrads[q_point] *</div>
<div class="line">                      displacement_multiplier_phi_j_symmgrad))</div>
<div class="line"> </div>
<div class="line">              + density_penalty_exponent *</div>
<div class="line">                  <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                           density_penalty_exponent - 1) *</div>
<div class="line">                  density_phi_i *</div>
<div class="line">                  (displacement_phi_j_div *</div>
<div class="line">                     old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                     lambda_values[q_point] +</div>
<div class="line">                   2 * mu_values[q_point] *</div>
<div class="line">                     (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                      displacement_phi_j_symmgrad)));</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* Equation 2 */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            fe_values.JxW(q_point) *</div>
<div class="line">            (density_penalty_exponent *</div>
<div class="line">               <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                        density_penalty_exponent - 1) *</div>
<div class="line">               density_phi_j *</div>
<div class="line">               (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                  displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                2 * mu_values[q_point] *</div>
<div class="line">                  (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                   displacement_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">             + <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                        density_penalty_exponent) *</div>
<div class="line">                 (displacement_multiplier_phi_j_div *</div>
<div class="line">                    displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                  2 * mu_values[q_point] *</div>
<div class="line">                    (displacement_multiplier_phi_j_symmgrad *</div>
<div class="line">                     displacement_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">            );</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* Equation 3, which has to do with the filter and which is</span></div>
<div class="line"><span class="comment">           * calculated elsewhere. */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            fe_values.JxW(q_point) *</div>
<div class="line">            (-1 * unfiltered_density_phi_i *</div>
<div class="line">               lower_slack_multiplier_phi_j +</div>
<div class="line">             unfiltered_density_phi_i * upper_slack_multiplier_phi_j);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* Equation 4: Primal feasibility */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            fe_values.JxW(q_point) *</div>
<div class="line">            (</div>
<div class="line"> </div>
<div class="line">              density_penalty_exponent *</div>
<div class="line">                <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                         density_penalty_exponent - 1) *</div>
<div class="line">                density_phi_j *</div>
<div class="line">                (old_displacement_divs[q_point] *</div>
<div class="line">                   displacement_multiplier_phi_i_div *</div>
<div class="line">                   lambda_values[q_point] +</div>
<div class="line">                 2 * mu_values[q_point] *</div>
<div class="line">                   (old_displacement_symmgrads[q_point] *</div>
<div class="line">                    displacement_multiplier_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">              + <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                         density_penalty_exponent) *</div>
<div class="line">                  (displacement_phi_j_div *</div>
<div class="line">                     displacement_multiplier_phi_i_div *</div>
<div class="line">                     lambda_values[q_point] +</div>
<div class="line">                   2 * mu_values[q_point] *</div>
<div class="line">                     (displacement_phi_j_symmgrad *</div>
<div class="line">                      displacement_multiplier_phi_i_symmgrad)));</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* Equation 5: Primal feasibility */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            -1 * fe_values.JxW(q_point) *</div>
<div class="line">            lower_slack_multiplier_phi_i *</div>
<div class="line">            (unfiltered_density_phi_j - lower_slack_phi_j);</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* Equation 6: Primal feasibility */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            -1 * fe_values.JxW(q_point) *</div>
<div class="line">            upper_slack_multiplier_phi_i *</div>
<div class="line">            (-1 * unfiltered_density_phi_j - upper_slack_phi_j);</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* Equation 7: Primal feasibility - the part with the filter</span></div>
<div class="line"><span class="comment">           * is added later */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) += -1 * fe_values.JxW(q_point) *</div>
<div class="line">                               unfiltered_density_multiplier_phi_i *</div>
<div class="line">                               (density_phi_j);</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* Equation 8: Complementary slackness */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            fe_values.JxW(q_point) *</div>
<div class="line">            (lower_slack_phi_i * lower_slack_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line">             + lower_slack_phi_i * lower_slack_phi_j *</div>
<div class="line">                 old_lower_slack_multiplier_values[q_point] /</div>
<div class="line">                 old_lower_slack_values[q_point]);</div>
<div class="line"> </div>
<div class="line">          <span class="comment">/* Equation 9: Complementary slackness */</span></div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            fe_values.JxW(q_point) *</div>
<div class="line">            (upper_slack_phi_i * upper_slack_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">             + upper_slack_phi_i * upper_slack_phi_j *</div>
<div class="line">                 old_upper_slack_multiplier_values[q_point] /</div>
<div class="line">                 old_upper_slack_values[q_point]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now that we have everything assembled, all we have to do is deal with the effect of (Dirichlet) boundary conditions and other constraints. We incorporate the former locally with just the contributions from the current cell, and then let the AffineConstraint class deal with the latter while copying contributions from the current cell into the global linear system:</p>
<div class="fragment"><div class="line">  <a class="code" href="namespaceMatrixTools.html#afe66f38c3a4f4e46dd8389b62209b891">MatrixTools::local_apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                           <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                           <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                           dummy_cell_rhs,</div>
<div class="line">                                           <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                         <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                         system_matrix);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Having accumulated all of the terms that belong into the Newton matrix, we now also have to compute the terms for the right hand side (i.e., the negative residual). We already do this in another function, and so we call that here:</p>
<div class="fragment"><div class="line">system_rhs = calculate_test_rhs(nonlinear_solution);</div>
</div><!-- fragment --><p>Here we use the filter matrix we have already constructed. We only need to integrate this filter applied to test functions, which are piecewise constant, and so the integration becomes a simple multiplication by the measure of the cell. Iterating over the pre-made filter matrix allows us to use the information about which cells are in or out of the filter without repeatedly checking neighbor cells again.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;::iterator</a> iter =</div>
<div class="line">             filter_matrix.<a class="code" href="classSparseMatrix.html#a419e25c734b10802f9c7f59d652f84ca">begin</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           ++iter)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>     = iter-&gt;column();</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span>       <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a> = iter-&gt;<a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>() * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure();</div>
<div class="line"> </div>
<div class="line">          system_matrix</div>
<div class="line">            .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">                   <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)</div>
<div class="line">            .add(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>);</div>
<div class="line">          system_matrix</div>
<div class="line">            .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                   <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)</div>
<div class="line">            .add(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="SolvingtheNewtonlinearsystem"></a> </p><h3>Solving the Newton linear system</h3>
<p>We will need to solve a linear system in each iteration. We use a direct solver, for now &ndash; this is clearly not an efficient choice for a matrix that has so many non-zeroes, and it will not scale to anything interesting. For "real" applications, we will need an iterative solver but the complexity of the system means that an iterative solver algorithm will take a good deal of work. Because this is not the focus of the current program, we simply stick with the direct solver we have here &ndash; the function follows the same structure as used in <a class="el" href="step_29.html">step-29</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">SANDTopOpt&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;solver&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> linear_solution;</div>
<div class="line">  linear_solution.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> A_direct;</div>
<div class="line">  A_direct.<a class="code" href="classSparseDirectUMFPACK.html#a25b1d3c7dbb88158a76165a4a56a16d6">initialize</a>(system_matrix);</div>
<div class="line">  A_direct.<a class="code" href="classSparseDirectUMFPACK.html#adc154e4830b0e16be265f10a5c8b7103">vmult</a>(linear_solution, system_rhs);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(linear_solution);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> linear_solution;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Detailsoftheoptimizationalgorithm"></a> </p><h3>Details of the optimization algorithm</h3>
<p>The next several functions deal with specific parts of the optimization algorithm, most notably with deciding whether the direction computed by solving the linearized (Newton) system is viable and, if so, how far we want to go in this direction.</p>
<p><a class="anchor" id="Computingsteplengths"></a> </p><h4>Computing step lengths</h4>
<p>We start with a function that does a binary search to figure out the maximum step that meets the dual feasibility &ndash; that is, how far can we go so that \(s&gt;0\) and \(z&gt;0\). The function returns a pair of values, one each for the \(s\) and \(z\) slack variables.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::pair&lt;double, double&gt; SANDTopOpt&lt;dim&gt;::calculate_max_step_size(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordtype">double</span>       fraction_to_boundary;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> min_fraction_to_boundary = .8;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> max_fraction_to_boundary = 1. - 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-5;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (min_fraction_to_boundary &lt; 1 - barrier_size)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (1 - barrier_size &lt; max_fraction_to_boundary)</div>
<div class="line">        fraction_to_boundary = 1 - barrier_size;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        fraction_to_boundary = max_fraction_to_boundary;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    fraction_to_boundary = min_fraction_to_boundary;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> step_size_s_low  = 0;</div>
<div class="line">  <span class="keywordtype">double</span> step_size_z_low  = 0;</div>
<div class="line">  <span class="keywordtype">double</span> step_size_s_high = 1;</div>
<div class="line">  <span class="keywordtype">double</span> step_size_z_high = 1;</div>
<div class="line">  <span class="keywordtype">double</span> step_size_s, step_size_z;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> max_bisection_method_steps = 50;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_bisection_method_steps; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">    {</div>
<div class="line">      step_size_s = (step_size_s_low + step_size_s_high) / 2;</div>
<div class="line">      step_size_z = (step_size_z_low + step_size_z_high) / 2;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> state_test_s =</div>
<div class="line">        (fraction_to_boundary * <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) + (step_size_s * <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> state_test_z =</div>
<div class="line">        (fraction_to_boundary * <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) + (step_size_z * <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">bool</span> accept_s =</div>
<div class="line">        (state_test_s.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)</div>
<div class="line">           .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>()) &amp;&amp;</div>
<div class="line">        (state_test_s.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)</div>
<div class="line">           .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>());</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">bool</span> accept_z =</div>
<div class="line">        (state_test_z.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>)</div>
<div class="line">           .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>()) &amp;&amp;</div>
<div class="line">        (state_test_z.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>)</div>
<div class="line">           .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (accept_s)</div>
<div class="line">        step_size_s_low = step_size_s;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        step_size_s_high = step_size_s;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (accept_z)</div>
<div class="line">        step_size_z_low = step_size_z;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        step_size_z_high = step_size_z;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> {step_size_s_low, step_size_z_low};</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Computingresiduals"></a> </p><h4>Computing residuals</h4>
<p>The next function computes a right hand side vector linearized around a "test solution vector" that we can use to look at the magnitude of the KKT conditions. This is then used for testing the convergence before shrinking the barrier size, as well as in the calculation of the \(l_1\) merit.</p>
<p>The function is lengthy and complicated, but it is really just a copy of the right hand side part of what the <code>assemble_system()</code> function above did.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> SANDTopOpt&lt;dim&gt;::calculate_test_rhs(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
</div><!-- fragment --><p>We first create a zero vector with size and blocking of system_rhs</p>
<div class="fragment"><div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs;</div>
<div class="line">  test_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(system_rhs);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>     fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                   <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                   face_quadrature_formula,</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> dummy_cell_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; lambda_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; mu_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(1.), <a class="code" href="namespacemu.html">mu</a>(1.);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt;            rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filtered_unfiltered_density_solution = test_solution;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filter_adjoint_unfiltered_density_multiplier_solution =</div>
<div class="line">    test_solution;</div>
<div class="line">  filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">    <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>) = 0;</div>
<div class="line">  filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">    <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>) = 0;</div>
<div class="line"> </div>
<div class="line">  filter_matrix.vmult(filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                        <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>),</div>
<div class="line">                      test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                        <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>));</div>
<div class="line">  filter_matrix.Tvmult(</div>
<div class="line">    filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>),</div>
<div class="line">    test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt;                  old_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt;          old_displacement_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt;                  old_displacement_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_symmgrads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_displacement_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt;         old_displacement_multiplier_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_multiplier_symmgrads(</div>
<div class="line">    <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_lower_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_upper_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_lower_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_upper_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_unfiltered_density_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; filtered_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; filter_adjoint_unfiltered_density_multiplier_values(</div>
<div class="line">    <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using namespace </span>ValueExtractors;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      cell_rhs = 0;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.value_list(fe_values.get_quadrature_points(), lambda_values);</div>
<div class="line">      <a class="code" href="namespacemu.html">mu</a>.value_list(fe_values.get_quadrature_points(), mu_values);</div>
<div class="line"> </div>
<div class="line">      fe_values[densities&lt;dim&gt;].get_function_values(test_solution,</div>
<div class="line">                                                    old_density_values);</div>
<div class="line">      fe_values[displacements&lt;dim&gt;].get_function_values(</div>
<div class="line">        test_solution, old_displacement_values);</div>
<div class="line">      fe_values[displacements&lt;dim&gt;].get_function_divergences(</div>
<div class="line">        test_solution, old_displacement_divs);</div>
<div class="line">      fe_values[displacements&lt;dim&gt;].get_function_symmetric_gradients(</div>
<div class="line">        test_solution, old_displacement_symmgrads);</div>
<div class="line">      fe_values[displacement_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">        test_solution, old_displacement_multiplier_values);</div>
<div class="line">      fe_values[displacement_multipliers&lt;dim&gt;].get_function_divergences(</div>
<div class="line">        test_solution, old_displacement_multiplier_divs);</div>
<div class="line">      fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">        .get_function_symmetric_gradients(</div>
<div class="line">          test_solution, old_displacement_multiplier_symmgrads);</div>
<div class="line">      fe_values[density_lower_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">        test_solution, old_lower_slack_values);</div>
<div class="line">      fe_values[density_lower_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">        test_solution, old_lower_slack_multiplier_values);</div>
<div class="line">      fe_values[density_upper_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">        test_solution, old_upper_slack_values);</div>
<div class="line">      fe_values[density_upper_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">        test_solution, old_upper_slack_multiplier_values);</div>
<div class="line">      fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">        test_solution, old_unfiltered_density_values);</div>
<div class="line">      fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">        test_solution, old_unfiltered_density_multiplier_values);</div>
<div class="line">      fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">        filtered_unfiltered_density_solution,</div>
<div class="line">        filtered_unfiltered_density_values);</div>
<div class="line">      fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">        filter_adjoint_unfiltered_density_multiplier_solution,</div>
<div class="line">        filter_adjoint_unfiltered_density_multiplier_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_i_symmgrad =</div>
<div class="line">                fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_i_div =</div>
<div class="line">                fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">              <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">                displacement_multiplier_phi_i_symmgrad =</div>
<div class="line">                  fe_values[displacement_multipliers&lt;dim&gt;].symmetric_gradient(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_i_div =</div>
<div class="line">                fe_values[displacement_multipliers&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                    q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_i =</div>
<div class="line">                fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_i =</div>
<div class="line">                fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_i =</div>
<div class="line">                fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                     q_point);</div>
<div class="line"> </div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_i =</div>
<div class="line">                fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                  <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_i =</div>
<div class="line">                fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_i =</div>
<div class="line">                fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_i =</div>
<div class="line">                fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                  <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 1: This equation, along with equations</span></div>
<div class="line"><span class="comment">               * 2 and 3, are the variational derivatives of the</span></div>
<div class="line"><span class="comment">               * Lagrangian with respect to the decision</span></div>
<div class="line"><span class="comment">               * variables - the density, displacement, and</span></div>
<div class="line"><span class="comment">               * unfiltered density. */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                -1 * fe_values.JxW(q_point) *</div>
<div class="line">                (density_penalty_exponent *</div>
<div class="line">                   <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                            density_penalty_exponent - 1) *</div>
<div class="line">                   density_phi_i *</div>
<div class="line">                   (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                      old_displacement_divs[q_point] *</div>
<div class="line">                      lambda_values[q_point] +</div>
<div class="line">                    2 * mu_values[q_point] *</div>
<div class="line">                      (old_displacement_symmgrads[q_point] *</div>
<div class="line">                       old_displacement_multiplier_symmgrads[q_point])) -</div>
<div class="line">                 density_phi_i *</div>
<div class="line">                   old_unfiltered_density_multiplier_values[q_point]);</div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 2; the boundary terms will be added further down</span></div>
<div class="line"><span class="comment">               * below. */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                -1 * fe_values.JxW(q_point) *</div>
<div class="line">                (<a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                          density_penalty_exponent) *</div>
<div class="line">                 (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                    displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                  2 * mu_values[q_point] *</div>
<div class="line">                    (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                     displacement_phi_i_symmgrad)));</div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 3 */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                -1 * fe_values.JxW(q_point) *</div>
<div class="line">                (unfiltered_density_phi_i *</div>
<div class="line">                   filter_adjoint_unfiltered_density_multiplier_values</div>
<div class="line">                     [q_point] +</div>
<div class="line">                 unfiltered_density_phi_i *</div>
<div class="line">                   old_upper_slack_multiplier_values[q_point] +</div>
<div class="line">                 -1 * unfiltered_density_phi_i *</div>
<div class="line">                   old_lower_slack_multiplier_values[q_point]);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 4; boundary term will again be dealt</span></div>
<div class="line"><span class="comment">               * with below. This equation being driven to 0</span></div>
<div class="line"><span class="comment">               * ensures that the elasticity equation is met as</span></div>
<div class="line"><span class="comment">               * a constraint. */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += -1 * fe_values.JxW(q_point) *</div>
<div class="line">                             (<a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                       density_penalty_exponent) *</div>
<div class="line">                              (old_displacement_divs[q_point] *</div>
<div class="line">                                 displacement_multiplier_phi_i_div *</div>
<div class="line">                                 lambda_values[q_point] +</div>
<div class="line">                               2 * mu_values[q_point] *</div>
<div class="line">                                 (displacement_multiplier_phi_i_symmgrad *</div>
<div class="line">                                  old_displacement_symmgrads[q_point])));</div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 5: This equation sets the lower slack</span></div>
<div class="line"><span class="comment">               * variable equal to the unfiltered density,</span></div>
<div class="line"><span class="comment">               * giving a minimum density of 0. */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                             (lower_slack_multiplier_phi_i *</div>
<div class="line">                              (old_unfiltered_density_values[q_point] -</div>
<div class="line">                               old_lower_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 6: This equation sets the upper slack</span></div>
<div class="line"><span class="comment">               * variable equal to one minus the unfiltered</span></div>
<div class="line"><span class="comment">               * density. */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                             (upper_slack_multiplier_phi_i *</div>
<div class="line">                              (1 - old_unfiltered_density_values[q_point] -</div>
<div class="line">                               old_upper_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 7: This is the difference between the</span></div>
<div class="line"><span class="comment">               * density and the filter applied to the</span></div>
<div class="line"><span class="comment">               * unfiltered density. This being driven to 0 by</span></div>
<div class="line"><span class="comment">               * the Newton steps ensures that the filter is</span></div>
<div class="line"><span class="comment">               * applied correctly. */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                             (unfiltered_density_multiplier_phi_i *</div>
<div class="line">                              (old_density_values[q_point] -</div>
<div class="line">                               filtered_unfiltered_density_values[q_point]));</div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 8: This along with equation 9 give the</span></div>
<div class="line"><span class="comment">               * requirement that s*z = \alpha for the barrier</span></div>
<div class="line"><span class="comment">               * size alpha, and gives complementary slackness</span></div>
<div class="line"><span class="comment">               * from KKT conditions when \alpha goes to 0. */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                -1 * fe_values.JxW(q_point) *</div>
<div class="line">                (lower_slack_phi_i *</div>
<div class="line">                 (old_lower_slack_multiplier_values[q_point] -</div>
<div class="line">                  barrier_size / old_lower_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">              <span class="comment">/* Equation 9 */</span></div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                -1 * fe_values.JxW(q_point) *</div>
<div class="line">                (upper_slack_phi_i *</div>
<div class="line">                 (old_upper_slack_multiplier_values[q_point] -</div>
<div class="line">                  barrier_size / old_upper_slack_values[q_point]));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>)</div>
<div class="line">            {</div>
<div class="line">              fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> face_q_point :</div>
<div class="line">                   fe_face_values.quadrature_point_indices())</div>
<div class="line">                {</div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_face_values.dof_indices())</div>
<div class="line">                    {</div>
<div class="line">                      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> traction;</div>
<div class="line">                      traction[1] = -1.;</div>
<div class="line"> </div>
<div class="line">                      cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                        -1 *</div>
<div class="line">                        (traction * fe_face_values[displacements&lt;dim&gt;].value(</div>
<div class="line">                                      <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, face_q_point)) *</div>
<div class="line">                        fe_face_values.JxW(face_q_point);</div>
<div class="line"> </div>
<div class="line">                      cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                        (traction *</div>
<div class="line">                         fe_face_values[displacement_multipliers&lt;dim&gt;].value(</div>
<div class="line">                           <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, face_q_point)) *</div>
<div class="line">                        fe_face_values.JxW(face_q_point);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="namespaceMatrixTools.html#afe66f38c3a4f4e46dd8389b62209b891">MatrixTools::local_apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               dummy_cell_matrix,</div>
<div class="line">                                               cell_rhs,</div>
<div class="line">                                               <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(cell_rhs,</div>
<div class="line">                                             <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                             test_rhs);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> test_rhs;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Computingthemeritfunction"></a> </p><h4>Computing the merit function</h4>
<p>The algorithm we use herein uses a "watchdog" strategy to determine where and how far to go from the current iterate. We base the watchdog strategy on an exact \(l_1\) merit function. This function calculates the exact \(l_1\) merit of a given, putative, next iterate.</p>
<p>The merit function consists of the sum of the objective function (which is simply an integral of external forces (on the boundary of the domain) times the displacement values of a test solution (typically, the current solution plus some multiple of the Newton update), and the \(l_1\) norms of the Lagrange multiplier components of residual vectors. The following code computes these parts in turn:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> SANDTopOpt&lt;dim&gt;::calculate_exact_merit(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;merit function&quot;</span>);</div>
</div><!-- fragment --><p>Start with computing the objective function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> objective_function_merit = 0;</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>     fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                   <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                   face_quadrature_formula,</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points = face_quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; displacement_face_values(n_face_q_points);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>)</div>
<div class="line">            {</div>
<div class="line">              fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">              fe_face_values[ValueExtractors::displacements&lt;dim&gt;]</div>
<div class="line">                .get_function_values(test_solution,</div>
<div class="line">                                     displacement_face_values);</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_q_point = 0;</div>
<div class="line">                   face_q_point &lt; n_face_q_points;</div>
<div class="line">                   ++face_q_point)</div>
<div class="line">                {</div>
<div class="line">                  <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> traction;</div>
<div class="line">                  traction[1] = -1.;</div>
<div class="line"> </div>
<div class="line">                  objective_function_merit +=</div>
<div class="line">                    (traction * displacement_face_values[face_q_point]) *</div>
<div class="line">                    fe_face_values.JxW(face_q_point);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">  {</div>
<div class="line">    objective_function_merit =</div>
<div class="line">      objective_function_merit -</div>
<div class="line">      barrier_size * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure() *</div>
<div class="line">        <a class="code" href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a>(test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()]);</div>
<div class="line">    objective_function_merit =</div>
<div class="line">      objective_function_merit -</div>
<div class="line">      barrier_size * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure() *</div>
<div class="line">        <a class="code" href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a>(test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()]);</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Then compute the residual and take the \(l_1\) norms of the components that correspond to Lagrange mulipliers. We add those to the objective function computed above, and return the sum at the bottom:</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs = calculate_test_rhs(test_solution);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> elasticity_constraint_merit =</div>
<div class="line">    penalty_multiplier *</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> filter_constraint_merit =</div>
<div class="line">    penalty_multiplier *</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_merit =</div>
<div class="line">    penalty_multiplier *</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_merit =</div>
<div class="line">    penalty_multiplier *</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> total_merit =</div>
<div class="line">    objective_function_merit + elasticity_constraint_merit +</div>
<div class="line">    filter_constraint_merit + lower_slack_merit + upper_slack_merit;</div>
<div class="line">  <span class="keywordflow">return</span> total_merit;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Findingasearchdirection"></a> </p><h4>Finding a search direction</h4>
<p>Next up is the function that actually computes a search direction starting at the current state (passed as the first argument) and returns the resulting vector. To this end, the function first calls the functions that assemble the linear system that corresponds to the Newton system, and that solve it.</p>
<p>This function also updates the penalty multiplier in the merit function, and then returns the largest scaled feasible step. It uses the <code>calculate_max_step_sizes()</code> function to find the largest feasible step that satisfies \(s&gt;0\) and \(z&gt;0\).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> SANDTopOpt&lt;dim&gt;::find_max_step()</div>
<div class="line">{</div>
<div class="line">  assemble_system();</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a> = <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
</div><!-- fragment --><p>Next we are going to update penalty_multiplier. In essence, a larger penalty multiplier makes us consider the constraints more. Looking at the Hessian and gradient with respect to the step we want to take with our decision variables, and comparing that to the norm of our constraint error gives us a way to ensure that our merit function is "exact" - that is, it has a minimum in the same location that the objective function does. As our merit function is exact for any penalty multiplier over some minimum value, we only keep the computed value if it increases the penalty multiplier.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> std::vector&lt;unsigned int&gt; decision_variables = {</div>
<div class="line">  <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>,</div>
<div class="line">  <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SolutionBlocks::displacement</a>,</div>
<div class="line">  <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">  <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>,</div>
<div class="line">  <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>};</div>
<div class="line"><span class="keywordtype">double</span> hess_part = 0;</div>
<div class="line"><span class="keywordtype">double</span> grad_part = 0;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> decision_variable_i : decision_variables)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> decision_variable_j : decision_variables)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classVector.html">Vector&lt;double&gt;</a> temp_vector(<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i).size());</div>
<div class="line">        system_matrix.block(decision_variable_i, decision_variable_j)</div>
<div class="line">          .vmult(temp_vector, <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_j));</div>
<div class="line">        hess_part += <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i) * temp_vector;</div>
<div class="line">      }</div>
<div class="line">    grad_part -= system_rhs.block(decision_variable_i) *</div>
<div class="line">                 <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> std::vector&lt;unsigned int&gt; equality_constraint_multipliers = {</div>
<div class="line">  <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>,</div>
<div class="line">  <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">  <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>,</div>
<div class="line">  <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>};</div>
<div class="line"><span class="keywordtype">double</span> constraint_norm = 0;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> multiplier_i : equality_constraint_multipliers)</div>
<div class="line">  constraint_norm += system_rhs.block(multiplier_i).linfty_norm();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> test_penalty_multiplier;</div>
<div class="line"><span class="keywordflow">if</span> (hess_part &gt; 0)</div>
<div class="line">  test_penalty_multiplier =</div>
<div class="line">    (grad_part + .5 * hess_part) / (.05 * constraint_norm);</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">  test_penalty_multiplier = (grad_part) / (.05 * constraint_norm);</div>
<div class="line"> </div>
<div class="line">penalty_multiplier = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(penalty_multiplier, test_penalty_multiplier);</div>
</div><!-- fragment --><p>Based on all of this, we can now compute step sizes for the primal and dual (Lagrange multiplier) variables. Once we have these, we scale the components of the solution vector, and that is what this function returns.</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> std::pair&lt;double, double&gt; max_step_sizes =</div>
<div class="line">    calculate_max_step_size(nonlinear_solution, <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> step_size_s = max_step_sizes.first;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> step_size_z = max_step_sizes.second;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>) *= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SolutionBlocks::displacement</a>) *= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>) *= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>) *= step_size_z;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>) *= step_size_z;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>) *= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>) *= step_size_z;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>) *= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>) *= step_size_z;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Computingascaledstep"></a> </p><h4>Computing a scaled step</h4>
<p>The next function then implements a back-tracking algorithm for a line search. It keeps shrinking step size until it finds a step where the merit is decreased, and then returns the new location based on the current state vector, and the direction to go into, times the step length.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a></div>
<div class="line">SANDTopOpt&lt;dim&gt;::compute_scaled_step(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                                     <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;max_step,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span> descent_requirement)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> merit_derivative =</div>
<div class="line">    (calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4 * max_step) -</div>
<div class="line">     calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>)) /</div>
<div class="line">    1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4;</div>
<div class="line">  <span class="keywordtype">double</span>       step_size                 = 1;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_linesearch_iterations = 10;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_linesearch_iterations; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + step_size * max_step) &lt;</div>
<div class="line">          calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) +</div>
<div class="line">            step_size * descent_requirement * merit_derivative)</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        step_size = step_size / 2;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + (step_size * max_step);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Checkingforconvergence"></a> </p><h4>Checking for convergence</h4>
<p>The final auxiliary function in this block is the one that checks to see if the KKT conditions are sufficiently met so that the overall algorithm can lower the barrier size. It does so by computing the \(l_1\) norm of the residual, which is what <code>calculate_test_rhs()</code> computes.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">bool</span> SANDTopOpt&lt;dim&gt;::check_convergence(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs      = calculate_test_rhs(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>              test_rhs_norm = test_rhs.<a class="code" href="classBlockVectorBase.html#a5253082a5591dc0d13fef1d65a3dbfae">l1_norm</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> convergence_condition = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-2;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> target_norm           = convergence_condition * barrier_size;</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;    Checking convergence. Current rhs norm is &quot;</span></div>
<div class="line">            &lt;&lt; test_rhs_norm &lt;&lt; <span class="stringliteral">&quot;, target is &quot;</span> &lt;&lt; target_norm &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (test_rhs_norm &lt; target_norm);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Postprocessingthesolution"></a> </p><h3>Postprocessing the solution</h3>
<p>The first of the postprocessing functions outputs information in a VTU file for visualization. It looks long, but it's really just the same as what was done in <a class="el" href="step_22.html">step-22</a>, for example, just with (a lot) more solution variables:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;std::string&gt; solution_names(1, <span class="stringliteral">&quot;density&quot;</span>);</div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    data_component_interpretation(</div>
<div class="line">      1, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line">      data_component_interpretation.push_back(</div>
<div class="line">        <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    }</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;unfiltered_density&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;displacement_multiplier&quot;</span>);</div>
<div class="line">      data_component_interpretation.push_back(</div>
<div class="line">        <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    }</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;unfiltered_density_multiplier&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;low_slack&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;low_slack_multiplier&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;high_slack&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;high_slack_multiplier&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(nonlinear_solution,</div>
<div class="line">                           solution_names,</div>
<div class="line">                           <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                           data_component_interpretation);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution&quot;</span> + <a class="code" href="group__Exceptions.html#ga72743302dcb1a0fb1f2f8dc5122d299e">std::to_string</a>(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>) + <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The second of these functions outputs the solution as an <code>.stl</code> file for 3d printing. <a href="https://en.wikipedia.org/wiki/STL_(file_format)">STL</a> files are made up of triangles and normal vectors, and we will use it to show all of those cells with a density value larger than zero by first extruding the mesh from a \(z\) value of zero to \(z=0.25\), and then generating two triangles for each face of the cells with a sufficiently large density value. The triangle nodes must go counter-clockwise when looking from the outside, and the normal vectors must be unit vectors pointing outwards, which requires a few checks.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::write_as_stl()</div>
<div class="line">{</div>
<div class="line">  static_assert(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2,</div>
<div class="line">                <span class="stringliteral">&quot;This function is not implemented for anything &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;other than the 2d case.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::ofstream stlfile;</div>
<div class="line">  stlfile.open(<span class="stringliteral">&quot;bridge.stl&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  stlfile &lt;&lt; <span class="stringliteral">&quot;solid bridge\n&quot;</span> &lt;&lt; <a class="code" href="table__handler__0_8txt.html#ac42f579ca4a40d2835c1abb1cb95121d">std::scientific</a>;</div>
<div class="line">  <span class="keywordtype">double</span> height = .25;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (nonlinear_solution.block(</div>
<div class="line">            <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()] &gt; 0.5)</div>
<div class="line">        {</div>
</div><!-- fragment --><p>We have now found a cell with a density value larger than zero. Let us start by writing out the bottom and top faces. Owing to the ordering issue mentioned above, we have to make sure that we understand whether a cell has a right- or left-handed coordinate system. We do this by interrogating the directions of the two edges starting at vertex 0 and whether they form a right-handed coordinate system.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> edge_directions[2] = {<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1) -</div>
<div class="line">                                             <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0),</div>
<div class="line">                                           <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2) -</div>
<div class="line">                                             <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)};</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> edge_tensor(</div>
<div class="line">  {{edge_directions[0][0], edge_directions[0][1]},</div>
<div class="line">   {edge_directions[1][0], edge_directions[1][1]}});</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">bool</span> is_right_handed_cell = (<a class="code" href="classSymmetricTensor.html#a7c03a03a5fe823733e7af9f7e4267f81">determinant</a>(edge_tensor) &gt; 0);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (is_right_handed_cell)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">/* Write one side at z = 0. */</span></div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Write one side at z = height. */</span></div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">  }</div>
<div class="line"><span class="keywordflow">else</span> <span class="comment">/* The cell has a left-handed set up */</span></div>
<div class="line">  {</div>
<div class="line">    <span class="comment">/* Write one side at z = 0. */</span></div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Write one side at z = height. */</span></div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Next we need to deal with the four faces of the cell, extended into the \(z\) direction. However, we only need to write these faces if either the face is on the domain boundary, or if it is the interface between a cell with density greater than 0.5, and a cell with a density less than 0.5.</p>
<div class="fragment"><div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_number = 0;</div>
<div class="line">               face_number &lt; GeometryInfo&lt;dim&gt;::faces_per_cell;</div>
<div class="line">               ++face_number)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::face_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> =</div>
<div class="line">                <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face(face_number);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary()) ||</div>
<div class="line">                  (!<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                   (nonlinear_solution.block(</div>
<div class="line">                      0)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;neighbor(face_number)-&gt;active_cell_index()] &lt;</div>
<div class="line">                    0.5)))</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> normal_vector =</div>
<div class="line">                    (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center() - <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center());</div>
<div class="line">                  <span class="keyword">const</span> <span class="keywordtype">double</span> normal_norm = normal_vector.<a class="code" href="classTensor.html#afd0934b4edd71063f66a9c67540e79fc">norm</a>();</div>
<div class="line">                  <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) *</div>
<div class="line">                          0.000000<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>+00 +</div>
<div class="line">                        (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) * (0 - 0) *</div>
<div class="line">                          normal_vector[0] +</div>
<div class="line">                        (height - 0) *</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                          normal_vector[1] -</div>
<div class="line">                        (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) * (0 - 0) *</div>
<div class="line">                          normal_vector[1] -</div>
<div class="line">                        (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) *</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                          normal_vector[0] -</div>
<div class="line">                        (height - 0) *</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) * 0 &gt;</div>
<div class="line">                      0)</div>
<div class="line">                    {</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                              &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                              &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                    }</div>
<div class="line">                  <span class="keywordflow">else</span></div>
<div class="line">                    {</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                              &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                              &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                              &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                      stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  stlfile &lt;&lt; <span class="stringliteral">&quot;endsolid bridge&quot;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Therunfunctiondrivingtheoverallalgorithm"></a> </p><h3>The <a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a> function driving the overall algorithm</h3>
<p>This function finally provides the overall driver logic. It is, in the grand scheme of things, a rather complicated function primarily because the optimization algorithm is difficult: It isn't just about finding a Newton direction like in <a class="el" href="step_15.html">step-15</a> and then going a fixed distance in this direction any more, but instead about (i) determining what the optimal log-barrier penalty parameter should be in the current step, (ii) a complicated algorithm to determine how far we want to go, and other ingredients. Let us see how we can break this down into smaller chunks in the following documentation.</p>
<p>The function starts out simple enough with first setting up the mesh, the <a class="el" href="classDoFHandler.html">DoFHandler</a>, and then the various linear algebra objects necessary for the following:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">SANDTopOpt&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;filter r is: &quot;</span> &lt;&lt; filter_r &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;setup&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">create_triangulation</a>();</div>
<div class="line"> </div>
<div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">    setup_boundary_values();</div>
<div class="line">    setup_block_system();</div>
<div class="line">    setup_filter_matrix();</div>
<div class="line">  }</div>
</div><!-- fragment --><p>We then set a number of parameters that affect the log-barrier and line search components of the optimization algorithm:</p>
<div class="fragment"><div class="line">barrier_size                  = 25;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> min_barrier_size = .0005;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_uphill_steps    = 8;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span>       descent_requirement = .0001;</div>
</div><!-- fragment --><p>Now start the principal iteration. The overall algorithm works by using an outer loop in which we loop until either (i) the log-barrier parameter has become small enough, or (ii) we have reached convergence. In any case, we terminate if end up with too large a number of iterations. This overall structure is encoded as a <code>do { ... } while (...)</code> loop where the convergence condition is at the bottom.</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       iteration_number = 0;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_iterations   = 10000;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">do</span></div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Starting outer step in iteration &quot;</span> &lt;&lt; iteration_number</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; with barrier parameter &quot;</span> &lt;&lt; barrier_size &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>Within this outer loop, we have an inner loop in which we try to find an update direction using the watchdog algorithm described in the introduction.</p>
<p>The general idea of the watchdog algorithm itself is this: For a maximum of <code>max_uphill_steps</code> (i.e., a loop within the "inner loop" mentioned above) attempts, we use <code>find_max_step()</code> to compute a Newton update step, and add these up in the <code>nonlinear_solution</code> vector. In each of these attempts (starting from the place reached at the end of the previous attempt), we check whether we have reached a target value of the merit function described above. The target value is computed based on where this algorithm starts (the <code>nonlinear_solution</code> at the beginning of the watchdog loop, saves as <code>watchdog_state</code>) and the first proposed direction provided by <code>find_max_step()</code> in the first go-around of this loop (the <code>k==0</code> case).</p>
<div class="fragment"><div class="line"><span class="keywordflow">do</span></div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;  Starting inner step in iteration &quot;</span></div>
<div class="line">              &lt;&lt; iteration_number</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; with merit function penalty multiplier &quot;</span></div>
<div class="line">              &lt;&lt; penalty_multiplier &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> watchdog_step_found = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> watchdog_state = nonlinear_solution;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a>       first_step;</div>
<div class="line">    <span class="keywordtype">double</span> target_merit     = numbers::signaling_nan&lt;double&gt;();</div>
<div class="line">    <span class="keywordtype">double</span> merit_derivative = numbers::signaling_nan&lt;double&gt;();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_uphill_steps; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">      {</div>
<div class="line">        ++iteration_number;</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> update_step = find_max_step();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> == 0)</div>
<div class="line">          {</div>
<div class="line">            first_step = update_step;</div>
<div class="line">            merit_derivative =</div>
<div class="line">              ((calculate_exact_merit(watchdog_state +</div>
<div class="line">                                      .0001 * first_step) -</div>
<div class="line">                calculate_exact_merit(watchdog_state)) /</div>
<div class="line">               .0001);</div>
<div class="line">            target_merit = calculate_exact_merit(watchdog_state) +</div>
<div class="line">                           descent_requirement * merit_derivative;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        nonlinear_solution += update_step;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> current_merit =</div>
<div class="line">          calculate_exact_merit(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;    current watchdog state merit is: &quot;</span></div>
<div class="line">                  &lt;&lt; current_merit &lt;&lt; <span class="stringliteral">&quot;; target merit is &quot;</span></div>
<div class="line">                  &lt;&lt; target_merit &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (current_merit &lt; target_merit)</div>
<div class="line">          {</div>
<div class="line">            watchdog_step_found = <span class="keyword">true</span>;</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;    found workable step after &quot;</span> &lt;&lt; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> + 1</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot; iterations&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">          }</div>
<div class="line">      }</div>
</div><!-- fragment --><p>The next part of the algorithm then depends on whether the watchdog loop above succeeded. If it did, then we are satisfied and no further action is necessary: We just stay where we are. If, however, we took the maximal number of unsuccessful steps in the loop above, then we need to do something else, and this is what the following code block does.</p>
<p>Specifically, from the final (unsuccessful) state of the loop above, we seek one more update direction and take what is called a "stretch
 step". If that stretch state satisfies a condition involving the merit function, then we go there. On the other hand, if the stretch state is also unacceptable (as all of the watchdog steps above were), then we discard all of the watchdog steps taken above and start over again where we had started the watchdog iterations &ndash; that place was stored in the <code>watchdog_state</code> variable above. More specifically, the conditions below first test whether we take a step from <code>watchdog_state</code> in direction <code>first_step</code>, or whether we can do one more update from the stretch state to find a new place. It is possible that neither of these is actually better than the state we started from at the beginning of the watchdog algorithm, but even if that is so, that place clearly was a difficult place to be in, and getting away to start the next iteration from another place might be a useful strategy to eventually converge.</p>
<p>We keep repeating the watchdog steps above along with the logic below until this inner iteration is finally converged (or if we run up against the maximal number of iterations &ndash; where we count the number of linear solves as iterations and increment the counter every time we call <code>find_max_step()</code> since that is where the linear solve actually happens). In any case, at the end of each of these inner iterations we also output the solution in a form suitable for visualization.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (watchdog_step_found == <span class="keyword">false</span>)</div>
<div class="line">  {</div>
<div class="line">    ++iteration_number;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> update_step = find_max_step();</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> stretch_state =</div>
<div class="line">      compute_scaled_step(nonlinear_solution,</div>
<div class="line">                          update_step,</div>
<div class="line">                          descent_requirement);</div>
</div><!-- fragment --><p>If we did not get a successful watchdog step, we now need to decide between going back to where we started, or using the final state. We compare the merits of both of these locations, and then take a scaled step from whichever location is better. As the scaled step is guaranteed to lower the merit, we will end up keeping one of the two.</p>
<div class="fragment"><div class="line">        <span class="keywordflow">if</span> ((calculate_exact_merit(nonlinear_solution) &lt;</div>
<div class="line">             calculate_exact_merit(watchdog_state)) ||</div>
<div class="line">            (calculate_exact_merit(stretch_state) &lt; target_merit))</div>
<div class="line">          {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;    Taking scaled step from end of watchdog&quot;</span></div>
<div class="line">                      &lt;&lt; std::endl;</div>
<div class="line">            nonlinear_solution = stretch_state;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            std::cout</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;    Taking scaled step from beginning of watchdog&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">            <span class="keywordflow">if</span> (calculate_exact_merit(stretch_state) &gt;</div>
<div class="line">                calculate_exact_merit(watchdog_state))</div>
<div class="line">              {</div>
<div class="line">                nonlinear_solution =</div>
<div class="line">                  compute_scaled_step(watchdog_state,</div>
<div class="line">                                      first_step,</div>
<div class="line">                                      descent_requirement);</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              {</div>
<div class="line">                ++iteration_number;</div>
<div class="line">                nonlinear_solution = stretch_state;</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> stretch_step =</div>
<div class="line">                  find_max_step();</div>
<div class="line">                nonlinear_solution =</div>
<div class="line">                  compute_scaled_step(nonlinear_solution,</div>
<div class="line">                                      stretch_step,</div>
<div class="line">                                      descent_requirement);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    output_results(iteration_number);</div>
<div class="line">  }</div>
<div class="line"><span class="keywordflow">while</span> ((iteration_number &lt; max_iterations) &amp;&amp;</div>
<div class="line">       (check_convergence(nonlinear_solution) == <span class="keyword">false</span>));</div>
</div><!-- fragment --><p>At the end of the outer loop, we have to update the barrier parameter, for which we use the following formula. The rest of the function is then simply about checking the outer loop convergence condition, and if we decide to terminate computations, about writing the final "design" as an STL file for use in 3d printing, and to output some timing information.</p>
<div class="fragment"><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> barrier_size_multiplier = .8;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> barrier_size_exponent   = 1.2;</div>
<div class="line"> </div>
<div class="line">        barrier_size =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(barrier_size * barrier_size_multiplier,</div>
<div class="line">                            std::pow(barrier_size, barrier_size_exponent)),</div>
<div class="line">                   min_barrier_size);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (((barrier_size &gt; min_barrier_size) ||</div>
<div class="line">            (check_convergence(nonlinear_solution) == <span class="keyword">false</span>)) &amp;&amp;</div>
<div class="line">           (iteration_number &lt; max_iterations));</div>
<div class="line"> </div>
<div class="line">    write_as_stl();</div>
<div class="line">    timer.<a class="code" href="classTimerOutput.html#a133e7d844826bc8716898fb2f86fb9b6">print_summary</a>();</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace SAND</span></div>
</div><!-- fragment --><p><a class="anchor" id="Themainfunction"></a> </p><h3>The main function</h3>
<p>The remainder of the code, the <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> function, is as usual:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classSAND_1_1SANDTopOpt.html">SAND::SANDTopOpt&lt;2&gt;</a> elastic_problem_2d;</div>
<div class="line">      elastic_problem_2d.<a class="code" href="classSAND_1_1SANDTopOpt.html#a1ab26b7b2bb38e7f74a85a5c729484e4">run</a>();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="TestProblem"></a></p><h3>Test Problem</h3>
<p>The algorithms used above are tested against a traditional topology optimization problem called the Messerschmitt-Bolkow-Blohm Beam (MBB Beam).</p>
<p>This problem considers the optimal 2-d structure that can be built on a rectangle 6 units wide, and 1 unit tall. The bottom corners are fixed in place in the \(y\) direction using a zero Dirichlet boundary condition, and a downward force is applied in the center of the top of the beam by enforcing a Neumann boundary condition. The rest of the boundary is allowed to move, and has no external force applied, which takes the form of a zero Neumann boundary condition. In essence, we are asking the following question: How should we design a bridge in a way so that if the bottom left and bottom right point of the bridge are on rollers that allow these points to move horizontally but not vertically, and so that the displacement in response to the vertical force in the center is minimal.</p>
<p>While the total volume of the domain is 6 units, 3 units of material are allowed for the structure. Because of the symmetry of the problem, it could be posed on a rectangle of width 3 and height 1 by cutting the original domain in half, and using zero Dirichlet boundary conditions in the \(x\) direction along the cut edge. That said, symmetry of the solution is a good indicator that the program is working as expected, so we solved the problem on the whole domain, as shown below. <b>[Bendse2004]</b></p>
<div style="text-align:center;"> <img src="https://www.dealii.org/images/steps/developer/step-79.mbbgeometry.png" alt="The MBB problem domain and boundary conditions" class="inline"/> </div><p>Using the program discussed above, we find the minimum volume of the MBB Beam and the individual components of the solution look as follows:</p>
<div class="onecolumn" style="width: 80%; text-align: center;"> <div> <img src="https://www.dealii.org/images/steps/developer/step-79.filtereddensity.png" alt="Filtered Density Solution" class="inline"/> </div> <div> <img src="https://www.dealii.org/images/steps/developer/step-79.unfiltereddensity.png" alt="Unfiltered Density Solution" class="inline"/> </div> </div><p>These pictures show that what we find here is in accordance with what one typically sees in other publications on the topic <b>[Bendse2004]</b>. Maybe more interestingly, the result looks like a truss bridge (except that we apply the load at the top of the trusses, rather than the bottom as in real truss bridges, akin to a "deck
truss" bridge), suggesting that the designs that have been used in bridge- building for centuries are indeed based on ideas we can now show to be optimal in some sense.</p>
<p><a class="anchor" id="Possibilitiesforextensions"></a></p><h4>Possibilities for extensions</h4>
<p>The results shown above took around 75 iterations to find, which is quite concerning given the expense in solving the large linear systems in each iteration. Looking at the evolution, it does look as though the convergence has moments of happening quickly and moments of happening slowly. We believe this to be due to both a lack of precision on when and how to decrease the boundary values, as well as our choice of merit function being sub-optimal. In the future, a LOQO barrier update replacing the monotone reduction, as well as a Markov Filter in place of a merit function will decrease the number of necessary iterations significantly.</p>
<p>The barrier decrease is most sensitive in the middle of the convergence, which is problematic, as it seems like we need it to decrease quickly, then slowly, then quickly again.</p>
<p>Secondly, the linear solver used here is just the sparse direct solver based on the <a class="el" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> class. This works reasonably well on small problems, but the formulation of the optimization problem detailed above has quite a large number of variables and so the linear problem is not only large but also has a lot of nonzero entries in many rows, even on meshes that overall are still relatively coarse. As a consequence, the solver time dominates the computations, and more sophisticated approaches at solving the linear system are necessary.</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Justin O&#39;Connor, Colorado State University, 2021.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2tensor_8h.html">deal.II/base/tensor.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2signaling__nan_8h.html">deal.II/base/signaling_nan.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparse__matrix_8h.html">deal.II/lac/block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2linear__operator_8h.html">deal.II/lac/linear_operator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2packaged__operation_8h.html">deal.II/lac/packaged_operation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgq_8h.html">deal.II/fe/fe_dgq.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceSAND.html">SAND</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>SolutionComponents</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a> = 0;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">displacement</a> = 1;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a> = 1 + <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">displacement_multiplier</a> = 2 + <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a> = 2 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a> = 3 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a> = 4 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a> = 5 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a> = 6 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  } <span class="comment">// namespace SolutionComponents</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>SolutionBlocks</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>                        = 0;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">displacement</a>                   = 1;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a>             = 2;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">displacement_multiplier</a>        = 3;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a>  = 4;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a>            = 5;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a> = 6;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a>            = 7;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a> = 8;</div>
<div class="line">  } <span class="comment">// namespace SolutionBlocks</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>BoundaryIds</div>
<div class="line">  {</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">down_force</a> = 101;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">no_force</a>   = 102;</div>
<div class="line">  } <span class="comment">// namespace BoundaryIds</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>ValueExtractors</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ac221049fbb9ba83a17d1078474c4a747">densities</a>(SolutionComponents::density&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a8cd7076dfb3722290a423c54fc25f28d">displacements</a>(SolutionComponents::displacement&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ae502a219c72947e0c0abc6bc5d318a11">unfiltered_densities</a>(SolutionComponents::unfiltered_density&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a75b37471806be11bfd15238908ef2570">displacement_multipliers</a>(</div>
<div class="line">      SolutionComponents::displacement_multiplier&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a07e1e8cad70f4d40499893eb4e603205">unfiltered_density_multipliers</a>(</div>
<div class="line">      SolutionComponents::unfiltered_density_multiplier&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a149b969d62b110112ced6d4a4a467494">density_lower_slacks</a>(SolutionComponents::density_lower_slack&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ada143f177c93011d19b9753f7af32d57">density_lower_slack_multipliers</a>(</div>
<div class="line">      SolutionComponents::density_lower_slack_multiplier&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a30f363fe7c63c168353b72e3a2dd28c4">density_upper_slacks</a>(SolutionComponents::density_upper_slack&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#af74f3b334f9c0a375c5b7afd07335505">density_upper_slack_multipliers</a>(</div>
<div class="line">      SolutionComponents::density_upper_slack_multiplier&lt;dim&gt;);</div>
<div class="line">  } <span class="comment">// namespace ValueExtractors</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>SANDTopOpt</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SANDTopOpt();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">create_triangulation</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setup_boundary_values();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setup_block_system();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setup_filter_matrix();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">    std::pair&lt;double, double&gt;</div>
<div class="line">    calculate_max_step_size(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                            <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a></div>
<div class="line">    calculate_test_rhs(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> calculate_exact_merit(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> find_max_step();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> compute_scaled_step(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                                            <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>,</div>
<div class="line">                                            <span class="keyword">const</span> <span class="keywordtype">double</span> descent_requirement);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> check_convergence(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> write_as_stl();</div>
<div class="line"> </div>
<div class="line">    std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt;</div>
<div class="line">    find_relevant_neighbors(</div>
<div class="line">      <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">    std::map&lt;types::global_dof_index, double&gt; boundary_values;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line">    <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      filter_sparsity_pattern;</div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> filter_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> system_rhs;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> nonlinear_solution;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> density_ratio;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> density_penalty_exponent;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> filter_r;</div>
<div class="line">    <span class="keywordtype">double</span>       penalty_multiplier;</div>
<div class="line">    <span class="keywordtype">double</span>       barrier_size;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTimerOutput.html">TimerOutput</a> timer;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classSAND_1_1SANDTopOpt.html#a12d2d4c43a7806a69dc6df81b97e1c07">SANDTopOpt&lt;dim&gt;::SANDTopOpt</a>()</div>
<div class="line">    : <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(<a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">         1,</div>
<div class="line">         (<a class="code" href="classFESystem.html">FESystem</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1) ^ <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)),</div>
<div class="line">         1,</div>
<div class="line">         <a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">         1,</div>
<div class="line">         (<a class="code" href="classFESystem.html">FESystem</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1) ^ <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)),</div>
<div class="line">         1,</div>
<div class="line">         <a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">         5)</div>
<div class="line">    , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    , density_ratio(.5)</div>
<div class="line">    , density_penalty_exponent(3)</div>
<div class="line">    , filter_r(.251)</div>
<div class="line">    , penalty_multiplier(1)</div>
<div class="line">    , timer(std::cout, <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary, <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> &gt; 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">SANDTopOpt&lt;dim&gt;::create_triangulation</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                              {6, 1},</div>
<div class="line">                                              <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 0),</div>
<div class="line">                                              <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(6, 1));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(3);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a> = <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center();</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(1) - 1) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keywordflow">if</span> ((<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(0) - 3) &lt; .3))</div>
<div class="line">                      <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>);</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                      <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">BoundaryIds::no_force</a>);</div>
<div class="line">                  }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                  <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">BoundaryIds::no_force</a>);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_boundary_values()</div>
<div class="line">  {</div>
<div class="line">    boundary_values.clear();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a> = <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center();</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> vertex_number : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_indices())</div>
<div class="line">                      {</div>
<div class="line">                        <span class="keyword">const</span> <span class="keyword">auto</span> vert = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(vertex_number);</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(0) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 &amp;&amp;</div>
<div class="line">                            <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                          {</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> x_displacement =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 0);</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 1);</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> x_displacement_multiplier =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 2);</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement_multiplier =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 3);</div>
<div class="line"> </div>
<div class="line">                            boundary_values[x_displacement]            = 0;</div>
<div class="line">                            boundary_values[y_displacement]            = 0;</div>
<div class="line">                            boundary_values[x_displacement_multiplier] = 0;</div>
<div class="line">                            boundary_values[y_displacement_multiplier] = 0;</div>
<div class="line">                          }</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(0) - 6) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 &amp;&amp;</div>
<div class="line">                                 <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                          {</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 1);</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement_multiplier =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 3);</div>
<div class="line"> </div>
<div class="line">                            boundary_values[y_displacement]            = 0;</div>
<div class="line">                            boundary_values[y_displacement_multiplier] = 0;</div>
<div class="line">                          }</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_block_system()</div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;unsigned int&gt; block_component(9, 2);</div>
<div class="line">    block_component[0] = 0;</div>
<div class="line">    block_component[1] = 1;</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a>                     n_p = dofs_per_block[0];</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a>                     n_u = dofs_per_block[1];</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebra_1_1CUDAWrappers_1_1kernel.html#aa63f11d31d19bd16be69280eac69dd10">std::vector&lt;BlockVector&lt;double&gt;::size_type</a>&gt; block_sizes = {</div>
<div class="line">      n_p, n_u, n_p, n_u, n_p, n_p, n_p, n_p, n_p};</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(9, 9);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; 9; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; 9; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">        dsp.block(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(block_sizes[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>], block_sizes[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]);</div>
<div class="line">    dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 7, 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 7);</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>SolutionComponents;</div>
<div class="line"> </div>
<div class="line">      coupling[density&lt;dim&gt;][density&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          coupling[density&lt;dim&gt;][displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          coupling[displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][density&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          coupling[density&lt;dim&gt;][displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] =</div>
<div class="line">            <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          coupling[displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][density&lt;dim&gt;] =</div>
<div class="line">            <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      coupling[density&lt;dim&gt;][unfiltered_density_multiplier&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[unfiltered_density_multiplier&lt;dim&gt;][density&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* Coupling for displacement */</span></div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              coupling[displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">                      [displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">              coupling[displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]</div>
<div class="line">                      [displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* Coupling for slack variables */</span></div>
<div class="line">      coupling[density_lower_slack&lt;dim&gt;][density_lower_slack&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[density_lower_slack&lt;dim&gt;][density_upper_slack&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[density_upper_slack&lt;dim&gt;][density_lower_slack&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">      coupling[density_lower_slack_multiplier&lt;dim&gt;]</div>
<div class="line">              [density_lower_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[density_lower_slack_multiplier&lt;dim&gt;]</div>
<div class="line">              [density_upper_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[density_upper_slack_multiplier&lt;dim&gt;]</div>
<div class="line">              [density_lower_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classComponentMask.html">ComponentMask</a> density_mask =</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(ValueExtractors::densities&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> density_dofs =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a45f4d01f1c4c6337e4be6f10a81fbdab">DoFTools::extract_dofs</a>(dof_handler, density_mask);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> last_density_dof =</div>
<div class="line">      density_dofs.<a class="code" href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">nth_index_in_set</a>(density_dofs.<a class="code" href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">n_elements</a>() - 1);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">add_line</a>(last_density_dof);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; density_dofs.<a class="code" href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">n_elements</a>() - 1; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a2b7756e9cb8e53553211add5426f8e50">add_entry</a>(last_density_dof,</div>
<div class="line">                            density_dofs.<a class="code" href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">nth_index_in_set</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>),</div>
<div class="line">                            -1);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">set_inhomogeneity</a>(last_density_dof, 0);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, coupling, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell : find_relevant_neighbors(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(check_cell-&gt;center());</div>
<div class="line">            <span class="keywordflow">if</span> (distance &lt; filter_r)</div>
<div class="line">              {</div>
<div class="line">                dsp</div>
<div class="line">                  .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                         <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)</div>
<div class="line">                  .<a class="code" href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">add</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, check_cell-&gt;active_cell_index());</div>
<div class="line">                dsp</div>
<div class="line">                  .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">                         <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)</div>
<div class="line">                  .<a class="code" href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">add</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, check_cell-&gt;active_cell_index());</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>(<span class="stringliteral">&quot;sparsity.plt&quot;</span>);</div>
<div class="line">    <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.print_gnuplot(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>);</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    nonlinear_solution.reinit(block_sizes);</div>
<div class="line">    system_rhs.reinit(block_sizes);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>SolutionBlocks;</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>).add(density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a>).add(density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a>)</div>
<div class="line">        .add(density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a>).add(density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a>).add(50);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a>).add(1 - density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a>).add(50);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_filter_matrix()</div>
<div class="line">  {</div>
<div class="line"> </div>
<div class="line">    filter_sparsity_pattern.copy_from(</div>
<div class="line">      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                             <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line">    filter_matrix.reinit(filter_sparsity_pattern);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell : find_relevant_neighbors(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(check_cell-&gt;center());</div>
<div class="line">            <span class="keywordflow">if</span> (distance &lt; filter_r)</div>
<div class="line">              {</div>
<div class="line">                filter_matrix.add(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                  check_cell-&gt;active_cell_index(),</div>
<div class="line">                                  filter_r - distance);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; filter_matrix.m(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> denominator = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="classSparseMatrix.html#ac94776653684705604fea3dae0af35f4">SparseMatrix&lt;double&gt;::iterator</a> iter = filter_matrix.begin(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter++)</div>
<div class="line">          denominator = denominator + iter-&gt;<a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>();</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="classSparseMatrix.html#ac94776653684705604fea3dae0af35f4">SparseMatrix&lt;double&gt;::iterator</a> iter = filter_matrix.begin(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter++)</div>
<div class="line">          iter-&gt;value() = iter-&gt;value() / denominator;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt;</div>
<div class="line">  SANDTopOpt&lt;dim&gt;::find_relevant_neighbors(</div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::set&lt;unsigned int&gt;                               neighbor_ids;</div>
<div class="line">    std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt; cells_to_check;</div>
<div class="line"> </div>
<div class="line">    neighbor_ids.insert(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index());</div>
<div class="line">    cells_to_check.insert(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> new_neighbors_found;</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        new_neighbors_found = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell :</div>
<div class="line">             <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a>&gt;(</div>
<div class="line">               cells_to_check.begin(), cells_to_check.end()))</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a> : check_cell-&gt;face_indices())</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">if</span> (!(check_cell-&gt;face(<a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a>)-&gt;at_boundary()))</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <span class="keyword">auto</span> &amp; <a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a> = check_cell-&gt;neighbor(<a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a>);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">                      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;center());</div>
<div class="line">                    <span class="keywordflow">if</span> ((distance &lt; filter_r) &amp;&amp;</div>
<div class="line">                        !(neighbor_ids.count(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;active_cell_index())))</div>
<div class="line">                      {</div>
<div class="line">                        cells_to_check.insert(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>);</div>
<div class="line">                        neighbor_ids.insert(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;active_cell_index());</div>
<div class="line">                        new_neighbors_found = <span class="keyword">true</span>;</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (new_neighbors_found);</div>
<div class="line">    <span class="keywordflow">return</span> cells_to_check;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::assemble_system()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    system_matrix = 0;</div>
<div class="line">    system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a> <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>          quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt;      face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>        fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>    fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                     <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                     face_quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     dummy_cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;                    lambda_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;                    mu_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(1.);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="namespacemu.html">mu</a>(1.);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;            rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filtered_unfiltered_density_solution =</div>
<div class="line">      nonlinear_solution;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filter_adjoint_unfiltered_density_multiplier_solution =</div>
<div class="line">      nonlinear_solution;</div>
<div class="line"> </div>
<div class="line">    filter_matrix.vmult(filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>),</div>
<div class="line">                        nonlinear_solution.block(</div>
<div class="line">                          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>));</div>
<div class="line">    filter_matrix.Tvmult(</div>
<div class="line">      filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">        <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>),</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;                  old_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;          old_displacement_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  old_displacement_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_symmgrads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_displacement_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_displacement_multiplier_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_multiplier_symmgrads(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_lower_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_upper_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_lower_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_upper_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_unfiltered_density_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; filtered_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; filter_adjoint_unfiltered_density_multiplier_values(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using namespace </span>ValueExtractors;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.value_list(fe_values.get_quadrature_points(), lambda_values);</div>
<div class="line">        <a class="code" href="namespacemu.html">mu</a>.value_list(fe_values.get_quadrature_points(), mu_values);</div>
<div class="line"> </div>
<div class="line">        fe_values[densities&lt;dim&gt;].get_function_values(nonlinear_solution,</div>
<div class="line">                                                      old_density_values);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_displacement_values);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_divergences(</div>
<div class="line">          nonlinear_solution, old_displacement_divs);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_symmetric_gradients(</div>
<div class="line">          nonlinear_solution, old_displacement_symmgrads);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_displacement_multiplier_values);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].get_function_divergences(</div>
<div class="line">          nonlinear_solution, old_displacement_multiplier_divs);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">          .get_function_symmetric_gradients(</div>
<div class="line">            nonlinear_solution, old_displacement_multiplier_symmgrads);</div>
<div class="line">        fe_values[density_lower_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_lower_slack_values);</div>
<div class="line">        fe_values[density_lower_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_lower_slack_multiplier_values);</div>
<div class="line">        fe_values[density_upper_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_upper_slack_values);</div>
<div class="line">        fe_values[density_upper_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_upper_slack_multiplier_values);</div>
<div class="line">        fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_unfiltered_density_values);</div>
<div class="line">        fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_unfiltered_density_multiplier_values);</div>
<div class="line">        fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">          filtered_unfiltered_density_solution,</div>
<div class="line">          filtered_unfiltered_density_values);</div>
<div class="line">        fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          filter_adjoint_unfiltered_density_multiplier_solution,</div>
<div class="line">          filter_adjoint_unfiltered_density_multiplier_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_i_symmgrad =</div>
<div class="line">                  fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_i_div =</div>
<div class="line">                  fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">                  displacement_multiplier_phi_i_symmgrad =</div>
<div class="line">                    fe_values[displacement_multipliers&lt;dim&gt;].symmetric_gradient(</div>
<div class="line">                      <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_i_div =</div>
<div class="line">                  fe_values[displacement_multipliers&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                      q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_i =</div>
<div class="line">                  fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_i =</div>
<div class="line">                  fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_i =</div>
<div class="line">                  fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                       q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_i =</div>
<div class="line">                  fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_i =</div>
<div class="line">                  fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_i =</div>
<div class="line">                  fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_i =</div>
<div class="line">                  fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> : fe_values.dof_indices())</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_j_symmgrad =</div>
<div class="line">                      fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>,</div>
<div class="line">                                                                       q_point);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_j_div =</div>
<div class="line">                      fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">                      displacement_multiplier_phi_j_symmgrad =</div>
<div class="line">                        fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">                          .symmetric_gradient(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_j_div =</div>
<div class="line">                      fe_values[displacement_multipliers&lt;dim&gt;].divergence(</div>
<div class="line">                        <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_j =</div>
<div class="line">                      fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_j =</div>
<div class="line">                      fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_j =</div>
<div class="line">                      fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(</div>
<div class="line">                        <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_j =</div>
<div class="line">                      fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_j =</div>
<div class="line">                      fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_j =</div>
<div class="line">                      fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                        <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_j =</div>
<div class="line">                      fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                        <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 1 */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (</div>
<div class="line"> </div>
<div class="line">                        -density_phi_i * unfiltered_density_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line">                        + density_penalty_exponent *</div>
<div class="line">                            (density_penalty_exponent - 1) *</div>
<div class="line">                            std::pow(old_density_values[q_point],</div>
<div class="line">                                     density_penalty_exponent - 2) *</div>
<div class="line">                            density_phi_i * density_phi_j *</div>
<div class="line">                            (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                               old_displacement_divs[q_point] *</div>
<div class="line">                               lambda_values[q_point] +</div>
<div class="line">                             2 * mu_values[q_point] *</div>
<div class="line">                               (old_displacement_symmgrads[q_point] *</div>
<div class="line">                                old_displacement_multiplier_symmgrads[q_point]))</div>
<div class="line"> </div>
<div class="line">                        + density_penalty_exponent *</div>
<div class="line">                            <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                     density_penalty_exponent - 1) *</div>
<div class="line">                            density_phi_i *</div>
<div class="line">                            (displacement_multiplier_phi_j_div *</div>
<div class="line">                               old_displacement_divs[q_point] *</div>
<div class="line">                               lambda_values[q_point] +</div>
<div class="line">                             2 * mu_values[q_point] *</div>
<div class="line">                               (old_displacement_symmgrads[q_point] *</div>
<div class="line">                                displacement_multiplier_phi_j_symmgrad))</div>
<div class="line"> </div>
<div class="line">                        + density_penalty_exponent *</div>
<div class="line">                            <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                     density_penalty_exponent - 1) *</div>
<div class="line">                            density_phi_i *</div>
<div class="line">                            (displacement_phi_j_div *</div>
<div class="line">                               old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                               lambda_values[q_point] +</div>
<div class="line">                             2 * mu_values[q_point] *</div>
<div class="line">                               (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                                displacement_phi_j_symmgrad)));</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 2 */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (density_penalty_exponent *</div>
<div class="line">                         <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                  density_penalty_exponent - 1) *</div>
<div class="line">                         density_phi_j *</div>
<div class="line">                         (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                            displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                          2 * mu_values[q_point] *</div>
<div class="line">                            (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                             displacement_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">                       + <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                  density_penalty_exponent) *</div>
<div class="line">                           (displacement_multiplier_phi_j_div *</div>
<div class="line">                              displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                            2 * mu_values[q_point] *</div>
<div class="line">                              (displacement_multiplier_phi_j_symmgrad *</div>
<div class="line">                               displacement_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">                      );</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 3, which has to do with the filter and which is</span></div>
<div class="line"><span class="comment">                     * calculated elsewhere. */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (-1 * unfiltered_density_phi_i *</div>
<div class="line">                         lower_slack_multiplier_phi_j +</div>
<div class="line">                       unfiltered_density_phi_i * upper_slack_multiplier_phi_j);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 4: Primal feasibility */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (</div>
<div class="line"> </div>
<div class="line">                        density_penalty_exponent *</div>
<div class="line">                          <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                   density_penalty_exponent - 1) *</div>
<div class="line">                          density_phi_j *</div>
<div class="line">                          (old_displacement_divs[q_point] *</div>
<div class="line">                             displacement_multiplier_phi_i_div *</div>
<div class="line">                             lambda_values[q_point] +</div>
<div class="line">                           2 * mu_values[q_point] *</div>
<div class="line">                             (old_displacement_symmgrads[q_point] *</div>
<div class="line">                              displacement_multiplier_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">                        + <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                   density_penalty_exponent) *</div>
<div class="line">                            (displacement_phi_j_div *</div>
<div class="line">                               displacement_multiplier_phi_i_div *</div>
<div class="line">                               lambda_values[q_point] +</div>
<div class="line">                             2 * mu_values[q_point] *</div>
<div class="line">                               (displacement_phi_j_symmgrad *</div>
<div class="line">                                displacement_multiplier_phi_i_symmgrad)));</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 5: Primal feasibility */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      -1 * fe_values.JxW(q_point) *</div>
<div class="line">                      lower_slack_multiplier_phi_i *</div>
<div class="line">                      (unfiltered_density_phi_j - lower_slack_phi_j);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 6: Primal feasibility */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      -1 * fe_values.JxW(q_point) *</div>
<div class="line">                      upper_slack_multiplier_phi_i *</div>
<div class="line">                      (-1 * unfiltered_density_phi_j - upper_slack_phi_j);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 7: Primal feasibility - the part with the filter</span></div>
<div class="line"><span class="comment">                     * is added later */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) += -1 * fe_values.JxW(q_point) *</div>
<div class="line">                                         unfiltered_density_multiplier_phi_i *</div>
<div class="line">                                         (density_phi_j);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 8: Complementary slackness */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (lower_slack_phi_i * lower_slack_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line">                       + lower_slack_phi_i * lower_slack_phi_j *</div>
<div class="line">                           old_lower_slack_multiplier_values[q_point] /</div>
<div class="line">                           old_lower_slack_values[q_point]);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 9: Complementary slackness */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (upper_slack_phi_i * upper_slack_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                       + upper_slack_phi_i * upper_slack_phi_j *</div>
<div class="line">                           old_upper_slack_multiplier_values[q_point] /</div>
<div class="line">                           old_upper_slack_values[q_point]);</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="namespaceMatrixTools.html#afe66f38c3a4f4e46dd8389b62209b891">MatrixTools::local_apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                                 <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                 <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                                 dummy_cell_rhs,</div>
<div class="line">                                                 <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               system_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    system_rhs = calculate_test_rhs(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classSparseMatrix.html#ac94776653684705604fea3dae0af35f4">SparseMatrix&lt;double&gt;::iterator</a> iter =</div>
<div class="line">               filter_matrix.begin(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             ++iter)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>     = iter-&gt;column();</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span>       <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a> = iter-&gt;<a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>() * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure();</div>
<div class="line"> </div>
<div class="line">            system_matrix</div>
<div class="line">              .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">                     <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)</div>
<div class="line">              .add(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, value);</div>
<div class="line">            system_matrix</div>
<div class="line">              .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                     <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)</div>
<div class="line">              .add(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, value);</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">SANDTopOpt&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;solver&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> linear_solution;</div>
<div class="line">    linear_solution.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> A_direct;</div>
<div class="line">    A_direct.<a class="code" href="classSparseDirectUMFPACK.html#a25b1d3c7dbb88158a76165a4a56a16d6">initialize</a>(system_matrix);</div>
<div class="line">    A_direct.<a class="code" href="classSparseDirectUMFPACK.html#adc154e4830b0e16be265f10a5c8b7103">vmult</a>(linear_solution, system_rhs);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(linear_solution);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> linear_solution;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::pair&lt;double, double&gt; SANDTopOpt&lt;dim&gt;::calculate_max_step_size(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordtype">double</span>       fraction_to_boundary;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> min_fraction_to_boundary = .8;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> max_fraction_to_boundary = 1. - 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-5;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (min_fraction_to_boundary &lt; 1 - barrier_size)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> (1 - barrier_size &lt; max_fraction_to_boundary)</div>
<div class="line">          fraction_to_boundary = 1 - barrier_size;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          fraction_to_boundary = max_fraction_to_boundary;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      fraction_to_boundary = min_fraction_to_boundary;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> step_size_s_low  = 0;</div>
<div class="line">    <span class="keywordtype">double</span> step_size_z_low  = 0;</div>
<div class="line">    <span class="keywordtype">double</span> step_size_s_high = 1;</div>
<div class="line">    <span class="keywordtype">double</span> step_size_z_high = 1;</div>
<div class="line">    <span class="keywordtype">double</span> step_size_s, step_size_z;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> max_bisection_method_steps = 50;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_bisection_method_steps; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">      {</div>
<div class="line">        step_size_s = (step_size_s_low + step_size_s_high) / 2;</div>
<div class="line">        step_size_z = (step_size_z_low + step_size_z_high) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> state_test_s =</div>
<div class="line">          (fraction_to_boundary * <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) + (step_size_s * <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> state_test_z =</div>
<div class="line">          (fraction_to_boundary * <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) + (step_size_z * <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> accept_s =</div>
<div class="line">          (state_test_s.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)</div>
<div class="line">             .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>()) &amp;&amp;</div>
<div class="line">          (state_test_s.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)</div>
<div class="line">             .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>());</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> accept_z =</div>
<div class="line">          (state_test_z.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>)</div>
<div class="line">             .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>()) &amp;&amp;</div>
<div class="line">          (state_test_z.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>)</div>
<div class="line">             .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (accept_s)</div>
<div class="line">          step_size_s_low = step_size_s;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          step_size_s_high = step_size_s;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (accept_z)</div>
<div class="line">          step_size_z_low = step_size_z;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          step_size_z_high = step_size_z;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> {step_size_s_low, step_size_z_low};</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> SANDTopOpt&lt;dim&gt;::calculate_test_rhs(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs;</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(system_rhs);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>     fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                     <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                     face_quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> dummy_cell_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; lambda_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; mu_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(1.), <a class="code" href="namespacemu.html">mu</a>(1.);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;            rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filtered_unfiltered_density_solution = test_solution;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filter_adjoint_unfiltered_density_multiplier_solution =</div>
<div class="line">      test_solution;</div>
<div class="line">    filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>) = 0;</div>
<div class="line">    filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>) = 0;</div>
<div class="line"> </div>
<div class="line">    filter_matrix.vmult(filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>),</div>
<div class="line">                        test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>));</div>
<div class="line">    filter_matrix.Tvmult(</div>
<div class="line">      filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">        <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>),</div>
<div class="line">      test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;                  old_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;          old_displacement_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  old_displacement_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_symmgrads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_displacement_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_displacement_multiplier_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_multiplier_symmgrads(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_lower_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_upper_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_lower_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_upper_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_unfiltered_density_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; filtered_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; filter_adjoint_unfiltered_density_multiplier_values(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using namespace </span>ValueExtractors;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        cell_rhs = 0;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.value_list(fe_values.get_quadrature_points(), lambda_values);</div>
<div class="line">        <a class="code" href="namespacemu.html">mu</a>.value_list(fe_values.get_quadrature_points(), mu_values);</div>
<div class="line"> </div>
<div class="line">        fe_values[densities&lt;dim&gt;].get_function_values(test_solution,</div>
<div class="line">                                                      old_density_values);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_displacement_values);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_divergences(</div>
<div class="line">          test_solution, old_displacement_divs);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_symmetric_gradients(</div>
<div class="line">          test_solution, old_displacement_symmgrads);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_displacement_multiplier_values);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].get_function_divergences(</div>
<div class="line">          test_solution, old_displacement_multiplier_divs);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">          .get_function_symmetric_gradients(</div>
<div class="line">            test_solution, old_displacement_multiplier_symmgrads);</div>
<div class="line">        fe_values[density_lower_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_lower_slack_values);</div>
<div class="line">        fe_values[density_lower_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_lower_slack_multiplier_values);</div>
<div class="line">        fe_values[density_upper_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_upper_slack_values);</div>
<div class="line">        fe_values[density_upper_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_upper_slack_multiplier_values);</div>
<div class="line">        fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_unfiltered_density_values);</div>
<div class="line">        fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_unfiltered_density_multiplier_values);</div>
<div class="line">        fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">          filtered_unfiltered_density_solution,</div>
<div class="line">          filtered_unfiltered_density_values);</div>
<div class="line">        fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          filter_adjoint_unfiltered_density_multiplier_solution,</div>
<div class="line">          filter_adjoint_unfiltered_density_multiplier_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_i_symmgrad =</div>
<div class="line">                  fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_i_div =</div>
<div class="line">                  fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">                  displacement_multiplier_phi_i_symmgrad =</div>
<div class="line">                    fe_values[displacement_multipliers&lt;dim&gt;].symmetric_gradient(</div>
<div class="line">                      <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_i_div =</div>
<div class="line">                  fe_values[displacement_multipliers&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                      q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_i =</div>
<div class="line">                  fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_i =</div>
<div class="line">                  fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_i =</div>
<div class="line">                  fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                       q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_i =</div>
<div class="line">                  fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_i =</div>
<div class="line">                  fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_i =</div>
<div class="line">                  fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_i =</div>
<div class="line">                  fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 1: This equation, along with equations</span></div>
<div class="line"><span class="comment">                 * 2 and 3, are the variational derivatives of the</span></div>
<div class="line"><span class="comment">                 * Lagrangian with respect to the decision</span></div>
<div class="line"><span class="comment">                 * variables - the density, displacement, and</span></div>
<div class="line"><span class="comment">                 * unfiltered density. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (density_penalty_exponent *</div>
<div class="line">                     <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                              density_penalty_exponent - 1) *</div>
<div class="line">                     density_phi_i *</div>
<div class="line">                     (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                        old_displacement_divs[q_point] *</div>
<div class="line">                        lambda_values[q_point] +</div>
<div class="line">                      2 * mu_values[q_point] *</div>
<div class="line">                        (old_displacement_symmgrads[q_point] *</div>
<div class="line">                         old_displacement_multiplier_symmgrads[q_point])) -</div>
<div class="line">                   density_phi_i *</div>
<div class="line">                     old_unfiltered_density_multiplier_values[q_point]);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 2; the boundary terms will be added further down</span></div>
<div class="line"><span class="comment">                 * below. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (<a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                            density_penalty_exponent) *</div>
<div class="line">                   (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                      displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                    2 * mu_values[q_point] *</div>
<div class="line">                      (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                       displacement_phi_i_symmgrad)));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 3 */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (unfiltered_density_phi_i *</div>
<div class="line">                     filter_adjoint_unfiltered_density_multiplier_values</div>
<div class="line">                       [q_point] +</div>
<div class="line">                   unfiltered_density_phi_i *</div>
<div class="line">                     old_upper_slack_multiplier_values[q_point] +</div>
<div class="line">                   -1 * unfiltered_density_phi_i *</div>
<div class="line">                     old_lower_slack_multiplier_values[q_point]);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 4; boundary term will again be dealt</span></div>
<div class="line"><span class="comment">                 * with below. This equation being driven to 0</span></div>
<div class="line"><span class="comment">                 * ensures that the elasticity equation is met as</span></div>
<div class="line"><span class="comment">                 * a constraint. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += -1 * fe_values.JxW(q_point) *</div>
<div class="line">                               (<a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                         density_penalty_exponent) *</div>
<div class="line">                                (old_displacement_divs[q_point] *</div>
<div class="line">                                   displacement_multiplier_phi_i_div *</div>
<div class="line">                                   lambda_values[q_point] +</div>
<div class="line">                                 2 * mu_values[q_point] *</div>
<div class="line">                                   (displacement_multiplier_phi_i_symmgrad *</div>
<div class="line">                                    old_displacement_symmgrads[q_point])));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 5: This equation sets the lower slack</span></div>
<div class="line"><span class="comment">                 * variable equal to the unfiltered density,</span></div>
<div class="line"><span class="comment">                 * giving a minimum density of 0. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                               (lower_slack_multiplier_phi_i *</div>
<div class="line">                                (old_unfiltered_density_values[q_point] -</div>
<div class="line">                                 old_lower_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 6: This equation sets the upper slack</span></div>
<div class="line"><span class="comment">                 * variable equal to one minus the unfiltered</span></div>
<div class="line"><span class="comment">                 * density. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                               (upper_slack_multiplier_phi_i *</div>
<div class="line">                                (1 - old_unfiltered_density_values[q_point] -</div>
<div class="line">                                 old_upper_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 7: This is the difference between the</span></div>
<div class="line"><span class="comment">                 * density and the filter applied to the</span></div>
<div class="line"><span class="comment">                 * unfiltered density. This being driven to 0 by</span></div>
<div class="line"><span class="comment">                 * the Newton steps ensures that the filter is</span></div>
<div class="line"><span class="comment">                 * applied correctly. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                               (unfiltered_density_multiplier_phi_i *</div>
<div class="line">                                (old_density_values[q_point] -</div>
<div class="line">                                 filtered_unfiltered_density_values[q_point]));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 8: This along with equation 9 give the</span></div>
<div class="line"><span class="comment">                 * requirement that @f$s*z = \alpha@f$ for the barrier</span></div>
<div class="line"><span class="comment">                 * size alpha, and gives complementary slackness</span></div>
<div class="line"><span class="comment">                 * from KKT conditions when @f$\alpha@f$ goes to 0. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (lower_slack_phi_i *</div>
<div class="line">                   (old_lower_slack_multiplier_values[q_point] -</div>
<div class="line">                    barrier_size / old_lower_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 9 */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (upper_slack_phi_i *</div>
<div class="line">                   (old_upper_slack_multiplier_values[q_point] -</div>
<div class="line">                    barrier_size / old_upper_slack_values[q_point]));</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>)</div>
<div class="line">              {</div>
<div class="line">                fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> face_q_point :</div>
<div class="line">                     fe_face_values.quadrature_point_indices())</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_face_values.dof_indices())</div>
<div class="line">                      {</div>
<div class="line">                        <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> traction;</div>
<div class="line">                        traction[1] = -1.;</div>
<div class="line"> </div>
<div class="line">                        cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                          -1 *</div>
<div class="line">                          (traction * fe_face_values[displacements&lt;dim&gt;].value(</div>
<div class="line">                                        <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, face_q_point)) *</div>
<div class="line">                          fe_face_values.JxW(face_q_point);</div>
<div class="line"> </div>
<div class="line">                        cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                          (traction *</div>
<div class="line">                           fe_face_values[displacement_multipliers&lt;dim&gt;].value(</div>
<div class="line">                             <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, face_q_point)) *</div>
<div class="line">                          fe_face_values.JxW(face_q_point);</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="namespaceMatrixTools.html#afe66f38c3a4f4e46dd8389b62209b891">MatrixTools::local_apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                                 <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                 dummy_cell_matrix,</div>
<div class="line">                                                 cell_rhs,</div>
<div class="line">                                                 <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(cell_rhs,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               test_rhs);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> test_rhs;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> SANDTopOpt&lt;dim&gt;::calculate_exact_merit(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;merit function&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> objective_function_merit = 0;</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">      <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                              <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                              quadrature_formula,</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">      <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>     fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                       <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                       face_quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points = face_quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;Tensor&lt;1, dim&gt;&gt; displacement_face_values(n_face_q_points);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                  <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>)</div>
<div class="line">                {</div>
<div class="line">                  fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">                  fe_face_values[ValueExtractors::displacements&lt;dim&gt;]</div>
<div class="line">                    .get_function_values(test_solution,</div>
<div class="line">                                         displacement_face_values);</div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_q_point = 0;</div>
<div class="line">                       face_q_point &lt; n_face_q_points;</div>
<div class="line">                       ++face_q_point)</div>
<div class="line">                    {</div>
<div class="line">                      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> traction;</div>
<div class="line">                      traction[1] = -1.;</div>
<div class="line"> </div>
<div class="line">                      objective_function_merit +=</div>
<div class="line">                        (traction * displacement_face_values[face_q_point]) *</div>
<div class="line">                        fe_face_values.JxW(face_q_point);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        objective_function_merit =</div>
<div class="line">          objective_function_merit -</div>
<div class="line">          barrier_size * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure() *</div>
<div class="line">            <a class="code" href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a>(test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">              <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()]);</div>
<div class="line">        objective_function_merit =</div>
<div class="line">          objective_function_merit -</div>
<div class="line">          barrier_size * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure() *</div>
<div class="line">            <a class="code" href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a>(test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">              <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()]);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs = calculate_test_rhs(test_solution);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> elasticity_constraint_merit =</div>
<div class="line">      penalty_multiplier *</div>
<div class="line">      test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> filter_constraint_merit =</div>
<div class="line">      penalty_multiplier *</div>
<div class="line">      test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_merit =</div>
<div class="line">      penalty_multiplier *</div>
<div class="line">      test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_merit =</div>
<div class="line">      penalty_multiplier *</div>
<div class="line">      test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> total_merit =</div>
<div class="line">      objective_function_merit + elasticity_constraint_merit +</div>
<div class="line">      filter_constraint_merit + lower_slack_merit + upper_slack_merit;</div>
<div class="line">    <span class="keywordflow">return</span> total_merit;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> SANDTopOpt&lt;dim&gt;::find_max_step()</div>
<div class="line">  {</div>
<div class="line">    assemble_system();</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a> = <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;unsigned int&gt; decision_variables = {</div>
<div class="line">      <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SolutionBlocks::displacement</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>};</div>
<div class="line">    <span class="keywordtype">double</span> hess_part = 0;</div>
<div class="line">    <span class="keywordtype">double</span> grad_part = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> decision_variable_i : decision_variables)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> decision_variable_j : decision_variables)</div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> temp_vector(<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i).size());</div>
<div class="line">            system_matrix.block(decision_variable_i, decision_variable_j)</div>
<div class="line">              .vmult(temp_vector, <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_j));</div>
<div class="line">            hess_part += <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i) * temp_vector;</div>
<div class="line">          }</div>
<div class="line">        grad_part -= system_rhs.block(decision_variable_i) *</div>
<div class="line">                     <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;unsigned int&gt; equality_constraint_multipliers = {</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>};</div>
<div class="line">    <span class="keywordtype">double</span> constraint_norm = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> multiplier_i : equality_constraint_multipliers)</div>
<div class="line">      constraint_norm += system_rhs.block(multiplier_i).linfty_norm();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> test_penalty_multiplier;</div>
<div class="line">    <span class="keywordflow">if</span> (hess_part &gt; 0)</div>
<div class="line">      test_penalty_multiplier =</div>
<div class="line">        (grad_part + .5 * hess_part) / (.05 * constraint_norm);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      test_penalty_multiplier = (grad_part) / (.05 * constraint_norm);</div>
<div class="line"> </div>
<div class="line">    penalty_multiplier = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(penalty_multiplier, test_penalty_multiplier);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;double, double&gt; max_step_sizes =</div>
<div class="line">      calculate_max_step_size(nonlinear_solution, <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> step_size_s = max_step_sizes.first;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> step_size_z = max_step_sizes.second;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SolutionBlocks::displacement</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>) *= step_size_z;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>) *= step_size_z;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>) *= step_size_z;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>) *= step_size_z;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a></div>
<div class="line">  SANDTopOpt&lt;dim&gt;::compute_scaled_step(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                                       <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;max_step,</div>
<div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">double</span> descent_requirement)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> merit_derivative =</div>
<div class="line">      (calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4 * max_step) -</div>
<div class="line">       calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>)) /</div>
<div class="line">      1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4;</div>
<div class="line">    <span class="keywordtype">double</span>       step_size                 = 1;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_linesearch_iterations = 10;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_linesearch_iterations; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> (calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + step_size * max_step) &lt;</div>
<div class="line">            calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) +</div>
<div class="line">              step_size * descent_requirement * merit_derivative)</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          step_size = step_size / 2;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + (step_size * max_step);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">bool</span> SANDTopOpt&lt;dim&gt;::check_convergence(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs      = calculate_test_rhs(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>              test_rhs_norm = test_rhs.<a class="code" href="classBlockVectorBase.html#a5253082a5591dc0d13fef1d65a3dbfae">l1_norm</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> convergence_condition = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-2;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> target_norm           = convergence_condition * barrier_size;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;    Checking convergence. Current rhs norm is &quot;</span></div>
<div class="line">              &lt;&lt; test_rhs_norm &lt;&lt; <span class="stringliteral">&quot;, target is &quot;</span> &lt;&lt; target_norm &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (test_rhs_norm &lt; target_norm);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::vector&lt;std::string&gt; solution_names(1, <span class="stringliteral">&quot;density&quot;</span>);</div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      data_component_interpretation(</div>
<div class="line">        1, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        solution_names.emplace_back(<span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line">        data_component_interpretation.push_back(</div>
<div class="line">          <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">      }</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;unfiltered_density&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        solution_names.emplace_back(<span class="stringliteral">&quot;displacement_multiplier&quot;</span>);</div>
<div class="line">        data_component_interpretation.push_back(</div>
<div class="line">          <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">      }</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;unfiltered_density_multiplier&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;low_slack&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;low_slack_multiplier&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;high_slack&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;high_slack_multiplier&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(nonlinear_solution,</div>
<div class="line">                             solution_names,</div>
<div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                             data_component_interpretation);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution&quot;</span> + <a class="code" href="group__Exceptions.html#ga72743302dcb1a0fb1f2f8dc5122d299e">std::to_string</a>(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>) + <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::write_as_stl()</div>
<div class="line">  {</div>
<div class="line">    static_assert(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2,</div>
<div class="line">                  <span class="stringliteral">&quot;This function is not implemented for anything &quot;</span></div>
<div class="line">                  <span class="stringliteral">&quot;other than the 2d case.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    std::ofstream stlfile;</div>
<div class="line">    stlfile.open(<span class="stringliteral">&quot;bridge.stl&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;solid bridge\n&quot;</span> &lt;&lt; <a class="code" href="table__handler__0_8txt.html#ac42f579ca4a40d2835c1abb1cb95121d">std::scientific</a>;</div>
<div class="line">    <span class="keywordtype">double</span> height = .25;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> (nonlinear_solution.block(</div>
<div class="line">              <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()] &gt; 0.5)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> edge_directions[2] = {<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1) -</div>
<div class="line">                                                         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0),</div>
<div class="line">                                                       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2) -</div>
<div class="line">                                                         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)};</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> edge_tensor(</div>
<div class="line">              {{edge_directions[0][0], edge_directions[0][1]},</div>
<div class="line">               {edge_directions[1][0], edge_directions[1][1]}});</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">bool</span> is_right_handed_cell = (<a class="code" href="mapping__q__internal__0_8txt.html#a7a28370132a1e8adca9c727413c710b4">determinant</a>(edge_tensor) &gt; 0);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (is_right_handed_cell)</div>
<div class="line">              {</div>
<div class="line">                <span class="comment">/* Write one side at z = 0. */</span></div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Write one side at z = height. */</span></div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="comment">/* The cell has a left-handed set up */</span></div>
<div class="line">              {</div>
<div class="line">                <span class="comment">/* Write one side at z = 0. */</span></div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Write one side at z = height. */</span></div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_number = 0;</div>
<div class="line">                 face_number &lt; GeometryInfo&lt;dim&gt;::faces_per_cell;</div>
<div class="line">                 ++face_number)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::face_iterator <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> =</div>
<div class="line">                  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face(face_number);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary()) ||</div>
<div class="line">                    (!<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                     (nonlinear_solution.block(</div>
<div class="line">                        0)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;neighbor(face_number)-&gt;active_cell_index()] &lt;</div>
<div class="line">                      0.5)))</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> normal_vector =</div>
<div class="line">                      (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center() - <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center());</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> normal_norm = normal_vector.<a class="code" href="classTensor.html#afd0934b4edd71063f66a9c67540e79fc">norm</a>();</div>
<div class="line">                    <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) *</div>
<div class="line">                            0.000000<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>+00 +</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) * (0 - 0) *</div>
<div class="line">                            normal_vector[0] +</div>
<div class="line">                          (height - 0) *</div>
<div class="line">                            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                            normal_vector[1] -</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) * (0 - 0) *</div>
<div class="line">                            normal_vector[1] -</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) *</div>
<div class="line">                            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                            normal_vector[0] -</div>
<div class="line">                          (height - 0) *</div>
<div class="line">                            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) * 0 &gt;</div>
<div class="line">                        0)</div>
<div class="line">                      {</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                      }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                      {</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;endsolid bridge&quot;</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">SANDTopOpt&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;filter r is: &quot;</span> &lt;&lt; filter_r &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;setup&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">create_triangulation</a>();</div>
<div class="line"> </div>
<div class="line">      dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">      <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">      setup_boundary_values();</div>
<div class="line">      setup_block_system();</div>
<div class="line">      setup_filter_matrix();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    barrier_size                  = 25;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> min_barrier_size = .0005;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_uphill_steps    = 8;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       descent_requirement = .0001;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       iteration_number = 0;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_iterations   = 10000;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Starting outer step in iteration &quot;</span> &lt;&lt; iteration_number</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot; with barrier parameter &quot;</span> &lt;&lt; barrier_size &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">do</span></div>
<div class="line">          {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;  Starting inner step in iteration &quot;</span></div>
<div class="line">                      &lt;&lt; iteration_number</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot; with merit function penalty multiplier &quot;</span></div>
<div class="line">                      &lt;&lt; penalty_multiplier &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">bool</span> watchdog_step_found = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> watchdog_state = nonlinear_solution;</div>
<div class="line">            <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a>       first_step;</div>
<div class="line">            <span class="keywordtype">double</span> target_merit     = numbers::signaling_nan&lt;double&gt;();</div>
<div class="line">            <span class="keywordtype">double</span> merit_derivative = numbers::signaling_nan&lt;double&gt;();</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_uphill_steps; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                ++iteration_number;</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> update_step = find_max_step();</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> == 0)</div>
<div class="line">                  {</div>
<div class="line">                    first_step = update_step;</div>
<div class="line">                    merit_derivative =</div>
<div class="line">                      ((calculate_exact_merit(watchdog_state +</div>
<div class="line">                                              .0001 * first_step) -</div>
<div class="line">                        calculate_exact_merit(watchdog_state)) /</div>
<div class="line">                       .0001);</div>
<div class="line">                    target_merit = calculate_exact_merit(watchdog_state) +</div>
<div class="line">                                   descent_requirement * merit_derivative;</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                nonlinear_solution += update_step;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> current_merit =</div>
<div class="line">                  calculate_exact_merit(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;    current watchdog state merit is: &quot;</span></div>
<div class="line">                          &lt;&lt; current_merit &lt;&lt; <span class="stringliteral">&quot;; target merit is &quot;</span></div>
<div class="line">                          &lt;&lt; target_merit &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (current_merit &lt; target_merit)</div>
<div class="line">                  {</div>
<div class="line">                    watchdog_step_found = <span class="keyword">true</span>;</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;    found workable step after &quot;</span> &lt;&lt; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> + 1</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; iterations&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (watchdog_step_found == <span class="keyword">false</span>)</div>
<div class="line">              {</div>
<div class="line">                ++iteration_number;</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> update_step = find_max_step();</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> stretch_state =</div>
<div class="line">                  compute_scaled_step(nonlinear_solution,</div>
<div class="line">                                      update_step,</div>
<div class="line">                                      descent_requirement);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> ((calculate_exact_merit(nonlinear_solution) &lt;</div>
<div class="line">                     calculate_exact_merit(watchdog_state)) ||</div>
<div class="line">                    (calculate_exact_merit(stretch_state) &lt; target_merit))</div>
<div class="line">                  {</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;    Taking scaled step from end of watchdog&quot;</span></div>
<div class="line">                              &lt;&lt; std::endl;</div>
<div class="line">                    nonlinear_solution = stretch_state;</div>
<div class="line">                  }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                  {</div>
<div class="line">                    std::cout</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot;    Taking scaled step from beginning of watchdog&quot;</span></div>
<div class="line">                      &lt;&lt; std::endl;</div>
<div class="line">                    <span class="keywordflow">if</span> (calculate_exact_merit(stretch_state) &gt;</div>
<div class="line">                        calculate_exact_merit(watchdog_state))</div>
<div class="line">                      {</div>
<div class="line">                        nonlinear_solution =</div>
<div class="line">                          compute_scaled_step(watchdog_state,</div>
<div class="line">                                              first_step,</div>
<div class="line">                                              descent_requirement);</div>
<div class="line">                      }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                      {</div>
<div class="line">                        ++iteration_number;</div>
<div class="line">                        nonlinear_solution = stretch_state;</div>
<div class="line">                        <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> stretch_step =</div>
<div class="line">                          find_max_step();</div>
<div class="line">                        nonlinear_solution =</div>
<div class="line">                          compute_scaled_step(nonlinear_solution,</div>
<div class="line">                                              stretch_step,</div>
<div class="line">                                              descent_requirement);</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            output_results(iteration_number);</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">while</span> ((iteration_number &lt; max_iterations) &amp;&amp;</div>
<div class="line">               (check_convergence(nonlinear_solution) == <span class="keyword">false</span>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> barrier_size_multiplier = .8;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> barrier_size_exponent   = 1.2;</div>
<div class="line"> </div>
<div class="line">        barrier_size =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(barrier_size * barrier_size_multiplier,</div>
<div class="line">                            std::pow(barrier_size, barrier_size_exponent)),</div>
<div class="line">                   min_barrier_size);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (((barrier_size &gt; min_barrier_size) ||</div>
<div class="line">            (check_convergence(nonlinear_solution) == <span class="keyword">false</span>)) &amp;&amp;</div>
<div class="line">           (iteration_number &lt; max_iterations));</div>
<div class="line"> </div>
<div class="line">    write_as_stl();</div>
<div class="line">    timer.<a class="code" href="classTimerOutput.html#a133e7d844826bc8716898fb2f86fb9b6">print_summary</a>();</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace SAND</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classSAND_1_1SANDTopOpt.html">SAND::SANDTopOpt&lt;2&gt;</a> elastic_problem_2d;</div>
<div class="line">      elastic_problem_2d.<a class="code" href="classSAND_1_1SANDTopOpt.html#a1ab26b7b2bb38e7f74a85a5c729484e4">run</a>();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><br  />
 This tutorial depends on <a class="el" href="step_8.html">step-8</a> , <a class="el" href="step_15.html">step-15</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#SolidIsotropicMaterialwithPenalization">Solid Isotropic Material with Penalization</a><a href="#SolidIsotropicMaterialwithPenalization">Solid Isotropic Material with Penalization</a>
        <li><a href="#ElasticityEquation">Elasticity Equation</a><a href="#ElasticityEquation">Elasticity Equation</a>
        <li><a href="#Makingthesolutionmeshindependent">Making the solution mesh-independent</a><a href="#Makingthesolutionmeshindependent">Making the solution mesh-independent</a>
        <li><a href="#CompleteProblemFormulation">Complete Problem Formulation</a><a href="#CompleteProblemFormulation">Complete Problem Formulation</a>
        <li><a href="#Solutionprocedure">Solution procedure</a><a href="#Solutionprocedure">Solution procedure</a>
        <li><a href="#Discretization">Discretization</a><a href="#Discretization">Discretization</a>
        <li><a href="#NonlinearAlgorithm">Nonlinear Algorithm</a><a href="#NonlinearAlgorithm">Nonlinear Algorithm</a>
        <li><a href="#MeritFunction">Merit Function</a><a href="#MeritFunction">Merit Function</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Preliminaries">Preliminaries</a><a href="#Preliminaries">Preliminaries</a>
        <li><a href="#TheSANDTopOptmainclass">The SANDTopOpt main class</a><a href="#TheSANDTopOptmainclass">The SANDTopOpt main class</a>
        <li><a href="#Constructorandsetupfunctions">Constructor and set-up functions</a><a href="#Constructorandsetupfunctions">Constructor and set-up functions</a>
        <li><a href="#Settingupblockmatricesandvectors">Setting up block matrices and vectors</a><a href="#Settingupblockmatricesandvectors">Setting up block matrices and vectors</a>
        <li><a href="#Creatingthefiltermatrix">Creating the filter matrix</a><a href="#Creatingthefiltermatrix">Creating the filter matrix</a>
        <li><a href="#AssemblingtheNewtonmatrix">Assembling the Newton matrix</a><a href="#AssemblingtheNewtonmatrix">Assembling the Newton matrix</a>
        <li><a href="#SolvingtheNewtonlinearsystem">Solving the Newton linear system</a><a href="#SolvingtheNewtonlinearsystem">Solving the Newton linear system</a>
        <li><a href="#Detailsoftheoptimizationalgorithm">Details of the optimization algorithm</a><a href="#Detailsoftheoptimizationalgorithm">Details of the optimization algorithm</a>
      <ul>
        <li><a href="#Computingsteplengths">Computing step lengths</a><a href="#Computingsteplengths">Computing step lengths</a>
        <li><a href="#Computingresiduals">Computing residuals</a><a href="#Computingresiduals">Computing residuals</a>
        <li><a href="#Computingthemeritfunction">Computing the merit function</a><a href="#Computingthemeritfunction">Computing the merit function</a>
        <li><a href="#Findingasearchdirection">Finding a search direction</a><a href="#Findingasearchdirection">Finding a search direction</a>
        <li><a href="#Computingascaledstep">Computing a scaled step</a><a href="#Computingascaledstep">Computing a scaled step</a>
        <li><a href="#Checkingforconvergence">Checking for convergence</a><a href="#Checkingforconvergence">Checking for convergence</a>
      </ul>
        <li><a href="#Postprocessingthesolution">Postprocessing the solution</a><a href="#Postprocessingthesolution">Postprocessing the solution</a>
        <li><a href="#Therunfunctiondrivingtheoverallalgorithm">The run() function driving the overall algorithm</a><a href="#Therunfunctiondrivingtheoverallalgorithm">The run() function driving the overall algorithm</a>
        <li><a href="#Themainfunction">The main function</a><a href="#Themainfunction">The main function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#TestProblem">Test Problem</a><a href="#TestProblem">Test Problem</a>
      <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>Topology Optimization of Elastic Media is a technique used to optimize astructure that is bearing some load. Ideally, we would like to minimize themaximum stress placed on a structure by selecting a region \(E\) where material isplaced. In other words, </p><p class="formulaDsp">
\[ \text{minimize}\| \boldsymbol{\sigma} (\mathbf{u}) \|_\infty \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } |E|\leq V_{\max}, \]
</p>
 <p class="formulaDsp">
\[ \text{and } \nabla \cdot \boldsymbol{\sigma} + \mathbf{F} = \mathbf{0}. \]
</p>
<p> Here, \(\boldsymbol{\sigma} = \mathbf{C} : \boldsymbol{\varepsilon}(\mathbf{u})\) is the stresswithin the body that is caused by the external forces \(\mathbf F\) , where we have for simplicity assumedthat the material is linear-elastic and so \(\mathbf{C}\) is the stress-strain tensor and \(\boldsymbol{\varepsilon}(\mathbf{u})=\frac{1}{2} (\nabla \mathbf{u} + (\nabla\mathbf{u})^T)\) is thesmall-deformation strain as a function of the displacement \(\mathbf{u}\) <br  />
</p>
<ul>
<li>see <a class="el" href="step_8.html">step-8</a> and <a class="el" href="step_17.html">step-17</a> for more on linear elasticity. In the formulation above, \(V_\text{max}\) is the maximal amount of material we are willing to provide tobuild the object. The last of the constraints is the partial differentialequation that relates stress \(\boldsymbol{\sigma}\) and forces \(\mathbf F\) and is simply thesteady-state force balance. That said, the infinity norm above creates a problem: As a function of locationof material, this objective function is necessarily not differentiable, makingprospects of optimization rather bleak. So instead, a common approach intopology optimization is to find an approximate solution by optimizing a relatedproblem: We would like to minimize the strain energy. This is ameasure of the potential energy stored in an object due to its deformation, butalso works as a measure of total deformation over the structure. <p class="formulaDsp">
\[ \text{minimize } \int_E \frac{1}{2}\boldsymbol{\sigma} : \boldsymbol{\varepsilon} dV \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } \|E\| \leq V_{\max} \]
</p>
 <p class="formulaDsp">
\[ \text{and } \nabla \cdot \boldsymbol{\sigma} + \mathbf{F} = \mathbf{0} \]
</p>
 The value of the objective function is calculated using a finite element method,where the solution is the displacements. This is placed inside of a nonlinearsolver loop that solves for a vector denoting placement of material. <a class="anchor" id="SolidIsotropicMaterialwithPenalization"></a><h3>Solid Isotropic Material with Penalization</h3>
</li>
</ul>
<p>In actual practice, we can only build objects in which the material is eitherpresent, or not present, at any given point</p>
<ul>
<li>i.e., we would have an indicatorfunction \(\rho_E(\mathbf{x})\in \{0,1\}\) that describes the material-filledregion and that we want to find through the optimization problem. In this case,the optimization problem becomes combinatorial, and very expensive to solve.Instead, we use an approach called Solid Isotropic Material with Penalization,or SIMP. <b>[Bendse2004]</b> <br  />
 The SIMP method is based on an idea of allowing the material to exist in alocation with a density \(\rho\) between 0 and 1. A density of 0 suggests thematerial is not there, and it is not a part of the structure, while a density of1 suggests the material is present. Values between 0 and 1 do not reflect adesign we can create in the real-world, but allow us to turn the combinatorialproblem into a continuous one. One then looks at density values \(\rho\) ,with the constraint that \(0 &lt; \rho_{\min} \leq \rho \leq 1\) . The minimum value \(\rho_{\min}\) , typically chosen to be around \(10^{-3}\) , avoids the possibilityof having an infinite strain energy, but is small enough to provide accurateresults. The straightforward application of the effect of this "density" on theelasticity of the media would be to simply multiply the stiffness tensor \(\mathbf{C}_0\) of the medium by the given density, that is, \(\mathbf{C} = \rho \mathbf{C}_0\) . However, thisapproach often gives optimal solutions where density values are far from both 0and 1. As one wants to find a real-world solution, meaning the material eitheris present or it is not, a penalty is applied to these in-between values. Asimple and effective way to do this is to multiply the stiffness tensor by thedensity raised to some integer power penalty parameter \(p\) , so that \(\mathbf{C} = \rho^p \mathbf{C}_0\) . This makes density values farther away from 0 or 1 lesseffective. It has been shown that using \(p=3\) is sufficiently high to create'black-and-white' solutions: that is, one gets optimal solutions in whichmaterial is either present or not present at all points. More material should always provide a structure with a lower strain energy, and so theinequality constraint can be viewed as an equality where the total volume usedis the maximum volume. Using this density idea also allows us to reframe the volume constraint on theoptimization problem. Use of SIMP then turns the optimization problem into thefollowing: <p class="formulaDsp">
\[ \text{minimize } \int_\Omega \frac{1}{2}\boldsymbol{\sigma}(\rho) : \boldsymbol{\varepsilon}(\rho) d\Omega \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } \int_\Omega \rho(x) d\Omega= V_{\max}, \]
</p>
 <p class="formulaDsp">
\[ 0&lt;\rho_{\min}\leq \rho(x) \leq 1, \]
</p>
 <p class="formulaDsp">
\[ \nabla \cdot \boldsymbol{\sigma}(\rho) + \mathbf{F} = 0 \quad \text{on } \Omega \]
</p>
@_fakenlThe final constraint, the balance of linear momentum (which we will refer to as the elasticity equation), gives a method for finding \(\boldsymbol{\sigma}\) and \(\boldsymbol{\varepsilon}\) given the density \(\rho\) . <a class="anchor" id="ElasticityEquation"></a><h3>Elasticity Equation</h3>
</li>
</ul>
<p>The elasticity equation in the time independent limit reads </p><p class="formulaDsp">
\[ \nabla \cdot \boldsymbol{\sigma} + \mathbf{F} = \mathbf{0} . \]
</p>
<p>@_fakenlIn the situations we will care about, we will assume that the medium has a linear material responseand in that case, we have that </p><p class="formulaDsp">
\[ \boldsymbol{\sigma} = \mathbf{C} : \boldsymbol{\varepsilon} = \rho^p \mathbf{C}_0 : \boldsymbol{\varepsilon}(\mathbf{u}) = \rho^p \mathbf{C}_0 : \left[\frac{1}{2} (\nabla \mathbf{u} + (\nabla \mathbf{u})^T) \right] . \]
</p>
<p>@_fakenlIn everything we will do below, we will always consider the displacementfield \(\mathbf{u}\) as the only solution variable, rather than considering \(\mathbf{u}\) and \(\boldsymbol{\sigma}\) as solution variables (as is done in mixedformulations). Furthermore, we will make the assumption that the material is linear isotropic,in which case the stress-strain tensor can be expressed in terms of the Lam&eacute;parameters \(\lambda,\mu\) such that </p><p class="formulaDsp">
\begin{align} \boldsymbol{\sigma} &amp;= \rho^p (\lambda \text{tr}(\boldsymbol{\varepsilon}) \mathbf{I} + 2 \mu \boldsymbol{\varepsilon}) , \\ \sigma_{i,j} &amp;= \rho^p (\lambda \varepsilon_{k,k} \delta_{i,j} + 2 \mu \varepsilon_{i,j}) . \end{align}
</p>
<p> See <a class="el" href="step_8.html">step-8</a> for how this transformation works. Integrating the objective function by parts gives </p><p class="formulaDsp">
\[ \int_\Omega \boldsymbol{\sigma}(\rho) : (\nabla \mathbf{u} + (\nabla \mathbf{u}))^T d\Omega+ \int_\Omega (\nabla \cdot \boldsymbol{\sigma}(\rho)) \cdot \mathbf{u} d\Omega= \int_{\partial \Omega} \mathbf{t} \cdot \mathbf{u} d\partial\Omega , \]
</p>
<p>@_fakenlinto which the linear elasticity equation can then be substituted, giving </p><p class="formulaDsp">
\[ \int_\Omega \boldsymbol{\sigma}(\rho) : (\nabla \mathbf{u} + (\nabla \mathbf{u})^T) d\Omega = \int_\Omega \mathbf{F}\cdot \mathbf{u} d\Omega+ \int_{\partial \Omega} \mathbf{t} \cdot \mathbf{u} d\partial\Omega . \]
</p>
<p>@_fakenlBecause we are assuming no body forces, this simplifies further to </p><p class="formulaDsp">
\[ \int_\Omega \boldsymbol{\sigma}(\rho) : (\nabla \mathbf{u} + (\nabla \mathbf{u})^T) d\Omega = \int_{\partial \Omega} \mathbf{t} \cdot \mathbf{u} d\partial\Omega, \]
</p>
<p>@_fakenlwhich is the final form of the governing equation that we'll be consideringfrom this point forward. <a class="anchor" id="Makingthesolutionmeshindependent"></a></p><h3>Making the solution mesh-independent</h3>
<p>Typically, the solutions to topology optimization problems aremesh-dependent, and as such the problem is ill-posed. This is becausefractal structures are often formed as the mesh is refined further. As the mesh gainsresolution, the optimal solution typically gains smaller and smaller structures.There are a few competing workarounds to this issue, but the most popular forfirst order optimization is the sensitivity filter, while second orderoptimization methods tend to prefer use of a density filter. As the filters affect the gradient and Hessian of the strain energy (i.e., theobjective function), the choice of filter has an effect on the solution of theproblem. The density filter as part of a second order method works byintroducing an unfiltered density, which we refer to as \(\varrho\) , and thenrequiring that the density be a convolution of the unfiltered density: </p><p class="formulaDsp">
\[ \rho = H(\varrho). \]
</p>
<p>@_fakenlHere, \(H\) is an operator so that \(\rho(\mathbf{x})\) is some kind of average ofthe values of \(\varrho\) in the area around \(\mathbf{x}\)</p>
<ul>
<li>i.e., it is a smoothedversion of \(\varrho\) . This prevents checkerboarding; the radius of the filter allows the user todefine an effective minimal beam width for the optimal structures we seek tofind. <div style="text-align:center;"> <img src="https://www.dealii.org/images/steps/developer/step-79.checkerboard.png" alt="Checkerboarding occurring in an MBB Beam" class="inline"/> </div></li>
</ul>
<p><a class="anchor" id="CompleteProblemFormulation"></a></p><h3>Complete Problem Formulation</h3>
<p>The minimization problem is now </p><p class="formulaDsp">
\[ \min_{\rho,\varrho,\mathbf{u}} \int_{\partial\Omega} \mathbf{u} \cdot \mathbf{t} d\partial\Omega \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } \rho = H(\varrho) \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega \rho^p \left(\frac{\mu}{2}\left(\boldsymbol{\varepsilon}(\mathbf{v}): \boldsymbol{\varepsilon}(\mathbf{u})) \right) + \lambda \left( \nabla \cdot \mathbf{u} \nabla \cdot \mathbf{v} \right) \right) d\Omega = \int_{\partial \Omega} \mathbf{v} \cdot \mathbf{t} d\partial\Omega \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega \rho d\Omega= V \]
</p>
 <p class="formulaDsp">
\[ 0\leq \varrho \leq 1 \]
</p>
<p>The inequality constraints are dealt with by first introducing slack variables, and second using log barriers to ensure that we obtain an interior-point method. The penalty parameter is going to be \(\alpha\), and the following slack variables are </p><ol>
<li>
<p class="startli">\(s_1\)</p>
<ul>
<li>a slack variable corresponding to the lower bound </li>
</ul>
</li>
<li>
<p class="startli">\(s_2\)</p>
<ul>
<li>a slack variable corresponding to the upper bound. </li>
</ul>
</li>
</ol>
<p>This now gives the following problem: </p><p class="formulaDsp">
\[ \min_{\rho,\varrho,\mathbf{u}, s_1, s_2} \int_{\partial\Omega} \mathbf{u} \cdot \mathbf{t} d\partial\Omega- \alpha \int_\Omega \left(\log(s_1) + \log(s_2)\right) d\Omega \]
</p>
 <p class="formulaDsp">
\[ \text{subject to } \rho = H(\varrho) \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega \rho^p \left(\frac{\mu}{2}\left(\boldsymbol{\varepsilon}(\mathbf{v}): \boldsymbol{\varepsilon}(\mathbf{u})) \right) + \lambda \left( \nabla \cdot \mathbf{u} \nabla \cdot \mathbf{v} \right) \right) d\Omega = \int_{\partial \Omega} \mathbf{v} \cdot \mathbf{t} d\partial\Omega \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega \rho d\Omega = V \]
</p>
 <p class="formulaDsp">
\[ \varrho = s_1 \]
</p>
 <p class="formulaDsp">
\[ 1-\varrho = s_2 \]
</p>
<p>With these variables in place, we can then follow the usual approach to solving constrained optimization problems: We introduce a Lagrangian in which we combine the objective function and the constraints by multiplying the constraints by Lagrange multipliers. Specifically, we will use the following symbols for the Lagrange multipliers for the various constraints: </p><ol>
<li>
\(\mathbf{y}_1 \): a Lagrange multiplier corresponding to the elasticity constraint,  </li>
<li>
\(y_2\): a Lagrange multiplier corresponding to the convolution filter constraint,  </li>
<li>
\(z_1\): a Lagrange multiplier corresponding to the lower slack variable, and  </li>
<li>
\(z_2\): a Lagrange multiplier corresponding to the upper slack variable.  </li>
</ol>
<p>With these variables, the Lagrangian function reads as follows:</p>
<p class="formulaDsp">
\begin{align} \mathcal{L} =&amp; \int_{\partial\Omega} \mathbf{u} \cdot \mathbf{t} d\partial\Omega - \alpha \int_\Omega \left(\log(s_1) + \log(s_2)\right) d\Omega- \int_\Omega \rho^p \left(\frac{\mu}{2}\left(\boldsymbol{\varepsilon}(\mathbf{y}_1):\boldsymbol{\varepsilon}(\mathbf{u})) \right) + \lambda \left( \nabla \cdot \mathbf{u} \nabla \cdot \mathbf{y}_1 \right)\right) d\Omega - \int_{\partial \Omega} \mathbf{y}_1 \cdot \mathbf{t} d\partial\Omega \\ &amp; -\int_\Omega y_2 (\rho - H(\varrho)) d\Omega - \int_\Omega z_1 (\varrho-s_1) d\Omega - \int_\Omega z_2 (1 - s_2 -\varrho) d\Omega \end{align}
</p>
<p>The solution of the optimization problem then needs to satisfy what are known as the <a href="https://en.wikipedia.org/wiki/Karush%E2%80%93Kuhn%E2%80%93Tucker_conditions">Karush-Kuhn-Tucker (KKT) conditions</a>: The derivatives of the Lagrangian with respect to all of its arguments need to be equal to zero, and because we have inequality constraints, we also have "complementarity" conditions. Since we here have an infinite-dimensional problem, these conditions all involve directional derivatives of the Lagrangian with regard to certain test functions</p>
<p>&ndash; in other words, all of these conditions have to be stated in weak form as is typically the basis for finite element methods anyway.</p>
<p>The barrier method allows us to initially weaken the "complementary slackness" as required by the typical KKT conditions. Typically, we would require that \(s_i z_i = 0\), but the barrier formulations give KKT conditions where \(s_i z_i = \alpha\), where \(\alpha\) is our barrier parameter. As part of the barrier method, this parameter must be driven close to 0 to give a good approximation of the original problem.</p>
<p>In the following, let us state all of these conditions where \(d_{\{\bullet\}}\) is a test function that is naturally paired with variational derivatives of the Lagrangian with respect to the \(\{\bullet\}\) function. For simplicity, we introduce \(\Gamma\) to indicate the portion of the boundary where forces are applied, and Neumann boundary conditions are used.</p>
<ol>
<li>
Stationarity: <p class="formulaDsp">
\[ \int_\Omega - d_\rho y_2 + p\rho^{p-1}d_\rho \left[\lambda (\nabla \cdot \mathbf{y}_1) (\nabla \cdot \mathbf{u}) + \mu \boldsymbol{\varepsilon}(\mathbf{u}):\boldsymbol{\varepsilon}(\mathbf{y}_1)\right] d\Omega=0\;\; \forall d_\rho \]
</p>
 <p class="formulaDsp">
\[ \int_\Gamma \mathbf d_\mathbf{u} \cdot \mathbf{t} d\partial\Omega+ \int_\Omega p\rho^{p} \left[\lambda (\nabla \cdot \mathbf d_\mathbf{u})( \nabla \cdot \mathbf{y}_1) + \mu \boldsymbol{\varepsilon}(\mathbf d_\mathbf{u}):\boldsymbol{\varepsilon}(\mathbf{y}_1)\right] d\Omega=0\;\; \forall \mathbf{d}_\mathbf{u} \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega -d_\varrho z_1 + d_\varrho z_2 + H(d_\varrho)y_2 d\Omega= 0\;\;\forall d_\varrho \]
</p>
  </li>
<li>
Primal Feasibility: <p class="formulaDsp">
\[ \int_\Omega \rho^{p}\lambda (\nabla \cdot \mathbf d_{\mathbf{y}_1}) (\nabla \cdot \mathbf{u}) + \rho^{p}\mu \boldsymbol{\varepsilon}(\mathbf d_{\mathbf{y}_1}) : \boldsymbol{\varepsilon}(\mathbf{u}) d\Omega - \int_\Gamma \mathbf d_{\mathbf{y}_1} \cdot \mathbf{t} d\partial\Omega =0 \;\;\forall \mathbf{d}_{\mathbf{y}_1} \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega d_{z_1}(\varrho - s_1) d\Omega = 0\;\;\forall d_{z_1} \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega d_{z_z}(1-\varrho-s_2) d\Omega = 0\;\;\forall d_{z_2} \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega d_{y_2}(\rho - H(\varrho)) d\Omega = 0\;\;\forall d_{y_2} \]
</p>
  </li>
<li>
Complementary Slackness: <p class="formulaDsp">
\[ \int_\Omega d_{s_1}(s_1z_1 - \alpha) d\Omega = 0 \;\;\forall d_{s_1} ,\;\;\; \alpha \to 0 \]
</p>
 <p class="formulaDsp">
\[ \int_\Omega d_{s_2}(s_2z_2 - \alpha) d\Omega = 0 \;\;\forall d_{s_2} ,\;\;\; \alpha \to 0 \]
</p>
  </li>
<li>
Dual Feasibility: <p class="formulaDsp">
\[ s_{1,i},s_{2,i},z_{1,i},z_{2,i} \geq 0 \;\;\;\; \forall i \]
</p>
  </li>
</ol>
<p><a class="anchor" id="Solutionprocedure"></a></p><h3>Solution procedure</h3>
<p>The optimality conditions above are, in addition to being convoluted, of a kind that is not easy to solve: They are generally nonlinear, and some of the relationships are also inequalities. We will address the nonlinearity using a Newton method to compute search directions, and come back to how to deal with the inequalities below when talking about step length procedures.</p>
<p>Newton's method applied to the equations above results in the system of equations listed below. Therein, variational derivatives with respect to the \(\{\bullet\}\) variable are taken in the \(c_{\{\bullet\}}\) direction.</p>
<ol>
<li>
<p class="startli">Stationarity: These equations ensure we are at a critical point of the objective function when constrained.</p>
<p class="interli">Equation 1</p>
<p class="formulaDsp">
\begin{align} &amp;\int_\Omega-d_\rho c_{y_2} + p(p-1) \rho^{p-2} d_\rho c_\rho [\lambda \nabla \cdot \mathbf{y}_1 \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{y}_1)] + p \rho^{p-1} d_\rho[\lambda \nabla \cdot \mathbf{c}_{\mathbf{y}_1} \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon} (\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{c}_{\mathbf{y}_1})] + p \rho^{p-1} d_\rho [\lambda \nabla \cdot {\mathbf{y}_1} \nabla \cdot \mathbf{c}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{c}_\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{y}_1)] d\Omega \\ &amp;= -\int_\Omega -d_\rho z_1 + d_\rho z_2 - d_\rho y_2 + p\rho^{p-1}d_\rho [\lambda \nabla \cdot \mathbf{y}_1 \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon} (\mathbf{u})\boldsymbol{\varepsilon}(\mathbf{y}_1)] d\Omega \end{align}
</p>
<p class="interli">Equation 2</p>
<p class="formulaDsp">
\begin{align} &amp;\int_\Omega p \rho^{p-1} c_\rho [\lambda \nabla \cdot {\mathbf{y}_1} \nabla \cdot \mathbf{d}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{d}_\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{y})] + \rho^{p} [\lambda \nabla \cdot \mathbf{c}_{\mathbf{y}_1} \nabla \cdot \mathbf{d}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{d}_\mathbf{u})\boldsymbol{\varepsilon}(\mathbf{c}_{\mathbf{y}_1})] d\Omega \\ &amp;= -\int_\Gamma \mathbf{d}_\mathbf{u} \cdot \mathbf{t} -\int_\Omega \rho^{p} [\lambda \nabla \cdot \mathbf{y} \nabla \cdot \mathbf{d}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(d_\mathbf{u})\boldsymbol{\varepsilon}(\mathbf{y}_1)] d\Omega \end{align}
</p>
<p class="interli">Equation 3 </p><p class="formulaDsp">
\[ \int_\Omega - d_\varrho c_{z_1} +d_\varrho c_{z_2} + H(d_\varrho)c_{y_2} d\Omega = -\int_\Omega -d_\varrho z_1 + d_\varrho z_2 + H(d_\varrho)y_2 d\Omega \]
</p>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Primal Feasibility: These equations ensure the equality constraints are met.</p>
<p class="interli">Equation 4</p>
<p class="formulaDsp">
\begin{align} &amp;\int_\Omega p \rho^{p-1} c_p[\lambda \nabla \cdot \mathbf{d}_{\mathbf{y}_1} \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{d}_{\mathbf{y}_1})] + \rho^{p}[\lambda \nabla \cdot \mathbf{d}_{\mathbf{y}_1} \nabla \cdot \mathbf{c}_\mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{c}_\mathbf{u}) \boldsymbol{\varepsilon}(\mathbf{d}_{\mathbf{y}_1})] d\Omega \\ &amp;= -\int_\Omega \rho^{p}[\lambda \nabla \cdot \mathbf{d}_{\mathbf{y}_1} \nabla \cdot \mathbf{u} + \mu \boldsymbol{\varepsilon}(\mathbf{u}) \boldsymbol{\varepsilon} (\mathbf{d}_{\mathbf{y}_1})] + \int_\Gamma \mathbf{d}_{\mathbf{y}_1} \cdot \mathbf{t} d\partial\Omega \end{align}
</p>
<p class="interli">Equation 5 </p><p class="formulaDsp">
\[ -\int_\Omega d_{z_1}(c_\varrho - c_{s_1}) d\Omega=\int_\Omega d_{z_1} (\varrho - s_1) d\Omega \]
</p>
<p class="interli">Equation 6 </p><p class="formulaDsp">
\[ -\int_\Omega d_{z_2}(-c_\varrho-c_{s_2}) d\Omega= \int_\Omega d_{z_2} (1-\varrho-s_2) d\Omega \]
</p>
<p class="interli">Equation 7 </p><p class="formulaDsp">
\[ -\int_\Omega d_{y_2}(c_\rho - H(c_\varrho)) d\Omega=\int_\Omega d_{y_2} (\rho - H(\varrho)) d\Omega \]
</p>
 <p class="endli"></p>
</li>
<li>
<p class="startli">Complementary Slackness: These equations essentially ensure the barrier is met</p>
<ul>
<li>in the final solution, we need \(s^T z = 0\).</li>
</ul>
<p class="interli">Equation 8 </p><p class="formulaDsp">
\[ \int_\Omega d_{s_1}(c_{s_1}z_1/s_1 + c_{z_1} ) d\Omega=-\int_\Omega d_{s_1} (z_1 - \alpha/s_1) d\Omega ,\;\;\; \alpha \to 0 \]
</p>
<p class="interli">Equation 9 </p><p class="formulaDsp">
\[ \int_\Omega d_{s_2} (c_{s_2}z_2/s_2 + c_{z_2} ) d\Omega=-\int_\Omega d_{s_2} (z_2 - \alpha/s_2) d\Omega,\;\;\; \alpha \to 0 \]
</p>
 <p class="endli"></p>
</li>
<li>
Dual Feasibility: The Lagrange multiplier on slacks and slack variables must be kept greater than 0. (This is the only part not implemented in the <code>SANDTopOpt::assemble_system()</code> function.) <p class="formulaDsp">
\[ s,z \geq 0 \]
</p>
  </li>
</ol>
<p><a class="anchor" id="Discretization"></a></p><h3>Discretization</h3>
<p>We use a quadrilateral mesh with \(Q_1\) elements to discretize the displacement and displacement Lagrange multiplier. Piecewise constant \(DGQ_0\) elements are used to discretize the density, unfiltered density, density slack variables, and multipliers for the slack variables and filter constraint.</p>
<p><a class="anchor" id="NonlinearAlgorithm"></a></p><h3>Nonlinear Algorithm</h3>
<p>While most of the discussion above follows traditional and well-known approaches to solving nonlinear optimization problems, it turns out that the problem is actually quite difficult to solve in practice. In particular, it is quite nonlinear and an important question is not just to find search directions \(c_{\{\bullet\}}\) as discussed above based on a Newton method, but that one needs to spend quite a lot of attention to how far one wants to go in this direction. This is often called "line search" and comes down to the question of how to choose the step length \(\alpha_k \in (0,1]\) so that we move from the current iterate \(\mathbf{x}_k\) to the next iterate \(\mathbf{x}_{k+1}=\mathbf{x}_k+\alpha_k \mathbf{x}_k\) in as efficient a way as possible. It is well understood that we need to eventually choose \(\alpha_k=1\) to realize the Newton's method's quadratic convergence; however, in the early iterations, taking such a long step might actually make things worse, either by leading to a point that has a worse objective function or at which the constraints are satisfied less well than they are at \(\mathbf{x}_k\).</p>
<p>Very complex algorithms have been proposed to deal with this issue <b>[Nocedal2009]</b> <b>[Waechter2005]</b>. Here, we implement a watchdog-search algorithm <b>[Nocedal2006]</b>. When discussing this algorithm, we will use the vector \(\mathbf{x}\) to represent all primal variables</p>
<ul>
<li>the filtered and unfiltered densities, slack variables and displacement</li>
<li>and use the vector \(\mathbf{y}\) to represent all of the dual vectors. The (incremental) solution to the nonlinear system of equations stated above will now be referred to as \(\Delta \mathbf{x}\) and \(\Delta \mathbf{y}\) instead of \(c_{\{\bullet\}}\). A merit function (explained in more detail later) is referred to here as \(\phi(\mathbf{x,\mathbf{y}})\).</li>
</ul>
<p>The watchdog algorithm applied to a subproblem with a given barrier parameter works in the following way: First, the current iteration is saved as a "watchdog" state, and the merit of the watchdog state is recorded. A maximal feasible Newton step is then taken. If the merit sufficiently decreased from the first step, this new step is accepted. If not, another maximal feasible Newton step is taken, and the merit is again compared to the watchdog merit. If after some number (typically between 5 and 8) of Newton steps, the merit did not adequately decrease, the algorithm takes a scaled Newton step from either the watchdog state or the last iteration that guarantees a sufficient decrease of the merit, and that step is accepted. Once a step is accepted, the norm of the KKT error is measured, and if it is sufficiently small, the barrier value is decreased. If it is not sufficiently small, the last accepted step is taken to be the new watchdog step, and the process is repeated.</p>
<p>Above, the "maximal feasible step" is a scaling of the Newton step in both the primal and dual variables given by</p>
<p class="formulaDsp">
\[ \beta^\mathbf{y} = \min\{1,\max \beta \text{ such that }\left(\mathbf{z}_{k+i} + \beta^\mathbf{z}_{k+i} \Delta \mathbf{z}_{k+i}\right)_j \geq \zeta \mathbf{z}_{k+i,j} \forall j\} \]
</p>
 <p class="formulaDsp">
\[ \beta^\mathbf{x} = \min\{1,\max \beta \text{ such that }\left(\mathbf{s}_{k+i} + \beta^\mathbf{s}_{k+i} \Delta \mathbf{s}_{k+i}\right)_j \geq \zeta \mathbf{s}_{k+i,j} \forall j\} \]
</p>
<p>Above, \(\zeta\) is the "fraction to boundary" that is allowed on any step. Because the derivatives become ill-conditioned near the boundary, this technique stands in for a <a href="https://en.wikipedia.org/wiki/Trust_region">trust region</a> and is necessary to ensure good approximations in the future. \(\zeta\) is taken to be \(\max\{0.8, 1-\alpha\}\), which allows movement closer to the boundary as the barrier becomes smaller. In the future, when implementing the LOQO algorithm for barrier reduction, this must be kept to 0.8 as the barrier parameter can vary wildly.</p>
<p>Separately, we need to deal with the log-barrier that we have used to enforce the positivity constraint on the slack variables \(s_1,s_2\): In the statement of the final optimization problem we solve, we have added the term </p><p class="formulaDsp">
\[ -\alpha \int_\Omega (\log(s_1) + \log(s_2)) d\Omega. \]
</p>
<p> The question is how we should choose the penalty factor \(\alpha\). As with all penalty methods, we are in reality only interested in the limit as \(\alpha\to 0\), since this is then the problem we really wanted to solve, subject to the positivity constraints on the slack variables. On the other hand, we need to choose \(\alpha\) large enough to make the problem solvable in practice. Actual implementations therefore start with a larger value of \(\alpha\) and gradually decrease it as the outer iterations proceed.</p>
<p>In the monotone method implemented here, the barrier parameter is updated whenever some level of convergence is achieved at the current barrier parameter. We use the \(l_\infty\) norm of the KKT conditions to check for convergence at each barrier size. The requirement is that \(\|KKT\|_{l_\infty} &lt; c \cdot \alpha\) where \(c\) is a constant over any barrier size and \(\alpha\) is the barrier parameter. This forces better convergence in later iterations, and is the same requirement as is used in <a href="https://coin-or.github.io/Ipopt/">IPOPT</a> (an open source software package for large-scale nonlinear optimization).</p>
<p>Here, the barrier is reduced linearly at larger values, and superlinearly at smaller values. At larger values, it is multiplied by a constant (around 0.6), and at lower values the barrier value is replaced by the barrier value raised to some exponent (around 1.2). This method has proven to be effective at keeping the subproblem solvable at large barrier values, while still allowing superlinear convergence at smaller barrier values. In practice, this looks like the following: </p><p class="formulaDsp">
\[ \alpha_{k+1} = \min\{\alpha_k^{1.2},0.6\alpha_k\} \]
</p>
<p>While taking large steps at reducing the barrier size when convergence is reached is widely used, more recent research has shown that it is typically faster to use algorithms that adaptively update barrier each iteration, i.e., methods in which we use concrete criteria at the end of each iteration to determine what the penalty parameter should be in the next iteration, rather than using reduction factors that are independent of the current solution. That said, such methods are also more complicated and we will not do this here.</p>
<p><a class="anchor" id="MeritFunction"></a></p><h3>Merit Function</h3>
<p>The algorithm outlined above makes use of a "merit function". Merit functions are used to determine whether a step from \(x_k\) to a proposed point \(x_{k+1}\) is beneficial. In unconstrained optimization problems, one can simply check this with the objective function we try to minimize, and typically uses conditions such as the <a href="https://en.wikipedia.org/wiki/Wolfe_conditions">Wolfe and Goldstein conditions</a>.</p>
<p>In constrained optimization problems, the question is how to balance reduction in the objective function against a possible increase in the violation of constraints: A proposed step might make the objective function smaller but be further away from the set of points that satisfy the constraints</p>
<p>&ndash; or the other way around. This trade-off is typically resolved by using a merit function that combines the two criteria.</p>
<p>Here, we use an exact \(l_1\) merit function to test the steps:</p>
<p class="formulaDsp">
\begin{align} \phi(\mathbf{x},\mathbf{y}) =&amp; \int_{\partial \Omega} \mathbf{u}\cdot \mathbf{t} d\partial\Omega- \alpha \int_\Omega (\log(s_1) + \log(s_2)) + p \sum_i\left| \int_\Omega y_{2,i}(H(\varrho) - \rho) d\Omega \right| \\ &amp; + p \sum_i\left| \int_{\partial \Omega} \mathbf{y}_{1,i}\cdot \mathbf{t} d\partial\Omega - \int_\Omega \rho^p[\lambda \nabla \cdot \mathbf{u} \nabla \cdot \mathbf{y}_{1,i} + \mu \boldsymbol{\varepsilon}{\mathbf{u}}\boldsymbol{\varepsilon}{\mathbf{y}_{1,i}}] d\Omega \right| + p \sum_i\left| \int_\Omega z_{1,i}(s_1 - \varrho) d\Omega\right| + p \sum_i\left| \int_\Omega z_{2,i}(1-\varrho - s_2) d\Omega\right| \end{align}
</p>
<p>Here, \(p\) is a penalty parameter. This merit function being exact means that there exists some \(p_0\) so that for any \(p &gt; p_0\), the merit function has its minima at the same location as the original problem. This penalty parameter is updated (by recommendation of Nocedal and Wright <b>[Benson2002]</b>) as follows: </p><p class="formulaDsp">
\[ p &gt; \frac{\frac{1}{2} \mathbf{x}^T \cdot \mathbf{H} \cdot \mathbf{x} - \mathbf{x}^T \cdot \nabla f}{\|c_i\|_{l_\infty}} \quad , i \in \mathcal{E}, \]
</p>
<p> where \(\mathbf{H}\) is the Hessian of the objective function, \(\mathbf{x}\) is a vector of our decision (primal) variables, \(f\) is the objective function, and \(c_i\) is the error on a current equality constraint.</p>
<p>Our use of this method is partially due to already having most of the necessary parts calculated in finding the right hand side, but also the use of an exact merit function ensures that it is minimized in the same location as the overall problem. Recent research has shown that one can replace merit functions by what are called "filter methods", and one should consider using these instead as they prove to be more efficient.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Preliminaries"></a> </p><h3>Preliminaries</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2tensor_8h.html">deal.II/base/tensor.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2signaling__nan_8h.html">deal.II/base/signaling_nan.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparse__matrix_8h.html">deal.II/lac/block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2linear__operator_8h.html">deal.II/lac/linear_operator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2packaged__operation_8h.html">deal.II/lac/packaged_operation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgq_8h.html">deal.II/fe/fe_dgq.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
</div><!-- fragment --><p>Above are fairly common files to include. These also include the one for the sparse direct class <a class="el" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a>. This is not the most efficient way to solve large linear problems, but it will do for now.</p>
<p>As usual, we put everything into a common namespace. We then start by declaring a number of symbolic names for constants that will be used throughout this tutorial. Specifically, we have alot* of variables in this program (of course the density and the displacement, but also the unfiltered density and quite a number of Lagrange multipliers). It is easy to forget which of these variables is at which position in the solution vector, and trying to use numbers for these vector components is a prescription for bugs. Rather, we define static variables that can be used in all of these places and that have to be initialized only once. In practice, this will lead to some lengthy expressions, but they are more readable and less likely to be wrong.</p>
<p>A similar issue arises with the ordering of blocks in the system matrix and in vectors. The matrices have \(9\times 9\) blocks, and it's difficult to remember which is which. It is far easier to just use symbolic names for those as well.</p>
<p>Finally, while we're at it, we introduce symbolic names also for the boundary indicators we will use, in the same spirit as was done in <a class="el" href="step_19.html">step-19</a>.</p>
<p>In all of these cases, we declare these variables as members in a namespace. In the case of the solution components, the concrete values of these variables depend on the space dimension, so we use <a href="https://en.cppreference.com/w/cpp/language/variable_template">template variables</a> to make the value of the variable depend on a template argument in the same way as we often use template functions.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceSAND.html">SAND</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p>This namespace keeps track of the first component in our finite element system that corresponds to each variable.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>SolutionComponents</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a> = 0;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">displacement</a> = 1;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a> = 1 + <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">displacement_multiplier</a> = 2 + <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a> = 2 + 2 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a> = 3 + 2 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a> = 4 + 2 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a> = 5 + 2 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a> = 6 + 2 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">} <span class="comment">// namespace SolutionComponents</span></div>
</div><!-- fragment --><p>This is the namespace which keeps track of which block corresponds to which variable.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>SolutionBlocks</div>
<div class="line">{</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>                        = 0;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">displacement</a>                   = 1;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a>             = 2;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">displacement_multiplier</a>        = 3;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a>  = 4;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a>            = 5;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a> = 6;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a>            = 7;</div>
<div class="line">  constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a> = 8;</div>
<div class="line">} <span class="comment">// namespace SolutionBlocks</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>BoundaryIds</div>
<div class="line">{</div>
<div class="line">  constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">down_force</a> = 101;</div>
<div class="line">  constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">no_force</a>   = 102;</div>
<div class="line">} <span class="comment">// namespace BoundaryIds</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>ValueExtractors</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ac221049fbb9ba83a17d1078474c4a747">densities</a>(SolutionComponents::density&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a8cd7076dfb3722290a423c54fc25f28d">displacements</a>(SolutionComponents::displacement&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ae502a219c72947e0c0abc6bc5d318a11">unfiltered_densities</a>(SolutionComponents::unfiltered_density&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a75b37471806be11bfd15238908ef2570">displacement_multipliers</a>(</div>
<div class="line">    SolutionComponents::displacement_multiplier&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a07e1e8cad70f4d40499893eb4e603205">unfiltered_density_multipliers</a>(</div>
<div class="line">    SolutionComponents::unfiltered_density_multiplier&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a149b969d62b110112ced6d4a4a467494">density_lower_slacks</a>(SolutionComponents::density_lower_slack&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ada143f177c93011d19b9753f7af32d57">density_lower_slack_multipliers</a>(</div>
<div class="line">    SolutionComponents::density_lower_slack_multiplier&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">    <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a30f363fe7c63c168353b72e3a2dd28c4">density_upper_slacks</a>(SolutionComponents::density_upper_slack&lt;dim&gt;);</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#af74f3b334f9c0a375c5b7afd07335505">density_upper_slack_multipliers</a>(</div>
<div class="line">    SolutionComponents::density_upper_slack_multiplier&lt;dim&gt;);</div>
<div class="line">} <span class="comment">// namespace ValueExtractors</span></div>
</div><!-- fragment --><p><a class="anchor" id="TheSANDTopOptmainclass"></a> </p><h3>The SANDTopOpt main class</h3>
<p>Next up is the main class for this problem. The majority of functions follow the usual naming schemes of tutorial programs, though there are a couple that have been broken out of what is usually called the <code>setup_system()</code> function because of their length, and there are also a number that deal with various aspects of the optimization algorithm.</p>
<p>As an added bonus, the program writes the computed design as an STL file that one can, for example, send to a 3d printer.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>SANDTopOpt</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SANDTopOpt();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">create_triangulation</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> setup_boundary_values();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> setup_block_system();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> setup_filter_matrix();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">  std::pair&lt;double, double&gt;</div>
<div class="line">  calculate_max_step_size(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                          <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a></div>
<div class="line">  calculate_test_rhs(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> calculate_exact_merit(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> find_max_step();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> compute_scaled_step(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                                          <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>,</div>
<div class="line">                                          <span class="keyword">const</span> <span class="keywordtype">double</span> descent_requirement);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> check_convergence(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> write_as_stl();</div>
<div class="line"> </div>
<div class="line">  std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt;</div>
<div class="line">  find_relevant_neighbors(</div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) <span class="keyword">const</span>;</div>
</div><!-- fragment --><p>Most of the member variables are also standard. There are, however, a number of variables that are specifically related to the optimization algorithm (such the various scalar factors below) as well as the filter matrix to ensure that the design remains smooth.</p>
<div class="fragment"><div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">  std::map&lt;types::global_dof_index, double&gt; boundary_values;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line">  <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      filter_sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> filter_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> system_rhs;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> nonlinear_solution;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> density_ratio;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> density_penalty_exponent;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> filter_r;</div>
<div class="line">  <span class="keywordtype">double</span>       penalty_multiplier;</div>
<div class="line">  <span class="keywordtype">double</span>       barrier_size;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTimerOutput.html">TimerOutput</a> timer;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="Constructorandsetupfunctions"></a> </p><h3>Constructor and set-up functions</h3>
<p>We initialize a <a class="el" href="classFESystem.html">FESystem</a> composed of 2 \(\times\)dim <code><a class="el" href="classFE__Q.html">FE_Q(1)</a></code> elements for the displacement variable and its Lagrange multiplier, and 7 <code><a class="el" href="classFE__DGQ.html">FE_DGQ(0)</a></code> elements. These piecewise constant functions are for density-related variables: the density itself, the unfiltered density, the slack variables for the lower and upper bounds on the unfiltered density, and then Lagrange multipliers for the connection between filtered and unfiltered densities as well as for the inequality constraints.</p>
<p>The order in which these elements appear is documented above.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">SANDTopOpt&lt;dim&gt;::SANDTopOpt()</div>
<div class="line">  : <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(<a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">       1,</div>
<div class="line">       (<a class="code" href="classFESystem.html">FESystem</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1) ^ <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)),</div>
<div class="line">       1,</div>
<div class="line">       <a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">       1,</div>
<div class="line">       (<a class="code" href="classFESystem.html">FESystem</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1) ^ <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)),</div>
<div class="line">       1,</div>
<div class="line">       <a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">       5)</div>
<div class="line">  , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  , density_ratio(.5)</div>
<div class="line">  , density_penalty_exponent(3)</div>
<div class="line">  , filter_r(.251)</div>
<div class="line">  , penalty_multiplier(1)</div>
<div class="line">  , timer(std::cout, <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary, <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> &gt; 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">}</div>
</div><!-- fragment --><p>The first step then is to create the triangulation that matches the problem description in the introduction</p>
<p>&ndash; a 6-by-1 rectangle (or a 6-by-1-by-1 box in 3d) where a force will be applied in the top center. This triangulation is then uniformly refined a number of times.</p>
<p>In contrast to nearly the entire rest of this program, this function specifically assumes that we are in 2d and will require changes if we wanted to move to 3d simulations. We ensure that nobody tries to accidentally run in 3d without such modifications through an assertion at the top of the function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">SANDTopOpt&lt;dim&gt;::create_triangulation</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                            {6, 1},</div>
<div class="line">                                            <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 0),</div>
<div class="line">                                            <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(6, 1));</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(3);</div>
</div><!-- fragment --><p>The second step is to apply boundary indicators to parts of the boundary. The following code assigns boundary indicators to the bottom, top, left, and right boundaries of the box, respectively. The center region of the top boundary is given a separate boundary indicator: This is where we will apply the down force.</p>
<div class="fragment"><div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">           {</div>
<div class="line">             <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">               {</div>
<div class="line">                 <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a> = <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center();</div>
<div class="line">                 <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(1)</div>
<div class="line">  </div>
<div class="line">- 1) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                   {</div>
<div class="line">                     <span class="keywordflow">if</span> ((<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(0)</div>
<div class="line">  </div>
<div class="line">- 3) &lt; .3))</div>
<div class="line">                       <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>);</div>
<div class="line">                     <span class="keywordflow">else</span></div>
<div class="line">                       <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">BoundaryIds::no_force</a>);</div>
<div class="line">                   }</div>
<div class="line">                 <span class="keywordflow">else</span></div>
<div class="line">                   <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">BoundaryIds::no_force</a>);</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p>Next, determine the constraints due to boundary values. The bottom corners of the domain are kept in place in the \(y\) direction</p>
<p>&ndash; the bottom left also in the \(x\) direction. deal.II generally thinks of boundary values as attached to pieces of the boundary, i.e., faces, rather than individual vertices. Indeed, mathematically speaking, one can not assign boundary values to individual points for the infinite-dimensional partial differential equation. But, since we are trying to reproduce a widely used benchmark, we will do so anyway and keep in mind that we have a finite-dimensional problem for which imposing boundary conditions at a single node is valid.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_boundary_values()</div>
<div class="line">{</div>
<div class="line">  boundary_values.clear();</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a> = <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center();</div>
</div><!-- fragment --><p>Check whether the current face is on the bottom boundary, and if it is whether one of its vertices might be the bottom left or bottom right vertex:</p>
<div class="fragment"><div class="line">                 <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(1)</div>
<div class="line">  </div>
<div class="line">- 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                   {</div>
<div class="line">                     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> vertex_number : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_indices())</div>
<div class="line">                       {</div>
<div class="line">                         <span class="keyword">const</span> <span class="keyword">auto</span> vert = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(vertex_number);</div>
<div class="line">  </div>
<div class="line">                         <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(0)</div>
<div class="line">  </div>
<div class="line">- 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 &amp;&amp;</div>
<div class="line">                             <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(1)</div>
<div class="line">  </div>
<div class="line">- 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                           {</div>
<div class="line">                             <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> x_displacement =</div>
<div class="line">                               <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 0);</div>
<div class="line">                             <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement =</div>
<div class="line">                               <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 1);</div>
<div class="line">                             <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> x_displacement_multiplier =</div>
<div class="line">                               <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 2);</div>
<div class="line">                             <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement_multiplier =</div>
<div class="line">                               <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 3);</div>
<div class="line">  </div>
<div class="line">                             boundary_values[x_displacement]            = 0;</div>
<div class="line">                             boundary_values[y_displacement]            = 0;</div>
<div class="line">                             boundary_values[x_displacement_multiplier] = 0;</div>
<div class="line">                             boundary_values[y_displacement_multiplier] = 0;</div>
<div class="line">                           }</div>
<div class="line">  </div>
<div class="line">                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(0)</div>
<div class="line">  </div>
<div class="line">- 6) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 &amp;&amp;</div>
<div class="line">                                  <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(1)</div>
<div class="line">  </div>
<div class="line">- 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                           {</div>
<div class="line">                             <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement =</div>
<div class="line">                               <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 1);</div>
<div class="line">                             <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement_multiplier =</div>
<div class="line">                               <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 3);</div>
<div class="line">  </div>
<div class="line">                             boundary_values[y_displacement]            = 0;</div>
<div class="line">                             boundary_values[y_displacement_multiplier] = 0;</div>
<div class="line">                           }</div>
<div class="line">                       }</div>
<div class="line">                   }</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="Settingupblockmatricesandvectors"></a> </p><h3>Setting up block matrices and vectors</h3>
<p>The next function makes a giant 9-by-9 block matrix, and also sets up the necessary block vectors. The sparsity pattern for this matrix includes the sparsity pattern for the filter matrix. It also initializes any block vectors we will use.</p>
<p>Setting up the blocks by themselves is not overly complicated and follows what is already done in programs such as <a class="el" href="step_22.html">step-22</a>, for example.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_block_system()</div>
<div class="line">{</div>
<div class="line">  std::vector&lt;unsigned int&gt; block_component(9, 2);</div>
<div class="line">  block_component[0] = 0;</div>
<div class="line">  block_component[1] = 1;</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a>                     n_p = dofs_per_block[0];</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a>                     n_u = dofs_per_block[1];</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebra_1_1CUDAWrappers_1_1kernel.html#aa63f11d31d19bd16be69280eac69dd10">std::vector&lt;BlockVector&lt;double&gt;::size_type</a>&gt; block_sizes = {</div>
<div class="line">    n_p, n_u, n_p, n_u, n_p, n_p, n_p, n_p, n_p};</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(9, 9);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; 9; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; 9; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">      dsp.block(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(block_sizes[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>], block_sizes[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]);</div>
<div class="line">  dsp.collect_sizes();</div>
</div><!-- fragment --><p>The bulk of the function is in setting up which of these blocks will actually contain anything, i.e., which variables couple with which other variables. This is cumbersome but necessary to ensure that we don't just allocate a very large number of entries for our matrix that will then end up being zero.</p>
<p>The concrete pattern you see below is something one probably has to draw once on a piece of paper, but follows in an otherwise relatively straightforward way from looking through the many terms of the bilinear form we will have to assemble in each nonlinear iteration.</p>
<p>The use of the symbolic names defined in namespace <code>SolutionComponents</code> helps understand what each of the following terms corresponds to, but it also makes the expressions lengthy and unwieldy: A term such as <code>coupling[SolutionComponents::density_upper_slack_multiplier&lt;dim&gt;][SolutionComponents::density&lt;dim&gt;]</code> just doesn't read very well, and would either have to be split over several lines or run off the right edge of nearly every screen. As a consequence, we open a curly-brace enclosed code block in which we temporarily make the names in namespace <code>SolutionComponents</code> available without the namespace qualifier, by saying <code>using namespace SolutionComponents</code>.</p>
<div class="fragment"><div class="line"><a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(2 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 7, 2 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 7);</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span>SolutionComponents;</div>
<div class="line"> </div>
<div class="line">  coupling[density&lt;dim&gt;][density&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      coupling[density&lt;dim&gt;][displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][density&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      coupling[density&lt;dim&gt;][displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][density&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  coupling[density&lt;dim&gt;][unfiltered_density_multiplier&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[unfiltered_density_multiplier&lt;dim&gt;][density&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">   [4.x.0] </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">        {</div>
<div class="line">          coupling[displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">                  [displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          coupling[displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]</div>
<div class="line">                  [displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">   [4.x.1] </div>
<div class="line">  coupling[density_lower_slack&lt;dim&gt;][density_lower_slack&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[density_lower_slack&lt;dim&gt;][density_upper_slack&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[density_upper_slack&lt;dim&gt;][density_lower_slack&lt;dim&gt;] =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">  coupling[density_lower_slack_multiplier&lt;dim&gt;]</div>
<div class="line">          [density_lower_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[density_lower_slack_multiplier&lt;dim&gt;]</div>
<div class="line">          [density_upper_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">  coupling[density_upper_slack_multiplier&lt;dim&gt;]</div>
<div class="line">          [density_lower_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Before we can create the sparsity pattern, we also have to set up constraints. Since this program does not adaptively refine the mesh, the only constraint we have is one that couples all density variables to enforce the volume constraint. This will ultimately lead to a dense sub-block of the matrix, but there is little we can do about that.</p>
<div class="fragment"><div class="line">     <span class="keyword">const</span> <a class="code" href="classComponentMask.html">ComponentMask</a> density_mask =</div>
<div class="line">       <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(ValueExtractors::densities&lt;dim&gt;);</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> density_dofs =</div>
<div class="line">       <a class="code" href="namespaceDoFTools.html#a45f4d01f1c4c6337e4be6f10a81fbdab">DoFTools::extract_dofs</a>(dof_handler, density_mask);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> last_density_dof =</div>
<div class="line">       density_dofs.<a class="code" href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">nth_index_in_set</a>(density_dofs.<a class="code" href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">n_elements</a>()</div>
<div class="line">  </div>
<div class="line">- 1);</div>
<div class="line">     <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">     <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">add_line</a>(last_density_dof);</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; density_dofs.<a class="code" href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">n_elements</a>()</div>
<div class="line">  </div>
<div class="line">- 1; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">       <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a2b7756e9cb8e53553211add5426f8e50">add_entry</a>(last_density_dof,</div>
<div class="line">                             density_dofs.<a class="code" href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">nth_index_in_set</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>),</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-1);</div>
<div class="line">     <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">set_inhomogeneity</a>(last_density_dof, 0);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
</div><!-- fragment --><p>We can now finally create the sparsity pattern for the matrix, taking into account which variables couple with which other variables, and the constraints we have on the density.</p>
<div class="fragment"><div class="line"><a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, coupling, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
</div><!-- fragment --><p>The only part of the matrix we have not dealt with is the filter matrix and its transpose. These are non-local (integral) operators for which deal.II does not currently have functions. What we will ultimately need to do is go over all cells and couple the unfiltered density on this cell to all filtered densities of neighboring cells that are less than a threshold distance away, and the other way around; for the moment, we are only concerned with building the sparsity pattern that would correspond to this kind of matrix, so we perform the equivalent loop and where later on we would write into an entry of the matrix, we now simply add an entry to the sparsity matrix:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell : find_relevant_neighbors(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(check_cell-&gt;center());</div>
<div class="line">        <span class="keywordflow">if</span> (distance &lt; filter_r)</div>
<div class="line">          {</div>
<div class="line">            dsp</div>
<div class="line">              .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                     <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)</div>
<div class="line">              .<a class="code" href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">add</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, check_cell-&gt;active_cell_index());</div>
<div class="line">            dsp</div>
<div class="line">              .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">                     <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)</div>
<div class="line">              .<a class="code" href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">add</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, check_cell-&gt;active_cell_index());</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Having so generated the "dynamic" sparsity pattern, we can finally copy it to the structure that is used to associate matrices with a sparsity pattern. Because the sparsity pattern is large and complex, we also output it into a file of its own for visualization purposes</p>
<p>&ndash; in other words, for "visual debugging".</p>
<div class="fragment"><div class="line"><a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">std::ofstream <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>(<span class="stringliteral">&quot;sparsity.plt&quot;</span>);</div>
<div class="line"><a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.print_gnuplot(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>);</div>
<div class="line"> </div>
<div class="line">system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
</div><!-- fragment --><p>What is left is to correctly size the various vectors and their blocks, as well as setting initial guesses for some of the components of the (nonlinear) solution vector. We here use the symbolic component names for individual blocks of the solution vector and, for brevity, use the same trick with <code>using namespace</code> as above:</p>
<div class="fragment"><div class="line">     nonlinear_solution.reinit(block_sizes);</div>
<div class="line">     system_rhs.reinit(block_sizes);</div>
<div class="line">  </div>
<div class="line">     {</div>
<div class="line">       <span class="keyword">using namespace </span>SolutionBlocks;</div>
<div class="line">       nonlinear_solution.block(<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>).add(density_ratio);</div>
<div class="line">       nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a>).add(density_ratio);</div>
<div class="line">       nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a>)</div>
<div class="line">         .add(density_ratio);</div>
<div class="line">       nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a>).add(density_ratio);</div>
<div class="line">       nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a>).add(50);</div>
<div class="line">       nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a>).add(1</div>
<div class="line">  </div>
<div class="line">- density_ratio);</div>
<div class="line">       nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a>).add(50);</div>
<div class="line">     }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="Creatingthefiltermatrix"></a> </p><h3>Creating the filter matrix</h3>
<p>Next up, a function that is used once at the beginning of the program: It creates a matrix \(H\) so that the filtered density vector equals \(H\) times the unfiltered density. The creation of this matrix is non-trivial, and it is used in every iteration, and so rather than reforming it as we do with the Newton matrix, it is made only once and stored separately.</p>
<p>The way this matrix is computed follows the outline used above already to form its sparsity pattern. We repeat this process here for the sparsity pattern of this separately formed matrix, and then actually build the matrix itself. You may want to check the definition of this matrix in the introduction to this program.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_filter_matrix()</div>
<div class="line">{</div>
</div><!-- fragment --><p>The sparsity pattern of the filter has already been determined and implemented in the setup_system() function. We copy the structure from the appropriate block and use it again here.</p>
<div class="fragment"><div class="line">filter_sparsity_pattern.copy_from(</div>
<div class="line">  <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                         <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line">filter_matrix.reinit(filter_sparsity_pattern);</div>
</div><!-- fragment --><p>Having so built the sparsity pattern, now we re-do all of these loops to actually compute the necessary values of the matrix entries:</p>
<div class="fragment"><div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">       {</div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell : find_relevant_neighbors(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">           {</div>
<div class="line">             <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">               <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(check_cell-&gt;center());</div>
<div class="line">             <span class="keywordflow">if</span> (distance &lt; filter_r)</div>
<div class="line">               {</div>
<div class="line">                 filter_matrix.add(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                   check_cell-&gt;active_cell_index(),</div>
<div class="line">                                   filter_r</div>
<div class="line">  </div>
<div class="line">- distance);</div>
<div class="line">                 </div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">       }</div>
</div><!-- fragment --><p>The final step is to normalize the matrix so that for each row, the sum of entries equals one.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; filter_matrix.m(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> denominator = 0;</div>
<div class="line">      <span class="keywordflow">for</span> (<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;::iterator</a> iter = filter_matrix.<a class="code" href="classSparseMatrix.html#a419e25c734b10802f9c7f59d652f84ca">begin</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter++)</div>
<div class="line">        denominator = denominator + iter-&gt;value();</div>
<div class="line">      <span class="keywordflow">for</span> (<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;::iterator</a> iter = filter_matrix.<a class="code" href="classSparseMatrix.html#a419e25c734b10802f9c7f59d652f84ca">begin</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter++)</div>
<div class="line">        iter-&gt;value() = iter-&gt;value() / denominator;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>This function is used for building the filter matrix. We create a set of all the cell iterators within a certain radius of the cell that is input. These are the neighboring cells that will be relevant for the filter.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt;</div>
<div class="line">SANDTopOpt&lt;dim&gt;::find_relevant_neighbors(</div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::set&lt;unsigned int&gt;                               neighbor_ids;</div>
<div class="line">  std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt; cells_to_check;</div>
<div class="line"> </div>
<div class="line">  neighbor_ids.insert(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index());</div>
<div class="line">  cells_to_check.insert(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> new_neighbors_found;</div>
<div class="line">  <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">      new_neighbors_found = <span class="keyword">false</span>;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell :</div>
<div class="line">           <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a>&gt;(</div>
<div class="line">             cells_to_check.begin(), cells_to_check.end()))</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a> : check_cell-&gt;face_indices())</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">if</span> (!(check_cell-&gt;face(<a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a>)-&gt;at_boundary()))</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <span class="keyword">auto</span> &amp; <a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a> = check_cell-&gt;neighbor(<a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a>);</div>
<div class="line">                  <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">                    <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;center());</div>
<div class="line">                  <span class="keywordflow">if</span> ((distance &lt; filter_r) &amp;&amp;</div>
<div class="line">                      !(neighbor_ids.count(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;active_cell_index())))</div>
<div class="line">                    {</div>
<div class="line">                      cells_to_check.insert(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>);</div>
<div class="line">                      neighbor_ids.insert(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;active_cell_index());</div>
<div class="line">                      new_neighbors_found = <span class="keyword">true</span>;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">while</span> (new_neighbors_found);</div>
<div class="line">  <span class="keywordflow">return</span> cells_to_check;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="AssemblingtheNewtonmatrix"></a> </p><h3>Assembling the Newton matrix</h3>
<p>Whereas the setup_filter_matrix function built a matrix that is the same as long as the mesh does not change (which we don't do anyway in this program), the next function builds the matrix to be solved in each iteration. This is where the magic happens. The components of the system of linear equations describing Newton's method for finding the solution of the KKT conditions are implemented here.</p>
<p>The top of the function is as in most of these functions and just sets up all sorts of variables necessary for the actual assembly, including a whole bunch of extractors. The entire set up should look familiar, though somewhat lengthier, if you've previously looked at <a class="el" href="step_22.html">step-22</a>.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::assemble_system()</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div>
<div class="line">  </div>
<div class="line">     system_matrix = 0;</div>
<div class="line">     system_rhs    = 0;</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a> <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">     <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>          quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">     <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt;      face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>        fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                             <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                             quadrature_formula,</div>
<div class="line">                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                               <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">     <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>    fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                      face_quadrature_formula,</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">     <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     dummy_cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;double&gt;                    lambda_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt;                    mu_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(1.);</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="namespacemu.html">mu</a>(1.);</div>
<div class="line">     std::vector&lt;Tensor&lt;1, dim&gt;&gt;            rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
</div><!-- fragment --><p>At this point, we apply the filter to the unfiltered density, and apply the adjoint (transpose) operation to the unfiltered density multiplier, both to the current best guess for the nonlinear solution. We use this later to tell us how far off our filtered density is from the filter applied to the unfiltered density. That is because while at the solution of the nonlinear problem, we have \(\rho=H\varrho\), but at intermediate iterations, we in general have \(\rho^k\neq H\varrho^k\) and the "residual" \(\rho^k-H\varrho^k\) will then appear as the right hand side of one of the Newton update equations that we compute below.</p>
<div class="fragment"><div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filtered_unfiltered_density_solution =</div>
<div class="line">  nonlinear_solution;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filter_adjoint_unfiltered_density_multiplier_solution =</div>
<div class="line">  nonlinear_solution;</div>
<div class="line"> </div>
<div class="line">filter_matrix.vmult(filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>),</div>
<div class="line">                    nonlinear_solution.block(</div>
<div class="line">                      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>));</div>
<div class="line">filter_matrix.Tvmult(</div>
<div class="line">  filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">    <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>),</div>
<div class="line">  nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::vector&lt;double&gt;                  old_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt;          old_displacement_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;                  old_displacement_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_symmgrads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_displacement_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_displacement_multiplier_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_multiplier_symmgrads(</div>
<div class="line">  <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_lower_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_upper_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_lower_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_upper_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; old_unfiltered_density_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; filtered_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt; filter_adjoint_unfiltered_density_multiplier_values(</div>
<div class="line">  <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>ValueExtractors;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.value_list(fe_values.get_quadrature_points(), lambda_values);</div>
<div class="line">    <a class="code" href="namespacemu.html">mu</a>.value_list(fe_values.get_quadrature_points(), mu_values);</div>
</div><!-- fragment --><p>As part of the construction of our system matrix, we need to retrieve values from our current guess at the solution. The following lines of code retrieve the needed values.</p>
<div class="fragment"><div class="line">fe_values[densities&lt;dim&gt;].get_function_values(nonlinear_solution,</div>
<div class="line">                                              old_density_values);</div>
<div class="line">fe_values[displacements&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_displacement_values);</div>
<div class="line">fe_values[displacements&lt;dim&gt;].get_function_divergences(</div>
<div class="line">  nonlinear_solution, old_displacement_divs);</div>
<div class="line">fe_values[displacements&lt;dim&gt;].get_function_symmetric_gradients(</div>
<div class="line">  nonlinear_solution, old_displacement_symmgrads);</div>
<div class="line">fe_values[displacement_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_displacement_multiplier_values);</div>
<div class="line">fe_values[displacement_multipliers&lt;dim&gt;].get_function_divergences(</div>
<div class="line">  nonlinear_solution, old_displacement_multiplier_divs);</div>
<div class="line">fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">  .get_function_symmetric_gradients(</div>
<div class="line">    nonlinear_solution, old_displacement_multiplier_symmgrads);</div>
<div class="line">fe_values[density_lower_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_lower_slack_values);</div>
<div class="line">fe_values[density_lower_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_lower_slack_multiplier_values);</div>
<div class="line">fe_values[density_upper_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_upper_slack_values);</div>
<div class="line">fe_values[density_upper_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_upper_slack_multiplier_values);</div>
<div class="line">fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_unfiltered_density_values);</div>
<div class="line">fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  nonlinear_solution, old_unfiltered_density_multiplier_values);</div>
<div class="line">fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">  filtered_unfiltered_density_solution,</div>
<div class="line">  filtered_unfiltered_density_values);</div>
<div class="line">fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">  filter_adjoint_unfiltered_density_multiplier_solution,</div>
<div class="line">  filter_adjoint_unfiltered_density_multiplier_values);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">  {</div>
</div><!-- fragment --><p>We need several more values corresponding to the test functions coming from the first derivatives taken from the Lagrangian, that is the \(d_{\bullet}\) functions. These are calculated here:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_i_symmgrad =</div>
<div class="line">      fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_i_div =</div>
<div class="line">      fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">      displacement_multiplier_phi_i_symmgrad =</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].symmetric_gradient(</div>
<div class="line">          <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_i_div =</div>
<div class="line">      fe_values[displacement_multipliers&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                          q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_i =</div>
<div class="line">      fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_i =</div>
<div class="line">      fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_i =</div>
<div class="line">      fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                           q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_i =</div>
<div class="line">      fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">        <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_i =</div>
<div class="line">      fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_i =</div>
<div class="line">      fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_i =</div>
<div class="line">      fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">        <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> : fe_values.dof_indices())</div>
<div class="line">      {</div>
</div><!-- fragment --><p>Finally, we need values that come from the second round of derivatives taken from the Lagrangian, the \(c_{\bullet}\) functions. These are calculated here:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_j_symmgrad =</div>
<div class="line">  fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>,</div>
<div class="line">                                                   q_point);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_j_div =</div>
<div class="line">  fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">  displacement_multiplier_phi_j_symmgrad =</div>
<div class="line">    fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">      .symmetric_gradient(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_j_div =</div>
<div class="line">  fe_values[displacement_multipliers&lt;dim&gt;].divergence(</div>
<div class="line">    <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_j =</div>
<div class="line">  fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_j =</div>
<div class="line">  fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_j =</div>
<div class="line">  fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(</div>
<div class="line">    <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_j =</div>
<div class="line">  fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_j =</div>
<div class="line">  fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_j =</div>
<div class="line">  fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">    <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_j =</div>
<div class="line">  fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">    <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
</div><!-- fragment --><p>This is where the actual work starts. In the following, we will build all of the terms of the matrix</p>
<p>&ndash; they are numerous and not entirely self-explanatory, also depending on the previous solutions and its derivatives (which we have already evaluated above and put into the variables called <code>old_*</code>). To understand what each of these terms corresponds to, you will want to look at the explicit form of these terms in the introduction above.</p>
<p>The right hand sides of the equations being driven to 0 give all the KKT conditions for finding a local minimum</p>
<p>&ndash; the descriptions of what each individual equation are given with the computations of the right hand side.</p>
<div class="fragment"><div class="line">                      [4.x.2] </div>
<div class="line">                     <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                       fe_values.JxW(q_point)</div>
<div class="line">                       (</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-density_phi_i unfiltered_density_multiplier_phi_j</div>
<div class="line">  </div>
<div class="line">                         + density_penalty_exponent</div>
<div class="line">                             (density_penalty_exponent</div>
<div class="line">  </div>
<div class="line">- 1)</div>
<div class="line">                             std::<a class="code" href="classVectorizedArray.html#a88a75c587436aef435bd528ab65ac3fe">pow</a>(old_density_values[q_point],</div>
<div class="line">                                      density_penalty_exponent</div>
<div class="line">  </div>
<div class="line">- 2)</div>
<div class="line">                             density_phi_i density_phi_j</div>
<div class="line">                             (old_displacement_multiplier_divs[q_point]</div>
<div class="line">                                old_displacement_divs[q_point]</div>
<div class="line">                                lambda_values[q_point] +</div>
<div class="line">                              2 mu_values[q_point]</div>
<div class="line">                                (old_displacement_symmgrads[q_point]</div>
<div class="line">                                 old_displacement_multiplier_symmgrads[q_point]))</div>
<div class="line">  </div>
<div class="line">                         + density_penalty_exponent</div>
<div class="line">                             std::<a class="code" href="classVectorizedArray.html#a88a75c587436aef435bd528ab65ac3fe">pow</a>(old_density_values[q_point],</div>
<div class="line">                                      density_penalty_exponent</div>
<div class="line">  </div>
<div class="line">- 1)</div>
<div class="line">                             density_phi_i</div>
<div class="line">                             (displacement_multiplier_phi_j_div</div>
<div class="line">                                old_displacement_divs[q_point]</div>
<div class="line">                                lambda_values[q_point] +</div>
<div class="line">                              2 mu_values[q_point]</div>
<div class="line">                                (old_displacement_symmgrads[q_point]</div>
<div class="line">                                 displacement_multiplier_phi_j_symmgrad))</div>
<div class="line">  </div>
<div class="line">                         + density_penalty_exponent</div>
<div class="line">                             std::<a class="code" href="classVectorizedArray.html#a88a75c587436aef435bd528ab65ac3fe">pow</a>(old_density_values[q_point],</div>
<div class="line">                                      density_penalty_exponent</div>
<div class="line">  </div>
<div class="line">- 1)</div>
<div class="line">                             density_phi_i</div>
<div class="line">                             (displacement_phi_j_div</div>
<div class="line">                                old_displacement_multiplier_divs[q_point]</div>
<div class="line">                                lambda_values[q_point] +</div>
<div class="line">                              2 mu_values[q_point]</div>
<div class="line">                                (old_displacement_multiplier_symmgrads[q_point]</div>
<div class="line">                                 displacement_phi_j_symmgrad)));</div>
<div class="line">  </div>
<div class="line">                      [4.<a class="code" href="vector__valued__0_8txt.html#a2b24e414d1a0d32deea919c5e8899811">x</a>.3] </div>
<div class="line">                     <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                       fe_values.<a class="code" href="cuda__matrix__free__0_8txt.html#a747ffbda88fa48702c72f4b04f9c5721">JxW</a>(q_point)</div>
<div class="line">                       (density_penalty_exponent</div>
<div class="line">                          std::<a class="code" href="classVectorizedArray.html#a88a75c587436aef435bd528ab65ac3fe">pow</a>(old_density_values[q_point],</div>
<div class="line">                                   density_penalty_exponent</div>
<div class="line">  </div>
<div class="line">- 1)</div>
<div class="line">                          density_phi_j</div>
<div class="line">                          (old_displacement_multiplier_divs[q_point]</div>
<div class="line">                             displacement_phi_i_div lambda_values[q_point] +</div>
<div class="line">                           2 mu_values[q_point]</div>
<div class="line">                             (old_displacement_multiplier_symmgrads[q_point]</div>
<div class="line">                              displacement_phi_i_symmgrad))</div>
<div class="line">  </div>
<div class="line">                        + std::<a class="code" href="classVectorizedArray.html#a88a75c587436aef435bd528ab65ac3fe">pow</a>(old_density_values[q_point],</div>
<div class="line">                                   density_penalty_exponent)</div>
<div class="line">                            (displacement_multiplier_phi_j_div</div>
<div class="line">                               displacement_phi_i_div lambda_values[q_point] +</div>
<div class="line">                             2 mu_values[q_point]</div>
<div class="line">                               (displacement_multiplier_phi_j_symmgrad</div>
<div class="line">                                displacement_phi_i_symmgrad))</div>
<div class="line">  </div>
<div class="line">                       );</div>
<div class="line">  </div>
<div class="line">                     <span class="comment">/* Equation 3, which has to do with the filter and which is</span></div>
<div class="line"><span class="comment">                      calculated elsewhere.</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.1] Equation 3, which has to do with the filter and which is</span></div>
<div class="line"><span class="comment">                      calculated elsewhere./</span></div>
<div class="line"><span class="comment">                     cell_matrix(i, j) +=</span></div>
<div class="line"><span class="comment">                       fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                       (-1 unfiltered_density_phi_i</span></div>
<div class="line"><span class="comment">                          lower_slack_multiplier_phi_j +</span></div>
<div class="line"><span class="comment">                        unfiltered_density_phi_i upper_slack_multiplier_phi_j);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"> </span></div>
<div class="line"><span class="comment">                      [4.x.4] </span></div>
<div class="line"><span class="comment">                     cell_matrix(i, j) +=</span></div>
<div class="line"><span class="comment">                       fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                       (</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                         density_penalty_exponent</span></div>
<div class="line"><span class="comment">                           std::pow(old_density_values[q_point],</span></div>
<div class="line"><span class="comment">                                    density_penalty_exponent</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- 1)</span></div>
<div class="line"><span class="comment">                           density_phi_j</span></div>
<div class="line"><span class="comment">                           (old_displacement_divs[q_point]</span></div>
<div class="line"><span class="comment">                              displacement_multiplier_phi_i_div</span></div>
<div class="line"><span class="comment">                              lambda_values[q_point] +</span></div>
<div class="line"><span class="comment">                            2 mu_values[q_point]</span></div>
<div class="line"><span class="comment">                              (old_displacement_symmgrads[q_point]</span></div>
<div class="line"><span class="comment">                               displacement_multiplier_phi_i_symmgrad))</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                         + std::pow(old_density_values[q_point],</span></div>
<div class="line"><span class="comment">                                    density_penalty_exponent)</span></div>
<div class="line"><span class="comment">                             (displacement_phi_j_div</span></div>
<div class="line"><span class="comment">                                displacement_multiplier_phi_i_div</span></div>
<div class="line"><span class="comment">                                lambda_values[q_point] +</span></div>
<div class="line"><span class="comment">                              2 mu_values[q_point]</span></div>
<div class="line"><span class="comment">                                (displacement_phi_j_symmgrad</span></div>
<div class="line"><span class="comment">                                 displacement_multiplier_phi_i_symmgrad)));</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                      [4.x.5] </span></div>
<div class="line"><span class="comment">                     cell_matrix(i, j) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                       lower_slack_multiplier_phi_i</span></div>
<div class="line"><span class="comment">                       (unfiltered_density_phi_j</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- lower_slack_phi_j);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                      [4.x.6] </span></div>
<div class="line"><span class="comment">                     cell_matrix(i, j) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                       upper_slack_multiplier_phi_i</span></div>
<div class="line"><span class="comment">                       (-1 unfiltered_density_phi_j</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- upper_slack_phi_j);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                     /* Equation 7: Primal feasibility</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- the part with the filter</span></div>
<div class="line"><span class="comment">                      is added later</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.2] Equation 7: Primal feasibility</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- the part with the filter</span></div>
<div class="line"><span class="comment">                      is added later/</span></div>
<div class="line"><span class="comment">                     cell_matrix(i, j) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                                          unfiltered_density_multiplier_phi_i</span></div>
<div class="line"><span class="comment">                                          (density_phi_j);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                      [4.x.7] </span></div>
<div class="line"><span class="comment">                     cell_matrix(i, j) +=</span></div>
<div class="line"><span class="comment">                       fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                       (lower_slack_phi_i lower_slack_multiplier_phi_j</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                        + lower_slack_phi_i lower_slack_phi_j</span></div>
<div class="line"><span class="comment">                            old_lower_slack_multiplier_values[q_point] /</span></div>
<div class="line"><span class="comment">                            old_lower_slack_values[q_point]);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                      [4.x.8] </span></div>
<div class="line"><span class="comment">                     cell_matrix(i, j) +=</span></div>
<div class="line"><span class="comment">                       fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                       (upper_slack_phi_i upper_slack_multiplier_phi_j</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"> </span></div>
<div class="line"><span class="comment">                        + upper_slack_phi_i upper_slack_phi_j</span></div>
<div class="line"><span class="comment">                            old_upper_slack_multiplier_values[q_point] /</span></div>
<div class="line"><span class="comment">                            old_upper_slack_values[q_point]);</span></div>
<div class="line"><span class="comment">                   }</span></div>
<div class="line"><span class="comment">               }</span></div>
<div class="line"><span class="comment">           }</span></div>
<div class="line"><span class="comment">* </span></div>
</div><!-- fragment --><p>Now that we have everything assembled, all we have to do is deal with the effect of (Dirichlet) boundary conditions and other constraints. We incorporate the former locally with just the contributions from the current cell, and then let the AffineConstraint class deal with the latter while copying contributions from the current cell into the global linear system:</p>
<div class="fragment"><div class="line">  <a class="code" href="namespaceMatrixTools.html#afe66f38c3a4f4e46dd8389b62209b891">MatrixTools::local_apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                           <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                           <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                           dummy_cell_rhs,</div>
<div class="line">                                           <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                         <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                         system_matrix);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Having accumulated all of the terms that belong into the Newton matrix, we now also have to compute the terms for the right hand side (i.e., the negative residual). We already do this in another function, and so we call that here:</p>
<div class="fragment"><div class="line">system_rhs = calculate_test_rhs(nonlinear_solution);</div>
</div><!-- fragment --><p>Here we use the filter matrix we have already constructed. We only need to integrate this filter applied to test functions, which are piecewise constant, and so the integration becomes a simple multiplication by the measure of the cell. Iterating over the pre-made filter matrix allows us to use the information about which cells are in or out of the filter without repeatedly checking neighbor cells again.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;::iterator</a> iter =</div>
<div class="line">             filter_matrix.<a class="code" href="classSparseMatrix.html#a419e25c734b10802f9c7f59d652f84ca">begin</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">           ++iter)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>     = iter-&gt;column();</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span>       <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a> = iter-&gt;<a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>() <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure();</div>
<div class="line"> </div>
<div class="line">          system_matrix</div>
<div class="line">            .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">                   <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)</div>
<div class="line">            .add(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>);</div>
<div class="line">          system_matrix</div>
<div class="line">            .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                   <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)</div>
<div class="line">            .add(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="SolvingtheNewtonlinearsystem"></a> </p><h3>Solving the Newton linear system</h3>
<p>We will need to solve a linear system in each iteration. We use a direct solver, for now</p>
<p>&ndash; this is clearly not an efficient choice for a matrix that has so many non-zeroes, and it will not scale to anything interesting. For "real" applications, we will need an iterative solver but the complexity of the system means that an iterative solver algorithm will take a good deal of work. Because this is not the focus of the current program, we simply stick with the direct solver we have here</p>
<p>&ndash; the function follows the same structure as used in <a class="el" href="step_29.html">step-29</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">SANDTopOpt&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;solver&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> linear_solution;</div>
<div class="line">  linear_solution.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> A_direct;</div>
<div class="line">  A_direct.<a class="code" href="classSparseDirectUMFPACK.html#a25b1d3c7dbb88158a76165a4a56a16d6">initialize</a>(system_matrix);</div>
<div class="line">  A_direct.<a class="code" href="classSparseDirectUMFPACK.html#adc154e4830b0e16be265f10a5c8b7103">vmult</a>(linear_solution, system_rhs);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(linear_solution);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> linear_solution;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Detailsoftheoptimizationalgorithm"></a> </p><h3>Details of the optimization algorithm</h3>
<p>The next several functions deal with specific parts of the optimization algorithm, most notably with deciding whether the direction computed by solving the linearized (Newton) system is viable and, if so, how far we want to go in this direction.</p>
<p><a class="anchor" id="Computingsteplengths"></a> </p><h4>Computing step lengths</h4>
<p>We start with a function that does a binary search to figure out the maximum step that meets the dual feasibility</p>
<p>&ndash; that is, how far can we go so that \(s&gt;0\) and \(z&gt;0\). The function returns a pair of values, one each for the \(s\) and \(z\) slack variables.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   std::pair&lt;double, double&gt; SANDTopOpt&lt;dim&gt;::calculate_max_step_size(</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keywordtype">double</span>       fraction_to_boundary;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> min_fraction_to_boundary = .8;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> max_fraction_to_boundary = 1.</div>
<div class="line">  </div>
<div class="line">- 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-5;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (min_fraction_to_boundary &lt; 1</div>
<div class="line">  </div>
<div class="line">- barrier_size)</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordflow">if</span> (1</div>
<div class="line">  </div>
<div class="line">- barrier_size &lt; max_fraction_to_boundary)</div>
<div class="line">           fraction_to_boundary = 1</div>
<div class="line">  </div>
<div class="line">- barrier_size;</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">           fraction_to_boundary = max_fraction_to_boundary;</div>
<div class="line">       }</div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       fraction_to_boundary = min_fraction_to_boundary;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordtype">double</span> step_size_s_low  = 0;</div>
<div class="line">     <span class="keywordtype">double</span> step_size_z_low  = 0;</div>
<div class="line">     <span class="keywordtype">double</span> step_size_s_high = 1;</div>
<div class="line">     <span class="keywordtype">double</span> step_size_z_high = 1;</div>
<div class="line">     <span class="keywordtype">double</span> step_size_s, step_size_z;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">int</span> max_bisection_method_steps = 50;</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_bisection_method_steps; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">       {</div>
<div class="line">         step_size_s = (step_size_s_low + step_size_s_high) / 2;</div>
<div class="line">         step_size_z = (step_size_z_low + step_size_z_high) / 2;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> state_test_s =</div>
<div class="line">           (fraction_to_boundary <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) + (step_size_s <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> state_test_z =</div>
<div class="line">           (fraction_to_boundary <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) + (step_size_z <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">bool</span> accept_s =</div>
<div class="line">           (state_test_s.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)</div>
<div class="line">              .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>()) &amp;&amp;</div>
<div class="line">           (state_test_s.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)</div>
<div class="line">              .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>());</div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">bool</span> accept_z =</div>
<div class="line">           (state_test_z.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>)</div>
<div class="line">              .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>()) &amp;&amp;</div>
<div class="line">           (state_test_z.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>)</div>
<div class="line">              .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>());</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">if</span> (accept_s)</div>
<div class="line">           step_size_s_low = step_size_s;</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">           step_size_s_high = step_size_s;</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">if</span> (accept_z)</div>
<div class="line">           step_size_z_low = step_size_z;</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">           step_size_z_high = step_size_z;</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">return</span> {step_size_s_low, step_size_z_low};</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="Computingresiduals"></a> </p><h4>Computing residuals</h4>
<p>The next function computes a right hand side vector linearized around a "test solution vector" that we can use to look at the magnitude of the KKT conditions. This is then used for testing the convergence before shrinking the barrier size, as well as in the calculation of the \(l_1\) merit.</p>
<p>The function is lengthy and complicated, but it is really just a copy of the right hand side part of what the <code>assemble_system()</code> function above did.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> SANDTopOpt&lt;dim&gt;::calculate_test_rhs(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
</div><!-- fragment --><p>We first create a zero vector with size and blocking of system_rhs</p>
<div class="fragment"><div class="line">     <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs;</div>
<div class="line">     test_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(system_rhs);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt; face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                             <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                             quadrature_formula,</div>
<div class="line">                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                               <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">     <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>     fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                      face_quadrature_formula,</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">     <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> dummy_cell_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;double&gt; lambda_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; mu_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(1.), <a class="code" href="namespacemu.html">mu</a>(1.);</div>
<div class="line">     std::vector&lt;Tensor&lt;1, dim&gt;&gt;            rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filtered_unfiltered_density_solution = test_solution;</div>
<div class="line">     <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filter_adjoint_unfiltered_density_multiplier_solution =</div>
<div class="line">       test_solution;</div>
<div class="line">     filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>) = 0;</div>
<div class="line">     filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>) = 0;</div>
<div class="line">  </div>
<div class="line">     filter_matrix.vmult(filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                           <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>),</div>
<div class="line">                         test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                           <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>));</div>
<div class="line">     filter_matrix.Tvmult(</div>
<div class="line">       filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">         <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>),</div>
<div class="line">       test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     std::vector&lt;double&gt;                  old_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;Tensor&lt;1, dim&gt;&gt;          old_displacement_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt;                  old_displacement_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_symmgrads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_displacement_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt;         old_displacement_multiplier_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_multiplier_symmgrads(</div>
<div class="line">       <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_lower_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_upper_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_lower_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_upper_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_unfiltered_density_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; filtered_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; filter_adjoint_unfiltered_density_multiplier_values(</div>
<div class="line">       <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">using namespace </span>ValueExtractors;</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">       {</div>
<div class="line">         cell_rhs = 0;</div>
<div class="line">  </div>
<div class="line">         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  </div>
<div class="line">         fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  </div>
<div class="line">         <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.value_list(fe_values.get_quadrature_points(), lambda_values);</div>
<div class="line">         <a class="code" href="namespacemu.html">mu</a>.value_list(fe_values.get_quadrature_points(), mu_values);</div>
<div class="line">  </div>
<div class="line">         fe_values[densities&lt;dim&gt;].get_function_values(test_solution,</div>
<div class="line">                                                       old_density_values);</div>
<div class="line">         fe_values[displacements&lt;dim&gt;].get_function_values(</div>
<div class="line">           test_solution, old_displacement_values);</div>
<div class="line">         fe_values[displacements&lt;dim&gt;].get_function_divergences(</div>
<div class="line">           test_solution, old_displacement_divs);</div>
<div class="line">         fe_values[displacements&lt;dim&gt;].get_function_symmetric_gradients(</div>
<div class="line">           test_solution, old_displacement_symmgrads);</div>
<div class="line">         fe_values[displacement_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">           test_solution, old_displacement_multiplier_values);</div>
<div class="line">         fe_values[displacement_multipliers&lt;dim&gt;].get_function_divergences(</div>
<div class="line">           test_solution, old_displacement_multiplier_divs);</div>
<div class="line">         fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">           .get_function_symmetric_gradients(</div>
<div class="line">             test_solution, old_displacement_multiplier_symmgrads);</div>
<div class="line">         fe_values[density_lower_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">           test_solution, old_lower_slack_values);</div>
<div class="line">         fe_values[density_lower_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">           test_solution, old_lower_slack_multiplier_values);</div>
<div class="line">         fe_values[density_upper_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">           test_solution, old_upper_slack_values);</div>
<div class="line">         fe_values[density_upper_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">           test_solution, old_upper_slack_multiplier_values);</div>
<div class="line">         fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">           test_solution, old_unfiltered_density_values);</div>
<div class="line">         fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">           test_solution, old_unfiltered_density_multiplier_values);</div>
<div class="line">         fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">           filtered_unfiltered_density_solution,</div>
<div class="line">           filtered_unfiltered_density_values);</div>
<div class="line">         fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">           filter_adjoint_unfiltered_density_multiplier_solution,</div>
<div class="line">           filter_adjoint_unfiltered_density_multiplier_values);</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">           {</div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">               {</div>
<div class="line">                 <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_i_symmgrad =</div>
<div class="line">                   fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_i_div =</div>
<div class="line">                   fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">  </div>
<div class="line">                 <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">                   displacement_multiplier_phi_i_symmgrad =</div>
<div class="line">                     fe_values[displacement_multipliers&lt;dim&gt;].symmetric_gradient(</div>
<div class="line">                       <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_i_div =</div>
<div class="line">                   fe_values[displacement_multipliers&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                       q_point);</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_i =</div>
<div class="line">                   fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_i =</div>
<div class="line">                   fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_i =</div>
<div class="line">                   fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                        q_point);</div>
<div class="line">  </div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_i =</div>
<div class="line">                   fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                     <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">  </div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_i =</div>
<div class="line">                   fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">  </div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_i =</div>
<div class="line">                   fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">  </div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_i =</div>
<div class="line">                   fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                     <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">  </div>
<div class="line">                 <span class="comment">/* Equation 1: This equation, along with equations</span></div>
<div class="line"><span class="comment">                  2 and 3, are the variational derivatives of the</span></div>
<div class="line"><span class="comment">                  Lagrangian with respect to the decision</span></div>
<div class="line"><span class="comment">                  variables</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- the density, displacement, and</span></div>
<div class="line"><span class="comment">                  unfiltered density.</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.3] Equation 1: This equation, along with equations</span></div>
<div class="line"><span class="comment">                  2 and 3, are the variational derivatives of the</span></div>
<div class="line"><span class="comment">                  Lagrangian with respect to the decision</span></div>
<div class="line"><span class="comment">                  variables</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- the density, displacement, and</span></div>
<div class="line"><span class="comment">                  unfiltered density./</span></div>
<div class="line"><span class="comment">                 cell_rhs(i) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                   (density_penalty_exponent</span></div>
<div class="line"><span class="comment">                      std::pow(old_density_values[q_point],</span></div>
<div class="line"><span class="comment">                               density_penalty_exponent</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- 1)</span></div>
<div class="line"><span class="comment">                      density_phi_i</span></div>
<div class="line"><span class="comment">                      (old_displacement_multiplier_divs[q_point]</span></div>
<div class="line"><span class="comment">                         old_displacement_divs[q_point]</span></div>
<div class="line"><span class="comment">                         lambda_values[q_point] +</span></div>
<div class="line"><span class="comment">                       2 mu_values[q_point]</span></div>
<div class="line"><span class="comment">                         (old_displacement_symmgrads[q_point]</span></div>
<div class="line"><span class="comment">                          old_displacement_multiplier_symmgrads[q_point]))</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-</span></div>
<div class="line"><span class="comment">                    density_phi_i</span></div>
<div class="line"><span class="comment">                      old_unfiltered_density_multiplier_values[q_point]);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                 /* Equation 2; the boundary terms will be added further down</span></div>
<div class="line"><span class="comment">                  below.</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.4] Equation 2; the boundary terms will be added further down</span></div>
<div class="line"><span class="comment">                  below./</span></div>
<div class="line"><span class="comment">                 cell_rhs(i) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                   (std::pow(old_density_values[q_point],</span></div>
<div class="line"><span class="comment">                             density_penalty_exponent)</span></div>
<div class="line"><span class="comment">                    (old_displacement_multiplier_divs[q_point]</span></div>
<div class="line"><span class="comment">                       displacement_phi_i_div lambda_values[q_point] +</span></div>
<div class="line"><span class="comment">                     2 mu_values[q_point]</span></div>
<div class="line"><span class="comment">                       (old_displacement_multiplier_symmgrads[q_point]</span></div>
<div class="line"><span class="comment">                        displacement_phi_i_symmgrad)));</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                  [4.x.9] </span></div>
<div class="line"><span class="comment">                 cell_rhs(i) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                   (unfiltered_density_phi_i</span></div>
<div class="line"><span class="comment">                      filter_adjoint_unfiltered_density_multiplier_values</span></div>
<div class="line"><span class="comment">                        [q_point] +</span></div>
<div class="line"><span class="comment">                    unfiltered_density_phi_i</span></div>
<div class="line"><span class="comment">                      old_upper_slack_multiplier_values[q_point] +</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 unfiltered_density_phi_i</span></div>
<div class="line"><span class="comment">                      old_lower_slack_multiplier_values[q_point]);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"> </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                 /* Equation 4; boundary term will again be dealt</span></div>
<div class="line"><span class="comment">                  with below. This equation being driven to 0</span></div>
<div class="line"><span class="comment">                  ensures that the elasticity equation is met as</span></div>
<div class="line"><span class="comment">                  a constraint.</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.5] Equation 4; boundary term will again be dealt</span></div>
<div class="line"><span class="comment">                  with below. This equation being driven to 0</span></div>
<div class="line"><span class="comment">                  ensures that the elasticity equation is met as</span></div>
<div class="line"><span class="comment">                  a constraint./</span></div>
<div class="line"><span class="comment">                 cell_rhs(i) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                                (std::pow(old_density_values[q_point],</span></div>
<div class="line"><span class="comment">                                          density_penalty_exponent)</span></div>
<div class="line"><span class="comment">                                 (old_displacement_divs[q_point]</span></div>
<div class="line"><span class="comment">                                    displacement_multiplier_phi_i_div</span></div>
<div class="line"><span class="comment">                                    lambda_values[q_point] +</span></div>
<div class="line"><span class="comment">                                  2 mu_values[q_point]</span></div>
<div class="line"><span class="comment">                                    (displacement_multiplier_phi_i_symmgrad</span></div>
<div class="line"><span class="comment">                                     old_displacement_symmgrads[q_point])));</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                 /* Equation 5: This equation sets the lower slack</span></div>
<div class="line"><span class="comment">                  variable equal to the unfiltered density,</span></div>
<div class="line"><span class="comment">                  giving a minimum density of 0.</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.6] Equation 5: This equation sets the lower slack</span></div>
<div class="line"><span class="comment">                  variable equal to the unfiltered density,</span></div>
<div class="line"><span class="comment">                  giving a minimum density of 0./</span></div>
<div class="line"><span class="comment">                 cell_rhs(i) += fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                                (lower_slack_multiplier_phi_i</span></div>
<div class="line"><span class="comment">                                 (old_unfiltered_density_values[q_point]</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-</span></div>
<div class="line"><span class="comment">                                  old_lower_slack_values[q_point]));</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                 /* Equation 6: This equation sets the upper slack</span></div>
<div class="line"><span class="comment">                  variable equal to one minus the unfiltered</span></div>
<div class="line"><span class="comment">                  density.</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.7] Equation 6: This equation sets the upper slack</span></div>
<div class="line"><span class="comment">                  variable equal to one minus the unfiltered</span></div>
<div class="line"><span class="comment">                  density./</span></div>
<div class="line"><span class="comment">                 cell_rhs(i) += fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                                (upper_slack_multiplier_phi_i</span></div>
<div class="line"><span class="comment">                                 (1</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">- old_unfiltered_density_values[q_point]</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-</span></div>
<div class="line"><span class="comment">                                  old_upper_slack_values[q_point]));</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                 /* Equation 7: This is the difference between the</span></div>
<div class="line"><span class="comment">                  density and the filter applied to the</span></div>
<div class="line"><span class="comment">                  unfiltered density. This being driven to 0 by</span></div>
<div class="line"><span class="comment">                  the Newton steps ensures that the filter is</span></div>
<div class="line"><span class="comment">                  applied correctly.</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.8] Equation 7: This is the difference between the</span></div>
<div class="line"><span class="comment">                  density and the filter applied to the</span></div>
<div class="line"><span class="comment">                  unfiltered density. This being driven to 0 by</span></div>
<div class="line"><span class="comment">                  the Newton steps ensures that the filter is</span></div>
<div class="line"><span class="comment">                  applied correctly./</span></div>
<div class="line"><span class="comment">                 cell_rhs(i) += fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                                (unfiltered_density_multiplier_phi_i</span></div>
<div class="line"><span class="comment">                                 (old_density_values[q_point]</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-</span></div>
<div class="line"><span class="comment">                                  filtered_unfiltered_density_values[q_point]));</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                 /* Equation 8: This along with equation 9 give the</span></div>
<div class="line"><span class="comment">                  requirement that s*z = \alpha for the barrier</span></div>
<div class="line"><span class="comment">                  size alpha, and gives complementary slackness</span></div>
<div class="line"><span class="comment">                  from KKT conditions when \alpha goes to 0.</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">[0.x.9] Equation 8: This along with equation 9 give the</span></div>
<div class="line"><span class="comment">                  requirement that s*z = \alpha for the barrier</span></div>
<div class="line"><span class="comment">                  size alpha, and gives complementary slackness</span></div>
<div class="line"><span class="comment">                  from KKT conditions when \alpha goes to 0./</span></div>
<div class="line"><span class="comment">                 cell_rhs(i) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                   (lower_slack_phi_i</span></div>
<div class="line"><span class="comment">                    (old_lower_slack_multiplier_values[q_point]</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-</span></div>
<div class="line"><span class="comment">                     barrier_size / old_lower_slack_values[q_point]));</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                  [4.x.10] </span></div>
<div class="line"><span class="comment">                 cell_rhs(i) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1 fe_values.JxW(q_point)</span></div>
<div class="line"><span class="comment">                   (upper_slack_phi_i</span></div>
<div class="line"><span class="comment">                    (old_upper_slack_multiplier_values[q_point]</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-</span></div>
<div class="line"><span class="comment">                     barrier_size / old_upper_slack_values[q_point]));</span></div>
<div class="line"><span class="comment">               }</span></div>
<div class="line"><span class="comment">           }</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">         for (const auto &amp;face : cell-&gt;face_iterators())</span></div>
<div class="line"><span class="comment">           {</span></div>
<div class="line"><span class="comment">             if (face-&gt;at_boundary() &amp;&amp;</span></div>
<div class="line"><span class="comment">                 face-&gt;boundary_id() == BoundaryIds::down_force)</span></div>
<div class="line"><span class="comment">               {</span></div>
<div class="line"><span class="comment">                 fe_face_values.reinit(cell, face);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                 for (const auto face_q_point :</span></div>
<div class="line"><span class="comment">                      fe_face_values.quadrature_point_indices())</span></div>
<div class="line"><span class="comment">                   {</span></div>
<div class="line"><span class="comment">                     for (const auto i : fe_face_values.dof_indices())</span></div>
<div class="line"><span class="comment">                       {</span></div>
<div class="line"><span class="comment">                         Tensor&lt;1, dim&gt; traction;</span></div>
<div class="line"><span class="comment">                         traction[1] =</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1.;</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                         cell_rhs(i) +=</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">-1</span></div>
<div class="line"><span class="comment">                           (traction fe_face_values[displacements&lt;dim&gt;].value(</span></div>
<div class="line"><span class="comment">                                         i, face_q_point))</span></div>
<div class="line"><span class="comment">                           fe_face_values.JxW(face_q_point);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">                         cell_rhs(i) +=</span></div>
<div class="line"><span class="comment">                           (traction</span></div>
<div class="line"><span class="comment">                            fe_face_values[displacement_multipliers&lt;dim&gt;].value(</span></div>
<div class="line"><span class="comment">                              i, face_q_point))</span></div>
<div class="line"><span class="comment">                           fe_face_values.JxW(face_q_point);</span></div>
<div class="line"><span class="comment">                       }</span></div>
<div class="line"><span class="comment">                   }</span></div>
<div class="line"><span class="comment">               }</span></div>
<div class="line"><span class="comment">           }</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">         MatrixTools::local_apply_boundary_values(boundary_values,</span></div>
<div class="line"><span class="comment">                                                  local_dof_indices,</span></div>
<div class="line"><span class="comment">                                                  dummy_cell_matrix,</span></div>
<div class="line"><span class="comment">                                                  cell_rhs,</span></div>
<div class="line"><span class="comment">                                                  true);</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">         constraints.distribute_local_to_global(cell_rhs,</span></div>
<div class="line"><span class="comment">                                                local_dof_indices,</span></div>
<div class="line"><span class="comment">                                                test_rhs);</span></div>
<div class="line"><span class="comment">       }</span></div>
<div class="line"><span class="comment">* </span></div>
<div class="line"><span class="comment">     return test_rhs;</span></div>
<div class="line"><span class="comment">   }</span></div>
<div class="line"><span class="comment">* </span></div>
</div><!-- fragment --><p><a class="anchor" id="Computingthemeritfunction"></a> </p><h4>Computing the merit function</h4>
<p>The algorithm we use herein uses a "watchdog" strategy to determine where and how far to go from the current iterate. We base the watchdog strategy on an exact \(l_1\) merit function. This function calculates the exact \(l_1\) merit of a given, putative, next iterate.</p>
<p>The merit function consists of the sum of the objective function (which is simply an integral of external forces (on the boundary of the domain) times the displacement values of a test solution (typically, the current solution plus some multiple of the Newton update), and the \(l_1\) norms of the Lagrange multiplier components of residual vectors. The following code computes these parts in turn:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> SANDTopOpt&lt;dim&gt;::calculate_exact_merit(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;merit function&quot;</span>);</div>
</div><!-- fragment --><p>Start with computing the objective function:</p>
<div class="fragment"><div class="line">     <span class="keywordtype">double</span> objective_function_merit = 0;</div>
<div class="line">     {</div>
<div class="line">       <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt; face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">       <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                               <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                               quadrature_formula,</div>
<div class="line">                               <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                 <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">       <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>     fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                        <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                        face_quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points = face_quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">  </div>
<div class="line">       std::vector&lt;Tensor&lt;1, dim&gt;&gt; displacement_face_values(n_face_q_points);</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">         {</div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">             {</div>
<div class="line">               <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                   <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>)</div>
<div class="line">                 {</div>
<div class="line">                   fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">                   fe_face_values[ValueExtractors::displacements&lt;dim&gt;]</div>
<div class="line">                     .get_function_values(test_solution,</div>
<div class="line">                                          displacement_face_values);</div>
<div class="line">                   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_q_point = 0;</div>
<div class="line">                        face_q_point &lt; n_face_q_points;</div>
<div class="line">                        ++face_q_point)</div>
<div class="line">                     {</div>
<div class="line">                       <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> traction;</div>
<div class="line">                       traction[1] =</div>
<div class="line">  </div>
<div class="line">-1.;</div>
<div class="line">  </div>
<div class="line">                       objective_function_merit +=</div>
<div class="line">                         (traction displacement_face_values[face_q_point])</div>
<div class="line">                         fe_face_values.JxW(face_q_point);</div>
<div class="line">                     }</div>
<div class="line">                 }</div>
<div class="line">             }</div>
<div class="line">         }</div>
<div class="line">     }</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">       {</div>
<div class="line">         objective_function_merit =</div>
<div class="line">           objective_function_merit</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">           barrier_size <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure()</div>
<div class="line">             <a class="code" href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a>(test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">               <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()]);</div>
<div class="line">         objective_function_merit =</div>
<div class="line">           objective_function_merit</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">           barrier_size <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure()</div>
<div class="line">             <a class="code" href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a>(test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">               <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()]);</div>
<div class="line">       }</div>
</div><!-- fragment --><p>Then compute the residual and take the \(l_1\) norms of the components that correspond to Lagrange mulipliers. We add those to the objective function computed above, and return the sum at the bottom:</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs = calculate_test_rhs(test_solution);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> elasticity_constraint_merit =</div>
<div class="line">    penalty_multiplier</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> filter_constraint_merit =</div>
<div class="line">    penalty_multiplier</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_merit =</div>
<div class="line">    penalty_multiplier</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_merit =</div>
<div class="line">    penalty_multiplier</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> total_merit =</div>
<div class="line">    objective_function_merit + elasticity_constraint_merit +</div>
<div class="line">    filter_constraint_merit + lower_slack_merit + upper_slack_merit;</div>
<div class="line">  <span class="keywordflow">return</span> total_merit;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Findingasearchdirection"></a> </p><h4>Finding a search direction</h4>
<p>Next up is the function that actually computes a search direction starting at the current state (passed as the first argument) and returns the resulting vector. To this end, the function first calls the functions that assemble the linear system that corresponds to the Newton system, and that solve it.</p>
<p>This function also updates the penalty multiplier in the merit function, and then returns the largest scaled feasible step. It uses the <code>calculate_max_step_sizes()</code> function to find the largest feasible step that satisfies \(s&gt;0\) and \(z&gt;0\).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> SANDTopOpt&lt;dim&gt;::find_max_step()</div>
<div class="line">{</div>
<div class="line">  assemble_system();</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a> = <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
</div><!-- fragment --><p>Next we are going to update penalty_multiplier. In essence, a larger penalty multiplier makes us consider the constraints more. Looking at the Hessian and gradient with respect to the step we want to take with our decision variables, and comparing that to the norm of our constraint error gives us a way to ensure that our merit function is "exact"</p>
<ul>
<li>that is, it has a minimum in the same location that the objective function does. As our merit function is exact for any penalty multiplier over some minimum value, we only keep the computed value if it increases the penalty multiplier.</li>
</ul>
<div class="fragment"><div class="line">     <span class="keyword">const</span> std::vector&lt;unsigned int&gt; decision_variables = {</div>
<div class="line">       <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>,</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SolutionBlocks::displacement</a>,</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>,</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>};</div>
<div class="line">     <span class="keywordtype">double</span> hess_part = 0;</div>
<div class="line">     <span class="keywordtype">double</span> grad_part = 0;</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> decision_variable_i : decision_variables)</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> decision_variable_j : decision_variables)</div>
<div class="line">           {</div>
<div class="line">             <a class="code" href="classVector.html">Vector&lt;double&gt;</a> temp_vector(<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i).size());</div>
<div class="line">             system_matrix.block(decision_variable_i, decision_variable_j)</div>
<div class="line">               .vmult(temp_vector, <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_j));</div>
<div class="line">             hess_part += <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i) temp_vector;</div>
<div class="line">           }</div>
<div class="line">         grad_part</div>
<div class="line">  </div>
<div class="line">-= system_rhs.block(decision_variable_i)</div>
<div class="line">                      <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i);</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;unsigned int&gt; equality_constraint_multipliers = {</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>,</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>,</div>
<div class="line">       <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>};</div>
<div class="line">     <span class="keywordtype">double</span> constraint_norm = 0;</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> multiplier_i : equality_constraint_multipliers)</div>
<div class="line">       constraint_norm += system_rhs.block(multiplier_i).linfty_norm();</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     <span class="keywordtype">double</span> test_penalty_multiplier;</div>
<div class="line">     <span class="keywordflow">if</span> (hess_part &gt; 0)</div>
<div class="line">       test_penalty_multiplier =</div>
<div class="line">         (grad_part + .5 hess_part) / (.05 constraint_norm);</div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       test_penalty_multiplier = (grad_part) / (.05 constraint_norm);</div>
<div class="line">  </div>
<div class="line">     penalty_multiplier = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(penalty_multiplier, test_penalty_multiplier);</div>
</div><!-- fragment --><p>Based on all of this, we can now compute step sizes for the primal and dual (Lagrange multiplier) variables. Once we have these, we scale the components of the solution vector, and that is what this function returns.</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> std::pair&lt;double, double&gt; max_step_sizes =</div>
<div class="line">    calculate_max_step_size(nonlinear_solution, <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> step_size_s = max_step_sizes.first;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> step_size_z = max_step_sizes.second;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>)= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SolutionBlocks::displacement</a>)= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>)= step_size_z;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)= step_size_z;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>)= step_size_z;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)= step_size_s;</div>
<div class="line">  <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>)= step_size_z;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Computingascaledstep"></a> </p><h4>Computing a scaled step</h4>
<p>The next function then implements a back-tracking algorithm for a line search. It keeps shrinking step size until it finds a step where the merit is decreased, and then returns the new location based on the current state vector, and the direction to go into, times the step length.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a></div>
<div class="line">   SANDTopOpt&lt;dim&gt;::compute_scaled_step(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                                        <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;max_step,</div>
<div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">double</span> descent_requirement)</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> merit_derivative =</div>
<div class="line">       (calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4 max_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">        calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>)) /</div>
<div class="line">       1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4;</div>
<div class="line">     <span class="keywordtype">double</span>       step_size                 = 1;</div>
<div class="line">     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_linesearch_iterations = 10;</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_linesearch_iterations; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordflow">if</span> (calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + step_size max_step) &lt;</div>
<div class="line">             calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) +</div>
<div class="line">               step_size descent_requirement merit_derivative)</div>
<div class="line">           <span class="keywordflow">break</span>;</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">           step_size = step_size / 2;</div>
<div class="line">       }</div>
<div class="line">     <span class="keywordflow">return</span> <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + (step_size max_step);</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="Checkingforconvergence"></a> </p><h4>Checking for convergence</h4>
<p>The final auxiliary function in this block is the one that checks to see if the KKT conditions are sufficiently met so that the overall algorithm can lower the barrier size. It does so by computing the \(l_1\) norm of the residual, which is what <code>calculate_test_rhs()</code> computes.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">bool</span> SANDTopOpt&lt;dim&gt;::check_convergence(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs      = calculate_test_rhs(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>              test_rhs_norm = test_rhs.<a class="code" href="classBlockVectorBase.html#a5253082a5591dc0d13fef1d65a3dbfae">l1_norm</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> convergence_condition = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-2;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> target_norm           = convergence_condition barrier_size;</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;    Checking convergence. Current rhs norm is &quot;</span></div>
<div class="line">            &lt;&lt; test_rhs_norm &lt;&lt; <span class="stringliteral">&quot;, target is &quot;</span> &lt;&lt; target_norm &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (test_rhs_norm &lt; target_norm);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Postprocessingthesolution"></a> </p><h3>Postprocessing the solution</h3>
<p>The first of the postprocessing functions outputs information in a VTU file for visualization. It looks long, but it's really just the same as what was done in <a class="el" href="step_22.html">step-22</a>, for example, just with (a lot) more solution variables:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;std::string&gt; solution_names(1, <span class="stringliteral">&quot;density&quot;</span>);</div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    data_component_interpretation(</div>
<div class="line">      1, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line">      data_component_interpretation.push_back(</div>
<div class="line">        <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    }</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;unfiltered_density&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    {</div>
<div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;displacement_multiplier&quot;</span>);</div>
<div class="line">      data_component_interpretation.push_back(</div>
<div class="line">        <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    }</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;unfiltered_density_multiplier&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;low_slack&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;low_slack_multiplier&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;high_slack&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;high_slack_multiplier&quot;</span>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(nonlinear_solution,</div>
<div class="line">                           solution_names,</div>
<div class="line">                           <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                           data_component_interpretation);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution&quot;</span> + <a class="code" href="group__Exceptions.html#ga72743302dcb1a0fb1f2f8dc5122d299e">std::to_string</a>(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>) + <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The second of these functions outputs the solution as an <code>.stl</code> file for 3d printing. <a href="https://en.wikipedia.org/wiki/STL_(file_format)">STL</a> files are made up of triangles and normal vectors, and we will use it to show all of those cells with a density value larger than zero by first extruding the mesh from a \(z\) value of zero to \(z=0.25\), and then generating two triangles for each face of the cells with a sufficiently large density value. The triangle nodes must go counter-clockwise when looking from the outside, and the normal vectors must be unit vectors pointing outwards, which requires a few checks.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::write_as_stl()</div>
<div class="line">{</div>
<div class="line">  static_assert(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2,</div>
<div class="line">                <span class="stringliteral">&quot;This function is not implemented for anything &quot;</span></div>
<div class="line">                <span class="stringliteral">&quot;other than the 2d case.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::ofstream stlfile;</div>
<div class="line">  stlfile.open(<span class="stringliteral">&quot;bridge.stl&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  stlfile &lt;&lt; <span class="stringliteral">&quot;solid bridge\n&quot;</span> &lt;&lt; <a class="code" href="table__handler__0_8txt.html#ac42f579ca4a40d2835c1abb1cb95121d">std::scientific</a>;</div>
<div class="line">  <span class="keywordtype">double</span> height = .25;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (nonlinear_solution.block(</div>
<div class="line">            <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()] &gt; 0.5)</div>
<div class="line">        {</div>
</div><!-- fragment --><p>We have now found a cell with a density value larger than zero. Let us start by writing out the bottom and top faces. Owing to the ordering issue mentioned above, we have to make sure that we understand whether a cell has a right- or left-handed coordinate system. We do this by interrogating the directions of the two edges starting at vertex 0 and whether they form a right-handed coordinate system.</p>
<div class="fragment"><div class="line">             <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> edge_directions[2] = {<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                                                          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0),</div>
<div class="line">                                                        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                                                          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)};</div>
<div class="line">             <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> edge_tensor(</div>
<div class="line">               {{edge_directions[0][0], edge_directions[0][1]},</div>
<div class="line">                {edge_directions[1][0], edge_directions[1][1]}});</div>
<div class="line">             <span class="keyword">const</span> <span class="keywordtype">bool</span> is_right_handed_cell = (<a class="code" href="classSymmetricTensor.html#a7c03a03a5fe823733e7af9f7e4267f81">determinant</a>(edge_tensor) &gt; 0);</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">if</span> (is_right_handed_cell)</div>
<div class="line">               {</div>
<div class="line">                  [4.x.11] </div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt;</div>
<div class="line">  </div>
<div class="line">-1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt;</div>
<div class="line">  </div>
<div class="line">-1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">  </div>
<div class="line">                  [4.x.12] </div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">               }</div>
<div class="line">             <span class="keywordflow">else</span>  [4.x.13] </div>
<div class="line">               {</div>
<div class="line">                  [4.x.14] </div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt;</div>
<div class="line">  </div>
<div class="line">-1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt;</div>
<div class="line">  </div>
<div class="line">-1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">  </div>
<div class="line">                  [4.x.15] </div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                 stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">               }</div>
</div><!-- fragment --><p>Next we need to deal with the four faces of the cell, extended into the \(z\) direction. However, we only need to write these faces if either the face is on the domain boundary, or if it is the interface between a cell with density greater than 0.5, and a cell with a density less than 0.5.</p>
<div class="fragment"><div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_number = 0;</div>
<div class="line">                  face_number &lt; GeometryInfo&lt;dim&gt;::faces_per_cell;</div>
<div class="line">                  ++face_number)</div>
<div class="line">               {</div>
<div class="line">                 <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::face_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> =</div>
<div class="line">                   <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face(face_number);</div>
<div class="line">  </div>
<div class="line">                 <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary()) ||</div>
<div class="line">                     (!<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                      (nonlinear_solution.block(</div>
<div class="line">                         0)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;neighbor(face_number)-&gt;active_cell_index()] &lt;</div>
<div class="line">                       0.5)))</div>
<div class="line">                   {</div>
<div class="line">                     <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> normal_vector =</div>
<div class="line">                       (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center());</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">double</span> normal_norm = normal_vector.<a class="code" href="classTensor.html#afd0934b4edd71063f66a9c67540e79fc">norm</a>();</div>
<div class="line">                     <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0])</div>
<div class="line">                             (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1]</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1])</div>
<div class="line">                             0.000000<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>+00 +</div>
<div class="line">                           (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) (0</div>
<div class="line">  </div>
<div class="line">- 0)</div>
<div class="line">                             normal_vector[0] +</div>
<div class="line">                           (height</div>
<div class="line">  </div>
<div class="line">- 0)</div>
<div class="line">                             (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0])</div>
<div class="line">                             normal_vector[1]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                           (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) (0</div>
<div class="line">  </div>
<div class="line">- 0)</div>
<div class="line">                             normal_vector[1]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                           (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a07bb39fb970c095c229ed653f6be7030">vertex</a>(0)[1]</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a07bb39fb970c095c229ed653f6be7030">vertex</a>(0)[1])</div>
<div class="line">                             (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a07bb39fb970c095c229ed653f6be7030">vertex</a>(1)[0]</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a07bb39fb970c095c229ed653f6be7030">vertex</a>(0)[0])</div>
<div class="line">                             normal_vector[0]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                           (height</div>
<div class="line">  </div>
<div class="line">- 0)</div>
<div class="line">                             (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a07bb39fb970c095c229ed653f6be7030">vertex</a>(1)[1]</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a07bb39fb970c095c229ed653f6be7030">vertex</a>(0)[1]) 0 &gt;</div>
<div class="line">                         0)</div>
<div class="line">                       {</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                 &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                 &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                       }</div>
<div class="line">                     <span class="keywordflow">else</span></div>
<div class="line">                       {</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                 &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                 &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                         stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                       }</div>
<div class="line">                   }</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">       }</div>
<div class="line">     stlfile &lt;&lt; <span class="stringliteral">&quot;endsolid bridge&quot;</span>;</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="Therunfunctiondrivingtheoverallalgorithm"></a> </p><h3>The <a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a> function driving the overall algorithm</h3>
<p>This function finally provides the overall driver logic. It is, in the grand scheme of things, a rather complicated function primarily because the optimization algorithm is difficult: It isn't just about finding a Newton direction like in <a class="el" href="step_15.html">step-15</a> and then going a fixed distance in this direction any more, but instead about (i) determining what the optimal log-barrier penalty parameter should be in the current step, (ii) a complicated algorithm to determine how far we want to go, and other ingredients. Let us see how we can break this down into smaller chunks in the following documentation.</p>
<p>The function starts out simple enough with first setting up the mesh, the <a class="el" href="classDoFHandler.html">DoFHandler</a>, and then the various linear algebra objects necessary for the following:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">SANDTopOpt&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;filter r is: &quot;</span> &lt;&lt; filter_r &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;setup&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">create_triangulation</a>();</div>
<div class="line"> </div>
<div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">    setup_boundary_values();</div>
<div class="line">    setup_block_system();</div>
<div class="line">    setup_filter_matrix();</div>
<div class="line">  }</div>
</div><!-- fragment --><p>We then set a number of parameters that affect the log-barrier and line search components of the optimization algorithm:</p>
<div class="fragment"><div class="line">barrier_size                  = 25;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> min_barrier_size = .0005;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_uphill_steps    = 8;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span>       descent_requirement = .0001;</div>
</div><!-- fragment --><p>Now start the principal iteration. The overall algorithm works by using an outer loop in which we loop until either (i) the log-barrier parameter has become small enough, or (ii) we have reached convergence. In any case, we terminate if end up with too large a number of iterations. This overall structure is encoded as a <code>do { ... } while (...)</code> loop where the convergence condition is at the bottom.</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       iteration_number = 0;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_iterations   = 10000;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">do</span></div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Starting outer step in iteration &quot;</span> &lt;&lt; iteration_number</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; with barrier parameter &quot;</span> &lt;&lt; barrier_size &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>Within this outer loop, we have an inner loop in which we try to find an update direction using the watchdog algorithm described in the introduction.</p>
<p>The general idea of the watchdog algorithm itself is this: For a maximum of <code>max_uphill_steps</code> (i.e., a loop within the "inner loop" mentioned above) attempts, we use <code>find_max_step()</code> to compute a Newton update step, and add these up in the <code>nonlinear_solution</code> vector. In each of these attempts (starting from the place reached at the end of the previous attempt), we check whether we have reached a target value of the merit function described above. The target value is computed based on where this algorithm starts (the <code>nonlinear_solution</code> at the beginning of the watchdog loop, saves as <code>watchdog_state</code>) and the first proposed direction provided by <code>find_max_step()</code> in the first go-around of this loop (the <code>k==0</code> case).</p>
<div class="fragment"><div class="line">         <span class="keywordflow">do</span></div>
<div class="line">           {</div>
<div class="line">             std::cout &lt;&lt; <span class="stringliteral">&quot;  Starting inner step in iteration &quot;</span></div>
<div class="line">                       &lt;&lt; iteration_number</div>
<div class="line">                       &lt;&lt; <span class="stringliteral">&quot; with merit function penalty multiplier &quot;</span></div>
<div class="line">                       &lt;&lt; penalty_multiplier &lt;&lt; std::endl;</div>
<div class="line">  </div>
<div class="line">             <span class="keywordtype">bool</span> watchdog_step_found = <span class="keyword">false</span>;</div>
<div class="line">  </div>
<div class="line">             <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> watchdog_state = nonlinear_solution;</div>
<div class="line">             <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a>       first_step;</div>
<div class="line">             <span class="keywordtype">double</span> target_merit     = numbers::signaling_nan&lt;double&gt;();</div>
<div class="line">             <span class="keywordtype">double</span> merit_derivative = numbers::signaling_nan&lt;double&gt;();</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_uphill_steps; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">               {</div>
<div class="line">                 ++iteration_number;</div>
<div class="line">                 <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> update_step = find_max_step();</div>
<div class="line">  </div>
<div class="line">                 <span class="keywordflow">if</span> (<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> == 0)</div>
<div class="line">                   {</div>
<div class="line">                     first_step = update_step;</div>
<div class="line">                     merit_derivative =</div>
<div class="line">                       ((calculate_exact_merit(watchdog_state +</div>
<div class="line">                                               .0001 first_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                         calculate_exact_merit(watchdog_state)) /</div>
<div class="line">                        .0001);</div>
<div class="line">                     target_merit = calculate_exact_merit(watchdog_state) +</div>
<div class="line">                                    descent_requirement merit_derivative;</div>
<div class="line">                   }</div>
<div class="line">  </div>
<div class="line">                 nonlinear_solution += update_step;</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> current_merit =</div>
<div class="line">                   calculate_exact_merit(nonlinear_solution);</div>
<div class="line">  </div>
<div class="line">                 std::cout &lt;&lt; <span class="stringliteral">&quot;    current watchdog state merit is: &quot;</span></div>
<div class="line">                           &lt;&lt; current_merit &lt;&lt; <span class="stringliteral">&quot;; target merit is &quot;</span></div>
<div class="line">                           &lt;&lt; target_merit &lt;&lt; std::endl;</div>
<div class="line">  </div>
<div class="line">                 <span class="keywordflow">if</span> (current_merit &lt; target_merit)</div>
<div class="line">                   {</div>
<div class="line">                     watchdog_step_found = <span class="keyword">true</span>;</div>
<div class="line">                     std::cout &lt;&lt; <span class="stringliteral">&quot;    found workable step after &quot;</span> &lt;&lt; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> + 1</div>
<div class="line">                               &lt;&lt; <span class="stringliteral">&quot; iterations&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                     <span class="keywordflow">break</span>;</div>
<div class="line">                   }</div>
<div class="line">               }</div>
</div><!-- fragment --><p>The next part of the algorithm then depends on whether the watchdog loop above succeeded. If it did, then we are satisfied and no further action is necessary: We just stay where we are. If, however, we took the maximal number of unsuccessful steps in the loop above, then we need to do something else, and this is what the following code block does.</p>
<p>Specifically, from the final (unsuccessful) state of the loop above, we seek one more update direction and take what is called a "stretch
 step". If that stretch state satisfies a condition involving the merit function, then we go there. On the other hand, if the stretch state is also unacceptable (as all of the watchdog steps above were), then we discard all of the watchdog steps taken above and start over again where we had started the watchdog iterations</p>
<p>&ndash; that place was stored in the <code>watchdog_state</code> variable above. More specifically, the conditions below first test whether we take a step from <code>watchdog_state</code> in direction <code>first_step</code>, or whether we can do one more update from the stretch state to find a new place. It is possible that neither of these is actually better than the state we started from at the beginning of the watchdog algorithm, but even if that is so, that place clearly was a difficult place to be in, and getting away to start the next iteration from another place might be a useful strategy to eventually converge.</p>
<p>We keep repeating the watchdog steps above along with the logic below until this inner iteration is finally converged (or if we run up against the maximal number of iterations</p>
<p>&ndash; where we count the number of linear solves as iterations and increment the counter every time we call <code>find_max_step()</code> since that is where the linear solve actually happens). In any case, at the end of each of these inner iterations we also output the solution in a form suitable for visualization.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (watchdog_step_found == <span class="keyword">false</span>)</div>
<div class="line">  {</div>
<div class="line">    ++iteration_number;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> update_step = find_max_step();</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> stretch_state =</div>
<div class="line">      compute_scaled_step(nonlinear_solution,</div>
<div class="line">                          update_step,</div>
<div class="line">                          descent_requirement);</div>
</div><!-- fragment --><p>If we did not get a successful watchdog step, we now need to decide between going back to where we started, or using the final state. We compare the merits of both of these locations, and then take a scaled step from whichever location is better. As the scaled step is guaranteed to lower the merit, we will end up keeping one of the two.</p>
<div class="fragment"><div class="line">        <span class="keywordflow">if</span> ((calculate_exact_merit(nonlinear_solution) &lt;</div>
<div class="line">             calculate_exact_merit(watchdog_state)) ||</div>
<div class="line">            (calculate_exact_merit(stretch_state) &lt; target_merit))</div>
<div class="line">          {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;    Taking scaled step from end of watchdog&quot;</span></div>
<div class="line">                      &lt;&lt; std::endl;</div>
<div class="line">            nonlinear_solution = stretch_state;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            std::cout</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;    Taking scaled step from beginning of watchdog&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">            <span class="keywordflow">if</span> (calculate_exact_merit(stretch_state) &gt;</div>
<div class="line">                calculate_exact_merit(watchdog_state))</div>
<div class="line">              {</div>
<div class="line">                nonlinear_solution =</div>
<div class="line">                  compute_scaled_step(watchdog_state,</div>
<div class="line">                                      first_step,</div>
<div class="line">                                      descent_requirement);</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              {</div>
<div class="line">                ++iteration_number;</div>
<div class="line">                nonlinear_solution = stretch_state;</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> stretch_step =</div>
<div class="line">                  find_max_step();</div>
<div class="line">                nonlinear_solution =</div>
<div class="line">                  compute_scaled_step(nonlinear_solution,</div>
<div class="line">                                      stretch_step,</div>
<div class="line">                                      descent_requirement);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    output_results(iteration_number);</div>
<div class="line">  }</div>
<div class="line"><span class="keywordflow">while</span> ((iteration_number &lt; max_iterations) &amp;&amp;</div>
<div class="line">       (check_convergence(nonlinear_solution) == <span class="keyword">false</span>));</div>
</div><!-- fragment --><p>At the end of the outer loop, we have to update the barrier parameter, for which we use the following formula. The rest of the function is then simply about checking the outer loop convergence condition, and if we decide to terminate computations, about writing the final "design" as an STL file for use in 3d printing, and to output some timing information.</p>
<div class="fragment"><div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> barrier_size_multiplier = .8;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> barrier_size_exponent   = 1.2;</div>
<div class="line"> </div>
<div class="line">        barrier_size =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(barrier_size barrier_size_multiplier,</div>
<div class="line">                            std::pow(barrier_size, barrier_size_exponent)),</div>
<div class="line">                   min_barrier_size);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (((barrier_size &gt; min_barrier_size) ||</div>
<div class="line">            (check_convergence(nonlinear_solution) == <span class="keyword">false</span>)) &amp;&amp;</div>
<div class="line">           (iteration_number &lt; max_iterations));</div>
<div class="line"> </div>
<div class="line">    write_as_stl();</div>
<div class="line">    timer.<a class="code" href="classTimerOutput.html#a133e7d844826bc8716898fb2f86fb9b6">print_summary</a>();</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace SAND</span></div>
</div><!-- fragment --><p><a class="anchor" id="Themainfunction"></a> </p><h3>The main function</h3>
<p>The remainder of the code, the <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> function, is as usual:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classSAND_1_1SANDTopOpt.html">SAND::SANDTopOpt&lt;2&gt;</a> elastic_problem_2d;</div>
<div class="line">      elastic_problem_2d.<a class="code" href="classSAND_1_1SANDTopOpt.html#a1ab26b7b2bb38e7f74a85a5c729484e4">run</a>();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="TestProblem"></a></p><h3>Test Problem</h3>
<p>The algorithms used above are tested against a traditional topology optimization problem called the Messerschmitt-Bolkow-Blohm Beam (MBB Beam).</p>
<p>This problem considers the optimal 2-d structure that can be built on a rectangle 6 units wide, and 1 unit tall. The bottom corners are fixed in place in the \(y\) direction using a zero Dirichlet boundary condition, and a downward force is applied in the center of the top of the beam by enforcing a Neumann boundary condition. The rest of the boundary is allowed to move, and has no external force applied, which takes the form of a zero Neumann boundary condition. In essence, we are asking the following question: How should we design a bridge in a way so that if the bottom left and bottom right point of the bridge are on rollers that allow these points to move horizontally but not vertically, and so that the displacement in response to the vertical force in the center is minimal.</p>
<p>While the total volume of the domain is 6 units, 3 units of material are allowed for the structure. Because of the symmetry of the problem, it could be posed on a rectangle of width 3 and height 1 by cutting the original domain in half, and using zero Dirichlet boundary conditions in the \(x\) direction along the cut edge. That said, symmetry of the solution is a good indicator that the program is working as expected, so we solved the problem on the whole domain, as shown below. <b>[Bendse2004]</b></p>
<div style="text-align:center;"> <img src="https://www.dealii.org/images/steps/developer/step-79.mbbgeometry.png" alt="The MBB problem domain and boundary conditions" class="inline"/> </div><p>Using the program discussed above, we find the minimum volume of the MBB Beam and the individual components of the solution look as follows:</p>
<div class="onecolumn" style="width: 80%; text-align: center;"> <div> <img src="https://www.dealii.org/images/steps/developer/step-79.filtereddensity.png" alt="Filtered Density Solution" class="inline"/> </div> <div> <img src="https://www.dealii.org/images/steps/developer/step-79.unfiltereddensity.png" alt="Unfiltered Density Solution" class="inline"/> </div> </div><p> <br  />
</p>
<p>These pictures show that what we find here is in accordance with what onetypically sees in other publications on the topic <b>[Bendse2004]</b> . Maybe more interestingly, theresult looks like a truss bridge (except that we apply the load at the top ofthe trusses, rather than the bottom as in real truss bridges, akin to a "decktruss" bridge), suggesting that the designs that have been used in bridge-building for centuries are indeed based on ideas we can now show to be optimalin some sense.</p>
<p><a class="anchor" id="Possibilitiesforextensions"></a></p><h4>Possibilities for extensions</h4>
<p>The results shown above took around 75 iterations to find, which is quiteconcerning given the expense in solving the large linear systems in eachiteration. Looking at the evolution, it does look as though the convergence hasmoments of happening quickly and moments of happening slowly. We believe this tobe due to both a lack of precision on when and how to decrease the boundaryvalues, as well as our choice of merit function being sub-optimal. In the future,a LOQO barrier update replacing the monotone reduction, as well as a MarkovFilter in place of a merit function will decrease the number of necessaryiterations significantly. The barrier decrease is most sensitive in the middle of the convergence, whichis problematic, as it seems like we need it to decrease quickly, then slowly,then quickly again. Secondly, the linear solver used here is just the sparse direct solver based onthe <a class="el" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> class. This works reasonably well on small problems,but the formulation of the optimization problem detailed above has quite a largenumber of variables and so the linear problem is not only large but also has alot of nonzero entries in many rows, even on meshes that overall are stillrelatively coarse. As a consequence, the solver time dominates thecomputations, and more sophisticated approaches at solving the linear systemare necessary.</p>
<p><a class="anchor" id="PlainProg"></a></p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Justin O&#39;Connor, Colorado State University, 2021.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2tensor_8h.html">deal.II/base/tensor.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2signaling__nan_8h.html">deal.II/base/signaling_nan.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparse__matrix_8h.html">deal.II/lac/block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2linear__operator_8h.html">deal.II/lac/linear_operator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2packaged__operation_8h.html">deal.II/lac/packaged_operation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgq_8h.html">deal.II/fe/fe_dgq.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceSAND.html">SAND</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>SolutionComponents</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a> = 0;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">displacement</a> = 1;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a> = 1 + <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">displacement_multiplier</a> = 2 + <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a> = 2 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a> = 3 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a> = 4 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a> = 5 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a> = 6 + 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  } <span class="comment">// namespace SolutionComponents</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>SolutionBlocks</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>                        = 0;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">displacement</a>                   = 1;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a>             = 2;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">displacement_multiplier</a>        = 3;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a>  = 4;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a>            = 5;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a> = 6;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a>            = 7;</div>
<div class="line">    constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a> = 8;</div>
<div class="line">  } <span class="comment">// namespace SolutionBlocks</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>BoundaryIds</div>
<div class="line">  {</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">down_force</a> = 101;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">no_force</a>   = 102;</div>
<div class="line">  } <span class="comment">// namespace BoundaryIds</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>ValueExtractors</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ac221049fbb9ba83a17d1078474c4a747">densities</a>(SolutionComponents::density&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a8cd7076dfb3722290a423c54fc25f28d">displacements</a>(SolutionComponents::displacement&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ae502a219c72947e0c0abc6bc5d318a11">unfiltered_densities</a>(SolutionComponents::unfiltered_density&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a75b37471806be11bfd15238908ef2570">displacement_multipliers</a>(</div>
<div class="line">      SolutionComponents::displacement_multiplier&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a07e1e8cad70f4d40499893eb4e603205">unfiltered_density_multipliers</a>(</div>
<div class="line">      SolutionComponents::unfiltered_density_multiplier&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a149b969d62b110112ced6d4a4a467494">density_lower_slacks</a>(SolutionComponents::density_lower_slack&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#ada143f177c93011d19b9753f7af32d57">density_lower_slack_multipliers</a>(</div>
<div class="line">      SolutionComponents::density_lower_slack_multiplier&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div>
<div class="line">      <a class="code" href="namespaceSAND_1_1ValueExtractors.html#a30f363fe7c63c168353b72e3a2dd28c4">density_upper_slacks</a>(SolutionComponents::density_upper_slack&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="namespaceSAND_1_1ValueExtractors.html#af74f3b334f9c0a375c5b7afd07335505">density_upper_slack_multipliers</a>(</div>
<div class="line">      SolutionComponents::density_upper_slack_multiplier&lt;dim&gt;);</div>
<div class="line">  } <span class="comment">// namespace ValueExtractors</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>SANDTopOpt</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SANDTopOpt();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">create_triangulation</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setup_boundary_values();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setup_block_system();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setup_filter_matrix();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">    std::pair&lt;double, double&gt;</div>
<div class="line">    calculate_max_step_size(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                            <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a></div>
<div class="line">    calculate_test_rhs(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> calculate_exact_merit(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> find_max_step();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> compute_scaled_step(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                                            <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>,</div>
<div class="line">                                            <span class="keyword">const</span> <span class="keywordtype">double</span> descent_requirement);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> check_convergence(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> write_as_stl();</div>
<div class="line"> </div>
<div class="line">    std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt;</div>
<div class="line">    find_relevant_neighbors(</div>
<div class="line">      <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">    std::map&lt;types::global_dof_index, double&gt; boundary_values;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line">    <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      filter_sparsity_pattern;</div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> filter_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> system_rhs;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> nonlinear_solution;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> density_ratio;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> density_penalty_exponent;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> filter_r;</div>
<div class="line">    <span class="keywordtype">double</span>       penalty_multiplier;</div>
<div class="line">    <span class="keywordtype">double</span>       barrier_size;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTimerOutput.html">TimerOutput</a> timer;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classSAND_1_1SANDTopOpt.html#a12d2d4c43a7806a69dc6df81b97e1c07">SANDTopOpt&lt;dim&gt;::SANDTopOpt</a>()</div>
<div class="line">    : <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(<a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">         1,</div>
<div class="line">         (<a class="code" href="classFESystem.html">FESystem</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1) ^ <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)),</div>
<div class="line">         1,</div>
<div class="line">         <a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">         1,</div>
<div class="line">         (<a class="code" href="classFESystem.html">FESystem</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1) ^ <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)),</div>
<div class="line">         1,</div>
<div class="line">         <a class="code" href="classFE__DGQ.html">FE_DGQ</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(0),</div>
<div class="line">         5)</div>
<div class="line">    , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    , density_ratio(.5)</div>
<div class="line">    , density_penalty_exponent(3)</div>
<div class="line">    , filter_r(.251)</div>
<div class="line">    , penalty_multiplier(1)</div>
<div class="line">    , timer(std::cout, <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary, <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> &gt; 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">SANDTopOpt&lt;dim&gt;::create_triangulation</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                              {6, 1},</div>
<div class="line">                                              <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 0),</div>
<div class="line">                                              <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(6, 1));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(3);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a> = <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center();</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(1) - 1) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keywordflow">if</span> ((<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(0) - 3) &lt; .3))</div>
<div class="line">                      <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>);</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                      <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">BoundaryIds::no_force</a>);</div>
<div class="line">                  }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                  <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">BoundaryIds::no_force</a>);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_boundary_values()</div>
<div class="line">  {</div>
<div class="line">    boundary_values.clear();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a> = <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center();</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a>(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> vertex_number : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_indices())</div>
<div class="line">                      {</div>
<div class="line">                        <span class="keyword">const</span> <span class="keyword">auto</span> vert = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(vertex_number);</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(0) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 &amp;&amp;</div>
<div class="line">                            <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                          {</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> x_displacement =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 0);</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 1);</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> x_displacement_multiplier =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 2);</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement_multiplier =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 3);</div>
<div class="line"> </div>
<div class="line">                            boundary_values[x_displacement]            = 0;</div>
<div class="line">                            boundary_values[y_displacement]            = 0;</div>
<div class="line">                            boundary_values[x_displacement_multiplier] = 0;</div>
<div class="line">                            boundary_values[y_displacement_multiplier] = 0;</div>
<div class="line">                          }</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(0) - 6) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 &amp;&amp;</div>
<div class="line">                                 <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(vert(1) - 0) &lt; 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12)</div>
<div class="line">                          {</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 1);</div>
<div class="line">                            <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> y_displacement_multiplier =</div>
<div class="line">                              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(vertex_number, 3);</div>
<div class="line"> </div>
<div class="line">                            boundary_values[y_displacement]            = 0;</div>
<div class="line">                            boundary_values[y_displacement_multiplier] = 0;</div>
<div class="line">                          }</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_block_system()</div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;unsigned int&gt; block_component(9, 2);</div>
<div class="line">    block_component[0] = 0;</div>
<div class="line">    block_component[1] = 1;</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a>                     n_p = dofs_per_block[0];</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a>                     n_u = dofs_per_block[1];</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="namespaceLinearAlgebra_1_1CUDAWrappers_1_1kernel.html#aa63f11d31d19bd16be69280eac69dd10">std::vector&lt;BlockVector&lt;double&gt;::size_type</a>&gt; block_sizes = {</div>
<div class="line">      n_p, n_u, n_p, n_u, n_p, n_p, n_p, n_p, n_p};</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(9, 9);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; 9; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; 9; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">        dsp.block(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(block_sizes[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>], block_sizes[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]);</div>
<div class="line">    dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 7, 2 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 7);</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>SolutionComponents;</div>
<div class="line"> </div>
<div class="line">      coupling[density&lt;dim&gt;][density&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          coupling[density&lt;dim&gt;][displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          coupling[displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][density&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          coupling[density&lt;dim&gt;][displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] =</div>
<div class="line">            <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          coupling[displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][density&lt;dim&gt;] =</div>
<div class="line">            <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      coupling[density&lt;dim&gt;][unfiltered_density_multiplier&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[unfiltered_density_multiplier&lt;dim&gt;][density&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* Coupling for displacement */</span></div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              coupling[displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">                      [displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">              coupling[displacement_multiplier&lt;dim&gt; + <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]</div>
<div class="line">                      [displacement&lt;dim&gt; + <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* Coupling for slack variables */</span></div>
<div class="line">      coupling[density_lower_slack&lt;dim&gt;][density_lower_slack&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[density_lower_slack&lt;dim&gt;][density_upper_slack&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[density_upper_slack&lt;dim&gt;][density_lower_slack&lt;dim&gt;] =</div>
<div class="line">        <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">      coupling[density_lower_slack_multiplier&lt;dim&gt;]</div>
<div class="line">              [density_lower_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[density_lower_slack_multiplier&lt;dim&gt;]</div>
<div class="line">              [density_upper_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      coupling[density_upper_slack_multiplier&lt;dim&gt;]</div>
<div class="line">              [density_lower_slack_multiplier&lt;dim&gt;] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classComponentMask.html">ComponentMask</a> density_mask =</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(ValueExtractors::densities&lt;dim&gt;);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> density_dofs =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a45f4d01f1c4c6337e4be6f10a81fbdab">DoFTools::extract_dofs</a>(dof_handler, density_mask);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a> last_density_dof =</div>
<div class="line">      density_dofs.<a class="code" href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">nth_index_in_set</a>(density_dofs.<a class="code" href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">n_elements</a>() - 1);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">add_line</a>(last_density_dof);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; density_dofs.<a class="code" href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">n_elements</a>() - 1; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a2b7756e9cb8e53553211add5426f8e50">add_entry</a>(last_density_dof,</div>
<div class="line">                            density_dofs.<a class="code" href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">nth_index_in_set</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>),</div>
<div class="line">                            -1);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">set_inhomogeneity</a>(last_density_dof, 0);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, coupling, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell : find_relevant_neighbors(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(check_cell-&gt;center());</div>
<div class="line">            <span class="keywordflow">if</span> (distance &lt; filter_r)</div>
<div class="line">              {</div>
<div class="line">                dsp</div>
<div class="line">                  .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                         <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)</div>
<div class="line">                  .<a class="code" href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">add</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, check_cell-&gt;active_cell_index());</div>
<div class="line">                dsp</div>
<div class="line">                  .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">                         <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)</div>
<div class="line">                  .<a class="code" href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">add</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, check_cell-&gt;active_cell_index());</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>(<span class="stringliteral">&quot;sparsity.plt&quot;</span>);</div>
<div class="line">    <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.print_gnuplot(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>);</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    nonlinear_solution.reinit(block_sizes);</div>
<div class="line">    system_rhs.reinit(block_sizes);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>SolutionBlocks;</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>).add(density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">unfiltered_density</a>).add(density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">unfiltered_density_multiplier</a>)</div>
<div class="line">        .add(density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">density_lower_slack</a>).add(density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">density_lower_slack_multiplier</a>).add(50);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">density_upper_slack</a>).add(1 - density_ratio);</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">density_upper_slack_multiplier</a>).add(50);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::setup_filter_matrix()</div>
<div class="line">  {</div>
<div class="line"> </div>
<div class="line">    filter_sparsity_pattern.copy_from(</div>
<div class="line">      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                             <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line">    filter_matrix.reinit(filter_sparsity_pattern);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell : find_relevant_neighbors(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(check_cell-&gt;center());</div>
<div class="line">            <span class="keywordflow">if</span> (distance &lt; filter_r)</div>
<div class="line">              {</div>
<div class="line">                filter_matrix.add(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                  check_cell-&gt;active_cell_index(),</div>
<div class="line">                                  filter_r - distance);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; filter_matrix.m(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> denominator = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="classSparseMatrix.html#ac94776653684705604fea3dae0af35f4">SparseMatrix&lt;double&gt;::iterator</a> iter = filter_matrix.begin(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter++)</div>
<div class="line">          denominator = denominator + iter-&gt;<a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>();</div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="classSparseMatrix.html#ac94776653684705604fea3dae0af35f4">SparseMatrix&lt;double&gt;::iterator</a> iter = filter_matrix.begin(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter++)</div>
<div class="line">          iter-&gt;value() = iter-&gt;value() / denominator;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt;</div>
<div class="line">  SANDTopOpt&lt;dim&gt;::find_relevant_neighbors(</div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::set&lt;unsigned int&gt;                               neighbor_ids;</div>
<div class="line">    std::set&lt;typename Triangulation&lt;dim&gt;::cell_iterator&gt; cells_to_check;</div>
<div class="line"> </div>
<div class="line">    neighbor_ids.insert(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index());</div>
<div class="line">    cells_to_check.insert(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> new_neighbors_found;</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        new_neighbors_found = <span class="keyword">false</span>;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;check_cell :</div>
<div class="line">             <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::cell_iterator</a>&gt;(</div>
<div class="line">               cells_to_check.begin(), cells_to_check.end()))</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a> : check_cell-&gt;face_indices())</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">if</span> (!(check_cell-&gt;face(<a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a>)-&gt;at_boundary()))</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <span class="keyword">auto</span> &amp; <a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a> = check_cell-&gt;neighbor(<a class="code" href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a>);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> distance =</div>
<div class="line">                      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center().distance(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;center());</div>
<div class="line">                    <span class="keywordflow">if</span> ((distance &lt; filter_r) &amp;&amp;</div>
<div class="line">                        !(neighbor_ids.count(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;active_cell_index())))</div>
<div class="line">                      {</div>
<div class="line">                        cells_to_check.insert(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>);</div>
<div class="line">                        neighbor_ids.insert(<a class="code" href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a>-&gt;active_cell_index());</div>
<div class="line">                        new_neighbors_found = <span class="keyword">true</span>;</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (new_neighbors_found);</div>
<div class="line">    <span class="keywordflow">return</span> cells_to_check;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::assemble_system()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;assembly&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    system_matrix = 0;</div>
<div class="line">    system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a> <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>          quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt;      face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>        fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>    fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                     <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                     face_quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     dummy_cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;                    lambda_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;                    mu_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(1.);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="namespacemu.html">mu</a>(1.);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;            rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filtered_unfiltered_density_solution =</div>
<div class="line">      nonlinear_solution;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filter_adjoint_unfiltered_density_multiplier_solution =</div>
<div class="line">      nonlinear_solution;</div>
<div class="line"> </div>
<div class="line">    filter_matrix.vmult(filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>),</div>
<div class="line">                        nonlinear_solution.block(</div>
<div class="line">                          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>));</div>
<div class="line">    filter_matrix.Tvmult(</div>
<div class="line">      filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">        <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>),</div>
<div class="line">      nonlinear_solution.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;                  old_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;          old_displacement_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  old_displacement_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_symmgrads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_displacement_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_displacement_multiplier_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_multiplier_symmgrads(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_lower_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_upper_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_lower_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_upper_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_unfiltered_density_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; filtered_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; filter_adjoint_unfiltered_density_multiplier_values(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using namespace </span>ValueExtractors;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.value_list(fe_values.get_quadrature_points(), lambda_values);</div>
<div class="line">        <a class="code" href="namespacemu.html">mu</a>.value_list(fe_values.get_quadrature_points(), mu_values);</div>
<div class="line"> </div>
<div class="line">        fe_values[densities&lt;dim&gt;].get_function_values(nonlinear_solution,</div>
<div class="line">                                                      old_density_values);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_displacement_values);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_divergences(</div>
<div class="line">          nonlinear_solution, old_displacement_divs);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_symmetric_gradients(</div>
<div class="line">          nonlinear_solution, old_displacement_symmgrads);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_displacement_multiplier_values);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].get_function_divergences(</div>
<div class="line">          nonlinear_solution, old_displacement_multiplier_divs);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">          .get_function_symmetric_gradients(</div>
<div class="line">            nonlinear_solution, old_displacement_multiplier_symmgrads);</div>
<div class="line">        fe_values[density_lower_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_lower_slack_values);</div>
<div class="line">        fe_values[density_lower_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_lower_slack_multiplier_values);</div>
<div class="line">        fe_values[density_upper_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_upper_slack_values);</div>
<div class="line">        fe_values[density_upper_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_upper_slack_multiplier_values);</div>
<div class="line">        fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_unfiltered_density_values);</div>
<div class="line">        fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          nonlinear_solution, old_unfiltered_density_multiplier_values);</div>
<div class="line">        fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">          filtered_unfiltered_density_solution,</div>
<div class="line">          filtered_unfiltered_density_values);</div>
<div class="line">        fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          filter_adjoint_unfiltered_density_multiplier_solution,</div>
<div class="line">          filter_adjoint_unfiltered_density_multiplier_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_i_symmgrad =</div>
<div class="line">                  fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_i_div =</div>
<div class="line">                  fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">                  displacement_multiplier_phi_i_symmgrad =</div>
<div class="line">                    fe_values[displacement_multipliers&lt;dim&gt;].symmetric_gradient(</div>
<div class="line">                      <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_i_div =</div>
<div class="line">                  fe_values[displacement_multipliers&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                      q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_i =</div>
<div class="line">                  fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_i =</div>
<div class="line">                  fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_i =</div>
<div class="line">                  fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                       q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_i =</div>
<div class="line">                  fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_i =</div>
<div class="line">                  fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_i =</div>
<div class="line">                  fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_i =</div>
<div class="line">                  fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> : fe_values.dof_indices())</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_j_symmgrad =</div>
<div class="line">                      fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>,</div>
<div class="line">                                                                       q_point);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_j_div =</div>
<div class="line">                      fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">                      displacement_multiplier_phi_j_symmgrad =</div>
<div class="line">                        fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">                          .symmetric_gradient(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_j_div =</div>
<div class="line">                      fe_values[displacement_multipliers&lt;dim&gt;].divergence(</div>
<div class="line">                        <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_j =</div>
<div class="line">                      fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_j =</div>
<div class="line">                      fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_j =</div>
<div class="line">                      fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(</div>
<div class="line">                        <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_j =</div>
<div class="line">                      fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_j =</div>
<div class="line">                      fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_j =</div>
<div class="line">                      fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                        <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_j =</div>
<div class="line">                      fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                        <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 1 */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (</div>
<div class="line"> </div>
<div class="line">                        -density_phi_i * unfiltered_density_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line">                        + density_penalty_exponent *</div>
<div class="line">                            (density_penalty_exponent - 1) *</div>
<div class="line">                            std::pow(old_density_values[q_point],</div>
<div class="line">                                     density_penalty_exponent - 2) *</div>
<div class="line">                            density_phi_i * density_phi_j *</div>
<div class="line">                            (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                               old_displacement_divs[q_point] *</div>
<div class="line">                               lambda_values[q_point] +</div>
<div class="line">                             2 * mu_values[q_point] *</div>
<div class="line">                               (old_displacement_symmgrads[q_point] *</div>
<div class="line">                                old_displacement_multiplier_symmgrads[q_point]))</div>
<div class="line"> </div>
<div class="line">                        + density_penalty_exponent *</div>
<div class="line">                            <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                     density_penalty_exponent - 1) *</div>
<div class="line">                            density_phi_i *</div>
<div class="line">                            (displacement_multiplier_phi_j_div *</div>
<div class="line">                               old_displacement_divs[q_point] *</div>
<div class="line">                               lambda_values[q_point] +</div>
<div class="line">                             2 * mu_values[q_point] *</div>
<div class="line">                               (old_displacement_symmgrads[q_point] *</div>
<div class="line">                                displacement_multiplier_phi_j_symmgrad))</div>
<div class="line"> </div>
<div class="line">                        + density_penalty_exponent *</div>
<div class="line">                            <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                     density_penalty_exponent - 1) *</div>
<div class="line">                            density_phi_i *</div>
<div class="line">                            (displacement_phi_j_div *</div>
<div class="line">                               old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                               lambda_values[q_point] +</div>
<div class="line">                             2 * mu_values[q_point] *</div>
<div class="line">                               (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                                displacement_phi_j_symmgrad)));</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 2 */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (density_penalty_exponent *</div>
<div class="line">                         <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                  density_penalty_exponent - 1) *</div>
<div class="line">                         density_phi_j *</div>
<div class="line">                         (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                            displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                          2 * mu_values[q_point] *</div>
<div class="line">                            (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                             displacement_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">                       + <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                  density_penalty_exponent) *</div>
<div class="line">                           (displacement_multiplier_phi_j_div *</div>
<div class="line">                              displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                            2 * mu_values[q_point] *</div>
<div class="line">                              (displacement_multiplier_phi_j_symmgrad *</div>
<div class="line">                               displacement_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">                      );</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 3, which has to do with the filter and which is</span></div>
<div class="line"><span class="comment">                     * calculated elsewhere. */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (-1 * unfiltered_density_phi_i *</div>
<div class="line">                         lower_slack_multiplier_phi_j +</div>
<div class="line">                       unfiltered_density_phi_i * upper_slack_multiplier_phi_j);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 4: Primal feasibility */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (</div>
<div class="line"> </div>
<div class="line">                        density_penalty_exponent *</div>
<div class="line">                          <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                   density_penalty_exponent - 1) *</div>
<div class="line">                          density_phi_j *</div>
<div class="line">                          (old_displacement_divs[q_point] *</div>
<div class="line">                             displacement_multiplier_phi_i_div *</div>
<div class="line">                             lambda_values[q_point] +</div>
<div class="line">                           2 * mu_values[q_point] *</div>
<div class="line">                             (old_displacement_symmgrads[q_point] *</div>
<div class="line">                              displacement_multiplier_phi_i_symmgrad))</div>
<div class="line"> </div>
<div class="line">                        + <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                   density_penalty_exponent) *</div>
<div class="line">                            (displacement_phi_j_div *</div>
<div class="line">                               displacement_multiplier_phi_i_div *</div>
<div class="line">                               lambda_values[q_point] +</div>
<div class="line">                             2 * mu_values[q_point] *</div>
<div class="line">                               (displacement_phi_j_symmgrad *</div>
<div class="line">                                displacement_multiplier_phi_i_symmgrad)));</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 5: Primal feasibility */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      -1 * fe_values.JxW(q_point) *</div>
<div class="line">                      lower_slack_multiplier_phi_i *</div>
<div class="line">                      (unfiltered_density_phi_j - lower_slack_phi_j);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 6: Primal feasibility */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      -1 * fe_values.JxW(q_point) *</div>
<div class="line">                      upper_slack_multiplier_phi_i *</div>
<div class="line">                      (-1 * unfiltered_density_phi_j - upper_slack_phi_j);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 7: Primal feasibility - the part with the filter</span></div>
<div class="line"><span class="comment">                     * is added later */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) += -1 * fe_values.JxW(q_point) *</div>
<div class="line">                                         unfiltered_density_multiplier_phi_i *</div>
<div class="line">                                         (density_phi_j);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 8: Complementary slackness */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (lower_slack_phi_i * lower_slack_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line">                       + lower_slack_phi_i * lower_slack_phi_j *</div>
<div class="line">                           old_lower_slack_multiplier_values[q_point] /</div>
<div class="line">                           old_lower_slack_values[q_point]);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Equation 9: Complementary slackness */</span></div>
<div class="line">                    <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      fe_values.JxW(q_point) *</div>
<div class="line">                      (upper_slack_phi_i * upper_slack_multiplier_phi_j</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                       + upper_slack_phi_i * upper_slack_phi_j *</div>
<div class="line">                           old_upper_slack_multiplier_values[q_point] /</div>
<div class="line">                           old_upper_slack_values[q_point]);</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="namespaceMatrixTools.html#afe66f38c3a4f4e46dd8389b62209b891">MatrixTools::local_apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                                 <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                 <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                                 dummy_cell_rhs,</div>
<div class="line">                                                 <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               system_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    system_rhs = calculate_test_rhs(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classSparseMatrix.html#ac94776653684705604fea3dae0af35f4">SparseMatrix&lt;double&gt;::iterator</a> iter =</div>
<div class="line">               filter_matrix.begin(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             iter != filter_matrix.end(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">             ++iter)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>     = iter-&gt;column();</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span>       <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a> = iter-&gt;<a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>() * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure();</div>
<div class="line"> </div>
<div class="line">            system_matrix</div>
<div class="line">              .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">                     <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>)</div>
<div class="line">              .add(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, value);</div>
<div class="line">            system_matrix</div>
<div class="line">              .block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">                     <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>)</div>
<div class="line">              .add(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, value);</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">SANDTopOpt&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;solver&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> linear_solution;</div>
<div class="line">    linear_solution.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> A_direct;</div>
<div class="line">    A_direct.<a class="code" href="classSparseDirectUMFPACK.html#a25b1d3c7dbb88158a76165a4a56a16d6">initialize</a>(system_matrix);</div>
<div class="line">    A_direct.<a class="code" href="classSparseDirectUMFPACK.html#adc154e4830b0e16be265f10a5c8b7103">vmult</a>(linear_solution, system_rhs);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(linear_solution);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> linear_solution;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::pair&lt;double, double&gt; SANDTopOpt&lt;dim&gt;::calculate_max_step_size(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordtype">double</span>       fraction_to_boundary;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> min_fraction_to_boundary = .8;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> max_fraction_to_boundary = 1. - 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-5;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (min_fraction_to_boundary &lt; 1 - barrier_size)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> (1 - barrier_size &lt; max_fraction_to_boundary)</div>
<div class="line">          fraction_to_boundary = 1 - barrier_size;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          fraction_to_boundary = max_fraction_to_boundary;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      fraction_to_boundary = min_fraction_to_boundary;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> step_size_s_low  = 0;</div>
<div class="line">    <span class="keywordtype">double</span> step_size_z_low  = 0;</div>
<div class="line">    <span class="keywordtype">double</span> step_size_s_high = 1;</div>
<div class="line">    <span class="keywordtype">double</span> step_size_z_high = 1;</div>
<div class="line">    <span class="keywordtype">double</span> step_size_s, step_size_z;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> max_bisection_method_steps = 50;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_bisection_method_steps; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">      {</div>
<div class="line">        step_size_s = (step_size_s_low + step_size_s_high) / 2;</div>
<div class="line">        step_size_z = (step_size_z_low + step_size_z_high) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> state_test_s =</div>
<div class="line">          (fraction_to_boundary * <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) + (step_size_s * <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> state_test_z =</div>
<div class="line">          (fraction_to_boundary * <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) + (step_size_z * <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> accept_s =</div>
<div class="line">          (state_test_s.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)</div>
<div class="line">             .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>()) &amp;&amp;</div>
<div class="line">          (state_test_s.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)</div>
<div class="line">             .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>());</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> accept_z =</div>
<div class="line">          (state_test_z.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>)</div>
<div class="line">             .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>()) &amp;&amp;</div>
<div class="line">          (state_test_z.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>)</div>
<div class="line">             .<a class="code" href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">is_non_negative</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (accept_s)</div>
<div class="line">          step_size_s_low = step_size_s;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          step_size_s_high = step_size_s;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (accept_z)</div>
<div class="line">          step_size_z_low = step_size_z;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          step_size_z_high = step_size_z;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> {step_size_s_low, step_size_z_low};</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> SANDTopOpt&lt;dim&gt;::calculate_test_rhs(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs;</div>
<div class="line">    test_rhs.<a class="code" href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">reinit</a>(system_rhs);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>     fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                     <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                     face_quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> dummy_cell_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; lambda_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; mu_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(1.), <a class="code" href="namespacemu.html">mu</a>(1.);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;            rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filtered_unfiltered_density_solution = test_solution;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> filter_adjoint_unfiltered_density_multiplier_solution =</div>
<div class="line">      test_solution;</div>
<div class="line">    filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>) = 0;</div>
<div class="line">    filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>) = 0;</div>
<div class="line"> </div>
<div class="line">    filter_matrix.vmult(filtered_unfiltered_density_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>),</div>
<div class="line">                        test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">                          <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>));</div>
<div class="line">    filter_matrix.Tvmult(</div>
<div class="line">      filter_adjoint_unfiltered_density_multiplier_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">        <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>),</div>
<div class="line">      test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;                  old_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;          old_displacement_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  old_displacement_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_symmgrads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_displacement_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_displacement_multiplier_divs(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_displacement_multiplier_symmgrads(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_lower_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_upper_slack_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_lower_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_upper_slack_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_unfiltered_density_multiplier_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; filtered_unfiltered_density_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; filter_adjoint_unfiltered_density_multiplier_values(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using namespace </span>ValueExtractors;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        cell_rhs = 0;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.value_list(fe_values.get_quadrature_points(), lambda_values);</div>
<div class="line">        <a class="code" href="namespacemu.html">mu</a>.value_list(fe_values.get_quadrature_points(), mu_values);</div>
<div class="line"> </div>
<div class="line">        fe_values[densities&lt;dim&gt;].get_function_values(test_solution,</div>
<div class="line">                                                      old_density_values);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_displacement_values);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_divergences(</div>
<div class="line">          test_solution, old_displacement_divs);</div>
<div class="line">        fe_values[displacements&lt;dim&gt;].get_function_symmetric_gradients(</div>
<div class="line">          test_solution, old_displacement_symmgrads);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_displacement_multiplier_values);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;].get_function_divergences(</div>
<div class="line">          test_solution, old_displacement_multiplier_divs);</div>
<div class="line">        fe_values[displacement_multipliers&lt;dim&gt;]</div>
<div class="line">          .get_function_symmetric_gradients(</div>
<div class="line">            test_solution, old_displacement_multiplier_symmgrads);</div>
<div class="line">        fe_values[density_lower_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_lower_slack_values);</div>
<div class="line">        fe_values[density_lower_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_lower_slack_multiplier_values);</div>
<div class="line">        fe_values[density_upper_slacks&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_upper_slack_values);</div>
<div class="line">        fe_values[density_upper_slack_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_upper_slack_multiplier_values);</div>
<div class="line">        fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_unfiltered_density_values);</div>
<div class="line">        fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          test_solution, old_unfiltered_density_multiplier_values);</div>
<div class="line">        fe_values[unfiltered_densities&lt;dim&gt;].get_function_values(</div>
<div class="line">          filtered_unfiltered_density_solution,</div>
<div class="line">          filtered_unfiltered_density_values);</div>
<div class="line">        fe_values[unfiltered_density_multipliers&lt;dim&gt;].get_function_values(</div>
<div class="line">          filter_adjoint_unfiltered_density_multiplier_solution,</div>
<div class="line">          filter_adjoint_unfiltered_density_multiplier_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> displacement_phi_i_symmgrad =</div>
<div class="line">                  fe_values[displacements&lt;dim&gt;].symmetric_gradient(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_phi_i_div =</div>
<div class="line">                  fe_values[displacements&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a></div>
<div class="line">                  displacement_multiplier_phi_i_symmgrad =</div>
<div class="line">                    fe_values[displacement_multipliers&lt;dim&gt;].symmetric_gradient(</div>
<div class="line">                      <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> displacement_multiplier_phi_i_div =</div>
<div class="line">                  fe_values[displacement_multipliers&lt;dim&gt;].divergence(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                      q_point);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> density_phi_i =</div>
<div class="line">                  fe_values[densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_phi_i =</div>
<div class="line">                  fe_values[unfiltered_densities&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> unfiltered_density_multiplier_phi_i =</div>
<div class="line">                  fe_values[unfiltered_density_multipliers&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>,</div>
<div class="line">                                                                       q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_multiplier_phi_i =</div>
<div class="line">                  fe_values[density_lower_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_phi_i =</div>
<div class="line">                  fe_values[density_lower_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_phi_i =</div>
<div class="line">                  fe_values[density_upper_slacks&lt;dim&gt;].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_multiplier_phi_i =</div>
<div class="line">                  fe_values[density_upper_slack_multipliers&lt;dim&gt;].value(</div>
<div class="line">                    <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 1: This equation, along with equations</span></div>
<div class="line"><span class="comment">                 * 2 and 3, are the variational derivatives of the</span></div>
<div class="line"><span class="comment">                 * Lagrangian with respect to the decision</span></div>
<div class="line"><span class="comment">                 * variables - the density, displacement, and</span></div>
<div class="line"><span class="comment">                 * unfiltered density. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (density_penalty_exponent *</div>
<div class="line">                     <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                              density_penalty_exponent - 1) *</div>
<div class="line">                     density_phi_i *</div>
<div class="line">                     (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                        old_displacement_divs[q_point] *</div>
<div class="line">                        lambda_values[q_point] +</div>
<div class="line">                      2 * mu_values[q_point] *</div>
<div class="line">                        (old_displacement_symmgrads[q_point] *</div>
<div class="line">                         old_displacement_multiplier_symmgrads[q_point])) -</div>
<div class="line">                   density_phi_i *</div>
<div class="line">                     old_unfiltered_density_multiplier_values[q_point]);</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 2; the boundary terms will be added further down</span></div>
<div class="line"><span class="comment">                 * below. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (<a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                            density_penalty_exponent) *</div>
<div class="line">                   (old_displacement_multiplier_divs[q_point] *</div>
<div class="line">                      displacement_phi_i_div * lambda_values[q_point] +</div>
<div class="line">                    2 * mu_values[q_point] *</div>
<div class="line">                      (old_displacement_multiplier_symmgrads[q_point] *</div>
<div class="line">                       displacement_phi_i_symmgrad)));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 3 */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (unfiltered_density_phi_i *</div>
<div class="line">                     filter_adjoint_unfiltered_density_multiplier_values</div>
<div class="line">                       [q_point] +</div>
<div class="line">                   unfiltered_density_phi_i *</div>
<div class="line">                     old_upper_slack_multiplier_values[q_point] +</div>
<div class="line">                   -1 * unfiltered_density_phi_i *</div>
<div class="line">                     old_lower_slack_multiplier_values[q_point]);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 4; boundary term will again be dealt</span></div>
<div class="line"><span class="comment">                 * with below. This equation being driven to 0</span></div>
<div class="line"><span class="comment">                 * ensures that the elasticity equation is met as</span></div>
<div class="line"><span class="comment">                 * a constraint. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += -1 * fe_values.JxW(q_point) *</div>
<div class="line">                               (<a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(old_density_values[q_point],</div>
<div class="line">                                         density_penalty_exponent) *</div>
<div class="line">                                (old_displacement_divs[q_point] *</div>
<div class="line">                                   displacement_multiplier_phi_i_div *</div>
<div class="line">                                   lambda_values[q_point] +</div>
<div class="line">                                 2 * mu_values[q_point] *</div>
<div class="line">                                   (displacement_multiplier_phi_i_symmgrad *</div>
<div class="line">                                    old_displacement_symmgrads[q_point])));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 5: This equation sets the lower slack</span></div>
<div class="line"><span class="comment">                 * variable equal to the unfiltered density,</span></div>
<div class="line"><span class="comment">                 * giving a minimum density of 0. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                               (lower_slack_multiplier_phi_i *</div>
<div class="line">                                (old_unfiltered_density_values[q_point] -</div>
<div class="line">                                 old_lower_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 6: This equation sets the upper slack</span></div>
<div class="line"><span class="comment">                 * variable equal to one minus the unfiltered</span></div>
<div class="line"><span class="comment">                 * density. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                               (upper_slack_multiplier_phi_i *</div>
<div class="line">                                (1 - old_unfiltered_density_values[q_point] -</div>
<div class="line">                                 old_upper_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 7: This is the difference between the</span></div>
<div class="line"><span class="comment">                 * density and the filter applied to the</span></div>
<div class="line"><span class="comment">                 * unfiltered density. This being driven to 0 by</span></div>
<div class="line"><span class="comment">                 * the Newton steps ensures that the filter is</span></div>
<div class="line"><span class="comment">                 * applied correctly. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += fe_values.JxW(q_point) *</div>
<div class="line">                               (unfiltered_density_multiplier_phi_i *</div>
<div class="line">                                (old_density_values[q_point] -</div>
<div class="line">                                 filtered_unfiltered_density_values[q_point]));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 8: This along with equation 9 give the</span></div>
<div class="line"><span class="comment">                 * requirement that @f$s*z = \alpha@f$ for the barrier</span></div>
<div class="line"><span class="comment">                 * size alpha, and gives complementary slackness</span></div>
<div class="line"><span class="comment">                 * from KKT conditions when @f$\alpha@f$ goes to 0. */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (lower_slack_phi_i *</div>
<div class="line">                   (old_lower_slack_multiplier_values[q_point] -</div>
<div class="line">                    barrier_size / old_lower_slack_values[q_point]));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Equation 9 */</span></div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  -1 * fe_values.JxW(q_point) *</div>
<div class="line">                  (upper_slack_phi_i *</div>
<div class="line">                   (old_upper_slack_multiplier_values[q_point] -</div>
<div class="line">                    barrier_size / old_upper_slack_values[q_point]));</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>)</div>
<div class="line">              {</div>
<div class="line">                fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> face_q_point :</div>
<div class="line">                     fe_face_values.quadrature_point_indices())</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_face_values.dof_indices())</div>
<div class="line">                      {</div>
<div class="line">                        <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> traction;</div>
<div class="line">                        traction[1] = -1.;</div>
<div class="line"> </div>
<div class="line">                        cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                          -1 *</div>
<div class="line">                          (traction * fe_face_values[displacements&lt;dim&gt;].value(</div>
<div class="line">                                        <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, face_q_point)) *</div>
<div class="line">                          fe_face_values.JxW(face_q_point);</div>
<div class="line"> </div>
<div class="line">                        cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                          (traction *</div>
<div class="line">                           fe_face_values[displacement_multipliers&lt;dim&gt;].value(</div>
<div class="line">                             <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, face_q_point)) *</div>
<div class="line">                          fe_face_values.JxW(face_q_point);</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="namespaceMatrixTools.html#afe66f38c3a4f4e46dd8389b62209b891">MatrixTools::local_apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                                 <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                 dummy_cell_matrix,</div>
<div class="line">                                                 cell_rhs,</div>
<div class="line">                                                 <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(cell_rhs,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               test_rhs);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> test_rhs;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> SANDTopOpt&lt;dim&gt;::calculate_exact_merit(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;test_solution)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;merit function&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> objective_function_merit = 0;</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1);</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">      <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                              <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                              quadrature_formula,</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">      <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>     fe_face_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                       <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                       face_quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points = face_quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;Tensor&lt;1, dim&gt;&gt; displacement_face_values(n_face_q_points);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                  <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">BoundaryIds::down_force</a>)</div>
<div class="line">                {</div>
<div class="line">                  fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">                  fe_face_values[ValueExtractors::displacements&lt;dim&gt;]</div>
<div class="line">                    .get_function_values(test_solution,</div>
<div class="line">                                         displacement_face_values);</div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_q_point = 0;</div>
<div class="line">                       face_q_point &lt; n_face_q_points;</div>
<div class="line">                       ++face_q_point)</div>
<div class="line">                    {</div>
<div class="line">                      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> traction;</div>
<div class="line">                      traction[1] = -1.;</div>
<div class="line"> </div>
<div class="line">                      objective_function_merit +=</div>
<div class="line">                        (traction * displacement_face_values[face_q_point]) *</div>
<div class="line">                        fe_face_values.JxW(face_q_point);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        objective_function_merit =</div>
<div class="line">          objective_function_merit -</div>
<div class="line">          barrier_size * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure() *</div>
<div class="line">            <a class="code" href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a>(test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">              <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()]);</div>
<div class="line">        objective_function_merit =</div>
<div class="line">          objective_function_merit -</div>
<div class="line">          barrier_size * <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;measure() *</div>
<div class="line">            <a class="code" href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a>(test_solution.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(</div>
<div class="line">              <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()]);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs = calculate_test_rhs(test_solution);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> elasticity_constraint_merit =</div>
<div class="line">      penalty_multiplier *</div>
<div class="line">      test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> filter_constraint_merit =</div>
<div class="line">      penalty_multiplier *</div>
<div class="line">      test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> lower_slack_merit =</div>
<div class="line">      penalty_multiplier *</div>
<div class="line">      test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> upper_slack_merit =</div>
<div class="line">      penalty_multiplier *</div>
<div class="line">      test_rhs.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>).<a class="code" href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">l1_norm</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> total_merit =</div>
<div class="line">      objective_function_merit + elasticity_constraint_merit +</div>
<div class="line">      filter_constraint_merit + lower_slack_merit + upper_slack_merit;</div>
<div class="line">    <span class="keywordflow">return</span> total_merit;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> SANDTopOpt&lt;dim&gt;::find_max_step()</div>
<div class="line">  {</div>
<div class="line">    assemble_system();</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a> = <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;unsigned int&gt; decision_variables = {</div>
<div class="line">      <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SolutionBlocks::displacement</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>};</div>
<div class="line">    <span class="keywordtype">double</span> hess_part = 0;</div>
<div class="line">    <span class="keywordtype">double</span> grad_part = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> decision_variable_i : decision_variables)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> decision_variable_j : decision_variables)</div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> temp_vector(<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i).size());</div>
<div class="line">            system_matrix.block(decision_variable_i, decision_variable_j)</div>
<div class="line">              .vmult(temp_vector, <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_j));</div>
<div class="line">            hess_part += <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i) * temp_vector;</div>
<div class="line">          }</div>
<div class="line">        grad_part -= system_rhs.block(decision_variable_i) *</div>
<div class="line">                     <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(decision_variable_i);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;unsigned int&gt; equality_constraint_multipliers = {</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>,</div>
<div class="line">      <a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>};</div>
<div class="line">    <span class="keywordtype">double</span> constraint_norm = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> multiplier_i : equality_constraint_multipliers)</div>
<div class="line">      constraint_norm += system_rhs.block(multiplier_i).linfty_norm();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> test_penalty_multiplier;</div>
<div class="line">    <span class="keywordflow">if</span> (hess_part &gt; 0)</div>
<div class="line">      test_penalty_multiplier =</div>
<div class="line">        (grad_part + .5 * hess_part) / (.05 * constraint_norm);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      test_penalty_multiplier = (grad_part) / (.05 * constraint_norm);</div>
<div class="line"> </div>
<div class="line">    penalty_multiplier = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(penalty_multiplier, test_penalty_multiplier);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;double, double&gt; max_step_sizes =</div>
<div class="line">      calculate_max_step_size(nonlinear_solution, <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> step_size_s = max_step_sizes.first;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> step_size_z = max_step_sizes.second;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SolutionBlocks::displacement</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SolutionBlocks::unfiltered_density</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SolutionBlocks::displacement_multiplier</a>) *= step_size_z;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SolutionBlocks::unfiltered_density_multiplier</a>) *= step_size_z;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SolutionBlocks::density_lower_slack</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SolutionBlocks::density_lower_slack_multiplier</a>) *= step_size_z;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SolutionBlocks::density_upper_slack</a>) *= step_size_s;</div>
<div class="line">    <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>.block(<a class="code" href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SolutionBlocks::density_upper_slack_multiplier</a>) *= step_size_z;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a></div>
<div class="line">  SANDTopOpt&lt;dim&gt;::compute_scaled_step(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>,</div>
<div class="line">                                       <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;max_step,</div>
<div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">double</span> descent_requirement)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> merit_derivative =</div>
<div class="line">      (calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4 * max_step) -</div>
<div class="line">       calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>)) /</div>
<div class="line">      1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4;</div>
<div class="line">    <span class="keywordtype">double</span>       step_size                 = 1;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_linesearch_iterations = 10;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_linesearch_iterations; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> (calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + step_size * max_step) &lt;</div>
<div class="line">            calculate_exact_merit(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>) +</div>
<div class="line">              step_size * descent_requirement * merit_derivative)</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          step_size = step_size / 2;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a> + (step_size * max_step);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">bool</span> SANDTopOpt&lt;dim&gt;::check_convergence(<span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> test_rhs      = calculate_test_rhs(<a class="code" href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>              test_rhs_norm = test_rhs.<a class="code" href="classBlockVectorBase.html#a5253082a5591dc0d13fef1d65a3dbfae">l1_norm</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> convergence_condition = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-2;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> target_norm           = convergence_condition * barrier_size;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;    Checking convergence. Current rhs norm is &quot;</span></div>
<div class="line">              &lt;&lt; test_rhs_norm &lt;&lt; <span class="stringliteral">&quot;, target is &quot;</span> &lt;&lt; target_norm &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (test_rhs_norm &lt; target_norm);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::vector&lt;std::string&gt; solution_names(1, <span class="stringliteral">&quot;density&quot;</span>);</div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      data_component_interpretation(</div>
<div class="line">        1, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        solution_names.emplace_back(<span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line">        data_component_interpretation.push_back(</div>
<div class="line">          <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">      }</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;unfiltered_density&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        solution_names.emplace_back(<span class="stringliteral">&quot;displacement_multiplier&quot;</span>);</div>
<div class="line">        data_component_interpretation.push_back(</div>
<div class="line">          <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">      }</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;unfiltered_density_multiplier&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;low_slack&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;low_slack_multiplier&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;high_slack&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;high_slack_multiplier&quot;</span>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(nonlinear_solution,</div>
<div class="line">                             solution_names,</div>
<div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                             data_component_interpretation);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution&quot;</span> + <a class="code" href="group__Exceptions.html#ga72743302dcb1a0fb1f2f8dc5122d299e">std::to_string</a>(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>) + <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SANDTopOpt&lt;dim&gt;::write_as_stl()</div>
<div class="line">  {</div>
<div class="line">    static_assert(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2,</div>
<div class="line">                  <span class="stringliteral">&quot;This function is not implemented for anything &quot;</span></div>
<div class="line">                  <span class="stringliteral">&quot;other than the 2d case.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    std::ofstream stlfile;</div>
<div class="line">    stlfile.open(<span class="stringliteral">&quot;bridge.stl&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;solid bridge\n&quot;</span> &lt;&lt; <a class="code" href="table__handler__0_8txt.html#ac42f579ca4a40d2835c1abb1cb95121d">std::scientific</a>;</div>
<div class="line">    <span class="keywordtype">double</span> height = .25;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> (nonlinear_solution.block(</div>
<div class="line">              <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">SolutionBlocks::density</a>)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index()] &gt; 0.5)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> edge_directions[2] = {<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1) -</div>
<div class="line">                                                         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0),</div>
<div class="line">                                                       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2) -</div>
<div class="line">                                                         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)};</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> edge_tensor(</div>
<div class="line">              {{edge_directions[0][0], edge_directions[0][1]},</div>
<div class="line">               {edge_directions[1][0], edge_directions[1][1]}});</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">bool</span> is_right_handed_cell = (<a class="code" href="mapping__q__internal__0_8txt.html#a7a28370132a1e8adca9c727413c710b4">determinant</a>(edge_tensor) &gt; 0);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (is_right_handed_cell)</div>
<div class="line">              {</div>
<div class="line">                <span class="comment">/* Write one side at z = 0. */</span></div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Write one side at z = height. */</span></div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="comment">/* The cell has a left-handed set up */</span></div>
<div class="line">              {</div>
<div class="line">                <span class="comment">/* Write one side at z = 0. */</span></div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Write one side at z = height. */</span></div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span> &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(2)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[0] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                        &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(3)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_number = 0;</div>
<div class="line">                 face_number &lt; GeometryInfo&lt;dim&gt;::faces_per_cell;</div>
<div class="line">                 ++face_number)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::face_iterator <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> =</div>
<div class="line">                  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face(face_number);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary()) ||</div>
<div class="line">                    (!<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">                     (nonlinear_solution.block(</div>
<div class="line">                        0)[<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;neighbor(face_number)-&gt;active_cell_index()] &lt;</div>
<div class="line">                      0.5)))</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> normal_vector =</div>
<div class="line">                      (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center() - <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center());</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">double</span> normal_norm = normal_vector.<a class="code" href="classTensor.html#afd0934b4edd71063f66a9c67540e79fc">norm</a>();</div>
<div class="line">                    <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) *</div>
<div class="line">                            0.000000<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>+00 +</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) * (0 - 0) *</div>
<div class="line">                            normal_vector[0] +</div>
<div class="line">                          (height - 0) *</div>
<div class="line">                            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                            normal_vector[1] -</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) * (0 - 0) *</div>
<div class="line">                            normal_vector[1] -</div>
<div class="line">                          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) *</div>
<div class="line">                            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]) *</div>
<div class="line">                            normal_vector[0] -</div>
<div class="line">                          (height - 0) *</div>
<div class="line">                            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] - <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1]) * 0 &gt;</div>
<div class="line">                        0)</div>
<div class="line">                      {</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                      }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                      {</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   facet normal &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[0] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; normal_vector[1] / normal_norm &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      outer loop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(0)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                &lt;&lt; 0.000000e+00 &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;         vertex &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[0]</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;vertex(1)[1] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; height</div>
<div class="line">                                &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;      endloop\n&quot;</span>;</div>
<div class="line">                        stlfile &lt;&lt; <span class="stringliteral">&quot;   endfacet\n&quot;</span>;</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">    stlfile &lt;&lt; <span class="stringliteral">&quot;endsolid bridge&quot;</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">SANDTopOpt&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;filter r is: &quot;</span> &lt;&lt; filter_r &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> t(timer, <span class="stringliteral">&quot;setup&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">create_triangulation</a>();</div>
<div class="line"> </div>
<div class="line">      dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">      <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">      setup_boundary_values();</div>
<div class="line">      setup_block_system();</div>
<div class="line">      setup_filter_matrix();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    barrier_size                  = 25;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> min_barrier_size = .0005;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_uphill_steps    = 8;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       descent_requirement = .0001;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       iteration_number = 0;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_iterations   = 10000;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Starting outer step in iteration &quot;</span> &lt;&lt; iteration_number</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot; with barrier parameter &quot;</span> &lt;&lt; barrier_size &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">do</span></div>
<div class="line">          {</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;  Starting inner step in iteration &quot;</span></div>
<div class="line">                      &lt;&lt; iteration_number</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot; with merit function penalty multiplier &quot;</span></div>
<div class="line">                      &lt;&lt; penalty_multiplier &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">bool</span> watchdog_step_found = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> watchdog_state = nonlinear_solution;</div>
<div class="line">            <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a>       first_step;</div>
<div class="line">            <span class="keywordtype">double</span> target_merit     = numbers::signaling_nan&lt;double&gt;();</div>
<div class="line">            <span class="keywordtype">double</span> merit_derivative = numbers::signaling_nan&lt;double&gt;();</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; max_uphill_steps; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                ++iteration_number;</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> update_step = find_max_step();</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> == 0)</div>
<div class="line">                  {</div>
<div class="line">                    first_step = update_step;</div>
<div class="line">                    merit_derivative =</div>
<div class="line">                      ((calculate_exact_merit(watchdog_state +</div>
<div class="line">                                              .0001 * first_step) -</div>
<div class="line">                        calculate_exact_merit(watchdog_state)) /</div>
<div class="line">                       .0001);</div>
<div class="line">                    target_merit = calculate_exact_merit(watchdog_state) +</div>
<div class="line">                                   descent_requirement * merit_derivative;</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                nonlinear_solution += update_step;</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> current_merit =</div>
<div class="line">                  calculate_exact_merit(nonlinear_solution);</div>
<div class="line"> </div>
<div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;    current watchdog state merit is: &quot;</span></div>
<div class="line">                          &lt;&lt; current_merit &lt;&lt; <span class="stringliteral">&quot;; target merit is &quot;</span></div>
<div class="line">                          &lt;&lt; target_merit &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (current_merit &lt; target_merit)</div>
<div class="line">                  {</div>
<div class="line">                    watchdog_step_found = <span class="keyword">true</span>;</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;    found workable step after &quot;</span> &lt;&lt; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> + 1</div>
<div class="line">                              &lt;&lt; <span class="stringliteral">&quot; iterations&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (watchdog_step_found == <span class="keyword">false</span>)</div>
<div class="line">              {</div>
<div class="line">                ++iteration_number;</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> update_step = find_max_step();</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> stretch_state =</div>
<div class="line">                  compute_scaled_step(nonlinear_solution,</div>
<div class="line">                                      update_step,</div>
<div class="line">                                      descent_requirement);</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> ((calculate_exact_merit(nonlinear_solution) &lt;</div>
<div class="line">                     calculate_exact_merit(watchdog_state)) ||</div>
<div class="line">                    (calculate_exact_merit(stretch_state) &lt; target_merit))</div>
<div class="line">                  {</div>
<div class="line">                    std::cout &lt;&lt; <span class="stringliteral">&quot;    Taking scaled step from end of watchdog&quot;</span></div>
<div class="line">                              &lt;&lt; std::endl;</div>
<div class="line">                    nonlinear_solution = stretch_state;</div>
<div class="line">                  }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                  {</div>
<div class="line">                    std::cout</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot;    Taking scaled step from beginning of watchdog&quot;</span></div>
<div class="line">                      &lt;&lt; std::endl;</div>
<div class="line">                    <span class="keywordflow">if</span> (calculate_exact_merit(stretch_state) &gt;</div>
<div class="line">                        calculate_exact_merit(watchdog_state))</div>
<div class="line">                      {</div>
<div class="line">                        nonlinear_solution =</div>
<div class="line">                          compute_scaled_step(watchdog_state,</div>
<div class="line">                                              first_step,</div>
<div class="line">                                              descent_requirement);</div>
<div class="line">                      }</div>
<div class="line">                    <span class="keywordflow">else</span></div>
<div class="line">                      {</div>
<div class="line">                        ++iteration_number;</div>
<div class="line">                        nonlinear_solution = stretch_state;</div>
<div class="line">                        <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> stretch_step =</div>
<div class="line">                          find_max_step();</div>
<div class="line">                        nonlinear_solution =</div>
<div class="line">                          compute_scaled_step(nonlinear_solution,</div>
<div class="line">                                              stretch_step,</div>
<div class="line">                                              descent_requirement);</div>
<div class="line">                      }</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            output_results(iteration_number);</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">while</span> ((iteration_number &lt; max_iterations) &amp;&amp;</div>
<div class="line">               (check_convergence(nonlinear_solution) == <span class="keyword">false</span>));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> barrier_size_multiplier = .8;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> barrier_size_exponent   = 1.2;</div>
<div class="line"> </div>
<div class="line">        barrier_size =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(barrier_size * barrier_size_multiplier,</div>
<div class="line">                            std::pow(barrier_size, barrier_size_exponent)),</div>
<div class="line">                   min_barrier_size);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (((barrier_size &gt; min_barrier_size) ||</div>
<div class="line">            (check_convergence(nonlinear_solution) == <span class="keyword">false</span>)) &amp;&amp;</div>
<div class="line">           (iteration_number &lt; max_iterations));</div>
<div class="line"> </div>
<div class="line">    write_as_stl();</div>
<div class="line">    timer.<a class="code" href="classTimerOutput.html#a133e7d844826bc8716898fb2f86fb9b6">print_summary</a>();</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace SAND</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classSAND_1_1SANDTopOpt.html">SAND::SANDTopOpt&lt;2&gt;</a> elastic_problem_2d;</div>
<div class="line">      elastic_problem_2d.<a class="code" href="classSAND_1_1SANDTopOpt.html#a1ab26b7b2bb38e7f74a85a5c729484e4">run</a>();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="apolynomial__0_8txt_html_af1258c87f1d73d29bd17331843ac1d25"><div class="ttname"><a href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a></div><div class="ttdeci">namespace in which classes relating to the description of d polynomial spaces are declared ***Base class for all D polynomials A polynomial is represented in this class by its coefficients which are set through the constructor or by derived classes There are two paths for evaluation of polynomials One is based on the coefficients which are evaluated through the Horner scheme which is a robust general purpose scheme An alternative and more stable evaluation of high degree polynomials with roots in the unit interval is provided by a product in terms of the roots This form is available for special polynomials such as Lagrange polynomials or Legendre polynomials and used with the respective constructor To obtain this more stable evaluation form the constructor with the roots in form of a Lagrange polynomial must be used In case a manipulation is done that changes the roots the representation is switched to the coefficient form This class is a typical example of a possible template argument for the TensorProductPolynomials class **Constructor The coefficients of the polynomial are passed as and denote the i e the first element of the array denotes the constant the second the linear and so on The degree of the polynomial represented by this object is thus the number of elements in the&lt; tt &gt; coefficient&lt;/tt &gt; array minus one **Constructor creating a zero polynomial of degree *[2.x.3] *Constructor for a Lagrange polynomial and its point of evaluation The idea is to where j is the evaluation point specified as argument and the support points contain all the evaluation is based on products of the whereas the Horner scheme is used for polynomials in the coefficient form **Return the values and the derivatives of the Polynomial at point&lt; tt &gt; x&lt;/tt &gt;&lt; tt &gt; i</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__0_8txt_source.html#l00024">polynomial_0.txt:24</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1SolutionComponents_html_a37582fef8d9db3168aa2807053db12a7"><div class="ttname"><a href="namespaceSAND_1_1SolutionComponents.html#a37582fef8d9db3168aa2807053db12a7">SAND::SolutionComponents::density_lower_slack_multiplier</a></div><div class="ttdeci">constexpr unsigned int density_lower_slack_multiplier</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00078">step-79.cc:78</a></div></div>
<div class="ttc" id="afe_2fe__dgq_8h_html"><div class="ttname"><a href="fe_2fe__dgq_8h.html">fe_dgq.h</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a79cbe2f02f8dfb85026c71d783dbb703"><div class="ttname"><a href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out__dof__data_8h_source.html#l01096">data_out_dof_data.h:1096</a></div></div>
<div class="ttc" id="anamespaceStep31_1_1EquationData_html_aa1e9e1a7297b10cb39c2065f86acc66f"><div class="ttname"><a href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">Step31::EquationData::density</a></div><div class="ttdeci">constexpr double density</div><div class="ttdef"><b>Definition:</b> <a href="step-31_8cc_source.html#l00075">step-31.cc:75</a></div></div>
<div class="ttc" id="aclassIndexSet_html"><div class="ttname"><a href="classIndexSet.html">IndexSet</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l00068">index_set.h:68</a></div></div>
<div class="ttc" id="aclassFEValues_html_a21f914e63d588e2652a9514620653d77"><div class="ttname"><a href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell)</div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00077">fe_update_flags.h:77</a></div></div>
<div class="ttc" id="aclassTimerOutput_html_a133e7d844826bc8716898fb2f86fb9b6"><div class="ttname"><a href="classTimerOutput.html#a133e7d844826bc8716898fb2f86fb9b6">TimerOutput::print_summary</a></div><div class="ttdeci">void print_summary() const</div><div class="ttdef"><b>Definition:</b> <a href="timer_8cc_source.html#l00535">timer.cc:535</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_afec1b694405cadb2d251275096ad3563"><div class="ttname"><a href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a></div><div class="ttdeci">if we even only hold bytes per line in this sparsity we ll need GB for this object even if every single line is empty Of only million lines will be non for which we need MB plus whatever is necessary to store the actual column indices of nonzero entries Let s say we have a moderately complex problem with entries per for each of which we store the column index worth then we ll need bytes for each of the million lines that correspond to the degrees of freedom we for a total of GB And we ll need bytes for each of the million lines that we don t for a total of GB It is clear that this ratio doesn t become any better if we go to even higher numbers of processors *The solution to this problem is to really only use any memory at all for those parts of the linear system that we or need for some other reason For all other we must know that they but we can not set up any part of our data structure To this there exists a class called IndexSet that denotes a set of indices which we care for and for which we may have to allocate memory The data structures for sparsity patterns constraint matrices matrices and vector can be initialized with these IndexSet objects to really only care for those rows or entries that correspond to indices in the index set and not care about all others These objects will then ask how many indices exist in the set allocate memory for each one of and when you want to access data for global degree of freedom[2.x.28] you will be redirected to the result of calling[2.x.29] with index[2.x.30] instead Accessing data for elements[2.x.31] for which[2.x.32] is false will yield an error *The remaining question is how to identify the set of indices that correspond to degrees of freedom we need to worry about on each processor To this you can use the[2.x.33] function to get at all the indices a processor owns Note that this is a subset of the degrees of freedom that are defined on the locally owned one sometimes needs the set of all degrees of freedom on the locally owned subdomain as well as the adjacent ghost cells This information is provided by the[2.x.35] function ***A typical parallel application is dealing with two different kinds of parallel but there are of course different vector types that can each represent both ghosted vectors are typically used for data output</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00059">distributed_0.txt:59</a></div></div>
<div class="ttc" id="aclassFE__DGQ_html"><div class="ttname"><a href="classFE__DGQ.html">FE_DGQ</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__dgq_8h_source.html#l00105">fe_dgq.h:105</a></div></div>
<div class="ttc" id="agroup__Vectors_html_gad8e23a22888630c9874cbddf8bcccdf5"><div class="ttname"><a href="group__Vectors.html#gad8e23a22888630c9874cbddf8bcccdf5">Vector::is_non_negative</a></div><div class="ttdeci">bool is_non_negative() const</div></div>
<div class="ttc" id="anamespaceSAND_1_1SolutionComponents_html_a9435cde8b5fc1e401de7c0a5692035ab"><div class="ttname"><a href="namespaceSAND_1_1SolutionComponents.html#a9435cde8b5fc1e401de7c0a5692035ab">SAND::SolutionComponents::density_lower_slack</a></div><div class="ttdeci">constexpr unsigned int density_lower_slack</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00076">step-79.cc:76</a></div></div>
<div class="ttc" id="aclassTimerOutput_1_1Scope_html"><div class="ttname"><a href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2timer_8h_source.html#l00600">timer.h:600</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1SolutionComponents_html_ae8ef6da66750c22acd349c9992e31ece"><div class="ttname"><a href="namespaceSAND_1_1SolutionComponents.html#ae8ef6da66750c22acd349c9992e31ece">SAND::SolutionComponents::unfiltered_density_multiplier</a></div><div class="ttdeci">constexpr unsigned int unfiltered_density_multiplier</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00074">step-79.cc:74</a></div></div>
<div class="ttc" id="afe_2fe__0_8txt_html_ad1bbe5407fe459d8e4e71ba7ed9f7428"><div class="ttname"><a href="fe_2fe__0_8txt.html#ad1bbe5407fe459d8e4e71ba7ed9f7428">neighbor</a></div><div class="ttdeci">it is possible that some of them are in turn constrained leading to longer chains of constraints that the AffineConstraints class will eventually have to sort this is of no concern for the FiniteElement and derived classes since they only act locally on one cell and its immediate neighbor</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__0_8txt_source.html#l00123">fe_0.txt:123</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a8fba07b9a84b89e6be225f5f95c3e355"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div><div class="ttdeci">the program is just and one can not intelligently work around that *It is sometimes useful to change the behavior of the[2.x.6] macro from aborting a program to throwing exceptions On the other exceptions are not allowed to propagate out of destructors of classes For this there is a variant of the called[2.x.7] that can be used in destructors These use cases are discussed further down below on this page **Dynamic such as whether an output file can be written to *These are things that shouldn t be checked because it is not guaranteed that a program for which the condition is satisfied in a debug mode run</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00022">exceptions_0.txt:22</a></div></div>
<div class="ttc" id="alac_2packaged__operation_8h_html"><div class="ttname"><a href="lac_2packaged__operation_8h.html">packaged_operation.h</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__q_8h_source.html#l00587">fe_q.h:587</a></div></div>
<div class="ttc" id="aclassSparseDirectUMFPACK_html_a25b1d3c7dbb88158a76165a4a56a16d6"><div class="ttname"><a href="classSparseDirectUMFPACK.html#a25b1d3c7dbb88158a76165a4a56a16d6">SparseDirectUMFPACK::initialize</a></div><div class="ttdeci">void initialize(const SparsityPattern &amp;sparsity_pattern)</div><div class="ttdef"><b>Definition:</b> <a href="sparse__direct_8cc_source.html#l00049">sparse_direct.cc:49</a></div></div>
<div class="ttc" id="aclassSymmetricTensor_html"><div class="ttname"><a href="classSymmetricTensor.html">SymmetricTensor&lt; 2, dim &gt;</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2namespace__dealii_8h_source.html#l00026">namespace_dealii.h:26</a></div></div>
<div class="ttc" id="aclassFiniteElement_html_a4409f54175f279ac24cc982cfcfcbd2f"><div class="ttname"><a href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">FiniteElement::component_mask</a></div><div class="ttdeci">ComponentMask component_mask(const FEValuesExtractors::Scalar &amp;scalar) const</div><div class="ttdef"><b>Definition:</b> <a href="fe_8cc_source.html#l00396">fe.cc:396</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00070">fe_update_flags.h:70</a></div></div>
<div class="ttc" id="aclassVector_html_aeaa8fc05dd5a8a8f9560a5de096ebb4e"><div class="ttname"><a href="classVector.html#aeaa8fc05dd5a8a8f9560a5de096ebb4e">Vector::l1_norm</a></div><div class="ttdeci">real_type l1_norm() const</div></div>
<div class="ttc" id="aiterators__0_8txt_html_a6cf0880ba2af3a1be4aacdbbd4b90f9c"><div class="ttname"><a href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a></div><div class="ttdeci">where BaseIterator usually is one of thestandard iterators discussed above *The FilteredIterator gets an additional Predicate in its constructor and willskip all objects where this Predicate evaluates to&lt; tt &gt; false&lt;/tt &gt; Acollection of predicates already implemented can be found in the namespaceIteratorFilters ***IteratorsLoops Iterating over objects *All iterators of the same kind and iterating over thesame kind of geometrical objects traverse the mesh in the sameorder Take this code all iterators will always point to the same mesh even though&lt; tt &gt; DoFHandler&lt;/tt &gt; and&lt; tt &gt; Triangulation&lt;/tt &gt; are very different and even if the DoFHandlers are handling different finite the difference is only in the Accessor As mentioned the order in which iterators traverse the forest ofobjects is actually well but application programs should notassume any such but rather consider this an implementation detailof the library *Corresponding to above the order in which iterators traverse activeobjects is the same for all iterators in the following the difference to the previous example being that here we only consider active but theyare really rather dumb Their magic only lies in the fact that they point tosome useful in this case the Accessor For they point to anactual object that stores some data On the other the deal II when do not return a reference to an actual but returnan object that knows how to get at the data that represents cells In thisobject doesn t store itself where the vertices of a cell are or what its neighborsare it knows how to tease this sort of information from out of thearrays and tables and lists that the Triangulation class sets up to describe amesh *Accessing data that characterizes a cell is always done through the i e the expression[2.x.10] grants access to[1.x.6] attributes of this Accessor Examples of properties you can query from aniterator are ***Since dereferencing iterators yields accessor these calls are tomember etc These in turn figure out the relevant datafrom the various data structures that store this data How this is actuallydone and what data structures are used is not really of concern to authors ofapplications in deal II In by hiding the actual data structureswe are able to store data in an efficient not necessarily in a way thatmakes it easily accessible or understandable to application writers ***IteratorsTypedefs Kinds of accessors *Depending on what sort of data you want to there are different kindsof accessor and hexes that make up a triangulation</div><div class="ttdef"><b>Definition:</b> <a href="iterators__0_8txt_source.html#l00063">iterators_0.txt:63</a></div></div>
<div class="ttc" id="aclassVectorizedArray_html_a88a75c587436aef435bd528ab65ac3fe"><div class="ttname"><a href="classVectorizedArray.html#a88a75c587436aef435bd528ab65ac3fe">VectorizedArray::pow</a></div><div class="ttdeci">VectorizedArray&lt; Number, width &gt; pow(const ::VectorizedArray&lt; Number, width &gt; &amp;x, const Number p)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05705">vectorization.h:5705</a></div></div>
<div class="ttc" id="aclassBlockVector_html"><div class="ttname"><a href="classBlockVector.html">BlockVector&lt; double &gt;</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_ac221049fbb9ba83a17d1078474c4a747"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#ac221049fbb9ba83a17d1078474c4a747">SAND::ValueExtractors::densities</a></div><div class="ttdeci">const FEValuesExtractors::Scalar densities(SolutionComponents::density&lt; dim &gt;)</div></div>
<div class="ttc" id="astep-1_8cc_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition:</b> <a href="step-1_8cc_source.html#l00086">step-1.cc:86</a></div></div>
<div class="ttc" id="aclassDynamicSparsityPattern_html_aa32f9f3ebad084d001349cd3ddb4074e"><div class="ttname"><a href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">DynamicSparsityPattern::reinit</a></div><div class="ttdeci">void reinit(const size_type m, const size_type n, const IndexSet &amp;rowset=IndexSet())</div><div class="ttdef"><b>Definition:</b> <a href="dynamic__sparsity__pattern_8cc_source.html#l00301">dynamic_sparsity_pattern.cc:301</a></div></div>
<div class="ttc" id="ampi__remote__point__evaluation__0_8txt_html_a07bb39fb970c095c229ed653f6be7030"><div class="ttname"><a href="mpi__remote__point__evaluation__0_8txt.html#a07bb39fb970c095c229ed653f6be7030">vertex</a></div><div class="ttdeci">*Helper class to access values on non matching grids *The name of the fields are chosen with the method quantities are computed at specified arbitrary positioned which receive the result and resort the result according to the points **Constructor[2.x.1] tolerance Tolerance in terms of unit cell coordinates for determining all cells around a point passed to the class during it might be necessary to adjust the tolerance in order to be able to identify a cell Floating point arithmetic implies that a point in not lie exactly on a vertex</div><div class="ttdef"><b>Definition:</b> <a href="mpi__remote__point__evaluation__0_8txt_source.html#l00005">mpi_remote_point_evaluation_0.txt:5</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga7b52b286796c23ef9ff178faf7a4b68f"><div class="ttname"><a href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">StandardExceptions::ExcNotImplemented</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcNotImplemented()</div></div>
<div class="ttc" id="anamespacemu_html"><div class="ttname"><a href="namespacemu.html">mu</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2function__parser_8h_source.html#l00032">function_parser.h:32</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8h_source.html#l01033">tria.h:1033</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_a07e1e8cad70f4d40499893eb4e603205"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#a07e1e8cad70f4d40499893eb4e603205">SAND::ValueExtractors::unfiltered_density_multipliers</a></div><div class="ttdeci">const FEValuesExtractors::Scalar unfiltered_density_multipliers(SolutionComponents::unfiltered_density_multiplier&lt; dim &gt;)</div></div>
<div class="ttc" id="afe_2fe__q_8h_html"><div class="ttname"><a href="fe_2fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="ampi__remote__point__evaluation__0_8txt_html_a45c57074a631760cdab557f450e880e0"><div class="ttname"><a href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a></div><div class="ttdeci">*Helper class to access values on non matching grids *The name of the fields are chosen with the method quantities are computed at specified arbitrary positioned which receive the result and resort the result according to the points **Constructor[2.x.1] tolerance Tolerance in terms of unit cell coordinates for determining all cells around a point passed to the class during it might be necessary to adjust the tolerance in order to be able to identify a cell Floating point arithmetic implies that a point in not lie exactly on a or face[2.x.2] enforce_unique_mapping Enforce unique mapping</div><div class="ttdef"><b>Definition:</b> <a href="mpi__remote__point__evaluation__0_8txt_source.html#l00005">mpi_remote_point_evaluation_0.txt:5</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1SolutionComponents_html_af9ebf6b819b61f39ea3f13a193b19a96"><div class="ttname"><a href="namespaceSAND_1_1SolutionComponents.html#af9ebf6b819b61f39ea3f13a193b19a96">SAND::SolutionComponents::unfiltered_density</a></div><div class="ttdeci">constexpr unsigned int unfiltered_density</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00070">step-79.cc:70</a></div></div>
<div class="ttc" id="aclassMappingQGeneric_html"><div class="ttname"><a href="classMappingQGeneric.html">MappingQGeneric&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1BoundaryIds_html_a04a00e8adf504a34745e04fe634ee63d"><div class="ttname"><a href="namespaceSAND_1_1BoundaryIds.html#a04a00e8adf504a34745e04fe634ee63d">SAND::BoundaryIds::no_force</a></div><div class="ttdeci">constexpr types::boundary_id no_force</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00101">step-79.cc:101</a></div></div>
<div class="ttc" id="abase_2vectorization_8h_html_ae5c8b2cd70b2640bab8f1ee4ccb7f4cc"><div class="ttname"><a href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; pow(const ::VectorizedArray&lt; Number, width &gt; &amp;x, const ::VectorizedArray&lt; Number, width &gt; &amp;p)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05727">vectorization.h:5727</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_ae502a219c72947e0c0abc6bc5d318a11"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#ae502a219c72947e0c0abc6bc5d318a11">SAND::ValueExtractors::unfiltered_densities</a></div><div class="ttdeci">const FEValuesExtractors::Scalar unfiltered_densities(SolutionComponents::unfiltered_density&lt; dim &gt;)</div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Scalar_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00095">fe_values_extractors.h:95</a></div></div>
<div class="ttc" id="abase_2timer_8h_html"><div class="ttname"><a href="base_2timer_8h.html">timer.h</a></div></div>
<div class="ttc" id="aiterators__0_8txt_html_a8c742afbfe0ebcd052583a6c31990f82"><div class="ttname"><a href="iterators__0_8txt.html#a8c742afbfe0ebcd052583a6c31990f82">state</a></div><div class="ttdeci">it does so for both DoFHandler and[2.x.14] objects Note that the DoFAccessor class is derived from either TriaAccessor or the DoFAccessor class comes in two flavors one accessing degrees of freedom on the level of a cell and the other accessing the active dofs of an active cell **The DoFCellAccessor class has the same purpose and relation to DoFCellAccessor as the CellAccessor has to TriaAccessor *Except to look up member you will not usually have to deal withthe actual class names listed above Rather one uses the typedefs provided bythe mesh classes Triangulation DoFHandler and[2.x.15] as wellas the function that generate such buta hexahedron there are corresponding types and calls like[2.x.34] that act on thedimension independent geometric objects and hex These just as the ones exist in active and non active forms *The actual definition of all the typedefs to the mesh classes arestated in the **and[2.x.37] classes for Triangulation and[1.x.10] classes for DoFHandler and[2.x.38] iterators *IteratorAccessorInternals Iterator and accessor internals being like act as if they pointed to an but in reality all they do is to return an accessor whendereferenced The accessor object contains the state</div><div class="ttdef"><b>Definition:</b> <a href="iterators__0_8txt_source.html#l00083">iterators_0.txt:83</a></div></div>
<div class="ttc" id="aclassSparseMatrix_html"><div class="ttname"><a href="classSparseMatrix.html">SparseMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassFunctions_1_1ConstantFunction_html"><div class="ttname"><a href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1SolutionComponents_html_abe8f98f8bdda741922a521f5a305b47d"><div class="ttname"><a href="namespaceSAND_1_1SolutionComponents.html#abe8f98f8bdda741922a521f5a305b47d">SAND::SolutionComponents::displacement_multiplier</a></div><div class="ttdeci">constexpr unsigned int displacement_multiplier</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00072">step-79.cc:72</a></div></div>
<div class="ttc" id="aclassBlockVectorBase_html_ae05a0e26814f032473ed2ef66da018bd"><div class="ttname"><a href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">BlockVectorBase::block</a></div><div class="ttdeci">BlockType &amp; block(const unsigned int i)</div></div>
<div class="ttc" id="agroup__Exceptions_html_ga72743302dcb1a0fb1f2f8dc5122d299e"><div class="ttname"><a href="group__Exceptions.html#ga72743302dcb1a0fb1f2f8dc5122d299e">Patterns::Tools::to_string</a></div><div class="ttdeci">std::string to_string(const T &amp;t)</div><div class="ttdef"><b>Definition:</b> <a href="base_2patterns_8h_source.html#l02413">patterns.h:2413</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_a149b969d62b110112ced6d4a4a467494"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#a149b969d62b110112ced6d4a4a467494">SAND::ValueExtractors::density_lower_slacks</a></div><div class="ttdeci">const FEValuesExtractors::Scalar density_lower_slacks(SolutionComponents::density_lower_slack&lt; dim &gt;)</div></div>
<div class="ttc" id="alac_2linear__operator_8h_html"><div class="ttname"><a href="lac_2linear__operator_8h.html">linear_operator.h</a></div></div>
<div class="ttc" id="aclassComponentMask_html"><div class="ttname"><a href="classComponentMask.html">ComponentMask</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2component__mask_8h_source.html#l00080">component_mask.h:80</a></div></div>
<div class="ttc" id="aclassBlockDynamicSparsityPattern_html"><div class="ttname"><a href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparsity__pattern_8h_source.html#l00549">block_sparsity_pattern.h:549</a></div></div>
<div class="ttc" id="aclassDataOutInterface_html_a93c780f93105e0daaa76c6c43694b4ae"><div class="ttname"><a href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">DataOutInterface::write_vtu</a></div><div class="ttdeci">void write_vtu(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07232">data_out_base.cc:7232</a></div></div>
<div class="ttc" id="anamespaceLinearAlgebra_1_1CUDAWrappers_1_1kernel_html_aa63f11d31d19bd16be69280eac69dd10"><div class="ttname"><a href="namespaceLinearAlgebra_1_1CUDAWrappers_1_1kernel.html#aa63f11d31d19bd16be69280eac69dd10">LinearAlgebra::CUDAWrappers::kernel::size_type</a></div><div class="ttdeci">types::global_dof_index size_type</div><div class="ttdef"><b>Definition:</b> <a href="lac_2cuda__kernels_8h_source.html#l00046">cuda_kernels.h:46</a></div></div>
<div class="ttc" id="alac_2affine__constraints_8h_html"><div class="ttname"><a href="lac_2affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="aparameter__handler__0_8txt_html_ad919e2b915d8e8226aef004c2d8399a8"><div class="ttname"><a href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">exception</a></div><div class="ttdeci">since default values may change in the process of program you cannot know the values of parameters not specified in the input file ****It is often convenient to have something happen as soon as a parameter value is read This could be a check that it is valid that a file that is listed in the parameter file exists **or to initiate something else in such as setting a variable outside the this action could also be initiated once all parameters are read via but it is sometimes[1.x.19] to do it right away *This is facilitated by the and can then do whatever they want with it **e save it somewhere outside the ParameterHandler in C one doesn t usually pass around the address of a but an action can be a function like object(taking a string as argument) that results from calling such as a[1.x.20] that has the form **[1.x.21] *and that is attached to a specific parameter. *A typical example of such an action would be as follows the content of the file equals the default value of the parameter the contents of files are never changed after declaration of a parameter a directory in this file system may not have a file called[2.x.20] in it In that the directory represents a subsection as declared and the directory s name will correspond to the name of the subsection It will then have no files in it at but it may have further directories in the code above will lead to a hierarchical representation of data that looks like this(the content of files is indicated at the right in a different font) this is only used when creating output for exceptions If non empty[2.x.35] is the ParameterHandler object will stop parsing lines after encountering[2.x.36] This is handy when adding extra data that shall be parsed manually If[2.x.37] the parameter handler will skip undefined sections and entries This is useful for partially parsing a parameter for example to obtain only the spatial dimension of the problem By default all entries and subsections are expected to be declared The function sets the value of all parameters it encounters in the input file to the provided value Parameters not explicitly listed in the input file are left at the value they previously which will be the default value provided to and for each parameter all associated actions that may previously have been set by or if an associated action throws an exception</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler__0_8txt_source.html#l00241">parameter_handler_0.txt:241</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a6ed7c846331069f406b8c9933c37fda4"><div class="ttname"><a href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandler&lt; dim, spacedim &gt; &amp;)</div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00266">dof_handler.h:266</a></div></div>
<div class="ttc" id="aclassSAND_1_1SANDTopOpt_html_a12d2d4c43a7806a69dc6df81b97e1c07"><div class="ttname"><a href="classSAND_1_1SANDTopOpt.html#a12d2d4c43a7806a69dc6df81b97e1c07">SAND::SANDTopOpt::SANDTopOpt</a></div><div class="ttdeci">SANDTopOpt()</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00214">step-79.cc:214</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a></div><div class="ttdeci">@ component_is_part_of_vector</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00062">data_component_interpretation.h:62</a></div></div>
<div class="ttc" id="aclassTable_html"><div class="ttname"><a href="classTable.html">Table</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00033">array_view.h:33</a></div></div>
<div class="ttc" id="aclassDoFHandler_html_a553ca864aaf70330d9be86bc78f36d1e"><div class="ttname"><a href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">DoFHandler::distribute_dofs</a></div><div class="ttdeci">void distribute_dofs(const FiniteElement&lt; dim, spacedim &gt; &amp;fe)</div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespaceDifferentiation_1_1SD_html_a592560ee80355620422a86087f11b9df"><div class="ttname"><a href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">Differentiation::SD::fabs</a></div><div class="ttdeci">Expression fabs(const Expression &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="symengine__math_8cc_source.html#l00273">symengine_math.cc:273</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00116">fe_update_flags.h:116</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_a2cbf5ad6b464871261dbd054bced18a8"><div class="ttname"><a href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">FiniteElementData::degree</a></div><div class="ttdeci">const unsigned int degree</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__base_8h_source.html#l00428">fe_base.h:428</a></div></div>
<div class="ttc" id="aclassIndexSet_html_a4efff8155d2f7abe987547a731ecb43a"><div class="ttname"><a href="classIndexSet.html#a4efff8155d2f7abe987547a731ecb43a">IndexSet::n_elements</a></div><div class="ttdeci">size_type n_elements() const</div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l01913">index_set.h:1913</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_1_1Airfoil_html_aba2454eb933cce1ab7d0d68b4f6041ff"><div class="ttname"><a href="namespaceGridGenerator_1_1Airfoil.html#aba2454eb933cce1ab7d0d68b4f6041ff">GridGenerator::Airfoil::create_triangulation</a></div><div class="ttdeci">void create_triangulation(Triangulation&lt; dim, dim &gt; &amp;tria, const AdditionalData &amp;additional_data=AdditionalData())</div></div>
<div class="ttc" id="apolynomials__abf__0_8txt_html_a7a716deb19e461cf8ba2a26e01c6a908"><div class="ttname"><a href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a></div><div class="ttdeci">*This class implements the[1.x.0] vector valued Arnold Boffi Falk polynomials as described in the article by Arnold Boffi SIAM J Numer Anal pp **The ABF polynomials are constructed such that the divergence is in the tensor product polynomial space[1.x.1] the polynomial order of each component must be two orders higher in the corresponding yielding the polynomial spaces[1.x.2] and[1.x.3] in resp ******Constructor Creates all basis functions for Raviart Thomas polynomials of given degree[2.x.1] k</div><div class="ttdef"><b>Definition:</b> <a href="polynomials__abf__0_8txt_source.html#l00013">polynomials_abf_0.txt:13</a></div></div>
<div class="ttc" id="anumerics_2vector__tools_8h_html"><div class="ttname"><a href="numerics_2vector__tools_8h.html">vector_tools.h</a></div></div>
<div class="ttc" id="abase_2function_8h_html"><div class="ttname"><a href="base_2function_8h.html">function.h</a></div></div>
<div class="ttc" id="aclassTimerOutput_html"><div class="ttname"><a href="classTimerOutput.html">TimerOutput</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2timer_8h_source.html#l00591">timer.h:591</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1SolutionComponents_html_a588bfd864c527d22182866c3b0973ae5"><div class="ttname"><a href="namespaceSAND_1_1SolutionComponents.html#a588bfd864c527d22182866c3b0973ae5">SAND::SolutionComponents::displacement</a></div><div class="ttdeci">constexpr unsigned int displacement</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00068">step-79.cc:68</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_af74f3b334f9c0a375c5b7afd07335505"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#af74f3b334f9c0a375c5b7afd07335505">SAND::ValueExtractors::density_upper_slack_multipliers</a></div><div class="ttdeci">const FEValuesExtractors::Scalar density_upper_slack_multipliers(SolutionComponents::density_upper_slack_multiplier&lt; dim &gt;)</div></div>
<div class="ttc" id="abase_2vectorization_8h_html_a2aa674852f105b0ed1b35f569c19fea6"><div class="ttname"><a href="base_2vectorization_8h.html#a2aa674852f105b0ed1b35f569c19fea6">std::log</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; log(const ::VectorizedArray&lt; Number, width &gt; &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05668">vectorization.h:5668</a></div></div>
<div class="ttc" id="anumerical__algorithms__0_8txt_html_a852a1e245dd2de4943eeb66beeaf65b1"><div class="ttname"><a href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">vector</a></div><div class="ttdeci">****This module groups a diverse set of classes that generally implement some sort of numerical algorithm on top all the basic and finite element classes in the library They are generally unconnected to each other *Some of the like KellyErrorEstimator and act on solutions already and compute derived quantities in the first two or help transferring a set of vectors from one mesh to another *The namespaces and VectorTools provide an assortment of such as creating a Laplace projecting or interpolating a function onto the present finite element etc The difference to the functions in the DoFTools and FETools functions is that they work on the DoFTools functions only act on a given DoFHandler object without reference to a data vector</div><div class="ttdef"><b>Definition:</b> <a href="numerical__algorithms__0_8txt_source.html#l00008">numerical_algorithms_0.txt:8</a></div></div>
<div class="ttc" id="aclassBlockVectorBase_html_a5253082a5591dc0d13fef1d65a3dbfae"><div class="ttname"><a href="classBlockVectorBase.html#a5253082a5591dc0d13fef1d65a3dbfae">BlockVectorBase::l1_norm</a></div><div class="ttdeci">real_type l1_norm() const</div></div>
<div class="ttc" id="anamespacetypes_html_aaf4eb6ec214fa642dfd956f11a9cd2d7"><div class="ttname"><a href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a></div><div class="ttdeci">unsigned int boundary_id</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00117">types.h:117</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a373fbdacd8c486e675b8d2bff8943192"><div class="ttname"><a href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global</a></div><div class="ttdeci">void distribute_local_to_global(const InVector &amp;local_vector, const std::vector&lt; size_type &gt; &amp;local_dof_indices, OutVector &amp;global_vector) const</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02250">affine_constraints.h:2250</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a></div><div class="ttdeci">@ always</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00221">dof_tools.h:221</a></div></div>
<div class="ttc" id="aconstraints__0_8txt_html_a5abc878123b65e2a7a16e57bba0e282e"><div class="ttname"><a href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a></div><div class="ttdeci">******This module deals with constraints on degrees of freedom The central class to deal with constraints is the AffineConstraints class *Constraints typically come from several for one usually enforces them by requiring that degrees of freedom on the boundary have particular for example[2.x.3] if the boundary condition[2.x.4] requires that the finite element solution[2.x.5] at the location of degree of freedom has the value Such constraints are generated by those versions of the[2.x.6] function that take a AffineConstraints for example no normal as happens in flow problems and is handled by the[2.x.11] function or prescribed tangential as happens in electromagnetic problems and is handled by the[2.x.13] function For the former imagine for example that we are at at vertex where the normal vector has the form[2.x.14] and that and[2.x.17] components of the flow field at this vertex are associated with degrees of and Then the no normal flux condition means that we need to have the condition[2.x.18] The prescribed tangential component leads to similar constraints though there is often something on the right hand side ****If you have hanging node constraints</div><div class="ttdef"><b>Definition:</b> <a href="constraints__0_8txt_source.html#l00020">constraints_0.txt:20</a></div></div>
<div class="ttc" id="anumerics_2matrix__tools_8h_html"><div class="ttname"><a href="numerics_2matrix__tools_8h.html">matrix_tools.h</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Vector_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00140">fe_values_extractors.h:140</a></div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
<div class="ttc" id="aclassTensor_html_afd0934b4edd71063f66a9c67540e79fc"><div class="ttname"><a href="classTensor.html#afd0934b4edd71063f66a9c67540e79fc">Tensor::norm</a></div><div class="ttdeci">numbers::NumberTraits&lt; Number &gt;::real_type norm() const</div></div>
<div class="ttc" id="avector__tools__point__value__0_8txt_html_ac7a5c2ceb5c739d5b51cc7e0eee8100a"><div class="ttname"><a href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a></div><div class="ttdeci">*Assembling of right hand sides **Create a right hand side vector for a point source at point[2.x.1] In other it creates a vector[2.x.2] so that[2.x.3] where[2.x.4] are the shape functions described by[2.x.5] and[2.x.6] is the point at which the delta function is located Prior content of the given[2.x.7] vector is deleted This function is for the case of a scalar finite element This function is typically used in one of these two with different values for right hand sides or and then evaluate the solution at the same point every time You could do this by calling[2.x.8] after each solve</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__point__value__0_8txt_source.html#l00015">vector_tools_point_value_0.txt:15</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a></div><div class="ttdeci">@ component_is_scalar</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00055">data_component_interpretation.h:55</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_a796721b56b3a90e4e3973c7caae4c3d8"><div class="ttname"><a href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; count_dofs_per_fe_block(const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::vector&lt; unsigned int &gt; &amp;target_block=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01943">dof_tools.cc:1943</a></div></div>
<div class="ttc" id="amapping__q__cache__0_8txt_html_ad70e0fe32f41f61653b79c84cbeedbee"><div class="ttname"><a href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a></div><div class="ttdeci">*This class implements a caching strategy for objects of the MappingQ family in terms of the[2.x.0] which is used in all operations of MappingQGeneric The information of the mapping is pre computed by the[2.x.1] function *The use of this class is discussed extensively in *[2.x.2] **Constructor[2.x.3] denotes the polynomial degree of the polynomials that are used to map cells from the reference to the real cell **Copy constructor **Destructor see *[2.x.4] *Returns[2.x.5] because the preservation of vertex locations depends on the mapping handed to the where[2.x.12] is the polynomial degree of the and it must be in the order the mapping or FE_Q sort their i all[2.x.13] vertex points then the points on the and hexes according to the usual hierarchical numbering No attempt is made to validate these points except for the number of given points *If multiple threads are this function will run in invoking the function passed in several times in case[2.x.15] the user code must make sure that the typically a lambda</div><div class="ttdef"><b>Definition:</b> <a href="mapping__q__cache__0_8txt_source.html#l00024">mapping_q_cache_0.txt:24</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_a75b37471806be11bfd15238908ef2570"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#a75b37471806be11bfd15238908ef2570">SAND::ValueExtractors::displacement_multipliers</a></div><div class="ttdeci">const FEValuesExtractors::Vector displacement_multipliers(SolutionComponents::displacement_multiplier&lt; dim &gt;)</div></div>
<div class="ttc" id="aclassBlockVector_html_adf4d1d6c3538af95309a95da2ded758c"><div class="ttname"><a href="classBlockVector.html#adf4d1d6c3538af95309a95da2ded758c">BlockVector::reinit</a></div><div class="ttdeci">void reinit(const unsigned int n_blocks, const size_type block_size=0, const bool omit_zeroing_entries=false)</div></div>
<div class="ttc" id="aclassFiniteElementData_html_ae2fa3b8d578ba488b4f37061bb0278bb"><div class="ttname"><a href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">FiniteElementData::dofs_per_cell</a></div><div class="ttdeci">const unsigned int dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__base_8h_source.html#l00410">fe_base.h:410</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a></div><div class="ttdeci">@ update_normal_vectors</div><div class="ttdoc">Normal vectors.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00132">fe_update_flags.h:132</a></div></div>
<div class="ttc" id="aclassTensor_html"><div class="ttname"><a href="classTensor.html">Tensor&lt; 1, dim &gt;</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_ac76417d7404b75cf53c732f456e6e971"><div class="ttname"><a href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a></div><div class="ttdeci">void subdivided_hyper_rectangle(Triangulation&lt; dim, spacedim &gt; &amp;tria, const std::vector&lt; unsigned int &gt; &amp;repetitions, const Point&lt; dim &gt; &amp;p1, const Point&lt; dim &gt; &amp;p2, const bool colorize=false)</div></div>
<div class="ttc" id="aclassDataOut_html_a087f63e22f0614bca326dbdca288c646"><div class="ttname"><a href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01071">data_out.cc:1071</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1SolutionComponents_html_ab0e927cd09d3cf18f6b824f78a6cad78"><div class="ttname"><a href="namespaceSAND_1_1SolutionComponents.html#ab0e927cd09d3cf18f6b824f78a6cad78">SAND::SolutionComponents::density_upper_slack_multiplier</a></div><div class="ttdeci">constexpr unsigned int density_upper_slack_multiplier</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00082">step-79.cc:82</a></div></div>
<div class="ttc" id="afunction__level__set__0_8txt_html_a4ddc91faf724f1bf45831525942c64a3"><div class="ttname"><a href="function__level__set__0_8txt.html#a4ddc91faf724f1bf45831525942c64a3">center</a></div><div class="ttdeci">*Signed distance level set function of a is the center of the sphere and[2.x.2] is its radius This function is thus zero on the negative inside the ball having the sphere as its and positive in the rest of[2.x.3] This function has gradient and Hessian equal where[2.x.6] is the Kronecker delta function takes the center and radius of the sphere ***The gradient is singular at the center of the sphere If the incoming[2.x.11] is too close to the center</div><div class="ttdef"><b>Definition:</b> <a href="function__level__set__0_8txt_source.html#l00008">function_level_set_0.txt:8</a></div></div>
<div class="ttc" id="anamespaceDoFRenumbering_html_a52c1941406d1ce2937e29a46edf111f4"><div class="ttname"><a href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a></div><div class="ttdeci">void component_wise(DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const std::vector&lt; unsigned int &gt; &amp;target_component=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering_8cc_source.html#l00681">dof_renumbering.cc:681</a></div></div>
<div class="ttc" id="ageometry__info__0_8txt_html_a30a552b07accf65da90f851e25d14d1c"><div class="ttname"><a href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div><div class="ttdeci">3, where it offers following possibilities:a face(quad) being refined in x- or y-direction(in the face-intern coordinate system) separately,([2.x.79] or([2.x.80] which corresponds to([2.x.81]). Additionally, it offers the possibilities a face can have through repeated anisotropic refinement steps performed on one of the two neighboring cells. It might be possible for example, that a face(quad) is refined with[2.x.82] and afterwards the left child is again refined with[2.x.83], so that there are three active subfaces. Note, however, that only refinement cases are allowed such that each line on a face between two hexes has not more than one hanging node. Furthermore, it is not allowed that two neighboring hexes are refined such that one of the hexes refines the common face with[2.x.84] and the other hex refines that face with[2.x.85] . In fact,[2.x.86] takes care of this situation and ensures that each face of a refined cell is completely contained in a single face of neighboring cells. The following drawings explain the SubfacePossibilities and give the corresponding subface numbers:*[1.x.4] **[2.x.87] *[0.x.68] *Possible cases of faces being subdivided into subface. See documentation to the SubfacePossibilities&lt; 3 &gt; for more details on the subface possibilities. *[0.x.69] *A class that provides all possible cases a face(in the current space dimension[2.x.88] might be subdivided into subfaces. *[2.x.89] *[0.x.70] *Constructor. Take and store a value indicating a particular subface possibility in the list of possible situations specified in the base class. *[0.x.71] *Return the numeric value stored by this class. While the presence of this operator might seem dangerous, it is useful in cases where one would like to have code like&lt; code &gt;switch(subface_case)... case[2.x.90] ...&lt;/code &gt;, which can be written as&lt; code &gt;switch[2.x.91] Another application is to use an object of the current type as an index into an array dim</div><div class="ttdef"><b>Definition:</b> <a href="geometry__info__0_8txt_source.html#l00202">geometry_info_0.txt:202</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_ada143f177c93011d19b9753f7af32d57"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#ada143f177c93011d19b9753f7af32d57">SAND::ValueExtractors::density_lower_slack_multipliers</a></div><div class="ttdeci">const FEValuesExtractors::Scalar density_lower_slack_multipliers(SolutionComponents::density_lower_slack_multiplier&lt; dim &gt;)</div></div>
<div class="ttc" id="atrilinos__sparse__matrix__0_8txt_html_ab4e34663c28496ee1b07f40fd5d00fa1"><div class="ttname"><a href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a></div><div class="ttdeci">all column elements of a row are stored on the same processor in any case The vector&lt; tt &gt; n_entries_per_row&lt;/tt &gt; specifies the number of entries in each row of the newly generated matrix **This function is initializes the Trilinos Epetra matrix according to the specified sparsity_pattern</div><div class="ttdef"><b>Definition:</b> <a href="trilinos__sparse__matrix__0_8txt_source.html#l00162">trilinos_sparse_matrix_0.txt:162</a></div></div>
<div class="ttc" id="aclassSparseMatrix_html_a419e25c734b10802f9c7f59d652f84ca"><div class="ttname"><a href="classSparseMatrix.html#a419e25c734b10802f9c7f59d652f84ca">SparseMatrix::begin</a></div><div class="ttdeci">const_iterator begin() const</div></div>
<div class="ttc" id="abase_2signaling__nan_8h_html"><div class="ttname"><a href="base_2signaling__nan_8h.html">signaling_nan.h</a></div></div>
<div class="ttc" id="aclassSparsityPattern_html"><div class="ttname"><a href="classSparsityPattern.html">SparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2sparsity__pattern_8h_source.html#l00900">sparsity_pattern.h:900</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a98c83a8c964d1c88f6f2493b1c2ae26f"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a></div><div class="ttdeci">and where the chemical species react with each other based on reaction coefficients that also depend nonlinearly and in complicated ways on the chemical and pressure In many the exact formulas for all of these coefficients can take several lines to write out</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00012">automatic_and_symbolic_differentiation_0.txt:12</a></div></div>
<div class="ttc" id="aclassFunction_html_acbfcab66b2fc63bfea59268f40772bb4"><div class="ttname"><a href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">Function::value</a></div><div class="ttdeci">virtual RangeNumberType value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const</div></div>
<div class="ttc" id="adofs_2dof__tools_8h_html"><div class="ttname"><a href="dofs_2dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="agrid_2grid__refinement_8h_html"><div class="ttname"><a href="grid_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="afe_2fe__system_8h_html"><div class="ttname"><a href="fe_2fe__system_8h.html">fe_system.h</a></div></div>
<div class="ttc" id="aclassSparseDirectUMFPACK_html_adc154e4830b0e16be265f10a5c8b7103"><div class="ttname"><a href="classSparseDirectUMFPACK.html#adc154e4830b0e16be265f10a5c8b7103">SparseDirectUMFPACK::vmult</a></div><div class="ttdeci">void vmult(Vector&lt; double &gt; &amp;dst, const Vector&lt; double &gt; &amp;src) const</div><div class="ttdef"><b>Definition:</b> <a href="sparse__direct_8cc_source.html#l00762">sparse_direct.cc:762</a></div></div>
<div class="ttc" id="avector__valued__0_8txt_html_a2b24e414d1a0d32deea919c5e8899811"><div class="ttname"><a href="vector__valued__0_8txt.html#a2b24e414d1a0d32deea919c5e8899811">x</a></div><div class="ttdeci">([1.x.8]&lt; sub &gt;1&lt;/sub &gt;, [1.x.9]&lt; sub &gt;2&lt;/sub &gt;, [1.x.10]&lt; sub &gt;3&lt;/sub &gt;)&lt; sup &gt;T&lt;/sup &gt; and[1.x.11] accordingly. Then, we can write the simplified equation in coordinates as[1.x.12] We see, that this is just three copies of the bilinear form of the Laplacian, one applied to each component(this is where the formulation with the[2.x.33] is more exciting, and we want to derive a framework that applies to that one as well). We can make this weak form a system of differential equations again by choosing special test functions:first, choose[1.x.13]=([1.x.14]&lt; sub &gt;1&lt;/sub &gt;, 0, 0)&lt; sup &gt;T&lt;/sup &gt;, then[1.x.15]=(0, [1.x.16]&lt; sub &gt;2&lt;/sub &gt;, 0)&lt; sup &gt;T&lt;/sup &gt;, and finally[1.x.17]=(0, 0, [1.x.18]&lt; sub &gt;3&lt;/sub &gt;)&lt; sup &gt;T&lt;/sup &gt;. writing the outcomes below each other, we obtain the system[1.x.19] where we used the standard inner product notation[2.x.34] . It is important for our understanding, that we keep in mind that the latter form as a system of PDE is completely equivalent to the original definition of the bilinear form[1.x.20]([1.x.21], [1.x.22]), which does not immediately exhibit this system structure. Let us close by writing the full system of the elastic equation with symmetric gradient[1.x.23]:[1.x.24] Very formally, if we believe in operator valued matrices, we can rewrite this in the form[1.x.25]&lt; sup &gt;T&lt;/sup &gt;[1.x.26]=[1.x.27]&lt; sup &gt;T&lt;/sup &gt;[1.x.28] or[1.x.29] *[1.x.30] Now, let us consider a more complex example, the mixed Laplace equations discussed in[2.x.35] in three dimensions:[1.x.31] **Here, we have four solution components:the scalar pressure[2.x.36] and the vector-valued velocity[2.x.37] with three vector components. Note as important difference to the previous example, that the vector space[1.x.32] is not just simply a copy of three identical spaces/*A systematic way to get a weak or variational form for this and other vector problems is to first consider it as a problem where the operators and solution variables are written in vector and matrix form. For the example, this would read as follows:[1.x.33] **This makes it clear that the solution[1.x.34] *indeed has four components. We note that we could change the ordering of the solution components[2.x.38] and[2.x.39] inside[2.x.40] if we also change columns of the matrix operator.*Next, we need to think about test functions[2.x.41] . We want to multiply both sides of the equation with them, then integrate over[2.x.42] . The result should be a scalar equality. We can achieve this by choosing[2.x.43] also vector valued as[1.x.35] **It is convenient to multiply the matrix-vector equation by the test function from the left, since this way we automatically get the correct matrix later on(in the linear system, the matrix is also multiplied from the right with the solution variable, not from the left), whereas if we multiplied from the right then the matrix so assembled is the transpose of the one we really want. *With this in mind, let us multiply by[2.x.44] and integrate to get the following equation which has to hold for all test functions[2.x.45] :[1.x.36] *or equivalently:[1.x.37] ***We get the final form by integrating by part the second term:[1.x.38] **It is this form that we will later use in assembling the discrete weak form into a matrix and a right hand side vector:the form in which we have solution and test functions[2.x.46] that each consist of a number of vector components that we can extract. **[2.x.47] VVFEs[1.x.39] *Once we have settled on a bilinear form and a functional setting, we need to find a way to describe the vector-valued finite element spaces from which we draw solution and test functions. This is where the FESystem class comes in:it composes vector-valued finite element spaces from simpler ones. In the example of the elasticity problem, we need[2.x.48] copies of the same element, for instance **[1.x.40] *This will generate a vector valued space of dimension[2.x.49], where each component is a continuous bilinear element of type FE_Q. It will have[2.x.50] times as many basis functions as the corresponding FE_Q, and each of these basis functions is a basis function of FE_Q, lifted into one of the components of the vector. *For the mixed Laplacian, the situation is more complex. First, we have to settle on a pair of discrete spaces[2.x.51] . One option would be the stable Raviart-Thomas pair **[1.x.41] *The first element in this system is already a vector valued element of dimension[2.x.52], while the second is a regular scalar element. *Alternatively to using the stable Raviart-Thomas pair, we could consider a stabilized formulation for the mixed Laplacian, for instance the LDG method. There, we have the option of using the same spaces for velocity components and pressure, namely **[1.x.42] *This system just has[2.x.53] equal copies of the same discontinuous element, which not really reflects the structure of the system. Therefore, we prefer **[1.x.43] *Here, we have a system of two elements, one vector-valued and one scalar, very much like with the[2.x.54] . Indeed, in many codes, the two can be interchanged. This element also allows us easily to switch to an LDG method with lower order approximation in the velocity, namely **[1.x.44] *It must be pointed out, that this element is different from **[1.x.45] *While the constructor call is very similar to[2.x.55], the result actually resembles more[2.x.56] in that this element produces[2.x.57] independent components. A more detailed comparison of the resulting FESystem objects is below. *[1.x.46] *FESystem has a few internal variables which reflect the internal structure set up by the constructor. These can then also be used by application programs to give structure to matrix assembling and linear algebra. We give the names and values of these variables for the examples above in the following table:&lt; table border=&quot;1&quot;&gt;&lt; tr &gt;&lt; th &gt;System Element&lt;/th &gt;[2.x.58][2.x.59][2.x.60]&lt;/tr &gt;&lt; tr &gt;&lt; td &gt;[2.x.61]&lt;/td &gt;&lt; td &gt;1&lt;/td &gt;&lt;/tr &gt;&lt; tr &gt;&lt; td &gt;[2.x.62]&lt;/td &gt;&lt; td &gt;2&lt;/td &gt;&lt;/tr &gt;&lt; tr &gt;&lt; td &gt;[2.x.63]&lt;/td &gt;&lt; td &gt;2&lt;/td &gt;&lt;/tr &gt;&lt; tr &gt;&lt; td &gt;[2.x.64]&lt;/td &gt;&lt; td &gt;1&lt;/td &gt;&lt;/tr &gt;&lt; tr &gt;&lt; td &gt;[2.x.65]&lt;/td &gt;&lt; td &gt;2&lt;/td &gt;&lt;/tr &gt;&lt;/table &gt; *From this table, it is clear that the FESystem reflects a lot of the structure of the system of differential equations in the cases of the[2.x.66] and the[2.x.67], in that we have a vector valued and a scalar variable. On the other hand, the convoluted elements do not have this structure and we have to reconstruct it somehow when assembling systems, as described below. *At this point, it is important to note that nesting of two FESystem object can give the whole FESystem a richer structure than just concatenating them. This structure can be exploited by application programs, but is not automatically so. *[2.x.68] VVAssembling[1.x.47] The next step is to assemble the linear system. How to do this for the simple case of a scalar problem has been shown in many tutorial programs, starting with[2.x.69] . Here we will show how to do it for vector problems. Corresponding to the different characterizations of weak formulations above and the different system elements created, we have a few options which are outlined below. *The whole concept is probably best explained by showing an example illustrating how the local contribution of a cell to the weak form of above mixed Laplace equations could be assembled. *[1.x.48] This is essentially how[2.x.70] does it:**[1.x.49] **So here 's what is happening:[2.x.71][2.x.72] The first thing we do is to declare &quot;extractors&quot;(see the FEValuesExtractors namespace). These are objects that don 't do much except store which components of a vector-valued finite element constitute a single scalar component, or a tensor of rank 1(i.e. what we call a &quot;physical vector&quot;, always consisting of[2.x.73] components). Here, we declare an object that represents the velocities consisting of[2.x.74] components starting at component zero, and the extractor for the pressure, which is a scalar component at position[2.x.75] . *[2.x.76] We then do our usual loop over all cells, shape functions, and quadrature points. In the innermost loop, we compute the local contribution of a pair of shape functions to the global matrix and right hand side vector. Recall that the cell contributions to the bilinear form(i.e. neglecting boundary terms) looked as follows, based on shape functions[2.x.77] :[1.x.50] *whereas the implementation looked like this:*[1.x.51] *The similarities are pretty obvious. *[2.x.78] Essentially, what happens in above code is this:when you do[2.x.79], a so-called &quot;view&quot; is created, i.e. an object that unlike the full FEValues object represents not all components of a finite element, but only the one(s) represented by the extractor object[2.x.80] or[2.x.81] . *[2.x.82] These views can then be asked for information about these individual components. For example, when you write[2.x.83] you get the value of the pressure component of the[2.x.84] th shape function[2.x.85] at the[2.x.86] th quadrature point. Because the extractor[2.x.87] represents a scalar component, the results of the operator[2.x.88] is a scalar number. On the other hand, the call[2.x.89] would produce the value of a whole set of[2.x.90] components, which would be of type[2.x.91] . *[2.x.92] Other things that can be done with views is to ask for the gradient of a particular shape function 's components described by an extractor. For example,[2.x.93] would represent the gradient of the scalar pressure component, which is of type[2.x.94], whereas the gradient of the velocities components,[2.x.95] is a[2.x.96], i.e. a matrix[2.x.97] that consists of entries[2.x.98] . Finally, both scalar and vector views can be asked for the second derivatives(&quot;Hessians&quot;) and vector views can be asked for the symmetric gradient, defined as[2.x.99] as well as the divergence[2.x.100] .[2.x.101] Other examples of using extractors and views are shown in tutorial programs[2.x.102],[2.x.103],[2.x.104] and several other programs. ***[2.x.105] In the current context, when we talk about a vector(for example in extracting the velocity components above), we mean the word in the sense physics uses it:it has[2.x.106] components that behave in specific ways under coordinate system transformations. Examples include velocity or displacement fields. This is opposed to how mathematics uses the word &quot;vector&quot;(and how we use this word in other contexts in the library, for example in the Vector class), where it really stands for a collection of numbers. An example of this latter use of the word could be the set of concentrations of chemical species in a flame x</div><div class="ttdef"><b>Definition:</b> <a href="vector__valued__0_8txt_source.html#l00090">vector_valued_0.txt:90</a></div></div>
<div class="ttc" id="amapping__q__internal__0_8txt_html_a7a28370132a1e8adca9c727413c710b4"><div class="ttname"><a href="mapping__q__internal__0_8txt.html#a7a28370132a1e8adca9c727413c710b4">determinant</a></div><div class="ttdeci">namespace to implement methods of MappingQGeneric such as the evaluation of the mapping and the transformation between real and unit cell **This function generates the reference cell support points from the support points by expanding the tensor product **This function is needed by the constructor of&lt; tt &gt; MappingQ&lt; dim, spacedim &gt;&lt;/tt &gt; for&lt; tt &gt; compute the mapped location of that point in real space **Implementation of transform_real_to_unit_cell for either type double or VectorizedArray&lt; double &gt; **Implementation of transform_real_to_unit_cell for which is generally a rational function This allows for a very cheap evaluation of the inverse map by a simple polynomial which can be used as a better initial guess for transforming points from real to unit coordinates than an affine approximation Far away outside the unit this approximation can become inaccurate for non affine cell shapes This must be expected from a fit of a polynomial to a rational and due to the fact that the region of the least squares the unit is left use this function with care in those situations **Number of basis functions in the quadratic approximation **Constructor[2.x.2] real_support_points The position of the mapping support points in real queried by[2.x.3][2.x.4] unit_support_points The location of the support points in reference coordinates[2.x.5] that map to the mapping support points in real space by a polynomial map **Copy constructor **Evaluate the quadratic approximation **In order to guarantee a good we need to apply a transformation to the points in real space that is computed by a shift vector we switch to an affine approximation that always works but is less accurate **In case the quadrature formula is a tensor this is a replacement for but only if the update_flags of the[2.x.6] argument indicate so **Update the co and contravariant matrices as well as their determinant</div><div class="ttdef"><b>Definition:</b> <a href="mapping__q__internal__0_8txt_source.html#l00045">mapping_q_internal_0.txt:45</a></div></div>
<div class="ttc" id="aadvection__0_8txt_html_a79a3cbbb7583dd309bf1b14dc20895b6"><div class="ttname"><a href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a></div><div class="ttdeci">**its DG formulations All advection operators depend on an advection velocity denoted by[1.x.0] in the formulas below It is denoted as&lt; tt &gt; velocity&lt;/tt &gt; in the parameter lists The functions cell_matrix() and both upwind_value_matrix() are taking the equation in weak form</div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00039">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1SolutionComponents_html_a42c8be5933db7eed97ce861429f46290"><div class="ttname"><a href="namespaceSAND_1_1SolutionComponents.html#a42c8be5933db7eed97ce861429f46290">SAND::SolutionComponents::density_upper_slack</a></div><div class="ttdeci">constexpr unsigned int density_upper_slack</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00080">step-79.cc:80</a></div></div>
<div class="ttc" id="abase_2quadrature__lib_8h_html"><div class="ttname"><a href="base_2quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="aclassSparseMatrix_html_ac94776653684705604fea3dae0af35f4"><div class="ttname"><a href="classSparseMatrix.html#ac94776653684705604fea3dae0af35f4">SparseMatrix&lt; double &gt;::iterator</a></div><div class="ttdeci">SparseMatrixIterators::Iterator&lt; double, false &gt; iterator</div><div class="ttdef"><b>Definition:</b> <a href="lac_2sparse__matrix_8h_source.html#l00583">sparse_matrix.h:583</a></div></div>
<div class="ttc" id="alac_2block__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2block__sparse__matrix_8h.html">block_sparse_matrix.h</a></div></div>
<div class="ttc" id="atable__handler__0_8txt_html_ac42f579ca4a40d2835c1abb1cb95121d"><div class="ttname"><a href="table__handler__0_8txt.html#ac42f579ca4a40d2835c1abb1cb95121d">scientific</a></div><div class="ttdeci">more if you want to prescribe the order in which columns are later printed by declaring columns in a particular order before entries are ever put into unsigned or a compiler error will result **If a row is only partially then set all elements of that row for which no elements exist in a particular column to the empty string This is akin to the auto_fill_mode described in the but more general because it allows you to start writing into a column for a new row without having to know that that column had been written to in the previous row If all columns have been written into in the current then this function doesn t do anything at all In other conceptually the function completes the current though its use case is to start a new row **Switch auto fill mode on or off See the general documentation of this class for a description of what auto fill mode does **Creates a respectively To merge two columns&lt; tt &gt; c1&lt;/tt &gt; and&lt; tt &gt; c2&lt;/tt &gt; to a supercolumn&lt; tt &gt; sc&lt;/tt &gt; hence call&lt; tt &gt; sc&lt;/tt &gt; Concerning the order of the the supercolumn replaces the first column that is added to the supercolumn Within the supercolumn the order of output follows the order the columns are added to the supercolumn **Change the order of columns and supercolumns in the table&lt; tt &gt; new_order&lt;/tt &gt; includes the keys and superkeys of the columns and supercolumns in the order the user would like them to be output If a superkey is included the keys of the subcolumns need not be explicitly mentioned in this vector The order of subcolumns within a supercolumn is not changeable and remains in the order in which the columns are added to the supercolumn This function may also be used to break big tables with too many columns into smaller ones For you can call this function with the first five columns and then call one of the&lt; tt &gt; write_ *&lt;/tt &gt; then call this function with the next five columns and again&lt; tt &gt; write_ *&lt;/tt &gt; and so on **Set the&lt; tt &gt; precision&lt;/tt &gt; e g double or float variables are written with&lt; tt &gt; precision&lt;/tt &gt; is the same as in calling&lt; tt &gt; out&lt;&lt; setprecision(precision)&lt;/tt &gt; **Set the&lt; tt &gt; scientific_flag&lt;/tt &gt; True means scientific</div><div class="ttdef"><b>Definition:</b> <a href="table__handler__0_8txt_source.html#l00168">table_handler_0.txt:168</a></div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_a8f384576a64c89a6fa8352847523e340"><div class="ttname"><a href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for n_q_points</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00537">fe_evaluation_0.txt:537</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a7b3d3f295bb56d6cd6856bdc6cbe8a01"><div class="ttname"><a href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">AffineConstraints::distribute</a></div><div class="ttdeci">void distribute(VectorType &amp;vec) const</div></div>
<div class="ttc" id="adofs_2dof__renumbering_8h_html"><div class="ttname"><a href="dofs_2dof__renumbering_8h.html">dof_renumbering.h</a></div></div>
<div class="ttc" id="aclassBlockSparsityPattern_html"><div class="ttname"><a href="classBlockSparsityPattern.html">BlockSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparsity__pattern_8h_source.html#l00425">block_sparsity_pattern.h:425</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_addd15bc409c61d6f795f0132c574335b"><div class="ttname"><a href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">AffineConstraints::clear</a></div><div class="ttdeci">void clear()</div></div>
<div class="ttc" id="abase_2tensor_8h_html"><div class="ttname"><a href="base_2tensor_8h.html">tensor.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00124">fe_update_flags.h:124</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01581">exceptions.h:1581</a></div></div>
<div class="ttc" id="alac_2block__vector_8h_html"><div class="ttname"><a href="lac_2block__vector_8h.html">block_vector.h</a></div></div>
<div class="ttc" id="aclassSymmetricTensor_html_a7c03a03a5fe823733e7af9f7e4267f81"><div class="ttname"><a href="classSymmetricTensor.html#a7c03a03a5fe823733e7af9f7e4267f81">SymmetricTensor::determinant</a></div><div class="ttdeci">constexpr Number determinant(const SymmetricTensor&lt; 2, dim, Number &gt; &amp;t)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l02666">symmetric_tensor.h:2666</a></div></div>
<div class="ttc" id="alac_2full__matrix_8h_html"><div class="ttname"><a href="lac_2full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="aclassIndexSet_html_ae1c4da2486b3c1bb2dfdd8940b42ec61"><div class="ttname"><a href="classIndexSet.html#ae1c4da2486b3c1bb2dfdd8940b42ec61">IndexSet::nth_index_in_set</a></div><div class="ttdeci">size_type nth_index_in_set(const size_type local_index) const</div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l01961">index_set.h:1961</a></div></div>
<div class="ttc" id="aclassFEFaceValues_html_a49db483b7252515ea578be6d57c5874b"><div class="ttname"><a href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">FEFaceValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell, const unsigned int face_no)</div></div>
<div class="ttc" id="aclassSAND_1_1SANDTopOpt_html"><div class="ttname"><a href="classSAND_1_1SANDTopOpt.html">SAND::SANDTopOpt</a></div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00138">step-79.cc:138</a></div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_a8cd7076dfb3722290a423c54fc25f28d"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#a8cd7076dfb3722290a423c54fc25f28d">SAND::ValueExtractors::displacements</a></div><div class="ttdeci">const FEValuesExtractors::Vector displacements(SolutionComponents::displacement&lt; dim &gt;)</div></div>
<div class="ttc" id="alac_2sparse__direct_8h_html"><div class="ttname"><a href="lac_2sparse__direct_8h.html">sparse_direct.h</a></div></div>
<div class="ttc" id="acuda__matrix__free__0_8txt_html_a747ffbda88fa48702c72f4b04f9c5721"><div class="ttname"><a href="cuda__matrix__free__0_8txt.html#a747ffbda88fa48702c72f4b04f9c5721">JxW</a></div><div class="ttdeci">*This class collects all the data that is stored for the matrix free implementation The storage scheme is tailored towards several loops performed with the same data i e typically doing many matrix vector products or residual computations on the same mesh This class does not implement any operations involving finite element basis functions i e regarding the operation performed on the cells For these operations the class FEEvaluation is designed to use the data collected in this class This class implements a loop over all which implies that it is possible to write to vectors in parallel without having to explicitly synchronize access to these vectors and matrices This class does not implement any shape values all it does is to cache the respective data To implement finite element operations use the class[2.x.0] This class traverse the cells in a different order than the usual Triangulation class in deal II *Only float and double are supported ***Parallelization scheme parallelization over degrees of freedom or over cells **This flag is used to determine which quantities should be cached This class can cache data needed for gradient Jacobian quadrature points as well as data for only data for gradients and Jacobian determinants times quadrature JxW</div><div class="ttdef"><b>Definition:</b> <a href="cuda__matrix__free__0_8txt_source.html#l00014">cuda_matrix_free_0.txt:14</a></div></div>
<div class="ttc" id="astep-69_8cc_html_a66a64d07b4db87c87b639bdcf7b18c82"><div class="ttname"><a href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; local_dof_indices</div><div class="ttdef"><b>Definition:</b> <a href="step-69_8cc_source.html#l00534">step-69.cc:534</a></div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point&lt; dim &gt;</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a4f7cb22b3c971599a839fddc988ef92a"><div class="ttname"><a href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">AffineConstraints::set_inhomogeneity</a></div><div class="ttdeci">void set_inhomogeneity(const size_type constrained_dof_index, const number value)</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02075">affine_constraints.h:2075</a></div></div>
<div class="ttc" id="apreconditioners__0_8txt_html_abebc9af399f7664771e26564a49c8dc1"><div class="ttname"><a href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a></div><div class="ttdeci">*****Preconditioners are used to accelerate the iterative solution of linear systems Typical preconditioners are Gauss or but the library also supports more complex ones such as Vanka or incomplete LU sparse direct solvers can be used as preconditioners when available *Broadly preconditioners are which are multiplied with a matrix to improve conditioning The idea that the preconditioned system[1.x.1] is much easier to solve than the original system[1.x.2] What this means exactly depends on the structure of the matrix and cannot be discussed here in generality For positive definite matrices[1.x.3] it means that the spectral condition Richardson iteration</div><div class="ttdef"><b>Definition:</b> <a href="preconditioners__0_8txt_source.html#l00009">preconditioners_0.txt:9</a></div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_ad3b9cdeadeb3bcdb52af5db70c041a6e"><div class="ttname"><a href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for can be different if such as FE_DGP **static The number of degrees of freedom of all components determined from the given template argument fe_degree Note that the actual number of degrees of freedom dofs_per_cell can be different if such as FE_DGP **static The number of degrees of freedom of all components determined from the given template argument fe_degree Note that the actual number of degrees of freedom dofs_per_cell can be different if such as FE_DGP **Constructor Takes all data stored in MatrixFree If applied to problems with more than one finite element or more than one quadrature formula selected during construction of[2.x.343] the appropriate component can be selected by the optional arguments[2.x.344] matrix_free Data object that contains all data[2.x.345] dof_no If matrix_free was set up with multiple DoFHandler this parameter selects to which DoFHandler AffineConstraints pair the given evaluator should be attached to[2.x.346] quad_no If matrix_free was set up with multiple Quadrature this parameter selects the appropriate number of the quadrature formula[2.x.347] first_selected_component If the dof_handler selected by dof_no uses an FESystem consisting of more than one this parameter allows for selecting the component where the current evaluation routine should start Note that one evaluator does not support combining different shape functions in different components In other the same base element of a FESystem needs to be set for the components between[2.x.348] and[2.x.349][2.x.350] active_fe_index If matrix_free was set up with DoFHandler objects with[2.x.351] this parameter selects to which DoFHandler AffineConstraints pair the given evaluator should be attached to[2.x.352] active_quad_index If matrix_free was set up with[2.x.353] this parameter selects the appropriate number of the quadrature formula **Constructor Takes all data stored in MatrixFree for a given cell which allows to automatically identify the active_fe_index and active_quad_index in case of a p adaptive strategy The rest of the arguments are the same as in the constructor above **Constructor that comes with reduced functionality and works similar as FEValues The arguments are similar to the ones passed to the constructor of with the notable difference that FEEvaluation expects a one dimensional quadrature instead of a[2.x.354] dimensional one The finite element can be both scalar or vector but this method always only selects a scalar base element at a the optional argument[2.x.356] allows to specify the index of the base element to be used for evaluation Note that the internal data structures always assume that the base element is non primitive are not supported currently As known from a call to the reinit method with a[2.x.357] is necessary to make the geometry and degrees of freedom of the current class known::If the iterator includes DoFHandler the initialization allows to also read from or write to vectors in the standard way for[2.x.359] types for one cell at a time this approach is much slower than the path with MatrixFree with MPI since index translation has to be done As only one cell at a time is this method does not vectorize over several but only possibly within the element if the evaluate integrate routines are combined inside user an object of type i the underlying mapping and quadrature points do only need to be evaluated once Make sure to not pass an optional object around when you intend to use the FEEvaluation object in parallel to the given one because otherwise the intended sharing may create race conditions **Copy constructor If FEEvaluationBase was constructed from a fe</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00555">fe_evaluation_0.txt:555</a></div></div>
<div class="ttc" id="atable__handler__0_8txt_html_a61e9964f9093088848525ca172895749"><div class="ttname"><a href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a></div><div class="ttdeci">the ConvergenceTable class does something like this *To support both the TableHandler class has a property called[1.x.4] By auto fill mode is but it can be enabled by calling set_auto_fill_mode(). If auto-fill mode is enabled we use the following algorithm call it *[2.x.18] ***If[2.x.19] then we add[2.x.20] copies of the object[2.x.21] to this column is the data type of the given[2.x.23] is a numeric then[2.x.24] is[2.x.25] is the empty string *[2.x.26] ***Add the given value to this column *Padding the column with default elements makes sure that after the addition the column has as many entries as the longest other column In other if we have skipped previous invocations of then the padding will enter default values into this column *The algorithm as described will fail if you try to skip adding values for a key if adding an element for this key is the first thing you want to do for a given iteration or time step</div><div class="ttdef"><b>Definition:</b> <a href="table__handler__0_8txt_source.html#l00070">table_handler_0.txt:70</a></div></div>
<div class="ttc" id="aclassQuadrature_html_af9f7d82770fa8126e19113f3e3db755b"><div class="ttname"><a href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">Quadrature::size</a></div><div class="ttdeci">unsigned int size() const</div></div>
<div class="ttc" id="aclassSparseDirectUMFPACK_html"><div class="ttname"><a href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2sparse__direct_8h_source.html#l00089">sparse_direct.h:89</a></div></div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a11139b28db021be1d2b762c3c5275ee4"><div class="ttname"><a href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">AffineConstraints::add_line</a></div><div class="ttdeci">void add_line(const size_type line_n)</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02001">affine_constraints.h:2001</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_adad35057b6e70ae37d4abe7878683d90"><div class="ttname"><a href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per the child indices of the child cells adjacent to face</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1BoundaryIds_html_aa1fedeca487643451d7d1cb9958184f2"><div class="ttname"><a href="namespaceSAND_1_1BoundaryIds.html#aa1fedeca487643451d7d1cb9958184f2">SAND::BoundaryIds::down_force</a></div><div class="ttdeci">constexpr types::boundary_id down_force</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00100">step-79.cc:100</a></div></div>
<div class="ttc" id="anamespaceMatrixTools_html_afe66f38c3a4f4e46dd8389b62209b891"><div class="ttname"><a href="namespaceMatrixTools.html#afe66f38c3a4f4e46dd8389b62209b891">MatrixTools::local_apply_boundary_values</a></div><div class="ttdeci">void local_apply_boundary_values(const std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const std::vector&lt; types::global_dof_index &gt; &amp;local_dof_indices, FullMatrix&lt; number &gt; &amp;local_matrix, Vector&lt; number &gt; &amp;local_rhs, const bool eliminate_columns)</div><div class="ttdef"><b>Definition:</b> <a href="matrix__tools_8cc_source.html#l00505">matrix_tools.cc:505</a></div></div>
<div class="ttc" id="anamespacetypes_html_a3bf9e493f1aab00b04933b81856144c4"><div class="ttname"><a href="namespacetypes.html#a3bf9e493f1aab00b04933b81856144c4">types::global_dof_index</a></div><div class="ttdeci">unsigned int global_dof_index</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00074">types.h:74</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">VectorTools::EvaluationFlags::min</a></div><div class="ttdeci">@ min</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00062">vector_tools_evaluate.h:62</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ac639e1db0b03fc797eca55e266afa976"><div class="ttname"><a href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per cell</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="aclassFEFaceValues_html"><div class="ttname"><a href="classFEFaceValues.html">FEFaceValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="aclassSAND_1_1SANDTopOpt_html_a1ab26b7b2bb38e7f74a85a5c729484e4"><div class="ttname"><a href="classSAND_1_1SANDTopOpt.html#a1ab26b7b2bb38e7f74a85a5c729484e4">SAND::SANDTopOpt::run</a></div><div class="ttdeci">void run()</div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l01814">step-79.cc:1814</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a2b7756e9cb8e53553211add5426f8e50"><div class="ttname"><a href="classAffineConstraints.html#a2b7756e9cb8e53553211add5426f8e50">AffineConstraints::add_entry</a></div><div class="ttdeci">void add_entry(const size_type constrained_dof_index, const size_type column, const number weight)</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02033">affine_constraints.h:2033</a></div></div>
<div class="ttc" id="agroup__CPP11_html_gaace8c98aca00e7e48a619bb5e08084aa"><div class="ttname"><a href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">DoFHandler::active_cell_iterators</a></div><div class="ttdeci">IteratorRange&lt; active_cell_iterator &gt; active_cell_iterators() const</div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_ac00ea19562c135512a6ff275a3cf0d8f"><div class="ttname"><a href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has this class generates all dim dimensional polynomials of the where the sum and[1.x.8] is less than or equal *[1.x.9] The i e for each dim dimensional polynomial in the polynomial space it gives the indices j</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00004">polynomial_space_0.txt:4</a></div></div>
<div class="ttc" id="aclassDynamicSparsityPattern_html_gae8b1dc183fb130d188ee13a5c8ba9324"><div class="ttname"><a href="classDynamicSparsityPattern.html#gae8b1dc183fb130d188ee13a5c8ba9324">DynamicSparsityPattern::add</a></div><div class="ttdeci">void add(const size_type i, const size_type j)</div><div class="ttdef"><b>Definition:</b> <a href="lac_2dynamic__sparsity__pattern_8h_source.html#l01085">dynamic_sparsity_pattern.h:1085</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">VectorTools::EvaluationFlags::max</a></div><div class="ttdeci">@ max</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00056">vector_tools_evaluate.h:56</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_a45f4d01f1c4c6337e4be6f10a81fbdab"><div class="ttname"><a href="namespaceDoFTools.html#a45f4d01f1c4c6337e4be6f10a81fbdab">DoFTools::extract_dofs</a></div><div class="ttdeci">IndexSet extract_dofs(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const ComponentMask &amp;component_mask)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l00393">dof_tools.cc:393</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut&lt; dim &gt;</a></div></div>
<div class="ttc" id="afunctions__0_8txt_html_af9f808a82e8c618e2e7a19dd08a9eae3"><div class="ttname"><a href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a></div><div class="ttdeci">****Functions are used in various places in deal for example to describe boundary coefficients in forcing or exact solutions Since closed form expressions for equations are often hard to pass along as function deal II uses the Function base class to describe these objects Essentially the interface of this base class requires derived classes to implement the ability to return the value of a function at one or a list of particular locations and function objects can then be used by algorithms like[2.x.1][2.x.2] and other functions *Some functions are needed again and and are therefore already provided in deal II This includes a function with a constant value</div><div class="ttdef"><b>Definition:</b> <a href="functions__0_8txt_source.html#l00007">functions_0.txt:7</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="anamespaceSAND_html"><div class="ttname"><a href="namespaceSAND.html">SAND</a></div><div class="ttdef"><b>Definition:</b> <a href="step-79_8cc_source.html#l00059">step-79.cc:59</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a1611aa37f754086388ca76bcd421cce5"><div class="ttname"><a href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">AffineConstraints::close</a></div><div class="ttdeci">void close()</div></div>
<div class="ttc" id="aclassFESystem_html"><div class="ttname"><a href="classFESystem.html">FESystem&lt; dim &gt;</a></div></div>
<div class="ttc" id="afe_2fe__values__0_8txt_html_a15ff2e0c168966d6ae13c4faabcec165"><div class="ttname"><a href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a></div><div class="ttdeci">we have to work a bit harder to compute this information **Default constructor Creates an invalid object **Constructor for an object that represents a single scalar component of a FEValuesBase for the shape function and quadrature point selected by the arguments[2.x.27] shape_function Number of the shape function to be evaluated Note that this number runs from zero to dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__0_8txt_source.html#l00073">fe_values_0.txt:73</a></div></div>
<div class="ttc" id="agrid_2grid__generator_8h_html"><div class="ttname"><a href="grid_2grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="apetsc__matrix__base__0_8txt_html_a5a1b8b75c93e6ea5e27829c4fe862a8e"><div class="ttname"><a href="petsc__matrix__base__0_8txt.html#a5a1b8b75c93e6ea5e27829c4fe862a8e">n</a></div><div class="ttdeci">local_size()&lt;/tt &gt;. *[0.x.57] *Return whether[2.x.13] is in the local range or not, see also local_range(). *[0.x.58] *Return a reference to the MPI communicator object in use with this matrix. This function has to be implemented in derived classes. *[0.x.59] *Return the number of nonzero elements of this matrix. Actually, it returns the number of entries in the sparsity pattern n</div><div class="ttdef"><b>Definition:</b> <a href="petsc__matrix__base__0_8txt_source.html#l00127">petsc_matrix_base_0.txt:127</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a02f5aa616d7b0799c538fe77d6c6c795"><div class="ttname"><a href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a></div><div class="ttdeci">i e</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00028">coding_conventions_0.txt:28</a></div></div>
<div class="ttc" id="anamespaceSAND_1_1ValueExtractors_html_a30f363fe7c63c168353b72e3a2dd28c4"><div class="ttname"><a href="namespaceSAND_1_1ValueExtractors.html#a30f363fe7c63c168353b72e3a2dd28c4">SAND::ValueExtractors::density_upper_slacks</a></div><div class="ttdeci">const FEValuesExtractors::Scalar density_upper_slacks(SolutionComponents::density_upper_slack&lt; dim &gt;)</div></div>
<div class="ttc" id="aclassBlockSparseMatrix_html"><div class="ttname"><a href="classBlockSparseMatrix.html">BlockSparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparse__matrix_8h_source.html#l00050">block_sparse_matrix.h:50</a></div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
