<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_41.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-41 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-41 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_15.html">step-15</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Introduction">Introduction</a>
        <li><a href="#Classicalformulation">Classical formulation</a>
        <li><a href="#Derivationofthevariationalinequality">Derivation of the variational inequality</a>
        <li><a href="#Formulationasasaddlepointproblem">Formulation as a saddle point problem</a>
        <li><a href="#ActiveSetmethodstosolvethesaddlepointproblem">Active Set methods to solve the saddle point problem</a>
        <li><a href="#Theprimaldualactivesetalgorithm">The primal-dual active set algorithm</a>
        <li><a href="#Implementation">Implementation</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#ThecodeObstacleProblemcodeclasstemplate">The <code>ObstacleProblem</code> class template</a>
        <li><a href="#Righthandsideboundaryvaluesandtheobstacle">Right hand side, boundary values, and the obstacle</a>
        <li><a href="#ImplementationofthecodeObstacleProblemcodeclass">Implementation of the <code>ObstacleProblem</code> class</a>
      <ul>
        <li><a href="#ObstacleProblemObstacleProblem">ObstacleProblem::ObstacleProblem</a>
        <li><a href="#ObstacleProblemmake_grid">ObstacleProblem::make_grid</a>
        <li><a href="#ObstacleProblemsetup_system">ObstacleProblem::setup_system</a>
        <li><a href="#ObstacleProblemassemble_system">ObstacleProblem::assemble_system</a>
        <li><a href="#ObstacleProblemassemble_mass_matrix_diagonal">ObstacleProblem::assemble_mass_matrix_diagonal</a>
        <li><a href="#ObstacleProblemupdate_solution_and_constraints">ObstacleProblem::update_solution_and_constraints</a>
        <li><a href="#ObstacleProblemsolve">ObstacleProblem::solve</a>
        <li><a href="#ObstacleProblemoutput_results">ObstacleProblem::output_results</a>
        <li><a href="#ObstacleProblemrun">ObstacleProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
</p>
<p><em>This program was contributed by JÃ¶rg Frohne (University of Siegen, Germany) while on a long-term visit to Texas A&amp;M University. <br  />
 This material is based upon work partly supported by ThyssenKrupp Steel Europe. </em></p>
<p><a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h3>Introduction</h3>
<p>This example is based on the Laplace equation in 2d and deals with the question what happens if a membrane is deflected by some external force but is also constrained by an obstacle. In other words, think of a elastic membrane clamped at the boundary to a rectangular frame (we choose \(\Omega = \left[-1,1\right]^2\)) and that sags through due to gravity acting on it. What happens now if there is an obstacle under the membrane that prevents it from reaching its equilibrium position if gravity was the only existing force? In the current example program, we will consider that under the membrane is a stair step obstacle against which gravity pushes the membrane.</p>
<p>This problem is typically called the "obstacle problem" (see also <a href="http://en.wikipedia.org/wiki/Obstacle_problem">this Wikipedia article</a>), and it results in a variational inequality, rather than a variational equation when put into the weak form. We will below derive it from the classical formulation, but before we go on to discuss the mathematics let us show how the solution of the problem we will consider in this tutorial program looks to gain some intuition of what we should expect:</p>
<table align="center" class="tutorial" cellspacing="3" cellpadding="3">
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.png" alt="" class="inline"/>   </td></tr>
</table>
<p>Here, at the left, we see the displacement of the membrane. The shape of the obstacle underneath is clearly visible. On the right, we overlay which parts of the membrane are in contact with the obstacle. We will later call this set of points the "active set" to indicate that an inequality constraint is active there.</p>
<p><a class="anchor" id="Classicalformulation"></a></p><h3>Classical formulation</h3>
<p>The classical formulation of the problem possesses the following form: </p><p class="formulaDsp">
\begin{align*} -\textrm{div}\ \sigma &amp;\geq f &amp; &amp;\quad\text{in } \Omega,\\ \sigma &amp;= \nabla u &amp; &amp;\quad\text{in } \Omega,\\ u(\mathbf x) &amp;= 0 &amp; &amp;\quad\text{on }\partial\Omega,\\ (-\Delta u - f)(u - g) &amp;= 0 &amp; &amp;\quad\text{in } \Omega,\\ u(\mathbf x) &amp;\geq g(\mathbf x) &amp; &amp;\quad\text{in } \Omega \end{align*}
</p>
<p> with \(u\in H^2(\Omega)\). \(u\) is a scalar valued function that denotes the vertical displacement of the membrane. The first equation is called equilibrium condition with a force of areal density \(f\). Here, we will consider this force to be gravity. The second one is known as Hooke's Law that says that the stresses \(\sigma\) are proportional to the gradient of the displacements \(u\) (the proportionality constant, often denoted by \(E\), has been set to one here, without loss of generality; if it is constant, it can be put into the right hand side function). At the boundary we have zero Dirichlet conditions. Obviously, the first two equations can be combined to yield \(-\Delta u \ge f\).</p>
<p>Intuitively, gravity acts downward and so \(f(\mathbf x)\) is a negative function (we choose \(f=-10\) in this program). The first condition then means that the total force acting on the membrane is gravity plus something positive: namely the upward force that the obstacle exerts on the membrane at those places where the two of them are in contact. How big is this additional force? We don't know yet (and neither do we know "where" it actually acts) but it must be so that the membrane doesn't penetrate the obstacle.</p>
<p>The fourth equality above together with the last inequality forms the obstacle condition which has to hold at every point of the whole domain. The latter of these two means that the membrane must be above the obstacle \(g(\mathbf x)\) everywhere. The second to last equation, often called the "complementarity
condition" says that where the membrane is not in contact with the obstacle (i.e., those \(\mathbf x\) where \(u(\mathbf x) - g(\mathbf x) \neq 0\)), then \(-\Delta u=f\) at these locations; in other words, no additional forces act there, as expected. On the other hand, where \(u=g\) we can have \(-\Delta u-f \neq 0\), i.e., there can be additional forces (though there don't have to be: it is possible for the membrane to just touch, not press against, the obstacle).</p>
<p><a class="anchor" id="Derivationofthevariationalinequality"></a></p><h3>Derivation of the variational inequality</h3>
<p>An obvious way to obtain the variational formulation of the obstacle problem is to consider the total potential energy: </p><p class="formulaDsp">
\begin{equation*} E(u) \dealcoloneq \dfrac{1}{2}\int\limits_{\Omega} \nabla u \cdot \nabla u - \int\limits_{\Omega} fu. \end{equation*}
</p>
<p> We have to find a solution \(u\in G\) of the following minimization problem: </p><p class="formulaDsp">
\begin{equation*} E(u)\leq E(v)\quad \forall v\in G, \end{equation*}
</p>
<p> with the convex set of admissible displacements: </p><p class="formulaDsp">
\begin{equation*} G \dealcoloneq \lbrace v\in V: v\geq g \text{ a.e. in } \Omega\rbrace,\quad V\dealcoloneq H^1_0(\Omega). \end{equation*}
</p>
<p> This set takes care of the third and fifth conditions above (the boundary values and the complementarity condition).</p>
<p>Consider now the minimizer \(u\in G\) of \(E\) and any other function \(v\in G\). Then the function </p><p class="formulaDsp">
\begin{equation*} F(\varepsilon) \dealcoloneq E(u+\varepsilon(v-u)),\quad\varepsilon\in\left[0,1\right], \end{equation*}
</p>
<p> takes its minimum at \(\varepsilon = 0\) (because \(u\) is a minimizer of the energy functional \(E(\cdot)\)), so that \(F&#39;(0)\geq 0\) for any choice of \(v\). Note that \(u+\varepsilon(v-u) = (1-\varepsilon)u+\varepsilon v\in G\) because of the convexity of \(G\). If we compute \(F&#39;(\varepsilon)\vert_{\varepsilon=0}\) it yields the variational formulation we are searching for:</p>
<p><em>Find a function \(u\in G\) with</em> </p><p class="formulaDsp">
\begin{equation*} \left(\nabla u, \nabla(v-u)\right) \geq \left(f,v-u\right) \quad \forall v\in G. \end{equation*}
</p>
<p>This is the typical form of variational inequalities, where not just \(v\) appears in the bilinear form but in fact \(v-u\). The reason is this: if \(u\) is not constrained, then we can find test functions \(v\) in \(G\) so that \(v-u\) can have any sign. By choosing test functions \(v_1,v_2\) so that \(v_1-u = -(v_2-u)\) it follows that the inequality can only hold for both \(v_1\) and \(v_2\) if the two sides are in fact equal, i.e., we obtain a variational equality.</p>
<p>On the other hand, if \(u=g\) then \(G\) only allows test functions \(v\) so that in fact \(v-u\ge 0\). This means that we can't test the equation with both \(v-u\) and \(-(v-u)\) as above, and so we can no longer conclude that the two sides are in fact equal. Thus, this mimics the way we have discussed the complementarity condition above.</p>
<p><a class="anchor" id="Formulationasasaddlepointproblem"></a></p><h3>Formulation as a saddle point problem</h3>
<p>The variational inequality above is awkward to work with. We would therefore like to reformulate it as an equivalent saddle point problem. We introduce a Lagrange multiplier \(\lambda\) and the convex cone \(K\subset V&#39;\), \(V&#39;\) dual space of \(V\), \(K \dealcoloneq \{\mu\in V&#39;: \langle\mu,v\rangle\geq 0,\quad \forall v\in V, v \le 0 \}\) of Lagrange multipliers, where \(\langle\cdot,\cdot\rangle\) denotes the duality pairing between \(V&#39;\) and \(V\). Intuitively, \(K\) is the cone of all "non-positive
functions", except that \(K\subset (H_0^1)&#39;\) and so contains other objects besides regular functions as well. This yields:</p>
<p><em>Find \(u\in V\) and \(\lambda\in K\) such that</em> </p><p class="formulaDsp">
\begin{align*} a(u,v) + b(v,\lambda) &amp;= f(v),\quad &amp;&amp;v\in V\\ b(u,\mu - \lambda) &amp;\leq \langle g,\mu - \lambda\rangle,\quad&amp;&amp;\mu\in K, \end{align*}
</p>
<p> <em>with</em> </p><p class="formulaDsp">
\begin{align*} a(u,v) &amp;\dealcoloneq \left(\nabla u, \nabla v\right),\quad &amp;&amp;u,v\in V\\ b(u,\mu) &amp;\dealcoloneq \langle u,\mu\rangle,\quad &amp;&amp;u\in V,\quad\mu\in V&#39;. \end{align*}
</p>
<p> In other words, we can consider \(\lambda\) as the negative of the additional, positive force that the obstacle exerts on the membrane. The inequality in the second line of the statement above only appears to have the wrong sign because we have \(\mu-\lambda&lt;0\) at points where \(\lambda=0\), given the definition of \(K\).</p>
<p>The existence and uniqueness of \((u,\lambda)\in V\times K\) of this saddle point problem has been stated in Glowinski, Lions and Tr&eacute;moli&egrave;res: Numerical Analysis of Variational Inequalities, North-Holland, 1981.</p>
<p><a class="anchor" id="ActiveSetmethodstosolvethesaddlepointproblem"></a></p><h3>Active Set methods to solve the saddle point problem</h3>
<p>There are different methods to solve the variational inequality. As one possibility you can understand the saddle point problem as a convex quadratic program (QP) with inequality constraints.</p>
<p>To get there, let us assume that we discretize both \(u\) and \(\lambda\) with the same finite element space, for example the usual \(Q_k\) spaces. We would then get the equations </p><p class="formulaDsp">
\begin{eqnarray*} &amp;A U + B\Lambda = F,&amp;\\ &amp;[BU-G]_i \geq 0, \quad \Lambda_i \leq 0,\quad \Lambda_i[BU-G]_i = 0 \qquad \forall i.&amp; \end{eqnarray*}
</p>
<p> where \(B\) is the mass matrix on the chosen finite element space and the indices \(i\) above are for all degrees of freedom in the set \(\cal S\) of degrees of freedom located in the interior of the domain (we have Dirichlet conditions on the perimeter). However, we can make our life simpler if we use a particular quadrature rule when assembling all terms that yield this mass matrix, namely a quadrature formula where quadrature points are only located at the interpolation points at which shape functions are defined; since all but one shape function are zero at these locations, we get a diagonal mass matrix with </p><p class="formulaDsp">
\begin{align*} B_{ii} = \int_\Omega \varphi_i(\mathbf x)^2\ \textrm{d}x, \qquad B_{ij}=0 \ \text{for } i\neq j. \end{align*}
</p>
<p> To define \(G\) we use the same technique as for \(B\). In other words, we define </p><p class="formulaDsp">
\begin{align*} G_{i} = \int_\Omega g_h(x) \varphi_i(\mathbf x)\ \textrm{d}x, \end{align*}
</p>
<p> where \(g_h\) is a suitable approximation of \(g\). The integral in the definition of \(B_{ii}\) and \(G_i\) are then approximated by the trapezoidal rule. With this, the equations above can be restated as </p><p class="formulaDsp">
\begin{eqnarray*} &amp;A U + B\Lambda = F,&amp;\\ &amp;U_i-B_{ii}^{-1}G_i \ge 0, \quad \Lambda_i \leq 0,\quad \Lambda_i[U_i-B_{ii}^{-1}G_i] = 0 \qquad \forall i\in{\cal S}.&amp; \end{eqnarray*}
</p>
<p>Now we define for each degree of freedom \(i\) the function </p><p class="formulaDsp">
\begin{equation*} C([BU]_i,\Lambda_i) \dealcoloneq -\Lambda_i + \min\lbrace 0, \Lambda_i + c([BU]_i - G_i) \rbrace, \end{equation*}
</p>
<p> with some \(c&gt;0\). (In this program we choose \(c = 100\). It is a kind of a penalty parameter which depends on the problem itself and needs to be chosen large enough; for example there is no convergence for \(c = 1\) using the current program if we use 7 global refinements.)</p>
<p>After some head-scratching one can then convince oneself that the inequalities above can equivalently be rewritten as </p><p class="formulaDsp">
\begin{equation*} C([BU]_i,\Lambda_i) = 0, \qquad \forall i\in{\cal S}. \end{equation*}
</p>
<p> The primal-dual active set strategy we will use here is an iterative scheme which is based on this condition to predict the next active and inactive sets \(\mathcal{A}_k\) and \(\mathcal{F}_k\) (that is, those complementary sets of indices \(i\) for which \(U_i\) is either equal to or not equal to the value of the obstacle \(B^{-1}G\)). For a more in depth treatment of this approach, see Hintermueller, Ito, Kunisch: The primal-dual active set strategy as a semismooth newton method, SIAM J. OPTIM., 2003, Vol. 13, No. 3, pp. 865-888.</p>
<p><a class="anchor" id="Theprimaldualactivesetalgorithm"></a></p><h3>The primal-dual active set algorithm</h3>
<p>The algorithm for the primal-dual active set method works as follows (NOTE: \(B = B^T\)):</p>
<ol type="1">
<li>Initialize \(\mathcal{A}_k\) and \(\mathcal{F}_k\), such that \(\mathcal{S}=\mathcal{A}_k\cup\mathcal{F}_k\) and \(\mathcal{A}_k\cap\mathcal{F}_k=\emptyset\) and set \(k=1\).</li>
<li>Find the primal-dual pair \((U^k,\Lambda^k)\) that satisfies <p class="formulaDsp">
\begin{align*} AU^k + B\Lambda^k &amp;= F,\\ [BU^k]_i &amp;= G_i\quad&amp;&amp;\forall i\in\mathcal{A}_k,\\ \Lambda_i^k &amp;= 0\quad&amp;&amp;\forall i\in\mathcal{F}_k. \end{align*}
</p>
 Note that the second and third conditions imply that exactly \(|S|\) unknowns are fixed, with the first condition yielding the remaining \(|S|\) equations necessary to determine both \(U\) and \(\Lambda\).</li>
<li>Define the new active and inactive sets by <p class="formulaDsp">
\begin{equation*} \begin{split} \mathcal{A}_{k+1} \dealcoloneq \lbrace i\in\mathcal{S}:\Lambda^k_i + c([BU^k]_i - G_i)&lt; 0\rbrace,\\ \mathcal{F}_{k+1} \dealcoloneq \lbrace i\in\mathcal{S}:\Lambda^k_i + c([BU^k]_i - G_i)\geq 0\rbrace. \end{split} \end{equation*}
</p>
</li>
<li>If \(\mathcal{A}_{k+1}=\mathcal{A}_k\) (and then, obviously, also \(\mathcal{F}_{k+1}=\mathcal{F}_k\)) then stop, else set \(k=k+1\) and go to step (2).</li>
</ol>
<p>The method is called "primal-dual" because it uses both primal (the displacement \(U\)) as well as dual variables (the Lagrange multiplier \(\Lambda\)) to determine the next active set.</p>
<p>At the end of this section, let us add two observations. First, for any primal-dual pair \((U^k,\Lambda^k)\) that satisfies these condition, we can distinguish the following cases:</p>
<ol type="1">
<li>\(\Lambda^k_i + c([BU^k]_i - G_i) &lt; 0\) (i active): <br  />
 Then either \([BU^k]_i&lt;G_i\) and \(\Lambda^k_i=0\) (penetration) or \(\Lambda^k_i&lt;0\) and \([BU^k]_i=G_i\) (pressing load).</li>
<li>\(\Lambda^k_i + c([BU^k]_i - G_i)\geq 0\) (i inactive): <br  />
 Then either \([BU^k]_i\geq G_i\) and \(\Lambda^k_i=0\) (no contact) or \(\Lambda^k_i\geq0\) and \([BU^k]_i=G_i\) (unpressing load).</li>
</ol>
<p>Second, the method above appears intuitively correct and useful but a bit ad hoc. However, it can be derived in a concisely in the following way. To this end, note that we'd like to solve the nonlinear system </p><p class="formulaDsp">
\begin{eqnarray*} &amp;A U + B\Lambda = F,&amp;\\ &amp;C([BU-G]_i, \Lambda_i) = 0, \qquad \forall i.&amp; \end{eqnarray*}
</p>
<p> We can iteratively solve this by always linearizing around the previous iterate (i.e., applying a Newton method), but for this we need to linearize the function \(C(\cdot,\cdot)\) that is not differentiable. That said, it is slantly differentiable, and in fact we have </p><p class="formulaDsp">
\begin{equation*} \dfrac{\partial}{\partial U^k_i}C([BU^k]_i,\Lambda^k_i) = \begin{cases} cB_{ii},&amp; \text{if}\ \Lambda^k_i + c([BU^k]_i - G_i)&lt; 0\\ 0,&amp; \text{if}\ \Lambda^k_i + c([BU^k]_i - G_i)\geq 0. \end{cases} \end{equation*}
</p>
 <p class="formulaDsp">
\begin{equation*} \dfrac{\partial}{\partial\Lambda^k_i}C([BU^k]_i,\Lambda^k_i) = \begin{cases} 0,&amp; \text{if}\ \Lambda^k_i + c([BU^k]_i - G_i)&lt; 0\\ -1,&amp; \text{if}\ \Lambda^k_i + c([BU^k]_i - G_i)\geq 0. \end{cases} \end{equation*}
</p>
<p> This suggest a semismooth Newton step of the form </p><p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; A_{\mathcal{F}_k\mathcal{A}_k} &amp; B_{\mathcal{F}_k} &amp; 0\\ A_{\mathcal{A}_k\mathcal{F}_k} &amp; A_{\mathcal{A}_k\mathcal{A}_k} &amp; 0 &amp; B_{\mathcal{A}_k}\\ 0 &amp; 0 &amp; -Id_{\mathcal{F}_k} &amp; 0\\ 0 &amp; cB_{\mathcal{A}_k} &amp; 0 &amp; 0 \end{pmatrix} \begin{pmatrix} \delta U^k_{\mathcal{F}_k}\\ \delta U^k_{\mathcal{A}_k}\\ \delta \Lambda^k_{\mathcal{F}_k}\\ \delta \Lambda^k_{\mathcal{A}_k} \end{pmatrix} = -\begin{pmatrix} (AU^k + \Lambda^k - F)_{\mathcal{F}_k}\\ (AU^k + \Lambda^k - F)_{\mathcal{A}_k}\\ -\Lambda^k_{\mathcal{F}_k}\\ c(B_{\mathcal{A}_k} U^k - G)_{\mathcal{A}_k} \end{pmatrix}, \end{equation*}
</p>
<p> where we have split matrices \(A,B\) as well as vectors in the natural way into rows and columns whose indices belong to either the active set \({\mathcal{A}_k}\) or the inactive set \({\mathcal{F}_k}\).</p>
<p>Rather than solving for updates \(\delta U, \delta \Lambda\), we can also solve for the variables we are interested in right away by setting \(\delta U^k \dealcoloneq U^{k+1} - U^k\) and \(\delta \Lambda^k \dealcoloneq \Lambda^{k+1} - \Lambda^k\) and bringing all known terms to the right hand side. This yields </p><p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; A_{\mathcal{F}_k\mathcal{A}_k} &amp; B_{\mathcal{F}_k} &amp; 0\\ A_{\mathcal{A}_k\mathcal{F}_k} &amp; A_{\mathcal{A}_k\mathcal{A}_k} &amp; 0 &amp; B_{\mathcal{A}_k}\\ 0 &amp; 0 &amp; Id_{\mathcal{F}_k} &amp; 0\\ 0 &amp; B_{\mathcal{A}_k} &amp; 0 &amp; 0 \end{pmatrix} \begin{pmatrix} U^k_{\mathcal{F}_k}\\ U^k_{\mathcal{A}_k}\\ \Lambda^k_{\mathcal{F}_k}\\ \Lambda^k_{\mathcal{A}_k} \end{pmatrix} = \begin{pmatrix} F_{\mathcal{F}_k}\\ F_{\mathcal{A}_k}\\ 0\\ G_{\mathcal{A}_k} \end{pmatrix}. \end{equation*}
</p>
<p> These are the equations outlined above in the description of the basic algorithm.</p>
<p>We could even drive this a bit further. It's easy to see that we can eliminate the third row and the third column because it implies \(\Lambda_{\mathcal{F}_k} = 0\): </p><p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; A_{\mathcal{F}_k\mathcal{A}_k} &amp; 0\\ A_{\mathcal{A}_k\mathcal{F}_k} &amp; A_{\mathcal{A}_k\mathcal{A}_k} &amp; B_{\mathcal{A}_k}\\ 0 &amp; B_{\mathcal{A}_k} &amp; 0 \end{pmatrix} \begin{pmatrix} U^k_{\mathcal{F}_k}\\ U^k_{\mathcal{A}_k}\\ \Lambda^k_{\mathcal{A}_k} \end{pmatrix} = \begin{pmatrix} F_{\mathcal{F}_k}\\ F_{\mathcal{A}_k}\\ G_{\mathcal{A}_k} \end{pmatrix}. \end{equation*}
</p>
<p> This shows that one in fact only needs to solve for the Lagrange multipliers located on the active set. By considering the second row one would then recover the full Lagrange multiplier vector through </p><p class="formulaDsp">
\begin{equation*} \Lambda^k_S = B^{-1}\left(f_{\mathcal{S}} - A_{\mathcal{S}}U^k_{\mathcal{S}}\right). \end{equation*}
</p>
<p> Because of the third row and the fact that \(B_{\mathcal{A}_k}\) is a diagonal matrix we are able to calculate \(U^k_{\mathcal{A}_k}=B^{-1}_{\mathcal{A}_k}G_{\mathcal{A}_k}\) directly. We can therefore also write the linear system as follows: </p><p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; 0\\ 0 &amp; Id_{\mathcal{A}_k} \\ \end{pmatrix} \begin{pmatrix} U^k_{\mathcal{F}_k}\\ U^k_{\mathcal{A}_k} \end{pmatrix} = \begin{pmatrix} F_{\mathcal{F}_k} - A_{\mathcal{F}_k\mathcal{A}_k}B^{-1}_{\mathcal{A}_k}G_{\mathcal{A}_k} \\ B_{\mathcal{A}_k}^{-1}G_{\mathcal{A}_k} \end{pmatrix}. \end{equation*}
</p>
<p> Fortunately, this form is easy to arrive at: we simply build the usual Laplace linear system </p><p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; A_{\mathcal{F}_k\mathcal{A}_k} \\ A_{\mathcal{A}_k\mathcal{F}_k} &amp; A_{\mathcal{A}_k\mathcal{A}_k} \end{pmatrix} \begin{pmatrix} U^k_{\mathcal{F}_k}\\ U^k_{\mathcal{A}_k} \end{pmatrix} = \begin{pmatrix} F_{\mathcal{F}_k}\\ F_{\mathcal{A}_k} \end{pmatrix}, \end{equation*}
</p>
<p> and then let the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class eliminate all constrained degrees of freedom, namely \(U^k_{\mathcal{A}_k}=B^{-1}_{\mathcal{A}_k}G_{\mathcal{A}_k}\), in the same way as if the dofs in \(\mathcal{A}_k\) were Dirichlet data. The result linear system (the second to last one above) is symmetric and positive definite and we solve it with a CG-method and the AMG preconditioner from Trilinos.</p>
<p><a class="anchor" id="Implementation"></a></p><h3>Implementation</h3>
<p>This tutorial is quite similar to <a class="el" href="step_4.html">step-4</a>. The general structure of the program follows <a class="el" href="step_4.html">step-4</a> with minor differences:</p><ul>
<li>We need two new methods, <code>assemble_mass_matrix_diagonal</code> and <code>update_solution_and_constraints</code>.</li>
<li>We need new member variables that denote the constraints we have here.</li>
<li>We change the preconditioner for the solver.</li>
</ul>
<p>You may want to read up on <a class="el" href="step_4.html">step-4</a> if you want to understand the current program.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>As usual, at the beginning we include all the header files we need in here. With the exception of the various files that provide interfaces to the Trilinos library, there are no surprises:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep41.html">Step41</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeObstacleProblemcodeclasstemplate"></a> </p><h3>The <code>ObstacleProblem</code> class template</h3>
<p>This class supplies all function and variables needed to describe the obstacle problem. It is close to what we had to do in <a class="el" href="step_4.html">step-4</a>, and so relatively simple. The only real new components are the update_solution_and_constraints function that computes the active set and a number of variables that are necessary to describe the original (unconstrained) form of the linear system (<code>complete_system_matrix</code> and <code>complete_system_rhs</code>) as well as the active set itself and the diagonal of the mass matrix \(B\) used in scaling Lagrange multipliers in the active set formulation. The rest is as in <a class="el" href="step_4.html">step-4</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>ObstacleProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  ObstacleProblem();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">  <span class="keywordtype">void</span> setup_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">       assemble_mass_matrix_diagonal(<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> &amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">  <span class="keywordtype">void</span> update_solution_and_constraints();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a>                  active_set;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> system_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> complete_system_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> system_rhs;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> complete_system_rhs;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> diagonal_of_mass_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> contact_force;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="Righthandsideboundaryvaluesandtheobstacle"></a> </p><h3>Right hand side, boundary values, and the obstacle</h3>
<p>In the following, we define classes that describe the right hand side function, the Dirichlet boundary values, and the height of the obstacle as a function of \(\mathbf x\). In all three cases, we derive these classes from <a class="el" href="classFunction.html">Function</a>&lt;dim&gt;, although in the case of <code><a class="el" href="classRightHandSide.html">RightHandSide</a></code> and <code>Obstacle</code> this is more out of convention than necessity since we never pass such objects to the library. In any case, the definition of the right hand side and boundary values classes is obvious given our choice of \(f=-10\), \(u|_{\partial\Omega}=0\):</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span><a class="code" href="classRightHandSide.html">RightHandSide</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">    <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> -10;</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span><a class="code" href="classBoundaryValues.html">BoundaryValues</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">    <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line">};</div>
</div><!-- fragment --><p>We describe the obstacle function by a cascaded barrier (think: stair steps):</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>Obstacle : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, 1));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; -0.5)</div>
<div class="line">      <span class="keywordflow">return</span> -0.2;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &gt;= -0.5 &amp;&amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; 0.0)</div>
<div class="line">      <span class="keywordflow">return</span> -0.4;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &gt;= 0.0 &amp;&amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; 0.5)</div>
<div class="line">      <span class="keywordflow">return</span> -0.6;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      <span class="keywordflow">return</span> -0.8;</div>
<div class="line">  }</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="ImplementationofthecodeObstacleProblemcodeclass"></a> </p><h3>Implementation of the <code>ObstacleProblem</code> class</h3>
<p><a class="anchor" id="ObstacleProblemObstacleProblem"></a> </p><h4>ObstacleProblem::ObstacleProblem</h4>
<p>To everyone who has taken a look at the first few tutorial programs, the constructor is completely obvious:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">ObstacleProblem&lt;dim&gt;::ObstacleProblem()</div>
<div class="line">  : <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(1)</div>
<div class="line">  , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemmake_grid"></a> </p><h4>ObstacleProblem::make_grid</h4>
<p>We solve our obstacle problem on the square \([-1,1]\times [-1,1]\) in 2D. This function therefore just sets up one of the simplest possible meshes.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">ObstacleProblem&lt;dim&gt;::make_grid</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, -1, 1);</div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(7);</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">            &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;Total number of cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_cells()</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemsetup_system"></a> </p><h4>ObstacleProblem::setup_system</h4>
<p>In this first function of note, we set up the degrees of freedom handler, resize vectors and matrices, and deal with the constraints. Initially, the constraints are, of course, only given by boundary values, so we interpolate them towards the top of the function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::setup_system()</div>
<div class="line">{</div>
<div class="line">  dof_handler.distribute_dofs(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">  active_set.set_size(dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">            &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           0,</div>
<div class="line">                                           <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.n_dofs());</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  system_matrix.reinit(dsp);</div>
<div class="line">  complete_system_matrix.reinit(dsp);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> solution_index_set = dof_handler.locally_owned_dofs();</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">  system_rhs.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">  complete_system_rhs.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">  contact_force.reinit(solution_index_set, MPI_COMM_WORLD);</div>
</div><!-- fragment --><p>The only other thing to do here is to compute the factors in the \(B\) matrix which is used to scale the residual. As discussed in the introduction, we'll use a little trick to make this mass matrix diagonal, and in the following then first compute all of this as a matrix and then extract the diagonal elements for later use:</p>
<div class="fragment"><div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div>
<div class="line">  <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.reinit(dsp);</div>
<div class="line">  assemble_mass_matrix_diagonal(<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">  diagonal_of_mass_matrix.reinit(solution_index_set);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.size(); <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>++)</div>
<div class="line">    diagonal_of_mass_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.diag_element(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemassemble_system"></a> </p><h4>ObstacleProblem::assemble_system</h4>
<p>This function at once assembles the system matrix and right-hand-side and applied the constraints (both due to the active set as well as from boundary values) to our system. Otherwise, it is functionally equivalent to the corresponding function in, for example, <a class="el" href="step_4.html">step-4</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::assemble_system()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  system_matrix = 0;</div>
<div class="line">  system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <a class="code" href="classRightHandSide.html">RightHandSide&lt;dim&gt;</a> <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line">      cell_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">                 fe_values.shape_grad(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point) * fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">            cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">              (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">               <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>.value(fe_values.quadrature_point(q_point)) *</div>
<div class="line">               fe_values.JxW(q_point));</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                             cell_rhs,</div>
<div class="line">                                             <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                             system_matrix,</div>
<div class="line">                                             system_rhs,</div>
<div class="line">                                             <span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemassemble_mass_matrix_diagonal"></a> </p><h4>ObstacleProblem::assemble_mass_matrix_diagonal</h4>
<p>The next function is used in the computation of the diagonal mass matrix \(B\) used to scale variables in the active set method. As discussed in the introduction, we get the mass matrix to be diagonal by choosing the trapezoidal rule for quadrature. Doing so we don't really need the triple loop over quadrature points, indices \(i\) and indices \(j\) any more and can, instead, just use a double loop. The rest of the function is obvious given what we have discussed in many of the previous tutorial programs.</p>
<p>Note that at the time this function is called, the constraints object only contains boundary value constraints; we therefore do not have to pay attention in the last copy-local-to-global step to preserve the values of matrix entries that may later on be constrained by the active set.</p>
<p>Note also that the trick with the trapezoidal rule only works if we have in fact \(Q_1\) elements. For higher order elements, one would need to use a quadrature formula that has quadrature points at all the support points of the finite element. Constructing such a quadrature formula isn't really difficult, but not the point here, and so we simply assert at the top of the function that our implicit assumption about the finite element is in fact satisfied.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::assemble_mass_matrix_diagonal(</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> &amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;dim&gt;</a> quadrature_formula;</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">            (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">             fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) * fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                             <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                             <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemupdate_solution_and_constraints"></a> </p><h4>ObstacleProblem::update_solution_and_constraints</h4>
<p>In a sense, this is the central function of this program. It updates the active set of constrained degrees of freedom as discussed in the introduction and computes an <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object from it that can then be used to eliminate constrained degrees of freedom from the solution of the next iteration. At the same time we set the constrained degrees of freedom of the solution to the correct value, namely the height of the obstacle.</p>
<p>Fundamentally, the function is rather simple: We have to loop over all degrees of freedom and check the sign of the function \(\Lambda^k_i + c([BU^k]_i - G_i) = \Lambda^k_i + cB_i(U^k_i - [g_h]_i)\) because in our case \(G_i = B_i[g_h]_i\). To this end, we use the formula given in the introduction by which we can compute the Lagrange multiplier as the residual of the original linear system (given via the variables <code>complete_system_matrix</code> and <code>complete_system_rhs</code>. At the top of this function, we compute this residual using a function that is part of the matrix classes.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::update_solution_and_constraints()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Updating active set...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> penalty_parameter = 100.0;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(</div>
<div class="line">    <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(dof_handler.n_dofs()));</div>
<div class="line">  complete_system_matrix.residual(<a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, complete_system_rhs);</div>
</div><!-- fragment --><p>compute contact_force[i] = - lambda[i] * diagonal_of_mass_matrix[i]</p>
<div class="fragment"><div class="line">contact_force = <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>;</div>
<div class="line">contact_force.scale(diagonal_of_mass_matrix);</div>
<div class="line">contact_force *= -1;</div>
</div><!-- fragment --><p>The next step is to reset the active set and constraints objects and to start the loop over all degrees of freedom. This is made slightly more complicated by the fact that we can't just loop over all elements of the solution vector since there is no way for us then to find out what location a DoF is associated with; however, we need this location to test whether the displacement of a DoF is larger or smaller than the height of the obstacle at this location.</p>
<p>We work around this by looping over all cells and DoFs defined on each of these cells. We use here that the displacement is described using a \(Q_1\) function for which degrees of freedom are always located on the vertices of the cell; thus, we can get the index of each degree of freedom and its location by asking the vertex for this information. On the other hand, this clearly wouldn't work for higher order elements, and so we add an assertion that makes sure that we only deal with elements for which all degrees of freedom are located in vertices to avoid tripping ourselves with non-functional code in case someone wants to play with increasing the polynomial degree of the solution.</p>
<p>The price to pay for having to loop over cells rather than DoFs is that we may encounter some degrees of freedom more than once, namely each time we visit one of the cells adjacent to a given vertex. We will therefore have to keep track which vertices we have already touched and which we haven't so far. We do so by using an array of flags <code>dof_touched</code>:</p>
<div class="fragment"><div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">active_set.clear();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> Obstacle&lt;dim&gt; obstacle;</div>
<div class="line"><a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;bool&gt;</a>   dof_touched(dof_handler.n_dofs(), <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_indices())</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dof_handler.get_fe().n_dofs_per_cell() == <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;n_vertices(),</div>
<div class="line">             <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dof_index = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(<a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a>, 0);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (dof_touched[dof_index] == <span class="keyword">false</span>)</div>
<div class="line">        dof_touched[dof_index] = <span class="keyword">true</span>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">continue</span>;</div>
</div><!-- fragment --><p>Now that we know that we haven't touched this DoF yet, let's get the value of the displacement function there as well as the value of the obstacle function and use this to decide whether the current DoF belongs to the active set. For that we use the function given above and in the introduction.</p>
<p>If we decide that the DoF should be part of the active set, we add its index to the active set, introduce an inhomogeneous equality constraint in the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object, and reset the solution value to the height of the obstacle. Finally, the residual of the non-contact part of the system serves as an additional control (the residual equals the remaining, unaccounted forces, and should be zero outside the contact zone), so we zero out the components of the residual vector (i.e., the Lagrange multiplier lambda) that correspond to the area where the body is in contact; at the end of the loop over all cells, the residual will therefore only consist of the residual in the non-contact zone. We output the norm of this residual along with the size of the active set after the loop.</p>
<div class="fragment"><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> obstacle_value = obstacle.value(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(<a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a>));</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> solution_value = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(dof_index);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(dof_index) + penalty_parameter *</div>
<div class="line">                                diagonal_of_mass_matrix(dof_index) *</div>
<div class="line">                                (solution_value - obstacle_value) &lt;</div>
<div class="line">          0)</div>
<div class="line">        {</div>
<div class="line">          active_set.add_index(dof_index);</div>
<div class="line">          <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">add_line</a>(dof_index);</div>
<div class="line">          <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">set_inhomogeneity</a>(dof_index, obstacle_value);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(dof_index) = obstacle_value;</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(dof_index) = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;      Size of active set: &quot;</span> &lt;&lt; active_set.n_elements()</div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;   Residual of the non-contact part of the system: &quot;</span></div>
<div class="line">          &lt;&lt; <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.l2_norm() &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>In a final step, we add to the set of constraints on DoFs we have so far from the active set those that result from Dirichlet boundary values, and close the constraints object:</p>
<div class="fragment"><div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           0,</div>
<div class="line">                                           <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemsolve"></a> </p><h4>ObstacleProblem::solve</h4>
<p>There is nothing to say really about the solve function. In the context of a Newton method, we are not typically interested in very high accuracy (why ask for a highly accurate solution of a linear problem that we know only gives us an approximation of the solution of the nonlinear problem), and so we use the <a class="el" href="classReductionControl.html">ReductionControl</a> class that stops iterations when either an absolute tolerance is reached (for which we choose \(10^{-12}\)) or when the residual is reduced by a certain factor (here, \(10^{-3}\)).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">ObstacleProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classReductionControl.html">ReductionControl</a>                        reduction_control(100, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3);</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(reduction_control);</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a>       precondition;</div>
<div class="line">  precondition.<a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">initialize</a>(system_matrix);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs, precondition);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;      Error: &quot;</span> &lt;&lt; reduction_control.initial_value() &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span></div>
<div class="line">            &lt;&lt; reduction_control.last_value() &lt;&lt; <span class="stringliteral">&quot; in &quot;</span></div>
<div class="line">            &lt;&lt; reduction_control.last_step() &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span></div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemoutput_results"></a> </p><h4>ObstacleProblem::output_results</h4>
<p>We use the vtk-format for the output. The file contains the displacement and a numerical representation of the active set.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Writing graphical output...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> active_set_vector(</div>
<div class="line">    dof_handler.locally_owned_dofs(), MPI_COMM_WORLD);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a> : active_set)</div>
<div class="line">    active_set_vector[<a class="code" href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a>] = 1.;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, <span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(active_set_vector, <span class="stringliteral">&quot;active_set&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(contact_force, <span class="stringliteral">&quot;lambda&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  std::ofstream output_vtk(<span class="stringliteral">&quot;output_&quot;</span> +</div>
<div class="line">                           <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>, 3) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output_vtk);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemrun"></a> </p><h4>ObstacleProblem::run</h4>
<p>This is the function which has the top-level control over everything. It is not very long, and in fact rather straightforward: in every iteration of the active set method, we assemble the linear system, solve it, update the active set and project the solution back to the feasible set, and then output the results. The iteration is terminated whenever the active set has not changed in the previous iteration.</p>
<p>The only trickier part is that we have to save the linear system (i.e., the matrix and right hand side) after assembling it in the first iteration. The reason is that this is the only step where we can access the linear system as built without any of the contact constraints active. We need this to compute the residual of the solution at other iterations, but in other iterations that linear system we form has the rows and columns that correspond to constrained degrees of freedom eliminated, and so we can no longer access the full residual of the original equation.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">ObstacleProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">    setup_system();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> active_set_old(active_set);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> = 0; <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> &lt;= <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.size(); ++<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Newton iteration &quot;</span> &lt;&lt; <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> == 0)</div>
<div class="line">          {</div>
<div class="line">            complete_system_matrix.copy_from(system_matrix);</div>
<div class="line">            complete_system_rhs = system_rhs;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">        update_solution_and_constraints();</div>
<div class="line">        output_results(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (active_set == active_set_old)</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        active_set_old = active_set;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step41</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>And this is the main function. It follows the pattern of all other main functions. The call to initialize MPI exists because the Trilinos library upon which we build our linear solvers in this program requires it.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep41.html">Step41</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
</div><!-- fragment --><p>This program can only be run in serial. Otherwise, throw an exception.</p>
<div class="fragment"><div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-41&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      ObstacleProblem&lt;2&gt; obstacle_problem;</div>
<div class="line">      obstacle_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>Running the program produces output like this: </p><div class="fragment"><div class="line"><a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 16384</div>
<div class="line">Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 21845</div>
<div class="line"><a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 16641</div>
<div class="line"> </div>
<div class="line"><a class="code" href="newton__0_8txt.html#a7ae4bec25ec0fbd4c3968d0926b5c7c6">Newton</a> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> 0</div>
<div class="line">   Assembling <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">   Solving <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">      Error: 0.310059 -&gt; 5.16619e-05 <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> 5 CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a>.</div>
<div class="line">   Updating <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>...</div>
<div class="line">      Size <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>: 13164</div>
<div class="line">   Residual <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> non-contact <a class="code" href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>: 1.61863e-05</div>
<div class="line">   Writing graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>...</div>
<div class="line"> </div>
<div class="line">Newton <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> 1</div>
<div class="line">   Assembling <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">   Solving <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">      Error: 1.11987 -&gt; 0.00109377 <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> 6 CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a>.</div>
<div class="line">   Updating <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>...</div>
<div class="line">      Size <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>: 12363</div>
<div class="line">   Residual <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> non-contact <a class="code" href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>: 3.9373</div>
<div class="line">   Writing graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>...</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"><a class="code" href="newton__0_8txt.html#a7ae4bec25ec0fbd4c3968d0926b5c7c6">Newton</a> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> 17</div>
<div class="line">   Assembling <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">   Solving <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">      Error: 0.00713308 -&gt; 2.29249e-06 <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> 4 CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a>.</div>
<div class="line">   Updating <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>...</div>
<div class="line">      Size <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>: 5399</div>
<div class="line">   Residual <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> non-contact <a class="code" href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>: 0.000957525</div>
<div class="line">   Writing graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>...</div>
<div class="line"> </div>
<div class="line">Newton <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> 18</div>
<div class="line">   Assembling <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">   Solving <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">      Error: 0.000957525 -&gt; 2.8033e-07 <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> 4 CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a>.</div>
<div class="line">   Updating <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>...</div>
<div class="line">      Size <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>: 5399</div>
<div class="line">   Residual <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> non-contact <a class="code" href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>: 2.8033e-07</div>
<div class="line">   Writing graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>...</div>
</div><!-- fragment --><p>The iterations end once the active set doesn't change any more (it has 5,399 constrained degrees of freedom at that point). The algebraic precondition is apparently working nicely since we only need 4-6 CG iterations to solve the linear system (although this also has a lot to do with the fact that we are not asking for very high accuracy of the linear solver).</p>
<p>More revealing is to look at a sequence of graphical output files (every third step is shown, with the number of the iteration in the leftmost column):</p>
<table align="center">
<tr>
<td valign="top">0 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.00.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.00.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.00.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">3 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.03.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.03.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.03.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">6 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.06.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.06.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.06.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">9 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.09.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.09.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.09.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">12 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.12.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.12.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.12.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">15 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.15.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.15.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.15.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">18 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.18.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.18.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.18.png" alt="" class="inline"/>   </td></tr>
</table>
<p>The pictures show that in the first step, the solution (which has been computed without any of the constraints active) bends through so much that pretty much every interior point has to be bounced back to the stairstep function, producing a discontinuous solution. Over the course of the active set iterations, this unphysical membrane shape is smoothed out, the contact with the lower-most stair step disappears, and the solution stabilizes.</p>
<p>In addition to this, the program also outputs the values of the Lagrange multipliers. Remember that these are the contact forces and so should only be positive on the contact set, and zero outside. If, on the other hand, a Lagrange multiplier is negative in the active set, then this degree of freedom must be removed from the active set. The following pictures show the multipliers in iterations 1, 9 and 18, where we use red and browns to indicate positive values, and blue for negative values.</p>
<table align="center">
<tr>
<td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.forces.01.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.forces.09.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.forces.18.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center">Iteration 1  </td><td align="center">Iteration 9  </td><td align="center">Iteration 18   </td></tr>
</table>
<p>It is easy to see that the positive values converge nicely to moderate values in the interior of the contact set and large upward forces at the edges of the steps, as one would expect (to support the large curvature of the membrane there); at the fringes of the active set, multipliers are initially negative, causing the set to shrink until, in iteration 18, there are no more negative multipliers and the algorithm has converged.</p>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p>As with any of the programs of this tutorial, there are a number of obvious possibilities for extensions and experiments. The first one is clear: introduce adaptivity. Contact problems are prime candidates for adaptive meshes because the solution has lines along which it is less regular (the places where contact is established between membrane and obstacle) and other areas where the solution is very smooth (or, in the present context, constant wherever it is in contact with the obstacle). Adding this to the current program should not pose too many difficulties, but it is not trivial to find a good error estimator for that purpose.</p>
<p>A more challenging task would be an extension to 3d. The problem here is not so much to simply make everything run in 3d. Rather, it is that when a 3d body is deformed and gets into contact with an obstacle, then the obstacle does not act as a constraining body force within the domain as is the case here. Rather, the contact force only acts on the boundary of the object. The inequality then is not in the differential equation but in fact in the (Neumann-type) boundary conditions, though this leads to a similar kind of variational inequality. Mathematically, this means that the Lagrange multiplier only lives on the surface, though it can of course be extended by zero into the domain if that is convenient. As in the current program, one does not need to form and store this Lagrange multiplier explicitly.</p>
<p>A further interesting problem for the 3d case is to consider contact problems with friction. In almost every mechanical process friction has a big influence. For the modelling we have to take into account tangential stresses at the contact surface. Also we have to observe that friction adds another nonlinearity to our problem.</p>
<p>Another nontrivial modification is to implement a more complex constitutive law like nonlinear elasticity or elasto-plastic material behavior. The difficulty here is to handle the additional nonlinearity arising through the nonlinear constitutive law.</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2011 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Joerg Frohne, Texas A&amp;M University and</span></div>
<div class="line"><span class="comment"> *                        University of Siegen, 2011, 2012</span></div>
<div class="line"><span class="comment"> *          Wolfgang Bangerth, Texas A&amp;M University, 2012</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep41.html">Step41</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>ObstacleProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    ObstacleProblem();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">    <span class="keywordtype">void</span> setup_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">    <span class="keywordtype">void</span></div>
<div class="line">         assemble_mass_matrix_diagonal(<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> &amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">    <span class="keywordtype">void</span> update_solution_and_constraints();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a>                  active_set;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> system_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> complete_system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> system_rhs;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> complete_system_rhs;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> diagonal_of_mass_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> contact_force;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classRightHandSide.html">RightHandSide</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">      <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> -10;</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classBoundaryValues.html">BoundaryValues</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">      <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>Obstacle : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, 1));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; -0.5)</div>
<div class="line">        <span class="keywordflow">return</span> -0.2;</div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &gt;= -0.5 &amp;&amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; 0.0)</div>
<div class="line">        <span class="keywordflow">return</span> -0.4;</div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &gt;= 0.0 &amp;&amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; 0.5)</div>
<div class="line">        <span class="keywordflow">return</span> -0.6;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> -0.8;</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classStep41_1_1ObstacleProblem.html#aa3ecce2b0c00868c513eef0f9ab38509">ObstacleProblem&lt;dim&gt;::ObstacleProblem</a>()</div>
<div class="line">    : <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(1)</div>
<div class="line">    , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">ObstacleProblem&lt;dim&gt;::make_grid</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, -1, 1);</div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(7);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Total number of cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_cells()</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::setup_system()</div>
<div class="line">  {</div>
<div class="line">    dof_handler.distribute_dofs(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">    active_set.set_size(dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             0,</div>
<div class="line">                                             <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.n_dofs());</div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(dsp);</div>
<div class="line">    complete_system_matrix.reinit(dsp);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> solution_index_set = dof_handler.locally_owned_dofs();</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">    system_rhs.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">    complete_system_rhs.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">    contact_force.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div>
<div class="line">    <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.reinit(dsp);</div>
<div class="line">    assemble_mass_matrix_diagonal(<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">    diagonal_of_mass_matrix.reinit(solution_index_set);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.size(); <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>++)</div>
<div class="line">      diagonal_of_mass_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.diag_element(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::assemble_system()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    system_matrix = 0;</div>
<div class="line">    system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <a class="code" href="classRightHandSide.html">RightHandSide&lt;dim&gt;</a> <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line">        cell_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q_point)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">                   fe_values.shape_grad(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point) * fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">                 <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>.value(fe_values.quadrature_point(q_point)) *</div>
<div class="line">                 fe_values.JxW(q_point));</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                               cell_rhs,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               system_matrix,</div>
<div class="line">                                               system_rhs,</div>
<div class="line">                                               <span class="keyword">true</span>);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::assemble_mass_matrix_diagonal(</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> &amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;dim&gt;</a> quadrature_formula;</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q_point)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">              (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">               fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) * fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::update_solution_and_constraints()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Updating active set...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> penalty_parameter = 100.0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(</div>
<div class="line">      <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(dof_handler.n_dofs()));</div>
<div class="line">    complete_system_matrix.residual(lambda, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, complete_system_rhs);</div>
<div class="line"> </div>
<div class="line">    contact_force = <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>;</div>
<div class="line">    contact_force.scale(diagonal_of_mass_matrix);</div>
<div class="line">    contact_force *= -1;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">    active_set.clear();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> Obstacle&lt;dim&gt; obstacle;</div>
<div class="line">    <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;bool&gt;</a>   dof_touched(dof_handler.n_dofs(), <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_indices())</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dof_handler.get_fe().n_dofs_per_cell() == <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;n_vertices(),</div>
<div class="line">                 <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dof_index = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(<a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a>, 0);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> (dof_touched[dof_index] == <span class="keyword">false</span>)</div>
<div class="line">            dof_touched[dof_index] = <span class="keyword">true</span>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> obstacle_value = obstacle.value(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(<a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a>));</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> solution_value = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(dof_index);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(dof_index) + penalty_parameter *</div>
<div class="line">                                    diagonal_of_mass_matrix(dof_index) *</div>
<div class="line">                                    (solution_value - obstacle_value) &lt;</div>
<div class="line">              0)</div>
<div class="line">            {</div>
<div class="line">              active_set.add_index(dof_index);</div>
<div class="line">              <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">add_line</a>(dof_index);</div>
<div class="line">              <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">set_inhomogeneity</a>(dof_index, obstacle_value);</div>
<div class="line"> </div>
<div class="line">              <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(dof_index) = obstacle_value;</div>
<div class="line"> </div>
<div class="line">              <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(dof_index) = 0;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;      Size of active set: &quot;</span> &lt;&lt; active_set.n_elements()</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Residual of the non-contact part of the system: &quot;</span></div>
<div class="line">              &lt;&lt; <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.l2_norm() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             0,</div>
<div class="line">                                             <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">ObstacleProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classReductionControl.html">ReductionControl</a>                        reduction_control(100, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3);</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(reduction_control);</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a>       precondition;</div>
<div class="line">    precondition.<a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">initialize</a>(system_matrix);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs, precondition);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;      Error: &quot;</span> &lt;&lt; reduction_control.initial_value() &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span></div>
<div class="line">              &lt;&lt; reduction_control.last_value() &lt;&lt; <span class="stringliteral">&quot; in &quot;</span></div>
<div class="line">              &lt;&lt; reduction_control.last_step() &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Writing graphical output...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> active_set_vector(</div>
<div class="line">      dof_handler.locally_owned_dofs(), MPI_COMM_WORLD);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a> : active_set)</div>
<div class="line">      active_set_vector[<a class="code" href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a>] = 1.;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, <span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(active_set_vector, <span class="stringliteral">&quot;active_set&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(contact_force, <span class="stringliteral">&quot;lambda&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::ofstream output_vtk(<span class="stringliteral">&quot;output_&quot;</span> +</div>
<div class="line">                             <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>, 3) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output_vtk);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">ObstacleProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">    setup_system();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> active_set_old(active_set);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> = 0; <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> &lt;= <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.size(); ++<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Newton iteration &quot;</span> &lt;&lt; <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> == 0)</div>
<div class="line">          {</div>
<div class="line">            complete_system_matrix.copy_from(system_matrix);</div>
<div class="line">            complete_system_rhs = system_rhs;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">        update_solution_and_constraints();</div>
<div class="line">        output_results(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (active_set == active_set_old)</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        active_set_old = active_set;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step41</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep41.html">Step41</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-41&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      ObstacleProblem&lt;2&gt; obstacle_problem;</div>
<div class="line">      obstacle_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><br  />
 This tutorial depends on <a class="el" href="step_15.html">step-15</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Introduction">Introduction</a><a href="#Introduction">Introduction</a>
        <li><a href="#Classicalformulation">Classical formulation</a><a href="#Classicalformulation">Classical formulation</a>
        <li><a href="#Derivationofthevariationalinequality">Derivation of the variational inequality</a><a href="#Derivationofthevariationalinequality">Derivation of the variational inequality</a>
        <li><a href="#Formulationasasaddlepointproblem">Formulation as a saddle point problem</a><a href="#Formulationasasaddlepointproblem">Formulation as a saddle point problem</a>
        <li><a href="#ActiveSetmethodstosolvethesaddlepointproblem">Active Set methods to solve the saddle point problem</a><a href="#ActiveSetmethodstosolvethesaddlepointproblem">Active Set methods to solve the saddle point problem</a>
        <li><a href="#Theprimaldualactivesetalgorithm">The primal-dual active set algorithm</a><a href="#Theprimaldualactivesetalgorithm">The primal-dual active set algorithm</a>
        <li><a href="#Implementation">Implementation</a><a href="#Implementation">Implementation</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#ThecodeObstacleProblemcodeclasstemplate">The <code>ObstacleProblem</code> class template</a><a href="#ThecodeObstacleProblemcodeclasstemplate">The <code>ObstacleProblem</code> class template</a>
        <li><a href="#Righthandsideboundaryvaluesandtheobstacle">Right hand side, boundary values, and the obstacle</a><a href="#Righthandsideboundaryvaluesandtheobstacle">Right hand side, boundary values, and the obstacle</a>
        <li><a href="#ImplementationofthecodeObstacleProblemcodeclass">Implementation of the <code>ObstacleProblem</code> class</a><a href="#ImplementationofthecodeObstacleProblemcodeclass">Implementation of the <code>ObstacleProblem</code> class</a>
      <ul>
        <li><a href="#ObstacleProblemObstacleProblem">ObstacleProblem::ObstacleProblem</a><a href="#ObstacleProblemObstacleProblem">ObstacleProblem::ObstacleProblem</a>
        <li><a href="#ObstacleProblemmake_grid">ObstacleProblem::make_grid</a><a href="#ObstacleProblemmake_grid">ObstacleProblem::make_grid</a>
        <li><a href="#ObstacleProblemsetup_system">ObstacleProblem::setup_system</a><a href="#ObstacleProblemsetup_system">ObstacleProblem::setup_system</a>
        <li><a href="#ObstacleProblemassemble_system">ObstacleProblem::assemble_system</a><a href="#ObstacleProblemassemble_system">ObstacleProblem::assemble_system</a>
        <li><a href="#ObstacleProblemassemble_mass_matrix_diagonal">ObstacleProblem::assemble_mass_matrix_diagonal</a><a href="#ObstacleProblemassemble_mass_matrix_diagonal">ObstacleProblem::assemble_mass_matrix_diagonal</a>
        <li><a href="#ObstacleProblemupdate_solution_and_constraints">ObstacleProblem::update_solution_and_constraints</a><a href="#ObstacleProblemupdate_solution_and_constraints">ObstacleProblem::update_solution_and_constraints</a>
        <li><a href="#ObstacleProblemsolve">ObstacleProblem::solve</a><a href="#ObstacleProblemsolve">ObstacleProblem::solve</a>
        <li><a href="#ObstacleProblemoutput_results">ObstacleProblem::output_results</a><a href="#ObstacleProblemoutput_results">ObstacleProblem::output_results</a>
        <li><a href="#ObstacleProblemrun">ObstacleProblem::run</a><a href="#ObstacleProblemrun">ObstacleProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
 <br  />
 <em>This program was contributed by JÃ¶rg Frohne (University of Siegen, Germany) while on a long-term visit to Texas A&amp;M University. <br  />
 This material is based upon work partly supported by ThyssenKrupp Steel Europe. </em></p>
<p><a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a></p><h3>Introduction</h3>
<p>This example is based on the Laplace equation in 2d and deals with thequestion what happens if a membrane is deflected by some external force but isalso constrained by an obstacle. In other words, think of a elastic membraneclamped at the boundary to a rectangular frame (we choose \(\Omega = \left[-1,1\right]^2\) ) and that sags through due to gravity acting on it. Whathappens now if there is an obstacle under the membrane that prevents it fromreaching its equilibrium position if gravity was the only existing force? Inthe current example program, we will consider that under the membrane is astair step obstacle against which gravity pushes the membrane. This problem is typically called the "obstacle problem" (see also <a href="http://en.wikipedia.org/wiki/Obstacle_problem">this Wikipedia article</a>), and it results in avariational inequality, rather than a variational equation when put into theweak form. We will below derive it from the classical formulation, but before wego on to discuss the mathematics let us show how the solution of the problem wewill consider in this tutorial program looks to gain some intuition of whatwe should expect: </p><table align="center" class="tutorial" cellspacing="3" cellpadding="3">
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.png" alt="" class="inline"/>   </td></tr>
</table>
<p><br  />
 Here, at the left, we see the displacement of the membrane. The shapeof the obstacle underneath is clearly visible. On the right, we overlay whichparts of the membrane are in contact with the obstacle. We will later callthis set of points the "active set" to indicate that an inequality constraintis active there.</p>
<p><a class="anchor" id="Classicalformulation"></a></p><h3>Classical formulation</h3>
<p>The classical formulation of the problem possesses the following form: </p><p class="formulaDsp">
\begin{align*} -\textrm{div}\ \sigma &amp;\geq f &amp; &amp;\quad\text{in } \Omega,\\ \sigma &amp;= \nabla u &amp; &amp;\quad\text{in } \Omega,\\ u(\mathbf x) &amp;= 0 &amp; &amp;\quad\text{on }\partial\Omega,\\ (-\Delta u - f)(u - g) &amp;= 0 &amp; &amp;\quad\text{in } \Omega,\\ u(\mathbf x) &amp;\geq g(\mathbf x) &amp; &amp;\quad\text{in } \Omega \end{align*}
</p>
<p> with \(u\in H^2(\Omega)\) . \(u\) is a scalar valued function that denotes thevertical displacement of the membrane. The first equation is called equilibriumcondition with a force of areal density \(f\) . Here, we will consider this forceto be gravity. The second one is known as Hooke's Law that says that the stresses \(\sigma\) are proportional to the gradient of the displacements \(u\) (theproportionality constant, often denoted by \(E\) , has been set to one here,without loss of generality; if it is constant, it can be put into the righthand side function). At the boundary we have zero Dirichletconditions. Obviously, the first two equations can be combined to yield \(-\Delta u \ge f\) . Intuitively, gravity acts downward and so \(f(\mathbf x)\) is a negativefunction (we choose \(f=-10\) in this program). The first condition then meansthat the total force acting on the membrane is gravity plus somethingpositive: namely the upward force that the obstacle exerts on the membrane atthose places where the two of them are in contact. How big is this additionalforce? We don't know yet (and neither do we know "where" it actually acts) butit must be so that the membrane doesn't penetrate the obstacle. The fourth equality above together with the last inequality forms the obstaclecondition which has to hold at every point of the whole domain. The latter ofthese two means that the membrane must be above the obstacle \(g(\mathbf x)\) everywhere. The second to last equation, often called the "complementaritycondition" says that where the membrane is not in contact with the obstacle(i.e., those \(\mathbf x\) where \(u(\mathbf x) - g(\mathbf x) \neq 0\) ), then \(-\Delta u=f\) at these locations; in other words, no additional forces actthere, as expected. On the other hand, where \(u=g\) we can have \(-\Delta u-f \neq 0\) , i.e., there can be additional forces (though there don't have to be:it is possible for the membrane to just touch, not press against, theobstacle).</p>
<p><a class="anchor" id="Derivationofthevariationalinequality"></a></p><h3>Derivation of the variational inequality</h3>
<p>An obvious way to obtain the variational formulation of the obstacle problem is to consider the total potential energy: </p><p class="formulaDsp">
\begin{equation*} E(u) \dealcoloneq \dfrac{1}{2}\int\limits_{\Omega} \nabla u \cdot \nabla u - \int\limits_{\Omega} fu. \end{equation*}
</p>
<p> We have to find a solution \(u\in G\) of the following minimization problem: </p><p class="formulaDsp">
\begin{equation*} E(u)\leq E(v)\quad \forall v\in G, \end{equation*}
</p>
<p> with the convex set of admissible displacements: </p><p class="formulaDsp">
\begin{equation*} G \dealcoloneq \lbrace v\in V: v\geq g \text{ a.e. in } \Omega\rbrace,\quad V\dealcoloneq H^1_0(\Omega). \end{equation*}
</p>
<p> This set takes care of the third and fifth conditions above (the boundaryvalues and the complementarity condition). Consider now the minimizer \(u\in G\) of \(E\) and any other function \(v\in G\) . Then the function </p><p class="formulaDsp">
\begin{equation*} F(\varepsilon) \dealcoloneq E(u+\varepsilon(v-u)),\quad\varepsilon\in\left[0,1\right], \end{equation*}
</p>
<p> takes its minimum at \(\varepsilon = 0\) (because \(u\) is a minimizer of theenergy functional \(E(\cdot)\) ), so that \(F&#39;(0)\geq 0\) for any choiceof \(v\) . Note that \(u+\varepsilon(v-u) = (1-\varepsilon)u+\varepsilon v\in G\) because of theconvexity of \(G\) . If we compute \(F&#39;(\varepsilon)\vert_{\varepsilon=0}\) ityields the variational formulation we are searching for: <em>Find a function \(u\in G\) with</em> </p><p class="formulaDsp">
\begin{equation*} \left(\nabla u, \nabla(v-u)\right) \geq \left(f,v-u\right) \quad \forall v\in G. \end{equation*}
</p>
<p>This is the typical form of variational inequalities, where not just \(v\) appears in the bilinear form but in fact \(v-u\) . The reason is this: if \(u\) isnot constrained, then we can find test functions \(v\) in \(G\) so that \(v-u\) can haveany sign. By choosing test functions \(v_1,v_2\) so that \(v_1-u = -(v_2-u)\) itfollows that the inequality can only hold for both \(v_1\) and \(v_2\) if the twosides are in fact equal, i.e., we obtain a variational equality. On the other hand, if \(u=g\) then \(G\) only allows test functions \(v\) so that in fact \(v-u\ge 0\) . This means that we can't test the equation with both \(v-u\) and \(-(v-u)\) as above, and so we can no longer conclude that the two sides are infact equal. Thus, this mimics the way we have discussed the complementaritycondition above.</p>
<p><a class="anchor" id="Formulationasasaddlepointproblem"></a></p><h3>Formulation as a saddle point problem</h3>
<p>The variational inequality above is awkward to work with. We would thereforelike to reformulate it as an equivalent saddle point problem. We introduce aLagrange multiplier \(\lambda\) and the convex cone \(K\subset V&#39;\) , \(V&#39;\) dual space of \(V\) , \(K \dealcoloneq \{\mu\in V&#39;: \langle\mu,v\rangle\geq 0,\quad \forall v\in V, v \le 0 \}\) ofLagrange multipliers, where \(\langle\cdot,\cdot\rangle\) denotes the dualitypairing between \(V&#39;\) and \(V\) . Intuitively, \(K\) is the cone of all "non-positivefunctions", except that \(K\subset (H_0^1)&#39;\) and so contains other objectsbesides regular functions as well.This yields: <em>Find \(u\in V\) and \(\lambda\in K\) such that</em> </p><p class="formulaDsp">
\begin{align*} a(u,v) + b(v,\lambda) &amp;= f(v),\quad &amp;&amp;v\in V\\ b(u,\mu - \lambda) &amp;\leq \langle g,\mu - \lambda\rangle,\quad&amp;&amp;\mu\in K, \end{align*}
</p>
<p> <em>with</em> </p><p class="formulaDsp">
\begin{align*} a(u,v) &amp;\dealcoloneq \left(\nabla u, \nabla v\right),\quad &amp;&amp;u,v\in V\\ b(u,\mu) &amp;\dealcoloneq \langle u,\mu\rangle,\quad &amp;&amp;u\in V,\quad\mu\in V&#39;. \end{align*}
</p>
<p> In other words, we can consider \(\lambda\) as the negative of the additional, positive force that theobstacle exerts on the membrane. The inequality in the second line of thestatement above only appears to have the wrong sign because we have \(\mu-\lambda&lt;0\) at points where \(\lambda=0\) , given the definition of \(K\) . The existence and uniqueness of \((u,\lambda)\in V\times K\) of this saddlepoint problem has been stated in Glowinski, Lions and Tr&eacute;moli&egrave;res: Numerical Analysis of VariationalInequalities, North-Holland, 1981.</p>
<p><a class="anchor" id="ActiveSetmethodstosolvethesaddlepointproblem"></a></p><h3>Active Set methods to solve the saddle point problem</h3>
<p>There are different methods to solve the variational inequality. As onepossibility you can understand the saddle point problem as a convex quadratic program (QP) withinequality constraints. To get there, let us assume that we discretize both \(u\) and \(\lambda\) with thesame finite element space, for example the usual \(Q_k\) spaces. We would thenget the equations </p><p class="formulaDsp">
\begin{eqnarray*} &amp;A U + B\Lambda = F,&amp;\\ &amp;[BU-G]_i \geq 0, \quad \Lambda_i \leq 0,\quad \Lambda_i[BU-G]_i = 0 \qquad \forall i.&amp; \end{eqnarray*}
</p>
<p> where \(B\) is the mass matrix on the chosen finite element space and theindices \(i\) above are for all degrees of freedom in the set \(\cal S\) of degrees offreedom located in the interior of the domain(we have Dirichlet conditions on the perimeter). However, wecan make our life simpler if we use a particular quadrature rule whenassembling all terms that yield this mass matrix, namely a quadrature formulawhere quadrature points are only located at the interpolation points atwhich shape functions are defined; since all but one shape function are zeroat these locations, we get a diagonal mass matrix with </p><p class="formulaDsp">
\begin{align*} B_{ii} = \int_\Omega \varphi_i(\mathbf x)^2\ \textrm{d}x, \qquad B_{ij}=0 \ \text{for } i\neq j. \end{align*}
</p>
<p> To define \(G\) we use the same technique as for \(B\) . In other words, wedefine </p><p class="formulaDsp">
\begin{align*} G_{i} = \int_\Omega g_h(x) \varphi_i(\mathbf x)\ \textrm{d}x, \end{align*}
</p>
<p> where \(g_h\) is a suitable approximation of \(g\) . The integral in the definitionof \(B_{ii}\) and \(G_i\) are then approximated by the trapezoidal rule.With this, the equations above can be restated as </p><p class="formulaDsp">
\begin{eqnarray*} &amp;A U + B\Lambda = F,&amp;\\ &amp;U_i-B_{ii}^{-1}G_i \ge 0, \quad \Lambda_i \leq 0,\quad \Lambda_i[U_i-B_{ii}^{-1}G_i] = 0 \qquad \forall i\in{\cal S}.&amp; \end{eqnarray*}
</p>
<p>Now we define for each degree of freedom \(i\) the function </p><p class="formulaDsp">
\begin{equation*} C([BU]_i,\Lambda_i) \dealcoloneq -\Lambda_i + \min\lbrace 0, \Lambda_i + c([BU]_i - G_i) \rbrace, \end{equation*}
</p>
<p> with some \(c&gt;0\) . (In this program we choose \(c = 100\) . It is a kind of apenalty parameter which depends on the problem itself and needs to be chosenlarge enough; for example there is no convergence for \(c = 1\) using thecurrent program if we use 7 global refinements.) After some head-scratching one can then convince oneself that the inequalitiesabove can equivalently be rewritten as </p><p class="formulaDsp">
\begin{equation*} C([BU]_i,\Lambda_i) = 0, \qquad \forall i\in{\cal S}. \end{equation*}
</p>
<p> The primal-dual active set strategy we will use here is an iterative scheme which is based onthis condition to predict the next active and inactive sets \(\mathcal{A}_k\) and \(\mathcal{F}_k\) (that is, those complementary sets of indices \(i\) for which \(U_i\) is either equal to or not equal to the value of the obstacle \(B^{-1}G\) ). For a more in depth treatment of this approach, see Hintermueller, Ito, Kunisch: The primal-dual active setstrategy as a semismooth newton method, SIAM J. OPTIM., 2003, Vol. 13, No. 3,pp. 865-888. <a class="anchor" id="Theprimaldualactivesetalgorithm"></a></p><h3>The primal-dual active set algorithm</h3>
<p>The algorithm for the primal-dual active set method works as follows (NOTE: \(B = B^T\) ):</p><ol type="1">
<li>Initialize \(\mathcal{A}_k\) and \(\mathcal{F}_k\) , such that \(\mathcal{S}=\mathcal{A}_k\cup\mathcal{F}_k\) and \(\mathcal{A}_k\cap\mathcal{F}_k=\emptyset\) and set \(k=1\) .2. Find the primal-dual pair \((U^k,\Lambda^k)\) that satisfies</li>
</ol>
<p class="formulaDsp">
\begin{align*} AU^k + B\Lambda^k &amp;= F,\\ [BU^k]_i &amp;= G_i\quad&amp;&amp;\forall i\in\mathcal{A}_k,\\ \Lambda_i^k &amp;= 0\quad&amp;&amp;\forall i\in\mathcal{F}_k. \end{align*}
</p>
<p> Note that the second and third conditions imply that exactly \(|S|\) unknowns are fixed, with the first condition yielding the remaining \(|S|\) equations necessary to determine both \(U\) and \(\Lambda\) .3. Define the new active and inactive sets by </p><p class="formulaDsp">
\begin{equation*} \begin{split} \mathcal{A}_{k+1} \dealcoloneq \lbrace i\in\mathcal{S}:\Lambda^k_i + c([BU^k]_i - G_i)&lt; 0\rbrace,\\ \mathcal{F}_{k+1} \dealcoloneq \lbrace i\in\mathcal{S}:\Lambda^k_i + c([BU^k]_i - G_i)\geq 0\rbrace. \end{split} \end{equation*}
</p>
<ol type="1">
<li>If \(\mathcal{A}_{k+1}=\mathcal{A}_k\) (and then, obviously, also \(\mathcal{F}_{k+1}=\mathcal{F}_k\) ) then stop, else set \(k=k+1\) and go to step (2). The method is called "primal-dual" because it uses both primal (thedisplacement \(U\) ) as well as dual variables (the Lagrange multiplier \(\Lambda\) ) to determine the next active set. At the end of this section, let us add two observations. First,for any primal-dual pair \((U^k,\Lambda^k)\) that satisfies thesecondition, we can distinguish the following cases:</li>
</ol>
<ol type="1">
<li>\(\Lambda^k_i + c([BU^k]_i - G_i) &lt; 0\) (i active): <br  />
 Then either \([BU^k]_i&lt;G_i\) and \(\Lambda^k_i=0\) (penetration) or \(\Lambda^k_i&lt;0\) and \([BU^k]_i=G_i\) (pressing load).2. \(\Lambda^k_i + c([BU^k]_i - G_i)\geq 0\) (i inactive): <br  />
 Then either \([BU^k]_i\geq G_i\) and \(\Lambda^k_i=0\) (no contact) or \(\Lambda^k_i\geq0\) and \([BU^k]_i=G_i\) (unpressing load). Second, the method above appears intuitively correct and useful but a bit adhoc. However, it can be derived in a concisely in the following way. To thisend, note that we'd like to solve the nonlinear system <p class="formulaDsp">
\begin{eqnarray*} &amp;A U + B\Lambda = F,&amp;\\ &amp;C([BU-G]_i, \Lambda_i) = 0, \qquad \forall i.&amp; \end{eqnarray*}
</p>
 We can iteratively solve this by always linearizing around the previousiterate (i.e., applying a Newton method), but for this we need to linearizethe function \(C(\cdot,\cdot)\) that is not differentiable. That said, it isslantly differentiable, and in fact we have <p class="formulaDsp">
\begin{equation*} \dfrac{\partial}{\partial U^k_i}C([BU^k]_i,\Lambda^k_i) = \begin{cases} cB_{ii},&amp; \text{if}\ \Lambda^k_i + c([BU^k]_i - G_i)&lt; 0\\ 0,&amp; \text{if}\ \Lambda^k_i + c([BU^k]_i - G_i)\geq 0. \end{cases} \end{equation*}
</p>
 <p class="formulaDsp">
\begin{equation*} \dfrac{\partial}{\partial\Lambda^k_i}C([BU^k]_i,\Lambda^k_i) = \begin{cases} 0,&amp; \text{if}\ \Lambda^k_i + c([BU^k]_i - G_i)&lt; 0\\ -1,&amp; \text{if}\ \Lambda^k_i + c([BU^k]_i - G_i)\geq 0. \end{cases} \end{equation*}
</p>
 This suggest a semismooth Newton step of the form <p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; A_{\mathcal{F}_k\mathcal{A}_k} &amp; B_{\mathcal{F}_k} &amp; 0\\ A_{\mathcal{A}_k\mathcal{F}_k} &amp; A_{\mathcal{A}_k\mathcal{A}_k} &amp; 0 &amp; B_{\mathcal{A}_k}\\ 0 &amp; 0 &amp; -Id_{\mathcal{F}_k} &amp; 0\\ 0 &amp; cB_{\mathcal{A}_k} &amp; 0 &amp; 0 \end{pmatrix} \begin{pmatrix} \delta U^k_{\mathcal{F}_k}\\ \delta U^k_{\mathcal{A}_k}\\ \delta \Lambda^k_{\mathcal{F}_k}\\ \delta \Lambda^k_{\mathcal{A}_k} \end{pmatrix} = -\begin{pmatrix} (AU^k + \Lambda^k - F)_{\mathcal{F}_k}\\ (AU^k + \Lambda^k - F)_{\mathcal{A}_k}\\ -\Lambda^k_{\mathcal{F}_k}\\ c(B_{\mathcal{A}_k} U^k - G)_{\mathcal{A}_k} \end{pmatrix}, \end{equation*}
</p>
 where we have split matrices \(A,B\) as well as vectors in the natural way intorows and columns whose indices belong to either the active set \({\mathcal{A}_k}\) or the inactive set \({\mathcal{F}_k}\) . Rather than solving for updates \(\delta U, \delta \Lambda\) , we can also solvefor the variables we are interested in right away by setting \(\delta U^k \dealcoloneq U^{k+1} - U^k\) and \(\delta \Lambda^k \dealcoloneq \Lambda^{k+1} - \Lambda^k\) andbringing all known terms to the right hand side. This yields <p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; A_{\mathcal{F}_k\mathcal{A}_k} &amp; B_{\mathcal{F}_k} &amp; 0\\ A_{\mathcal{A}_k\mathcal{F}_k} &amp; A_{\mathcal{A}_k\mathcal{A}_k} &amp; 0 &amp; B_{\mathcal{A}_k}\\ 0 &amp; 0 &amp; Id_{\mathcal{F}_k} &amp; 0\\ 0 &amp; B_{\mathcal{A}_k} &amp; 0 &amp; 0 \end{pmatrix} \begin{pmatrix} U^k_{\mathcal{F}_k}\\ U^k_{\mathcal{A}_k}\\ \Lambda^k_{\mathcal{F}_k}\\ \Lambda^k_{\mathcal{A}_k} \end{pmatrix} = \begin{pmatrix} F_{\mathcal{F}_k}\\ F_{\mathcal{A}_k}\\ 0\\ G_{\mathcal{A}_k} \end{pmatrix}. \end{equation*}
</p>
 These are the equations outlined above in the description of the basic algorithm. We could even drive this a bit further.It's easy to see that we can eliminate the third row and the third columnbecause it implies \(\Lambda_{\mathcal{F}_k} = 0\) : <p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; A_{\mathcal{F}_k\mathcal{A}_k} &amp; 0\\ A_{\mathcal{A}_k\mathcal{F}_k} &amp; A_{\mathcal{A}_k\mathcal{A}_k} &amp; B_{\mathcal{A}_k}\\ 0 &amp; B_{\mathcal{A}_k} &amp; 0 \end{pmatrix} \begin{pmatrix} U^k_{\mathcal{F}_k}\\ U^k_{\mathcal{A}_k}\\ \Lambda^k_{\mathcal{A}_k} \end{pmatrix} = \begin{pmatrix} F_{\mathcal{F}_k}\\ F_{\mathcal{A}_k}\\ G_{\mathcal{A}_k} \end{pmatrix}. \end{equation*}
</p>
 This shows that one in fact only needs to solve for the Lagrange multiplierslocated on the active set. By considering the second row one would then recoverthe full Lagrange multiplier vector through <p class="formulaDsp">
\begin{equation*} \Lambda^k_S = B^{-1}\left(f_{\mathcal{S}} - A_{\mathcal{S}}U^k_{\mathcal{S}}\right). \end{equation*}
</p>
 Because of the third row and the fact that \(B_{\mathcal{A}_k}\) is a diagonal matrix we are ableto calculate \(U^k_{\mathcal{A}_k}=B^{-1}_{\mathcal{A}_k}G_{\mathcal{A}_k}\) directly. We can therefore also write thelinear system as follows: <p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; 0\\ 0 &amp; Id_{\mathcal{A}_k} \\ \end{pmatrix} \begin{pmatrix} U^k_{\mathcal{F}_k}\\ U^k_{\mathcal{A}_k} \end{pmatrix} = \begin{pmatrix} F_{\mathcal{F}_k} - A_{\mathcal{F}_k\mathcal{A}_k}B^{-1}_{\mathcal{A}_k}G_{\mathcal{A}_k} \\ B_{\mathcal{A}_k}^{-1}G_{\mathcal{A}_k} \end{pmatrix}. \end{equation*}
</p>
 Fortunately, this form is easy to arrive at: we simply build the usual Laplacelinear system <p class="formulaDsp">
\begin{equation*} \begin{pmatrix} A_{\mathcal{F}_k\mathcal{F}_k} &amp; A_{\mathcal{F}_k\mathcal{A}_k} \\ A_{\mathcal{A}_k\mathcal{F}_k} &amp; A_{\mathcal{A}_k\mathcal{A}_k} \end{pmatrix} \begin{pmatrix} U^k_{\mathcal{F}_k}\\ U^k_{\mathcal{A}_k} \end{pmatrix} = \begin{pmatrix} F_{\mathcal{F}_k}\\ F_{\mathcal{A}_k} \end{pmatrix}, \end{equation*}
</p>
 and then let the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class eliminate all constrained degrees offreedom, namely \(U^k_{\mathcal{A}_k}=B^{-1}_{\mathcal{A}_k}G_{\mathcal{A}_k}\) ,in the same way as if the dofs in \(\mathcal{A}_k\) were Dirichlet data. Theresult linear system (the second to last one above) is symmetric and positivedefinite and we solve it with a CG-methodand the AMG preconditioner from Trilinos.</li>
</ol>
<p><a class="anchor" id="Implementation"></a></p><h3>Implementation</h3>
<p>This tutorial is quite similar to <a class="el" href="step_4.html">step-4</a> . The general structure of the programfollows <a class="el" href="step_4.html">step-4</a> with minor differences:</p>
<ul>
<li>We need two new methods, <code>assemble_mass_matrix_diagonal</code> and <code>update_solution_and_constraints</code> .</li>
<li>We need new member variables that denote the constraints we have here.</li>
<li>We change the preconditioner for the solver.</li>
</ul>
<p>You may want to read up on <a class="el" href="step_4.html">step-4</a> if you want to understand thecurrent program.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>As usual, at the beginning we include all the header files we need in here. With the exception of the various files that provide interfaces to the Trilinos library, there are no surprises:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep41.html">Step41</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeObstacleProblemcodeclasstemplate"></a> </p><h3>The <code>ObstacleProblem</code> class template</h3>
<p>This class supplies all function and variables needed to describe the obstacle problem. It is close to what we had to do in <a class="el" href="step_4.html">step-4</a> , and so relatively simple. The only real new components are the update_solution_and_constraints function that computes the active set and a number of variables that are necessary to describe the original (unconstrained) form of the linear system ( <code>complete_system_matrix</code> and <code>complete_system_rhs</code> ) as well as the active set itself and the diagonal of the mass matrix \(B\) used in scaling Lagrange multipliers in the active set formulation. The rest is as in <a class="el" href="step_4.html">step-4</a> :</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>ObstacleProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  ObstacleProblem();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">  <span class="keywordtype">void</span> setup_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">       assemble_mass_matrix_diagonal(<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> &amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">  <span class="keywordtype">void</span> update_solution_and_constraints();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a>                  active_set;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> system_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> complete_system_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> system_rhs;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> complete_system_rhs;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> diagonal_of_mass_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> contact_force;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="Righthandsideboundaryvaluesandtheobstacle"></a> </p><h3>Right hand side, boundary values, and the obstacle</h3>
<p>In the following, we define classes that describe the right hand side function, the Dirichlet boundary values, and the height of the obstacle as a function of \(\mathbf x\) . In all three cases, we derive these classes from <a class="el" href="classFunction.html">Function</a> &lt;dim&gt;, although in the case of <code><a class="el" href="classRightHandSide.html">RightHandSide</a></code> and <code>Obstacle</code> this is more out of convention than necessity since we never pass such objects to the library. In any case, the definition of the right hand side and boundary values classes is obvious given our choice of \(f=-10\) , \(u|_{\partial\Omega}=0\) :</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keyword">class </span><a class="code" href="classRightHandSide.html">RightHandSide</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">   {</div>
<div class="line">   <span class="keyword">public</span>:</div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;  <span class="comment">/*p*/</span> ,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">       <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 1);</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">return</span></div>
<div class="line">  </div>
<div class="line">-10;</div>
<div class="line">     }</div>
<div class="line">   };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keyword">class </span><a class="code" href="classBoundaryValues.html">BoundaryValues</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">   {</div>
<div class="line">   <span class="keyword">public</span>:</div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;  <span class="comment">/*p*/</span> ,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">       <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 1);</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">return</span> 0;</div>
<div class="line">     }</div>
<div class="line">   };</div>
</div><!-- fragment --><p>We describe the obstacle function by a cascaded barrier (think: stair steps):</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keyword">class </span>Obstacle : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">   {</div>
<div class="line">   <span class="keyword">public</span>:</div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">       <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, 1));</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt;</div>
<div class="line">  </div>
<div class="line">-0.5)</div>
<div class="line">         <span class="keywordflow">return</span></div>
<div class="line">  </div>
<div class="line">-0.2;</div>
<div class="line">       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &gt;=</div>
<div class="line">  </div>
<div class="line">-0.5 &amp;&amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; 0.0)</div>
<div class="line">         <span class="keywordflow">return</span></div>
<div class="line">  </div>
<div class="line">-0.4;</div>
<div class="line">       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &gt;= 0.0 &amp;&amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; 0.5)</div>
<div class="line">         <span class="keywordflow">return</span></div>
<div class="line">  </div>
<div class="line">-0.6;</div>
<div class="line">       <span class="keywordflow">else</span></div>
<div class="line">         <span class="keywordflow">return</span></div>
<div class="line">  </div>
<div class="line">-0.8;</div>
<div class="line">     }</div>
<div class="line">   };</div>
</div><!-- fragment --><p><a class="anchor" id="ImplementationofthecodeObstacleProblemcodeclass"></a> </p><h3>Implementation of the <code>ObstacleProblem</code> class</h3>
<p><a class="anchor" id="ObstacleProblemObstacleProblem"></a> </p><h4>ObstacleProblem::ObstacleProblem</h4>
<p>To everyone who has taken a look at the first few tutorial programs, the constructor is completely obvious:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">ObstacleProblem&lt;dim&gt;::ObstacleProblem()</div>
<div class="line">  : <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(1)</div>
<div class="line">  , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemmake_grid"></a> </p><h4>ObstacleProblem::make_grid</h4>
<p>We solve our obstacle problem on the square \([-1,1]\times [-1,1]\) in 2D. This function therefore just sets up one of the simplest possible meshes.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">ObstacleProblem&lt;dim&gt;::make_grid</a>()</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">  </div>
<div class="line">-1, 1);</div>
<div class="line">     <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(7);</div>
<div class="line">  </div>
<div class="line">     std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">               &lt;&lt; std::endl</div>
<div class="line">               &lt;&lt; <span class="stringliteral">&quot;Total number of cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_cells()</div>
<div class="line">               &lt;&lt; std::endl;</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemsetup_system"></a> </p><h4>ObstacleProblem::setup_system</h4>
<p>In this first function of note, we set up the degrees of freedom handler, resize vectors and matrices, and deal with the constraints. Initially, the constraints are, of course, only given by boundary values, so we interpolate them towards the top of the function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::setup_system()</div>
<div class="line">{</div>
<div class="line">  dof_handler.distribute_dofs(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">  active_set.set_size(dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">            &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           0,</div>
<div class="line">                                           <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.n_dofs());</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  system_matrix.reinit(dsp);</div>
<div class="line">  complete_system_matrix.reinit(dsp);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> solution_index_set = dof_handler.locally_owned_dofs();</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">  system_rhs.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">  complete_system_rhs.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">  contact_force.reinit(solution_index_set, MPI_COMM_WORLD);</div>
</div><!-- fragment --><p>The only other thing to do here is to compute the factors in the \(B\) matrix which is used to scale the residual. As discussed in the introduction, we'll use a little trick to make this mass matrix diagonal, and in the following then first compute all of this as a matrix and then extract the diagonal elements for later use:</p>
<div class="fragment"><div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div>
<div class="line">  <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.reinit(dsp);</div>
<div class="line">  assemble_mass_matrix_diagonal(<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">  diagonal_of_mass_matrix.reinit(solution_index_set);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.size(); <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>++)</div>
<div class="line">    diagonal_of_mass_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.diag_element(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemassemble_system"></a> </p><h4>ObstacleProblem::assemble_system</h4>
<p>This function at once assembles the system matrix and right-hand-side and applied the constraints (both due to the active set as well as from boundary values) to our system. Otherwise, it is functionally equivalent to the corresponding function in, for example, <a class="el" href="step_4.html">step-4</a> .</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::assemble_system()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  system_matrix = 0;</div>
<div class="line">  system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <a class="code" href="classRightHandSide.html">RightHandSide&lt;dim&gt;</a> <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line">      cell_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point)</div>
<div class="line">                 fe_values.shape_grad(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point) fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">            cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">              (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point)</div>
<div class="line">               <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>.value(fe_values.quadrature_point(q_point))</div>
<div class="line">               fe_values.JxW(q_point));</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                             cell_rhs,</div>
<div class="line">                                             <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                             system_matrix,</div>
<div class="line">                                             system_rhs,</div>
<div class="line">                                             <span class="keyword">true</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemassemble_mass_matrix_diagonal"></a> </p><h4>ObstacleProblem::assemble_mass_matrix_diagonal</h4>
<p>The next function is used in the computation of the diagonal mass matrix \(B\) used to scale variables in the active set method. As discussed in the introduction, we get the mass matrix to be diagonal by choosing the trapezoidal rule for quadrature. Doing so we don't really need the triple loop over quadrature points, indices \(i\) and indices \(j\) any more and can, instead, just use a double loop. The rest of the function is obvious given what we have discussed in many of the previous tutorial programs. <br  />
 Note that at the time this function is called, the constraints object only contains boundary value constraints; we therefore do not have to pay attention in the last copy-local-to-global step to preserve the values of matrix entries that may later on be constrained by the active set. <br  />
 Note also that the trick with the trapezoidal rule only works if we have in fact \(Q_1\) elements. For higher order elements, one would need to use a quadrature formula that has quadrature points at all the support points of the finite element. Constructing such a quadrature formula isn't really difficult, but not the point here, and so we simply assert at the top of the function that our implicit assumption about the finite element is in fact satisfied.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::assemble_mass_matrix_diagonal(</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> &amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;dim&gt;</a> quadrature_formula;</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">            (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point)</div>
<div class="line">             fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                             <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                             <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemupdate_solution_and_constraints"></a> </p><h4>ObstacleProblem::update_solution_and_constraints</h4>
<p>In a sense, this is the central function of this program. It updates the active set of constrained degrees of freedom as discussed in the introduction and computes an <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object from it that can then be used to eliminate constrained degrees of freedom from the solution of the next iteration. At the same time we set the constrained degrees of freedom of the solution to the correct value, namely the height of the obstacle. <br  />
 Fundamentally, the function is rather simple: We have to loop over all degrees of freedom and check the sign of the function \(\Lambda^k_i + c([BU^k]_i - G_i) = \Lambda^k_i + cB_i(U^k_i - [g_h]_i)\) because in our case \(G_i = B_i[g_h]_i\) . To this end, we use the formula given in the introduction by which we can compute the Lagrange multiplier as the residual of the original linear system (given via the variables <code>complete_system_matrix</code> and <code>complete_system_rhs</code> . At the top of this function, we compute this residual using a function that is part of the matrix classes.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::update_solution_and_constraints()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Updating active set...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> penalty_parameter = 100.0;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(</div>
<div class="line">    <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(dof_handler.n_dofs()));</div>
<div class="line">  complete_system_matrix.residual(<a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, complete_system_rhs);</div>
</div><!-- fragment --><p>compute contact_force[i] =</p>
<ul>
<li>lambda[i] diagonal_of_mass_matrix[i]</li>
</ul>
<div class="fragment"><div class="line">     contact_force = <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>;</div>
<div class="line">     contact_force.scale(diagonal_of_mass_matrix);</div>
<div class="line">     contact_force=</div>
<div class="line">  </div>
<div class="line">-1;</div>
</div><!-- fragment --><p>The next step is to reset the active set and constraints objects and to start the loop over all degrees of freedom. This is made slightly more complicated by the fact that we can't just loop over all elements of the solution vector since there is no way for us then to find out what location a DoF is associated with; however, we need this location to test whether the displacement of a DoF is larger or smaller than the height of the obstacle at this location. <br  />
 We work around this by looping over all cells and DoFs defined on each of these cells. We use here that the displacement is described using a \(Q_1\) function for which degrees of freedom are always located on the vertices of the cell; thus, we can get the index of each degree of freedom and its location by asking the vertex for this information. On the other hand, this clearly wouldn't work for higher order elements, and so we add an assertion that makes sure that we only deal with elements for which all degrees of freedom are located in vertices to avoid tripping ourselves with non-functional code in case someone wants to play with increasing the polynomial degree of the solution. <br  />
 The price to pay for having to loop over cells rather than DoFs is that we may encounter some degrees of freedom more than once, namely each time we visit one of the cells adjacent to a given vertex. We will therefore have to keep track which vertices we have already touched and which we haven't so far. We do so by using an array of flags <code>dof_touched</code> :</p>
<div class="fragment"><div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">active_set.clear();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> Obstacle&lt;dim&gt; obstacle;</div>
<div class="line"><a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;bool&gt;</a>   dof_touched(dof_handler.n_dofs(), <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_indices())</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dof_handler.get_fe().n_dofs_per_cell() == <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;n_vertices(),</div>
<div class="line">             <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dof_index = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(<a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a>, 0);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (dof_touched[dof_index] == <span class="keyword">false</span>)</div>
<div class="line">        dof_touched[dof_index] = <span class="keyword">true</span>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">continue</span>;</div>
</div><!-- fragment --><p>Now that we know that we haven't touched this DoF yet, let's get the value of the displacement function there as well as the value of the obstacle function and use this to decide whether the current DoF belongs to the active set. For that we use the function given above and in the introduction. <br  />
 If we decide that the DoF should be part of the active set, we add its index to the active set, introduce an inhomogeneous equality constraint in the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object, and reset the solution value to the height of the obstacle. Finally, the residual of the non-contact part of the system serves as an additional control (the residual equals the remaining, unaccounted forces, and should be zero outside the contact zone), so we zero out the components of the residual vector (i.e., the Lagrange multiplier lambda) that correspond to the area where the body is in contact; at the end of the loop over all cells, the residual will therefore only consist of the residual in the non-contact zone. We output the norm of this residual along with the size of the active set after the loop.</p>
<div class="fragment"><div class="line">           <span class="keyword">const</span> <span class="keywordtype">double</span> obstacle_value = obstacle.value(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(<a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a>));</div>
<div class="line">           <span class="keyword">const</span> <span class="keywordtype">double</span> solution_value = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(dof_index);</div>
<div class="line">  </div>
<div class="line">           <span class="keywordflow">if</span> (<a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(dof_index) + penalty_parameter</div>
<div class="line">                                     diagonal_of_mass_matrix(dof_index)</div>
<div class="line">                                     (solution_value</div>
<div class="line">  </div>
<div class="line">- obstacle_value) &lt;</div>
<div class="line">               0)</div>
<div class="line">             {</div>
<div class="line">               active_set.add_index(dof_index);</div>
<div class="line">               <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">add_line</a>(dof_index);</div>
<div class="line">               <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">set_inhomogeneity</a>(dof_index, obstacle_value);</div>
<div class="line">  </div>
<div class="line">               <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(dof_index) = obstacle_value;</div>
<div class="line">  </div>
<div class="line">               <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(dof_index) = 0;</div>
<div class="line">             }</div>
<div class="line">         }</div>
<div class="line">     std::cout &lt;&lt; <span class="stringliteral">&quot;      Size of active set: &quot;</span> &lt;&lt; active_set.n_elements()</div>
<div class="line">               &lt;&lt; std::endl;</div>
<div class="line">  </div>
<div class="line">     std::cout &lt;&lt; <span class="stringliteral">&quot;   Residual of the non-contact part of the system: &quot;</span></div>
<div class="line">               &lt;&lt; <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.l2_norm() &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>In a final step, we add to the set of constraints on DoFs we have so far from the active set those that result from Dirichlet boundary values, and close the constraints object:</p>
<div class="fragment"><div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           0,</div>
<div class="line">                                           <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemsolve"></a> </p><h4>ObstacleProblem::solve</h4>
<p>There is nothing to say really about the solve function. In the context of a Newton method, we are not typically interested in very high accuracy (why ask for a highly accurate solution of a linear problem that we know only gives us an approximation of the solution of the nonlinear problem), and so we use the <a class="el" href="classReductionControl.html">ReductionControl</a> class that stops iterations when either an absolute tolerance is reached (for which we choose \(10^{-12}\) ) or when the residual is reduced by a certain factor (here, \(10^{-3}\) ).</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">ObstacleProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">   {</div>
<div class="line">     std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classReductionControl.html">ReductionControl</a>                        reduction_control(100, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3);</div>
<div class="line">     <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(reduction_control);</div>
<div class="line">     <a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a>       precondition;</div>
<div class="line">     precondition.<a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">initialize</a>(system_matrix);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs, precondition);</div>
<div class="line">     <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">  </div>
<div class="line">     std::cout &lt;&lt; <span class="stringliteral">&quot;      Error: &quot;</span> &lt;&lt; reduction_control.initial_value() &lt;&lt; <span class="stringliteral">&quot;</span></div>
<div class="line"><span class="stringliteral">  </span></div>
<div class="line"><span class="stringliteral">-&gt; &quot;</span></div>
<div class="line">               &lt;&lt; reduction_control.last_value() &lt;&lt; <span class="stringliteral">&quot; in &quot;</span></div>
<div class="line">               &lt;&lt; reduction_control.last_step() &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span></div>
<div class="line">               &lt;&lt; std::endl;</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemoutput_results"></a> </p><h4>ObstacleProblem::output_results</h4>
<p>We use the vtk-format for the output. The file contains the displacement and a numerical representation of the active set.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Writing graphical output...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> active_set_vector(</div>
<div class="line">    dof_handler.locally_owned_dofs(), MPI_COMM_WORLD);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a> : active_set)</div>
<div class="line">    active_set_vector[<a class="code" href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a>] = 1.;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, <span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(active_set_vector, <span class="stringliteral">&quot;active_set&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(contact_force, <span class="stringliteral">&quot;lambda&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  std::ofstream output_vtk(<span class="stringliteral">&quot;output_&quot;</span> +</div>
<div class="line">                           <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>, 3) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output_vtk);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ObstacleProblemrun"></a> </p><h4>ObstacleProblem::run</h4>
<p>This is the function which has the top-level control over everything. It is not very long, and in fact rather straightforward: in every iteration of the active set method, we assemble the linear system, solve it, update the active set and project the solution back to the feasible set, and then output the results. The iteration is terminated whenever the active set has not changed in the previous iteration. <br  />
 The only trickier part is that we have to save the linear system (i.e., the matrix and right hand side) after assembling it in the first iteration. The reason is that this is the only step where we can access the linear system as built without any of the contact constraints active. We need this to compute the residual of the solution at other iterations, but in other iterations that linear system we form has the rows and columns that correspond to constrained degrees of freedom eliminated, and so we can no longer access the full residual of the original equation.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">ObstacleProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">    setup_system();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> active_set_old(active_set);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> = 0; <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> &lt;= <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.size(); ++<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Newton iteration &quot;</span> &lt;&lt; <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> == 0)</div>
<div class="line">          {</div>
<div class="line">            complete_system_matrix.copy_from(system_matrix);</div>
<div class="line">            complete_system_rhs = system_rhs;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">        update_solution_and_constraints();</div>
<div class="line">        output_results(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (active_set == active_set_old)</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        active_set_old = active_set;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step41</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>And this is the main function. It follows the pattern of all other main functions. The call to initialize MPI exists because the Trilinos library upon which we build our linear solvers in this program requires it.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, charargv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep41.html">Step41</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
</div><!-- fragment --><p>This program can only be run in serial. Otherwise, throw an exception.</p>
<div class="fragment"><div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-41&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      ObstacleProblem&lt;2&gt; obstacle_problem;</div>
<div class="line">      obstacle_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>Running the program produces output like this: </p><div class="fragment"><div class="line"><a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 16384</div>
<div class="line">Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 21845</div>
<div class="line"><a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 16641</div>
<div class="line">  </div>
<div class="line"><a class="code" href="newton__0_8txt.html#a7ae4bec25ec0fbd4c3968d0926b5c7c6">Newton</a> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> 0</div>
<div class="line">   Assembling <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">   Solving <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">      Error: 0.310059</div>
<div class="line">  </div>
<div class="line">-&gt; 5.16619e-05 <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> 5 CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a>.</div>
<div class="line">   Updating <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>...</div>
<div class="line">      Size <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>: 13164</div>
<div class="line">   Residual <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> non-contact <a class="code" href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>: 1.61863e-05</div>
<div class="line">   Writing graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>...</div>
<div class="line">  </div>
<div class="line"><a class="code" href="newton__0_8txt.html#a7ae4bec25ec0fbd4c3968d0926b5c7c6">Newton</a> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> 1</div>
<div class="line">   Assembling <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">   Solving <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">      Error: 1.11987</div>
<div class="line">  </div>
<div class="line">-&gt; 0.00109377 <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> 6 CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a>.</div>
<div class="line">   Updating <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>...</div>
<div class="line">      Size <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>: 12363</div>
<div class="line">   Residual <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> non-contact <a class="code" href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>: 3.9373</div>
<div class="line">   Writing graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>...</div>
<div class="line">  </div>
<div class="line">...</div>
<div class="line">  </div>
<div class="line"><a class="code" href="newton__0_8txt.html#a7ae4bec25ec0fbd4c3968d0926b5c7c6">Newton</a> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> 17</div>
<div class="line">   Assembling <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">   Solving <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">      Error: 0.00713308</div>
<div class="line">  </div>
<div class="line">-&gt; 2.29249e-06 <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> 4 CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a>.</div>
<div class="line">   Updating <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>...</div>
<div class="line">      Size <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>: 5399</div>
<div class="line">   Residual <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> non-contact <a class="code" href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>: 0.000957525</div>
<div class="line">   Writing graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>...</div>
<div class="line">  </div>
<div class="line"><a class="code" href="newton__0_8txt.html#a7ae4bec25ec0fbd4c3968d0926b5c7c6">Newton</a> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> 18</div>
<div class="line">   Assembling <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">   Solving <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>...</div>
<div class="line">      Error: 0.000957525</div>
<div class="line">  </div>
<div class="line">-&gt; 2.8033e-07 <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> 4 CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a>.</div>
<div class="line">   Updating <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>...</div>
<div class="line">      Size <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a>: 5399</div>
<div class="line">   Residual <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> non-contact <a class="code" href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a>: 2.8033e-07</div>
<div class="line">   Writing graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>...</div>
</div><!-- fragment --><p>The iterations end once the active set doesn't change any more (it has5,399 constrained degrees of freedom at that point). The algebraicprecondition is apparently working nicely since we only need 4-6 CGiterations to solve the linear system (although this also has a lot todo with the fact that we are not asking for very high accuracy of thelinear solver). More revealing is to look at a sequence of graphical output files(every third step is shown, with the number of the iteration in theleftmost column): </p><table align="center">
<tr>
<td valign="top">0 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.00.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.00.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.00.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">3 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.03.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.03.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.03.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">6 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.06.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.06.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.06.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">9 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.09.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.09.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.09.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">12 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.12.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.12.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.12.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">15 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.15.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.15.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.15.png" alt="" class="inline"/>   </td></tr>
<tr>
<td valign="top">18 &#160;  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.18.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.active-set.18.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.displacement.3d.18.png" alt="" class="inline"/>   </td></tr>
</table>
<p><br  />
 The pictures show that in the first step, the solution (which has beencomputed without any of the constraints active) bends through so muchthat pretty much every interior point has to be bounced back to thestairstep function, producing a discontinuous solution. Over thecourse of the active set iterations, this unphysical membrane shape issmoothed out, the contact with the lower-most stair step disappears,and the solution stabilizes. In addition to this, the program also outputs the values of theLagrange multipliers. Remember that these are the contact forces andso should only be positive on the contact set, and zero outside. If,on the other hand, a Lagrange multiplier is negative in the activeset, then this degree of freedom must be removed from the activeset. The following pictures show the multipliers in iterations 1, 9and 18, where we use red and browns to indicate positive values, andblue for negative values. </p><table align="center">
<tr>
<td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.forces.01.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.forces.09.png" alt="" class="inline"/>  </td><td valign="top"><img src="https://www.dealii.org/images/steps/developer/step-41.forces.18.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center">Iteration 1  </td><td align="center">Iteration 9  </td><td align="center">Iteration 18   </td></tr>
</table>
<p><br  />
 It is easy to see that the positive values converge nicely to moderatevalues in the interior of the contact set and large upward forces atthe edges of the steps, as one would expect (to support the largecurvature of the membrane there); at the fringes of the active set,multipliers are initially negative, causing the set to shrink until,in iteration 18, there are no more negative multipliers and thealgorithm has converged.</p>
<p><a class="anchor" id="extensions"></a><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p>As with any of the programs of this tutorial, there are a number ofobvious possibilities for extensions and experiments. The first one isclear: introduce adaptivity. Contact problems are prime candidates foradaptive meshes because the solution has lines along which it is lessregular (the places where contact is established between membrane andobstacle) and other areas where the solution is very smooth (or, inthe present context, constant wherever it is in contact with theobstacle). Adding this to the current program should not pose too manydifficulties, but it is not trivial to find a good error estimator forthat purpose. A more challenging task would be an extension to 3d. The problem hereis not so much to simply make everything run in 3d. Rather, it is thatwhen a 3d body is deformed and gets into contact with an obstacle,then the obstacle does not act as a constraining body force within thedomain as is the case here. Rather, the contact force only acts on theboundary of the object. The inequality then is not in the differentialequation but in fact in the (Neumann-type) boundary conditions, thoughthis leads to a similar kind of variationalinequality. Mathematically, this means that the Lagrange multiplieronly lives on the surface, though it can of course be extended by zerointo the domain if that is convenient. As in the current program, onedoes not need to form and store this Lagrange multiplier explicitly. A further interesting problem for the 3d case is to consider contact problemswith friction. In almost every mechanical process friction has a big influence.For the modelling we have to take into account tangential stresses at the contactsurface. Also we have to observe that friction adds another nonlinearity toour problem. Another nontrivial modification is to implement a more complex constitutivelaw like nonlinear elasticity or elasto-plastic material behavior.The difficulty here is to handle the additional nonlinearity arisingthrough the nonlinear constitutive law.</p>
<p><a class="anchor" id="PlainProg"></a></p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2011 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Joerg Frohne, Texas A&amp;M University and</span></div>
<div class="line"><span class="comment"> *                        University of Siegen, 2011, 2012</span></div>
<div class="line"><span class="comment"> *          Wolfgang Bangerth, Texas A&amp;M University, 2012</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep41.html">Step41</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>ObstacleProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    ObstacleProblem();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">    <span class="keywordtype">void</span> setup_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">    <span class="keywordtype">void</span></div>
<div class="line">         assemble_mass_matrix_diagonal(<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> &amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">    <span class="keywordtype">void</span> update_solution_and_constraints();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a>                  active_set;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> system_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> complete_system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> system_rhs;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> complete_system_rhs;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> diagonal_of_mass_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> contact_force;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classRightHandSide.html">RightHandSide</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">      <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> -10;</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classBoundaryValues.html">BoundaryValues</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">      <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>Obstacle : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, 1));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; -0.5)</div>
<div class="line">        <span class="keywordflow">return</span> -0.2;</div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &gt;= -0.5 &amp;&amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; 0.0)</div>
<div class="line">        <span class="keywordflow">return</span> -0.4;</div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &gt;= 0.0 &amp;&amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0) &lt; 0.5)</div>
<div class="line">        <span class="keywordflow">return</span> -0.6;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> -0.8;</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classStep41_1_1ObstacleProblem.html#aa3ecce2b0c00868c513eef0f9ab38509">ObstacleProblem&lt;dim&gt;::ObstacleProblem</a>()</div>
<div class="line">    : <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(1)</div>
<div class="line">    , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">ObstacleProblem&lt;dim&gt;::make_grid</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, -1, 1);</div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(7);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Total number of cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_cells()</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::setup_system()</div>
<div class="line">  {</div>
<div class="line">    dof_handler.distribute_dofs(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">    active_set.set_size(dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             0,</div>
<div class="line">                                             <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.n_dofs());</div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(dsp);</div>
<div class="line">    complete_system_matrix.reinit(dsp);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> solution_index_set = dof_handler.locally_owned_dofs();</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">    system_rhs.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">    complete_system_rhs.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line">    contact_force.reinit(solution_index_set, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div>
<div class="line">    <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.reinit(dsp);</div>
<div class="line">    assemble_mass_matrix_diagonal(<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">    diagonal_of_mass_matrix.reinit(solution_index_set);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.size(); <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>++)</div>
<div class="line">      diagonal_of_mass_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.diag_element(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::assemble_system()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    system_matrix = 0;</div>
<div class="line">    system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <a class="code" href="classRightHandSide.html">RightHandSide&lt;dim&gt;</a> <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line">        cell_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q_point)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">                   fe_values.shape_grad(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_point) * fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">              cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">                 <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>.value(fe_values.quadrature_point(q_point)) *</div>
<div class="line">                 fe_values.JxW(q_point));</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                               cell_rhs,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               system_matrix,</div>
<div class="line">                                               system_rhs,</div>
<div class="line">                                               <span class="keyword">true</span>);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::assemble_mass_matrix_diagonal(</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> &amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> == 1, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;dim&gt;</a> quadrature_formula;</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>         fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q_point)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">              (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) *</div>
<div class="line">               fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_point) * fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(<a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::update_solution_and_constraints()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Updating active set...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> penalty_parameter = 100.0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(</div>
<div class="line">      <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(dof_handler.n_dofs()));</div>
<div class="line">    complete_system_matrix.residual(lambda, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, complete_system_rhs);</div>
<div class="line"> </div>
<div class="line">    contact_force = <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>;</div>
<div class="line">    contact_force.scale(diagonal_of_mass_matrix);</div>
<div class="line">    contact_force *= -1;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">    active_set.clear();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> Obstacle&lt;dim&gt; obstacle;</div>
<div class="line">    <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;bool&gt;</a>   dof_touched(dof_handler.n_dofs(), <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_indices())</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dof_handler.get_fe().n_dofs_per_cell() == <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;n_vertices(),</div>
<div class="line">                 <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dof_index = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex_dof_index(<a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a>, 0);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> (dof_touched[dof_index] == <span class="keyword">false</span>)</div>
<div class="line">            dof_touched[dof_index] = <span class="keyword">true</span>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> obstacle_value = obstacle.value(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;vertex(<a class="code" href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a>));</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> solution_value = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(dof_index);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(dof_index) + penalty_parameter *</div>
<div class="line">                                    diagonal_of_mass_matrix(dof_index) *</div>
<div class="line">                                    (solution_value - obstacle_value) &lt;</div>
<div class="line">              0)</div>
<div class="line">            {</div>
<div class="line">              active_set.add_index(dof_index);</div>
<div class="line">              <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">add_line</a>(dof_index);</div>
<div class="line">              <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">set_inhomogeneity</a>(dof_index, obstacle_value);</div>
<div class="line"> </div>
<div class="line">              <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(dof_index) = obstacle_value;</div>
<div class="line"> </div>
<div class="line">              <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>(dof_index) = 0;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;      Size of active set: &quot;</span> &lt;&lt; active_set.n_elements()</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Residual of the non-contact part of the system: &quot;</span></div>
<div class="line">              &lt;&lt; <a class="code" href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a>.l2_norm() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             0,</div>
<div class="line">                                             <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">ObstacleProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classReductionControl.html">ReductionControl</a>                        reduction_control(100, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3);</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(reduction_control);</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a>       precondition;</div>
<div class="line">    precondition.<a class="code" href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">initialize</a>(system_matrix);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs, precondition);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;      Error: &quot;</span> &lt;&lt; reduction_control.initial_value() &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span></div>
<div class="line">              &lt;&lt; reduction_control.last_value() &lt;&lt; <span class="stringliteral">&quot; in &quot;</span></div>
<div class="line">              &lt;&lt; reduction_control.last_step() &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> ObstacleProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Writing graphical output...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> active_set_vector(</div>
<div class="line">      dof_handler.locally_owned_dofs(), MPI_COMM_WORLD);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> <a class="code" href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a> : active_set)</div>
<div class="line">      active_set_vector[<a class="code" href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a>] = 1.;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, <span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(active_set_vector, <span class="stringliteral">&quot;active_set&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(contact_force, <span class="stringliteral">&quot;lambda&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::ofstream output_vtk(<span class="stringliteral">&quot;output_&quot;</span> +</div>
<div class="line">                             <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>, 3) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output_vtk);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">ObstacleProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">    setup_system();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> active_set_old(active_set);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> = 0; <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> &lt;= <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.size(); ++<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Newton iteration &quot;</span> &lt;&lt; <a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a> == 0)</div>
<div class="line">          {</div>
<div class="line">            complete_system_matrix.copy_from(system_matrix);</div>
<div class="line">            complete_system_rhs = system_rhs;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">        update_solution_and_constraints();</div>
<div class="line">        output_results(<a class="code" href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (active_set == active_set_old)</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        active_set_old = active_set;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step41</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep41.html">Step41</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-41&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      ObstacleProblem&lt;2&gt; obstacle_problem;</div>
<div class="line">      obstacle_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="adistributed__0_8txt_html_adeac996b7de9cb86911e504716172e83"><div class="ttname"><a href="distributed__0_8txt.html#adeac996b7de9cb86911e504716172e83">system</a></div><div class="ttdeci">if we even only hold bytes per line in this sparsity we ll need GB for this object even if every single line is empty Of only million lines will be non for which we need MB plus whatever is necessary to store the actual column indices of nonzero entries Let s say we have a moderately complex problem with entries per for each of which we store the column index worth then we ll need bytes for each of the million lines that correspond to the degrees of freedom we for a total of GB And we ll need bytes for each of the million lines that we don t for a total of GB It is clear that this ratio doesn t become any better if we go to even higher numbers of processors *The solution to this problem is to really only use any memory at all for those parts of the linear system that we or need for some other reason For all other we must know that they but we can not set up any part of our data structure To this there exists a class called IndexSet that denotes a set of indices which we care for and for which we may have to allocate memory The data structures for sparsity patterns constraint matrices matrices and vector can be initialized with these IndexSet objects to really only care for those rows or entries that correspond to indices in the index set and not care about all others These objects will then ask how many indices exist in the set allocate memory for each one of and when you want to access data for global degree of freedom[2.x.28] you will be redirected to the result of calling[2.x.29] with index[2.x.30] instead Accessing data for elements[2.x.31] for which[2.x.32] is false will yield an error *The remaining question is how to identify the set of indices that correspond to degrees of freedom we need to worry about on each processor To this you can use the[2.x.33] function to get at all the indices a processor owns Note that this is a subset of the degrees of freedom that are defined on the locally owned one sometimes needs the set of all degrees of freedom on the locally owned subdomain as well as the adjacent ghost cells This information is provided by the[2.x.35] function ***A typical parallel application is dealing with two different kinds of parallel but there are of course different vector types that can each represent both ghosted vectors are typically used for data error input in integration This is because in these one typically needs access not only to[2.x.39] locally owned dofs but also to[2.x.40] locally active dofs and sometimes to[2.x.41] locally relevant and their values may not be stored in non ghosted vectors on the processor that needs them The operations listed above also only require read only access to and ghosted vectors are therefore usable in these contexts *On the other vectors without ghost entries are used in all other places like or any other form of manipulation These are typically write only operations and therefore need not have read access to vector elements that may be owned by another processor *You can copy between vectors with and without ghost the only class equipped to deal with the situation just explained is DynamicSparsityPattern A version of the function[2.x.45] exists that takes an IndexSet argument that indicates which lines of the sparsity pattern to allocate memory for In other it is safe to create such an object that will report as its size but in fact only stores only as many rows as the index set has elements You can then use the usual function[2.x.46] to build the sparsity pattern that results from assembling on the locally owned portion of the mesh The resulting object can be used to initialize a PETSc or Trilinos matrix which support very large object sizes through completely distributed storage The matrix can then be assembled by only looping over those cells owned by the current processor *The only thing to pay attention to is for which degrees of freedom the sparsity needs to store entries These in the ones we could possibly store values to in the matrix upon assembly It is clear that these are certainly the locally active degrees of it may also be possible to write to entries that are located on ghost cells you need to pass the index set that results from[2.x.47] upon initializing the sparsity pattern ***When creating the sparsity pattern as well as when assembling the linear system</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00070">distributed_0.txt:70</a></div></div>
<div class="ttc" id="apolynomial__0_8txt_html_af1258c87f1d73d29bd17331843ac1d25"><div class="ttname"><a href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a></div><div class="ttdeci">namespace in which classes relating to the description of d polynomial spaces are declared ***Base class for all D polynomials A polynomial is represented in this class by its coefficients which are set through the constructor or by derived classes There are two paths for evaluation of polynomials One is based on the coefficients which are evaluated through the Horner scheme which is a robust general purpose scheme An alternative and more stable evaluation of high degree polynomials with roots in the unit interval is provided by a product in terms of the roots This form is available for special polynomials such as Lagrange polynomials or Legendre polynomials and used with the respective constructor To obtain this more stable evaluation form the constructor with the roots in form of a Lagrange polynomial must be used In case a manipulation is done that changes the roots the representation is switched to the coefficient form This class is a typical example of a possible template argument for the TensorProductPolynomials class **Constructor The coefficients of the polynomial are passed as and denote the i e the first element of the array denotes the constant the second the linear and so on The degree of the polynomial represented by this object is thus the number of elements in the&lt; tt &gt; coefficient&lt;/tt &gt; array minus one **Constructor creating a zero polynomial of degree *[2.x.3] *Constructor for a Lagrange polynomial and its point of evaluation The idea is to where j is the evaluation point specified as argument and the support points contain all the evaluation is based on products of the whereas the Horner scheme is used for polynomials in the coefficient form **Return the values and the derivatives of the Polynomial at point&lt; tt &gt; x&lt;/tt &gt;&lt; tt &gt; i</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__0_8txt_source.html#l00024">polynomial_0.txt:24</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a79cbe2f02f8dfb85026c71d783dbb703"><div class="ttname"><a href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out__dof__data_8h_source.html#l01096">data_out_dof_data.h:1096</a></div></div>
<div class="ttc" id="aclassIndexSet_html"><div class="ttname"><a href="classIndexSet.html">IndexSet</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l00068">index_set.h:68</a></div></div>
<div class="ttc" id="aclassFEValues_html_a21f914e63d588e2652a9514620653d77"><div class="ttname"><a href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell)</div></div>
<div class="ttc" id="adofs_2dof__handler__0_8txt_html_aae1f8d9ad7eda22eb5458605a6db742d"><div class="ttname"><a href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a></div><div class="ttdeci">this information can therefore be used upon construction of the SparsityPattern object The returned number is not really the maximum number but an estimate based on the finite element and the maximum number of cells meeting at a vertex The number holds for the constrained matrix as well The determination of the number of couplings can be done by simple picture drawing An example can be found in the implementation of this function *This function is most often used to determine the maximal row length for sparsity patterns while the estimates returned by this function are rather accurate in they are often significantly too high leading the SparsityPattern class to allocate much too much memory in some cases Unless someone comes around to improving the present function for d there is not very much one can do about these cases The typical way to work around this problem is to use an intermediate compressed sparsity pattern that only allocates memory on demand Refer to the[2.x.89] and[2.x.90] example programs on how to do this The problem is also discussed in the documentation of the module on *[2.x.91] *Return the number of degrees of freedom located on the boundary another dof on the boundary can couple with The number is the same as for all cells on this level are further then this function returns[2.x.98] so that loops of the kind **have zero iterations</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler__0_8txt_source.html#l00175">dof_handler_0.txt:175</a></div></div>
<div class="ttc" id="anewton__0_8txt_html_af4dc1cb00f59a52e48df46a4c205a8e6"><div class="ttname"><a href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a></div><div class="ttdeci">*Operator class performing Newton s iteration with standard step size control and adaptive matrix generation This class performs a Newton iteration up to convergence determined by control If after an update the norm of the residual has become larger then step size control is activated and the update is subsequently divided by two until the residual actually becomes depending on the tends to be this method applies an adaptive reassembling strategy Only if the reduction factor for the residual is more than receiving the applications computing the residual and solving the linear respectively **Declare the parameters applicable to Newton s method **Read the parameters in the ParameterHandler **Initialize the pointer data_out for debugging **The actual Newton iteration The initial value is in&lt; tt &gt; which also contains the result after convergence Values in&lt; tt &gt; in&lt;/tt &gt; are not used by but will be handed down to the objects **Set the maximal residual reduction allowed without triggering assembling in the next step Return the previous value **Control object for the Newton iteration **The indicating that the matrix must be assembled anew upon start **A flag used to decide how many stepsize iteration should be made Default is the original value of Enter zero here to turn off stepsize control *Controlled by&lt; tt &gt; Stepsize iterations&lt;/tt &gt; in parameter file **Threshold for re assembling matrix If the quotient of two consecutive residuals is smaller than this the system matrix is not assembled in this step *This parameter should be adjusted to the residual gain of the inner solver The default values is resulting in reassembling in every Newton step **Print update and updated solution after each step into file&lt; tt &gt; Newton_NNN&lt;/tt &gt; **Write debug output to[2.x.3] the higher the number</div><div class="ttdef"><b>Definition:</b> <a href="newton__0_8txt_source.html#l00034">newton_0.txt:34</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00077">fe_update_flags.h:77</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1Vector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__vector_8h_source.html#l00280">trilinos_vector.h:280</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_afec1b694405cadb2d251275096ad3563"><div class="ttname"><a href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a></div><div class="ttdeci">if we even only hold bytes per line in this sparsity we ll need GB for this object even if every single line is empty Of only million lines will be non for which we need MB plus whatever is necessary to store the actual column indices of nonzero entries Let s say we have a moderately complex problem with entries per for each of which we store the column index worth then we ll need bytes for each of the million lines that correspond to the degrees of freedom we for a total of GB And we ll need bytes for each of the million lines that we don t for a total of GB It is clear that this ratio doesn t become any better if we go to even higher numbers of processors *The solution to this problem is to really only use any memory at all for those parts of the linear system that we or need for some other reason For all other we must know that they but we can not set up any part of our data structure To this there exists a class called IndexSet that denotes a set of indices which we care for and for which we may have to allocate memory The data structures for sparsity patterns constraint matrices matrices and vector can be initialized with these IndexSet objects to really only care for those rows or entries that correspond to indices in the index set and not care about all others These objects will then ask how many indices exist in the set allocate memory for each one of and when you want to access data for global degree of freedom[2.x.28] you will be redirected to the result of calling[2.x.29] with index[2.x.30] instead Accessing data for elements[2.x.31] for which[2.x.32] is false will yield an error *The remaining question is how to identify the set of indices that correspond to degrees of freedom we need to worry about on each processor To this you can use the[2.x.33] function to get at all the indices a processor owns Note that this is a subset of the degrees of freedom that are defined on the locally owned one sometimes needs the set of all degrees of freedom on the locally owned subdomain as well as the adjacent ghost cells This information is provided by the[2.x.35] function ***A typical parallel application is dealing with two different kinds of parallel but there are of course different vector types that can each represent both ghosted vectors are typically used for data output</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00059">distributed_0.txt:59</a></div></div>
<div class="ttc" id="anamespaceLocalIntegrators_1_1L2_html_a1c15243765304a803037988b5561627d"><div class="ttname"><a href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">LocalIntegrators::L2::mass_matrix</a></div><div class="ttdeci">void mass_matrix(FullMatrix&lt; double &gt; &amp;M, const FEValuesBase&lt; dim &gt; &amp;fe, const double factor=1.)</div><div class="ttdef"><b>Definition:</b> <a href="integrators_2l2_8h_source.html#l00056">l2.h:56</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__cg_8h_source.html#l00088">solver_cg.h:88</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a8fba07b9a84b89e6be225f5f95c3e355"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div><div class="ttdeci">the program is just and one can not intelligently work around that *It is sometimes useful to change the behavior of the[2.x.6] macro from aborting a program to throwing exceptions On the other exceptions are not allowed to propagate out of destructors of classes For this there is a variant of the called[2.x.7] that can be used in destructors These use cases are discussed further down below on this page **Dynamic such as whether an output file can be written to *These are things that shouldn t be checked because it is not guaranteed that a program for which the condition is satisfied in a debug mode run</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00022">exceptions_0.txt:22</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespaceUtilities_html_a6195c5f009ea8c7c536c6ffdf108c32f"><div class="ttname"><a href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></div><div class="ttdeci">std::string int_to_string(const unsigned int value, const unsigned int digits=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00473">utilities.cc:473</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2namespace__dealii_8h_source.html#l00026">namespace_dealii.h:26</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1SparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__sparse__matrix_8h_source.html#l00505">trilinos_sparse_matrix.h:505</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00070">fe_update_flags.h:70</a></div></div>
<div class="ttc" id="aiterators__0_8txt_html_a6cf0880ba2af3a1be4aacdbbd4b90f9c"><div class="ttname"><a href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a></div><div class="ttdeci">where BaseIterator usually is one of thestandard iterators discussed above *The FilteredIterator gets an additional Predicate in its constructor and willskip all objects where this Predicate evaluates to&lt; tt &gt; false&lt;/tt &gt; Acollection of predicates already implemented can be found in the namespaceIteratorFilters ***IteratorsLoops Iterating over objects *All iterators of the same kind and iterating over thesame kind of geometrical objects traverse the mesh in the sameorder Take this code all iterators will always point to the same mesh even though&lt; tt &gt; DoFHandler&lt;/tt &gt; and&lt; tt &gt; Triangulation&lt;/tt &gt; are very different and even if the DoFHandlers are handling different finite the difference is only in the Accessor As mentioned the order in which iterators traverse the forest ofobjects is actually well but application programs should notassume any such but rather consider this an implementation detailof the library *Corresponding to above the order in which iterators traverse activeobjects is the same for all iterators in the following the difference to the previous example being that here we only consider active but theyare really rather dumb Their magic only lies in the fact that they point tosome useful in this case the Accessor For they point to anactual object that stores some data On the other the deal II when do not return a reference to an actual but returnan object that knows how to get at the data that represents cells In thisobject doesn t store itself where the vertices of a cell are or what its neighborsare it knows how to tease this sort of information from out of thearrays and tables and lists that the Triangulation class sets up to describe amesh *Accessing data that characterizes a cell is always done through the i e the expression[2.x.10] grants access to[1.x.6] attributes of this Accessor Examples of properties you can query from aniterator are ***Since dereferencing iterators yields accessor these calls are tomember etc These in turn figure out the relevant datafrom the various data structures that store this data How this is actuallydone and what data structures are used is not really of concern to authors ofapplications in deal II In by hiding the actual data structureswe are able to store data in an efficient not necessarily in a way thatmakes it easily accessible or understandable to application writers ***IteratorsTypedefs Kinds of accessors *Depending on what sort of data you want to there are different kindsof accessor and hexes that make up a triangulation</div><div class="ttdef"><b>Definition:</b> <a href="iterators__0_8txt_source.html#l00063">iterators_0.txt:63</a></div></div>
<div class="ttc" id="ageodynamics__0_8txt_html_a47b3a2cd492d04754f4796002e14ed13"><div class="ttname"><a href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a></div><div class="ttdeci">all others have started as modifications of one of the tutorial programs *The tutorial programs we propose to write will provide students and researchers with a reference implementation of current numerical technology such as higher order sophisticated linear and nonlinear stabilization etc Providing these as starting points for further development by others will also serve the goal of training a new generation of geodynamicists in modern numerical algorithms *In deal it is fairly simple to extend a set of equations by another for example an additional advected quantity that enters the existing equations as a right hand side or in one of the coefficients Since applications typically use blocked matrices rather than the one big matrix for everything it is also not complicated to find suitable linear solvers for augmented equations deal II is a good tool for trying out more complex formulations of or more complete models and their effects on the accuracy of solutions *deal II provides many interchangeable components that allow rapid prototyping of finite element kinds and stabilization or linear solvers For typically only a few lines of code have to be changed to replace low order by high order elements Through it becomes relatively simple to try out higher order a different block elimination solver</div><div class="ttdef"><b>Definition:</b> <a href="geodynamics__0_8txt_source.html#l00033">geodynamics_0.txt:33</a></div></div>
<div class="ttc" id="astep-1_8cc_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition:</b> <a href="step-1_8cc_source.html#l00086">step-1.cc:86</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga7b52b286796c23ef9ff178faf7a4b68f"><div class="ttname"><a href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">StandardExceptions::ExcNotImplemented</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcNotImplemented()</div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation&lt; dim &gt;</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="afe_2fe__q_8h_html"><div class="ttname"><a href="fe_2fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="adata__out__dof__data__0_8txt_html_a5ac6413decc3bcd12e49889ff104da8a"><div class="ttname"><a href="data__out__dof__data__0_8txt.html#a5ac6413decc3bcd12e49889ff104da8a">part</a></div><div class="ttdeci">namespace for exceptions that are used throughout the DataOut *collection of classes **Exception **Exception **Exception **Exception **Exception **Exception **Exception **Exception **Exception **The DataEntry abstract classes away the concrete data type of vectors users can attach to but it has the downside that DataOut also doesn t know the underlying scalar type of these vectors If the underlying scalar types all represent real if the vector type uses a[2.x.3] scalar then DataEntry returning a[2.x.4] for a vector entry is not sufficient **we need to provide DataOut with a way to query both the real and the imaginary part</div><div class="ttdef"><b>Definition:</b> <a href="data__out__dof__data__0_8txt_source.html#l00029">data_out_dof_data_0.txt:29</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_aafea668ad0c451ac7a0fae0f558c36d7"><div class="ttname"><a href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a></div><div class="ttdeci">in the area occupied by these artificial cells</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00037">distributed_0.txt:37</a></div></div>
<div class="ttc" id="anewton__0_8txt_html_a7ae4bec25ec0fbd4c3968d0926b5c7c6"><div class="ttname"><a href="newton__0_8txt.html#a7ae4bec25ec0fbd4c3968d0926b5c7c6">Newton</a></div><div class="ttdeci">*Operator class performing Newton s iteration with standard step size control and adaptive matrix generation This class performs a Newton iteration up to convergence determined by control If after an update the norm of the residual has become larger then step size control is activated and the update is subsequently divided by two until the residual actually becomes depending on the tends to be this method applies an adaptive reassembling strategy Only if the reduction factor for the residual is more than receiving the applications computing the residual and solving the linear respectively **Declare the parameters applicable to Newton s method **Read the parameters in the ParameterHandler **Initialize the pointer data_out for debugging **The actual Newton iteration The initial value is in&lt; tt &gt; which also contains the result after convergence Values in&lt; tt &gt; in&lt;/tt &gt; are not used by Newton</div><div class="ttdef"><b>Definition:</b> <a href="newton__0_8txt_source.html#l00012">newton_0.txt:12</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gaafbb69cc2a791ae55880fd8d57d0c1b0"><div class="ttname"><a href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a></div><div class="ttdeci">#define AssertIndexRange(index, range)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01827">exceptions.h:1827</a></div></div>
<div class="ttc" id="aclassReductionControl_html"><div class="ttname"><a href="classReductionControl.html">ReductionControl</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__control_8h_source.html#l00443">solver_control.h:443</a></div></div>
<div class="ttc" id="aconstraints__0_8txt_html_a9132c79972fe954d265b941f34bebed9"><div class="ttname"><a href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a></div><div class="ttdeci">******This module deals with constraints on degrees of freedom The central class to deal with constraints is the AffineConstraints class *Constraints typically come from several for one usually enforces them by requiring that degrees of freedom on the boundary have particular for example[2.x.3] if the boundary condition[2.x.4] requires that the finite element solution[2.x.5] at the location of degree of freedom has the value Such constraints are generated by those versions of the[2.x.6] function that take a AffineConstraints for example no normal as happens in flow problems and is handled by the[2.x.11] function or prescribed tangential as happens in electromagnetic problems and is handled by the[2.x.13] function For the former imagine for example that we are at at vertex where the normal vector has the form[2.x.14] and that the[2.x.15]</div><div class="ttdef"><b>Definition:</b> <a href="constraints__0_8txt_source.html#l00020">constraints_0.txt:20</a></div></div>
<div class="ttc" id="alac_2affine__constraints_8h_html"><div class="ttname"><a href="lac_2affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_ac2b339f054fd752a401e197097db8cfe"><div class="ttname"><a href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a></div><div class="ttdeci">********clusters ***deal II can use multiple machines connected via MPI to parallelize in addition to the parallelization within a shared memory machine discussed in the[2.x.4] module There are essentially two ways to utilize multiple but only a share of the global sparsity and solution vector is stored on each machine ****The mesh and DoF handler are also i e each processor stores only a share of the cells and degrees of freedom No processor has knowledge of the entire or solution</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00025">distributed_0.txt:25</a></div></div>
<div class="ttc" id="aparameter__handler__0_8txt_html_ad919e2b915d8e8226aef004c2d8399a8"><div class="ttname"><a href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">exception</a></div><div class="ttdeci">since default values may change in the process of program you cannot know the values of parameters not specified in the input file ****It is often convenient to have something happen as soon as a parameter value is read This could be a check that it is valid that a file that is listed in the parameter file exists **or to initiate something else in such as setting a variable outside the this action could also be initiated once all parameters are read via but it is sometimes[1.x.19] to do it right away *This is facilitated by the and can then do whatever they want with it **e save it somewhere outside the ParameterHandler in C one doesn t usually pass around the address of a but an action can be a function like object(taking a string as argument) that results from calling such as a[1.x.20] that has the form **[1.x.21] *and that is attached to a specific parameter. *A typical example of such an action would be as follows the content of the file equals the default value of the parameter the contents of files are never changed after declaration of a parameter a directory in this file system may not have a file called[2.x.20] in it In that the directory represents a subsection as declared and the directory s name will correspond to the name of the subsection It will then have no files in it at but it may have further directories in the code above will lead to a hierarchical representation of data that looks like this(the content of files is indicated at the right in a different font) this is only used when creating output for exceptions If non empty[2.x.35] is the ParameterHandler object will stop parsing lines after encountering[2.x.36] This is handy when adding extra data that shall be parsed manually If[2.x.37] the parameter handler will skip undefined sections and entries This is useful for partially parsing a parameter for example to obtain only the spatial dimension of the problem By default all entries and subsections are expected to be declared The function sets the value of all parameters it encounters in the input file to the provided value Parameters not explicitly listed in the input file are left at the value they previously which will be the default value provided to and for each parameter all associated actions that may previously have been set by or if an associated action throws an exception</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler__0_8txt_source.html#l00241">parameter_handler_0.txt:241</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a6ed7c846331069f406b8c9933c37fda4"><div class="ttname"><a href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandler&lt; dim, spacedim &gt; &amp;)</div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00266">dof_handler.h:266</a></div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00116">fe_update_flags.h:116</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_a2cbf5ad6b464871261dbd054bced18a8"><div class="ttname"><a href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">FiniteElementData::degree</a></div><div class="ttdeci">const unsigned int degree</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__base_8h_source.html#l00428">fe_base.h:428</a></div></div>
<div class="ttc" id="anumerics_2vector__tools_8h_html"><div class="ttname"><a href="numerics_2vector__tools_8h.html">vector_tools.h</a></div></div>
<div class="ttc" id="abase_2function_8h_html"><div class="ttname"><a href="base_2function_8h.html">function.h</a></div></div>
<div class="ttc" id="amultithreading__0_8txt_html_a33468e75b7ea6d2e64b7e88c6ff1217a"><div class="ttname"><a href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a></div><div class="ttdeci">namespace are implemented the way they are More information on their implementation can be found in the[2.x.72] WorkStream paper To see the WorkStream class used in practice on tasks like the ones outlined above take a look at or[2.x.78] tutorial programs *To begin given the brief description the way the[2.x.79] function could then be written is like this(note that this is not quite the correct syntax, as will be described below) we recycle these objects after they have been used by[2.x.101] and feed them back into another instance of[2.x.102]</div><div class="ttdef"><b>Definition:</b> <a href="multithreading__0_8txt_source.html#l00171">multithreading_0.txt:171</a></div></div>
<div class="ttc" id="anamespaceStep41_html"><div class="ttname"><a href="namespaceStep41.html">Step41</a></div><div class="ttdef"><b>Definition:</b> <a href="step-41_8cc_source.html#l00053">step-41.cc:53</a></div></div>
<div class="ttc" id="abase_2index__set_8h_html"><div class="ttname"><a href="base_2index__set_8h.html">index_set.h</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a373fbdacd8c486e675b8d2bff8943192"><div class="ttname"><a href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global</a></div><div class="ttdeci">void distribute_local_to_global(const InVector &amp;local_vector, const std::vector&lt; size_type &gt; &amp;local_dof_indices, OutVector &amp;global_vector) const</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02250">affine_constraints.h:2250</a></div></div>
<div class="ttc" id="aconstraints__0_8txt_html_a5abc878123b65e2a7a16e57bba0e282e"><div class="ttname"><a href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a></div><div class="ttdeci">******This module deals with constraints on degrees of freedom The central class to deal with constraints is the AffineConstraints class *Constraints typically come from several for one usually enforces them by requiring that degrees of freedom on the boundary have particular for example[2.x.3] if the boundary condition[2.x.4] requires that the finite element solution[2.x.5] at the location of degree of freedom has the value Such constraints are generated by those versions of the[2.x.6] function that take a AffineConstraints for example no normal as happens in flow problems and is handled by the[2.x.11] function or prescribed tangential as happens in electromagnetic problems and is handled by the[2.x.13] function For the former imagine for example that we are at at vertex where the normal vector has the form[2.x.14] and that and[2.x.17] components of the flow field at this vertex are associated with degrees of and Then the no normal flux condition means that we need to have the condition[2.x.18] The prescribed tangential component leads to similar constraints though there is often something on the right hand side ****If you have hanging node constraints</div><div class="ttdef"><b>Definition:</b> <a href="constraints__0_8txt_source.html#l00020">constraints_0.txt:20</a></div></div>
<div class="ttc" id="alac_2trilinos__precondition_8h_html"><div class="ttname"><a href="lac_2trilinos__precondition_8h.html">trilinos_precondition.h</a></div></div>
<div class="ttc" id="aclassDataOutInterface_html_acad99726038e4fca7f605fdffb3317e4"><div class="ttname"><a href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">DataOutInterface::write_vtk</a></div><div class="ttdeci">void write_vtk(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07221">data_out_base.cc:7221</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga0d685aad996180f9851183ae3e29019a"><div class="ttname"><a href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">StandardExceptions::ExcIndexRange</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcIndexRange(int arg1, int arg2, int arg3)</div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1PreconditionAMG_html"><div class="ttname"><a href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01391">trilinos_precondition.h:1391</a></div></div>
<div class="ttc" id="alac_2trilinos__vector_8h_html"><div class="ttname"><a href="lac_2trilinos__vector_8h.html">trilinos_vector.h</a></div></div>
<div class="ttc" id="avector__tools__point__value__0_8txt_html_ac7a5c2ceb5c739d5b51cc7e0eee8100a"><div class="ttname"><a href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a></div><div class="ttdeci">*Assembling of right hand sides **Create a right hand side vector for a point source at point[2.x.1] In other it creates a vector[2.x.2] so that[2.x.3] where[2.x.4] are the shape functions described by[2.x.5] and[2.x.6] is the point at which the delta function is located Prior content of the given[2.x.7] vector is deleted This function is for the case of a scalar finite element This function is typically used in one of these two with different values for right hand sides or and then evaluate the solution at the same point every time You could do this by calling[2.x.8] after each solve</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__point__value__0_8txt_source.html#l00015">vector_tools_point_value_0.txt:15</a></div></div>
<div class="ttc" id="alac_2dynamic__sparsity__pattern_8h_html"><div class="ttname"><a href="lac_2dynamic__sparsity__pattern_8h.html">dynamic_sparsity_pattern.h</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gae9a45f517af1401c50811a11083f9114"><div class="ttname"><a href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">StandardExceptions::ExcMessage</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcMessage(std::string arg1)</div></div>
<div class="ttc" id="amapping__q__cache__0_8txt_html_ad70e0fe32f41f61653b79c84cbeedbee"><div class="ttname"><a href="mapping__q__cache__0_8txt.html#ad70e0fe32f41f61653b79c84cbeedbee">lambda</a></div><div class="ttdeci">*This class implements a caching strategy for objects of the MappingQ family in terms of the[2.x.0] which is used in all operations of MappingQGeneric The information of the mapping is pre computed by the[2.x.1] function *The use of this class is discussed extensively in *[2.x.2] **Constructor[2.x.3] denotes the polynomial degree of the polynomials that are used to map cells from the reference to the real cell **Copy constructor **Destructor see *[2.x.4] *Returns[2.x.5] because the preservation of vertex locations depends on the mapping handed to the where[2.x.12] is the polynomial degree of the and it must be in the order the mapping or FE_Q sort their i all[2.x.13] vertex points then the points on the and hexes according to the usual hierarchical numbering No attempt is made to validate these points except for the number of given points *If multiple threads are this function will run in invoking the function passed in several times in case[2.x.15] the user code must make sure that the typically a lambda</div><div class="ttdef"><b>Definition:</b> <a href="mapping__q__cache__0_8txt_source.html#l00024">mapping_q_cache_0.txt:24</a></div></div>
<div class="ttc" id="aclassBoundaryValues_html_a45af33d412a06517009ba6f342340256"><div class="ttname"><a href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-4_8cc_source.html#l00106">step-4.cc:106</a></div></div>
<div class="ttc" id="aclassBoundaryValues_html"><div class="ttname"><a href="classBoundaryValues.html">BoundaryValues</a></div><div class="ttdef"><b>Definition:</b> <a href="step-4_8cc_source.html#l00086">step-4.cc:86</a></div></div>
<div class="ttc" id="anamespaceStep8_html_a8cfe56efd5e932e7421d357e26eab267"><div class="ttname"><a href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">Step8::right_hand_side</a></div><div class="ttdeci">void right_hand_side(const std::vector&lt; Point&lt; dim &gt;&gt; &amp;points, std::vector&lt; Tensor&lt; 1, dim &gt;&gt; &amp;values)</div><div class="ttdef"><b>Definition:</b> <a href="step-8_8cc_source.html#l00090">step-8.cc:90</a></div></div>
<div class="ttc" id="aclassDataOut_html_a087f63e22f0614bca326dbdca288c646"><div class="ttname"><a href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01071">data_out.cc:1071</a></div></div>
<div class="ttc" id="abase_2index__set_8h_html_ad28b2e725afda38ffdef1bf61d5cadd4"><div class="ttname"><a href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a></div><div class="ttdeci">IndexSet complete_index_set(const IndexSet::size_type N)</div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l01094">index_set.h:1094</a></div></div>
<div class="ttc" id="avector__0_8txt_html_aaf255149898cc5cea8c1fa1e76fffe6f"><div class="ttname"><a href="vector__0_8txt.html#aaf255149898cc5cea8c1fa1e76fffe6f">v</a></div><div class="ttdeci">0 v</div><div class="ttdef"><b>Definition:</b> <a href="vector__0_8txt_source.html#l00062">vector_0.txt:62</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a69730bc7f91dd1be17fd083a66514e73"><div class="ttname"><a href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a></div><div class="ttdeci">their purpose is merely to keepdeal II as uniform as possible Uniformity reduces the number of bugs weproduce because we for always assume that input arguments comebefore output arguments of a function call They also simplify reading codebecause some things become clear already by looking at the style a piece ofcode is without having to look up the exact definition of something **deal II uses[2.x.2] to normalize indentation Astyle file is provided at ***Before a you should run **on each of your files This will make sure indentation is conforming to thestyle guidelines outlined in this page *This is cumbersome and more you can just run **in whatever directory you set up the library to be compiled to indent allsource files that have been changed recently If you want to make sure thatthe indenting is correct for all your you might want to set up apre commit hook One way to do is to copy[2.x.4] to[2.x.5] and make sure it isexecutable *If the system you are working on has more than one version of[2.x.6] degrees of freedom</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00018">coding_conventions_0.txt:18</a></div></div>
<div class="ttc" id="aclassDynamicSparsityPattern_html"><div class="ttname"><a href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2dynamic__sparsity__pattern_8h_source.html#l00340">dynamic_sparsity_pattern.h:340</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ab2562d41bb26f362043f9719a8cd9b87"><div class="ttname"><a href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></div><div class="ttdeci">void interpolate_boundary_values(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::map&lt; types::boundary_id, const Function&lt; spacedim, number &gt; * &gt; &amp;function_map, std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
<div class="ttc" id="aclassFunction_html_acbfcab66b2fc63bfea59268f40772bb4"><div class="ttname"><a href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">Function::value</a></div><div class="ttdeci">virtual RangeNumberType value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const</div></div>
<div class="ttc" id="adofs_2dof__tools_8h_html"><div class="ttname"><a href="dofs_2dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="astep-2_8cc_html_ab108b7b7bca84a81aceda045aaef1961"><div class="ttname"><a href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a></div><div class="ttdeci">void make_grid(Triangulation&lt; 2 &gt; &amp;triangulation)</div><div class="ttdef"><b>Definition:</b> <a href="step-2_8cc_source.html#l00038">step-2.cc:38</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1PreconditionAMG_html_af36504290094ae83e3d0ff50c03d548a"><div class="ttname"><a href="classTrilinosWrappers_1_1PreconditionAMG.html#af36504290094ae83e3d0ff50c03d548a">TrilinosWrappers::PreconditionAMG::initialize</a></div><div class="ttdeci">void initialize(const SparseMatrix &amp;matrix, const AdditionalData &amp;additional_data=AdditionalData())</div><div class="ttdef"><b>Definition:</b> <a href="trilinos__precondition__ml_8cc_source.html#l00222">trilinos_precondition_ml.cc:222</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a602682024ec652b990be121b5665f8ce"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a></div><div class="ttdeci">&lt;/tt &gt; **If the&lt; tt &gt;&lt;/tt &gt; preprocessor directive is set</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00031">exceptions_0.txt:31</a></div></div>
<div class="ttc" id="aadvection__0_8txt_html_a79a3cbbb7583dd309bf1b14dc20895b6"><div class="ttname"><a href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a></div><div class="ttdeci">**its DG formulations All advection operators depend on an advection velocity denoted by[1.x.0] in the formulas below It is denoted as&lt; tt &gt; velocity&lt;/tt &gt; in the parameter lists The functions cell_matrix() and both upwind_value_matrix() are taking the equation in weak form</div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00039">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="aclassRightHandSide_html"><div class="ttname"><a href="classRightHandSide.html">RightHandSide</a></div><div class="ttdef"><b>Definition:</b> <a href="step-4_8cc_source.html#l00076">step-4.cc:76</a></div></div>
<div class="ttc" id="abase_2quadrature__lib_8h_html"><div class="ttname"><a href="base_2quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_a8f384576a64c89a6fa8352847523e340"><div class="ttname"><a href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for n_q_points</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00537">fe_evaluation_0.txt:537</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassQTrapezoid_html"><div class="ttname"><a href="classQTrapezoid.html">QTrapezoid</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00126">quadrature_lib.h:126</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a7b3d3f295bb56d6cd6856bdc6cbe8a01"><div class="ttname"><a href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">AffineConstraints::distribute</a></div><div class="ttdeci">void distribute(VectorType &amp;vec) const</div></div>
<div class="ttc" id="aclassAffineConstraints_html_addd15bc409c61d6f795f0132c574335b"><div class="ttname"><a href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">AffineConstraints::clear</a></div><div class="ttdeci">void clear()</div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00124">fe_update_flags.h:124</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01581">exceptions.h:1581</a></div></div>
<div class="ttc" id="alac_2full__matrix_8h_html"><div class="ttname"><a href="lac_2full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="alac_2solver__cg_8h_html"><div class="ttname"><a href="lac_2solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_acea0cbcd68e52ce8113d1134b87de403"><div class="ttname"><a href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a></div><div class="ttdeci">void hyper_cube(Triangulation&lt; dim, spacedim &gt; &amp;tria, const double left=0., const double right=1., const bool colorize=false)</div></div>
<div class="ttc" id="aclassStep41_1_1ObstacleProblem_html_aa3ecce2b0c00868c513eef0f9ab38509"><div class="ttname"><a href="classStep41_1_1ObstacleProblem.html#aa3ecce2b0c00868c513eef0f9ab38509">Step41::ObstacleProblem::ObstacleProblem</a></div><div class="ttdeci">ObstacleProblem()</div><div class="ttdef"><b>Definition:</b> <a href="step-41_8cc_source.html#l00152">step-41.cc:152</a></div></div>
<div class="ttc" id="afe__q__0_8txt_html_a1a8eaafa20c4d8c9ab128b62a984738c"><div class="ttname"><a href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a></div><div class="ttdeci">*Implementation of a scalar Lagrange finite element[2.x.0] that yields the finite element space of piecewise polynomials of degree[2.x.1] in each coordinate direction This class is realized using tensor product polynomials based on D Lagrange polynomials with Gauss or given support points *The standard constructor of this class takes the degree[2.x.2] of this finite element it can take a quadrature formula[2.x.3] defining the support points of the Lagrange interpolation in one coordinate direction *For more information about the&lt; tt &gt; spacedim&lt;/tt &gt; template parameter check the documentation of FiniteElement or the one of Triangulation **The constructor creates a TensorProductPolynomials object that includes the tensor product of[2.x.4] polynomials of degree[2.x.5] This[2.x.6] object provides all values and derivatives of the shape functions In case a quadrature rule is the constructor creates a TensorProductPolynomials object that includes the tensor product of[2.x.7] polynomials with the support points from *[2.x.8] Furthermore the constructor fills the[2.x.9] the[2.x.10] equidistant support points at i where one polynomial is one and all the others are zero For higher polynomial degrees</div><div class="ttdef"><b>Definition:</b> <a href="fe__q__0_8txt_source.html#l00009">fe_q_0.txt:9</a></div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_ac26de0c059200523177bb1d92cc25d00"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a></div><div class="ttdeci">unsigned int n_mpi_processes(const MPI_Comm &amp;mpi_communicator)</div><div class="ttdef"><b>Definition:</b> <a href="mpi_8cc_source.html#l00117">mpi.cc:117</a></div></div>
<div class="ttc" id="anamespacenumbers_html_a8ae36952c7e0cc778b47b5371b3aeff1"><div class="ttname"><a href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a></div><div class="ttdeci">static const unsigned int invalid_unsigned_int</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00179">types.h:179</a></div></div>
<div class="ttc" id="astep-69_8cc_html_a66a64d07b4db87c87b639bdcf7b18c82"><div class="ttname"><a href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; local_dof_indices</div><div class="ttdef"><b>Definition:</b> <a href="step-69_8cc_source.html#l00534">step-69.cc:534</a></div></div>
<div class="ttc" id="alac_2vector_8h_html"><div class="ttname"><a href="lac_2vector_8h.html">vector.h</a></div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point&lt; dim &gt;</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a4f7cb22b3c971599a839fddc988ef92a"><div class="ttname"><a href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">AffineConstraints::set_inhomogeneity</a></div><div class="ttdeci">void set_inhomogeneity(const size_type constrained_dof_index, const number value)</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02075">affine_constraints.h:2075</a></div></div>
<div class="ttc" id="apreconditioners__0_8txt_html_abebc9af399f7664771e26564a49c8dc1"><div class="ttname"><a href="preconditioners__0_8txt.html#abebc9af399f7664771e26564a49c8dc1">iteration</a></div><div class="ttdeci">*****Preconditioners are used to accelerate the iterative solution of linear systems Typical preconditioners are Gauss or but the library also supports more complex ones such as Vanka or incomplete LU sparse direct solvers can be used as preconditioners when available *Broadly preconditioners are which are multiplied with a matrix to improve conditioning The idea that the preconditioned system[1.x.1] is much easier to solve than the original system[1.x.2] What this means exactly depends on the structure of the matrix and cannot be discussed here in generality For positive definite matrices[1.x.3] it means that the spectral condition Richardson iteration</div><div class="ttdef"><b>Definition:</b> <a href="preconditioners__0_8txt_source.html#l00009">preconditioners_0.txt:9</a></div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_ad3b9cdeadeb3bcdb52af5db70c041a6e"><div class="ttname"><a href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for can be different if such as FE_DGP **static The number of degrees of freedom of all components determined from the given template argument fe_degree Note that the actual number of degrees of freedom dofs_per_cell can be different if such as FE_DGP **static The number of degrees of freedom of all components determined from the given template argument fe_degree Note that the actual number of degrees of freedom dofs_per_cell can be different if such as FE_DGP **Constructor Takes all data stored in MatrixFree If applied to problems with more than one finite element or more than one quadrature formula selected during construction of[2.x.343] the appropriate component can be selected by the optional arguments[2.x.344] matrix_free Data object that contains all data[2.x.345] dof_no If matrix_free was set up with multiple DoFHandler this parameter selects to which DoFHandler AffineConstraints pair the given evaluator should be attached to[2.x.346] quad_no If matrix_free was set up with multiple Quadrature this parameter selects the appropriate number of the quadrature formula[2.x.347] first_selected_component If the dof_handler selected by dof_no uses an FESystem consisting of more than one this parameter allows for selecting the component where the current evaluation routine should start Note that one evaluator does not support combining different shape functions in different components In other the same base element of a FESystem needs to be set for the components between[2.x.348] and[2.x.349][2.x.350] active_fe_index If matrix_free was set up with DoFHandler objects with[2.x.351] this parameter selects to which DoFHandler AffineConstraints pair the given evaluator should be attached to[2.x.352] active_quad_index If matrix_free was set up with[2.x.353] this parameter selects the appropriate number of the quadrature formula **Constructor Takes all data stored in MatrixFree for a given cell which allows to automatically identify the active_fe_index and active_quad_index in case of a p adaptive strategy The rest of the arguments are the same as in the constructor above **Constructor that comes with reduced functionality and works similar as FEValues The arguments are similar to the ones passed to the constructor of with the notable difference that FEEvaluation expects a one dimensional quadrature instead of a[2.x.354] dimensional one The finite element can be both scalar or vector but this method always only selects a scalar base element at a the optional argument[2.x.356] allows to specify the index of the base element to be used for evaluation Note that the internal data structures always assume that the base element is non primitive are not supported currently As known from a call to the reinit method with a[2.x.357] is necessary to make the geometry and degrees of freedom of the current class known::If the iterator includes DoFHandler the initialization allows to also read from or write to vectors in the standard way for[2.x.359] types for one cell at a time this approach is much slower than the path with MatrixFree with MPI since index translation has to be done As only one cell at a time is this method does not vectorize over several but only possibly within the element if the evaluate integrate routines are combined inside user an object of type i the underlying mapping and quadrature points do only need to be evaluated once Make sure to not pass an optional object around when you intend to use the FEEvaluation object in parallel to the given one because otherwise the intended sharing may create race conditions **Copy constructor If FEEvaluationBase was constructed from a fe</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00555">fe_evaluation_0.txt:555</a></div></div>
<div class="ttc" id="alac_2trilinos__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2trilinos__sparse__matrix_8h.html">trilinos_sparse_matrix.h</a></div></div>
<div class="ttc" id="aclassQuadrature_html_af9f7d82770fa8126e19113f3e3db755b"><div class="ttname"><a href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">Quadrature::size</a></div><div class="ttdeci">unsigned int size() const</div></div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a11139b28db021be1d2b762c3c5275ee4"><div class="ttname"><a href="classAffineConstraints.html#a11139b28db021be1d2b762c3c5275ee4">AffineConstraints::add_line</a></div><div class="ttdeci">void add_line(const size_type line_n)</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02001">affine_constraints.h:2001</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ad83f9d9d8b603ed71c3483de199bc7a7"><div class="ttname"><a href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a></div><div class="ttdeci">their purpose is merely to keepdeal II as uniform as possible Uniformity reduces the number of bugs weproduce because we for always assume that input arguments comebefore output arguments of a function call They also simplify reading codebecause some things become clear already by looking at the style a piece ofcode is without having to look up the exact definition of something **deal II uses[2.x.2] to normalize indentation Astyle file is provided at ***Before a you should run **on each of your files This will make sure indentation is conforming to thestyle guidelines outlined in this page *This is cumbersome and more you can just run **in whatever directory you set up the library to be compiled in</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00013">coding_conventions_0.txt:13</a></div></div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2function_8h_source.html#l00140">function.h:140</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ac639e1db0b03fc797eca55e266afa976"><div class="ttname"><a href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per cell</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="ascalapack__0_8txt_html_abc6ecee32660d1fa6d6157325220179a"><div class="ttname"><a href="scalapack__0_8txt.html#abc6ecee32660d1fa6d6157325220179a">index</a></div><div class="ttdeci">[2.x.71] and column index=[2.x.72] . **************- The global row and column index of the first element of the submatrix B is provided by[2.x.73] with row index=[2.x.74] and column index=[2.x.75] . **************- The dimension of the submatrix to be copied is given by[2.x.76] with number of rows=[2.x.77] and number of columns=[2.x.78] . If it is necessary to copy complete matrices with an identical block-cyclic distribution, use[2.x.79] &amp;dest) with only one argument to avoid communication. The underlying process grids of the matrices[2.x.80] and[2.x.81] must have been built with the same MPI communicator. *[0.x.17] *Transposing assignment:[2.x.82] The matrices[2.x.83] and[2.x.84] must have the same process grid. The following alignment conditions have to be fulfilled:[2.x.85] and[2.x.86] . *[0.x.18] *The operations based on the input parameter[2.x.87] and the alignment conditions are summarized in the following table:|transpose_B|Block Sizes|Operation||:---------:|:--------------------------:|:-------------------------------------------:||false|[2.x.88][2.x.89][2.x.90]|[2.x.91]||true|[2.x.92][2.x.93][2.x.94]|[2.x.95]|The matrices[2.x.96] and[2.x.97] must have the same process grid. *[0.x.19] *Matrix-addition:[2.x.98] The matrices[2.x.99] and[2.x.100] must have the same process grid. The following alignment conditions have to be fulfilled:[2.x.101] and[2.x.102] . *[0.x.20] *Matrix-addition:[2.x.103] The matrices[2.x.104] and[2.x.105] must have the same process grid. The following alignment conditions have to be fulfilled:[2.x.106] and[2.x.107] . *[0.x.21] *Matrix-matrix-multiplication:The operations based on the input parameters and the alignment conditions are summarized in the following table:|transpose_A|transpose_B|Block Sizes|Operation||:---------:|:---------:|:-------------------------------------------:|:-------------------------------------------------------------:||false|false|[2.x.108][2.x.109][2.x.110][2.x.111][2.x.112]|[2.x.113]||false|true|[2.x.114][2.x.115][2.x.116][2.x.117][2.x.118]|[2.x.119]||true|false|[2.x.120][2.x.121][2.x.122][2.x.123][2.x.124]|[2.x.125]||true|true|[2.x.126][2.x.127][2.x.128][2.x.129][2.x.130]|[2.x.131]|It is assumed that[2.x.132] and[2.x.133] have compatible sizes and that[2.x.134] already has the right size. The matrices[2.x.135],[2.x.136] and[2.x.137] must have the same process grid. *[0.x.22] *Matrix-matrix-multiplication. The optional parameter[2.x.138] determines whether the result is stored in[2.x.139] or added to[2.x.140] . if([2.x.141][2.x.142] else[2.x.143] It is assumed that[2.x.144] and[2.x.145] have compatible sizes and that[2.x.146] already has the right size. The following alignment conditions have to be fulfilled:[2.x.147],[2.x.148] and[2.x.149] . *[0.x.23] *Matrix-matrix-multiplication using transpose of[2.x.150] . The optional parameter[2.x.151] determines whether the result is stored in[2.x.152] or added to[2.x.153] . if([2.x.154][2.x.155] else[2.x.156] It is assumed that[2.x.157] and[2.x.158] have compatible sizes and that[2.x.159] already has the right size. The following alignment conditions have to be fulfilled:[2.x.160],[2.x.161] and[2.x.162] . *[0.x.24] *Matrix-matrix-multiplication using the transpose of[2.x.163] . The optional parameter[2.x.164] determines whether the result is stored in[2.x.165] or added to[2.x.166] . if([2.x.167][2.x.168] else[2.x.169] It is assumed that[2.x.170] and[2.x.171] have compatible sizes and that[2.x.172] already has the right size. The following alignment conditions have to be fulfilled:[2.x.173],[2.x.174] and[2.x.175] . *[0.x.25] *Matrix-matrix-multiplication using transpose of[2.x.176] and[2.x.177] . The optional parameter[2.x.178] determines whether the result is stored in[2.x.179] or added to[2.x.180] . if([2.x.181][2.x.182] else[2.x.183] It is assumed that[2.x.184] and[2.x.185] have compatible sizes and that[2.x.186] already has the right size. The following alignment conditions have to be fulfilled:[2.x.187],[2.x.188] and[2.x.189] . *[0.x.26] *Stores the distributed matrix in[2.x.190] using HDF5. In case that deal.II was built without HDF5 a call to this function will cause an exception to be thrown. If HDF5 was built with MPI, parallel I/O is used to save the matrix. Otherwise, just one process will do the output. This means that internally the distributed matrix is copied to one process, which does the output. Therefore, the matrix has to fit into the memory of one process. To tweak the I/O performance, especially for parallel I/O, the user may define the optional parameter[2.x.191] All MPI processes need to call the function with the same value. The matrix is written in chunks to the file, therefore the properties of the system define the optimal chunk size. Internally, HDF5 splits the matrix into&lt; tt &gt;chunk_size.first&lt;/tt &gt; x&lt; tt &gt;chunk_size.second&lt;/tt &gt; sized blocks, with&lt; tt &gt;chunk_size.first&lt;/tt &gt; being the number of rows of a chunk and&lt; tt &gt;chunk_size.second&lt;/tt &gt; the number of columns. *[0.x.27] *Loads the distributed matrix from file[2.x.192] using HDF5. In case that deal.II was built without HDF5 a call to this function will cause an exception to be thrown. The matrix must have the same dimensions as the matrix stored in the file. If HDF5 was build with MPI, parallel I/O is used to load the matrix. Otherwise, just one process will load the matrix from storage and distribute the content to the other processes subsequently. *[0.x.28] *Compute the Cholesky factorization of the matrix using ScaLAPACK function[2.x.193] . The result of the factorization is stored in this object. *[0.x.29] *Compute the LU factorization of the matrix using ScaLAPACK function[2.x.194] and partial pivoting with row interchanges. The result of the factorization is stored in this object. *[0.x.30] *Invert the matrix by first computing a Cholesky for symmetric matrices or a LU factorization for general matrices and then building the actual inverse using[2.x.195] or[2.x.196] . If the matrix is triangular, the LU factorization step is skipped, and[2.x.197] is used directly. If a Cholesky or LU factorization has been applied previously,[2.x.198] are called directly. The inverse is stored in this object. *[0.x.31] *Computing selected eigenvalues and, optionally, the eigenvectors of the real symmetric matrix[2.x.199] . The eigenvalues/eigenvectors are selected by prescribing a range of indices[2.x.200] If successful, the computed eigenvalues are arranged in ascending order. The eigenvectors are stored in the columns of the matrix, thereby overwriting the original content of the matrix. If all eigenvalues/eigenvectors have to be computed, pass the closed interval[2.x.201] in[2.x.202] Pass the closed interval[2.x.203] if the[2.x.204] largest eigenvalues/eigenvectors are desired. *[0.x.32] *Computing selected eigenvalues and, optionally, the eigenvectors. The eigenvalues/eigenvectors are selected by prescribing a range of values[2.x.205] for the eigenvalues. If successful, the computed eigenvalues are arranged in ascending order. The eigenvectors are stored in the columns of the matrix, thereby overwriting the original content of the matrix. *[0.x.33] *Computing selected eigenvalues and, optionally, the eigenvectors of the real symmetric matrix[2.x.206] using the MRRR algorithm. The eigenvalues/eigenvectors are selected by prescribing a range of indices[2.x.207] If successful, the computed eigenvalues are arranged in ascending order. The eigenvectors are stored in the columns of the matrix, thereby overwriting the original content of the matrix. If all eigenvalues/eigenvectors have to be computed, pass the closed interval[2.x.208] in[2.x.209] Pass the closed interval[2.x.210] if the[2.x.211] largest eigenvalues/eigenvectors are desired. *[0.x.34] *Computing selected eigenvalues and, optionally, the eigenvectors of the real symmetric matrix[2.x.212] using the MRRR algorithm. The eigenvalues/eigenvectors are selected by prescribing a range of values[2.x.213] for the eigenvalues. If successful, the computed eigenvalues are arranged in ascending order. The eigenvectors are stored in the columns of the matrix, thereby overwriting the original content of the matrix. *[0.x.35] *Computing the singular value decomposition(SVD) of a matrix[2.x.214], optionally computing the left and/or right singular vectors. The SVD is written as[2.x.215] with[2.x.216] as a diagonal matrix,[2.x.217] and[2.x.218] as orthogonal matrices. The diagonal elements of[2.x.219] are the singular values of[2.x.220] and the columns of[2.x.221] and[2.x.222] are the corresponding left and right singular vectors, respectively. The singular values are returned in decreasing order and only the first[2.x.223] columns of[2.x.224] and rows of[2.x.225] are computed. Upon return the content of the matrix is unusable. The matrix[2.x.226] must have identical block cyclic distribution for the rows and column. If left singular vectors are required matrices[2.x.227] and[2.x.228] have to be constructed with the same process grid and block cyclic distribution. If right singular vectors are required matrices[2.x.229] and[2.x.230] have to be constructed with the same process grid and block cyclic distribution. To avoid computing the left and/or right singular vectors the function accepts[2.x.231] for[2.x.232] and/or[2.x.233] *[0.x.36] *Solving overdetermined or underdetermined real linear systems involving matrix[2.x.234], or its transpose[2.x.235], using a QR or LQ factorization of[2.x.236] for[2.x.237] RHS vectors in the columns of matrix[2.x.238] It is assumed that[2.x.239] has full rank:[2.x.240] . The following options are supported:********- If(!transpose) and[2.x.241] :least squares solution of overdetermined system[2.x.242] .\n Upon exit the rows[2.x.243] to[2.x.244] of[2.x.245] contain the least square solution vectors. The residual sum of squares for each column is given by the sum of squares of elements[2.x.246] to[2.x.247] in that column. **************- If(!transpose) and[2.x.248] :find minimum norm solutions of underdetermined systems[2.x.249] .\n Upon exit the columns of[2.x.250] contain the minimum norm solution vectors. **************- If(transpose) and[2.x.251] :find minimum norm solutions of underdetermined system[2.x.252] .\n Upon exit the columns of[2.x.253] contain the minimum norm solution vectors. **************- If(transpose) and[2.x.254] :least squares solution of overdetermined system[2.x.255] .\n Upon exit the rows[2.x.256] to[2.x.257] contain the least square solution vectors. The residual sum of squares for each column is given by the sum of squares of elements[2.x.258] to[2.x.259] in that column. If(!tranpose) then[2.x.260], otherwise[2.x.261] . The matrices[2.x.262] and[2.x.263] must have an identical block cyclic distribution for rows and columns. *[0.x.37] *Compute the pseudoinverse[2.x.264](Moore-Penrose inverse) of a real matrix[2.x.265] using the singular value decomposition[2.x.266] . Unlike the inverse, the pseudoinverse[2.x.267] exists for both rectangular as well as singular matrices[2.x.268] . For a rectangular[2.x.269] the pseudoinverse is computed by taking the reciprocal of each non-zero element on the diagonal, leaving the zeros in place, and then transposing[2.x.270] . For the numerical computation only the singular values[2.x.271] are taken into account. Upon successful exit, the function returns the number of singular values fulfilling that condition. That value can be interpreted as the rank of[2.x.272] . Upon return this object contains the pseudoinverse[2.x.273] . The following alignment conditions have to be fulfilled:[2.x.274] . *[0.x.38] *Estimate the condition number of a SPD matrix in the[2.x.275] -norm. The matrix has to be in the Cholesky state(see compute_cholesky_factorization()). The reciprocal of the condition number is returned in order to avoid the possibility of overflow when the condition number is very large.[2.x.276] must contain the[2.x.277] -norm of the matrix prior to calling Cholesky factorization(see l1_norm()). *[2.x.278] An alternative is to compute the inverse of the matrix explicitly and manually construct[2.x.279] . *[0.x.39] *Compute the[2.x.280] -norm of the matrix. *[0.x.40] *Compute the[2.x.281] norm of the matrix. *[0.x.41] *Compute the Frobenius norm of the matrix. *[0.x.42] *Number of rows of the[2.x.282] matrix. *[0.x.43] *Number of columns of the[2.x.283] matrix. *[0.x.44] *Number of local rows on this MPI processes. *[0.x.45] *Number of local columns on this MPI process. *[0.x.46] *Return the global row number for the given local row[2.x.284] . *[0.x.47] *Return the global column number for the given local column[2.x.285] *[0.x.48] *Read access to local element. *[0.x.49] *Write access to local element. *[0.x.50] *Scale the columns of the distributed matrix by the scalars provided in the array[2.x.286] The array[2.x.287] must have as many entries as the matrix columns. Copies of[2.x.288] have to be available on all processes of the underlying MPI communicator. *[2.x.289] The fundamental prerequisite for the[2.x.290] is that it must be possible to create an ArrayView from it index</div><div class="ttdef"><b>Definition:</b> <a href="scalapack__0_8txt_source.html#l00250">scalapack_0.txt:250</a></div></div>
<div class="ttc" id="anamespaceEuler__DG_html_a143bc64b6fa6ced9f11c148a2af3ff09"><div class="ttname"><a href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Euler_DG::Number</a></div><div class="ttdeci">double Number</div><div class="ttdef"><b>Definition:</b> <a href="step-67_8cc_source.html#l00064">step-67.cc:64</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_ac00ea19562c135512a6ff275a3cf0d8f"><div class="ttname"><a href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has this class generates all dim dimensional polynomials of the where the sum and[1.x.8] is less than or equal *[1.x.9] The i e for each dim dimensional polynomial in the polynomial space it gives the indices j</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00004">polynomial_space_0.txt:4</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_a33b522422da89e5c080e7405ad49d7c7"><div class="ttname"><a href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">FiniteElementData::n_dofs_per_cell</a></div><div class="ttdeci">unsigned int n_dofs_per_cell() const</div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut&lt; dim &gt;</a></div></div>
<div class="ttc" id="afunctions__0_8txt_html_af9f808a82e8c618e2e7a19dd08a9eae3"><div class="ttname"><a href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a></div><div class="ttdeci">****Functions are used in various places in deal for example to describe boundary coefficients in forcing or exact solutions Since closed form expressions for equations are often hard to pass along as function deal II uses the Function base class to describe these objects Essentially the interface of this base class requires derived classes to implement the ability to return the value of a function at one or a list of particular locations and function objects can then be used by algorithms like[2.x.1][2.x.2] and other functions *Some functions are needed again and and are therefore already provided in deal II This includes a function with a constant value</div><div class="ttdef"><b>Definition:</b> <a href="functions__0_8txt_source.html#l00007">functions_0.txt:7</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassRightHandSide_html_a07b87d7025c7c5feca044c5c7d4296ef"><div class="ttname"><a href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-4_8cc_source.html#l00094">step-4.cc:94</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a1611aa37f754086388ca76bcd421cce5"><div class="ttname"><a href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">AffineConstraints::close</a></div><div class="ttdeci">void close()</div></div>
<div class="ttc" id="agroup__Exceptions_html_gafc0ca7ad85b3ebd64e8e51689ac85caf"><div class="ttname"><a href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a></div><div class="ttdeci">#define AssertThrow(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01699">exceptions.h:1699</a></div></div>
<div class="ttc" id="asparse__vanka__0_8txt_html_a96771f1712564cc2701caa2fdfb4965d"><div class="ttname"><a href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">vector&lt; bool &gt;</a></div><div class="ttdeci">this elimination is done by the modification of the right hand and in the end these degrees of freedom do not occur in the matrix and solution vector any more at all *This system is solved and the values are updated into the destination vector the matrices are built up such that the degree of freedom associated with the Lagrange multiplier is the first one usually the upper left entry in the matrix is zero It is not clear to so it must persist longer than the Vanka object The same is true for the matrix The matrix[2.x.11] which is passed here may or may not be the same matrix for which this object shall act as preconditioner In it is conceivable that the preconditioner is build up for one matrix but is used for subsequent steps in a nonlinear process as where the matrix changes in each step slightly **Destructor Delete all allocated matrices **Parameters for SparseVanka **Constructor For the parameters see below **Constructor For the parameters see below[2.x.12] The use of this constructor is deprecated **the second and third parameters are ignored **Indices of those degrees of freedom that we shall work on **If the default constructor is used then this function needs to be called before an object of this class is used as preconditioner For more detail about possible parameters see the class documentation and the documentation of the[2.x.13] class After this function is called the preconditioner is ready to be only values for allowed indices are written to[2.x.27] so the application of this function only does what is announced in the general documentation if the given mask sets all values to zero The reason for providing the mask anyway is that in derived classes we may want to apply the preconditioner to parts of the matrix in order to parallelize the application it is important to only write to some slices of[2.x.28] in order to eliminate the dependencies of threads of each other If a null pointer is passed instead of a pointer to then it is assumed that we shall work on all degrees of freedom This is then equivalent to calling the function with a&lt; tt &gt; vector&lt; bool &gt;(n_dofs, true)&lt;/tt &gt;. The[2.x.30] of this class of course calls this function with a null pointer *[0.x.17] *Determine an estimate for the memory consumption(in bytes) of this object. *[0.x.18] *Pointer to the matrix. *[0.x.19] *Indices of those degrees of freedom that we shall work on. *[0.x.20] *Array of inverse matrices</div></div>
<div class="ttc" id="aclassIndexSet_html_ad28b2e725afda38ffdef1bf61d5cadd4"><div class="ttname"><a href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">IndexSet::complete_index_set</a></div><div class="ttdeci">IndexSet complete_index_set(const IndexSet::size_type N)</div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l01094">index_set.h:1094</a></div></div>
<div class="ttc" id="afe_2fe__values__0_8txt_html_a15ff2e0c168966d6ae13c4faabcec165"><div class="ttname"><a href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a></div><div class="ttdeci">we have to work a bit harder to compute this information **Default constructor Creates an invalid object **Constructor for an object that represents a single scalar component of a FEValuesBase for the shape function and quadrature point selected by the arguments[2.x.27] shape_function Number of the shape function to be evaluated Note that this number runs from zero to dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__0_8txt_source.html#l00073">fe_values_0.txt:73</a></div></div>
<div class="ttc" id="adof__tools__0_8txt_html_aa623f15672a6db0f3f730a81a5b432b4"><div class="ttname"><a href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a></div><div class="ttdeci">previous contents are not deleted **This function generates a matrix such that when a vector of data with as many elements as there are degrees of freedom of this component on the coarse grid is multiplied to this we obtain a vector with as many elements as there are global degrees of freedom on the fine grid All the elements of the other vector components of the finite element fields on the fine grid are not touched Triangulation of the fine grid can be distributed When called in each process has to have a copy of the coarse grid In this function returns transfer representation for a set of locally owned cells The output of this function is a compressed format that can be used to construct corresponding sparse transfer matrix ****Periodic boundary conditions *[2.x.121] *Insert this functions constrains all DoFs associated with the boundary described by[2.x.125] to the respective DoFs of the boundary described by[2.x.126] More the global DoF see below if[2.x.134] and[2.x.135] are not active this function loops recursively over the children of[2.x.136] and[2.x.137] If only one of the two faces is active</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__0_8txt_source.html#l00095">dof_tools_0.txt:95</a></div></div>
<div class="ttc" id="aparsed__convergence__table__0_8txt_html_a8a90f5ba57a42a3fd4c067e00f8b8aea"><div class="ttname"><a href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a></div><div class="ttdeci">****This class simplifies the construction of convergence tables reading the options for the generation of the table from a parameter file It provides a series of methods that can be used to compute the error given a reference exact solution or the difference between two numerical solutions or any other custom computation of the error given via[2.x.1] objects *An example usage of this class is given by ****The above code constructs a ParsedConvergenceTable that works for scalar and will produce an error table with and Linfty_norm norms of the error *Whenever a call to the methods the instance of this class inspects its parameters computes all norms specified by the parameter given at construction time possibly modified via a parameter file computes all extra column entries specified using the method and writes one row of the convergence table *Once you have finished with the a call to and to the the same code can be used to estimate the errors of mixed or multi physics e and one component for the pressure field p</div><div class="ttdef"><b>Definition:</b> <a href="parsed__convergence__table__0_8txt_source.html#l00020">parsed_convergence_table_0.txt:20</a></div></div>
<div class="ttc" id="agrid_2grid__generator_8h_html"><div class="ttname"><a href="grid_2grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="atable__0_8txt_html_aa889bb34debce4db8c9ace2f875bdf0d"><div class="ttname"><a href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a></div><div class="ttdeci">tables that store three or more dimensional then there is nothing you can do about the size of these if your program is parallelized via then a typical first implementation would create a table object on every process and fill it on every MPI process by reading the data from a file This is inefficient from two the data stored on every process is the and while every process needs to be able to read from a it is not necessary that every process stores its own either by re creating a copy of the table in the other processes memory space if by creating copies in shared memory once for all processes located on each of the machines used by the MPI job ******Integer type used to count the number of elements in this container **Default constructor Set all dimensions to zero **Constructor Initialize the array with the given dimensions in each index component **Constructor Initialize the array with the given dimensions in each index component</div><div class="ttdef"><b>Definition:</b> <a href="table__0_8txt_source.html#l00083">table_0.txt:83</a></div></div>
<div class="ttc" id="aclassUtilities_1_1MPI_1_1MPI__InitFinalize_html"><div class="ttname"><a href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2mpi_8h_source.html#l00836">mpi.h:836</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a02f5aa616d7b0799c538fe77d6c6c795"><div class="ttname"><a href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a></div><div class="ttdeci">i e</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00028">coding_conventions_0.txt:28</a></div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
