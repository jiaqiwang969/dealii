<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_31.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-31 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-31 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_22.html">step-22</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#TheBoussinesqequations">The Boussinesq equations</a>
        <li><a href="#Boundaryandinitialconditions">Boundary and initial conditions</a>
        <li><a href="#Solutionapproach">Solution approach</a>
      <ul>
        <li><a href="#Timestepping">Time stepping</a>
        <li><a href="#WeakformandspacediscretizationfortheStokespart">Weak form and space discretization for the Stokes part</a>
        <li><a href="#Stabilizationweakformandspacediscretizationforthetemperatureequation">Stabilization, weak form and space discretization for the temperature equation</a>
        <li><a href="#Linearsolvers">Linear solvers</a>
      <ul>
        <li><a href="#LinearsolversfortheStokesproblem">Linear solvers for the Stokes problem</a>
        <li><a href="#Linearsolversforthetemperatureequation">Linear solvers for the temperature equation</a>
      </ul>
      </ul>
        <li><a href="#Implementationdetails">Implementation details</a>
      <ul>
        <li><a href="#UsingdifferentDoFHandlerobjects">Using different DoFHandler objects</a>
        <li><a href="#UsingTrilinos">Using Trilinos</a>
      </ul>
        <li><a href="#Thetestcase">The testcase</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#Equationdata">Equation data</a>
        <li><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a>
      <ul>
        <li><a href="#ThecodeInverseMatrixcodeclasstemplate">The <code>InverseMatrix</code> class template</a>
        <li><a href="#Schurcomplementpreconditioner">Schur complement preconditioner</a>
      </ul>
        <li><a href="#ThecodeBoussinesqFlowProblemcodeclasstemplate">The <code>BoussinesqFlowProblem</code> class template</a>
        <li><a href="#BoussinesqFlowProblemclassimplementation">BoussinesqFlowProblem class implementation</a>
      <ul>
        <li><a href="#BoussinesqFlowProblemBoussinesqFlowProblem">BoussinesqFlowProblem::BoussinesqFlowProblem</a>
        <li><a href="#BoussinesqFlowProblemget_maximal_velocity">BoussinesqFlowProblem::get_maximal_velocity</a>
        <li><a href="#BoussinesqFlowProblemget_extrapolated_temperature_range">BoussinesqFlowProblem::get_extrapolated_temperature_range</a>
        <li><a href="#BoussinesqFlowProblemcompute_viscosity">BoussinesqFlowProblem::compute_viscosity</a>
        <li><a href="#BoussinesqFlowProblemsetup_dofs">BoussinesqFlowProblem::setup_dofs</a>
        <li><a href="#BoussinesqFlowProblemassemble_stokes_preconditioner">BoussinesqFlowProblem::assemble_stokes_preconditioner</a>
        <li><a href="#BoussinesqFlowProblembuild_stokes_preconditioner">BoussinesqFlowProblem::build_stokes_preconditioner</a>
        <li><a href="#BoussinesqFlowProblemassemble_stokes_system">BoussinesqFlowProblem::assemble_stokes_system</a>
        <li><a href="#BoussinesqFlowProblemassemble_temperature_matrix">BoussinesqFlowProblem::assemble_temperature_matrix</a>
        <li><a href="#BoussinesqFlowProblemassemble_temperature_system">BoussinesqFlowProblem::assemble_temperature_system</a>
        <li><a href="#BoussinesqFlowProblemsolve">BoussinesqFlowProblem::solve</a>
        <li><a href="#BoussinesqFlowProblemoutput_results">BoussinesqFlowProblem::output_results</a>
        <li><a href="#BoussinesqFlowProblemrefine_mesh">BoussinesqFlowProblem::refine_mesh</a>
        <li><a href="#BoussinesqFlowProblemrun">BoussinesqFlowProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Resultsin2d"> Results in 2d </a>
        <li><a href="#Resultsin3d"> Results in 3d </a>
        <li><a href="#Numericalexperimentstodetermineoptimalparameters"> Numerical experiments to determine optimal parameters </a>
      <ul>
        <li><a href="#Choosingicsubksubiandbeta"> Choosing <i>c<sub>k</sub></i> and beta </a>
      <ul>
        <li><a href="#ResultsforQsub1subelements">Results for Q<sub>1</sub> elements</a>
        <li><a href="#ResultsforQsub2subelements">Results for Q<sub>2</sub> elements</a>
        <li><a href="#Resultsfor3d">Results for 3d</a>
        <li><a href="#Conclusions">Conclusions</a>
      </ul>
      </ul>
        <li><a href="#Possibilitiesforextensions"> Possibilities for extensions </a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
</p>
<p><em>This program was contributed by Martin Kronbichler and Wolfgang Bangerth. <br  />
 This material is based upon work partly supported by the National Science Foundation under Award No. EAR-0426271 and The California Institute of Technology. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation or of The California Institute of Technology. </em></p>
<p><a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p><a class="anchor" id="TheBoussinesqequations"></a></p><h3>The Boussinesq equations</h3>
<p>This program deals with an interesting physical problem: how does a fluid (i.e., a liquid or gas) behave if it experiences differences in buoyancy caused by temperature differences? It is clear that those parts of the fluid that are hotter (and therefore lighter) are going to rise up and those that are cooler (and denser) are going to sink down with gravity.</p>
<p>In cases where the fluid moves slowly enough such that inertial effects can be neglected, the equations that describe such behavior are the Boussinesq equations that read as follows: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; -\rho\; \beta \; T\; \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0, \\ \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma. \end{eqnarray*}
</p>
<p> These equations fall into the class of vector-valued problems (a toplevel overview of this topic can be found in the <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> module). Here, \(\mathbf u\) is the velocity field, \(p\) the pressure, and \(T\) the temperature of the fluid. \(\varepsilon ({\mathbf u}) = \frac 12 [(\nabla{\mathbf u}) + (\nabla {\mathbf u})^T]\) is the symmetric gradient of the velocity. As can be seen, velocity and pressure solve a Stokes equation describing the motion of an incompressible fluid, an equation we have previously considered in <a class="el" href="step_22.html">step-22</a>; we will draw extensively on the experience we have gained in that program, in particular with regard to efficient linear Stokes solvers.</p>
<p>The forcing term of the fluid motion is the buoyancy of the fluid, expressed as the product of the density \(\rho\), the thermal expansion coefficient \(\beta\), the temperature \(T\) and the gravity vector \(\mathbf{g}\) pointing downward. (A derivation of why the right hand side looks like it looks is given in the introduction of <a class="el" href="step_32.html">step-32</a>.) While the first two equations describe how the fluid reacts to temperature differences by moving around, the third equation states how the fluid motion affects the temperature field: it is an advection diffusion equation, i.e., the temperature is attached to the fluid particles and advected along in the flow field, with an additional diffusion (heat conduction) term. In many applications, the diffusion coefficient is fairly small, and the temperature equation is in fact transport, not diffusion dominated and therefore in character more hyperbolic than elliptic; we will have to take this into account when developing a stable discretization.</p>
<p>In the equations above, the term \(\gamma\) on the right hand side denotes the heat sources and may be a spatially and temporally varying function. \(\eta\) and \(\kappa\) denote the viscosity and diffusivity coefficients, which we assume constant for this tutorial program. The more general case when \(\eta\) depends on the temperature is an important factor in physical applications: Most materials become more fluid as they get hotter (i.e., \(\eta\) decreases with \(T\)); sometimes, as in the case of rock minerals at temperatures close to their melting point, \(\eta\) may change by orders of magnitude over the typical range of temperatures.</p>
<p>We note that the Stokes equation above could be nondimensionalized by introducing the <a href="http://en.wikipedia.org/wiki/Rayleigh_number" target="_top">Rayleigh number</a> \(\mathrm{Ra}=\frac{\|\mathbf{g}\| \beta \rho}{\eta \kappa} \delta T L^3\) using a typical length scale \(L\), typical temperature difference \(\delta T\), density \(\rho\), thermal diffusivity \(\eta\), and thermal conductivity \(\kappa\). \(\mathrm{Ra}\) is a dimensionless number that describes the ratio of heat transport due to convection induced by buoyancy changes from temperature differences, and of heat transport due to thermal diffusion. A small Rayleigh number implies that buoyancy is not strong relative to viscosity and fluid motion \(\mathbf{u}\) is slow enough so that heat diffusion \(\kappa\nabla T\) is the dominant heat transport term. On the other hand, a fluid with a high Rayleigh number will show vigorous convection that dominates heat conduction.</p>
<p>For most fluids for which we are interested in computing thermal convection, the Rayleigh number is very large, often \(10^6\) or larger. From the structure of the equations, we see that this will lead to large pressure differences and large velocities. Consequently, the convection term in the convection-diffusion equation for \(T\) will also be very large and an accurate solution of this equation will require us to choose small time steps. Problems with large Rayleigh numbers are therefore hard to solve numerically for similar reasons that make solving the <a href="http://en.wikipedia.org/wiki/Navier-stokes_equations">Navier-Stokes equations</a> hard to solve when the <a href="http://en.wikipedia.org/wiki/Reynolds_number">Reynolds number \(\mathrm{Re}\)</a> is large.</p>
<p>Note that a large Rayleigh number does not necessarily involve large velocities in absolute terms. For example, the Rayleigh number in the earth mantle is larger than \(10^6\). Yet the velocities are small: the material is in fact solid rock but it is so hot and under pressure that it can flow very slowly, on the order of at most a few centimeters per year. Nevertheless, this can lead to mixing over time scales of many million years, a time scale much shorter than for the same amount of heat to be distributed by thermal conductivity and a time scale of relevance to affect the evolution of the earth's interior and surface structure.</p>
<dl class="section note"><dt>Note</dt><dd>If you are interested in using the program as the basis for your own experiments, you will also want to take a look at its continuation in <a class="el" href="step_32.html">step-32</a>. Furthermore, <a class="el" href="step_32.html">step-32</a> later was developed into the much larger open source code ASPECT (see <a href="https://aspect.geodynamics.org/">https://aspect.geodynamics.org/</a> ) that can solve realistic problems and that you may want to investigate before trying to morph <a class="el" href="step_31.html">step-31</a> into something that can solve whatever you want to solve.</dd></dl>
<p><a class="anchor" id="Boundaryandinitialconditions"></a></p><h3>Boundary and initial conditions</h3>
<p>Since the Boussinesq equations are derived under the assumption that inertia of the fluid's motion does not play a role, the flow field is at each time entirely determined by buoyancy difference at that time, not by the flow field at previous times. This is reflected by the fact that the first two equations above are the steady state Stokes equation that do not contain a time derivative. Consequently, we do not need initial conditions for either velocities or pressure. On the other hand, the temperature field does satisfy an equation with a time derivative, so we need initial conditions for \(T\).</p>
<p>As for boundary conditions: if \(\kappa&gt;0\) then the temperature satisfies a second order differential equation that requires boundary data all around the boundary for all times. These can either be a prescribed boundary temperature \(T|_{\partial\Omega}=T_b\) (Dirichlet boundary conditions), or a prescribed thermal flux \(\mathbf{n}\cdot\kappa\nabla T|_{\partial\Omega}=\phi\); in this program, we will use an insulated boundary condition, i.e., prescribe no thermal flux: \(\phi=0\).</p>
<p>Similarly, the velocity field requires us to pose boundary conditions. These may be no-slip no-flux conditions \(\mathbf{u}=0\) on \(\partial\Omega\) if the fluid sticks to the boundary, or no normal flux conditions \(\mathbf n \cdot \mathbf u = 0\) if the fluid can flow along but not across the boundary, or any number of other conditions that are physically reasonable. In this program, we will use no normal flux conditions.</p>
<p><a class="anchor" id="Solutionapproach"></a></p><h3>Solution approach</h3>
<p>Like the equations solved in <a class="el" href="step_21.html">step-21</a>, we here have a system of differential-algebraic equations (DAE): with respect to the time variable, only the temperature equation is a differential equation whereas the Stokes system for \(\mathbf{u}\) and \(p\) has no time-derivatives and is therefore of the sort of an algebraic constraint that has to hold at each time instant. The main difference to <a class="el" href="step_21.html">step-21</a> is that the algebraic constraint there was a mixed Laplace system of the form </p><p class="formulaDsp">
\begin{eqnarray*} \mathbf u + {\mathbf K}\lambda \nabla p &amp;=&amp; 0, \\ \nabla\cdot \mathbf u &amp;=&amp; f, \end{eqnarray*}
</p>
<p> where now we have a Stokes system </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; f, \\ \nabla\cdot \mathbf u &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> where \(\nabla \cdot \eta \varepsilon (\cdot)\) is an operator similar to the Laplacian \(\Delta\) applied to a vector field.</p>
<p>Given the similarity to what we have done in <a class="el" href="step_21.html">step-21</a>, it may not come as a surprise that we choose a similar approach, although we will have to make adjustments for the change in operator in the top-left corner of the differential operator.</p>
<p><a class="anchor" id="Timestepping"></a></p><h4>Time stepping</h4>
<p>The structure of the problem as a DAE allows us to use the same strategy as we have already used in <a class="el" href="step_21.html">step-21</a>, i.e., we use a time lag scheme: we first solve the temperature equation (using an extrapolated velocity field), and then insert the new temperature solution into the right hand side of the velocity equation. The way we implement this in our code looks at things from a slightly different perspective, though. We first solve the Stokes equations for velocity and pressure using the temperature field from the previous time step, which means that we get the velocity for the previous time step. In other words, we first solve the Stokes system for time step \(n - 1\) as </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2\eta \varepsilon ({\mathbf u}^{n-1})) + \nabla p^{n-1} &amp;=&amp; -\rho\; \beta \; T^{n-1} \mathbf{g}, \\ \nabla \cdot {\mathbf u}^{n-1} &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> and then the temperature equation with an extrapolated velocity field to time \(n\).</p>
<p>In contrast to <a class="el" href="step_21.html">step-21</a>, we'll use a higher order time stepping scheme here, namely the <a href="http://en.wikipedia.org/wiki/Backward_differentiation_formula">Backward Differentiation Formula scheme of order 2 (BDF-2 in short)</a> that replaces the time derivative \(\frac{\partial T}{\partial t}\) by the (one-sided) difference quotient \(\frac{\frac 32 T^{n}-2T^{n-1}+\frac 12 T^{n-2}}{k}\) with \(k\) the time step size. This gives the discretized-in-time temperature equation </p><p class="formulaDsp">
\begin{eqnarray*} \frac 32 T^n - k\nabla \cdot \kappa \nabla T^n &amp;=&amp; 2 T^{n-1} - \frac 12 T^{n-2} - k(2{\mathbf u}^{n-1} - {\mathbf u}^{n-2} ) \cdot \nabla (2T^{n-1}-T^{n-2}) + k\gamma. \end{eqnarray*}
</p>
<p> Note how the temperature equation is solved semi-explicitly: diffusion is treated implicitly whereas advection is treated explicitly using an extrapolation (or forward-projection) of temperature and velocity, including the just-computed velocity \({\mathbf u}^{n-1}\). The forward-projection to the current time level \(n\) is derived from a Taylor expansion, \(T^n \approx T^{n-1} + k_n \frac{\partial T}{\partial t} \approx T^{n-1} + k_n \frac{T^{n-1}-T^{n-2}}{k_n} = 2T^{n-1}-T^{n-2}\). We need this projection for maintaining the order of accuracy of the BDF-2 scheme. In other words, the temperature fields we use in the explicit right hand side are second order approximations of the current temperature field &mdash; not quite an explicit time stepping scheme, but by character not too far away either.</p>
<p>The introduction of the temperature extrapolation limits the time step by a <a href="http://en.wikipedia.org/wiki/Courant–Friedrichs–Lewy_condition">Courant-Friedrichs-Lewy (CFL) condition</a> just like it was in <a class="el" href="step_21.html">step-21</a>. (We wouldn't have had that stability condition if we treated the advection term implicitly since the BDF-2 scheme is A-stable, at the price that we needed to build a new temperature matrix at each time step.) We will discuss the exact choice of time step in the <a href="#Results">results section</a>, but for the moment of importance is that this CFL condition means that the time step size \(k\) may change from time step to time step, and that we have to modify the above formula slightly. If \(k_n,k_{n-1}\) are the time steps sizes of the current and previous time step, then we use the approximations </p><p class="formulaDsp">
\begin{align*} \frac{\partial T}{\partial t} \approx \frac 1{k_n} \left( \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} T^{n} - \frac{k_n+k_{n-1}}{k_{n-1}}T^{n-1} + \frac{k_n^2}{k_{n-1}(k_n+k_{n-1})} T^{n-2} \right) \end{align*}
</p>
<p> and </p><p class="formulaDsp">
\begin{align*} T^n \approx T^{n-1} + k_n \frac{\partial T}{\partial t} \approx T^{n-1} + k_n \frac{T^{n-1}-T^{n-2}}{k_{n-1}} = \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2}, \end{align*}
</p>
<p> and above equation is generalized as follows: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} T^n - k_n\nabla \cdot \kappa \nabla T^n &amp;=&amp; \frac{k_n+k_{n-1}}{k_{n-1}} T^{n-1} - \frac{k_n^2}{k_{n-1}(k_n+k_{n-1})} T^{n-2} - k_n{\mathbf u}^{*,n} \cdot \nabla T^{*,n} + k_n\gamma, \end{eqnarray*}
</p>
<p>where \({(\cdot)}^{*,n} = \left(1+\frac{k_n}{k_{n-1}}\right)(\cdot)^{n-1} - \frac{k_n}{k_{n-1}}(\cdot)^{n-2}\) denotes the extrapolation of velocity \(\mathbf u\) and temperature \(T\) to time level \(n\), using the values at the two previous time steps. That's not an easy to read equation, but will provide us with the desired higher order accuracy. As a consistency check, it is easy to verify that it reduces to the same equation as above if \(k_n=k_{n-1}\).</p>
<p>As a final remark we note that the choice of a higher order time stepping scheme of course forces us to keep more time steps in memory; in particular, we here will need to have \(T^{n-2}\) around, a vector that we could previously discard. This seems like a nuisance that we were able to avoid previously by using only a first order time stepping scheme, but as we will see below when discussing the topic of stabilization, we will need this vector anyway and so keeping it around for time discretization is essentially for free and gives us the opportunity to use a higher order scheme.</p>
<p><a class="anchor" id="WeakformandspacediscretizationfortheStokespart"></a></p><h4>Weak form and space discretization for the Stokes part</h4>
<p>Like solving the mixed Laplace equations, solving the Stokes equations requires us to choose particular pairs of finite elements for velocities and pressure variables. Because this has already been discussed in <a class="el" href="step_22.html">step-22</a>, we only cover this topic briefly: Here, we use the stable pair \(Q_{p+1}^d \times Q_p, p\ge 1\). These are continuous elements, so we can form the weak form of the Stokes equation without problem by integrating by parts and substituting continuous functions by their discrete counterparts: </p><p class="formulaDsp">
\begin{eqnarray*} (\nabla {\mathbf v}_h, 2\eta \varepsilon ({\mathbf u}^{n-1}_h)) - (\nabla \cdot {\mathbf v}_h, p^{n-1}_h) &amp;=&amp; -({\mathbf v}_h, \rho\; \beta \; T^{n-1}_h \mathbf{g}), \\ (q_h, \nabla \cdot {\mathbf u}^{n-1}_h) &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> for all test functions \(\mathbf v_h, q_h\). The first term of the first equation is considered as the inner product between tensors, i.e. \((\nabla {\mathbf v}_h, \eta \varepsilon ({\mathbf u}^{n-1}_h))_\Omega = \int_\Omega \sum_{i,j=1}^d [\nabla {\mathbf v}_h]_{ij} \eta [\varepsilon ({\mathbf u}^{n-1}_h)]_{ij}\, dx\). Because the second tensor in this product is symmetric, the anti-symmetric component of \(\nabla {\mathbf v}_h\) plays no role and it leads to the entirely same form if we use the symmetric gradient of \(\mathbf v_h\) instead. Consequently, the formulation we consider and that we implement is </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon({\mathbf v}_h), 2\eta \varepsilon ({\mathbf u}^{n-1}_h)) - (\nabla \cdot {\mathbf v}_h, p^{n-1}_h) &amp;=&amp; -({\mathbf v}_h, \rho\; \beta \; T^{n-1}_h \mathbf{g}), \\ (q_h, \nabla \cdot {\mathbf u}^{n-1}_h) &amp;=&amp; 0. \end{eqnarray*}
</p>
<p>This is exactly the same as what we already discussed in <a class="el" href="step_22.html">step-22</a> and there is not much more to say about this here.</p>
<p><a class="anchor" id="Stabilizationweakformandspacediscretizationforthetemperatureequation"></a></p><h4>Stabilization, weak form and space discretization for the temperature equation</h4>
<p>The more interesting question is what to do with the temperature advection-diffusion equation. By default, not all discretizations of this equation are equally stable unless we either do something like upwinding, stabilization, or all of this. One way to achieve this is to use discontinuous elements (i.e., the <a class="el" href="classFE__DGQ.html">FE_DGQ</a> class that we used, for example, in the discretization of the transport equation in <a class="el" href="step_12.html">step-12</a>, or in discretizing the pressure in <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a>) and to define a flux at the interface between cells that takes into account upwinding. If we had a pure advection problem this would probably be the simplest way to go. However, here we have some diffusion as well, and the discretization of the Laplace operator with discontinuous elements is cumbersome because of the significant number of additional terms that need to be integrated on each face between cells. Discontinuous elements also have the drawback that the use of numerical fluxes introduces an additional numerical diffusion that acts everywhere, whereas we would really like to minimize the effect of numerical diffusion to a minimum and only apply it where it is necessary to stabilize the scheme.</p>
<p>A better alternative is therefore to add some nonlinear viscosity to the model. Essentially, what this does is to transform the temperature equation from the form </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma \end{eqnarray*}
</p>
<p> to something like </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot (\kappa+\nu(T)) \nabla T &amp;=&amp; \gamma, \end{eqnarray*}
</p>
<p> where \(\nu(T)\) is an addition viscosity (diffusion) term that only acts in the vicinity of shocks and other discontinuities. \(\nu(T)\) is chosen in such a way that if \(T\) satisfies the original equations, the additional viscosity is zero.</p>
<p>To achieve this, the literature contains a number of approaches. We will here follow one developed by Guermond and Popov that builds on a suitably defined residual and a limiting procedure for the additional viscosity. To this end, let us define a residual \(R_\alpha(T)\) as follows: </p><p class="formulaDsp">
\begin{eqnarray*} R_\alpha(T) = \left( \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T - \gamma \right) T^{\alpha-1} \end{eqnarray*}
</p>
<p> where we will later choose the stabilization exponent \(\alpha\) from within the range \([1,2]\). Note that \(R_\alpha(T)\) will be zero if \(T\) satisfies the temperature equation, since then the term in parentheses will be zero. Multiplying terms out, we get the following, entirely equivalent form: </p><p class="formulaDsp">
\begin{eqnarray*} R_\alpha(T) = \frac 1\alpha \frac{\partial (T^\alpha)}{\partial t} + \frac 1\alpha {\mathbf u} \cdot \nabla (T^\alpha) - \frac 1\alpha \nabla \cdot \kappa \nabla (T^\alpha) + \kappa(\alpha-1) T^{\alpha-2} |\nabla T|^2 - \gamma T^{\alpha-1} \end{eqnarray*}
</p>
<p>With this residual, we can now define the artificial viscosity as a piecewise constant function defined on each cell \(K\) with diameter \(h_K\) separately as follows: </p><p class="formulaDsp">
\begin{eqnarray*} \nu_\alpha(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} \min\left\{ h_K, h_K^\alpha \frac{\|R_\alpha(T)\|_{L^\infty(K)}}{c(\mathbf{u},T)} \right\} \end{eqnarray*}
</p>
<p>Here, \(\beta\) is a stabilization constant (a dimensional analysis reveals that it is unitless and therefore independent of scaling; we will discuss its choice in the <a href="#Results">results section</a>) and \(c(\mathbf{u},T)\) is a normalization constant that must have units \(\frac{m^{\alpha-1}K^\alpha}{s}\). We will choose it as \(c(\mathbf{u},T) = c_R\ \|\mathbf{u}\|_{L^\infty(\Omega)} \ \mathrm{var}(T) \ |\mathrm{diam}(\Omega)|^{\alpha-2}\), where \(\mathrm{var}(T)=\max_\Omega T - \min_\Omega T\) is the range of present temperature values (remember that buoyancy is driven by temperature variations, not the absolute temperature) and \(c_R\) is a dimensionless constant. To understand why this method works consider this: If on a particular cell \(K\) the temperature field is smooth, then we expect the residual to be small there (in fact to be on the order of \({\cal O}(h_K)\)) and the stabilization term that injects artificial diffusion will there be of size \(h_K^{\alpha+1}\) &mdash; i.e., rather small, just as we hope it to be when no additional diffusion is necessary. On the other hand, if we are on or close to a discontinuity of the temperature field, then the residual will be large; the minimum operation in the definition of \(\nu_\alpha(T)\) will then ensure that the stabilization has size \(h_K\) &mdash; the optimal amount of artificial viscosity to ensure stability of the scheme.</p>
<p>Whether or not this scheme really works is a good question. Computations by Guermond and Popov have shown that this form of stabilization actually performs much better than most of the other stabilization schemes that are around (for example streamline diffusion, to name only the simplest one). Furthermore, for \(\alpha\in [1,2)\) they can even prove that it produces better convergence orders for the linear transport equation than for example streamline diffusion. For \(\alpha=2\), no theoretical results are currently available, but numerical tests indicate that the results are considerably better than for \(\alpha=1\).</p>
<p>A more practical question is how to introduce this artificial diffusion into the equations we would like to solve. Note that the numerical viscosity \(\nu(T)\) is temperature-dependent, so the equation we want to solve is nonlinear in \(T\) &mdash; not what one desires from a simple method to stabilize an equation, and even less so if we realize that \(\nu(T)\) is nondifferentiable in \(T\). However, there is no reason to despair: we still have to discretize in time and we can treat the term explicitly.</p>
<p>In the definition of the stabilization parameter, we approximate the time derivative by \(\frac{\partial T}{\partial t} \approx \frac{T^{n-1}-T^{n-2}}{k^{n-1}}\). This approximation makes only use of available time data and this is the reason why we need to store data of two previous time steps (which enabled us to use the BDF-2 scheme without additional storage cost). We could now simply evaluate the rest of the terms at \(t_{n-1}\), but then the discrete residual would be nothing else than a backward Euler approximation, which is only first order accurate. So, in case of smooth solutions, the residual would be still of the order \(h\), despite the second order time accuracy in the outer BDF-2 scheme and the spatial FE discretization. This is certainly not what we want to have (in fact, we desired to have small residuals in regions where the solution behaves nicely), so a bit more care is needed. The key to this problem is to observe that the first derivative as we constructed it is actually centered at \(t_{n-\frac{3}{2}}\). We get the desired second order accurate residual calculation if we evaluate all spatial terms at \(t_{n-\frac{3}{2}}\) by using the approximation \(\frac 12 T^{n-1}+\frac 12 T^{n-2}\), which means that we calculate the nonlinear viscosity as a function of this intermediate temperature, \(\nu_\alpha = \nu_\alpha\left(\frac 12 T^{n-1}+\frac 12 T^{n-2}\right)\). Note that this evaluation of the residual is nothing else than a Crank-Nicholson scheme, so we can be sure that now everything is alright. One might wonder whether it is a problem that the numerical viscosity now is not evaluated at time \(n\) (as opposed to the rest of the equation). However, this offset is uncritical: For smooth solutions, \(\nu_\alpha\) will vary continuously, so the error in time offset is \(k\) times smaller than the nonlinear viscosity itself, i.e., it is a small higher order contribution that is left out. That's fine because the term itself is already at the level of discretization error in smooth regions.</p>
<p>Using the BDF-2 scheme introduced above, this yields for the simpler case of uniform time steps of size \(k\): </p><p class="formulaDsp">
\begin{eqnarray*} \frac 32 T^n - k\nabla \cdot \kappa \nabla T^n &amp;=&amp; 2 T^{n-1} - \frac 12 T^{n-2} \\ &amp;&amp; + k\nabla \cdot \left[ \nu_\alpha\left(\frac 12 T^{n-1}+\frac 12 T^{n-2}\right) \ \nabla (2T^{n-1}-T^{n-2}) \right] \\ &amp;&amp; - k(2{\mathbf u}^{n-1}-{\mathbf u}^{n-2}) \cdot \nabla (2T^{n-1}-T^{n-2}) \\ &amp;&amp; + k\gamma. \end{eqnarray*}
</p>
<p> On the left side of this equation remains the term from the time derivative and the original (physical) diffusion which we treat implicitly (this is actually a nice term: the matrices that result from the left hand side are the mass matrix and a multiple of the Laplace matrix &mdash; both are positive definite and if the time step size \(k\) is small, the sum is simple to invert). On the right hand side, the terms in the first line result from the time derivative; in the second line is the artificial diffusion at time \(t_{n-\frac 32}\); the third line contains the advection term, and the fourth the sources. Note that the artificial diffusion operates on the extrapolated temperature at the current time in the same way as we have discussed the advection works in the section on time stepping.</p>
<p>The form for nonuniform time steps that we will have to use in reality is a bit more complicated (which is why we showed the simpler form above first) and reads: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} T^n - k_n\nabla \cdot \kappa \nabla T^n &amp;=&amp; \frac{k_n+k_{n-1}}{k_{n-1}} T^{n-1} - \frac{k_n^2}{k_{n-1}(k_n+k_{n-1})} T^{n-2} \\ &amp;&amp; + k_n\nabla \cdot \left[ \nu_\alpha\left(\frac 12 T^{n-1}+\frac 12 T^{n-2}\right) \ \nabla \left[ \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2} \right] \right] \\ &amp;&amp; - k_n \left[ \left(1+\frac{k_n}{k_{n-1}}\right){\mathbf u}^{n-1} - \frac{k_n}{k_{n-1}}{\mathbf u}^{n-2} \right] \cdot \nabla \left[ \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2} \right] \\ &amp;&amp; + k_n\gamma. \end{eqnarray*}
</p>
<p>After settling all these issues, the weak form follows naturally from the strong form shown in the last equation, and we immediately arrive at the weak form of the discretized equations: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} (\tau_h,T_h^n) + k_n (\nabla \tau_h, \kappa \nabla T_h^n) &amp;=&amp; \biggl(\tau_h, \frac{k_n+k_{n-1}}{k_{n-1}} T_h^{n-1} - \frac{k_n^2}{k_{n-1}(k_n+k_{n-1})} T_h^{n-2} \\ &amp;&amp;\qquad - k_n \left[ \left(1+\frac{k_n}{k_{n-1}}\right){\mathbf u}^{n-1} - \frac{k_n}{k_{n-1}}{\mathbf u}^{n-2} \right] \cdot \nabla \left[ \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2} \right] + k_n\gamma \biggr) \\ &amp;&amp; - k_n \left(\nabla \tau_h, \nu_\alpha\left(\frac 12 T_h^{n-1}+\frac 12 T_h^{n-2}\right) \ \nabla \left[ \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2} \right] \right) \end{eqnarray*}
</p>
<p> for all discrete test functions \(\tau_h\). Here, the diffusion term has been integrated by parts, and we have used that we will impose no thermal flux, \(\mathbf{n}\cdot\kappa\nabla T|_{\partial\Omega}=0\).</p>
<p>This then results in a matrix equation of form </p><p class="formulaDsp">
\begin{eqnarray*} \left( \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} M+k_n A_T\right) T_h^n = F(U_h^{n-1}, U_h^{n-2},T_h^{n-1},T_h^{n-2}), \end{eqnarray*}
</p>
<p> which given the structure of matrix on the left (the sum of two positive definite matrices) is easily solved using the Conjugate Gradient method.</p>
<p><a class="anchor" id="Linearsolvers"></a></p><h4>Linear solvers</h4>
<p>As explained above, our approach to solving the joint system for velocities/pressure on the one hand and temperature on the other is to use an operator splitting where we first solve the Stokes system for the velocities and pressures using the old temperature field, and then solve for the new temperature field using the just computed velocity field. (A more extensive discussion of operator splitting methods can be found in <a class="el" href="step_58.html">step-58</a>.)</p>
<p><a class="anchor" id="LinearsolversfortheStokesproblem"></a></p><h5>Linear solvers for the Stokes problem</h5>
<p>Solving the linear equations coming from the Stokes system has been discussed in great detail in <a class="el" href="step_22.html">step-22</a>. In particular, in the results section of that program, we have discussed a number of alternative linear solver strategies that turned out to be more efficient than the original approach. The best alternative identified there we to use a GMRES solver preconditioned by a block matrix involving the Schur complement. Specifically, the Stokes operator leads to a block structured matrix </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \end{eqnarray*}
</p>
<p> and as discussed there a good preconditioner is </p><p class="formulaDsp">
\begin{eqnarray*} P = \left(\begin{array}{cc} A &amp; 0 \\ B &amp; -S \end{array}\right), \qquad \text{or equivalently} \qquad P^{-1} = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ S^{-1} B A^{-1} &amp; -S^{-1} \end{array}\right) \end{eqnarray*}
</p>
<p> where \(S\) is the Schur complement of the Stokes operator \(S=B^TA^{-1}B\). Of course, this preconditioner is not useful because we can't form the various inverses of matrices, but we can use the following as a preconditioner: </p><p class="formulaDsp">
\begin{eqnarray*} \tilde P^{-1} = \left(\begin{array}{cc} \tilde A^{-1} &amp; 0 \\ \tilde S^{-1} B \tilde A^{-1} &amp; -\tilde S^{-1} \end{array}\right) \end{eqnarray*}
</p>
<p> where \(\tilde A^{-1},\tilde S^{-1}\) are approximations to the inverse matrices. In particular, it turned out that \(S\) is spectrally equivalent to the mass matrix and consequently replacing \(\tilde S^{-1}\) by a CG solver applied to the mass matrix on the pressure space was a good choice. In a small deviation from <a class="el" href="step_22.html">step-22</a>, we here have a coefficient \(\eta\) in the momentum equation, and by the same derivation as there we should arrive at the conclusion that it is the weighted mass matrix with entries \(\tilde S_{ij}=(\eta^{-1}\varphi_i,\varphi_j)\) that we should be using.</p>
<p>It was more complicated to come up with a good replacement \(\tilde A^{-1}\), which corresponds to the discretized symmetric Laplacian of the vector-valued velocity field, i.e. \(A_{ij} = (\varepsilon {\mathbf v}_i, 2\eta \varepsilon ({\mathbf v}_j))\). In <a class="el" href="step_22.html">step-22</a> we used a sparse LU decomposition (using the <a class="el" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> class) of \(A\) for \(\tilde A^{-1}\) &mdash; the perfect preconditioner &mdash; in 2d, but for 3d memory and compute time is not usually sufficient to actually compute this decomposition; consequently, we only use an incomplete LU decomposition (ILU, using the <a class="el" href="classSparseILU.html">SparseILU</a> class) in 3d.</p>
<p>For this program, we would like to go a bit further. To this end, note that the symmetrized bilinear form on vector fields, \((\varepsilon {\mathbf v}_i, 2 \eta \varepsilon ({\mathbf v}_j))\) is not too far away from the nonsymmetrized version, \((\nabla {\mathbf v}_i, \eta \nabla {\mathbf v}_j) = \sum_{k,l=1}^d (\partial_k ({\mathbf v}_i)_l, \eta \partial_k ({\mathbf v}_j)_l) \) (note that the factor 2 has disappeared in this form). The latter, however, has the advantage that the <code>dim</code> vector components of the test functions are not coupled (well, almost, see below), i.e., the resulting matrix is block-diagonal: one block for each vector component, and each of these blocks is equal to the Laplace matrix for this vector component. So assuming we order degrees of freedom in such a way that first all \(x\)-components of the velocity are numbered, then the \(y\)-components, and then the \(z\)-components, then the matrix \(\hat A\) that is associated with this slightly different bilinear form has the form </p><p class="formulaDsp">
\begin{eqnarray*} \hat A = \left(\begin{array}{ccc} A_s &amp; 0 &amp; 0 \\ 0 &amp; A_s &amp; 0 \\ 0 &amp; 0 &amp; A_s \end{array}\right) \end{eqnarray*}
</p>
<p> where \(A_s\) is a Laplace matrix of size equal to the number of shape functions associated with each component of the vector-valued velocity. With this matrix, one could be tempted to define our preconditioner for the velocity matrix \(A\) as follows: </p><p class="formulaDsp">
\begin{eqnarray*} \tilde A^{-1} = \left(\begin{array}{ccc} \tilde A_s^{-1} &amp; 0 &amp; 0 \\ 0 &amp; \tilde A_s^{-1} &amp; 0 \\ 0 &amp; 0 &amp; \tilde A_s^{-1} \end{array}\right), \end{eqnarray*}
</p>
<p> where \(\tilde A_s^{-1}\) is a preconditioner for the Laplace matrix &mdash; something where we know very well how to build good preconditioners!</p>
<p>In reality, the story is not quite as simple: To make the matrix \(\tilde A\) definite, we need to make the individual blocks \(\tilde A_s\) definite by applying boundary conditions. One can try to do so by applying Dirichlet boundary conditions all around the boundary, and then the so-defined preconditioner \(\tilde A^{-1}\) turns out to be a good preconditioner for \(A\) if the latter matrix results from a Stokes problem where we also have Dirichlet boundary conditions on the velocity components all around the domain, i.e., if we enforce \(\mathbf{u} = 0\).</p>
<p>Unfortunately, this "if" is an "if and only if": in the program below we will want to use no-flux boundary conditions of the form \(\mathbf u \cdot \mathbf n = 0\) (i.e., flow parallel to the boundary is allowed, but no flux through the boundary). In this case, it turns out that the block diagonal matrix defined above is not a good preconditioner because it neglects the coupling of components at the boundary. A better way to do things is therefore if we build the matrix \(\hat A\) as the vector Laplace matrix \(\hat A_{ij} = (\nabla {\mathbf v}_i, \eta \nabla {\mathbf v}_j)\) and then apply the same boundary condition as we applied to \(A\). If this is a Dirichlet boundary condition all around the domain, the \(\hat A\) will decouple to three diagonal blocks as above, and if the boundary conditions are of the form \(\mathbf u \cdot \mathbf n = 0\) then this will introduce a coupling of degrees of freedom at the boundary but only there. This, in fact, turns out to be a much better preconditioner than the one introduced above, and has almost all the benefits of what we hoped to get.</p>
<p>To sum this whole story up, we can observe: </p><ul>
<li>
<p class="startli">Compared to building a preconditioner from the original matrix \(A\) resulting from the symmetric gradient as we did in <a class="el" href="step_22.html">step-22</a>, we have to expect that the preconditioner based on the Laplace bilinear form performs worse since it does not take into account the coupling between vector components.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">On the other hand, preconditioners for the Laplace matrix are typically more mature and perform better than ones for vector problems. For example, at the time of this writing, Algebraic Multigrid (AMG) algorithms are very well developed for scalar problems, but not so for vector problems.</p>
<p class="endli"></p>
</li>
<li>
In building this preconditioner, we will have to build up the matrix \(\hat A\) and its preconditioner. While this means that we have to store an additional matrix we didn't need before, the preconditioner \(\tilde A_s^{-1}\) is likely going to need much less memory than storing a preconditioner for the coupled matrix \(A\). This is because the matrix \(A_s\) has only a third of the entries per row for all rows corresponding to interior degrees of freedom, and contains coupling between vector components only on those parts of the boundary where the boundary conditions introduce such a coupling. Storing the matrix is therefore comparatively cheap, and we can expect that computing and storing the preconditioner \(\tilde A_s\) will also be much cheaper compared to doing so for the fully coupled matrix. </li>
</ul>
<p><a class="anchor" id="Linearsolversforthetemperatureequation"></a></p><h5>Linear solvers for the temperature equation</h5>
<p>This is the easy part: The matrix for the temperature equation has the form \(\alpha M + \beta A\), where \(M,A\) are mass and stiffness matrices on the temperature space, and \(\alpha,\beta\) are constants related the time stepping scheme and the current and previous time step. This being the sum of a symmetric positive definite and a symmetric positive semidefinite matrix, the result is also symmetric positive definite. Furthermore, \(\frac\beta\alpha\) is a number proportional to the time step, and so becomes small whenever the mesh is fine, damping the effect of the then ill-conditioned stiffness matrix.</p>
<p>As a consequence, inverting this matrix with the Conjugate Gradient algorithm, using a simple preconditioner, is trivial and very cheap compared to inverting the Stokes matrix.</p>
<p><a class="anchor" id="Implementationdetails"></a></p><h3>Implementation details</h3>
<p><a class="anchor" id="UsingdifferentDoFHandlerobjects"></a></p><h4>Using different <a class="el" href="classDoFHandler.html">DoFHandler</a> objects</h4>
<p>One of the things worth explaining up front about the program below is the use of two different <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. If one looks at the structure of the equations above and the scheme for their solution, one realizes that there is little commonality that keeps the Stokes part and the temperature part together. In all previous tutorial programs in which we have discussed <a class="el" href="group__vector__valued.html">vector-valued problems</a> we have always only used a single finite element with several vector components, and a single <a class="el" href="classDoFHandler.html">DoFHandler</a> object. Sometimes, we have substructured the resulting matrix into blocks to facilitate particular solver schemes; this was, for example, the case in the <a class="el" href="step_22.html">step-22</a> program for the Stokes equations upon which the current program is based.</p>
<p>We could of course do the same here. The linear system that we would get would look like this: </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{ccc} A &amp; B^T &amp; 0 \\ B &amp; 0 &amp;0 \\ C &amp; 0 &amp; K \end{array}\right) \left(\begin{array}{ccc} U^{n-1} \\ P^{n-1} \\ T^n \end{array}\right) = \left(\begin{array}{ccc} F_U(T^{n-1}) \\ 0 \\ F_T(U^{n-1},U^{n-2},T^{n-1},T^{n-2}) \end{array}\right). \end{eqnarray*}
</p>
<p> The problem with this is: We never use the whole matrix at the same time. In fact, it never really exists at the same time: As explained above, \(K\) and \(F_T\) depend on the already computed solution \(U^n\), in the first case through the time step (that depends on \(U^n\) because it has to satisfy a CFL condition). So we can only assemble it once we've already solved the top left \(2\times 2\) block Stokes system, and once we've moved on to the temperature equation we don't need the Stokes part any more; the fact that we build an object for a matrix that never exists as a whole in memory at any given time led us to jumping through some hoops in <a class="el" href="step_21.html">step-21</a>, so let's not repeat this sort of error. Furthermore, we don't actually build the matrix \(C\): Because by the time we get to the temperature equation we already know \(U^n\), and because we have to assemble the right hand side \(F_T\) at this time anyway, we simply move the term \(CU^n\) to the right hand side and assemble it along with all the other terms there. What this means is that there does not remain a part of the matrix where temperature variables and Stokes variables couple, and so a global enumeration of all degrees of freedom is no longer important: It is enough if we have an enumeration of all Stokes degrees of freedom, and of all temperature degrees of freedom independently.</p>
<p>In essence, there is consequently not much use in putting <em>everything</em> into a block matrix (though there are of course the same good reasons to do so for the \(2\times 2\) Stokes part), or, for that matter, in putting everything into the same <a class="el" href="classDoFHandler.html">DoFHandler</a> object.</p>
<p>But are there <em>downsides</em> to doing so? These exist, though they may not be obvious at first. The main problem is that if we need to create one global finite element that contains velocity, pressure, and temperature shape functions, and use this to initialize the <a class="el" href="classDoFHandler.html">DoFHandler</a>. But we also use this finite element object to initialize all <a class="el" href="classFEValues.html">FEValues</a> or <a class="el" href="classFEFaceValues.html">FEFaceValues</a> objects that we use. This may not appear to be that big a deal, but imagine what happens when, for example, we evaluate the residual \( R_\alpha(T) = \left( \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T - \gamma \right) T^{\alpha-1} \) that we need to compute the artificial viscosity \(\nu_\alpha(T)|_K\). For this, we need the Laplacian of the temperature, which we compute using the tensor of second derivatives (Hessians) of the shape functions (we have to give the <code>update_hessians</code> flag to the <a class="el" href="classFEValues.html">FEValues</a> object for this). Now, if we have a finite that contains the shape functions for velocities, pressures, and temperatures, that means that we have to compute the Hessians of <em>all</em> shape functions, including the many higher order shape functions for the velocities. That's a lot of computations that we don't need, and indeed if one were to do that (as we had in an early version of the program), assembling the right hand side took about a quarter of the overall compute time.</p>
<p>So what we will do is to use two different finite element objects, one for the Stokes components and one for the temperatures. With this come two different DoFHandlers, two sparsity patterns and two matrices for the Stokes and temperature parts, etc. And whenever we have to assemble something that contains both temperature and Stokes shape functions (in particular the right hand sides of Stokes and temperature equations), then we use two <a class="el" href="classFEValues.html">FEValues</a> objects initialized with two cell iterators that we walk in parallel through the two <a class="el" href="classDoFHandler.html">DoFHandler</a> objects associated with the same <a class="el" href="classTriangulation.html">Triangulation</a> object; for these two <a class="el" href="classFEValues.html">FEValues</a> objects, we use of course the same quadrature objects so that we can iterate over the same set of quadrature points, but each <a class="el" href="classFEValues.html">FEValues</a> object will get update flags only according to what it actually needs to compute. In particular, when we compute the residual as above, we only ask for the values of the Stokes shape functions, but also the Hessians of the temperature shape functions &mdash; much cheaper indeed, and as it turns out: assembling the right hand side of the temperature equation is now a component of the program that is hardly measurable.</p>
<p>With these changes, timing the program yields that only the following operations are relevant for the overall run time: </p><ul>
<li>
Solving the Stokes system: 72% of the run time. </li>
<li>
Assembling the Stokes preconditioner and computing the algebraic multigrid hierarchy using the Trilinos ML package: 11% of the run time. </li>
<li>
The function <code>BoussinesqFlowProblem::setup_dofs</code>: 7% of overall run time. </li>
<li>
Assembling the Stokes and temperature right hand side vectors as well as assembling the matrices: 7%. </li>
</ul>
<p>In essence this means that all bottlenecks apart from the algebraic multigrid have been removed.</p>
<p><a class="anchor" id="UsingTrilinos"></a></p><h4>Using Trilinos</h4>
<p>In much the same way as we used PETSc to support our linear algebra needs in <a class="el" href="step_17.html">step-17</a> and <a class="el" href="step_18.html">step-18</a>, we use interfaces to the <a href="http://trilinos.org">Trilinos</a> library (see the deal.II README file for installation instructions) in this program. Trilinos is a very large collection of everything that has to do with linear and nonlinear algebra, as well as all sorts of tools around that (and looks like it will grow in many other directions in the future as well).</p>
<p>The main reason for using Trilinos, similar to our exploring PETSc, is that it is a very powerful library that provides a lot more tools than deal.II's own linear algebra library. That includes, in particular, the ability to work in parallel on a cluster, using MPI, and a wider variety of preconditioners. In the latter class, one of the most interesting capabilities is the existence of the Trilinos ML package that implements an Algebraic <a class="el" href="classMultigrid.html">Multigrid</a> (AMG) method. We will use this preconditioner to precondition the second order operator part of the momentum equation. The ability to solve problems in parallel will be explored in <a class="el" href="step_32.html">step-32</a>, using the same problem as discussed here.</p>
<p>PETSc, which we have used in <a class="el" href="step_17.html">step-17</a> and <a class="el" href="step_18.html">step-18</a>, is certainly a powerful library, providing a large number of functions that deal with matrices, vectors, and iterative solvers and preconditioners, along with lots of other stuff, most of which runs quite well in parallel. It is, however, a few years old already than Trilinos, written in C, and generally not quite as easy to use as some other libraries. As a consequence, deal.II has also acquired interfaces to Trilinos, which shares a lot of the same functionality with PETSc. It is, however, a project that is several years younger, is written in C++ and by people who generally have put a significant emphasis on software design.</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>The case we want to solve here is as follows: we solve the Boussinesq equations described above with \(\kappa=10^{-6}, \eta=1, \rho=1, \beta=10\), i.e., a relatively slow moving fluid that has virtually no thermal diffusive conductivity and transports heat mainly through convection. On the boundary, we will require no-normal flux for the velocity ( \(\mathrm{n}\cdot\mathrm{u}=0\)) and for the temperature ( \(\mathrm{n}\cdot\nabla T=0\)). This is one of the cases discussed in the introduction of <a class="el" href="step_22.html">step-22</a> and fixes one component of the velocity while allowing flow to be parallel to the boundary. There remain <code>dim-1</code> components to be fixed, namely the tangential components of the normal stress; for these, we choose homogeneous conditions which means that we do not have to anything special. Initial conditions are only necessary for the temperature field, and we choose it to be constant zero.</p>
<p>The evolution of the problem is then entirely driven by the right hand side \(\gamma(\mathrm{x},t)\) of the temperature equation, i.e., by heat sources and sinks. Here, we choose a setup invented in advance of a Christmas lecture: real candles are of course prohibited in U.S. class rooms, but virtual ones are allowed. We therefore choose three spherical heat sources unequally spaced close to the bottom of the domain, imitating three candles. The fluid located at these sources, initially at rest, is then heated up and as the temperature rises gains buoyancy, rising up; more fluid is dragged up and through the sources, leading to three hot plumes that rise up until they are captured by the recirculation of fluid that sinks down on the outside, replacing the air that rises due to heating.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The first step, as always, is to include the functionality of these well-known deal.II library files and some C++ header files.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
</div><!-- fragment --><p>Then we need to include some header files that provide vector, matrix, and preconditioner classes that implement interfaces to the respective Trilinos classes. In particular, we will need interfaces to the matrix and vector classes based on Trilinos as well as Trilinos preconditioners:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
</div><!-- fragment --><p>Finally, here are a few C++ headers that haven't been included yet by one of the aforelisted header files:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
</div><!-- fragment --><p>At the end of this top-matter, we import all deal.II names into the global namespace:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep31.html">Step31</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Equationdata"></a> </p><h3>Equation data</h3>
<p>Again, the next stage in the program is the definition of the equation data, that is, the various boundary conditions, the right hand sides and the initial condition (remember that we're about to solve a time-dependent system). The basic strategy for this definition is the same as in <a class="el" href="step_22.html">step-22</a>. Regarding the details, though, there are some differences.</p>
<p>The first thing is that we don't set any inhomogeneous boundary conditions on the velocity, since as is explained in the introduction we will use no-flux conditions \(\mathbf{n}\cdot\mathbf{u}=0\). So what is left are <code>dim-1</code> conditions for the tangential part of the normal component of the stress tensor, \(\textbf{n} \cdot [p \textbf{1} - \eta\varepsilon(\textbf{u})]\); we assume homogeneous values for these components, i.e., a natural boundary condition that requires no specific action (it appears as a zero term in the right hand side of the weak form).</p>
<p>For the temperature \(T\), we assume no thermal energy flux, i.e., \(\mathbf{n} \cdot \kappa \nabla T=0\). This, again, is a boundary condition that does not require us to do anything in particular.</p>
<p>Secondly, we have to set initial conditions for the temperature (no initial conditions are required for the velocity and pressure, since the Stokes equations for the quasi-stationary case we consider here have no time derivatives of the velocity or pressure). Here, we choose a very simple test case, where the initial temperature is zero, and all dynamics are driven by the temperature right hand side.</p>
<p>Thirdly, we need to define the right hand side of the temperature equation. We choose it to be constant within three circles (or spheres in 3d) somewhere at the bottom of the domain, as explained in the introduction, and zero outside.</p>
<p>Finally, or maybe firstly, at the top of this namespace, we define the various material constants we need ( \(\eta,\kappa\), density \(\rho\) and the thermal expansion coefficient \(\beta\)):</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>EquationData</div>
<div class="line">{</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a>     = 1;</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">kappa</a>   = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6;</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>    = 10;</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a> = 1;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>TemperatureInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    TemperatureInitialValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>TemperatureRightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    TemperatureRightHandSide()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0,</div>
<div class="line">             <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Invalid operation for a scalar function.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2) || (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3), <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> source_centers[3] = {</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(.3, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.3, .5, .1)),</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.45, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.45, .5, .1)),</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.75, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.75, .5, .1))};</div>
<div class="line">      <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> source_radius = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 1. / 32 : 1. / 8);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> ((source_centers[0].distance(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ||</div>
<div class="line">                  (source_centers[1].<a class="code" href="classPoint.html#a3df8e6ab311dab9337c8d7b039c7b815">distance</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ||</div>
<div class="line">                  (source_centers[2].distance(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ?</div>
<div class="line">                1 :</div>
<div class="line">                0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureRightHandSide&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line">} <span class="comment">// namespace EquationData</span></div>
</div><!-- fragment --><p><a class="anchor" id="Linearsolversandpreconditioners"></a> </p><h3>Linear solvers and preconditioners</h3>
<p>This section introduces some objects that are used for the solution of the linear equations of the Stokes system that we need to solve in each time step. Many of the ideas used here are the same as in <a class="el" href="step_20.html">step-20</a>, where Schur complement based preconditioners and solvers have been introduced, with the actual interface taken from <a class="el" href="step_22.html">step-22</a> (in particular the discussion in the "Results" section of <a class="el" href="step_22.html">step-22</a>, in which we introduce alternatives to the direct Schur complement approach). Note, however, that here we don't use the Schur complement to solve the Stokes equations, though an approximate Schur complement (the mass matrix on the pressure space) appears in the preconditioner.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">{</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeInverseMatrixcodeclasstemplate"></a> </p><h4>The <code>InverseMatrix</code> class template</h4>
<p>This class is an interface to calculate the action of an "inverted" matrix on a vector (using the <code>vmult</code> operation) in the same way as the corresponding class in <a class="el" href="step_22.html">step-22</a>: when the product of an object of this class is requested, we solve a linear equation system with that matrix using the CG method, accelerated by a preconditioner of (templated) class <code>PreconditionerType</code>.</p>
<p>In a minor deviation from the implementation of the same class in <a class="el" href="step_22.html">step-22</a>, we make the <code>vmult</code> function take any kind of vector type (it will yield compiler errors, however, if the matrix does not allow a matrix-vector product with this kind of vector).</p>
<p>Secondly, we catch any exceptions that the solver may have thrown. The reason is as follows: When debugging a program like this one occasionally makes a mistake of passing an indefinite or nonsymmetric matrix or preconditioner to the current class. The solver will, in that case, not converge and throw a run-time exception. If not caught here it will propagate up the call stack and may end up in <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> where we output an error message that will say that the CG solver failed. The question then becomes: Which CG solver? The one that inverted the mass matrix? The one that inverted the top left block with the Laplace operator? Or a CG solver in one of the several other nested places where we use linear solvers in the current code? No indication about this is present in a run-time exception because it doesn't store the stack of calls through which we got to the place where the exception was generated.</p>
<p>So rather than letting the exception propagate freely up to <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> we realize that there is little that an outer function can do if the inner solver fails and rather convert the run-time exception into an assertion that fails and triggers a call to <code><a class="el" href="namespacedeal__II__exceptions_1_1internals.html#a600f8f191a6ce368afda0074dd7ea1dc">abort()</a></code>, allowing us to trace back in a debugger how we got to the current place.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(VectorType &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">  <span class="keyword">const</span> PreconditionerType &amp;           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">  <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">  <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">  : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">  , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">  VectorType &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">  <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-7 * src.l2_norm());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>.what()));</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Schurcomplementpreconditioner"></a> </p><h4>Schur complement preconditioner</h4>
<p>This is the implementation of the Schur complement preconditioner as described in detail in the introduction. As opposed to <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_22.html">step-22</a>, we solve the block system all-at-once using GMRES, and use the Schur complement of the block structured matrix to build a good preconditioner instead.</p>
<p>Let's have a look at the ideal preconditioner matrix \(P=\left(\begin{array}{cc} A &amp; 0 \\ B &amp; -S \end{array}\right)\) described in the introduction. If we apply this matrix in the solution of a linear system, convergence of an iterative GMRES solver will be governed by the matrix </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1}\left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) = \left(\begin{array}{cc} I &amp; A^{-1} B^T \\ 0 &amp; I \end{array}\right), \end{eqnarray*}
</p>
<p> which indeed is very simple. A GMRES solver based on exact matrices would converge in one iteration, since all eigenvalues are equal (any Krylov method takes at most as many iterations as there are distinct eigenvalues). Such a preconditioner for the blocked Stokes system has been proposed by Silvester and Wathen ("Fast iterative solution of stabilised Stokes
 systems part II.  Using general block preconditioners", SIAM J. Numer. Anal., 31 (1994), pp. 1352-1367).</p>
<p>Replacing \(P\) by \(\tilde{P}\) keeps that spirit alive: the product \(P^{-1} A\) will still be close to a matrix with eigenvalues 1 with a distribution that does not depend on the problem size. This lets us hope to be able to get a number of GMRES iterations that is problem-size independent.</p>
<p>The deal.II users who have already gone through the <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_22.html">step-22</a> tutorials can certainly imagine how we're going to implement this. We replace the exact inverse matrices in \(P^{-1}\) by some approximate inverses built from the InverseMatrix class, and the inverse Schur complement will be approximated by the pressure mass matrix \(M_p\) (weighted by \(\eta^{-1}\) as mentioned in the introduction). As pointed out in the results section of <a class="el" href="step_22.html">step-22</a>, we can replace the exact inverse of \(A\) by just the application of a preconditioner, in this case on a vector Laplace matrix as was explained in the introduction. This does increase the number of (outer) GMRES iterations, but is still significantly cheaper than an exact inverse, which would require between 20 and 35 CG iterations for <em>each</em> outer solver step (using the AMG preconditioner).</p>
<p>Having the above explanations in mind, we define a preconditioner class with a <code>vmult</code> functionality, which is all we need for the interaction with the usual solver functions further below in the program code.</p>
<p>First the declarations. These are similar to the definition of the Schur complement in <a class="el" href="step_20.html">step-20</a>, with the difference that we need some more preconditioners in the constructor and that the matrices we use here are built upon Trilinos:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line"><span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  BlockSchurPreconditioner(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                        PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">    <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">             <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">    stokes_matrix;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                         PreconditionerTypeMp&gt;&gt;</div>
<div class="line">                             m_inverse;</div>
<div class="line">  <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div>
<div class="line">};</div>
</div><!-- fragment --><p>When using a <a class="el" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> or a <a class="el" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a>, the <a class="el" href="classVector.html">Vector</a> is initialized using an <a class="el" href="classIndexSet.html">IndexSet</a>. <a class="el" href="classIndexSet.html">IndexSet</a> is used not only to resize the <a class="el" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> but it also associates an index in the <a class="el" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> with a degree of freedom (see <a class="el" href="step_40.html">step-40</a> for a more detailed explanation). The function <a class="el" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set()</a> creates an <a class="el" href="classIndexSet.html">IndexSet</a> where every valid index is part of the set. Note that this program can only be run sequentially and will throw an exception if used in parallel.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div>
<div class="line">  BlockSchurPreconditioner(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                        PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">    <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner)</div>
<div class="line">  : stokes_matrix(&amp;S)</div>
<div class="line">  , m_inverse(&amp;Mpinv)</div>
<div class="line">  , a_preconditioner(Apreconditioner)</div>
<div class="line">  , tmp(<a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(stokes_matrix-&gt;<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1, 1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>()))</div>
<div class="line">{}</div>
</div><!-- fragment --><p>Next is the <code>vmult</code> function. We implement the action of \(P^{-1}\) as described above in three successive steps. In formulas, we want to compute \(Y=P^{-1}X\) where \(X,Y\) are both vectors with two block components.</p>
<p>The first step multiplies the velocity part of the vector by a preconditioner of the matrix \(A\), i.e., we compute \(Y_0={\tilde A}^{-1}X_0\). The resulting velocity vector is then multiplied by \(B\) and subtracted from the pressure, i.e., we want to compute \(X_1-BY_0\). This second step only acts on the pressure vector and is accomplished by the residual function of our matrix classes, except that the sign is wrong. Consequently, we change the sign in the temporary pressure vector and finally multiply by the inverse pressure mass matrix to get the final pressure vector, completing our work on the Stokes preconditioner:</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult</a>(</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">    stokes_matrix-&gt;block(1, 0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">    tmp *= -1;</div>
<div class="line">    m_inverse-&gt;vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace LinearSolvers</span></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeBoussinesqFlowProblemcodeclasstemplate"></a> </p><h3>The <code>BoussinesqFlowProblem</code> class template</h3>
<p>The definition of the class that defines the top-level logic of solving the time-dependent Boussinesq problem is mainly based on the <a class="el" href="step_22.html">step-22</a> tutorial program. The main differences are that now we also have to solve for the temperature equation, which forces us to have a second <a class="el" href="classDoFHandler.html">DoFHandler</a> object for the temperature variable as well as matrices, right hand sides, and solution vectors for the current and previous time steps. As mentioned in the introduction, all linear algebra objects are going to use wrappers of the corresponding Trilinos functionality.</p>
<p>The member functions of this class are reminiscent of <a class="el" href="step_21.html">step-21</a>, where we also used a staggered scheme that first solve the flow equations (here the Stokes equations, in <a class="el" href="step_21.html">step-21</a> Darcy flow) and then update the advected quantity (here the temperature, there the saturation). The functions that are new are mainly concerned with determining the time step, as well as the proper size of the artificial viscosity stabilization.</p>
<p>The last three variables indicate whether the various matrices or preconditioners need to be rebuilt the next time the corresponding build functions are called. This allows us to move the corresponding <code>if</code> into the respective function and thereby keeping our main <code><a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a></code> function clean and easy to read.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>BoussinesqFlowProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  BoussinesqFlowProblem();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span>   setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_stokes_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span>   build_stokes_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_stokes_system();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_temperature_system(<span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity);</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_temperature_matrix();</div>
<div class="line">  <span class="keywordtype">double</span> get_maximal_velocity() <span class="keyword">const</span>;</div>
<div class="line">  std::pair&lt;double, double&gt; get_extrapolated_temperature_range() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span>                      <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span>                      output_results() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span>                      refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <span class="keywordtype">double</span>             global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        stokes_degree;</div>
<div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             stokes_fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           stokes_dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> stokes_constraints;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;IndexSet&gt;               stokes_partitioning;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_stokes_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        temperature_degree;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 temperature_fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           temperature_dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> temperature_constraints;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_mass_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_stiffness_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_temperature_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_temperature_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span>       time_step;</div>
<div class="line">  <span class="keywordtype">double</span>       old_time_step;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">  std::shared_ptr&lt;TrilinosWrappers::PreconditionAMG&gt; Amg_preconditioner;</div>
<div class="line">  std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt;  Mp_preconditioner;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> rebuild_stokes_matrix;</div>
<div class="line">  <span class="keywordtype">bool</span> rebuild_temperature_matrices;</div>
<div class="line">  <span class="keywordtype">bool</span> rebuild_stokes_preconditioner;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemclassimplementation"></a> </p><h3>BoussinesqFlowProblem class implementation</h3>
<p><a class="anchor" id="BoussinesqFlowProblemBoussinesqFlowProblem"></a> </p><h4>BoussinesqFlowProblem::BoussinesqFlowProblem</h4>
<p>The constructor of this class is an extension of the constructor in <a class="el" href="step_22.html">step-22</a>. We need to add the various variables that concern the temperature. As discussed in the introduction, we are going to use \(Q_2\times Q_1\) (Taylor-Hood) elements again for the Stokes part, and \(Q_2\) elements for the temperature. However, by using variables that store the polynomial degree of the Stokes and temperature finite elements, it is easy to consistently modify the degree of the elements as well as all quadrature formulas used on them downstream. Moreover, we initialize the time stepping as well as the options for matrix assembly and preconditioning:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::BoussinesqFlowProblem()</div>
<div class="line">  : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">  , global_Omega_diameter(std::numeric_limits&lt;<a class="code" href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a>&gt;::quiet_NaN())</div>
<div class="line">  , stokes_degree(1)</div>
<div class="line">  , stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_degree + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_degree), 1)</div>
<div class="line">  , stokes_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  temperature_degree(2)</div>
<div class="line">  , temperature_fe(temperature_degree)</div>
<div class="line">  , temperature_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  time_step(0)</div>
<div class="line">  , old_time_step(0)</div>
<div class="line">  , timestep_number(0)</div>
<div class="line">  , rebuild_stokes_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , rebuild_temperature_matrices(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , rebuild_stokes_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_maximal_velocity"></a> </p><h4>BoussinesqFlowProblem::get_maximal_velocity</h4>
<p>Starting the real functionality of this class is a helper function that determines the maximum ( \(L_\infty\)) velocity in the domain (at the quadrature points, in fact). How it works should be relatively obvious to all who have gotten to this point of the tutorial. Note that since we are only interested in the velocity, rather than using <code>stokes_fe_values.get_function_values</code> to get the values of the entire Stokes solution (velocities and pressures) we use <code>stokes_fe_values[velocities].get_function_values</code> to extract only the velocities part. This has the additional benefit that we get it as a <a class="el" href="classTensor.html">Tensor&lt;1,dim&gt;</a>, rather than some components in a <a class="el" href="structDataPostprocessorInputs_1_1Vector.html">Vector&lt;double&gt;</a>, allowing us to process it right away using the <code><a class="el" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm()</a></code> function to get the magnitude of the velocity.</p>
<p>The only point worth thinking about a bit is how to choose the quadrature points we use here. Since the goal of this function is to find the maximal velocity over a domain by looking at quadrature points on each cell. So we should ask how we should best choose these quadrature points on each cell. To this end, recall that if we had a single \(Q_1\) field (rather than the vector-valued field of higher order) then the maximum would be attained at a vertex of the mesh. In other words, we should use the <a class="el" href="classQTrapezoid.html">QTrapezoid</a> class that has quadrature points only at the vertices of cells.</p>
<p>For higher order shape functions, the situation is more complicated: the maxima and minima may be attained at points between the support points of shape functions (for the usual \(Q_p\) elements the support points are the equidistant Lagrange interpolation points); furthermore, since we are looking for the maximum magnitude of a vector-valued quantity, we can even less say with certainty where the set of potential maximal points are. Nevertheless, intuitively if not provably, the Lagrange interpolation points appear to be a better choice than the Gauss points.</p>
<p>There are now different methods to produce a quadrature formula with quadrature points equal to the interpolation points of the finite element. One option would be to use the <a class="el" href="group__Exceptions.html#ga5b35a290aa7dd7562911a92a13b11fee">FiniteElement::get_unit_support_points()</a> function, reduce the output to a unique set of points to avoid duplicate function evaluations, and create a <a class="el" href="classQuadrature.html">Quadrature</a> object using these points. Another option, chosen here, is to use the <a class="el" href="classQTrapezoid.html">QTrapezoid</a> class and combine it with the <a class="el" href="classQIterated.html">QIterated</a> class that repeats the <a class="el" href="classQTrapezoid.html">QTrapezoid</a> formula on a number of sub-cells in each coordinate direction. To cover all support points, we need to iterate it <code>stokes_degree+1</code> times since this is the polynomial degree of the Stokes element in use:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_maximal_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(), stokes_degree + 1);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(stokes_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  <span class="keywordtype">double</span>                      max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                velocity_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> max_velocity;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_extrapolated_temperature_range"></a> </p><h4>BoussinesqFlowProblem::get_extrapolated_temperature_range</h4>
<p>Next a function that determines the minimum and maximum temperature at quadrature points inside \(\Omega\) when extrapolated from the two previous time steps to the current one. We need this information in the computation of the artificial viscosity parameter \(\nu\) as discussed in the introduction.</p>
<p>The formula for the extrapolated temperature is \(\left(1+\frac{k_n}{k_{n-1}} \right)T^{n-1} + \frac{k_n}{k_{n-1}} T^{n-2}\). The way to compute it is to loop over all quadrature points and update the maximum and minimum value if the current value is bigger/smaller than the previous one. We initialize the variables that store the max and min before the loop over all quadrature points by the smallest and the largest number representable as a double. Then we know for a fact that it is larger/smaller than the minimum/maximum and that the loop over all quadrature points is ultimately going to update the initial value with the correct one.</p>
<p>The only other complication worth mentioning here is that in the first time step, \(T^{k-2}\) is not yet available of course. In that case, we can only use \(T^{k-1}\) which we have from the initial temperature. As quadrature points, we use the same choice as in the previous function though with the difference that now the number of repetitions is determined by the polynomial degree of the temperature field.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::pair&lt;double, double&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::get_extrapolated_temperature_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                          temperature_degree);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(temperature_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">             max_temperature = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">        {</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                        old_temperature_values);</div>
<div class="line">          fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                        old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> =</div>
<div class="line">                (1. + time_step / old_time_step) * old_temperature_values[q] -</div>
<div class="line">                time_step / old_time_step * old_old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">              min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">              max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">             max_temperature = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">        {</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                        old_temperature_values);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> = old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">              min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">              max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemcompute_viscosity"></a> </p><h4>BoussinesqFlowProblem::compute_viscosity</h4>
<p>The last of the tool functions computes the artificial viscosity parameter \(\nu|_K\) on a cell \(K\) as a function of the extrapolated temperature, its gradient and Hessian (second derivatives), the velocity, the right hand side \(\gamma\) all on the quadrature points of the current cell, and various other parameters as described in detail in the introduction.</p>
<p>There are some universal constants worth mentioning here. First, we need to fix \(\beta\); we choose \(\beta=0.017\cdot dim\), a choice discussed in detail in the results section of this tutorial program. The second is the exponent \(\alpha\); \(\alpha=1\) appears to work fine for the current program, even though some additional benefit might be expected from choosing \(\alpha = 2\). Finally, there is one thing that requires special casing: In the first time step, the velocity equals zero, and the formula for \(\nu|_K\) is not defined. In that case, we return \(\nu|_K=5\cdot 10^3 \cdot h_K\), a choice admittedly more motivated by heuristics than anything else (it is in the same order of magnitude, however, as the value returned for most cells on the second time step).</p>
<p>The rest of the function should be mostly obvious based on the material discussed in the introduction:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = 0.017 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 1.0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (global_u_infty == 0)</div>
<div class="line">    <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 * cell_diameter;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_temperature.size();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_residual = 0;</div>
<div class="line">  <span class="keywordtype">double</span> max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u =</div>
<div class="line">        (old_velocity_values[q] + old_old_velocity_values[q]) / 2;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> dT_dt =</div>
<div class="line">        (old_temperature[q] - old_old_temperature[q]) / old_time_step;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_T =</div>
<div class="line">        u * (old_temperature_grads[q] + old_old_temperature_grads[q]) / 2;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> kappa_Delta_T =</div>
<div class="line">        <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> *</div>
<div class="line">        (old_temperature_laplacians[q] + old_old_temperature_laplacians[q]) /</div>
<div class="line">        2;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> =</div>
<div class="line">        <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dT_dt + u_grad_T - kappa_Delta_T - gamma_values[q]) *</div>
<div class="line">                 std::pow((old_temperature[q] + old_old_temperature[q]) / 2,</div>
<div class="line">                          <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 1.));</div>
<div class="line"> </div>
<div class="line">      max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">      max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u * u), max_velocity);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(2., (4. - 2 * <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) / <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R * global_u_infty * global_T_variation *</div>
<div class="line">                                <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(global_Omega_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 2.);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (</div>
<div class="line">    <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a> * max_velocity *</div>
<div class="line">    <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(cell_diameter,</div>
<div class="line">             std::pow(cell_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) * max_residual / global_scaling));</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemsetup_dofs"></a> </p><h4>BoussinesqFlowProblem::setup_dofs</h4>
<p>This is the function that sets up the <a class="el" href="classDoFHandler.html">DoFHandler</a> objects we have here (one for the Stokes part and one for the temperature part) as well as set to the right sizes the various objects required for the linear algebra in this program. Its basic operations are similar to what we do in <a class="el" href="step_22.html">step-22</a>.</p>
<p>The body of the function first enumerates all degrees of freedom for the Stokes and temperature systems. For the Stokes part, degrees of freedom are then sorted to ensure that velocities precede pressure DoFs so that we can partition the Stokes matrix into a \(2\times 2\) matrix. As a difference to <a class="el" href="step_22.html">step-22</a>, we do not perform any additional DoF renumbering. In that program, it paid off since our solver was heavily dependent on ILU's, whereas we use AMG here which is not sensitive to the DoF numbering. The IC preconditioner for the inversion of the pressure mass matrix would of course take advantage of a Cuthill-McKee like renumbering, but its costs are low compared to the velocity portion, so the additional work does not pay off.</p>
<p>We then proceed with the generation of the hanging node constraints that arise from adaptive grid refinement for both <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. For the velocity, we impose no-flux boundary conditions \(\mathbf{u}\cdot \mathbf{n}=0\) by adding constraints to the object that already stores the hanging node constraints matrix. The second parameter in the function describes the first of the velocity components in the total dof vector, which is zero here. The variable <code>no_normal_flux_boundaries</code> denotes the boundary indicators for which to set the no flux boundary conditions; here, this is boundary indicator zero.</p>
<p>After having done so, we count the number of degrees of freedom in the various blocks:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  std::vector&lt;unsigned int&gt; stokes_sub_blocks(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">  stokes_sub_blocks[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    stokes_dof_handler.distribute_dofs(stokes_fe);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">    stokes_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                            stokes_constraints);</div>
<div class="line">    std::set&lt;types::boundary_id&gt; no_normal_flux_boundaries;</div>
<div class="line">    no_normal_flux_boundaries.insert(0);</div>
<div class="line">    <a class="code" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                                    0,</div>
<div class="line">                                                    no_normal_flux_boundaries,</div>
<div class="line">                                                    stokes_constraints);</div>
<div class="line">    stokes_constraints.close();</div>
<div class="line">  }</div>
<div class="line">  {</div>
<div class="line">    temperature_dof_handler.distribute_dofs(temperature_fe);</div>
<div class="line"> </div>
<div class="line">    temperature_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(temperature_dof_handler,</div>
<div class="line">                                            temperature_constraints);</div>
<div class="line">    temperature_constraints.close();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; stokes_dofs_per_block =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = stokes_dofs_per_block[0],</div>
<div class="line">                     n_p = stokes_dofs_per_block[1],</div>
<div class="line">                     n_T = temperature_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_T &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div>
<div class="line">            &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_T &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>The next step is to create the sparsity pattern for the Stokes and temperature system matrices as well as the preconditioner matrix from which we build the Stokes preconditioner. As in <a class="el" href="step_22.html">step-22</a>, we choose to create the pattern by using the blocked version of <a class="el" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a>.</p>
<p>So, we first release the memory stored in the matrices, then set up an object of type <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> consisting of \(2\times 2\) blocks (for the Stokes system matrix and preconditioner) or <a class="el" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> (for the temperature part). We then fill these objects with the nonzero pattern, taking into account that for the Stokes system matrix, there are no entries in the pressure-pressure block (but all velocity vector components couple with each other and with the pressure). Similarly, in the Stokes preconditioner matrix, only the diagonal blocks are nonzero, since we use the vector Laplacian as discussed in the introduction. This operator only couples each vector component of the Laplacian with itself, but not with the other vector components. (Application of the constraints resulting from the no-flux boundary conditions will couple vector components at the boundary again, however.)</p>
<p>When generating the sparsity pattern, we directly apply the constraints from hanging nodes and no-flux boundary conditions. This approach was already used in <a class="el" href="step_27.html">step-27</a>, but is different from the one in early tutorial programs where we first built the original sparsity pattern and only then added the entries resulting from constraints. The reason for doing so is that later during assembly we are going to distribute the constraints immediately when transferring local to global dofs. Consequently, there will be no data written at positions of constrained degrees of freedom, so we can let the <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a> function omit these entries by setting the last Boolean flag to <code>false</code>. Once the sparsity pattern is ready, we can use it to initialize the Trilinos matrices. Since the Trilinos matrices store the sparsity pattern internally, there is no need to keep the sparsity pattern around after the initialization of the matrix.</p>
<div class="fragment"><div class="line">stokes_partitioning.resize(2);</div>
<div class="line">stokes_partitioning[0] = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_u);</div>
<div class="line">stokes_partitioning[1] = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_p);</div>
<div class="line">{</div>
<div class="line">  stokes_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">  dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">  dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">  dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">  dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">  dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">    stokes_dof_handler, coupling, dsp, stokes_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  stokes_matrix.reinit(dsp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  Amg_preconditioner.reset();</div>
<div class="line">  Mp_preconditioner.reset();</div>
<div class="line">  stokes_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">  dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">  dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">  dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">  dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">  dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">    stokes_dof_handler, coupling, dsp, stokes_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  stokes_preconditioner_matrix.reinit(dsp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The creation of the temperature matrix (or, rather, matrices, since we provide a temperature mass matrix and a temperature stiffness matrix, that will be added together for time discretization) follows the generation of the Stokes matrix &ndash; except that it is much easier here since we do not need to take care of any blocks or coupling between components. Note how we initialize the three temperature matrices: We only use the sparsity pattern for reinitialization of the first matrix, whereas we use the previously generated matrix for the two remaining reinits. The reason for doing so is that reinitialization from an already generated matrix allows Trilinos to reuse the sparsity pattern instead of generating a new one for each copy. This saves both some time and memory.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  temperature_mass_matrix.clear();</div>
<div class="line">  temperature_stiffness_matrix.clear();</div>
<div class="line">  temperature_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_T, n_T);</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(temperature_dof_handler,</div>
<div class="line">                                  dsp,</div>
<div class="line">                                  temperature_constraints,</div>
<div class="line">                                  <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  temperature_matrix.reinit(dsp);</div>
<div class="line">  temperature_mass_matrix.reinit(temperature_matrix);</div>
<div class="line">  temperature_stiffness_matrix.reinit(temperature_matrix);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Lastly, we set the vectors for the Stokes solutions \(\mathbf u^{n-1}\) and \(\mathbf u^{n-2}\), as well as for the temperatures \(T^{n}\), \(T^{n-1}\) and \(T^{n-2}\) (required for time stepping) and all the system right hand sides to their correct sizes and block structure:</p>
<div class="fragment"><div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> temperature_partitioning = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_T);</div>
<div class="line">  stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  stokes_rhs.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_old_temperature_solution.reinit(temperature_partitioning,</div>
<div class="line">                                      MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  temperature_rhs.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemassemble_stokes_preconditioner"></a> </p><h4>BoussinesqFlowProblem::assemble_stokes_preconditioner</h4>
<p>This function assembles the matrix we use for preconditioning the Stokes system. What we need are a vector Laplace matrix on the velocity components and a mass matrix weighted by \(\eta^{-1}\) on the pressure component. We start by generating a quadrature object of appropriate order, the <a class="el" href="classFEValues.html">FEValues</a> object that can give values and gradients at the quadrature points (together with quadrature weights). Next we create data structures for the cell matrix and the relation between local and global DoFs. The vectors <code>grad_phi_u</code> and <code>phi_p</code> are going to hold the values of the basis functions in order to faster build up the local matrices, as was already done in <a class="el" href="step_22.html">step-22</a>. Before we start the loop over all active cells, we have to specify which components are pressure and which are velocity.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_preconditioner()</div>
<div class="line">{</div>
<div class="line">  stokes_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(stokes_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div>
<div class="line">                                 quadrature_formula,</div>
<div class="line">                                 <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;double&gt;         phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      local_matrix = 0;</div>
</div><!-- fragment --><p>The creation of the local matrix is rather simple. There are only a Laplace term (on the velocity) and a mass matrix weighted by \(\eta^{-1}\) to be generated, so the creation of the local matrix is done in two lines. Once the local matrix is ready (loop over rows and columns in the local matrix on each quadrature point), we get the local DoF indices and write the local information into the global matrix. We do this as in <a class="el" href="step_27.html">step-27</a>, i.e., we directly apply the constraints from hanging nodes locally. By doing so, we don't have to do that afterwards, and we don't also write into entries of the matrix that will actually be set to zero again later when eliminating constraints.</p>
<div class="fragment"><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              grad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> *</div>
<div class="line">                   <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>], grad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) +</div>
<div class="line">                 (1. / <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a>) * phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                stokes_fe_values.JxW(q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">      stokes_constraints.distribute_local_to_global(</div>
<div class="line">        local_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, stokes_preconditioner_matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblembuild_stokes_preconditioner"></a> </p><h4>BoussinesqFlowProblem::build_stokes_preconditioner</h4>
<p>This function generates the inner preconditioners that are going to be used for the Schur complement block preconditioner. Since the preconditioners need only to be regenerated when the matrices change, this function does not have to do anything in case the matrices have not changed (i.e., the flag <code>rebuild_stokes_preconditioner</code> has the value <code>false</code>). Otherwise its first task is to call <code>assemble_stokes_preconditioner</code> to generate the preconditioner matrices.</p>
<p>Next, we set up the preconditioner for the velocity-velocity matrix \(A\). As explained in the introduction, we are going to use an AMG preconditioner based on a vector Laplace matrix \(\hat{A}\) (which is spectrally close to the Stokes matrix \(A\)). Usually, the <a class="el" href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a> class can be seen as a good black-box preconditioner which does not need any special knowledge. In this case, however, we have to be careful: since we build an AMG for a vector problem, we have to tell the preconditioner setup which dofs belong to which vector component. We do this using the function <a class="el" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>, a function that generates a set of <code>dim</code> vectors, where each one has ones in the respective component of the vector problem and zeros elsewhere. Hence, these are the constant modes on each component, which explains the name of the variable.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::build_stokes_preconditioner()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_preconditioner == <span class="keyword">false</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding Stokes preconditioner...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">  assemble_stokes_preconditioner();</div>
<div class="line"> </div>
<div class="line">  Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionAMG&gt;();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;std::vector&lt;bool&gt;</a>&gt; constant_modes;</div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocity_components(0);</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>(stokes_dof_handler,</div>
<div class="line">                                   stokes_fe.component_mask(</div>
<div class="line">                                     velocity_components),</div>
<div class="line">                                   constant_modes);</div>
<div class="line">  <a class="code" href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a> amg_data;</div>
<div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">constant_modes</a> = constant_modes;</div>
</div><!-- fragment --><p>Next, we set some more options of the AMG preconditioner. In particular, we need to tell the AMG setup that we use quadratic basis functions for the velocity matrix (this implies more nonzero elements in the matrix, so that a more robust algorithm needs to be chosen internally). Moreover, we want to be able to control how the coarsening structure is build up. The way the Trilinos smoothed aggregation AMG does this is to look which matrix entries are of similar size as the diagonal entry in order to algebraically build a coarse-grid structure. By setting the parameter <code>aggregation_threshold</code> to 0.02, we specify that all entries that are more than two percent of size of some diagonal pivots in that row should form one coarse grid point. This parameter is rather ad hoc, and some fine-tuning of it can influence the performance of the preconditioner. As a rule of thumb, larger values of <code>aggregation_threshold</code> will decrease the number of iterations, but increase the costs per iteration. A look at the Trilinos documentation will provide more information on these parameters. With this data set, we then initialize the preconditioner with the matrix we want it to apply to.</p>
<p>Finally, we also initialize the preconditioner for the inversion of the pressure mass matrix. This matrix is symmetric and well-behaved, so we can chose a simple preconditioner. We stick with an incomplete Cholesky (IC) factorization preconditioner, which is designed for symmetric matrices. We could have also chosen an SSOR preconditioner with relaxation factor around 1.2, but IC is cheaper for our example. We wrap the preconditioners into a <code>std::shared_ptr</code> pointer, which makes it easier to recreate the preconditioner next time around since we do not have to care about destroying the previously used object.</p>
<div class="fragment"><div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">elliptic</a>              = <span class="keyword">true</span>;</div>
<div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">higher_order_elements</a> = <span class="keyword">true</span>;</div>
<div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">smoother_sweeps</a>       = 2;</div>
<div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">aggregation_threshold</a> = 0.02;</div>
<div class="line">  Amg_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(0, 0),</div>
<div class="line">                                 amg_data);</div>
<div class="line"> </div>
<div class="line">  Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">  Mp_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(1, 1));</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_preconditioner = <span class="keyword">false</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemassemble_stokes_system"></a> </p><h4>BoussinesqFlowProblem::assemble_stokes_system</h4>
<p>The time lag scheme we use for advancing the coupled Stokes-temperature system forces us to split up the assembly (and the solution of linear systems) into two step. The first one is to create the Stokes system matrix and right hand side, and the second is to create matrix and right hand sides for the temperature dofs, which depends on the result of the linear system for the velocity.</p>
<p>This function is called at the beginning of each time step. In the first time step or if the mesh has changed, indicated by the <code>rebuild_stokes_matrix</code>, we need to assemble the Stokes matrix; on the other hand, if the mesh hasn't changed and the matrix is already available, this is not necessary and all we need to do is assemble the right hand side vector which changes in each time step.</p>
<p>Regarding the technical details of implementation, not much has changed from <a class="el" href="step_22.html">step-22</a>. We reset matrix and vector, create a quadrature formula on the cells, and then create the respective <a class="el" href="classFEValues.html">FEValues</a> object. For the update flags, we require basis function derivatives only in case of a full assembly, since they are not needed for the right hand side; as always, choosing the minimal set of flags depending on what is currently needed makes the call to <a class="el" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a> further down in the program more efficient.</p>
<p>There is one thing that needs to be commented &ndash; since we have a separate finite element and <a class="el" href="classDoFHandler.html">DoFHandler</a> for the temperature, we need to generate a second <a class="el" href="classFEValues.html">FEValues</a> object for the proper evaluation of the temperature solution. This isn't too complicated to realize here: just use the temperature structures and set an update flag for the basis function values which we need for evaluation of the temperature solution. The only important part to remember here is that the same quadrature formula is used for both <a class="el" href="classFEValues.html">FEValues</a> objects to ensure that we get matching information when we loop over the quadrature points of the two objects.</p>
<p>The declarations proceed with some shortcuts for array sizes, the creation of the local matrix and right hand side as well as the vector for the indices of the local dofs compared to the global system.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_system()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">    stokes_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  stokes_rhs = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(stokes_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(</div>
<div class="line">    stokes_fe,</div>
<div class="line">    quadrature_formula,</div>
<div class="line">    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">      (rebuild_stokes_matrix == <span class="keyword">true</span> ? <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> : <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>(0)));</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values(temperature_fe,</div>
<div class="line">                                      quadrature_formula,</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
</div><!-- fragment --><p>Next we need a vector that will contain the values of the temperature solution at the previous time level at the quadrature points to assemble the source term in the right hand side of the momentum equation. Let's call this vector <code>old_solution_values</code>.</p>
<p>The set of vectors we create next hold the evaluations of the basis functions as well as their gradients and symmetrized gradients that will be used for creating the matrices. Putting these into their own arrays rather than asking the <a class="el" href="classFEValues.html">FEValues</a> object for this information each time it is needed is an optimization to accelerate the assembly process, see <a class="el" href="step_22.html">step-22</a> for details.</p>
<p>The last two declarations are used to extract the individual blocks (velocity, pressure, temperature) from the total FE system.</p>
<div class="fragment"><div class="line">std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt;          phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; grads_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;                  div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;                  phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
</div><!-- fragment --><p>Now start the loop over all cells in the problem. We are working on two different DoFHandlers for this assembly routine, so we must have two different cell iterators for the two objects in use. This might seem a bit peculiar, since both the Stokes system and the temperature system use the same grid, but that's the only way to keep degrees of freedom in sync. The first statements within the loop are again all very familiar, doing the update of the finite element data as specified by the update flags, zeroing out the local arrays and getting the values of the old solution at the quadrature points. Then we are ready to loop over the quadrature points on the cell.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>             = stokes_dof_handler.begin_active();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> endc             = stokes_dof_handler.end();</div>
<div class="line"><span class="keyword">auto</span>       temperature_cell = temperature_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++temperature_cell)</div>
<div class="line">  {</div>
<div class="line">    stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    temperature_fe_values.reinit(temperature_cell);</div>
<div class="line"> </div>
<div class="line">    local_matrix = 0;</div>
<div class="line">    local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                              old_temperature_values);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> old_temperature = old_temperature_values[q];</div>
</div><!-- fragment --><p>Next we extract the values and gradients of basis functions relevant to the terms in the inner products. As shown in <a class="el" href="step_22.html">step-22</a> this helps accelerate assembly.</p>
<p>Once this is done, we start the loop over the rows and columns of the local matrix and feed the matrix with the relevant products. The right hand side is filled with the forcing term driven by temperature in direction of gravity (which is vertical in our example). Note that the right hand side term is always generated, whereas the matrix contributions are only updated when it is requested by the <code>rebuild_matrices</code> flag.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">    {</div>
<div class="line">      phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">      <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">        {</div>
<div class="line">          grads_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">            stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">            stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">        local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">          (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * 2 * (grads_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grads_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) -</div>
<div class="line">           div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">          stokes_fe_values.JxW(q);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> gravity =</div>
<div class="line">    -((<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2) ? (<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 1)) : (<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 0, 1)));</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (-<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a> * <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">EquationData::beta</a> *</div>
<div class="line">                     gravity * phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * old_temperature) *</div>
<div class="line">                    stokes_fe_values.JxW(q);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The last step in the loop over all cells is to enter the local contributions into the global matrix and vector structures to the positions specified in <code>local_dof_indices</code>. Again, we let the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class do the insertion of the cell matrix elements to the global matrix, which already condenses the hanging node constraints.</p>
<div class="fragment"><div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">        stokes_constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                                      local_rhs,</div>
<div class="line">                                                      <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                      stokes_matrix,</div>
<div class="line">                                                      stokes_rhs);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        stokes_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                      <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                      stokes_rhs);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_matrix = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemassemble_temperature_matrix"></a> </p><h4>BoussinesqFlowProblem::assemble_temperature_matrix</h4>
<p>This function assembles the matrix in the temperature equation. The temperature matrix consists of two parts, a mass matrix and the time step size times a stiffness matrix given by a Laplace term times the amount of diffusion. Since the matrix depends on the time step size (which varies from one step to another), the temperature matrix needs to be updated every time step. We could simply regenerate the matrices in every time step, but this is not really efficient since mass and Laplace matrix do only change when we change the mesh. Hence, we do this more efficiently by generating two separate matrices in this function, one for the mass matrix and one for the stiffness (diffusion) matrix. We will then sum up the matrix plus the stiffness matrix times the time step size once we know the actual time step.</p>
<p>So the details for this first step are very simple. In case we need to rebuild the matrix (i.e., the mesh has changed), we zero the data structures, get a quadrature formula and a <a class="el" href="classFEValues.html">FEValues</a> object, and create local matrices, local dof indices and evaluation structures for the basis functions.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_matrix()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_temperature_matrices == <span class="keyword">false</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  temperature_mass_matrix      = 0;</div>
<div class="line">  temperature_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>   quadrature_formula(temperature_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values(temperature_fe,</div>
<div class="line">                                      quadrature_formula,</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = temperature_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_mass_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_stiffness_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt;         phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
</div><!-- fragment --><p>Now, let's start the loop over all cells in the triangulation. We need to zero out the local matrices, update the finite element evaluations, and then loop over the rows and columns of the matrices on each quadrature point, where we then create the mass matrix and the stiffness matrix (Laplace terms times the diffusion <code>EquationData::kappa</code>. Finally, we let the constraints object insert these values into the global matrix, and directly condense the constraints into the matrix.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      local_mass_matrix      = 0;</div>
<div class="line">      local_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">      temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              {</div>
<div class="line">                local_mass_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] * temperature_fe_values.JxW(q));</div>
<div class="line">                local_stiffness_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (<a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> * grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">                   temperature_fe_values.JxW(q));</div>
<div class="line">              }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      temperature_constraints.distribute_local_to_global(</div>
<div class="line">        local_mass_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, temperature_mass_matrix);</div>
<div class="line">      temperature_constraints.distribute_local_to_global(</div>
<div class="line">        local_stiffness_matrix,</div>
<div class="line">        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">        temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  rebuild_temperature_matrices = <span class="keyword">false</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemassemble_temperature_system"></a> </p><h4>BoussinesqFlowProblem::assemble_temperature_system</h4>
<p>This function does the second part of the assembly work on the temperature matrix, the actual addition of pressure mass and stiffness matrix (where the time step size comes into play), as well as the creation of the velocity-dependent right hand side. The declarations for the right hand side assembly in this function are pretty much the same as the ones used in the other assembly routines, except that we restrict ourselves to vectors this time. We are going to calculate residuals on the temperature system, which means that we have to evaluate second derivatives, specified by the update flag <code>update_hessians</code>.</p>
<p>The temperature equation is coupled to the Stokes system by means of the fluid velocity. These two parts of the solution are associated with different DoFHandlers, so we again need to create a second <a class="el" href="classFEValues.html">FEValues</a> object for the evaluation of the velocity at the quadrature points.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_system(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (use_bdf2_scheme == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">      temperature_matrix *=</div>
<div class="line">        (2 * time_step + old_time_step) / (time_step + old_time_step);</div>
<div class="line">      temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">      temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  temperature_rhs = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(temperature_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     temperature_fe_values(temperature_fe,</div>
<div class="line">                                      quadrature_formula,</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div>
<div class="line">                                 quadrature_formula,</div>
<div class="line">                                 <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = temperature_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
</div><!-- fragment --><p>Next comes the declaration of vectors to hold the old and older solution values (as a notation for time levels \(n-1\) and \(n-2\), respectively) and gradients at quadrature points of the current cell. We also declare an object to hold the temperature right hand side values (<code>gamma_values</code>), and we again use shortcuts for the temperature basis functions. Eventually, we need to find the temperature extrema and the diameter of the computational domain which will be used for the definition of the stabilization parameter (we got the maximal velocity as an input to this function).</p>
<div class="fragment"><div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_temperature_grads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_temperature_grads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_temperature_laplacians(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_old_temperature_laplacians(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">EquationData::TemperatureRightHandSide&lt;dim&gt; temperature_right_hand_side;</div>
<div class="line">std::vector&lt;double&gt;                         gamma_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;double&gt;         phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range =</div>
<div class="line">  get_extrapolated_temperature_range();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
</div><!-- fragment --><p>Now, let's start the loop over all cells in the triangulation. Again, we need two cell iterators that walk in parallel through the cells of the two involved <a class="el" href="classDoFHandler.html">DoFHandler</a> objects for the Stokes and temperature part. Within the loop, we first set the local rhs to zero, and then get the values and derivatives of the old solution functions at the quadrature points, since they are going to be needed for the definition of the stabilization parameters and as coefficients in the equation, respectively. Note that since the temperature has its own <a class="el" href="classDoFHandler.html">DoFHandler</a> and <a class="el" href="classFEValues.html">FEValues</a> object we get the entire solution at the quadrature point (which is the scalar temperature field only anyway) whereas for the Stokes part we restrict ourselves to extracting the velocity part (and ignoring the pressure part) by using <code>stokes_fe_values[velocities].get_function_values</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>        = temperature_dof_handler.begin_active();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> endc        = temperature_dof_handler.end();</div>
<div class="line"><span class="keyword">auto</span>       stokes_cell = stokes_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++stokes_cell)</div>
<div class="line">  {</div>
<div class="line">    local_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    stokes_fe_values.reinit(stokes_cell);</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                              old_temperature_values);</div>
<div class="line">    temperature_fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                              old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.get_function_gradients(old_temperature_solution,</div>
<div class="line">                                                 old_temperature_grads);</div>
<div class="line">    temperature_fe_values.get_function_gradients(</div>
<div class="line">      old_old_temperature_solution, old_old_temperature_grads);</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.get_function_laplacians(</div>
<div class="line">      old_temperature_solution, old_temperature_laplacians);</div>
<div class="line">    temperature_fe_values.get_function_laplacians(</div>
<div class="line">      old_old_temperature_solution, old_old_temperature_laplacians);</div>
<div class="line"> </div>
<div class="line">    temperature_right_hand_side.<a class="code" href="classFunction.html#a562fc1114e95e702e6696721f71528db">value_list</a>(</div>
<div class="line">      temperature_fe_values.get_quadrature_points(), gamma_values);</div>
<div class="line"> </div>
<div class="line">    stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                     old_velocity_values);</div>
<div class="line">    stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">      old_stokes_solution, old_old_velocity_values);</div>
</div><!-- fragment --><p>Next, we calculate the artificial viscosity for stabilization according to the discussion in the introduction using the dedicated function. With that at hand, we can get into the loop over quadrature points and local rhs vector components. The terms here are quite lengthy, but their definition follows the time-discrete system developed in the introduction of this program. The BDF-2 scheme needs one more term from the old time step (and involves more complicated factors) than the backward Euler scheme that is used for the first time step. When all this is done, we distribute the local vector into the global one (including hanging node constraints).</p>
<div class="fragment"><div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">        compute_viscosity(old_temperature_values,</div>
<div class="line">                          old_old_temperature_values,</div>
<div class="line">                          old_temperature_grads,</div>
<div class="line">                          old_old_temperature_grads,</div>
<div class="line">                          old_temperature_laplacians,</div>
<div class="line">                          old_old_temperature_laplacians,</div>
<div class="line">                          old_velocity_values,</div>
<div class="line">                          old_old_velocity_values,</div>
<div class="line">                          gamma_values,</div>
<div class="line">                          maximal_velocity,</div>
<div class="line">                          global_T_range.second - global_T_range.first,</div>
<div class="line">                          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> T_term_for_rhs =</div>
<div class="line">            (use_bdf2_scheme ?</div>
<div class="line">               (old_temperature_values[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                old_old_temperature_values[q] * (time_step * time_step) /</div>
<div class="line">                  (old_time_step * (time_step + old_time_step))) :</div>
<div class="line">               old_temperature_values[q]);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> ext_grad_T =</div>
<div class="line">            (use_bdf2_scheme ?</div>
<div class="line">               (old_temperature_grads[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                old_old_temperature_grads[q] * time_step / old_time_step) :</div>
<div class="line">               old_temperature_grads[q]);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> extrapolated_u =</div>
<div class="line">            (use_bdf2_scheme ?</div>
<div class="line">               (old_velocity_values[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                old_old_velocity_values[q] * time_step / old_time_step) :</div>
<div class="line">               old_velocity_values[q]);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">              (T_term_for_rhs * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">               time_step * extrapolated_u * ext_grad_T * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">               time_step * nu * ext_grad_T * grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] +</div>
<div class="line">               time_step * gamma_values[q] * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) *</div>
<div class="line">              temperature_fe_values.JxW(q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">      temperature_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                         <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                         temperature_rhs);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemsolve"></a> </p><h4>BoussinesqFlowProblem::solve</h4>
<p>This function solves the linear systems of equations. Following the introduction, we start with the Stokes system, where we need to generate our block Schur preconditioner. Since all the relevant actions are implemented in the class <code>BlockSchurPreconditioner</code>, all we have to do is to initialize the class appropriately. What we need to pass down is an <code>InverseMatrix</code> object for the pressure mass matrix, which we set up using the respective class together with the IC preconditioner we already generated, and the AMG preconditioner for the velocity-velocity matrix. Note that both <code>Mp_preconditioner</code> and <code>Amg_preconditioner</code> are only pointers, so we use <code>*</code> to pass down the actual preconditioner objects.</p>
<p>Once the preconditioner is ready, we create a GMRES solver for the block system. Since we are working with Trilinos data structures, we have to set the respective template argument in the solver. GMRES needs to internally store temporary vectors for each iteration (see the discussion in the results section of <a class="el" href="step_22.html">step-22</a>) &ndash; the more vectors it can use, the better it will generally perform. To keep memory demands in check, we set the number of vectors to 100. This means that up to 100 solver iterations, every temporary vector can be stored. If the solver needs to iterate more often to get the specified tolerance, it will work on a reduced set of vectors by restarting at every 100 iterations.</p>
<p>With this all set up, we solve the system and distribute the constraints in the Stokes system, i.e., hanging nodes and no-flux boundary condition, in order to have the appropriate solution values even at constrained dofs. Finally, we write the number of iterations to the screen.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">BoussinesqFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                       <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">      mp_inverse(stokes_preconditioner_matrix.block(1, 1),</div>
<div class="line">                 *Mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">      <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">      <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix, mp_inverse, *Amg_preconditioner);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(stokes_matrix.m(),</div>
<div class="line">                                 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * stokes_rhs.l2_norm());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolverGMRES.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> gmres(</div>
<div class="line">      solver_control,</div>
<div class="line">      <a class="code" href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(100));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; stokes_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (stokes_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">        stokes_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line">    gmres.solve(stokes_matrix, stokes_solution, stokes_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">    stokes_constraints.distribute(stokes_solution);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; GMRES iterations for Stokes subsystem.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Once we know the Stokes solution, we can determine the new time step from the maximal velocity. We have to do this to satisfy the CFL condition since convection terms are treated explicitly in the temperature equation, as discussed in the introduction. The exact form of the formula used here for the time step is discussed in the results section of this program.</p>
<p>There is a snatch here. The formula contains a division by the maximum value of the velocity. However, at the start of the computation, we have a constant temperature field (we start with a constant temperature, and it will be nonconstant only after the first time step during which the source acts). Constant temperature means that no buoyancy acts, and so the velocity is zero. Dividing by it will not likely lead to anything good.</p>
<p>To avoid the resulting infinite time step, we ask whether the maximal velocity is very small (in particular smaller than the values we encounter during any of the following time steps) and if so rather than dividing by zero we just divide by a small value, resulting in a large but finite time step.</p>
<div class="fragment"><div class="line">old_time_step                 = time_step;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity = get_maximal_velocity();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (maximal_velocity &gt;= 0.01)</div>
<div class="line">  time_step = 1. / (1.7 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> * <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) / temperature_degree *</div>
<div class="line">              <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) /</div>
<div class="line">              maximal_velocity;</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">  time_step = 1. / (1.7 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> * <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) / temperature_degree *</div>
<div class="line">              <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) / .01;</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span></div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;Time step: &quot;</span> &lt;&lt; time_step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">temperature_solution = old_temperature_solution;</div>
</div><!-- fragment --><p>Next we set up the temperature system and the right hand side using the function <code>assemble_temperature_system()</code>. Knowing the matrix and right hand side of the temperature equation, we set up a preconditioner and a solver. The temperature matrix is a mass matrix (with eigenvalues around one) plus a Laplace matrix (with eigenvalues between zero and \(ch^{-2}\)) times a small number proportional to the time step \(k_n\). Hence, the resulting symmetric and positive definite matrix has eigenvalues in the range \([1,1+k_nh^{-2}]\) (up to constants). This matrix is only moderately ill conditioned even for small mesh sizes and we get a reasonably good preconditioner by simple means, for example with an incomplete Cholesky decomposition preconditioner (IC) as we also use for preconditioning the pressure mass matrix solver. As a solver, we choose the conjugate gradient method CG. As before, we tell the solver to use Trilinos vectors via the template argument <code><a class="el" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></code>. Finally, we solve, distribute the hanging node constraints and write out the number of iterations.</p>
<div class="fragment"><div class="line">assemble_temperature_system(maximal_velocity);</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(temperature_matrix.m(),</div>
<div class="line">                               1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-8 * temperature_rhs.l2_norm());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">  <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(temperature_matrix);</div>
<div class="line"> </div>
<div class="line">  cg.solve(temperature_matrix,</div>
<div class="line">           temperature_solution,</div>
<div class="line">           temperature_rhs,</div>
<div class="line">           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">  temperature_constraints.distribute(temperature_solution);</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; CG iterations for temperature.&quot;</span> &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>At the end of this function, we step through the vector and read out the maximum and minimum temperature value, which we also want to output. This will come in handy when determining the correct constant in the choice of time step as discuss in the results section of this program.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">double</span> min_temperature = temperature_solution(0),</div>
<div class="line">           max_temperature = temperature_solution(0);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; temperature_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        min_temperature =</div>
<div class="line">          std::min&lt;double&gt;(min_temperature, temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">        max_temperature =</div>
<div class="line">          std::max&lt;double&gt;(max_temperature, temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Temperature range: &quot;</span> &lt;&lt; min_temperature &lt;&lt; <span class="charliteral">&#39; &#39;</span></div>
<div class="line">              &lt;&lt; max_temperature &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemoutput_results"></a> </p><h4>BoussinesqFlowProblem::output_results</h4>
<p>This function writes the solution to a VTK output file for visualization, which is done every tenth time step. This is usually quite a simple task, since the deal.II library provides functions that do almost all the job for us. There is one new function compared to previous examples: We want to visualize both the Stokes solution and the temperature as one data set, but we have done all the calculations based on two different <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. Luckily, the <a class="el" href="classDataOut.html">DataOut</a> class is prepared to deal with it. All we have to do is to not attach one single <a class="el" href="classDoFHandler.html">DoFHandler</a> at the beginning and then use that for all added vector, but specify the <a class="el" href="classDoFHandler.html">DoFHandler</a> to each vector separately. The rest is done as in <a class="el" href="step_22.html">step-22</a>. We create solution names (that are going to appear in the visualization program for the individual components). The first <code>dim</code> components are the vector velocity, and then we have pressure for the Stokes part, whereas temperature is scalar. This information is read out using the <a class="el" href="namespaceDataComponentInterpretation.html">DataComponentInterpretation</a> helper class. Next, we actually attach the data vectors with their <a class="el" href="classDoFHandler.html">DoFHandler</a> objects, build patches according to the degree of freedom, which are (sub-) elements that describe the data for visualization programs. Finally, we open a file (that includes the time step number) and write the vtk data into it.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (timestep_number % 10 != 0)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;std::string&gt; stokes_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  stokes_names.emplace_back(<span class="stringliteral">&quot;p&quot;</span>);</div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    stokes_component_interpretation(</div>
<div class="line">      <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    stokes_component_interpretation[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] =</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(stokes_dof_handler,</div>
<div class="line">                           stokes_solution,</div>
<div class="line">                           stokes_names,</div>
<div class="line">                           stokes_component_interpretation);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(temperature_dof_handler,</div>
<div class="line">                           temperature_solution,</div>
<div class="line">                           <span class="stringliteral">&quot;T&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(stokes_degree, temperature_degree));</div>
<div class="line"> </div>
<div class="line">  std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution-&quot;</span> +</div>
<div class="line">                       <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 4) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemrefine_mesh"></a> </p><h4>BoussinesqFlowProblem::refine_mesh</h4>
<p>This function takes care of the adaptive mesh refinement. The three tasks this function performs is to first find out which cells to refine/coarsen, then to actually do the refinement and eventually transfer the solution vectors between the two different grids. The first task is simply achieved by using the well-established Kelly error estimator on the temperature (it is the temperature we're mainly interested in for this program, and we need to be accurate in regions of high temperature gradients, also to not have too much numerical diffusion). The second task is to actually do the remeshing. That involves only basic functions as well, such as the <code>refine_and_coarsen_fixed_fraction</code> that refines those cells with the largest estimated error that together make up 80 per cent of the error, and coarsens those cells with the smallest error that make up for a combined 10 per cent of the error.</p>
<p>If implemented like this, we would get a program that will not make much progress: Remember that we expect temperature fields that are nearly discontinuous (the diffusivity \(\kappa\) is very small after all) and consequently we can expect that a freely adapted mesh will refine further and further into the areas of large gradients. This decrease in mesh size will then be accompanied by a decrease in time step, requiring an exceedingly large number of time steps to solve to a given final time. It will also lead to meshes that are much better at resolving discontinuities after several mesh refinement cycles than in the beginning.</p>
<p>In particular to prevent the decrease in time step size and the correspondingly large number of time steps, we limit the maximal refinement depth of the mesh. To this end, after the refinement indicator has been applied to the cells, we simply loop over all cells on the finest level and unselect them from refinement if they would result in too high a mesh level.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(temperature_dof_handler,</div>
<div class="line">                                     <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(temperature_degree + 1),</div>
<div class="line">                                     {},</div>
<div class="line">                                     temperature_solution,</div>
<div class="line">                                     estimated_error_per_cell);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                    estimated_error_per_cell,</div>
<div class="line">                                                    0.8,</div>
<div class="line">                                                    0.1);</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> :</div>
<div class="line">         <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators_on_level(max_grid_level))</div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
</div><!-- fragment --><p>As part of mesh refinement we need to transfer the solution vectors from the old mesh to the new one. To this end we use the <a class="el" href="classSolutionTransfer.html">SolutionTransfer</a> class and we have to prepare the solution vectors that should be transferred to the new grid (we will lose the old grid once we have done the refinement so the transfer has to happen concurrently with refinement). What we definitely need are the current and the old temperature (BDF-2 time stepping requires two old solutions). Since the <a class="el" href="classSolutionTransfer.html">SolutionTransfer</a> objects only support to transfer one object per dof handler, we need to collect the two temperature solutions in one data structure. Moreover, we choose to transfer the Stokes solution, too, since we need the velocity at two previous time steps, of which only one is calculated on the fly.</p>
<p>Consequently, we initialize two <a class="el" href="classSolutionTransfer.html">SolutionTransfer</a> objects for the Stokes and temperature <a class="el" href="classDoFHandler.html">DoFHandler</a> objects, by attaching them to the old dof handlers. With this at place, we can prepare the triangulation and the data vectors for refinement (in this order).</p>
<div class="fragment"><div class="line">std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_temperature(2);</div>
<div class="line">x_temperature[0]                            = temperature_solution;</div>
<div class="line">x_temperature[1]                            = old_temperature_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> x_stokes = stokes_solution;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> temperature_trans(</div>
<div class="line">  temperature_dof_handler);</div>
<div class="line"><a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> stokes_trans(</div>
<div class="line">  stokes_dof_handler);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">temperature_trans.prepare_for_coarsening_and_refinement(x_temperature);</div>
<div class="line">stokes_trans.prepare_for_coarsening_and_refinement(x_stokes);</div>
</div><!-- fragment --><p>Now everything is ready, so do the refinement and recreate the dof structure on the new grid, and initialize the matrix structures and the new vectors in the <code>setup_dofs</code> function. Next, we actually perform the interpolation of the solutions between the grids. We create another copy of temporary vectors for temperature (now corresponding to the new grid), and let the interpolate function do the job. Then, the resulting array of vectors is written into the respective vector member variables.</p>
<p>Remember that the set of constraints will be updated for the new triangulation in the setup_dofs() call.</p>
<div class="fragment"><div class="line"><a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">setup_dofs();</div>
<div class="line"> </div>
<div class="line">std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp(2);</div>
<div class="line">tmp[0].<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(temperature_solution);</div>
<div class="line">tmp[1].<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(temperature_solution);</div>
<div class="line">temperature_trans.interpolate(x_temperature, tmp);</div>
<div class="line"> </div>
<div class="line">temperature_solution     = tmp[0];</div>
<div class="line">old_temperature_solution = tmp[1];</div>
</div><!-- fragment --><p>After the solution has been transferred we then enforce the constraints on the transferred solution.</p>
<div class="fragment"><div class="line">temperature_constraints.distribute(temperature_solution);</div>
<div class="line">temperature_constraints.distribute(old_temperature_solution);</div>
</div><!-- fragment --><p>For the Stokes vector, everything is just the same &ndash; except that we do not need another temporary vector since we just interpolate a single vector. In the end, we have to tell the program that the matrices and preconditioners need to be regenerated, since the mesh has changed.</p>
<div class="fragment"><div class="line">  stokes_trans.interpolate(x_stokes, stokes_solution);</div>
<div class="line"> </div>
<div class="line">  stokes_constraints.distribute(stokes_solution);</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_matrix         = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_temperature_matrices  = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_stokes_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemrun"></a> </p><h4>BoussinesqFlowProblem::run</h4>
<p>This function performs all the essential steps in the Boussinesq program. It starts by setting up a grid (depending on the spatial dimension, we choose some different level of initial refinement and additional adaptive refinement steps, and then create a cube in <code>dim</code> dimensions and set up the dofs for the first time. Since we want to start the time stepping already with an adaptively refined grid, we perform some pre-refinement steps, consisting of all assembly, solution and refinement, but without actually advancing in time. Rather, we use the vilified <code>goto</code> statement to jump out of the time loop right after mesh refinement to start all over again on the new mesh beginning at the <code>start_time_iteration</code> label. (The use of the <code>goto</code> is discussed in <a class="el" href="step_26.html">step-26</a>.)</p>
<p>Before we start, we project the initial values to the grid and obtain the first data for the <code>old_temperature_solution</code> vector. Then, we initialize time step number and time step and start the time loop.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">BoussinesqFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 4 : 2);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 4 : 3);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">  global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(initial_refinement);</div>
<div class="line"> </div>
<div class="line">  setup_dofs();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">start_time_iteration:</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(temperature_dof_handler,</div>
<div class="line">                       temperature_constraints,</div>
<div class="line">                       <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(temperature_degree + 2),</div>
<div class="line">                       EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">                       old_temperature_solution);</div>
<div class="line"> </div>
<div class="line">  timestep_number = 0;</div>
<div class="line">  time_step = old_time_step = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div>
<div class="line">                &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>The first steps in the time loop are all obvious &ndash; we assemble the Stokes system, the preconditioner, the temperature matrix (matrices and preconditioner do actually only change in case we've remeshed before), and then do the solve. Before going on with the next time step, we have to check whether we should first finish the pre-refinement steps or if we should remesh (every fifth time step), refining up to a level that is consistent with initial refinement and pre-refinement steps. Last in the loop is to advance the solutions, i.e., to copy the solutions to the next "older" time level.</p>
<div class="fragment"><div class="line">  assemble_stokes_system();</div>
<div class="line">  build_stokes_preconditioner();</div>
<div class="line">  assemble_temperature_matrix();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">  output_results();</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">      (pre_refinement_step &lt; n_pre_refinement_steps))</div>
<div class="line">    {</div>
<div class="line">      refine_mesh(initial_refinement + n_pre_refinement_steps);</div>
<div class="line">      ++pre_refinement_step;</div>
<div class="line">      <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 5 == 0))</div>
<div class="line">    refine_mesh(initial_refinement + n_pre_refinement_steps);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">  ++timestep_number;</div>
<div class="line"> </div>
<div class="line">  old_stokes_solution          = stokes_solution;</div>
<div class="line">  old_old_temperature_solution = old_temperature_solution;</div>
<div class="line">  old_temperature_solution     = temperature_solution;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Do all the above until we arrive at time 100.</p>
<div class="fragment"><div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &lt;= 100);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step31</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>The main function looks almost the same as in all other programs.</p>
<p>There is one difference we have to be careful about. This program uses Trilinos and, typically, Trilinos is configured so that it can run in parallel using MPI. This doesn't mean that it <em>has</em> to run in parallel, and in fact this program (unlike <a class="el" href="step_32.html">step-32</a>) makes no attempt at all to do anything in parallel using MPI. Nevertheless, Trilinos wants the MPI system to be initialized. We do that be creating an object of type <a class="el" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> that initializes MPI (if available) using the arguments given to <a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a> (i.e., <code>argc</code> and <code>argv</code>) and de-initializes it again when the object goes out of scope.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep31.html">Step31</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
</div><!-- fragment --><p>This program can only be run in serial. Otherwise, throw an exception.</p>
<div class="fragment"><div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-31&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      BoussinesqFlowProblem&lt;2&gt; flow_problem;</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="Resultsin2d"></a></p><h3>Results in 2d </h3>
<p>When you run the program in 2d, the output will look something like this: <code> </p><pre>
Number of active cells: 256 (on 5 levels)
Number of degrees of freedom: 3556 (2178+289+1089)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 0.919118
   9 CG iterations for temperature.
   Temperature range: -0.16687 1.30011</pre><p></code></p>
<p><code></p><pre>Number of active cells: 280 (on 6 levels)
Number of degrees of freedom: 4062 (2490+327+1245)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 0.459559
   9 CG iterations for temperature.
   Temperature range: -0.0982971 0.598503</pre><p></code></p>
<p><code></p><pre>Number of active cells: 520 (on 7 levels)
Number of degrees of freedom: 7432 (4562+589+2281)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 0.229779
   9 CG iterations for temperature.
   Temperature range: -0.0551098 0.294493</pre><p></code></p>
<p><code></p><pre>Number of active cells: 1072 (on 8 levels)
Number of degrees of freedom: 15294 (9398+1197+4699)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 0.11489
   9 CG iterations for temperature.
   Temperature range: -0.0273524 0.156861</pre><p></code></p>
<p><code></p><pre>Number of active cells: 2116 (on 9 levels)
Number of degrees of freedom: 30114 (18518+2337+9259)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 0.0574449
   9 CG iterations for temperature.
   Temperature range: -0.014993 0.0738328</pre><p></code></p>
<p><code></p><pre>Timestep 1:  t=0.0574449
   Assembling...
   Solving...
   56 GMRES iterations for Stokes subsystem.
   Time step: 0.0574449
   9 CG iterations for temperature.
   Temperature range: -0.0273934 0.14488</pre><p></code></p>
<p><code></p><pre>...
</pre><p> </code></p>
<p>In the beginning we refine the mesh several times adaptively and always return to time step zero to restart on the newly refined mesh. Only then do we start the actual time iteration.</p>
<p>The program runs for a while. The temperature field for time steps 0, 500, 1000, 1500, 2000, 3000, 4000, and 5000 looks like this (note that the color scale used for the temperature is not always the same):</p>
<table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.00.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.01.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.02.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.03.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.04.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.05.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.06.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.07.png" alt="" class="inline"/>   </td></tr>
</table>
<p>The visualizations shown here were generated using a version of the example which did not enforce the constraints after transferring the mesh.</p>
<p>As can be seen, we have three heat sources that heat fluid and therefore produce a buoyancy effect that lets hots pockets of fluid rise up and swirl around. By a chimney effect, the three streams are pressed together by fluid that comes from the outside and wants to join the updraft party. Note that because the fluid is initially at rest, those parts of the fluid that were initially over the sources receive a longer heating time than that fluid that is later dragged over the source by the fully developed flow field. It is therefore hotter, a fact that can be seen in the red tips of the three plumes. Note also the relatively fine features of the flow field, a result of the sophisticated transport stabilization of the temperature equation we have chosen.</p>
<p>In addition to the pictures above, the following ones show the adaptive mesh and the flow field at the same time steps:</p>
<table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.00.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.01.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.02.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.03.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.04.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.05.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.06.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.07.png" alt="" class="inline"/>   </td></tr>
</table>
<p><a class="anchor" id="Resultsin3d"></a></p><h3>Results in 3d </h3>
<p>The same thing can of course be done in 3d by changing the template parameter to the BoussinesqFlowProblem object in <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> from 2 to 3, so that the output now looks like follows:</p>
<p><code> </p><pre>
Number of active cells: 64 (on 3 levels)
Number of degrees of freedom: 3041 (2187+125+729)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 2.45098
   9 CG iterations for temperature.
   Temperature range: -0.675683 4.94725</pre><p></code></p>
<p><code></p><pre>Number of active cells: 288 (on 4 levels)
Number of degrees of freedom: 12379 (8943+455+2981)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 1.22549
   9 CG iterations for temperature.
   Temperature range: -0.527701 2.25764</pre><p></code></p>
<p><code></p><pre>Number of active cells: 1296 (on 5 levels)
Number of degrees of freedom: 51497 (37305+1757+12435)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 0.612745
   10 CG iterations for temperature.
   Temperature range: -0.496942 0.847395</pre><p></code></p>
<p><code></p><pre>Number of active cells: 5048 (on 6 levels)
Number of degrees of freedom: 192425 (139569+6333+46523)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0
   Assembling...
   Rebuilding Stokes preconditioner...
   Solving...
   0 GMRES iterations for Stokes subsystem.
   Time step: 0.306373
   10 CG iterations for temperature.
   Temperature range: -0.267683 0.497739</pre><p></code></p>
<p><code></p><pre>Timestep 1:  t=0.306373
   Assembling...
   Solving...
   27 GMRES iterations for Stokes subsystem.
   Time step: 0.306373
   10 CG iterations for temperature.
   Temperature range: -0.461787 0.958679</pre><p></code></p>
<p><code></p><pre>...
</pre><p> </code></p>
<p>Visualizing the temperature isocontours at time steps 0, 50, 100, 150, 200, 300, 400, 500, 600, 700, and 800 yields the following plots:</p>
<table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.00.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.01.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.02.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.03.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.04.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.05.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.06.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.07.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.08.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.09.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.10.png" alt="" class="inline"/>  </td><td></td></tr>
</table>
<p>That the first picture looks like three hedgehogs stems from the fact that our scheme essentially projects the source times the first time step size onto the mesh to obtain the temperature field in the first time step. Since the source function is discontinuous, we need to expect over- and undershoots from this project. This is in fact what happens (it's easier to check this in 2d) and leads to the crumpled appearance of the isosurfaces. The visualizations shown here were generated using a version of the example which did not enforce the constraints after transferring the mesh.</p>
<p><a class="anchor" id="Numericalexperimentstodetermineoptimalparameters"></a></p><h3>Numerical experiments to determine optimal parameters </h3>
<p>The program as is has three parameters that we don't have much of a theoretical handle on how to choose in an optimal way. These are: </p><ul>
<li>
The time step must satisfy a CFL condition \(k\le \min_K \frac{c_kh_K}{\|\mathbf{u}\|_{L^\infty(K)}}\). Here, \(c_k\) is dimensionless, but what is the right value? </li>
<li>
In the computation of the artificial viscosity, <p class="formulaDsp">
\begin{eqnarray*} \nu_\alpha(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} \min\left\{ h_K, h_K^\alpha \frac{\|R_\alpha(T)\|_{L^\infty(K)}}{c(\mathbf{u},T)} \right\}, \end{eqnarray*}
</p>
 with \(c(\mathbf{u},T) = c_R\ \|\mathbf{u}\|_{L^\infty(\Omega)} \ \mathrm{var}(T) \ |\mathrm{diam}(\Omega)|^{\alpha-2}\). Here, the choice of the dimensionless numbers \(\beta,c_R\) is of interest. </li>
</ul>
<p>In all of these cases, we will have to expect that the correct choice of each value depends on that of the others, and most likely also on the space dimension and polynomial degree of the finite element used for the temperature. Below we'll discuss a few numerical experiments to choose constants \(c_k\) and \(\beta\).</p>
<p>Below, we will not discuss the choice of \(c_R\). In the program, we set it to \(c_R=2^{\frac{4-2\alpha}{d}}\). The reason for this value is a bit complicated and has more to do with the history of the program than reasoning: while the correct formula for the global scaling parameter \(c(\mathbf{u},T)\) is shown above, the program (including the version shipped with deal.II 6.2) initially had a bug in that we computed \(c(\mathbf{u},T) = \|\mathbf{u}\|_{L^\infty(\Omega)} \ \mathrm{var}(T) \ \frac{1}{|\mathrm{diam}(\Omega)|^{\alpha-2}}\) instead, where we had set the scaling parameter to one. Since we only computed on the unit square/cube where \(\mathrm{diam}(\Omega)=2^{1/d}\), this was entirely equivalent to using the correct formula with \(c_R=\left(2^{1/d}\right)^{4-2\alpha}=2^{\frac{4-2\alpha}{d}}\). Since this value for \(c_R\) appears to work just fine for the current program, we corrected the formula in the program and set \(c_R\) to a value that reproduces exactly the results we had before. We will, however, revisit this issue again in <a class="el" href="step_32.html">step-32</a>.</p>
<p>Now, however, back to the discussion of what values of \(c_k\) and \(\beta\) to choose:</p>
<p><a class="anchor" id="Choosingicsubksubiandbeta"></a></p><h4>Choosing <em>c<sub>k</sub></em> and beta </h4>
<p>These two constants are definitely linked in some way. The reason is easy to see: In the case of a pure advection problem, \(\frac{\partial T}{\partial t} + \mathbf{u}\cdot\nabla T = \gamma\), any explicit scheme has to satisfy a CFL condition of the form \(k\le \min_K \frac{c_k^a h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\). On the other hand, for a pure diffusion problem, \(\frac{\partial T}{\partial t} + \nu \Delta T = \gamma\), explicit schemes need to satisfy a condition \(k\le \min_K \frac{c_k^d h_K^2}{\nu}\). So given the form of \(\nu\) above, an advection diffusion problem like the one we have to solve here will result in a condition of the form \( k\le \min_K \min \left\{ \frac{c_k^a h_K}{\|\mathbf{u}\|_{L^\infty(K)}}, \frac{c_k^d h_K^2}{\beta \|\mathbf{u}\|_{L^\infty(K)} h_K}\right\} = \min_K \left( \min \left\{ c_k^a, \frac{c_k^d}{\beta}\right\} \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}} \right) \). It follows that we have to face the fact that we might want to choose \(\beta\) larger to improve the stability of the numerical scheme (by increasing the amount of artificial diffusion), but we have to pay a price in the form of smaller, and consequently more time steps. In practice, one would therefore like to choose \(\beta\) as small as possible to keep the transport problem sufficiently stabilized while at the same time trying to choose the time step as large as possible to reduce the overall amount of work.</p>
<p>The find the right balance, the only way is to do a few computational experiments. Here's what we did: We modified the program slightly to allow less mesh refinement (so we don't always have to wait that long) and to choose \( \nu(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} h_K \) to eliminate the effect of the constant \(c_R\) (we know that solutions are stable by using this version of \(\nu(T)\) as an artificial viscosity, but that we can improve things &ndash; i.e. make the solution sharper &ndash; by using the more complicated formula for this artificial viscosity). We then run the program for different values \(c_k,\beta\) and observe maximal and minimal temperatures in the domain. What we expect to see is this: If we choose the time step too big (i.e. choose a \(c_k\) bigger than theoretically allowed) then we will get exponential growth of the temperature. If we choose \(\beta\) too small, then the transport stabilization becomes insufficient and the solution will show significant oscillations but not exponential growth.</p>
<p><a class="anchor" id="ResultsforQsub1subelements"></a></p><h5>Results for Q<sub>1</sub> elements</h5>
<p>Here is what we get for \(\beta=0.01, \beta=0.1\), and \(\beta=0.5\), different choices of \(c_k\), and bilinear elements (<code>temperature_degree=1</code>) in 2d:</p>
<table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.01.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.03.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.1.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.5.png" alt="" class="inline"/>   </td></tr>
</table>
<p>The way to interpret these graphs goes like this: for \(\beta=0.01\) and \(c_k=\frac 12,\frac 14\), we see exponential growth or at least large variations, but if we choose \(k=\frac 18\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\) or smaller, then the scheme is stable though a bit wobbly. For more artificial diffusion, we can choose \(k=\frac 14\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\) or smaller for \(\beta=0.03\), \(k=\frac 13\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\) or smaller for \(\beta=0.1\), and again need \(k=\frac 1{15}\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\) for \(\beta=0.5\) (this time because much diffusion requires a small time step).</p>
<p>So how to choose? If we were simply interested in a large time step, then we would go with \(\beta=0.1\) and \(k=\frac 13\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\). On the other hand, we're also interested in accuracy and here it may be of interest to actually investigate what these curves show. To this end note that we start with a zero temperature and that our sources are positive &mdash; so we would intuitively expect that the temperature can never drop below zero. But it does, a consequence of Gibb's phenomenon when using continuous elements to approximate a discontinuous solution. We can therefore see that choosing \(\beta\) too small is bad: too little artificial diffusion leads to over- and undershoots that aren't diffused away. On the other hand, for large \(\beta\), the minimum temperature drops below zero at the beginning but then quickly diffuses back to zero.</p>
<p>On the other hand, let's also look at the maximum temperature. Watching the movie of the solution, we see that initially the fluid is at rest. The source keeps heating the same volume of fluid whose temperature increases linearly at the beginning until its buoyancy is able to move it upwards. The hottest part of the fluid is therefore transported away from the solution and fluid taking its place is heated for only a short time before being moved out of the source region, therefore remaining cooler than the initial bubble. If \(\kappa=0\) (in the program it is nonzero but very small) then the hottest part of the fluid should be advected along with the flow with its temperature constant. That's what we can see in the graphs with the smallest \(\beta\): Once the maximum temperature is reached, it hardly changes any more. On the other hand, the larger the artificial diffusion, the more the hot spot is diffused. Note that for this criterion, the time step size does not play a significant role.</p>
<p>So to sum up, likely the best choice would appear to be \(\beta=0.03\) and \(k=\frac 14\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\). The curve is a bit wobbly, but overall pictures looks pretty reasonable with the exception of some over and undershoots close to the start time due to Gibb's phenomenon.</p>
<p><a class="anchor" id="ResultsforQsub2subelements"></a></p><h5>Results for Q<sub>2</sub> elements</h5>
<p>One can repeat the same sequence of experiments for higher order elements as well. Here are the graphs for bi-quadratic shape functions (<code>temperature_degree=2</code>) for the temperature, while we retain the \(Q_2/Q_1\) stable Taylor-Hood element for the Stokes system:</p>
<table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.01.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.03.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.1.png" alt="" class="inline"/>   </td></tr>
</table>
<p>Again, small values of \(\beta\) lead to less diffusion but we have to choose the time step very small to keep things under control. Too large values of \(\beta\) make for more diffusion, but again require small time steps. The best value would appear to be \(\beta=0.03\), as for the \(Q_1\) element, and then we have to choose \(k=\frac 18\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\) &mdash; exactly half the size for the \(Q_1\) element, a fact that may not be surprising if we state the CFL condition as the requirement that the time step be small enough so that the distance transport advects in each time step is no longer than one <em>grid point</em> away (which for \(Q_1\) elements is \(h_K\), but for \(Q_2\) elements is \(h_K/2\)). It turns out that \(\beta\) needs to be slightly larger for obtaining stable results also late in the simulation at times larger than 60, so we actually choose it as \(\beta = 0.034\) in the code.</p>
<p><a class="anchor" id="Resultsfor3d"></a></p><h5>Results for 3d</h5>
<p>One can repeat these experiments in 3d and find the optimal time step for each value of \(\beta\) and find the best value of \(\beta\). What one finds is that for the same \(\beta\) already used in 2d, the time steps needs to be a bit smaller, by around a factor of 1.2 or so. This is easily explained: the time step restriction is \(k=\min_K \frac{ch_K}{\|\mathbf{u}\|_{L^\infty(K)}}\) where \(h_K\) is the <em>diameter</em> of the cell. However, what is really needed is the distance between mesh points, which is \(\frac{h_K}{\sqrt{d}}\). So a more appropriate form would be \(k=\min_K \frac{ch_K}{\|\mathbf{u}\|_{L^\infty(K)}\sqrt{d}}\).</p>
<p>The second find is that one needs to choose \(\beta\) slightly bigger (about \(\beta=0.05\) or so). This then again reduces the time step we can take.</p>
<p><a class="anchor" id="Conclusions"></a></p><h5>Conclusions</h5>
<p>Concluding, from the simple computations above, \(\beta=0.034\) appears to be a good choice for the stabilization parameter in 2d, and \(\beta=0.05\) in 3d. In a dimension independent way, we can model this as \(\beta=0.017d\). If one does longer computations (several thousand time steps) on finer meshes, one realizes that the time step size is not quite small enough and that for stability one will have to reduce the above values a bit more (by about a factor of \(\frac 78\)).</p>
<p>As a consequence, a formula that reconciles 2d, 3d, and variable polynomial degree and takes all factors in account reads as follows: </p><p class="formulaDsp">
\begin{eqnarray*} k = \frac 1{2 \cdot 1.7} \frac 1{\sqrt{d}} \frac 2d \frac 1{q_T} \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}} = \frac 1{1.7 d\sqrt{d}} \frac 1{q_T} \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}. \end{eqnarray*}
</p>
<p> In the first form (in the center of the equation), \(\frac 1{2 \cdot 1.7}\) is a universal constant, \(\frac 1{\sqrt{d}}\) is the factor that accounts for the difference between cell diameter and grid point separation, \(\frac 2d\) accounts for the increase in \(\beta\) with space dimension, \(\frac 1{q_T}\) accounts for the distance between grid points for higher order elements, and \(\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\) for the local speed of transport relative to the cell size. This is the formula that we use in the program.</p>
<p>As for the question of whether to use \(Q_1\) or \(Q_2\) elements for the temperature, the following considerations may be useful: First, solving the temperature equation is hardly a factor in the overall scheme since almost the entire compute time goes into solving the Stokes system in each time step. Higher order elements for the temperature equation are therefore not a significant drawback. On the other hand, if one compares the size of the over- and undershoots the solution produces due to the discontinuous source description, one notices that for the choice of \(\beta\) and \(k\) as above, the \(Q_1\) solution dips down to around \(-0.47\), whereas the \(Q_2\) solution only goes to \(-0.13\) (remember that the exact solution should never become negative at all. This means that the \(Q_2\) solution is significantly more accurate; the program therefore uses these higher order elements, despite the penalty we pay in terms of smaller time steps.</p>
<p><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions </h3>
<p>There are various ways to extend the current program. Of particular interest is, of course, to make it faster and/or increase the resolution of the program, in particular in 3d. This is the topic of the <a class="el" href="step_32.html">step-32</a> tutorial program which will implement strategies to solve this problem in parallel on a cluster. It is also the basis of the much larger open source code ASPECT (see <a href="https://aspect.geodynamics.org/">https://aspect.geodynamics.org/</a> ) that can solve realistic problems and that constitutes the further development of <a class="el" href="step_32.html">step-32</a>.</p>
<p>Another direction would be to make the fluid flow more realistic. The program was initially written to simulate various cases simulating the convection of material in the earth's mantle, i.e. the zone between the outer earth core and the solid earth crust: there, material is heated from below and cooled from above, leading to thermal convection. The physics of this fluid are much more complicated than shown in this program, however: The viscosity of mantle material is strongly dependent on the temperature, i.e. \(\eta=\eta(T)\), with the dependency frequently modeled as a viscosity that is reduced exponentially with rising temperature. Secondly, much of the dynamics of the mantle is determined by chemical reactions, primarily phase changes of the various crystals that make up the mantle; the buoyancy term on the right hand side of the Stokes equations then depends not only on the temperature, but also on the chemical composition at a given location which is advected by the flow field but also changes as a function of pressure and temperature. We will investigate some of these effects in later tutorial programs as well.</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2007 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Martin Kronbichler, Uppsala University,</span></div>
<div class="line"><span class="comment"> *          Wolfgang Bangerth, Texas A&amp;M University 2007, 2008</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep31.html">Step31</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>EquationData</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a>     = 1;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">kappa</a>   = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>    = 10;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a> = 1;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>TemperatureInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      TemperatureInitialValues()</div>
<div class="line">        : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">          value(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">      }</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>TemperatureRightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      TemperatureRightHandSide()</div>
<div class="line">        : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0,</div>
<div class="line">               <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Invalid operation for a scalar function.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2) || (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3), <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> source_centers[3] = {</div>
<div class="line">          (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(.3, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.3, .5, .1)),</div>
<div class="line">          (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.45, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.45, .5, .1)),</div>
<div class="line">          (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.75, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.75, .5, .1))};</div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> source_radius = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 1. / 32 : 1. / 8);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> ((source_centers[0].distance(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ||</div>
<div class="line">                    (source_centers[1].<a class="code" href="classPoint.html#a3df8e6ab311dab9337c8d7b039c7b815">distance</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ||</div>
<div class="line">                    (source_centers[2].distance(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ?</div>
<div class="line">                  1 :</div>
<div class="line">                  0);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">          value(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureRightHandSide&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">      }</div>
<div class="line">    };</div>
<div class="line">  } <span class="comment">// namespace EquationData</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">  {</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                    <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(VectorType &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerType &amp;           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">      <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">      <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">      : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">      , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">      VectorType &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">      <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-7 * src.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">try</span></div>
<div class="line">        {</div>
<div class="line">          cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>.what()));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      BlockSchurPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">        <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                            PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">        <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                 <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">        stokes_matrix;</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                             PreconditionerTypeMp&gt;&gt;</div>
<div class="line">                                 m_inverse;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div>
<div class="line">      BlockSchurPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">        <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                            PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">        <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner)</div>
<div class="line">      : stokes_matrix(&amp;S)</div>
<div class="line">      , m_inverse(&amp;Mpinv)</div>
<div class="line">      , a_preconditioner(Apreconditioner)</div>
<div class="line">      , tmp(<a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(stokes_matrix-&gt;<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1, 1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>()))</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keywordtype">void</span></div>
<div class="line">    <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult</a>(</div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">      stokes_matrix-&gt;block(1, 0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">      tmp *= -1;</div>
<div class="line">      m_inverse-&gt;vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">    }</div>
<div class="line">  } <span class="comment">// namespace LinearSolvers</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>BoussinesqFlowProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    BoussinesqFlowProblem();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span>   setup_dofs();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_stokes_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span>   build_stokes_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_stokes_system();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_temperature_system(<span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity);</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_temperature_matrix();</div>
<div class="line">    <span class="keywordtype">double</span> get_maximal_velocity() <span class="keyword">const</span>;</div>
<div class="line">    std::pair&lt;double, double&gt; get_extrapolated_temperature_range() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span>                      <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span>                      output_results() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span>                      refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <span class="keywordtype">double</span>             global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        stokes_degree;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             stokes_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           stokes_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> stokes_constraints;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;IndexSet&gt;               stokes_partitioning;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_stokes_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        temperature_degree;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 temperature_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           temperature_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> temperature_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_mass_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_stiffness_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>       time_step;</div>
<div class="line">    <span class="keywordtype">double</span>       old_time_step;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionAMG&gt; Amg_preconditioner;</div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt;  Mp_preconditioner;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_stokes_matrix;</div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_temperature_matrices;</div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_stokes_preconditioner;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::BoussinesqFlowProblem()</div>
<div class="line">    : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">    , global_Omega_diameter(std::numeric_limits&lt;<a class="code" href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a>&gt;::quiet_NaN())</div>
<div class="line">    , stokes_degree(1)</div>
<div class="line">    , stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_degree + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_degree), 1)</div>
<div class="line">    , stokes_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    temperature_degree(2)</div>
<div class="line">    , temperature_fe(temperature_degree)</div>
<div class="line">    , temperature_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    time_step(0)</div>
<div class="line">    , old_time_step(0)</div>
<div class="line">    , timestep_number(0)</div>
<div class="line">    , rebuild_stokes_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    , rebuild_temperature_matrices(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    , rebuild_stokes_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_maximal_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(), stokes_degree + 1);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(stokes_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    <span class="keywordtype">double</span>                      max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                  velocity_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> max_velocity;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::pair&lt;double, double&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::get_extrapolated_temperature_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                            temperature_degree);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(temperature_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">               max_temperature = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                          old_temperature_values);</div>
<div class="line">            fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                          old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> =</div>
<div class="line">                  (1. + time_step / old_time_step) * old_temperature_values[q] -</div>
<div class="line">                  time_step / old_time_step * old_old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">                min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">               max_temperature = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                          old_temperature_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> = old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">                min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = 0.017 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 1.0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (global_u_infty == 0)</div>
<div class="line">      <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 * cell_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_temperature.size();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_residual = 0;</div>
<div class="line">    <span class="keywordtype">double</span> max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u =</div>
<div class="line">          (old_velocity_values[q] + old_old_velocity_values[q]) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dT_dt =</div>
<div class="line">          (old_temperature[q] - old_old_temperature[q]) / old_time_step;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_T =</div>
<div class="line">          u * (old_temperature_grads[q] + old_old_temperature_grads[q]) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> kappa_Delta_T =</div>
<div class="line">          <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> *</div>
<div class="line">          (old_temperature_laplacians[q] + old_old_temperature_laplacians[q]) /</div>
<div class="line">          2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> =</div>
<div class="line">          <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dT_dt + u_grad_T - kappa_Delta_T - gamma_values[q]) *</div>
<div class="line">                   std::pow((old_temperature[q] + old_old_temperature[q]) / 2,</div>
<div class="line">                            <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 1.));</div>
<div class="line"> </div>
<div class="line">        max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">        max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u * u), max_velocity);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(2., (4. - 2 * <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) / <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R * global_u_infty * global_T_variation *</div>
<div class="line">                                  <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(global_Omega_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 2.);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (</div>
<div class="line">      <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a> * max_velocity *</div>
<div class="line">      <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(cell_diameter,</div>
<div class="line">               std::pow(cell_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) * max_residual / global_scaling));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;unsigned int&gt; stokes_sub_blocks(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">    stokes_sub_blocks[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      stokes_dof_handler.distribute_dofs(stokes_fe);</div>
<div class="line">      <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">      stokes_constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                              stokes_constraints);</div>
<div class="line">      std::set&lt;types::boundary_id&gt; no_normal_flux_boundaries;</div>
<div class="line">      no_normal_flux_boundaries.insert(0);</div>
<div class="line">      <a class="code" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                                      0,</div>
<div class="line">                                                      no_normal_flux_boundaries,</div>
<div class="line">                                                      stokes_constraints);</div>
<div class="line">      stokes_constraints.close();</div>
<div class="line">    }</div>
<div class="line">    {</div>
<div class="line">      temperature_dof_handler.distribute_dofs(temperature_fe);</div>
<div class="line"> </div>
<div class="line">      temperature_constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(temperature_dof_handler,</div>
<div class="line">                                              temperature_constraints);</div>
<div class="line">      temperature_constraints.close();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; stokes_dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = stokes_dofs_per_block[0],</div>
<div class="line">                       n_p = stokes_dofs_per_block[1],</div>
<div class="line">                       n_T = temperature_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_T &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div>
<div class="line">              &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_T &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    stokes_partitioning.resize(2);</div>
<div class="line">    stokes_partitioning[0] = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_u);</div>
<div class="line">    stokes_partitioning[1] = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_p);</div>
<div class="line">    {</div>
<div class="line">      stokes_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">      dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">      dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">      dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        stokes_dof_handler, coupling, dsp, stokes_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      stokes_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      Amg_preconditioner.reset();</div>
<div class="line">      Mp_preconditioner.reset();</div>
<div class="line">      stokes_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">      dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">      dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">      dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        stokes_dof_handler, coupling, dsp, stokes_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      stokes_preconditioner_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      temperature_mass_matrix.clear();</div>
<div class="line">      temperature_stiffness_matrix.clear();</div>
<div class="line">      temperature_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_T, n_T);</div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(temperature_dof_handler,</div>
<div class="line">                                      dsp,</div>
<div class="line">                                      temperature_constraints,</div>
<div class="line">                                      <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      temperature_matrix.reinit(dsp);</div>
<div class="line">      temperature_mass_matrix.reinit(temperature_matrix);</div>
<div class="line">      temperature_stiffness_matrix.reinit(temperature_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> temperature_partitioning = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_T);</div>
<div class="line">    stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    stokes_rhs.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_old_temperature_solution.reinit(temperature_partitioning,</div>
<div class="line">                                        MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    temperature_rhs.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_preconditioner()</div>
<div class="line">  {</div>
<div class="line">    stokes_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(stokes_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div>
<div class="line">                                   quadrature_formula,</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;         phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                grad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> *</div>
<div class="line">                     <a class="code" href="base_2symmetric__tensor_8h.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>], grad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) +</div>
<div class="line">                   (1. / <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a>) * phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                  stokes_fe_values.JxW(q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        stokes_constraints.distribute_local_to_global(</div>
<div class="line">          local_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, stokes_preconditioner_matrix);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::build_stokes_preconditioner()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_preconditioner == <span class="keyword">false</span>)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding Stokes preconditioner...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    assemble_stokes_preconditioner();</div>
<div class="line"> </div>
<div class="line">    Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionAMG&gt;();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;std::vector&lt;bool&gt;</a>&gt; constant_modes;</div>
<div class="line">    <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocity_components(0);</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>(stokes_dof_handler,</div>
<div class="line">                                     stokes_fe.component_mask(</div>
<div class="line">                                       velocity_components),</div>
<div class="line">                                     constant_modes);</div>
<div class="line">    <a class="code" href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a> amg_data;</div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">constant_modes</a> = constant_modes;</div>
<div class="line"> </div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">elliptic</a>              = <span class="keyword">true</span>;</div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">higher_order_elements</a> = <span class="keyword">true</span>;</div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">smoother_sweeps</a>       = 2;</div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">aggregation_threshold</a> = 0.02;</div>
<div class="line">    Amg_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(0, 0),</div>
<div class="line">                                   amg_data);</div>
<div class="line"> </div>
<div class="line">    Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">    Mp_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(1, 1));</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_preconditioner = <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_system()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">      stokes_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    stokes_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(stokes_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(</div>
<div class="line">      stokes_fe,</div>
<div class="line">      quadrature_formula,</div>
<div class="line">      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">        (rebuild_stokes_matrix == <span class="keyword">true</span> ? <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> : <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>(0)));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values(temperature_fe,</div>
<div class="line">                                        quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;          phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; grads_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>             = stokes_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc             = stokes_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       temperature_cell = temperature_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++temperature_cell)</div>
<div class="line">      {</div>
<div class="line">        stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        temperature_fe_values.reinit(temperature_cell);</div>
<div class="line"> </div>
<div class="line">        local_matrix = 0;</div>
<div class="line">        local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                                  old_temperature_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> old_temperature = old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">                  {</div>
<div class="line">                    grads_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                      stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                    div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                      stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                    phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                  local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * 2 * (grads_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grads_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) -</div>
<div class="line">                     div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                    stokes_fe_values.JxW(q);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> gravity =</div>
<div class="line">              -((<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2) ? (<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 1)) : (<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 0, 1)));</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (-<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a> * <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">EquationData::beta</a> *</div>
<div class="line">                               gravity * phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * old_temperature) *</div>
<div class="line">                              stokes_fe_values.JxW(q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">          stokes_constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                                        local_rhs,</div>
<div class="line">                                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                        stokes_matrix,</div>
<div class="line">                                                        stokes_rhs);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          stokes_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                        stokes_rhs);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_matrix = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_matrix()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_temperature_matrices == <span class="keyword">false</span>)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    temperature_mass_matrix      = 0;</div>
<div class="line">    temperature_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>   quadrature_formula(temperature_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values(temperature_fe,</div>
<div class="line">                                        quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = temperature_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_mass_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_stiffness_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        local_mass_matrix      = 0;</div>
<div class="line">        local_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                {</div>
<div class="line">                  local_mass_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] * temperature_fe_values.JxW(q));</div>
<div class="line">                  local_stiffness_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (<a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> * grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">                     temperature_fe_values.JxW(q));</div>
<div class="line">                }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        temperature_constraints.distribute_local_to_global(</div>
<div class="line">          local_mass_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, temperature_mass_matrix);</div>
<div class="line">        temperature_constraints.distribute_local_to_global(</div>
<div class="line">          local_stiffness_matrix,</div>
<div class="line">          <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">          temperature_stiffness_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    rebuild_temperature_matrices = <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_system(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (use_bdf2_scheme == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">        temperature_matrix *=</div>
<div class="line">          (2 * time_step + old_time_step) / (time_step + old_time_step);</div>
<div class="line">        temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">        temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    temperature_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(temperature_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     temperature_fe_values(temperature_fe,</div>
<div class="line">                                        quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div>
<div class="line">                                   quadrature_formula,</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = temperature_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_temperature_grads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_temperature_grads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_temperature_laplacians(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_old_temperature_laplacians(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    EquationData::TemperatureRightHandSide&lt;dim&gt; temperature_right_hand_side;</div>
<div class="line">    std::vector&lt;double&gt;                         gamma_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range =</div>
<div class="line">      get_extrapolated_temperature_range();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>        = temperature_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc        = temperature_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       stokes_cell = stokes_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++stokes_cell)</div>
<div class="line">      {</div>
<div class="line">        local_rhs = 0;</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        stokes_fe_values.reinit(stokes_cell);</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                                  old_temperature_values);</div>
<div class="line">        temperature_fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                                  old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.get_function_gradients(old_temperature_solution,</div>
<div class="line">                                                     old_temperature_grads);</div>
<div class="line">        temperature_fe_values.get_function_gradients(</div>
<div class="line">          old_old_temperature_solution, old_old_temperature_grads);</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.get_function_laplacians(</div>
<div class="line">          old_temperature_solution, old_temperature_laplacians);</div>
<div class="line">        temperature_fe_values.get_function_laplacians(</div>
<div class="line">          old_old_temperature_solution, old_old_temperature_laplacians);</div>
<div class="line"> </div>
<div class="line">        temperature_right_hand_side.<a class="code" href="classFunction.html#a562fc1114e95e702e6696721f71528db">value_list</a>(</div>
<div class="line">          temperature_fe_values.get_quadrature_points(), gamma_values);</div>
<div class="line"> </div>
<div class="line">        stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                         old_velocity_values);</div>
<div class="line">        stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">          old_stokes_solution, old_old_velocity_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">          compute_viscosity(old_temperature_values,</div>
<div class="line">                            old_old_temperature_values,</div>
<div class="line">                            old_temperature_grads,</div>
<div class="line">                            old_old_temperature_grads,</div>
<div class="line">                            old_temperature_laplacians,</div>
<div class="line">                            old_old_temperature_laplacians,</div>
<div class="line">                            old_velocity_values,</div>
<div class="line">                            old_old_velocity_values,</div>
<div class="line">                            gamma_values,</div>
<div class="line">                            maximal_velocity,</div>
<div class="line">                            global_T_range.second - global_T_range.first,</div>
<div class="line">                            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> T_term_for_rhs =</div>
<div class="line">              (use_bdf2_scheme ?</div>
<div class="line">                 (old_temperature_values[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                  old_old_temperature_values[q] * (time_step * time_step) /</div>
<div class="line">                    (old_time_step * (time_step + old_time_step))) :</div>
<div class="line">                 old_temperature_values[q]);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> ext_grad_T =</div>
<div class="line">              (use_bdf2_scheme ?</div>
<div class="line">                 (old_temperature_grads[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                  old_old_temperature_grads[q] * time_step / old_time_step) :</div>
<div class="line">                 old_temperature_grads[q]);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> extrapolated_u =</div>
<div class="line">              (use_bdf2_scheme ?</div>
<div class="line">                 (old_velocity_values[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                  old_old_velocity_values[q] * time_step / old_time_step) :</div>
<div class="line">                 old_velocity_values[q]);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                (T_term_for_rhs * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">                 time_step * extrapolated_u * ext_grad_T * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">                 time_step * nu * ext_grad_T * grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] +</div>
<div class="line">                 time_step * gamma_values[q] * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) *</div>
<div class="line">                temperature_fe_values.JxW(q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        temperature_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                           <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                           temperature_rhs);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">BoussinesqFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                         <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">        mp_inverse(stokes_preconditioner_matrix.block(1, 1),</div>
<div class="line">                   *Mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">        <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">        <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">        <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix, mp_inverse, *Amg_preconditioner);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(stokes_matrix.m(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * stokes_rhs.l2_norm());</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverGMRES.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> gmres(</div>
<div class="line">        solver_control,</div>
<div class="line">        <a class="code" href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(100));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; stokes_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (stokes_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">          stokes_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line">      gmres.solve(stokes_matrix, stokes_solution, stokes_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">      stokes_constraints.distribute(stokes_solution);</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot; GMRES iterations for Stokes subsystem.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    old_time_step                 = time_step;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity = get_maximal_velocity();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (maximal_velocity &gt;= 0.01)</div>
<div class="line">      time_step = 1. / (1.7 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> * <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) / temperature_degree *</div>
<div class="line">                  <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) /</div>
<div class="line">                  maximal_velocity;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      time_step = 1. / (1.7 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> * <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) / temperature_degree *</div>
<div class="line">                  <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) / .01;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span></div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Time step: &quot;</span> &lt;&lt; time_step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    temperature_solution = old_temperature_solution;</div>
<div class="line"> </div>
<div class="line">    assemble_temperature_system(maximal_velocity);</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(temperature_matrix.m(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-8 * temperature_rhs.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">      <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(temperature_matrix);</div>
<div class="line"> </div>
<div class="line">      cg.solve(temperature_matrix,</div>
<div class="line">               temperature_solution,</div>
<div class="line">               temperature_rhs,</div>
<div class="line">               <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">      temperature_constraints.distribute(temperature_solution);</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot; CG iterations for temperature.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> min_temperature = temperature_solution(0),</div>
<div class="line">             max_temperature = temperature_solution(0);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; temperature_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          min_temperature =</div>
<div class="line">            std::min&lt;double&gt;(min_temperature, temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">          max_temperature =</div>
<div class="line">            std::max&lt;double&gt;(max_temperature, temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Temperature range: &quot;</span> &lt;&lt; min_temperature &lt;&lt; <span class="charliteral">&#39; &#39;</span></div>
<div class="line">                &lt;&lt; max_temperature &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number % 10 != 0)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;std::string&gt; stokes_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">    stokes_names.emplace_back(<span class="stringliteral">&quot;p&quot;</span>);</div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      stokes_component_interpretation(</div>
<div class="line">        <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      stokes_component_interpretation[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] =</div>
<div class="line">        <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(stokes_dof_handler,</div>
<div class="line">                             stokes_solution,</div>
<div class="line">                             stokes_names,</div>
<div class="line">                             stokes_component_interpretation);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(temperature_dof_handler,</div>
<div class="line">                             temperature_solution,</div>
<div class="line">                             <span class="stringliteral">&quot;T&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(stokes_degree, temperature_degree));</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution-&quot;</span> +</div>
<div class="line">                         <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 4) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(temperature_dof_handler,</div>
<div class="line">                                       <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(temperature_degree + 1),</div>
<div class="line">                                       {},</div>
<div class="line">                                       temperature_solution,</div>
<div class="line">                                       estimated_error_per_cell);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                      estimated_error_per_cell,</div>
<div class="line">                                                      0.8,</div>
<div class="line">                                                      0.1);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> :</div>
<div class="line">           <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators_on_level(max_grid_level))</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_temperature(2);</div>
<div class="line">    x_temperature[0]                            = temperature_solution;</div>
<div class="line">    x_temperature[1]                            = old_temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> x_stokes = stokes_solution;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> temperature_trans(</div>
<div class="line">      temperature_dof_handler);</div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> stokes_trans(</div>
<div class="line">      stokes_dof_handler);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">    temperature_trans.prepare_for_coarsening_and_refinement(x_temperature);</div>
<div class="line">    stokes_trans.prepare_for_coarsening_and_refinement(x_stokes);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp(2);</div>
<div class="line">    tmp[0].<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(temperature_solution);</div>
<div class="line">    tmp[1].<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(temperature_solution);</div>
<div class="line">    temperature_trans.interpolate(x_temperature, tmp);</div>
<div class="line"> </div>
<div class="line">    temperature_solution     = tmp[0];</div>
<div class="line">    old_temperature_solution = tmp[1];</div>
<div class="line"> </div>
<div class="line">    temperature_constraints.distribute(temperature_solution);</div>
<div class="line">    temperature_constraints.distribute(old_temperature_solution);</div>
<div class="line"> </div>
<div class="line">    stokes_trans.interpolate(x_stokes, stokes_solution);</div>
<div class="line"> </div>
<div class="line">    stokes_constraints.distribute(stokes_solution);</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_matrix         = <span class="keyword">true</span>;</div>
<div class="line">    rebuild_temperature_matrices  = <span class="keyword">true</span>;</div>
<div class="line">    rebuild_stokes_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">BoussinesqFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 4 : 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 4 : 3);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">    global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(initial_refinement);</div>
<div class="line"> </div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">  start_time_iteration:</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(temperature_dof_handler,</div>
<div class="line">                         temperature_constraints,</div>
<div class="line">                         <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(temperature_degree + 2),</div>
<div class="line">                         EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">                         old_temperature_solution);</div>
<div class="line"> </div>
<div class="line">    timestep_number = 0;</div>
<div class="line">    time_step = old_time_step = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_stokes_system();</div>
<div class="line">        build_stokes_preconditioner();</div>
<div class="line">        assemble_temperature_matrix();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        output_results();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; n_pre_refinement_steps))</div>
<div class="line">          {</div>
<div class="line">            refine_mesh(initial_refinement + n_pre_refinement_steps);</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 5 == 0))</div>
<div class="line">          refine_mesh(initial_refinement + n_pre_refinement_steps);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">        ++timestep_number;</div>
<div class="line"> </div>
<div class="line">        old_stokes_solution          = stokes_solution;</div>
<div class="line">        old_old_temperature_solution = old_temperature_solution;</div>
<div class="line">        old_temperature_solution     = temperature_solution;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &lt;= 100);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step31</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep31.html">Step31</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-31&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      BoussinesqFlowProblem&lt;2&gt; flow_problem;</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><br  />
 This tutorial depends on <a class="el" href="step_22.html">step-22</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#TheBoussinesqequations">The Boussinesq equations</a><a href="#TheBoussinesqequations">The Boussinesq equations</a>
        <li><a href="#Boundaryandinitialconditions">Boundary and initial conditions</a><a href="#Boundaryandinitialconditions">Boundary and initial conditions</a>
        <li><a href="#Solutionapproach">Solution approach</a><a href="#Solutionapproach">Solution approach</a>
      <ul>
        <li><a href="#Timestepping">Time stepping</a><a href="#Timestepping">Time stepping</a>
        <li><a href="#WeakformandspacediscretizationfortheStokespart">Weak form and space discretization for the Stokes part</a><a href="#WeakformandspacediscretizationfortheStokespart">Weak form and space discretization for the Stokes part</a>
        <li><a href="#Stabilizationweakformandspacediscretizationforthetemperatureequation">Stabilization, weak form and space discretization for the temperature equation</a><a href="#Stabilizationweakformandspacediscretizationforthetemperatureequation">Stabilization, weak form and space discretization for the temperature equation</a>
        <li><a href="#Linearsolvers">Linear solvers</a><a href="#Linearsolvers">Linear solvers</a>
      <ul>
        <li><a href="#LinearsolversfortheStokesproblem">Linear solvers for the Stokes problem</a><a href="#LinearsolversfortheStokesproblem">Linear solvers for the Stokes problem</a>
        <li><a href="#Linearsolversforthetemperatureequation">Linear solvers for the temperature equation</a><a href="#Linearsolversforthetemperatureequation">Linear solvers for the temperature equation</a>
      </ul>
      </ul>
        <li><a href="#Implementationdetails">Implementation details</a><a href="#Implementationdetails">Implementation details</a>
      <ul>
        <li><a href="#UsingdifferentDoFHandlerobjects">Using different DoFHandler objects</a><a href="#UsingdifferentDoFHandlerobjects">Using different DoFHandler objects</a>
        <li><a href="#UsingTrilinos">Using Trilinos</a><a href="#UsingTrilinos">Using Trilinos</a>
      </ul>
        <li><a href="#Thetestcase">The testcase</a><a href="#Thetestcase">The testcase</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#Equationdata">Equation data</a><a href="#Equationdata">Equation data</a>
        <li><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a>
      <ul>
        <li><a href="#ThecodeInverseMatrixcodeclasstemplate">The <code>InverseMatrix</code> class template</a><a href="#ThecodeInverseMatrixcodeclasstemplate">The <code>InverseMatrix</code> class template</a>
        <li><a href="#Schurcomplementpreconditioner">Schur complement preconditioner</a><a href="#Schurcomplementpreconditioner">Schur complement preconditioner</a>
      </ul>
        <li><a href="#ThecodeBoussinesqFlowProblemcodeclasstemplate">The <code>BoussinesqFlowProblem</code> class template</a><a href="#ThecodeBoussinesqFlowProblemcodeclasstemplate">The <code>BoussinesqFlowProblem</code> class template</a>
        <li><a href="#BoussinesqFlowProblemclassimplementation">BoussinesqFlowProblem class implementation</a><a href="#BoussinesqFlowProblemclassimplementation">BoussinesqFlowProblem class implementation</a>
      <ul>
        <li><a href="#BoussinesqFlowProblemBoussinesqFlowProblem">BoussinesqFlowProblem::BoussinesqFlowProblem</a><a href="#BoussinesqFlowProblemBoussinesqFlowProblem">BoussinesqFlowProblem::BoussinesqFlowProblem</a>
        <li><a href="#BoussinesqFlowProblemget_maximal_velocity">BoussinesqFlowProblem::get_maximal_velocity</a><a href="#BoussinesqFlowProblemget_maximal_velocity">BoussinesqFlowProblem::get_maximal_velocity</a>
        <li><a href="#BoussinesqFlowProblemget_extrapolated_temperature_range">BoussinesqFlowProblem::get_extrapolated_temperature_range</a><a href="#BoussinesqFlowProblemget_extrapolated_temperature_range">BoussinesqFlowProblem::get_extrapolated_temperature_range</a>
        <li><a href="#BoussinesqFlowProblemcompute_viscosity">BoussinesqFlowProblem::compute_viscosity</a><a href="#BoussinesqFlowProblemcompute_viscosity">BoussinesqFlowProblem::compute_viscosity</a>
        <li><a href="#BoussinesqFlowProblemsetup_dofs">BoussinesqFlowProblem::setup_dofs</a><a href="#BoussinesqFlowProblemsetup_dofs">BoussinesqFlowProblem::setup_dofs</a>
        <li><a href="#BoussinesqFlowProblemassemble_stokes_preconditioner">BoussinesqFlowProblem::assemble_stokes_preconditioner</a><a href="#BoussinesqFlowProblemassemble_stokes_preconditioner">BoussinesqFlowProblem::assemble_stokes_preconditioner</a>
        <li><a href="#BoussinesqFlowProblembuild_stokes_preconditioner">BoussinesqFlowProblem::build_stokes_preconditioner</a><a href="#BoussinesqFlowProblembuild_stokes_preconditioner">BoussinesqFlowProblem::build_stokes_preconditioner</a>
        <li><a href="#BoussinesqFlowProblemassemble_stokes_system">BoussinesqFlowProblem::assemble_stokes_system</a><a href="#BoussinesqFlowProblemassemble_stokes_system">BoussinesqFlowProblem::assemble_stokes_system</a>
        <li><a href="#BoussinesqFlowProblemassemble_temperature_matrix">BoussinesqFlowProblem::assemble_temperature_matrix</a><a href="#BoussinesqFlowProblemassemble_temperature_matrix">BoussinesqFlowProblem::assemble_temperature_matrix</a>
        <li><a href="#BoussinesqFlowProblemassemble_temperature_system">BoussinesqFlowProblem::assemble_temperature_system</a><a href="#BoussinesqFlowProblemassemble_temperature_system">BoussinesqFlowProblem::assemble_temperature_system</a>
        <li><a href="#BoussinesqFlowProblemsolve">BoussinesqFlowProblem::solve</a><a href="#BoussinesqFlowProblemsolve">BoussinesqFlowProblem::solve</a>
        <li><a href="#BoussinesqFlowProblemoutput_results">BoussinesqFlowProblem::output_results</a><a href="#BoussinesqFlowProblemoutput_results">BoussinesqFlowProblem::output_results</a>
        <li><a href="#BoussinesqFlowProblemrefine_mesh">BoussinesqFlowProblem::refine_mesh</a><a href="#BoussinesqFlowProblemrefine_mesh">BoussinesqFlowProblem::refine_mesh</a>
        <li><a href="#BoussinesqFlowProblemrun">BoussinesqFlowProblem::run</a><a href="#BoussinesqFlowProblemrun">BoussinesqFlowProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Resultsin2d"> Results in 2d </a><a href="#Resultsin2d"> Results in 2d </a>
        <li><a href="#Resultsin3d"> Results in 3d </a><a href="#Resultsin3d"> Results in 3d </a>
        <li><a href="#Numericalexperimentstodetermineoptimalparameters"> Numerical experiments to determine optimal parameters </a><a href="#Numericalexperimentstodetermineoptimalparameters"> Numerical experiments to determine optimal parameters </a>
      <ul>
        <li><a href="#Choosingicsubksubiandbeta"> Choosing <i>c<sub>k</sub></i><a href="#Choosingicsubksubiandbeta"> Choosing <i>c<sub>k</sub></i> and beta </a><i>c<sub>k</sub></i> and beta </a>
      <ul>
        <li><a href="#ResultsforQsub1subelements">Results for Q<sub>1</sub> elements</a><a href="#ResultsforQsub1subelements">Results for Q<sub>1</sub> elements</a>
        <li><a href="#ResultsforQsub2subelements">Results for Q<sub>2</sub> elements</a><a href="#ResultsforQsub2subelements">Results for Q<sub>2</sub> elements</a>
        <li><a href="#Resultsfor3d">Results for 3d</a><a href="#Resultsfor3d">Results for 3d</a>
        <li><a href="#Conclusions">Conclusions</a><a href="#Conclusions">Conclusions</a>
      </ul>
      </ul>
        <li><a href="#Possibilitiesforextensions"> Possibilities for extensions </a><a href="#Possibilitiesforextensions"> Possibilities for extensions </a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
 <br  />
 <em>This program was contributed by Martin Kronbichler and Wolfgang Bangerth. <br  />
 This material is based upon work partly supported by the National Science Foundation under Award No. EAR-0426271 and The California Institute of Technology. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation or of The California Institute of Technology. </em></p>
<p><a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p><a class="anchor" id="TheBoussinesqequations"></a></p><h3>The Boussinesq equations</h3>
<p>This program deals with an interesting physical problem: how does afluid (i.e., a liquid or gas) behave if it experiences differences inbuoyancy caused by temperature differences? It is clear that thoseparts of the fluid that are hotter (and therefore lighter) are goingto rise up and those that are cooler (and denser) are going to sinkdown with gravity. In cases where the fluid moves slowly enough such that inertial effectscan be neglected, the equations that describe such behavior are theBoussinesq equations that read as follows: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; -\rho\; \beta \; T\; \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0, \\ \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma. \end{eqnarray*}
</p>
<p> These equations fall into the class of vector-valued problems (atoplevel overview of this topic can be found in the <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> module).Here, \(\mathbf u\) is the velocity field, \(p\) the pressure, and \(T\) the temperature of the fluid. \(\varepsilon ({\mathbf u}) = \frac 12 [(\nabla{\mathbf u}) + (\nabla {\mathbf u})^T]\) is the symmetricgradient of the velocity. As can be seen, velocity and pressuresolve a Stokes equation describing the motion of an incompressiblefluid, an equation we have previously considered in <a class="el" href="step_22.html">step-22</a> ; wewill draw extensively on the experience we have gained in that program, inparticular with regard to efficient linear Stokes solvers. The forcing term of the fluid motion is the buoyancy of thefluid, expressed as the product of the density \(\rho\) , the thermal expansioncoefficient \(\beta\) ,the temperature \(T\) and the gravity vector \(\mathbf{g}\) pointingdownward. (A derivation of why the right hand side looks like it looksis given in the introduction of <a class="el" href="step_32.html">step-32</a> .)While the first two equations describe how the fluid reacts totemperature differences by moving around, the third equation stateshow the fluid motion affects the temperature field: it is an advectiondiffusion equation, i.e., the temperature is attached to the fluidparticles and advected along in the flow field, with an additionaldiffusion (heat conduction) term. In many applications, the diffusioncoefficient is fairly small, and the temperature equation is in facttransport, not diffusion dominated and therefore in character more hyperbolicthan elliptic; we will have to take this into account when developing a stablediscretization. In the equations above, the term \(\gamma\) on the right hand side denotes theheat sources and may be a spatially and temporally varying function. \(\eta\) and \(\kappa\) denote the viscosity and diffusivity coefficients, which we assumeconstant for this tutorial program. The more general case when \(\eta\) depends onthe temperature is an important factor in physical applications: Most materialsbecome more fluid as they get hotter (i.e., \(\eta\) decreases with \(T\) );sometimes, as in the case of rock minerals at temperatures close to theirmelting point, \(\eta\) may change by orders of magnitude over the typical rangeof temperatures. We note that the Stokes equation above could be nondimensionalized byintroducing the <a href="http://en.wikipedia.org/wiki/Rayleigh_number" target="_top">Rayleigh number</a> \(\mathrm{Ra}=\frac{\|\mathbf{g}\| \beta \rho}{\eta \kappa} \delta T L^3\) using atypical length scale \(L\) , typical temperature difference \(\delta T\) , density \(\rho\) , thermal diffusivity \(\eta\) , and thermal conductivity \(\kappa\) . \(\mathrm{Ra}\) is a dimensionless number that describes the ratio of heattransport due to convection induced by buoyancy changes fromtemperature differences, and of heat transport due to thermaldiffusion. A small Rayleigh number implies that buoyancy is not strongrelative to viscosity and fluid motion \(\mathbf{u}\) is slow enough sothat heat diffusion \(\kappa\nabla T\) is the dominant heat transportterm. On the other hand, a fluid with a high Rayleigh number will showvigorous convection that dominates heat conduction. For most fluids for which we are interested in computing thermalconvection, the Rayleigh number is very large, often \(10^6\) orlarger. From the structure of the equations, we see that this willlead to large pressure differences and large velocities. Consequently,the convection term in the convection-diffusion equation for \(T\) willalso be very large and an accurate solution of this equation willrequire us to choose small time steps. Problems with large Rayleighnumbers are therefore hard to solve numerically for similar reasonsthat make solving the <a href="http://en.wikipedia.org/wiki/Navier-stokes_equations">Navier-Stokes equations</a> hard to solve when the <a href="http://en.wikipedia.org/wiki/Reynolds_number">Reynolds number \(\mathrm{Re}\)</a> is large. Note that a large Rayleigh number does not necessarily involve largevelocities in absolute terms. For example, the Rayleigh number in theearth mantle is larger than \(10^6\) . Yet thevelocities are small: the material is in fact solid rock but it is sohot and under pressure that it can flow very slowly, on the order ofat most a few centimeters per year. Nevertheless, this can lead tomixing over time scales of many million years, a time scale muchshorter than for the same amount of heat to be distributed by thermalconductivity and a time scale of relevance to affect the evolution of theearth's interior and surface structure. </p><dl class="section note"><dt>Note</dt><dd>If you are interested in using the program as the basis for your ownexperiments, you will also want to take a look at its continuation in <a class="el" href="step_32.html">step-32</a> . Furthermore, <a class="el" href="step_32.html">step-32</a> later was developed into the much larger opensource code ASPECT (see <a href="https://aspect.geodynamics.org/">https://aspect.geodynamics.org/</a> ) that can solve realisticproblems and that you may want to investigate before trying to morph <a class="el" href="step_31.html">step-31</a> into something that can solve whatever you want to solve.</dd></dl>
<p><a class="anchor" id="Boundaryandinitialconditions"></a></p><h3>Boundary and initial conditions</h3>
<p>Since the Boussinesq equations are derived under the assumption that inertiaof the fluid's motion does not play a role, the flow field is at each timeentirely determined by buoyancy difference at that time, not by the flow fieldat previous times. This is reflected by the fact that the first two equationsabove are the steady state Stokes equation that do not contain a timederivative. Consequently, we do not need initial conditions for eithervelocities or pressure. On the other hand, the temperature field does satisfyan equation with a time derivative, so we need initial conditions for \(T\) . As for boundary conditions: if \(\kappa&gt;0\) then the temperaturesatisfies a second order differential equation that requiresboundary data all around the boundary for all times. These can either be aprescribed boundary temperature \(T|_{\partial\Omega}=T_b\) (Dirichlet boundaryconditions), or a prescribed thermal flux \(\mathbf{n}\cdot\kappa\nabla T|_{\partial\Omega}=\phi\) ; in this program, we will use an insulated boundarycondition, i.e., prescribe no thermal flux: \(\phi=0\) . Similarly, the velocity field requires us to pose boundary conditions. Thesemay be no-slip no-flux conditions \(\mathbf{u}=0\) on \(\partial\Omega\) if the fluidsticks to the boundary, or no normal flux conditions \(\mathbf n \cdot \mathbf u = 0\) if the fluid can flow along but not across the boundary, or any numberof other conditions that are physically reasonable. In this program, we willuse no normal flux conditions.</p>
<p><a class="anchor" id="Solutionapproach"></a></p><h3>Solution approach</h3>
<p>Like the equations solved in <a class="el" href="step_21.html">step-21</a> , we here have asystem of differential-algebraic equations (DAE): with respect to the timevariable, only the temperature equation is a differential equationwhereas the Stokes system for \(\mathbf{u}\) and \(p\) has notime-derivatives and is therefore of the sort of an algebraicconstraint that has to hold at each time instant. The main differenceto <a class="el" href="step_21.html">step-21</a> is that the algebraic constraint there was amixed Laplace system of the form </p><p class="formulaDsp">
\begin{eqnarray*} \mathbf u + {\mathbf K}\lambda \nabla p &amp;=&amp; 0, \\ \nabla\cdot \mathbf u &amp;=&amp; f, \end{eqnarray*}
</p>
<p> where now we have a Stokes system </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; f, \\ \nabla\cdot \mathbf u &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> where \(\nabla \cdot \eta \varepsilon (\cdot)\) is an operator similar to theLaplacian \(\Delta\) applied to a vector field. Given the similarity to what we have done in <a class="el" href="step_21.html">step-21</a> ,it may not come as a surprise that we choose a similar approach,although we will have to make adjustments for the change in operatorin the top-left corner of the differential operator.</p>
<p><a class="anchor" id="Timestepping"></a></p><h4>Time stepping</h4>
<p>The structure of the problem as a DAE allows us to use the same strategy aswe have already used in <a class="el" href="step_21.html">step-21</a> , i.e., we use a time lagscheme: we first solve the temperature equation (using an extrapolatedvelocity field), and then insert the new temperature solution into the righthand side of the velocity equation. The way we implement this in our codelooks at things from a slightly different perspective, though. We firstsolve the Stokes equations for velocity and pressure using the temperaturefield from the previous time step, which means that we get the velocity forthe previous time step. In other words, we first solve the Stokes system fortime step \(n - 1\) as </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2\eta \varepsilon ({\mathbf u}^{n-1})) + \nabla p^{n-1} &amp;=&amp; -\rho\; \beta \; T^{n-1} \mathbf{g}, \\ \nabla \cdot {\mathbf u}^{n-1} &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> and then the temperature equation with an extrapolated velocity field totime \(n\) . In contrast to <a class="el" href="step_21.html">step-21</a> , we'll use a higher order timestepping scheme here, namely the <a href="http://en.wikipedia.org/wiki/Backward_differentiation_formula">Backward Differentiation Formula scheme of order 2 (BDF-2 in short)</a> that replacesthe time derivative \(\frac{\partial T}{\partial t}\) by the (one-sided)difference quotient \(\frac{\frac 32 T^{n}-2T^{n-1}+\frac 12 T^{n-2}}{k}\) with \(k\) the time step size. This gives the discretized-in-timetemperature equation </p><p class="formulaDsp">
\begin{eqnarray*} \frac 32 T^n - k\nabla \cdot \kappa \nabla T^n &amp;=&amp; 2 T^{n-1} - \frac 12 T^{n-2} - k(2{\mathbf u}^{n-1} - {\mathbf u}^{n-2} ) \cdot \nabla (2T^{n-1}-T^{n-2}) + k\gamma. \end{eqnarray*}
</p>
<p> Note how the temperature equation is solved semi-explicitly: diffusion istreated implicitly whereas advection is treated explicitly using anextrapolation (or forward-projection) of temperature and velocity, includingthe just-computed velocity \({\mathbf u}^{n-1}\) . The forward-projection tothe current time level \(n\) is derived from a Taylor expansion, \(T^n \approx T^{n-1} + k_n \frac{\partial T}{\partial t} \approx T^{n-1} + k_n \frac{T^{n-1}-T^{n-2}}{k_n} = 2T^{n-1}-T^{n-2}\) . We need this projection formaintaining the order of accuracy of the BDF-2 scheme. In other words, thetemperature fields we use in the explicit right hand side are second orderapproximations of the current temperature field &mdash; not quite anexplicit time stepping scheme, but by character not too far away either. The introduction of the temperature extrapolation limits the time step by a<a href="http://en.wikipedia.org/wiki/Courant–Friedrichs–Lewy_condition">Courant-Friedrichs-Lewy (CFL) condition</a> just like it was in <a class="el" href="step_21.html">@ref step_21 </a>step-21"  ". (We wouldn't have had that stability condition if we treated theadvection term implicitly since the BDF-2 scheme is A-stable, at the pricethat we needed to build a new temperature matrix at each time step.) We willdiscuss the exact choice of time step in the <a href="#Results">results section</a>, but for the moment of importance is that this CFL conditionmeans that the time step size \(k\) may change from time step to timestep, and that we have to modify the above formula slightly. If \(k_n,k_{n-1}\) are the time steps sizes of the current and previous timestep, then we use the approximations </p><p class="formulaDsp">
\begin{align*} \frac{\partial T}{\partial t} \approx \frac 1{k_n} \left( \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} T^{n} - \frac{k_n+k_{n-1}}{k_{n-1}}T^{n-1} + \frac{k_n^2}{k_{n-1}(k_n+k_{n-1})} T^{n-2} \right) \end{align*}
</p>
<p> and </p><p class="formulaDsp">
\begin{align*} T^n \approx T^{n-1} + k_n \frac{\partial T}{\partial t} \approx T^{n-1} + k_n \frac{T^{n-1}-T^{n-2}}{k_{n-1}} = \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2}, \end{align*}
</p>
<p> and above equation is generalized as follows: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} T^n - k_n\nabla \cdot \kappa \nabla T^n &amp;=&amp; \frac{k_n+k_{n-1}}{k_{n-1}} T^{n-1} - \frac{k_n^2}{k_{n-1}(k_n+k_{n-1})} T^{n-2} - k_n{\mathbf u}^{*,n} \cdot \nabla T^{*,n} + k_n\gamma, \end{eqnarray*}
</p>
<p>where \({(\cdot)}^{*,n} = \left(1+\frac{k_n}{k_{n-1}}\right)(\cdot)^{n-1} - \frac{k_n}{k_{n-1}}(\cdot)^{n-2}\) denotes the extrapolation of velocity \(\mathbf u\) and temperature \(T\) to time level \(n\) , using the valuesat the two previous time steps. That's not an easy to read equation, butwill provide us with the desired higher order accuracy. As a consistencycheck, it is easy to verify that it reduces to the same equation as above if \(k_n=k_{n-1}\) . As a final remark we note that the choice of a higher order timestepping scheme of course forces us to keep more time steps in memory;in particular, we here will need to have \(T^{n-2}\) around, a vectorthat we could previously discard. This seems like a nuisance that wewere able to avoid previously by using only a first order timestepping scheme, but as we will see below when discussing the topic ofstabilization, we will need this vector anyway and so keeping itaround for time discretization is essentially for free and gives usthe opportunity to use a higher order scheme.</p>
<p><a class="anchor" id="WeakformandspacediscretizationfortheStokespart"></a></p><h4>Weak form and space discretization for the Stokes part</h4>
<p>Like solving the mixed Laplace equations, solving the Stokes equationsrequires us to choose particular pairs of finite elements forvelocities and pressure variables. Because this has already been discussed in <a class="el" href="step_22.html">step-22</a> , we only cover this topic briefly:Here, we use thestable pair \(Q_{p+1}^d \times Q_p, p\ge 1\) . These are continuouselements, so we can form the weak form of the Stokes equation withoutproblem by integrating by parts and substituting continuous functionsby their discrete counterparts: </p><p class="formulaDsp">
\begin{eqnarray*} (\nabla {\mathbf v}_h, 2\eta \varepsilon ({\mathbf u}^{n-1}_h)) - (\nabla \cdot {\mathbf v}_h, p^{n-1}_h) &amp;=&amp; -({\mathbf v}_h, \rho\; \beta \; T^{n-1}_h \mathbf{g}), \\ (q_h, \nabla \cdot {\mathbf u}^{n-1}_h) &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> for all test functions \(\mathbf v_h, q_h\) . The first term of the firstequation is considered as the inner product between tensors, i.e. \((\nabla {\mathbf v}_h, \eta \varepsilon ({\mathbf u}^{n-1}_h))_\Omega = \int_\Omega \sum_{i,j=1}^d [\nabla {\mathbf v}_h]_{ij} \eta [\varepsilon ({\mathbf u}^{n-1}_h)]_{ij}\, dx\) .Because the second tensor in this product is symmetric, theanti-symmetric component of \(\nabla {\mathbf v}_h\) plays no role andit leads to the entirely same form if we use the symmetric gradient of \(\mathbf v_h\) instead. Consequently, the formulation we consider andthat we implement is </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon({\mathbf v}_h), 2\eta \varepsilon ({\mathbf u}^{n-1}_h)) - (\nabla \cdot {\mathbf v}_h, p^{n-1}_h) &amp;=&amp; -({\mathbf v}_h, \rho\; \beta \; T^{n-1}_h \mathbf{g}), \\ (q_h, \nabla \cdot {\mathbf u}^{n-1}_h) &amp;=&amp; 0. \end{eqnarray*}
</p>
<p>This is exactly the same as what we already discussed in <a class="el" href="step_22.html">step-22</a> and there is not much more to say about this here.</p>
<p><a class="anchor" id="Stabilizationweakformandspacediscretizationforthetemperatureequation"></a></p><h4>Stabilization, weak form and space discretization for the temperature equation</h4>
<p>The more interesting question is what to do with the temperatureadvection-diffusion equation. By default, not all discretizations ofthis equation are equally stable unless we either do something likeupwinding, stabilization, or all of this. One way to achieve this isto use discontinuous elements (i.e., the <a class="el" href="classFE__DGQ.html">FE_DGQ</a> class that we used, forexample, in the discretization of the transport equation in <a class="el" href="step_12.html">step-12</a> , or in discretizing the pressure in <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a> ) and to define aflux at the interface between cells that takes into accountupwinding. If we had a pure advection problem this would probably bethe simplest way to go. However, here we have some diffusion as well,and the discretization of the Laplace operator with discontinuouselements is cumbersome because of the significant number of additionalterms that need to be integrated on each face betweencells. Discontinuous elements also have the drawback that the use ofnumerical fluxes introduces an additional numerical diffusion thatacts everywhere, whereas we would really like to minimize the effectof numerical diffusion to a minimum and only apply it where it isnecessary to stabilize the scheme. A better alternative is therefore to add some nonlinear viscosity tothe model. Essentially, what this does is to transform the temperatureequation from the form </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma \end{eqnarray*}
</p>
<p> to something like </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot (\kappa+\nu(T)) \nabla T &amp;=&amp; \gamma, \end{eqnarray*}
</p>
<p> where \(\nu(T)\) is an addition viscosity (diffusion) term that onlyacts in the vicinity of shocks and other discontinuities. \(\nu(T)\) ischosen in such a way that if \(T\) satisfies the original equations, theadditional viscosity is zero. To achieve this, the literature contains a number of approaches. Wewill here follow one developed by Guermond and Popov that builds on asuitably defined residual and a limiting procedure for the additionalviscosity. To this end, let us define a residual \(R_\alpha(T)\) as follows: </p><p class="formulaDsp">
\begin{eqnarray*} R_\alpha(T) = \left( \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T - \gamma \right) T^{\alpha-1} \end{eqnarray*}
</p>
<p> where we will later choose the stabilization exponent \(\alpha\) fromwithin the range \([1,2]\) . Note that \(R_\alpha(T)\) will be zero if \(T\) satisfies the temperature equation, since then the term in parentheseswill be zero. Multiplying terms out, we get the following, entirelyequivalent form: </p><p class="formulaDsp">
\begin{eqnarray*} R_\alpha(T) = \frac 1\alpha \frac{\partial (T^\alpha)}{\partial t} + \frac 1\alpha {\mathbf u} \cdot \nabla (T^\alpha) - \frac 1\alpha \nabla \cdot \kappa \nabla (T^\alpha) + \kappa(\alpha-1) T^{\alpha-2} |\nabla T|^2 - \gamma T^{\alpha-1} \end{eqnarray*}
</p>
<p>With this residual, we can now define the artificial viscosity asa piecewise constant function defined on each cell \(K\) with diameter \(h_K\) separately asfollows: </p><p class="formulaDsp">
\begin{eqnarray*} \nu_\alpha(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} \min\left\{ h_K, h_K^\alpha \frac{\|R_\alpha(T)\|_{L^\infty(K)}}{c(\mathbf{u},T)} \right\} \end{eqnarray*}
</p>
<p>Here, \(\beta\) is a stabilization constant (a dimensional analysisreveals that it is unitless and therefore independent of scaling; we willdiscuss its choice in the <a href="#Results">results section</a>) and \(c(\mathbf{u},T)\) is a normalization constant that must have units \(\frac{m^{\alpha-1}K^\alpha}{s}\) . We will choose it as \(c(\mathbf{u},T) = c_R\ \|\mathbf{u}\|_{L^\infty(\Omega)} \ \mathrm{var}(T) \ |\mathrm{diam}(\Omega)|^{\alpha-2}\) ,where \(\mathrm{var}(T)=\max_\Omega T - \min_\Omega T\) is the range of presenttemperature values (remember that buoyancy is driven by temperaturevariations, not the absolute temperature) and \(c_R\) is a dimensionlessconstant. To understand why this method works consider this: If on a particularcell \(K\) the temperature field is smooth, then we expect the residualto be small there (in fact to be on the order of \({\cal O}(h_K)\) ) andthe stabilization term that injects artificial diffusion will there beof size \(h_K^{\alpha+1}\) &mdash; i.e., rather small, just as we hope it tobe when no additional diffusion is necessary. On the other hand, if weare on or close to a discontinuity of the temperature field, then theresidual will be large; the minimum operation in the definition of \(\nu_\alpha(T)\) will then ensure that the stabilization has size \(h_K\) &mdash; the optimal amount of artificial viscosity to ensure stability ofthe scheme. Whether or not this scheme really works is a good question.Computations by Guermond and Popov have shown that this form ofstabilization actually performs much better than most of the otherstabilization schemes that are around (for example streamlinediffusion, to name only the simplest one). Furthermore, for \(\alpha\in [1,2)\) they can even prove that it produces better convergence ordersfor the linear transport equation than for example streamlinediffusion. For \(\alpha=2\) , no theoretical results are currentlyavailable, but numerical tests indicate that the resultsare considerably better than for \(\alpha=1\) . A more practical question is how to introduce this artificialdiffusion into the equations we would like to solve. Note that thenumerical viscosity \(\nu(T)\) is temperature-dependent, so the equationwe want to solve is nonlinear in \(T\) &mdash; not what one desires from asimple method to stabilize an equation, and even less so if we realizethat \(\nu(T)\) is nondifferentiable in \(T\) . However, there is noreason to despair: we still have to discretize in time and we cantreat the term explicitly. In the definition of the stabilization parameter, we approximate the timederivative by \(\frac{\partial T}{\partial t} \approx \frac{T^{n-1}-T^{n-2}}{k^{n-1}}\) . This approximation makes only useof available time data and this is the reason why we need to store data of twoprevious time steps (which enabled us to use the BDF-2 scheme withoutadditional storage cost). We could now simply evaluate the rest of theterms at \(t_{n-1}\) , but then the discrete residual would be nothing else thana backward Euler approximation, which is only first order accurate. So, incase of smooth solutions, the residual would be still of the order \(h\) ,despite the second order time accuracy in the outer BDF-2 scheme and thespatial FE discretization. This is certainly not what we want to have(in fact, we desired to have small residuals in regions where the solutionbehaves nicely), so a bit more care is needed. The key to this problemis to observe that the first derivative as we constructed it is actuallycentered at \(t_{n-\frac{3}{2}}\) . We get the desired second order accurateresidual calculation if we evaluate all spatial terms at \(t_{n-\frac{3}{2}}\) by using the approximation \(\frac 12 T^{n-1}+\frac 12 T^{n-2}\) , which meansthat we calculate the nonlinear viscosity as a function of thisintermediate temperature, \(\nu_\alpha = \nu_\alpha\left(\frac 12 T^{n-1}+\frac 12 T^{n-2}\right)\) . Note that thisevaluation of the residual is nothing else than a Crank-Nicholson scheme,so we can be sure that now everything is alright. One might wonder whetherit is a problem that the numerical viscosity now is not evaluated attime \(n\) (as opposed to the rest of the equation). However, this offsetis uncritical: For smooth solutions, \(\nu_\alpha\) will vary continuously,so the error in time offset is \(k\) times smaller than the nonlinearviscosity itself, i.e., it is a small higher order contribution that isleft out. That's fine because the term itself is already at the level ofdiscretization error in smooth regions. Using the BDF-2 scheme introduced above,this yields for the simpler case of uniform time steps of size \(k\) : </p><p class="formulaDsp">
\begin{eqnarray*} \frac 32 T^n - k\nabla \cdot \kappa \nabla T^n &amp;=&amp; 2 T^{n-1} - \frac 12 T^{n-2} \\ &amp;&amp; + k\nabla \cdot \left[ \nu_\alpha\left(\frac 12 T^{n-1}+\frac 12 T^{n-2}\right) \ \nabla (2T^{n-1}-T^{n-2}) \right] \\ &amp;&amp; - k(2{\mathbf u}^{n-1}-{\mathbf u}^{n-2}) \cdot \nabla (2T^{n-1}-T^{n-2}) \\ &amp;&amp; + k\gamma. \end{eqnarray*}
</p>
<p> On the left side of this equation remains the term from the timederivative and the original (physical) diffusion which we treatimplicitly (this is actually a nice term: the matrices that resultfrom the left hand side are the mass matrix and a multiple of theLaplace matrix &mdash; both are positive definite and if the time stepsize \(k\) is small, the sum is simple to invert). On the right handside, the terms in the first line result from the time derivative; inthe second line is the artificial diffusion at time \(t_{n-\frac 32}\) ; the third line contains theadvection term, and the fourth the sources. Note that theartificial diffusion operates on the extrapolatedtemperature at the current time in the same way as we have discussedthe advection works in the section on time stepping. The form for nonuniform time steps that we will have to use inreality is a bit more complicated (which is why we showed the simplerform above first) and reads: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} T^n - k_n\nabla \cdot \kappa \nabla T^n &amp;=&amp; \frac{k_n+k_{n-1}}{k_{n-1}} T^{n-1} - \frac{k_n^2}{k_{n-1}(k_n+k_{n-1})} T^{n-2} \\ &amp;&amp; + k_n\nabla \cdot \left[ \nu_\alpha\left(\frac 12 T^{n-1}+\frac 12 T^{n-2}\right) \ \nabla \left[ \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2} \right] \right] \\ &amp;&amp; - k_n \left[ \left(1+\frac{k_n}{k_{n-1}}\right){\mathbf u}^{n-1} - \frac{k_n}{k_{n-1}}{\mathbf u}^{n-2} \right] \cdot \nabla \left[ \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2} \right] \\ &amp;&amp; + k_n\gamma. \end{eqnarray*}
</p>
<p>After settling all these issues, the weak form follows naturally fromthe strong form shown in the last equation, and we immediately arriveat the weak form of the discretized equations: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} (\tau_h,T_h^n) + k_n (\nabla \tau_h, \kappa \nabla T_h^n) &amp;=&amp; \biggl(\tau_h, \frac{k_n+k_{n-1}}{k_{n-1}} T_h^{n-1} - \frac{k_n^2}{k_{n-1}(k_n+k_{n-1})} T_h^{n-2} \\ &amp;&amp;\qquad - k_n \left[ \left(1+\frac{k_n}{k_{n-1}}\right){\mathbf u}^{n-1} - \frac{k_n}{k_{n-1}}{\mathbf u}^{n-2} \right] \cdot \nabla \left[ \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2} \right] + k_n\gamma \biggr) \\ &amp;&amp; - k_n \left(\nabla \tau_h, \nu_\alpha\left(\frac 12 T_h^{n-1}+\frac 12 T_h^{n-2}\right) \ \nabla \left[ \left(1+\frac{k_n}{k_{n-1}}\right)T^{n-1}-\frac{k_n}{k_{n-1}}T^{n-2} \right] \right) \end{eqnarray*}
</p>
<p> for all discrete test functions \(\tau_h\) . Here, the diffusion term has beenintegrated by parts, and we have used that we will impose no thermal flux, \(\mathbf{n}\cdot\kappa\nabla T|_{\partial\Omega}=0\) . This then results in amatrix equation of form </p><p class="formulaDsp">
\begin{eqnarray*} \left( \frac{2k_n+k_{n-1}}{k_n+k_{n-1}} M+k_n A_T\right) T_h^n = F(U_h^{n-1}, U_h^{n-2},T_h^{n-1},T_h^{n-2}), \end{eqnarray*}
</p>
<p> which given the structure of matrix on the left (the sum of twopositive definite matrices) is easily solved using the ConjugateGradient method.</p>
<p><a class="anchor" id="Linearsolvers"></a></p><h4>Linear solvers</h4>
<p>As explained above, our approach to solving the joint system forvelocities/pressure on the one hand and temperature on the other is to use anoperator splitting where we first solve the Stokes system for the velocitiesand pressures using the old temperature field, and then solve for the newtemperature field using the just computed velocity field. (A moreextensive discussion of operator splitting methods can be found in <a class="el" href="step_58.html">step-58</a> .)</p>
<p><a class="anchor" id="LinearsolversfortheStokesproblem"></a></p><h5>Linear solvers for the Stokes problem</h5>
<p>Solving the linear equations coming from the Stokes system has beendiscussed in great detail in <a class="el" href="step_22.html">step-22</a> . In particular, inthe results section of that program, we have discussed a number ofalternative linear solver strategies that turned out to be moreefficient than the original approach. The best alternativeidentified there we to use a GMRES solver preconditioned by a blockmatrix involving the Schur complement. Specifically, the Stokesoperator leads to a block structured matrix </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \end{eqnarray*}
</p>
<p> and as discussed there a good preconditioner is </p><p class="formulaDsp">
\begin{eqnarray*} P = \left(\begin{array}{cc} A &amp; 0 \\ B &amp; -S \end{array}\right), \qquad \text{or equivalently} \qquad P^{-1} = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ S^{-1} B A^{-1} &amp; -S^{-1} \end{array}\right) \end{eqnarray*}
</p>
<p> where \(S\) is the Schur complement of the Stokes operator \(S=B^TA^{-1}B\) . Of course, this preconditioner is not useful because wecan't form the various inverses of matrices, but we can use thefollowing as a preconditioner: </p><p class="formulaDsp">
\begin{eqnarray*} \tilde P^{-1} = \left(\begin{array}{cc} \tilde A^{-1} &amp; 0 \\ \tilde S^{-1} B \tilde A^{-1} &amp; -\tilde S^{-1} \end{array}\right) \end{eqnarray*}
</p>
<p> where \(\tilde A^{-1},\tilde S^{-1}\) are approximations to the inversematrices. In particular, it turned out that \(S\) is spectrallyequivalent to the mass matrix and consequently replacing \(\tilde S^{-1}\) by a CG solver applied to the mass matrix on the pressurespace was a good choice. In a small deviation from <a class="el" href="step_22.html">step-22</a> , wehere have a coefficient \(\eta\) in the momentum equation, and by the samederivation as there we should arrive at the conclusion that it is the weightedmass matrix with entries \(\tilde S_{ij}=(\eta^{-1}\varphi_i,\varphi_j)\) thatwe should be using. It was more complicated to come up with a good replacement \(\tilde A^{-1}\) , which corresponds to the discretized symmetric Laplacian ofthe vector-valued velocity field, i.e. \(A_{ij} = (\varepsilon {\mathbf v}_i, 2\eta \varepsilon ({\mathbf v}_j))\) .In <a class="el" href="step_22.html">step-22</a> we used a sparse LU decomposition (using theSparseDirectUMFPACK class) of \(A\) for \(\tilde A^{-1}\) &mdash; theperfect preconditioner &mdash; in 2d, but for 3d memory and computetime is not usually sufficient to actually compute this decomposition;consequently, we only use an incomplete LU decomposition (ILU, usingthe <a class="el" href="classSparseILU.html">SparseILU</a> class) in 3d. For this program, we would like to go a bit further. To this end, notethat the symmetrized bilinear form on vector fields, \((\varepsilon {\mathbf v}_i, 2 \eta \varepsilon ({\mathbf v}_j))\) is not too far away from the nonsymmetrized version, \((\nabla {\mathbf v}_i, \eta \nabla {\mathbf v}_j) = \sum_{k,l=1}^d (\partial_k ({\mathbf v}_i)_l, \eta \partial_k ({\mathbf v}_j)_l) \) (note that the factor 2 has disappeared in this form). The latter,however, has the advantage that the <code>dim</code> vector componentsof the test functions are not coupled (well, almost, see below),i.e., the resulting matrix is block-diagonal: one block for each vectorcomponent, and each of these blocks is equal to the Laplace matrix forthis vector component. So assuming we order degrees of freedom in sucha way that first all \(x\) -components of the velocity are numbered, thenthe \(y\) -components, and then the \(z\) -components, then the matrix \(\hat A\) that is associated with this slightly different bilinear form hasthe form </p><p class="formulaDsp">
\begin{eqnarray*} \hat A = \left(\begin{array}{ccc} A_s &amp; 0 &amp; 0 \\ 0 &amp; A_s &amp; 0 \\ 0 &amp; 0 &amp; A_s \end{array}\right) \end{eqnarray*}
</p>
<p> where \(A_s\) is a Laplace matrix of size equal to the number of shape functionsassociated with each component of the vector-valued velocity. With thismatrix, one could be tempted to define our preconditioner for thevelocity matrix \(A\) as follows: </p><p class="formulaDsp">
\begin{eqnarray*} \tilde A^{-1} = \left(\begin{array}{ccc} \tilde A_s^{-1} &amp; 0 &amp; 0 \\ 0 &amp; \tilde A_s^{-1} &amp; 0 \\ 0 &amp; 0 &amp; \tilde A_s^{-1} \end{array}\right), \end{eqnarray*}
</p>
<p> where \(\tilde A_s^{-1}\) is a preconditioner for the Laplace matrix &mdash;something where we know very well how to build good preconditioners! In reality, the story is not quite as simple: To make the matrix \(\tilde A\) definite, we need to make the individual blocks \(\tilde A_s\) definite by applying boundary conditions. One can try to do so byapplying Dirichlet boundary conditions all around the boundary, andthen the so-defined preconditioner \(\tilde A^{-1}\) turns out to be agood preconditioner for \(A\) if the latter matrix results from a Stokesproblem where we also have Dirichlet boundary conditions on thevelocity components all around the domain, i.e., if we enforce \(\mathbf{u} = 0\) . Unfortunately, this "if" is an "if and only if": in the program belowwe will want to use no-flux boundary conditions of the form \(\mathbf u \cdot \mathbf n = 0\) (i.e., flow parallel to the boundary is allowed,but no flux through the boundary). In this case, it turns out that theblock diagonal matrix defined above is not a good preconditionerbecause it neglects the coupling of components at the boundary. Abetter way to do things is therefore if we build the matrix \(\hat A\) as the vector Laplace matrix \(\hat A_{ij} = (\nabla {\mathbf v}_i, \eta \nabla {\mathbf v}_j)\) and then apply the same boundary conditionas we applied to \(A\) . If this is a Dirichlet boundary condition allaround the domain, the \(\hat A\) will decouple to three diagonal blocksas above, and if the boundary conditions are of the form \(\mathbf u \cdot \mathbf n = 0\) then this will introduce a coupling of degrees offreedom at the boundary but only there. This, in fact, turns out to bea much better preconditioner than the one introduced above, and hasalmost all the benefits of what we hoped to get.</p>
<p>To sum this whole story up, we can observe: </p><ul>
<li>
Compared to building a preconditioner from the original matrix \(A\) resulting from the symmetric gradient as we did in <a class="el" href="step_22.html">step-22</a> , we have to expect that the preconditioner based on the Laplace bilinear form performs worse since it does not take into account the coupling between vector components. </li>
<li>
On the other hand, preconditioners for the Laplace matrix are typically more mature and perform better than ones for vector problems. For example, at the time of this writing, Algebraic Multigrid (AMG) algorithms are very well developed for scalar problems, but not so for vector problems. </li>
<li>
In building this preconditioner, we will have to build up the matrix \(\hat A\) and its preconditioner. While this means that we have to store an additional matrix we didn't need before, the preconditioner \(\tilde A_s^{-1}\) is likely going to need much less memory than storing a preconditioner for the coupled matrix \(A\) . This is because the matrix \(A_s\) has only a third of the entries per row for all rows corresponding to interior degrees of freedom, and contains coupling between vector components only on those parts of the boundary where the boundary conditions introduce such a coupling. Storing the matrix is therefore comparatively cheap, and we can expect that computing and storing the preconditioner \(\tilde A_s\) will also be much cheaper compared to doing so for the fully coupled matrix. </li>
</ul>
<p><br  />
</p>
<p><a class="anchor" id="Linearsolversforthetemperatureequation"></a></p><h5>Linear solvers for the temperature equation</h5>
<p>This is the easy part: The matrix for the temperature equation has the form \(\alpha M + \beta A\) , where \(M,A\) are mass and stiffness matrices on thetemperature space, and \(\alpha,\beta\) are constants related the time steppingscheme and the current and previous time step. This being the sum of asymmetric positive definite and a symmetric positive semidefinite matrix, theresult is also symmetric positive definite. Furthermore, \(\frac\beta\alpha\) isa number proportional to the time step, and so becomes small whenever the meshis fine, damping the effect of the then ill-conditioned stiffness matrix. As a consequence, inverting this matrix with the Conjugate Gradient algorithm,using a simple preconditioner, is trivial and very cheap compared to invertingthe Stokes matrix.</p>
<p><a class="anchor" id="Implementationdetails"></a></p><h3>Implementation details</h3>
<p><a class="anchor" id="UsingdifferentDoFHandlerobjects"></a></p><h4>Using different <a class="el" href="classDoFHandler.html">DoFHandler</a> objects</h4>
<p>One of the things worth explaining up front about the program below is the useof two different <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. If one looks at the structure of theequations above and the scheme for their solution, one realizes that there islittle commonality that keeps the Stokes part and the temperature parttogether. In all previous tutorial programs in which we have discussed <a class="el" href="group__vector__valued.html">vector-valued problems</a> we have always only used a singlefinite element with several vector components, and a single <a class="el" href="classDoFHandler.html">DoFHandler</a> object.Sometimes, we have substructured the resulting matrix into blocks tofacilitate particular solver schemes; this was, for example, the case in the <a class="el" href="step_22.html">step-22</a> program for the Stokes equations upon which the currentprogram is based. We could of course do the same here. The linear system that we would get wouldlook like this: </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{ccc} A &amp; B^T &amp; 0 \\ B &amp; 0 &amp;0 \\ C &amp; 0 &amp; K \end{array}\right) \left(\begin{array}{ccc} U^{n-1} \\ P^{n-1} \\ T^n \end{array}\right) = \left(\begin{array}{ccc} F_U(T^{n-1}) \\ 0 \\ F_T(U^{n-1},U^{n-2},T^{n-1},T^{n-2}) \end{array}\right). \end{eqnarray*}
</p>
<p> The problem with this is: We never use the whole matrix at the same time. Infact, it never really exists at the same time: As explained above, \(K\) and \(F_T\) depend on the already computed solution \(U^n\) , in the first case throughthe time step (that depends on \(U^n\) because it has to satisfy a CFLcondition). So we can only assemble it once we've already solved the top left \(2\times 2\) block Stokes system, and once we've moved on to the temperatureequation we don't need the Stokes part any more; the fact that webuild an object for a matrix that never exists as a whole in memory atany given time led us to jumping through some hoops in <a class="el" href="step_21.html">step-21</a> , solet's not repeat this sort of error. Furthermore, we don'tactually build the matrix \(C\) : Because by the time we get to the temperatureequation we already know \(U^n\) , and because we have to assemble the right handside \(F_T\) at this time anyway, we simply move the term \(CU^n\) to the righthand side and assemble it along with all the other terms there. What thismeans is that there does not remain a part of the matrix where temperaturevariables and Stokes variables couple, and so a global enumeration of alldegrees of freedom is no longer important: It is enough if we have anenumeration of all Stokes degrees of freedom, and of all temperature degreesof freedom independently. In essence, there is consequently not much use in putting <em>everything</em>into a block matrix (though there are of course the same good reasons to do sofor the \(2\times 2\) Stokes part), or, for that matter, in putting everythinginto the same <a class="el" href="classDoFHandler.html">DoFHandler</a> object. But are there <em>downsides</em> to doing so? These exist, though they may notbe obvious at first. The main problem is that if we need to create one globalfinite element that contains velocity, pressure, and temperature shapefunctions, and use this to initialize the <a class="el" href="classDoFHandler.html">DoFHandler</a>. But we also use thisfinite element object to initialize all <a class="el" href="classFEValues.html">FEValues</a> or <a class="el" href="classFEFaceValues.html">FEFaceValues</a> objects thatwe use. This may not appear to be that big a deal, but imagine what happenswhen, for example, we evaluate the residual \( R_\alpha(T) = \left( \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T - \gamma \right) T^{\alpha-1} \) that we need to compute the artificial viscosity \(\nu_\alpha(T)|_K\) . Forthis, we need the Laplacian of the temperature, which we compute using thetensor of second derivatives (Hessians) of the shape functions (we have togive the <code>update_hessians</code> flag to the <a class="el" href="classFEValues.html">FEValues</a> object forthis). Now, if we have a finite that contains the shape functions forvelocities, pressures, and temperatures, that means that we have to computethe Hessians of <em>all</em> shape functions, including the many higher ordershape functions for the velocities. That's a lot of computations that we don'tneed, and indeed if one were to do that (as we had in an early version of theprogram), assembling the right hand side took about a quarter of the overallcompute time. So what we will do is to use two different finite element objects, one for theStokes components and one for the temperatures. With this come two differentDoFHandlers, two sparsity patterns and two matrices for the Stokes andtemperature parts, etc. And whenever we have to assemble something thatcontains both temperature and Stokes shape functions (in particular the righthand sides of Stokes and temperature equations), then we use two FEValuesobjects initialized with two cell iterators that we walk in parallel throughthe two <a class="el" href="classDoFHandler.html">DoFHandler</a> objects associated with the same <a class="el" href="classTriangulation.html">Triangulation</a> object; forthese two <a class="el" href="classFEValues.html">FEValues</a> objects, we use of course the same quadrature objects sothat we can iterate over the same set of quadrature points, but each FEValuesobject will get update flags only according to what it actually needs tocompute. In particular, when we compute the residual as above, we only ask forthe values of the Stokes shape functions, but also the Hessians of thetemperature shape functions &mdash; much cheaper indeed, and as it turns out:assembling the right hand side of the temperature equation is now a componentof the program that is hardly measurable. With these changes, timing the program yields that only the followingoperations are relevant for the overall run time: </p><ul>
<li>
Solving the Stokes system: 72% of the run time. </li>
<li>
Assembling the Stokes preconditioner and computing the algebraic multigrid hierarchy using the Trilinos ML package: 11% of the run time. </li>
<li>
The function <code>BoussinesqFlowProblem::setup_dofs</code> : 7% of overall run time. </li>
<li>
Assembling the Stokes and temperature right hand side vectors as well as assembling the matrices: 7%. </li>
</ul>
<p>In essence this means that all bottlenecks apart from the algebraicmultigrid have been removed.</p>
<p><a class="anchor" id="UsingTrilinos"></a></p><h4>Using Trilinos</h4>
<p>In much the same way as we used PETSc to support our linear algebra needs in <a class="el" href="step_17.html">step-17</a> and <a class="el" href="step_18.html">step-18</a> , we use interfaces to the <a href="http://trilinos.org">Trilinos</a> library (see thedeal.II README file for installation instructions) in this program. Trilinosis a very large collection ofeverything that has to do with linear and nonlinear algebra, as well as allsorts of tools around that (and looks like it will grow in many otherdirections in the future as well). The main reason for using Trilinos, similar to our exploring PETSc, is that itis a very powerful library that provides a lot more tools than deal.II's ownlinear algebra library. That includes, in particular, the ability to work inparallel on a cluster, using MPI, and a wider variety of preconditioners. Inthe latter class, one of the most interesting capabilities is the existence ofthe Trilinos ML package that implements an Algebraic <a class="el" href="classMultigrid.html">Multigrid</a> (AMG)method. We will use this preconditioner to precondition the second orderoperator part of the momentum equation. The ability to solve problems inparallel will be explored in <a class="el" href="step_32.html">step-32</a> , using the same problem asdiscussed here. PETSc, which we have used in <a class="el" href="step_17.html">step-17</a> and <a class="el" href="step_18.html">step-18</a> , is certainly a powerfullibrary, providing a large number of functions that deal with matrices,vectors, and iterative solvers and preconditioners, along with lots of otherstuff, most of which runs quite well in parallel. It is, however, a few yearsold already than Trilinos, written in C, and generally not quite as easy touse as some other libraries. As a consequence, deal.II has also acquiredinterfaces to Trilinos, which shares a lot of the same functionality withPETSc. It is, however, a project that is several years younger, is written inC++ and by people who generally have put a significant emphasis on softwaredesign.</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>The case we want to solve here is as follows: we solve the Boussinesqequations described above with \(\kappa=10^{-6}, \eta=1, \rho=1, \beta=10\) ,i.e., a relatively slow moving fluid that has virtually no thermal diffusiveconductivity and transports heat mainly through convection. On theboundary, we will require no-normal flux for the velocity( \(\mathrm{n}\cdot\mathrm{u}=0\) ) and for the temperature( \(\mathrm{n}\cdot\nabla T=0\) ). This is one of the cases discussed in theintroduction of <a class="el" href="step_22.html">step-22</a> and fixes one component of the velocitywhile allowing flow to be parallel to the boundary. There remain <code>dim-1</code> components to be fixed, namely the tangential components ofthe normal stress; for these, we choose homogeneous conditions which means thatwe do not have to anything special. Initial conditions are only necessary forthe temperature field, and we choose it to be constant zero. The evolution of the problem is then entirely driven by the right hand side \(\gamma(\mathrm{x},t)\) of the temperature equation, i.e., by heat sources andsinks. Here, we choose a setup invented in advance of a Christmas lecture:real candles are of course prohibited in U.S. class rooms, but virtual onesare allowed. We therefore choose three spherical heat sources unequally spacedclose to the bottom of the domain, imitating three candles. The fluid locatedat these sources, initially at rest, is then heated up and as the temperaturerises gains buoyancy, rising up; more fluid is dragged up and through thesources, leading to three hot plumes that rise up until they are captured bythe recirculation of fluid that sinks down on the outside, replacing the airthat rises due to heating.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The first step, as always, is to include the functionality of these well-known deal.II library files and some C++ header files.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
</div><!-- fragment --><p>Then we need to include some header files that provide vector, matrix, and preconditioner classes that implement interfaces to the respective Trilinos classes. In particular, we will need interfaces to the matrix and vector classes based on Trilinos as well as Trilinos preconditioners:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
</div><!-- fragment --><p>Finally, here are a few C++ headers that haven't been included yet by one of the aforelisted header files:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
</div><!-- fragment --><p>At the end of this top-matter, we import all deal.II names into the global namespace:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep31.html">Step31</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Equationdata"></a> </p><h3>Equation data</h3>
<p>Again, the next stage in the program is the definition of the equation data, that is, the various boundary conditions, the right hand sides and the initial condition (remember that we're about to solve a time-dependent system). The basic strategy for this definition is the same as in <a class="el" href="step_22.html">step-22</a> . Regarding the details, though, there are some differences.</p>
<p>The first thing is that we don't set any inhomogeneous boundary conditions on the velocity, since as is explained in the introduction we will use no-flux conditions \(\mathbf{n}\cdot\mathbf{u}=0\) . So what is left are <code>dim-1</code> conditions for the tangential part of the normal component of the stress tensor, \(\textbf{n} \cdot [p \textbf{1} - \eta\varepsilon(\textbf{u})]\) ; we assume homogeneous values for these components, i.e., a natural boundary condition that requires no specific action (it appears as a zero term in the right hand side of the weak form). For the temperature \(T\) , we assume no thermal energy flux, i.e., \(\mathbf{n} \cdot \kappa \nabla T=0\) . This, again, is a boundary condition that does not require us to do anything in particular. <br  />
 Secondly, we have to set initial conditions for the temperature (no initial conditions are required for the velocity and pressure, since the Stokes equations for the quasi-stationary case we consider here have no time derivatives of the velocity or pressure). Here, we choose a very simple test case, where the initial temperature is zero, and all dynamics are driven by the temperature right hand side. <br  />
 Thirdly, we need to define the right hand side of the temperature equation. We choose it to be constant within three circles (or spheres in 3d) somewhere at the bottom of the domain, as explained in the introduction, and zero outside. <br  />
 Finally, or maybe firstly, at the top of this namespace, we define the various material constants we need ( \(\eta,\kappa\) , density \(\rho\) and the thermal expansion coefficient \(\beta\) ):</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>EquationData</div>
<div class="line">{</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a>     = 1;</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">kappa</a>   = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6;</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>    = 10;</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a> = 1;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>TemperatureInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    TemperatureInitialValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;  <span class="comment">/*p*/</span> ,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <span class="comment">/*component*/</span>  = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>TemperatureRightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    TemperatureRightHandSide()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0,</div>
<div class="line">             <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Invalid operation for a scalar function.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2) || (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3), <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> source_centers[3] = {</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(.3, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.3, .5, .1)),</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.45, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.45, .5, .1)),</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.75, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.75, .5, .1))};</div>
<div class="line">      <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> source_radius = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 1. / 32 : 1. / 8);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> ((source_centers[0].distance(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ||</div>
<div class="line">                  (source_centers[1].<a class="code" href="classPoint.html#a3df8e6ab311dab9337c8d7b039c7b815">distance</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ||</div>
<div class="line">                  (source_centers[2].distance(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ?</div>
<div class="line">                1 :</div>
<div class="line">                0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureRightHandSide&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line">} <span class="comment">// namespace EquationData</span></div>
</div><!-- fragment --><p><a class="anchor" id="Linearsolversandpreconditioners"></a> </p><h3>Linear solvers and preconditioners</h3>
<p>This section introduces some objects that are used for the solution of the linear equations of the Stokes system that we need to solve in each time step. Many of the ideas used here are the same as in <a class="el" href="step_20.html">step-20</a> , where Schur complement based preconditioners and solvers have been introduced, with the actual interface taken from <a class="el" href="step_22.html">step-22</a> (in particular the discussion in the "Results" section of <a class="el" href="step_22.html">step-22</a> , in which we introduce alternatives to the direct Schur complement approach). Note, however, that here we don't use the Schur complement to solve the Stokes equations, though an approximate Schur complement (the mass matrix on the pressure space) appears in the preconditioner.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">{</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeInverseMatrixcodeclasstemplate"></a> </p><h4>The <code>InverseMatrix</code> class template</h4>
<p>This class is an interface to calculate the action of an "inverted" matrix on a vector (using the <code>vmult</code> operation) in the same way as the corresponding class in <a class="el" href="step_22.html">step-22</a> : when the product of an object of this class is requested, we solve a linear equation system with that matrix using the CG method, accelerated by a preconditioner of (templated) class <code>PreconditionerType</code> . <br  />
 In a minor deviation from the implementation of the same class in <a class="el" href="step_22.html">step-22</a> , we make the <code>vmult</code> function take any kind of vector type (it will yield compiler errors, however, if the matrix does not allow a matrix-vector product with this kind of vector). <br  />
 Secondly, we catch any exceptions that the solver may have thrown. The reason is as follows: When debugging a program like this one occasionally makes a mistake of passing an indefinite or nonsymmetric matrix or preconditioner to the current class. The solver will, in that case, not converge and throw a run-time exception. If not caught here it will propagate up the call stack and may end up in <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> where we output an error message that will say that the CG solver failed. The question then becomes: Which CG solver? The one that inverted the mass matrix? The one that inverted the top left block with the Laplace operator? Or a CG solver in one of the several other nested places where we use linear solvers in the current code? No indication about this is present in a run-time exception because it doesn't store the stack of calls through which we got to the place where the exception was generated. <br  />
 So rather than letting the exception propagate freely up to <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> we realize that there is little that an outer function can do if the inner solver fails and rather convert the run-time exception into an assertion that fails and triggers a call to <code><a class="el" href="namespacedeal__II__exceptions_1_1internals.html#a600f8f191a6ce368afda0074dd7ea1dc">abort()</a></code> , allowing us to trace back in a debugger how we got to the current place.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(VectorType &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">  <span class="keyword">const</span> PreconditionerType &amp;           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">  <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">  <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">  : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">  , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">  VectorType &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">  <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-7 src.l2_norm());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>.what()));</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Schurcomplementpreconditioner"></a> </p><h4>Schur complement preconditioner</h4>
<p>This is the implementation of the Schur complement preconditioner as described in detail in the introduction. As opposed to <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_22.html">step-22</a> , we solve the block system all-at-once using GMRES, and use the Schur complement of the block structured matrix to build a good preconditioner instead. <br  />
 Let's have a look at the ideal preconditioner matrix \(P=\left(\begin{array}{cc} A &amp; 0 \\ B &amp; -S \end{array}\right)\) described in the introduction. If we apply this matrix in the solution of a linear system, convergence of an iterative GMRES solver will be governed by the matrix </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1}\left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) = \left(\begin{array}{cc} I &amp; A^{-1} B^T \\ 0 &amp; I \end{array}\right), \end{eqnarray*}
</p>
<p> which indeed is very simple. A GMRES solver based on exact matrices would converge in one iteration, since all eigenvalues are equal (any Krylov method takes at most as many iterations as there are distinct eigenvalues). Such a preconditioner for the blocked Stokes system has been proposed by Silvester and Wathen ("Fast iterative solution of stabilised Stokes systems part II.  Using general block preconditioners", SIAM J. Numer. Anal., 31 (1994), pp. 1352-1367). Replacing \(P\) by \(\tilde{P}\) keeps that spirit alive: the product \(P^{-1} A\) will still be close to a matrix with eigenvalues 1 with a distribution that does not depend on the problem size. This lets us hope to be able to get a number of GMRES iterations that is problem-size independent. <br  />
 The deal.II users who have already gone through the <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_22.html">step-22</a> tutorials can certainly imagine how we're going to implement this. We replace the exact inverse matrices in \(P^{-1}\) by some approximate inverses built from the InverseMatrix class, and the inverse Schur complement will be approximated by the pressure mass matrix \(M_p\) (weighted by \(\eta^{-1}\) as mentioned in the introduction). As pointed out in the results section of <a class="el" href="step_22.html">step-22</a> , we can replace the exact inverse of \(A\) by just the application of a preconditioner, in this case on a vector Laplace matrix as was explained in the introduction. This does increase the number of (outer) GMRES iterations, but is still significantly cheaper than an exact inverse, which would require between 20 and 35 CG iterations for <em> each </em> outer solver step (using the AMG preconditioner). <br  />
 Having the above explanations in mind, we define a preconditioner class with a <code>vmult</code> functionality, which is all we need for the interaction with the usual solver functions further below in the program code. <br  />
 First the declarations. These are similar to the definition of the Schur complement in <a class="el" href="step_20.html">step-20</a> , with the difference that we need some more preconditioners in the constructor and that the matrices we use here are built upon Trilinos:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line"><span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  BlockSchurPreconditioner(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                        PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">    <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">             <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">    stokes_matrix;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                         PreconditionerTypeMp&gt;&gt;</div>
<div class="line">                             m_inverse;</div>
<div class="line">  <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div>
<div class="line">};</div>
</div><!-- fragment --><p>When using a <a class="el" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> or a <a class="el" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a>, the <a class="el" href="classVector.html">Vector</a> is initialized using an <a class="el" href="classIndexSet.html">IndexSet</a>. <a class="el" href="classIndexSet.html">IndexSet</a> is used not only to resize the <a class="el" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> but it also associates an index in the <a class="el" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> with a degree of freedom (see <a class="el" href="step_40.html">step-40</a> for a more detailed explanation). The function <a class="el" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set()</a> creates an <a class="el" href="classIndexSet.html">IndexSet</a> where every valid index is part of the set. Note that this program can only be run sequentially and will throw an exception if used in parallel.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div>
<div class="line">  BlockSchurPreconditioner(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                        PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">    <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner)</div>
<div class="line">  : stokes_matrix(&amp;S)</div>
<div class="line">  , m_inverse(&amp;Mpinv)</div>
<div class="line">  , a_preconditioner(Apreconditioner)</div>
<div class="line">  , tmp(<a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(stokes_matrix-&gt;<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1, 1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>()))</div>
<div class="line">{}</div>
</div><!-- fragment --><p>Next is the <code>vmult</code> function. We implement the action of \(P^{-1}\) as described above in three successive steps. In formulas, we want to compute \(Y=P^{-1}X\) where \(X,Y\) are both vectors with two block components. <br  />
 The first step multiplies the velocity part of the vector by a preconditioner of the matrix \(A\) , i.e., we compute \(Y_0={\tilde A}^{-1}X_0\) . The resulting velocity vector is then multiplied by \(B\) and subtracted from the pressure, i.e., we want to compute \(X_1-BY_0\) . This second step only acts on the pressure vector and is accomplished by the residual function of our matrix classes, except that the sign is wrong. Consequently, we change the sign in the temporary pressure vector and finally multiply by the inverse pressure mass matrix to get the final pressure vector, completing our work on the Stokes preconditioner:</p>
<div class="fragment"><div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">     <span class="keywordtype">void</span></div>
<div class="line">     <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult</a>(</div>
<div class="line">       <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">       stokes_matrix-&gt;block(1, 0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">       tmp=</div>
<div class="line">  </div>
<div class="line">-1;</div>
<div class="line">       m_inverse-&gt;vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">     }</div>
<div class="line">   } <span class="comment">// namespace LinearSolvers</span></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeBoussinesqFlowProblemcodeclasstemplate"></a> </p><h3>The <code>BoussinesqFlowProblem</code> class template</h3>
<p>The definition of the class that defines the top-level logic of solving the time-dependent Boussinesq problem is mainly based on the <a class="el" href="step_22.html">step-22</a> tutorial program. The main differences are that now we also have to solve for the temperature equation, which forces us to have a second <a class="el" href="classDoFHandler.html">DoFHandler</a> object for the temperature variable as well as matrices, right hand sides, and solution vectors for the current and previous time steps. As mentioned in the introduction, all linear algebra objects are going to use wrappers of the corresponding Trilinos functionality. <br  />
 The member functions of this class are reminiscent of <a class="el" href="step_21.html">step-21</a> , where we also used a staggered scheme that first solve the flow equations (here the Stokes equations, in <a class="el" href="step_21.html">step-21</a> Darcy flow) and then update the advected quantity (here the temperature, there the saturation). The functions that are new are mainly concerned with determining the time step, as well as the proper size of the artificial viscosity stabilization. <br  />
 The last three variables indicate whether the various matrices or preconditioners need to be rebuilt the next time the corresponding build functions are called. This allows us to move the corresponding <code>if</code> into the respective function and thereby keeping our main <code><a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a></code> function clean and easy to read.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>BoussinesqFlowProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  BoussinesqFlowProblem();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span>   setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_stokes_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span>   build_stokes_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_stokes_system();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_temperature_system(<span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity);</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_temperature_matrix();</div>
<div class="line">  <span class="keywordtype">double</span> get_maximal_velocity() <span class="keyword">const</span>;</div>
<div class="line">  std::pair&lt;double, double&gt; get_extrapolated_temperature_range() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span>                      <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span>                      output_results() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span>                      refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <span class="keywordtype">double</span>             global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        stokes_degree;</div>
<div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             stokes_fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           stokes_dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> stokes_constraints;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;IndexSet&gt;               stokes_partitioning;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_stokes_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        temperature_degree;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 temperature_fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           temperature_dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> temperature_constraints;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_mass_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_stiffness_matrix;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_temperature_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_temperature_solution;</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span>       time_step;</div>
<div class="line">  <span class="keywordtype">double</span>       old_time_step;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">  std::shared_ptr&lt;TrilinosWrappers::PreconditionAMG&gt; Amg_preconditioner;</div>
<div class="line">  std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt;  Mp_preconditioner;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">bool</span> rebuild_stokes_matrix;</div>
<div class="line">  <span class="keywordtype">bool</span> rebuild_temperature_matrices;</div>
<div class="line">  <span class="keywordtype">bool</span> rebuild_stokes_preconditioner;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemclassimplementation"></a> </p><h3>BoussinesqFlowProblem class implementation</h3>
<pre class="fragment">&lt;a name="BoussinesqFlowProblemBoussinesqFlowProblem"&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::BoussinesqFlowProblem&lt;/h4&gt;   
The constructor of this class is an extension of the constructor in   @ref step_22 "step-22"  . We need to add the various variables that concern the temperature. As discussed in the introduction, we are going to use   @f$Q_2\times Q_1@f$   (Taylor-Hood) elements again for the Stokes part, and   @f$Q_2@f$   elements for the temperature. However, by using variables that store the polynomial degree of the Stokes and temperature finite elements, it is easy to consistently modify the degree of the elements as well as all quadrature formulas used on them downstream. Moreover, we initialize the time stepping as well as the options for matrix assembly and preconditioning:
</pre><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::BoussinesqFlowProblem()</div>
<div class="line">  : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">  , global_Omega_diameter(std::numeric_limits&lt;<a class="code" href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a>&gt;::quiet_NaN())</div>
<div class="line">  , stokes_degree(1)</div>
<div class="line">  , stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_degree + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_degree), 1)</div>
<div class="line">  , stokes_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  temperature_degree(2)</div>
<div class="line">  , temperature_fe(temperature_degree)</div>
<div class="line">  , temperature_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  time_step(0)</div>
<div class="line">  , old_time_step(0)</div>
<div class="line">  , timestep_number(0)</div>
<div class="line">  , rebuild_stokes_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , rebuild_temperature_matrices(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , rebuild_stokes_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_maximal_velocity"></a> </p><h4>BoussinesqFlowProblem::get_maximal_velocity</h4>
<p>Starting the real functionality of this class is a helper function that determines the maximum ( \(L_\infty\) ) velocity in the domain (at the quadrature points, in fact). How it works should be relatively obvious to all who have gotten to this point of the tutorial. Note that since we are only interested in the velocity, rather than using <code>stokes_fe_values.get_function_values</code> to get the values of the entire Stokes solution (velocities and pressures) we use <code>stokes_fe_values[velocities].get_function_values</code> to extract only the velocities part. This has the additional benefit that we get it as a <a class="el" href="classTensor.html">Tensor&lt;1,dim&gt;</a>, rather than some components in a <a class="el" href="structDataPostprocessorInputs_1_1Vector.html">Vector&lt;double&gt;</a>, allowing us to process it right away using the <code><a class="el" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm()</a></code> function to get the magnitude of the velocity. <br  />
 The only point worth thinking about a bit is how to choose the quadrature points we use here. Since the goal of this function is to find the maximal velocity over a domain by looking at quadrature points on each cell. So we should ask how we should best choose these quadrature points on each cell. To this end, recall that if we had a single \(Q_1\) field (rather than the vector-valued field of higher order) then the maximum would be attained at a vertex of the mesh. In other words, we should use the <a class="el" href="classQTrapezoid.html">QTrapezoid</a> class that has quadrature points only at the vertices of cells. <br  />
 For higher order shape functions, the situation is more complicated: the maxima and minima may be attained at points between the support points of shape functions (for the usual \(Q_p\) elements the support points are the equidistant Lagrange interpolation points); furthermore, since we are looking for the maximum magnitude of a vector-valued quantity, we can even less say with certainty where the set of potential maximal points are. Nevertheless, intuitively if not provably, the Lagrange interpolation points appear to be a better choice than the Gauss points. <br  />
 There are now different methods to produce a quadrature formula with quadrature points equal to the interpolation points of the finite element. One option would be to use the <a class="el" href="group__Exceptions.html#ga5b35a290aa7dd7562911a92a13b11fee">FiniteElement::get_unit_support_points()</a> function, reduce the output to a unique set of points to avoid duplicate function evaluations, and create a <a class="el" href="classQuadrature.html">Quadrature</a> object using these points. Another option, chosen here, is to use the <a class="el" href="classQTrapezoid.html">QTrapezoid</a> class and combine it with the <a class="el" href="classQIterated.html">QIterated</a> class that repeats the <a class="el" href="classQTrapezoid.html">QTrapezoid</a> formula on a number of sub-cells in each coordinate direction. To cover all support points, we need to iterate it <code>stokes_degree+1</code> times since this is the polynomial degree of the Stokes element in use:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_maximal_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(), stokes_degree + 1);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(stokes_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  <span class="keywordtype">double</span>                      max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                velocity_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> max_velocity;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_extrapolated_temperature_range"></a> </p><h4>BoussinesqFlowProblem::get_extrapolated_temperature_range</h4>
<p>Next a function that determines the minimum and maximum temperature at quadrature points inside \(\Omega\) when extrapolated from the two previous time steps to the current one. We need this information in the computation of the artificial viscosity parameter \(\nu\) as discussed in the introduction. <br  />
 The formula for the extrapolated temperature is \(\left(1+\frac{k_n}{k_{n-1}} \right)T^{n-1} + \frac{k_n}{k_{n-1}} T^{n-2}\) . The way to compute it is to loop over all quadrature points and update the maximum and minimum value if the current value is bigger/smaller than the previous one. We initialize the variables that store the max and min before the loop over all quadrature points by the smallest and the largest number representable as a double. Then we know for a fact that it is larger/smaller than the minimum/maximum and that the loop over all quadrature points is ultimately going to update the initial value with the correct one. The only other complication worth mentioning here is that in the first time step, \(T^{k-2}\) is not yet available of course. In that case, we can only use \(T^{k-1}\) which we have from the initial temperature. As quadrature points, we use the same choice as in the previous function though with the difference that now the number of repetitions is determined by the polynomial degree of the temperature field.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   std::pair&lt;double, double&gt;</div>
<div class="line">   BoussinesqFlowProblem&lt;dim&gt;::get_extrapolated_temperature_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                             temperature_degree);</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(temperature_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">                max_temperature =</div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">           {</div>
<div class="line">             fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">             fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                           old_temperature_values);</div>
<div class="line">             fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                           old_old_temperature_values);</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">               {</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> =</div>
<div class="line">                   (1. + time_step / old_time_step) old_temperature_values[q]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                   time_step / old_time_step old_old_temperature_values[q];</div>
<div class="line">  </div>
<div class="line">                 min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                 max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div>
<div class="line">       }</div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       {</div>
<div class="line">         <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">                max_temperature =</div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">           {</div>
<div class="line">             fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">             fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                           old_temperature_values);</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">               {</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> = old_temperature_values[q];</div>
<div class="line">  </div>
<div class="line">                 min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                 max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemcompute_viscosity"></a> </p><h4>BoussinesqFlowProblem::compute_viscosity</h4>
<p>The last of the tool functions computes the artificial viscosity parameter \(\nu|_K\) on a cell \(K\) as a function of the extrapolated temperature, its gradient and Hessian (second derivatives), the velocity, the right hand side \(\gamma\) all on the quadrature points of the current cell, and various other parameters as described in detail in the introduction. <br  />
 There are some universal constants worth mentioning here. First, we need to fix \(\beta\) ; we choose \(\beta=0.017\cdot dim\) , a choice discussed in detail in the results section of this tutorial program. The second is the exponent \(\alpha\) ; \(\alpha=1\) appears to work fine for the current program, even though some additional benefit might be expected from choosing \(\alpha = 2\) . Finally, there is one thing that requires special casing: In the first time step, the velocity equals zero, and the formula for \(\nu|_K\) is not defined. In that case, we return \(\nu|_K=5\cdot 10^3 \cdot h_K\) , a choice admittedly more motivated by heuristics than anything else (it is in the same order of magnitude, however, as the value returned for most cells on the second time step). The rest of the function should be mostly obvious based on the material discussed in the introduction:</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = 0.017 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 1.0;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (global_u_infty == 0)</div>
<div class="line">       <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 cell_diameter;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_temperature.size();</div>
<div class="line">  </div>
<div class="line">     <span class="keywordtype">double</span> max_residual = 0;</div>
<div class="line">     <span class="keywordtype">double</span> max_velocity = 0;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">       {</div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u =</div>
<div class="line">           (old_velocity_values[q] + old_old_velocity_values[q]) / 2;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> dT_dt =</div>
<div class="line">           (old_temperature[q]</div>
<div class="line">  </div>
<div class="line">- old_old_temperature[q]) / old_time_step;</div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_T =</div>
<div class="line">           u (old_temperature_grads[q] + old_old_temperature_grads[q]) / 2;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> kappa_Delta_T =</div>
<div class="line">           <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a></div>
<div class="line">           (old_temperature_laplacians[q] + old_old_temperature_laplacians[q]) /</div>
<div class="line">           2;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> =</div>
<div class="line">           <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dT_dt + u_grad_T</div>
<div class="line">  </div>
<div class="line">- kappa_Delta_T</div>
<div class="line">  </div>
<div class="line">- gamma_values[q])</div>
<div class="line">                    std::pow((old_temperature[q] + old_old_temperature[q]) / 2,</div>
<div class="line">                             <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a></div>
<div class="line">  </div>
<div class="line">- 1.));</div>
<div class="line">  </div>
<div class="line">         max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">         max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u u), max_velocity);</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(2., (4.</div>
<div class="line">  </div>
<div class="line">- 2 <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) / <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R global_u_infty global_T_variation</div>
<div class="line">                                   <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(global_Omega_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a></div>
<div class="line">  </div>
<div class="line">- 2.);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">return</span> (</div>
<div class="line">       <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a> max_velocity</div>
<div class="line">       <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(cell_diameter,</div>
<div class="line">                std::pow(cell_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) max_residual / global_scaling));</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemsetup_dofs"></a> </p><h4>BoussinesqFlowProblem::setup_dofs</h4>
<p><br  />
 This is the function that sets up the <a class="el" href="classDoFHandler.html">DoFHandler</a> objects we have here (one for the Stokes part and one for the temperature part) as well as set to the right sizes the various objects required for the linear algebra in this program. Its basic operations are similar to what we do in <a class="el" href="step_22.html">step-22</a> . <br  />
 The body of the function first enumerates all degrees of freedom for the Stokes and temperature systems. For the Stokes part, degrees of freedom are then sorted to ensure that velocities precede pressure DoFs so that we can partition the Stokes matrix into a \(2\times 2\) matrix. As a difference to <a class="el" href="step_22.html">step-22</a> , we do not perform any additional DoF renumbering. In that program, it paid off since our solver was heavily dependent on ILU's, whereas we use AMG here which is not sensitive to the DoF numbering. The IC preconditioner for the inversion of the pressure mass matrix would of course take advantage of a Cuthill-McKee like renumbering, but its costs are low compared to the velocity portion, so the additional work does not pay off. <br  />
 We then proceed with the generation of the hanging node constraints that arise from adaptive grid refinement for both <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. For the velocity, we impose no-flux boundary conditions \(\mathbf{u}\cdot \mathbf{n}=0\) by adding constraints to the object that already stores the hanging node constraints matrix. The second parameter in the function describes the first of the velocity components in the total dof vector, which is zero here. The variable <code>no_normal_flux_boundaries</code> denotes the boundary indicators for which to set the no flux boundary conditions; here, this is boundary indicator zero. After having done so, we count the number of degrees of freedom in the various blocks:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  std::vector&lt;unsigned int&gt; stokes_sub_blocks(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">  stokes_sub_blocks[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    stokes_dof_handler.distribute_dofs(stokes_fe);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">    stokes_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                            stokes_constraints);</div>
<div class="line">    std::set&lt;types::boundary_id&gt; no_normal_flux_boundaries;</div>
<div class="line">    no_normal_flux_boundaries.insert(0);</div>
<div class="line">    <a class="code" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                                    0,</div>
<div class="line">                                                    no_normal_flux_boundaries,</div>
<div class="line">                                                    stokes_constraints);</div>
<div class="line">    stokes_constraints.close();</div>
<div class="line">  }</div>
<div class="line">  {</div>
<div class="line">    temperature_dof_handler.distribute_dofs(temperature_fe);</div>
<div class="line"> </div>
<div class="line">    temperature_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(temperature_dof_handler,</div>
<div class="line">                                            temperature_constraints);</div>
<div class="line">    temperature_constraints.close();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; stokes_dofs_per_block =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = stokes_dofs_per_block[0],</div>
<div class="line">                     n_p = stokes_dofs_per_block[1],</div>
<div class="line">                     n_T = temperature_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_T &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div>
<div class="line">            &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_T &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>The next step is to create the sparsity pattern for the Stokes and temperature system matrices as well as the preconditioner matrix from which we build the Stokes preconditioner. As in <a class="el" href="step_22.html">step-22</a> , we choose to create the pattern by using the blocked version of <a class="el" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a>. <br  />
 So, we first release the memory stored in the matrices, then set up an object of type <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> consisting of \(2\times 2\) blocks (for the Stokes system matrix and preconditioner) or <a class="el" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> (for the temperature part). We then fill these objects with the nonzero pattern, taking into account that for the Stokes system matrix, there are no entries in the pressure-pressure block (but all velocity vector components couple with each other and with the pressure). Similarly, in the Stokes preconditioner matrix, only the diagonal blocks are nonzero, since we use the vector Laplacian as discussed in the introduction. This operator only couples each vector component of the Laplacian with itself, but not with the other vector components. (Application of the constraints resulting from the no-flux boundary conditions will couple vector components at the boundary again, however.) <br  />
 When generating the sparsity pattern, we directly apply the constraints from hanging nodes and no-flux boundary conditions. This approach was already used in <a class="el" href="step_27.html">step-27</a> , but is different from the one in early tutorial programs where we first built the original sparsity pattern and only then added the entries resulting from constraints. The reason for doing so is that later during assembly we are going to distribute the constraints immediately when transferring local to global dofs. Consequently, there will be no data written at positions of constrained degrees of freedom, so we can let the <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a> function omit these entries by setting the last Boolean flag to <code>false</code> . Once the sparsity pattern is ready, we can use it to initialize the Trilinos matrices. Since the Trilinos matrices store the sparsity pattern internally, there is no need to keep the sparsity pattern around after the initialization of the matrix.</p>
<div class="fragment"><div class="line">stokes_partitioning.resize(2);</div>
<div class="line">stokes_partitioning[0] = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_u);</div>
<div class="line">stokes_partitioning[1] = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_p);</div>
<div class="line">{</div>
<div class="line">  stokes_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">  dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">  dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">  dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">  dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">  dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">    stokes_dof_handler, coupling, dsp, stokes_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  stokes_matrix.reinit(dsp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  Amg_preconditioner.reset();</div>
<div class="line">  Mp_preconditioner.reset();</div>
<div class="line">  stokes_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">  dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">  dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">  dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">  dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">  dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">    stokes_dof_handler, coupling, dsp, stokes_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  stokes_preconditioner_matrix.reinit(dsp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The creation of the temperature matrix (or, rather, matrices, since we provide a temperature mass matrix and a temperature stiffness matrix, that will be added together for time discretization) follows the generation of the Stokes matrix &ndash; except that it is much easier here since we do not need to take care of any blocks or coupling between components. Note how we initialize the three temperature matrices: We only use the sparsity pattern for reinitialization of the first matrix, whereas we use the previously generated matrix for the two remaining reinits. The reason for doing so is that reinitialization from an already generated matrix allows Trilinos to reuse the sparsity pattern instead of generating a new one for each copy. This saves both some time and memory.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  temperature_mass_matrix.clear();</div>
<div class="line">  temperature_stiffness_matrix.clear();</div>
<div class="line">  temperature_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_T, n_T);</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(temperature_dof_handler,</div>
<div class="line">                                  dsp,</div>
<div class="line">                                  temperature_constraints,</div>
<div class="line">                                  <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  temperature_matrix.reinit(dsp);</div>
<div class="line">  temperature_mass_matrix.reinit(temperature_matrix);</div>
<div class="line">  temperature_stiffness_matrix.reinit(temperature_matrix);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Lastly, we set the vectors for the Stokes solutions \(\mathbf u^{n-1}\) and \(\mathbf u^{n-2}\) , as well as for the temperatures \(T^{n}\) , \(T^{n-1}\) and \(T^{n-2}\) (required for time stepping) and all the system right hand sides to their correct sizes and block structure:</p>
<div class="fragment"><div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> temperature_partitioning = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_T);</div>
<div class="line">  stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  stokes_rhs.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_old_temperature_solution.reinit(temperature_partitioning,</div>
<div class="line">                                      MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  temperature_rhs.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemassemble_stokes_preconditioner"></a> </p><h4>BoussinesqFlowProblem::assemble_stokes_preconditioner</h4>
<p><br  />
 This function assembles the matrix we use for preconditioning the Stokes system. What we need are a vector Laplace matrix on the velocity components and a mass matrix weighted by \(\eta^{-1}\) on the pressure component. We start by generating a quadrature object of appropriate order, the <a class="el" href="classFEValues.html">FEValues</a> object that can give values and gradients at the quadrature points (together with quadrature weights). Next we create data structures for the cell matrix and the relation between local and global DoFs. The vectors <code>grad_phi_u</code> and <code>phi_p</code> are going to hold the values of the basis functions in order to faster build up the local matrices, as was already done in <a class="el" href="step_22.html">step-22</a> . Before we start the loop over all active cells, we have to specify which components are pressure and which are velocity.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_preconditioner()</div>
<div class="line">{</div>
<div class="line">  stokes_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(stokes_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div>
<div class="line">                                 quadrature_formula,</div>
<div class="line">                                 <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;double&gt;         phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      local_matrix = 0;</div>
</div><!-- fragment --><p>The creation of the local matrix is rather simple. There are only a Laplace term (on the velocity) and a mass matrix weighted by \(\eta^{-1}\) to be generated, so the creation of the local matrix is done in two lines. Once the local matrix is ready (loop over rows and columns in the local matrix on each quadrature point), we get the local DoF indices and write the local information into the global matrix. We do this as in <a class="el" href="step_27.html">step-27</a> , i.e., we directly apply the constraints from hanging nodes locally. By doing so, we don't have to do that afterwards, and we don't also write into entries of the matrix that will actually be set to zero again later when eliminating constraints.</p>
<div class="fragment"><div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              grad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a></div>
<div class="line">                   <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>], grad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) +</div>
<div class="line">                 (1. / <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a>) phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])</div>
<div class="line">                stokes_fe_values.JxW(q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">      stokes_constraints.distribute_local_to_global(</div>
<div class="line">        local_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, stokes_preconditioner_matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblembuild_stokes_preconditioner"></a> </p><h4>BoussinesqFlowProblem::build_stokes_preconditioner</h4>
<p><br  />
 This function generates the inner preconditioners that are going to be used for the Schur complement block preconditioner. Since the preconditioners need only to be regenerated when the matrices change, this function does not have to do anything in case the matrices have not changed (i.e., the flag <code>rebuild_stokes_preconditioner</code> has the value <code>false</code> ). Otherwise its first task is to call <code>assemble_stokes_preconditioner</code> to generate the preconditioner matrices. <br  />
 Next, we set up the preconditioner for the velocity-velocity matrix \(A\) . As explained in the introduction, we are going to use an AMG preconditioner based on a vector Laplace matrix \(\hat{A}\) (which is spectrally close to the Stokes matrix \(A\) ). Usually, the <a class="el" href="classTrilinosWrappers_1_1PreconditionAMG.html">TrilinosWrappers::PreconditionAMG</a> class can be seen as a good black-box preconditioner which does not need any special knowledge. In this case, however, we have to be careful: since we build an AMG for a vector problem, we have to tell the preconditioner setup which dofs belong to which vector component. We do this using the function <a class="el" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>, a function that generates a set of <code>dim</code> vectors, where each one has ones in the respective component of the vector problem and zeros elsewhere. Hence, these are the constant modes on each component, which explains the name of the variable.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::build_stokes_preconditioner()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_preconditioner == <span class="keyword">false</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding Stokes preconditioner...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">  assemble_stokes_preconditioner();</div>
<div class="line"> </div>
<div class="line">  Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionAMG&gt;();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;std::vector&lt;bool&gt;</a>&gt; constant_modes;</div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocity_components(0);</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>(stokes_dof_handler,</div>
<div class="line">                                   stokes_fe.component_mask(</div>
<div class="line">                                     velocity_components),</div>
<div class="line">                                   constant_modes);</div>
<div class="line">  <a class="code" href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a> amg_data;</div>
<div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">constant_modes</a> = constant_modes;</div>
</div><!-- fragment --><p>Next, we set some more options of the AMG preconditioner. In particular, we need to tell the AMG setup that we use quadratic basis functions for the velocity matrix (this implies more nonzero elements in the matrix, so that a more robust algorithm needs to be chosen internally). Moreover, we want to be able to control how the coarsening structure is build up. The way the Trilinos smoothed aggregation AMG does this is to look which matrix entries are of similar size as the diagonal entry in order to algebraically build a coarse-grid structure. By setting the parameter <code>aggregation_threshold</code> to 0.02, we specify that all entries that are more than two percent of size of some diagonal pivots in that row should form one coarse grid point. This parameter is rather ad hoc, and some fine-tuning of it can influence the performance of the preconditioner. As a rule of thumb, larger values of <code>aggregation_threshold</code> will decrease the number of iterations, but increase the costs per iteration. A look at the Trilinos documentation will provide more information on these parameters. With this data set, we then initialize the preconditioner with the matrix we want it to apply to. <br  />
 Finally, we also initialize the preconditioner for the inversion of the pressure mass matrix. This matrix is symmetric and well-behaved, so we can chose a simple preconditioner. We stick with an incomplete Cholesky (IC) factorization preconditioner, which is designed for symmetric matrices. We could have also chosen an SSOR preconditioner with relaxation factor around 1.2, but IC is cheaper for our example. We wrap the preconditioners into a <code>std::shared_ptr</code> pointer, which makes it easier to recreate the preconditioner next time around since we do not have to care about destroying the previously used object.</p>
<div class="fragment"><div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">elliptic</a>              = <span class="keyword">true</span>;</div>
<div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">higher_order_elements</a> = <span class="keyword">true</span>;</div>
<div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">smoother_sweeps</a>       = 2;</div>
<div class="line">  amg_data.<a class="code" href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">aggregation_threshold</a> = 0.02;</div>
<div class="line">  Amg_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(0, 0),</div>
<div class="line">                                 amg_data);</div>
<div class="line"> </div>
<div class="line">  Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">  Mp_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(1, 1));</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_preconditioner = <span class="keyword">false</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemassemble_stokes_system"></a> </p><h4>BoussinesqFlowProblem::assemble_stokes_system</h4>
<p><br  />
 The time lag scheme we use for advancing the coupled Stokes-temperature system forces us to split up the assembly (and the solution of linear systems) into two step. The first one is to create the Stokes system matrix and right hand side, and the second is to create matrix and right hand sides for the temperature dofs, which depends on the result of the linear system for the velocity. <br  />
 This function is called at the beginning of each time step. In the first time step or if the mesh has changed, indicated by the <code>rebuild_stokes_matrix</code> , we need to assemble the Stokes matrix; on the other hand, if the mesh hasn't changed and the matrix is already available, this is not necessary and all we need to do is assemble the right hand side vector which changes in each time step. <br  />
 Regarding the technical details of implementation, not much has changed from <a class="el" href="step_22.html">step-22</a> . We reset matrix and vector, create a quadrature formula on the cells, and then create the respective <a class="el" href="classFEValues.html">FEValues</a> object. For the update flags, we require basis function derivatives only in case of a full assembly, since they are not needed for the right hand side; as always, choosing the minimal set of flags depending on what is currently needed makes the call to <a class="el" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a> further down in the program more efficient. <br  />
 There is one thing that needs to be commented &ndash; since we have a separate finite element and <a class="el" href="classDoFHandler.html">DoFHandler</a> for the temperature, we need to generate a second <a class="el" href="classFEValues.html">FEValues</a> object for the proper evaluation of the temperature solution. This isn't too complicated to realize here: just use the temperature structures and set an update flag for the basis function values which we need for evaluation of the temperature solution. The only important part to remember here is that the same quadrature formula is used for both <a class="el" href="classFEValues.html">FEValues</a> objects to ensure that we get matching information when we loop over the quadrature points of the two objects. <br  />
 The declarations proceed with some shortcuts for array sizes, the creation of the local matrix and right hand side as well as the vector for the indices of the local dofs compared to the global system.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_system()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">    stokes_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  stokes_rhs = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(stokes_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(</div>
<div class="line">    stokes_fe,</div>
<div class="line">    quadrature_formula,</div>
<div class="line">    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">      (rebuild_stokes_matrix == <span class="keyword">true</span> ? <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> : <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>(0)));</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values(temperature_fe,</div>
<div class="line">                                      quadrature_formula,</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
</div><!-- fragment --><p>Next we need a vector that will contain the values of the temperature solution at the previous time level at the quadrature points to assemble the source term in the right hand side of the momentum equation. Let's call this vector <code>old_solution_values</code> . <br  />
 The set of vectors we create next hold the evaluations of the basis functions as well as their gradients and symmetrized gradients that will be used for creating the matrices. Putting these into their own arrays rather than asking the <a class="el" href="classFEValues.html">FEValues</a> object for this information each time it is needed is an optimization to accelerate the assembly process, see <a class="el" href="step_22.html">step-22</a> for details. <br  />
 The last two declarations are used to extract the individual blocks (velocity, pressure, temperature) from the total FE system.</p>
<div class="fragment"><div class="line">std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt;          phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; grads_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;                  div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;                  phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
</div><!-- fragment --><p>Now start the loop over all cells in the problem. We are working on two different DoFHandlers for this assembly routine, so we must have two different cell iterators for the two objects in use. This might seem a bit peculiar, since both the Stokes system and the temperature system use the same grid, but that's the only way to keep degrees of freedom in sync. The first statements within the loop are again all very familiar, doing the update of the finite element data as specified by the update flags, zeroing out the local arrays and getting the values of the old solution at the quadrature points. Then we are ready to loop over the quadrature points on the cell.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>             = stokes_dof_handler.begin_active();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> endc             = stokes_dof_handler.end();</div>
<div class="line"><span class="keyword">auto</span>       temperature_cell = temperature_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++temperature_cell)</div>
<div class="line">  {</div>
<div class="line">    stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    temperature_fe_values.reinit(temperature_cell);</div>
<div class="line"> </div>
<div class="line">    local_matrix = 0;</div>
<div class="line">    local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                              old_temperature_values);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> old_temperature = old_temperature_values[q];</div>
</div><!-- fragment --><p>Next we extract the values and gradients of basis functions relevant to the terms in the inner products. As shown in <a class="el" href="step_22.html">step-22</a> this helps accelerate assembly. <br  />
 Once this is done, we start the loop over the rows and columns of the local matrix and feed the matrix with the relevant products. The right hand side is filled with the forcing term driven by temperature in direction of gravity (which is vertical in our example). Note that the right hand side term is always generated, whereas the matrix contributions are only updated when it is requested by the <code>rebuild_matrices</code> flag.</p>
<div class="fragment"><div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">               {</div>
<div class="line">                 phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                 <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">                   {</div>
<div class="line">                     grads_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                       stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                     div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                       stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                     phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                   }</div>
<div class="line">               }</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">               <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                   local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                     (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> 2 (grads_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] grads_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                      div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]</div>
<div class="line">  </div>
<div class="line">- phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])</div>
<div class="line">                     stokes_fe_values.JxW(q);</div>
<div class="line">  </div>
<div class="line">             <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> gravity =</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-((<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2) ? (<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 1)) : (<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 0, 1)));</div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">               local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (-<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">EquationData::beta</a></div>
<div class="line">                                gravity phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] old_temperature)</div>
<div class="line">                               stokes_fe_values.JxW(q);</div>
<div class="line">           }</div>
</div><!-- fragment --><p>The last step in the loop over all cells is to enter the local contributions into the global matrix and vector structures to the positions specified in <code>local_dof_indices</code> . Again, we let the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class do the insertion of the cell matrix elements to the global matrix, which already condenses the hanging node constraints.</p>
<div class="fragment"><div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">        stokes_constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                                      local_rhs,</div>
<div class="line">                                                      <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                      stokes_matrix,</div>
<div class="line">                                                      stokes_rhs);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        stokes_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                      <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                      stokes_rhs);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_matrix = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemassemble_temperature_matrix"></a> </p><h4>BoussinesqFlowProblem::assemble_temperature_matrix</h4>
<p><br  />
 This function assembles the matrix in the temperature equation. The temperature matrix consists of two parts, a mass matrix and the time step size times a stiffness matrix given by a Laplace term times the amount of diffusion. Since the matrix depends on the time step size (which varies from one step to another), the temperature matrix needs to be updated every time step. We could simply regenerate the matrices in every time step, but this is not really efficient since mass and Laplace matrix do only change when we change the mesh. Hence, we do this more efficiently by generating two separate matrices in this function, one for the mass matrix and one for the stiffness (diffusion) matrix. We will then sum up the matrix plus the stiffness matrix times the time step size once we know the actual time step. <br  />
 So the details for this first step are very simple. In case we need to rebuild the matrix (i.e., the mesh has changed), we zero the data structures, get a quadrature formula and a <a class="el" href="classFEValues.html">FEValues</a> object, and create local matrices, local dof indices and evaluation structures for the basis functions.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_matrix()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_temperature_matrices == <span class="keyword">false</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  temperature_mass_matrix      = 0;</div>
<div class="line">  temperature_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>   quadrature_formula(temperature_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values(temperature_fe,</div>
<div class="line">                                      quadrature_formula,</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = temperature_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_mass_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_stiffness_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt;         phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
</div><!-- fragment --><p>Now, let's start the loop over all cells in the triangulation. We need to zero out the local matrices, update the finite element evaluations, and then loop over the rows and columns of the matrices on each quadrature point, where we then create the mass matrix and the stiffness matrix (Laplace terms times the diffusion <code>EquationData::kappa</code> . Finally, we let the constraints object insert these values into the global matrix, and directly condense the constraints into the matrix.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      local_mass_matrix      = 0;</div>
<div class="line">      local_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">      temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              {</div>
<div class="line">                local_mass_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] temperature_fe_values.JxW(q));</div>
<div class="line">                local_stiffness_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (<a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]</div>
<div class="line">                   temperature_fe_values.JxW(q));</div>
<div class="line">              }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      temperature_constraints.distribute_local_to_global(</div>
<div class="line">        local_mass_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, temperature_mass_matrix);</div>
<div class="line">      temperature_constraints.distribute_local_to_global(</div>
<div class="line">        local_stiffness_matrix,</div>
<div class="line">        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">        temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  rebuild_temperature_matrices = <span class="keyword">false</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemassemble_temperature_system"></a> </p><h4>BoussinesqFlowProblem::assemble_temperature_system</h4>
<p><br  />
 This function does the second part of the assembly work on the temperature matrix, the actual addition of pressure mass and stiffness matrix (where the time step size comes into play), as well as the creation of the velocity-dependent right hand side. The declarations for the right hand side assembly in this function are pretty much the same as the ones used in the other assembly routines, except that we restrict ourselves to vectors this time. We are going to calculate residuals on the temperature system, which means that we have to evaluate second derivatives, specified by the update flag <code>update_hessians</code> . <br  />
 The temperature equation is coupled to the Stokes system by means of the fluid velocity. These two parts of the solution are associated with different DoFHandlers, so we again need to create a second <a class="el" href="classFEValues.html">FEValues</a> object for the evaluation of the velocity at the quadrature points.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_system(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (use_bdf2_scheme == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">      temperature_matrix=</div>
<div class="line">        (2 time_step + old_time_step) / (time_step + old_time_step);</div>
<div class="line">      temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">      temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  temperature_rhs = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(temperature_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     temperature_fe_values(temperature_fe,</div>
<div class="line">                                      quadrature_formula,</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div>
<div class="line">                                 quadrature_formula,</div>
<div class="line">                                 <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = temperature_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
</div><!-- fragment --><p>Next comes the declaration of vectors to hold the old and older solution values (as a notation for time levels \(n-1\) and \(n-2\) , respectively) and gradients at quadrature points of the current cell. We also declare an object to hold the temperature right hand side values ( <code>gamma_values</code> ), and we again use shortcuts for the temperature basis functions. Eventually, we need to find the temperature extrema and the diameter of the computational domain which will be used for the definition of the stabilization parameter (we got the maximal velocity as an input to this function).</p>
<div class="fragment"><div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_temperature_grads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_temperature_grads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_temperature_laplacians(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">std::vector&lt;double&gt;         old_old_temperature_laplacians(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">EquationData::TemperatureRightHandSide&lt;dim&gt; temperature_right_hand_side;</div>
<div class="line">std::vector&lt;double&gt;                         gamma_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;double&gt;         phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range =</div>
<div class="line">  get_extrapolated_temperature_range();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
</div><!-- fragment --><p>Now, let's start the loop over all cells in the triangulation. Again, we need two cell iterators that walk in parallel through the cells of the two involved <a class="el" href="classDoFHandler.html">DoFHandler</a> objects for the Stokes and temperature part. Within the loop, we first set the local rhs to zero, and then get the values and derivatives of the old solution functions at the quadrature points, since they are going to be needed for the definition of the stabilization parameters and as coefficients in the equation, respectively. Note that since the temperature has its own <a class="el" href="classDoFHandler.html">DoFHandler</a> and <a class="el" href="classFEValues.html">FEValues</a> object we get the entire solution at the quadrature point (which is the scalar temperature field only anyway) whereas for the Stokes part we restrict ourselves to extracting the velocity part (and ignoring the pressure part) by using <code>stokes_fe_values[velocities].get_function_values</code> .</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>        = temperature_dof_handler.begin_active();</div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> endc        = temperature_dof_handler.end();</div>
<div class="line"><span class="keyword">auto</span>       stokes_cell = stokes_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++stokes_cell)</div>
<div class="line">  {</div>
<div class="line">    local_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    stokes_fe_values.reinit(stokes_cell);</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                              old_temperature_values);</div>
<div class="line">    temperature_fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                              old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.get_function_gradients(old_temperature_solution,</div>
<div class="line">                                                 old_temperature_grads);</div>
<div class="line">    temperature_fe_values.get_function_gradients(</div>
<div class="line">      old_old_temperature_solution, old_old_temperature_grads);</div>
<div class="line"> </div>
<div class="line">    temperature_fe_values.get_function_laplacians(</div>
<div class="line">      old_temperature_solution, old_temperature_laplacians);</div>
<div class="line">    temperature_fe_values.get_function_laplacians(</div>
<div class="line">      old_old_temperature_solution, old_old_temperature_laplacians);</div>
<div class="line"> </div>
<div class="line">    temperature_right_hand_side.<a class="code" href="classFunction.html#a562fc1114e95e702e6696721f71528db">value_list</a>(</div>
<div class="line">      temperature_fe_values.get_quadrature_points(), gamma_values);</div>
<div class="line"> </div>
<div class="line">    stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                     old_velocity_values);</div>
<div class="line">    stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">      old_stokes_solution, old_old_velocity_values);</div>
</div><!-- fragment --><p>Next, we calculate the artificial viscosity for stabilization according to the discussion in the introduction using the dedicated function. With that at hand, we can get into the loop over quadrature points and local rhs vector components. The terms here are quite lengthy, but their definition follows the time-discrete system developed in the introduction of this program. The BDF-2 scheme needs one more term from the old time step (and involves more complicated factors) than the backward Euler scheme that is used for the first time step. When all this is done, we distribute the local vector into the global one (including hanging node constraints).</p>
<div class="fragment"><div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">           compute_viscosity(old_temperature_values,</div>
<div class="line">                             old_old_temperature_values,</div>
<div class="line">                             old_temperature_grads,</div>
<div class="line">                             old_old_temperature_grads,</div>
<div class="line">                             old_temperature_laplacians,</div>
<div class="line">                             old_old_temperature_laplacians,</div>
<div class="line">                             old_velocity_values,</div>
<div class="line">                             old_old_velocity_values,</div>
<div class="line">                             gamma_values,</div>
<div class="line">                             maximal_velocity,</div>
<div class="line">                             global_T_range.second</div>
<div class="line">  </div>
<div class="line">- global_T_range.first,</div>
<div class="line">                             <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">           {</div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">               {</div>
<div class="line">                 grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                 phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">               }</div>
<div class="line">  </div>
<div class="line">             <span class="keyword">const</span> <span class="keywordtype">double</span> T_term_for_rhs =</div>
<div class="line">               (use_bdf2_scheme ?</div>
<div class="line">                  (old_temperature_values[q] (1 + time_step / old_time_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                   old_old_temperature_values[q] (time_step time_step) /</div>
<div class="line">                     (old_time_step (time_step + old_time_step))) :</div>
<div class="line">                  old_temperature_values[q]);</div>
<div class="line">  </div>
<div class="line">             <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> ext_grad_T =</div>
<div class="line">               (use_bdf2_scheme ?</div>
<div class="line">                  (old_temperature_grads[q] (1 + time_step / old_time_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                   old_old_temperature_grads[q] time_step / old_time_step) :</div>
<div class="line">                  old_temperature_grads[q]);</div>
<div class="line">  </div>
<div class="line">             <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> extrapolated_u =</div>
<div class="line">               (use_bdf2_scheme ?</div>
<div class="line">                  (old_velocity_values[q] (1 + time_step / old_time_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                   old_old_velocity_values[q] time_step / old_time_step) :</div>
<div class="line">                  old_velocity_values[q]);</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">               local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                 (T_term_for_rhs phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                  time_step extrapolated_u ext_grad_T phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                  time_step nu ext_grad_T grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] +</div>
<div class="line">                  time_step gamma_values[q] phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>])</div>
<div class="line">                 temperature_fe_values.JxW(q);</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">         temperature_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                            <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                            temperature_rhs);</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemsolve"></a> </p><h4>BoussinesqFlowProblem::solve</h4>
<p><br  />
 This function solves the linear systems of equations. Following the introduction, we start with the Stokes system, where we need to generate our block Schur preconditioner. Since all the relevant actions are implemented in the class <code>BlockSchurPreconditioner</code> , all we have to do is to initialize the class appropriately. What we need to pass down is an <code>InverseMatrix</code> object for the pressure mass matrix, which we set up using the respective class together with the IC preconditioner we already generated, and the AMG preconditioner for the velocity-velocity matrix. Note that both <code>Mp_preconditioner</code> and <code>Amg_preconditioner</code> are only pointers, so we use <code>*</code> to pass down the actual preconditioner objects. <br  />
 Once the preconditioner is ready, we create a GMRES solver for the block system. Since we are working with Trilinos data structures, we have to set the respective template argument in the solver. GMRES needs to internally store temporary vectors for each iteration (see the discussion in the results section of <a class="el" href="step_22.html">step-22</a> ) &ndash; the more vectors it can use, the better it will generally perform. To keep memory demands in check, we set the number of vectors to 100. This means that up to 100 solver iterations, every temporary vector can be stored. If the solver needs to iterate more often to get the specified tolerance, it will work on a reduced set of vectors by restarting at every 100 iterations. <br  />
 With this all set up, we solve the system and distribute the constraints in the Stokes system, i.e., hanging nodes and no-flux boundary condition, in order to have the appropriate solution values even at constrained dofs. Finally, we write the number of iterations to the screen.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">BoussinesqFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                       <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">      mp_inverse(stokes_preconditioner_matrix.block(1, 1),</div>
<div class="line">                Mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">      <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">      <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix, mp_inverse,Amg_preconditioner);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(stokes_matrix.m(),</div>
<div class="line">                                 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 stokes_rhs.l2_norm());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolverGMRES.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> gmres(</div>
<div class="line">      solver_control,</div>
<div class="line">      <a class="code" href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(100));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; stokes_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (stokes_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">        stokes_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line">    gmres.solve(stokes_matrix, stokes_solution, stokes_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">    stokes_constraints.distribute(stokes_solution);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; GMRES iterations for Stokes subsystem.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Once we know the Stokes solution, we can determine the new time step from the maximal velocity. We have to do this to satisfy the CFL condition since convection terms are treated explicitly in the temperature equation, as discussed in the introduction. The exact form of the formula used here for the time step is discussed in the results section of this program. <br  />
 There is a snatch here. The formula contains a division by the maximum value of the velocity. However, at the start of the computation, we have a constant temperature field (we start with a constant temperature, and it will be nonconstant only after the first time step during which the source acts). Constant temperature means that no buoyancy acts, and so the velocity is zero. Dividing by it will not likely lead to anything good. <br  />
 To avoid the resulting infinite time step, we ask whether the maximal velocity is very small (in particular smaller than the values we encounter during any of the following time steps) and if so rather than dividing by zero we just divide by a small value, resulting in a large but finite time step.</p>
<div class="fragment"><div class="line">old_time_step                 = time_step;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity = get_maximal_velocity();</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (maximal_velocity &gt;= 0.01)</div>
<div class="line">  time_step = 1. / (1.7 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) / temperature_degree</div>
<div class="line">              <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) /</div>
<div class="line">              maximal_velocity;</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">  time_step = 1. / (1.7 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) / temperature_degree</div>
<div class="line">              <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) / .01;</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span></div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;Time step: &quot;</span> &lt;&lt; time_step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">temperature_solution = old_temperature_solution;</div>
</div><!-- fragment --><p>Next we set up the temperature system and the right hand side using the function <code>assemble_temperature_system()</code> . Knowing the matrix and right hand side of the temperature equation, we set up a preconditioner and a solver. The temperature matrix is a mass matrix (with eigenvalues around one) plus a Laplace matrix (with eigenvalues between zero and \(ch^{-2}\) ) times a small number proportional to the time step \(k_n\) . Hence, the resulting symmetric and positive definite matrix has eigenvalues in the range \([1,1+k_nh^{-2}]\) (up to constants). This matrix is only moderately ill conditioned even for small mesh sizes and we get a reasonably good preconditioner by simple means, for example with an incomplete Cholesky decomposition preconditioner (IC) as we also use for preconditioning the pressure mass matrix solver. As a solver, we choose the conjugate gradient method CG. As before, we tell the solver to use Trilinos vectors via the template argument <code><a class="el" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></code> . Finally, we solve, distribute the hanging node constraints and write out the number of iterations.</p>
<div class="fragment"><div class="line">assemble_temperature_system(maximal_velocity);</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(temperature_matrix.m(),</div>
<div class="line">                               1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-8 temperature_rhs.l2_norm());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">  <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(temperature_matrix);</div>
<div class="line"> </div>
<div class="line">  cg.solve(temperature_matrix,</div>
<div class="line">           temperature_solution,</div>
<div class="line">           temperature_rhs,</div>
<div class="line">           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">  temperature_constraints.distribute(temperature_solution);</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; CG iterations for temperature.&quot;</span> &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>At the end of this function, we step through the vector and read out the maximum and minimum temperature value, which we also want to output. This will come in handy when determining the correct constant in the choice of time step as discuss in the results section of this program.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">double</span> min_temperature = temperature_solution(0),</div>
<div class="line">           max_temperature = temperature_solution(0);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; temperature_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        min_temperature =</div>
<div class="line">          std::min&lt;double&gt;(min_temperature, temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">        max_temperature =</div>
<div class="line">          std::max&lt;double&gt;(max_temperature, temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Temperature range: &quot;</span> &lt;&lt; min_temperature &lt;&lt; <span class="charliteral">&#39; &#39;</span></div>
<div class="line">              &lt;&lt; max_temperature &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemoutput_results"></a> </p><h4>BoussinesqFlowProblem::output_results</h4>
<p><br  />
 This function writes the solution to a VTK output file for visualization, which is done every tenth time step. This is usually quite a simple task, since the deal.II library provides functions that do almost all the job for us. There is one new function compared to previous examples: We want to visualize both the Stokes solution and the temperature as one data set, but we have done all the calculations based on two different <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. Luckily, the <a class="el" href="classDataOut.html">DataOut</a> class is prepared to deal with it. All we have to do is to not attach one single <a class="el" href="classDoFHandler.html">DoFHandler</a> at the beginning and then use that for all added vector, but specify the <a class="el" href="classDoFHandler.html">DoFHandler</a> to each vector separately. The rest is done as in <a class="el" href="step_22.html">step-22</a> . We create solution names (that are going to appear in the visualization program for the individual components). The first <code>dim</code> components are the vector velocity, and then we have pressure for the Stokes part, whereas temperature is scalar. This information is read out using the <a class="el" href="namespaceDataComponentInterpretation.html">DataComponentInterpretation</a> helper class. Next, we actually attach the data vectors with their <a class="el" href="classDoFHandler.html">DoFHandler</a> objects, build patches according to the degree of freedom, which are (sub-) elements that describe the data for visualization programs. Finally, we open a file (that includes the time step number) and write the vtk data into it.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (timestep_number % 10 != 0)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;std::string&gt; stokes_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  stokes_names.emplace_back(<span class="stringliteral">&quot;p&quot;</span>);</div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    stokes_component_interpretation(</div>
<div class="line">      <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    stokes_component_interpretation[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] =</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(stokes_dof_handler,</div>
<div class="line">                           stokes_solution,</div>
<div class="line">                           stokes_names,</div>
<div class="line">                           stokes_component_interpretation);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(temperature_dof_handler,</div>
<div class="line">                           temperature_solution,</div>
<div class="line">                           <span class="stringliteral">&quot;T&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(stokes_degree, temperature_degree));</div>
<div class="line"> </div>
<div class="line">  std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution-&quot;</span> +</div>
<div class="line">                       <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 4) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemrefine_mesh"></a> </p><h4>BoussinesqFlowProblem::refine_mesh</h4>
<p><br  />
 This function takes care of the adaptive mesh refinement. The three tasks this function performs is to first find out which cells to refine/coarsen, then to actually do the refinement and eventually transfer the solution vectors between the two different grids. The first task is simply achieved by using the well-established Kelly error estimator on the temperature (it is the temperature we're mainly interested in for this program, and we need to be accurate in regions of high temperature gradients, also to not have too much numerical diffusion). The second task is to actually do the remeshing. That involves only basic functions as well, such as the <code>refine_and_coarsen_fixed_fraction</code> that refines those cells with the largest estimated error that together make up 80 per cent of the error, and coarsens those cells with the smallest error that make up for a combined 10 per cent of the error. <br  />
 If implemented like this, we would get a program that will not make much progress: Remember that we expect temperature fields that are nearly discontinuous (the diffusivity \(\kappa\) is very small after all) and consequently we can expect that a freely adapted mesh will refine further and further into the areas of large gradients. This decrease in mesh size will then be accompanied by a decrease in time step, requiring an exceedingly large number of time steps to solve to a given final time. It will also lead to meshes that are much better at resolving discontinuities after several mesh refinement cycles than in the beginning. <br  />
 In particular to prevent the decrease in time step size and the correspondingly large number of time steps, we limit the maximal refinement depth of the mesh. To this end, after the refinement indicator has been applied to the cells, we simply loop over all cells on the finest level and unselect them from refinement if they would result in too high a mesh level.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span></div>
<div class="line">   BoussinesqFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(temperature_dof_handler,</div>
<div class="line">                                        <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt;(temperature_degree + 1),</div>
<div class="line">                                        {},</div>
<div class="line">                                        temperature_solution,</div>
<div class="line">                                        estimated_error_per_cell);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                       estimated_error_per_cell,</div>
<div class="line">                                                       0.8,</div>
<div class="line">                                                       0.1);</div>
<div class="line">     <span class="keywordflow">if</span> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> :</div>
<div class="line">            <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators_on_level(max_grid_level))</div>
<div class="line">         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
</div><!-- fragment --><p>As part of mesh refinement we need to transfer the solution vectors from the old mesh to the new one. To this end we use the <a class="el" href="classSolutionTransfer.html">SolutionTransfer</a> class and we have to prepare the solution vectors that should be transferred to the new grid (we will lose the old grid once we have done the refinement so the transfer has to happen concurrently with refinement). What we definitely need are the current and the old temperature (BDF-2 time stepping requires two old solutions). Since the <a class="el" href="classSolutionTransfer.html">SolutionTransfer</a> objects only support to transfer one object per dof handler, we need to collect the two temperature solutions in one data structure. Moreover, we choose to transfer the Stokes solution, too, since we need the velocity at two previous time steps, of which only one is calculated on the fly. <br  />
 Consequently, we initialize two <a class="el" href="classSolutionTransfer.html">SolutionTransfer</a> objects for the Stokes and temperature <a class="el" href="classDoFHandler.html">DoFHandler</a> objects, by attaching them to the old dof handlers. With this at place, we can prepare the triangulation and the data vectors for refinement (in this order).</p>
<div class="fragment"><div class="line">std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_temperature(2);</div>
<div class="line">x_temperature[0]                            = temperature_solution;</div>
<div class="line">x_temperature[1]                            = old_temperature_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> x_stokes = stokes_solution;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> temperature_trans(</div>
<div class="line">  temperature_dof_handler);</div>
<div class="line"><a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> stokes_trans(</div>
<div class="line">  stokes_dof_handler);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">temperature_trans.prepare_for_coarsening_and_refinement(x_temperature);</div>
<div class="line">stokes_trans.prepare_for_coarsening_and_refinement(x_stokes);</div>
</div><!-- fragment --><p>Now everything is ready, so do the refinement and recreate the dof structure on the new grid, and initialize the matrix structures and the new vectors in the <code>setup_dofs</code> function. Next, we actually perform the interpolation of the solutions between the grids. We create another copy of temporary vectors for temperature (now corresponding to the new grid), and let the interpolate function do the job. Then, the resulting array of vectors is written into the respective vector member variables. <br  />
 Remember that the set of constraints will be updated for the new triangulation in the setup_dofs() call.</p>
<div class="fragment"><div class="line"><a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">setup_dofs();</div>
<div class="line"> </div>
<div class="line">std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp(2);</div>
<div class="line">tmp[0].<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(temperature_solution);</div>
<div class="line">tmp[1].<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(temperature_solution);</div>
<div class="line">temperature_trans.interpolate(x_temperature, tmp);</div>
<div class="line"> </div>
<div class="line">temperature_solution     = tmp[0];</div>
<div class="line">old_temperature_solution = tmp[1];</div>
</div><!-- fragment --><p>After the solution has been transferred we then enforce the constraints on the transferred solution.</p>
<div class="fragment"><div class="line">temperature_constraints.distribute(temperature_solution);</div>
<div class="line">temperature_constraints.distribute(old_temperature_solution);</div>
</div><!-- fragment --><p>For the Stokes vector, everything is just the same &ndash; except that we do not need another temporary vector since we just interpolate a single vector. In the end, we have to tell the program that the matrices and preconditioners need to be regenerated, since the mesh has changed.</p>
<div class="fragment"><div class="line">  stokes_trans.interpolate(x_stokes, stokes_solution);</div>
<div class="line"> </div>
<div class="line">  stokes_constraints.distribute(stokes_solution);</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_matrix         = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_temperature_matrices  = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_stokes_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemrun"></a> </p><h4>BoussinesqFlowProblem::run</h4>
<p><br  />
 This function performs all the essential steps in the Boussinesq program. It starts by setting up a grid (depending on the spatial dimension, we choose some different level of initial refinement and additional adaptive refinement steps, and then create a cube in <code>dim</code> dimensions and set up the dofs for the first time. Since we want to start the time stepping already with an adaptively refined grid, we perform some pre-refinement steps, consisting of all assembly, solution and refinement, but without actually advancing in time. Rather, we use the vilified <code>goto</code> statement to jump out of the time loop right after mesh refinement to start all over again on the new mesh beginning at the <code>start_time_iteration</code> label. (The use of the <code>goto</code> is discussed in <a class="el" href="step_26.html">step-26</a> .) <br  />
 Before we start, we project the initial values to the grid and obtain the first data for the <code>old_temperature_solution</code> vector. Then, we initialize time step number and time step and start the time loop.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">BoussinesqFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 4 : 2);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 4 : 3);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">  global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(initial_refinement);</div>
<div class="line"> </div>
<div class="line">  setup_dofs();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">start_time_iteration:</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(temperature_dof_handler,</div>
<div class="line">                       temperature_constraints,</div>
<div class="line">                       <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(temperature_degree + 2),</div>
<div class="line">                       EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">                       old_temperature_solution);</div>
<div class="line"> </div>
<div class="line">  timestep_number = 0;</div>
<div class="line">  time_step = old_time_step = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div>
<div class="line">                &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>The first steps in the time loop are all obvious &ndash; we assemble the Stokes system, the preconditioner, the temperature matrix (matrices and preconditioner do actually only change in case we've remeshed before), and then do the solve. Before going on with the next time step, we have to check whether we should first finish the pre-refinement steps or if we should remesh (every fifth time step), refining up to a level that is consistent with initial refinement and pre-refinement steps. Last in the loop is to advance the solutions, i.e., to copy the solutions to the next "older" time level.</p>
<div class="fragment"><div class="line">  assemble_stokes_system();</div>
<div class="line">  build_stokes_preconditioner();</div>
<div class="line">  assemble_temperature_matrix();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">  output_results();</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">      (pre_refinement_step &lt; n_pre_refinement_steps))</div>
<div class="line">    {</div>
<div class="line">      refine_mesh(initial_refinement + n_pre_refinement_steps);</div>
<div class="line">      ++pre_refinement_step;</div>
<div class="line">      <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 5 == 0))</div>
<div class="line">    refine_mesh(initial_refinement + n_pre_refinement_steps);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">  ++timestep_number;</div>
<div class="line"> </div>
<div class="line">  old_stokes_solution          = stokes_solution;</div>
<div class="line">  old_old_temperature_solution = old_temperature_solution;</div>
<div class="line">  old_temperature_solution     = temperature_solution;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Do all the above until we arrive at time 100.</p>
<div class="fragment"><div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &lt;= 100);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step31</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>The main function looks almost the same as in all other programs.</p>
<p>There is one difference we have to be careful about. This program uses Trilinos and, typically, Trilinos is configured so that it can run in parallel using MPI. This doesn't mean that it <em>has</em> to run in parallel, and in fact this program (unlike <a class="el" href="step_32.html">step-32</a> ) makes no attempt at all to do anything in parallel using MPI. Nevertheless, Trilinos wants the MPI system to be initialized. We do that be creating an object of type <a class="el" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> that initializes MPI (if available) using the arguments given to <a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a> (i.e., <code>argc</code> and <code>argv</code> ) and de-initializes it again when the object goes out of scope.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, charargv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep31.html">Step31</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
</div><!-- fragment --><p>This program can only be run in serial. Otherwise, throw an exception.</p>
<div class="fragment"><div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-31&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      BoussinesqFlowProblem&lt;2&gt; flow_problem;</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="Resultsin2d"></a></p><h3>Results in 2d </h3>
<p>When you run the program in 2d, the output will look something likethis:<code></p><pre>Number of active cells: 256 (on 5 levels)Number of degrees of freedom: 3556 (2178+289+1089)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 0.919118   9 CG iterations for temperature.   Temperature range:</pre><p></code></p>
<p><code></p><pre><ul>
<li>.16687 1.30011
  Number of active cells: 280 (on 6 levels)Number of degrees of freedom: 4062 (2490+327+1245)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 0.459559   9 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></p>
<p><code></p><pre><ul>
<li>.0982971 0.598503
  Number of active cells: 520 (on 7 levels)Number of degrees of freedom: 7432 (4562+589+2281)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 0.229779   9 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></p>
<p><code></p><pre><ul>
<li>.0551098 0.294493
  Number of active cells: 1072 (on 8 levels)Number of degrees of freedom: 15294 (9398+1197+4699)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 0.11489   9 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></p>
<p><code></p><pre><ul>
<li>.0273524 0.156861
  Number of active cells: 2116 (on 9 levels)Number of degrees of freedom: 30114 (18518+2337+9259)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 0.0574449   9 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></p>
<p><code></p><pre><ul>
<li>.014993 0.0738328
  Timestep 1:  t=0.0574449   Assembling...   Solving...   56 GMRES iterations for Stokes subsystem.   Time step: 0.0574449   9 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></p>
<p><code></p><pre><ul>
<li>.0273934 0.14488
  ...
  In the beginning we refine the mesh several times adaptively andalways return to time step zero to restart on the newly refinedmesh. Only then do we start the actual time iteration.
  The program runs for a while. The temperature field for time steps 0,500, 1000, 1500, 2000, 3000, 4000, and 5000 looks like this (note thatthe color scale used for the temperature is not always the same):
    <table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.00.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.01.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.02.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.03.png" alt="" class="inline"/>
    
  
  </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.04.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.05.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.06.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.solution.07.png" alt="" class="inline"/>
    
  
</td></tr>
</table>
<br  />

  The visualizations shown here were generated using a version of the examplewhich did not enforce the constraints after transferring the mesh.
  As can be seen, we have three heat sources that heat fluid andtherefore produce a buoyancy effect that lets hots pockets of fluidrise up and swirl around. By a chimney effect, the three streams arepressed together by fluid that comes from the outside and wants tojoin the updraft party. Note that because the fluid is initially atrest, those parts of the fluid that were initially over the sourcesreceive a longer heating time than that fluid that is later draggedover the source by the fully developed flow field. It is thereforehotter, a fact that can be seen in the red tips of the threeplumes. Note also the relatively fine features of the flow field, aresult of the sophisticated transport stabilization of the temperatureequation we have chosen.
  In addition to the pictures above, the following ones show theadaptive mesh and the flow field at the same time steps:
    <table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.00.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.01.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.02.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.03.png" alt="" class="inline"/>
    
  
  </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.04.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.05.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.06.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.2d.grid.07.png" alt="" class="inline"/>
    
  
</td></tr>
</table>
<br  />
</li>
</ul>
</pre><p></code></p>
<p><code></p><pre>  <a class="anchor" id="Resultsin3d"></a><h3>Results in 3d </h3>
</pre><p></code></p>
<p><code></p><pre></pre><p></code></p>
<p><code></p><pre>  The same thing can of course be done in 3d by changing the templateparameter to the BoussinesqFlowProblem object in   <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code>  from 2 to 3, so that the output now looks like follows:
  <code><pre>Number of active cells: 64 (on 3 levels)Number of degrees of freedom: 3041 (2187+125+729)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 2.45098   9 CG iterations for temperature.   Temperature range:</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre><ul>
<li>.675683 4.94725
  Number of active cells: 288 (on 4 levels)Number of degrees of freedom: 12379 (8943+455+2981)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 1.22549   9 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre><ul>
<li>.527701 2.25764
  Number of active cells: 1296 (on 5 levels)Number of degrees of freedom: 51497 (37305+1757+12435)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 0.612745   10 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre><ul>
<li>.496942 0.847395
  Number of active cells: 5048 (on 6 levels)Number of degrees of freedom: 192425 (139569+6333+46523)
  Timestep 0:  t=0   Assembling...   Rebuilding Stokes preconditioner...   Solving...   0 GMRES iterations for Stokes subsystem.   Time step: 0.306373   10 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre><ul>
<li>.267683 0.497739
  Timestep 1:  t=0.306373   Assembling...   Solving...   27 GMRES iterations for Stokes subsystem.   Time step: 0.306373   10 CG iterations for temperature.   Temperature range:</li>
</ul>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre><ul>
<li>.461787 0.958679
  ...
  Visualizing the temperature isocontours at time steps 0,50, 100, 150, 200, 300, 400, 500, 600, 700, and 800 yields thefollowing plots:
    <table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.00.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.01.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.02.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.03.png" alt="" class="inline"/>
    
  
  </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.04.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.05.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.06.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.07.png" alt="" class="inline"/>
    
  
  </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.08.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.09.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.3d.solution.10.png" alt="" class="inline"/>
    
    </td><td></td></tr>
</table>
<br  />

  That the first picture looks like three hedgehogs stems from the fact that ourscheme essentially projects the source times the first time step size onto themesh to obtain the temperature field in the first time step. Since the sourcefunction is discontinuous, we need to expect over- and undershoots from thisproject. This is in fact what happens (it's easier to check this in 2d) andleads to the crumpled appearance of the isosurfaces.  The visualizations shownhere were generated using a version of the example which did not enforce theconstraints after transferring the mesh.</li>
</ul>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <a class="anchor" id="Numericalexperimentstodetermineoptimalparameters"></a><h3>Numerical experiments to determine optimal parameters </h3>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre></pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  The program as is has three parameters that we don't have much of atheoretical handle on how to choose in an optimal way. These are:  <ul>
<li>
The time step must satisfy a CFL condition \(k\le \min_K \frac{c_kh_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  . Here, \(c_k\)   is      dimensionless, but what is the right value?    </li>
<li>
In the computation of the artificial viscosity, <p class="formulaDsp">
\begin{eqnarray*} \nu_\alpha(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} \min\left\{ h_K, h_K^\alpha \frac{\|R_\alpha(T)\|_{L^\infty(K)}}{c(\mathbf{u},T)} \right\}, \end{eqnarray*}
</p>

        with \(c(\mathbf{u},T) = c_R\ \|\mathbf{u}\|_{L^\infty(\Omega)} \ \mathrm{var}(T) \ |\mathrm{diam}(\Omega)|^{\alpha-2}\)  .      Here, the choice of the dimensionless numbers \(\beta,c_R\)   is of      interest.  </li>
</ul>
In all of these cases, we will have to expect that the correct choice of eachvalue depends on that of the others, and most likely also on the spacedimension and polynomial degree of the finite element used for thetemperature. Below we'll discuss a few numerical experiments to chooseconstants \(c_k\)   and \(\beta\)  .
  Below, we will not discuss the choice of \(c_R\)  . In the program, we setit to \(c_R=2^{\frac{4-2\alpha}{d}}\)  . The reason for this value is abit complicated and has more to do with the history of the programthan reasoning: while the correct formula for the global scalingparameter \(c(\mathbf{u},T)\)   is shown above, the program (including theversion shipped with deal.II 6.2) initially had a bug in that wecomputed \(c(\mathbf{u},T) = \|\mathbf{u}\|_{L^\infty(\Omega)} \ \mathrm{var}(T) \ \frac{1}{|\mathrm{diam}(\Omega)|^{\alpha-2}}\)   instead, wherewe had set the scaling parameter to one. Since we only computed on theunit square/cube where \(\mathrm{diam}(\Omega)=2^{1/d}\)  , this wasentirely equivalent to using the correct formula with \(c_R=\left(2^{1/d}\right)^{4-2\alpha}=2^{\frac{4-2\alpha}{d}}\)  . Sincethis value for \(c_R\)   appears to work just fine for the currentprogram, we corrected the formula in the program and set \(c_R\)   to avalue that reproduces exactly the results we had before. We will,however, revisit this issue again in   <a class="el" href="step_32.html">step-32</a>  .
  Now, however, back to the discussion of what values of \(c_k\)   and \(\beta\)   to choose:</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <a class="anchor" id="Choosingicsubksubiandbeta"></a><h4>Choosing <em>c<sub>k</sub></em><em>c<sub>k</sub></em> and beta </h4>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre></pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  These two constants are definitely linked in some way. The reason is easy tosee: In the case of a pure advection problem, \(\frac{\partial T}{\partial t} + \mathbf{u}\cdot\nabla T = \gamma\)  , anyexplicit scheme has to satisfy a CFL condition of the form \(k\le \min_K \frac{c_k^a h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  . On the other hand,for a pure diffusion problem, \(\frac{\partial T}{\partial t} + \nu \Delta T = \gamma\)  ,explicit schemes need to satisfy a condition \(k\le \min_K \frac{c_k^d h_K^2}{\nu}\)  . So given the form of \(\nu\)   above, anadvection diffusion problem like the one we have to solve here will result ina condition of the form \( k\le \min_K \min \left\{ \frac{c_k^a h_K}{\|\mathbf{u}\|_{L^\infty(K)}}, \frac{c_k^d h_K^2}{\beta \|\mathbf{u}\|_{L^\infty(K)} h_K}\right\} = \min_K \left( \min \left\{ c_k^a, \frac{c_k^d}{\beta}\right\} \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}} \right) \)  .It follows that we have to face the fact that we might want to choose \(\beta\)  larger to improve the stability of the numerical scheme (by increasing theamount of artificial diffusion), but we have to pay a price in the form ofsmaller, and consequently more time steps. In practice, one would thereforelike to choose \(\beta\)   as small as possible to keep the transport problemsufficiently stabilized while at the same time trying to choose the time stepas large as possible to reduce the overall amount of work.
  The find the right balance, the only way is to do a few computationalexperiments. Here's what we did: We modified the program slightly to allowless mesh refinement (so we don't always have to wait that long) and to choose \( \nu(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} h_K \)   to eliminate the effect of the constant \(c_R\)   (we know thatsolutions are stable by using this version of \(\nu(T)\)   as an artificialviscosity, but that we can improve things</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre><ul>
<li>i.e. make the solutionsharper</li>
<li>by using the more complicated formula for this artificialviscosity). We then run the programfor different values \(c_k,\beta\)   and observe maximal and minimal temperaturesin the domain. What we expect to see is this: If we choose the time step toobig (i.e. choose a \(c_k\)   bigger than theoretically allowed) then we will getexponential growth of the temperature. If we choose \(\beta\)   too small, thenthe transport stabilization becomes insufficient and the solution will showsignificant oscillations but not exponential growth.</li>
</ul>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <a class="anchor" id="ResultsforQsub1subelements"></a><h5>Results for Q<sub>1</sub> elements</h5>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre></pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  Here is what we get for \(\beta=0.01, \beta=0.1\)  , and \(\beta=0.5\)  , different choices of \(c_k\)  , andbilinear elements (  <code>temperature_degree=1</code>  ) in 2d:
    <table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.01.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.03.png" alt="" class="inline"/>
    
  
  </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.1.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q1.beta=0.5.png" alt="" class="inline"/>
    
  
</td></tr>
</table>
<br  />

  The way to interpret these graphs goes like this: for \(\beta=0.01\)   and \(c_k=\frac 12,\frac 14\)  , we see exponential growth or at least largevariations, but if we choose \(k=\frac 18\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  or smaller, then the scheme isstable though a bit wobbly. For more artificial diffusion, we can choose \(k=\frac 14\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  or smaller for \(\beta=0.03\)  , \(k=\frac 13\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  or smaller for \(\beta=0.1\)  , and again need \(k=\frac 1{15}\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  for \(\beta=0.5\)   (this time because much diffusion requires a small timestep).
  So how to choose? If we were simply interested in a large time step, then wewould go with \(\beta=0.1\)   and \(k=\frac 13\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  .On the other hand, we're also interested in accuracy and here it may be ofinterest to actually investigate what these curves show. To this end note thatwe start with a zero temperature and that our sources are positive &mdash; sowe would intuitively expect that the temperature can never drop belowzero. But it does, a consequence of Gibb's phenomenon when using continuouselements to approximate a discontinuous solution. We can therefore see thatchoosing \(\beta\)   too small is bad: too little artificial diffusion leads toover- and undershoots that aren't diffused away. On the other hand, for large \(\beta\)  , the minimum temperature drops below zero at the beginning but thenquickly diffuses back to zero.
  On the other hand, let's also look at the maximum temperature. Watching themovie of the solution, we see that initially the fluid is at rest. The sourcekeeps heating the same volume of fluid whose temperature increases linearly atthe beginning until its buoyancy is able to move it upwards. The hottest partof the fluid is therefore transported away from the solution and fluid takingits place is heated for only a short time before being moved out of the sourceregion, therefore remaining cooler than the initial bubble. If \(\kappa=0\)  (in the program it is nonzero but very small) then the hottest part of thefluid should be advected along with the flow with its temperatureconstant. That's what we can see in the graphs with the smallest \(\beta\)  : Oncethe maximum temperature is reached, it hardly changes any more. On the otherhand, the larger the artificial diffusion, the more the hot spot isdiffused. Note that for this criterion, the time step size does not play asignificant role.
  So to sum up, likely the best choice would appear to be \(\beta=0.03\)  and \(k=\frac 14\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  . The curve isa bit wobbly, but overall pictures looks pretty reasonable with theexception of some over and undershoots close to the start time due toGibb's phenomenon.</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <a class="anchor" id="ResultsforQsub2subelements"></a><h5>Results for Q<sub>2</sub> elements</h5>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre></pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  One can repeat the same sequence of experiments for higher orderelements as well. Here are the graphs for bi-quadratic shape functions(  <code>temperature_degree=2</code>  ) for the temperature, while weretain the \(Q_2/Q_1\)   stable Taylor-Hood element for the Stokes system:
    <table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.01.png" alt="" class="inline"/>
    
    </td><td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.03.png" alt="" class="inline"/>
    
  
  </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-31.timestep.q2.beta=0.1.png" alt="" class="inline"/>
    
  
</td></tr>
</table>
<br  />

  Again, small values of \(\beta\)   lead to less diffusion but we have tochoose the time step very small to keep things under control. Toolarge values of \(\beta\)   make for more diffusion, but again requiresmall time steps. The best value would appear to be \(\beta=0.03\)  , asfor the \(Q_1\)   element, and then we have to choose \(k=\frac 18\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)   &mdash; exactlyhalf the size for the \(Q_1\)   element, a fact that may not be surprisingif we state the CFL condition as the requirement that the time step besmall enough so that the distance transport advects in each time stepis no longer than one <em>grid point</em> away (which for \(Q_1\)   elementsis \(h_K\)  , but for \(Q_2\)   elements is \(h_K/2\)  ). It turns out that \(\beta\)  needs to be slightly larger for obtaining stable results also late inthe simulation at times larger than 60, so we actually choose it as \(\beta = 0.034\)   in the code.</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <a class="anchor" id="Resultsfor3d"></a><h5>Results for 3d</h5>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre></pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  One can repeat these experiments in 3d and find the optimal time stepfor each value of \(\beta\)   and find the best value of \(\beta\)  . What onefinds is that for the same \(\beta\)   already used in 2d, the time stepsneeds to be a bit smaller, by around a factor of 1.2 or so. This iseasily explained: the time step restriction is \(k=\min_K \frac{ch_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)   where \(h_K\)   isthe <em>diameter</em> of the cell. However, what is really needed is thedistance between mesh points, which is \(\frac{h_K}{\sqrt{d}}\)  . So amore appropriate form would be \(k=\min_K \frac{ch_K}{\|\mathbf{u}\|_{L^\infty(K)}\sqrt{d}}\)  .
  The second find is that one needs to choose \(\beta\)   slightly bigger(about \(\beta=0.05\)   or so). This then again reduces the time step wecan take.</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <a class="anchor" id="Conclusions"></a><h5>Conclusions</h5>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre></pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  Concluding, from the simple computations above, \(\beta=0.034\)   appears to be agood choice for the stabilization parameter in 2d, and \(\beta=0.05\)   in 3d. Ina dimension independent way, we can model this as \(\beta=0.017d\)  . If one doeslonger computations (several thousand time steps) on finer meshes, onerealizes that the time step size is not quite small enough and that forstability one will have to reduce the above values a bit more (by about afactor of \(\frac 78\)  ).
  As a consequence, a formula that reconciles 2d, 3d, and variable polynomialdegree and takes all factors in account reads as follows: <p class="formulaDsp">
\begin{eqnarray*} k = \frac 1{2 \cdot 1.7} \frac 1{\sqrt{d}} \frac 2d \frac 1{q_T} \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}} = \frac 1{1.7 d\sqrt{d}} \frac 1{q_T} \frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}. \end{eqnarray*}
</p>

  In the first form (in the center of the equation), \(\frac 1{2 \cdot 1.7}\)   is a universal constant, \(\frac 1{\sqrt{d}}\)  is the factor that accounts for the difference between cell diameterand grid point separation, \(\frac 2d\)   accounts for the increase in \(\beta\)   with space dimension, \(\frac 1{q_T}\)   accounts for the distance between grid points forhigher order elements, and \(\frac{h_K}{\|\mathbf{u}\|_{L^\infty(K)}}\)  for the local speed of transport relative to the cell size. This isthe formula that we use in the program.
  As for the question of whether to use \(Q_1\)   or \(Q_2\)   elements for thetemperature, the following considerations may be useful: First,solving the temperature equation is hardly a factor in the overallscheme since almost the entire compute time goes into solving theStokes system in each time step. Higher order elements for thetemperature equation are therefore not a significant drawback. On theother hand, if one compares the size of the over- and undershoots thesolution produces due to the discontinuous source description, onenotices that for the choice of \(\beta\)   and \(k\)   as above, the \(Q_1\)  solution dips down to around \(-0.47\)  , whereas the \(Q_2\)   solution onlygoes to \(-0.13\)   (remember that the exact solution should never becomenegative at all. This means that the \(Q_2\)   solution is significantlymore accurate; the program therefore uses these higher order elements,despite the penalty we pay in terms of smaller time steps.</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <a class="anchor" id="Possibilitiesforextensions"></a><h3>Possibilities for extensions </h3>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre></pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  There are various ways to extend the current program. Of particular interestis, of course, to make it faster and/or increase the resolution of theprogram, in particular in 3d. This is the topic of the   <a class="el" href="step_32.html">step-32</a>  tutorial program which will implement strategies to solve this problem inparallel on a cluster. It is also the basis of the much larger opensource code ASPECT (see <a href="https://aspect.geodynamics.org/">https://aspect.geodynamics.org/</a> ) that can solve realisticproblems and that constitutes the further development of   <a class="el" href="step_32.html">step-32</a>  .
  Another direction would be to make the fluid flow more realistic. The programwas initially written to simulate various cases simulating the convection ofmaterial in the earth's mantle, i.e. the zone between the outer earth core andthe solid earth crust: there, material is heated from below and cooled fromabove, leading to thermal convection. The physics of this fluid are much morecomplicated than shown in this program, however: The viscosity of mantlematerial is strongly dependent on the temperature, i.e. \(\eta=\eta(T)\)  , withthe dependency frequently modeled as a viscosity that is reduced exponentiallywith rising temperature. Secondly, much of the dynamics of the mantle isdetermined by chemical reactions, primarily phase changes of the variouscrystals that make up the mantle; the buoyancy term on the right hand side ofthe Stokes equations then depends not only on the temperature, but also on thechemical composition at a given location which is advected by the flow fieldbut also changes as a function of pressure and temperature. We willinvestigate some of these effects in later tutorial programs as well.</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <a class="anchor" id="PlainProg"></a><h1>The plain program</h1>
</pre><p></code></pre><p></code></p>
<p><code></p><pre><code><pre>  <div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2007 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Martin Kronbichler, Uppsala University,</span></div>
<div class="line"><span class="comment"> *          Wolfgang Bangerth, Texas A&amp;M University 2007, 2008</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep31.html">Step31</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>EquationData</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a>     = 1;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">kappa</a>   = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>    = 10;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a> = 1;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>TemperatureInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      TemperatureInitialValues()</div>
<div class="line">        : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">          value(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">      }</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>TemperatureRightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      TemperatureRightHandSide()</div>
<div class="line">        : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        (void)<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>;</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0,</div>
<div class="line">               <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Invalid operation for a scalar function.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2) || (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3), <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> source_centers[3] = {</div>
<div class="line">          (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(.3, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.3, .5, .1)),</div>
<div class="line">          (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.45, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.45, .5, .1)),</div>
<div class="line">          (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.75, .1) : <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(.75, .5, .1))};</div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> source_radius = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 1. / 32 : 1. / 8);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> ((source_centers[0].distance(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ||</div>
<div class="line">                    (source_centers[1].<a class="code" href="classPoint.html#a3df8e6ab311dab9337c8d7b039c7b815">distance</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ||</div>
<div class="line">                    (source_centers[2].distance(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>) &lt; source_radius) ?</div>
<div class="line">                  1 :</div>
<div class="line">                  0);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">          value(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureRightHandSide&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">      }</div>
<div class="line">    };</div>
<div class="line">  } <span class="comment">// namespace EquationData</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">  {</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                    <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(VectorType &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerType &amp;           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">      <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">      <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">      : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">      , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">      VectorType &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">      <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-7 * src.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">try</span></div>
<div class="line">        {</div>
<div class="line">          cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>.what()));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      BlockSchurPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">        <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                            PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">        <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                 <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">        stokes_matrix;</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                             PreconditionerTypeMp&gt;&gt;</div>
<div class="line">                                 m_inverse;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div>
<div class="line">      BlockSchurPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">        <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                            PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">        <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner)</div>
<div class="line">      : stokes_matrix(&amp;S)</div>
<div class="line">      , m_inverse(&amp;Mpinv)</div>
<div class="line">      , a_preconditioner(Apreconditioner)</div>
<div class="line">      , tmp(<a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(stokes_matrix-&gt;<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1, 1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>()))</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keywordtype">void</span></div>
<div class="line">    <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult</a>(</div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">      stokes_matrix-&gt;block(1, 0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">      tmp *= -1;</div>
<div class="line">      m_inverse-&gt;vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">    }</div>
<div class="line">  } <span class="comment">// namespace LinearSolvers</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>BoussinesqFlowProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    BoussinesqFlowProblem();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span>   setup_dofs();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_stokes_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span>   build_stokes_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_stokes_system();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_temperature_system(<span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity);</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_temperature_matrix();</div>
<div class="line">    <span class="keywordtype">double</span> get_maximal_velocity() <span class="keyword">const</span>;</div>
<div class="line">    std::pair&lt;double, double&gt; get_extrapolated_temperature_range() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span>                      <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span>                      output_results() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span>                      refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <span class="keywordtype">double</span>             global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        stokes_degree;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             stokes_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           stokes_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> stokes_constraints;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;IndexSet&gt;               stokes_partitioning;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_stokes_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        temperature_degree;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 temperature_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           temperature_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> temperature_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_mass_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_stiffness_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>       time_step;</div>
<div class="line">    <span class="keywordtype">double</span>       old_time_step;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionAMG&gt; Amg_preconditioner;</div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt;  Mp_preconditioner;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_stokes_matrix;</div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_temperature_matrices;</div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_stokes_preconditioner;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::BoussinesqFlowProblem()</div>
<div class="line">    : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">    , global_Omega_diameter(std::numeric_limits&lt;<a class="code" href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a>&gt;::quiet_NaN())</div>
<div class="line">    , stokes_degree(1)</div>
<div class="line">    , stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_degree + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_degree), 1)</div>
<div class="line">    , stokes_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    temperature_degree(2)</div>
<div class="line">    , temperature_fe(temperature_degree)</div>
<div class="line">    , temperature_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    time_step(0)</div>
<div class="line">    , old_time_step(0)</div>
<div class="line">    , timestep_number(0)</div>
<div class="line">    , rebuild_stokes_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    , rebuild_temperature_matrices(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    , rebuild_stokes_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_maximal_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(), stokes_degree + 1);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(stokes_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    <span class="keywordtype">double</span>                      max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                  velocity_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> max_velocity;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::pair&lt;double, double&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::get_extrapolated_temperature_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                            temperature_degree);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(temperature_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">               max_temperature = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                          old_temperature_values);</div>
<div class="line">            fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                          old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> =</div>
<div class="line">                  (1. + time_step / old_time_step) * old_temperature_values[q] -</div>
<div class="line">                  time_step / old_time_step * old_old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">                min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">               max_temperature = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                          old_temperature_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> = old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">                min_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                max_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> std::make_pair(min_temperature, max_temperature);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        gamma_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_u_infty,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_T_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = 0.017 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 1.0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (global_u_infty == 0)</div>
<div class="line">      <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 * cell_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_temperature.size();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_residual = 0;</div>
<div class="line">    <span class="keywordtype">double</span> max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u =</div>
<div class="line">          (old_velocity_values[q] + old_old_velocity_values[q]) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dT_dt =</div>
<div class="line">          (old_temperature[q] - old_old_temperature[q]) / old_time_step;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_T =</div>
<div class="line">          u * (old_temperature_grads[q] + old_old_temperature_grads[q]) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> kappa_Delta_T =</div>
<div class="line">          <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> *</div>
<div class="line">          (old_temperature_laplacians[q] + old_old_temperature_laplacians[q]) /</div>
<div class="line">          2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> =</div>
<div class="line">          <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dT_dt + u_grad_T - kappa_Delta_T - gamma_values[q]) *</div>
<div class="line">                   std::pow((old_temperature[q] + old_old_temperature[q]) / 2,</div>
<div class="line">                            <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 1.));</div>
<div class="line"> </div>
<div class="line">        max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">        max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u * u), max_velocity);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(2., (4. - 2 * <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) / <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R * global_u_infty * global_T_variation *</div>
<div class="line">                                  <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(global_Omega_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 2.);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (</div>
<div class="line">      <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a> * max_velocity *</div>
<div class="line">      <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(cell_diameter,</div>
<div class="line">               std::pow(cell_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) * max_residual / global_scaling));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;unsigned int&gt; stokes_sub_blocks(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">    stokes_sub_blocks[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      stokes_dof_handler.distribute_dofs(stokes_fe);</div>
<div class="line">      <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">      stokes_constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                              stokes_constraints);</div>
<div class="line">      std::set&lt;types::boundary_id&gt; no_normal_flux_boundaries;</div>
<div class="line">      no_normal_flux_boundaries.insert(0);</div>
<div class="line">      <a class="code" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                                      0,</div>
<div class="line">                                                      no_normal_flux_boundaries,</div>
<div class="line">                                                      stokes_constraints);</div>
<div class="line">      stokes_constraints.close();</div>
<div class="line">    }</div>
<div class="line">    {</div>
<div class="line">      temperature_dof_handler.distribute_dofs(temperature_fe);</div>
<div class="line"> </div>
<div class="line">      temperature_constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(temperature_dof_handler,</div>
<div class="line">                                              temperature_constraints);</div>
<div class="line">      temperature_constraints.close();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; stokes_dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = stokes_dofs_per_block[0],</div>
<div class="line">                       n_p = stokes_dofs_per_block[1],</div>
<div class="line">                       n_T = temperature_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_T &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div>
<div class="line">              &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_T &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    stokes_partitioning.resize(2);</div>
<div class="line">    stokes_partitioning[0] = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_u);</div>
<div class="line">    stokes_partitioning[1] = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_p);</div>
<div class="line">    {</div>
<div class="line">      stokes_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">      dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">      dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">      dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        stokes_dof_handler, coupling, dsp, stokes_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      stokes_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      Amg_preconditioner.reset();</div>
<div class="line">      Mp_preconditioner.reset();</div>
<div class="line">      stokes_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">      dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">      dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">      dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        stokes_dof_handler, coupling, dsp, stokes_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      stokes_preconditioner_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      temperature_mass_matrix.clear();</div>
<div class="line">      temperature_stiffness_matrix.clear();</div>
<div class="line">      temperature_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_T, n_T);</div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(temperature_dof_handler,</div>
<div class="line">                                      dsp,</div>
<div class="line">                                      temperature_constraints,</div>
<div class="line">                                      <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      temperature_matrix.reinit(dsp);</div>
<div class="line">      temperature_mass_matrix.reinit(temperature_matrix);</div>
<div class="line">      temperature_stiffness_matrix.reinit(temperature_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> temperature_partitioning = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_T);</div>
<div class="line">    stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_stokes_solution.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    stokes_rhs.reinit(stokes_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_temperature_solution.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_old_temperature_solution.reinit(temperature_partitioning,</div>
<div class="line">                                        MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    temperature_rhs.reinit(temperature_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_preconditioner()</div>
<div class="line">  {</div>
<div class="line">    stokes_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(stokes_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div>
<div class="line">                                   quadrature_formula,</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;         phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                grad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> *</div>
<div class="line">                     <a class="code" href="base_2symmetric__tensor_8h.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(grad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>], grad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) +</div>
<div class="line">                   (1. / <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a>) * phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                  stokes_fe_values.JxW(q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        stokes_constraints.distribute_local_to_global(</div>
<div class="line">          local_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, stokes_preconditioner_matrix);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::build_stokes_preconditioner()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_preconditioner == <span class="keyword">false</span>)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding Stokes preconditioner...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    assemble_stokes_preconditioner();</div>
<div class="line"> </div>
<div class="line">    Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionAMG&gt;();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;std::vector&lt;bool&gt;</a>&gt; constant_modes;</div>
<div class="line">    <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocity_components(0);</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>(stokes_dof_handler,</div>
<div class="line">                                     stokes_fe.component_mask(</div>
<div class="line">                                       velocity_components),</div>
<div class="line">                                     constant_modes);</div>
<div class="line">    <a class="code" href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a> amg_data;</div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">constant_modes</a> = constant_modes;</div>
<div class="line"> </div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">elliptic</a>              = <span class="keyword">true</span>;</div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">higher_order_elements</a> = <span class="keyword">true</span>;</div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">smoother_sweeps</a>       = 2;</div>
<div class="line">    amg_data.<a class="code" href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">aggregation_threshold</a> = 0.02;</div>
<div class="line">    Amg_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(0, 0),</div>
<div class="line">                                   amg_data);</div>
<div class="line"> </div>
<div class="line">    Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">    Mp_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(1, 1));</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_preconditioner = <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_system()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">      stokes_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    stokes_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(stokes_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(</div>
<div class="line">      stokes_fe,</div>
<div class="line">      quadrature_formula,</div>
<div class="line">      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">        (rebuild_stokes_matrix == <span class="keyword">true</span> ? <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> : <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>(0)));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values(temperature_fe,</div>
<div class="line">                                        quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt;          phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; grads_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>             = stokes_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc             = stokes_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       temperature_cell = temperature_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++temperature_cell)</div>
<div class="line">      {</div>
<div class="line">        stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        temperature_fe_values.reinit(temperature_cell);</div>
<div class="line"> </div>
<div class="line">        local_matrix = 0;</div>
<div class="line">        local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                                  old_temperature_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> old_temperature = old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">                  {</div>
<div class="line">                    grads_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                      stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                    div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                      stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                    phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                  local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * 2 * (grads_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grads_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) -</div>
<div class="line">                     div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                    stokes_fe_values.JxW(q);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> gravity =</div>
<div class="line">              -((<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2) ? (<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 1)) : (<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(0, 0, 1)));</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (-<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a> * <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">EquationData::beta</a> *</div>
<div class="line">                               gravity * phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * old_temperature) *</div>
<div class="line">                              stokes_fe_values.JxW(q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">          stokes_constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                                        local_rhs,</div>
<div class="line">                                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                        stokes_matrix,</div>
<div class="line">                                                        stokes_rhs);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          stokes_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                        stokes_rhs);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_matrix = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_matrix()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_temperature_matrices == <span class="keyword">false</span>)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    temperature_mass_matrix      = 0;</div>
<div class="line">    temperature_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>   quadrature_formula(temperature_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values(temperature_fe,</div>
<div class="line">                                        quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = temperature_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_mass_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_stiffness_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        local_mass_matrix      = 0;</div>
<div class="line">        local_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                {</div>
<div class="line">                  local_mass_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] * temperature_fe_values.JxW(q));</div>
<div class="line">                  local_stiffness_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (<a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> * grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">                     temperature_fe_values.JxW(q));</div>
<div class="line">                }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        temperature_constraints.distribute_local_to_global(</div>
<div class="line">          local_mass_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, temperature_mass_matrix);</div>
<div class="line">        temperature_constraints.distribute_local_to_global(</div>
<div class="line">          local_stiffness_matrix,</div>
<div class="line">          <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">          temperature_stiffness_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    rebuild_temperature_matrices = <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_system(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (use_bdf2_scheme == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">        temperature_matrix *=</div>
<div class="line">          (2 * time_step + old_time_step) / (time_step + old_time_step);</div>
<div class="line">        temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">        temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    temperature_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(temperature_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     temperature_fe_values(temperature_fe,</div>
<div class="line">                                        quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     stokes_fe_values(stokes_fe,</div>
<div class="line">                                   quadrature_formula,</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = temperature_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_temperature_grads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_temperature_grads(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_temperature_laplacians(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_old_temperature_laplacians(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    EquationData::TemperatureRightHandSide&lt;dim&gt; temperature_right_hand_side;</div>
<div class="line">    std::vector&lt;double&gt;                         gamma_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range =</div>
<div class="line">      get_extrapolated_temperature_range();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>        = temperature_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc        = temperature_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       stokes_cell = stokes_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++stokes_cell)</div>
<div class="line">      {</div>
<div class="line">        local_rhs = 0;</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        stokes_fe_values.reinit(stokes_cell);</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                                  old_temperature_values);</div>
<div class="line">        temperature_fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                                  old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.get_function_gradients(old_temperature_solution,</div>
<div class="line">                                                     old_temperature_grads);</div>
<div class="line">        temperature_fe_values.get_function_gradients(</div>
<div class="line">          old_old_temperature_solution, old_old_temperature_grads);</div>
<div class="line"> </div>
<div class="line">        temperature_fe_values.get_function_laplacians(</div>
<div class="line">          old_temperature_solution, old_temperature_laplacians);</div>
<div class="line">        temperature_fe_values.get_function_laplacians(</div>
<div class="line">          old_old_temperature_solution, old_old_temperature_laplacians);</div>
<div class="line"> </div>
<div class="line">        temperature_right_hand_side.<a class="code" href="classFunction.html#a562fc1114e95e702e6696721f71528db">value_list</a>(</div>
<div class="line">          temperature_fe_values.get_quadrature_points(), gamma_values);</div>
<div class="line"> </div>
<div class="line">        stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                         old_velocity_values);</div>
<div class="line">        stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">          old_stokes_solution, old_old_velocity_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">          compute_viscosity(old_temperature_values,</div>
<div class="line">                            old_old_temperature_values,</div>
<div class="line">                            old_temperature_grads,</div>
<div class="line">                            old_old_temperature_grads,</div>
<div class="line">                            old_temperature_laplacians,</div>
<div class="line">                            old_old_temperature_laplacians,</div>
<div class="line">                            old_velocity_values,</div>
<div class="line">                            old_old_velocity_values,</div>
<div class="line">                            gamma_values,</div>
<div class="line">                            maximal_velocity,</div>
<div class="line">                            global_T_range.second - global_T_range.first,</div>
<div class="line">                            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> T_term_for_rhs =</div>
<div class="line">              (use_bdf2_scheme ?</div>
<div class="line">                 (old_temperature_values[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                  old_old_temperature_values[q] * (time_step * time_step) /</div>
<div class="line">                    (old_time_step * (time_step + old_time_step))) :</div>
<div class="line">                 old_temperature_values[q]);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> ext_grad_T =</div>
<div class="line">              (use_bdf2_scheme ?</div>
<div class="line">                 (old_temperature_grads[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                  old_old_temperature_grads[q] * time_step / old_time_step) :</div>
<div class="line">                 old_temperature_grads[q]);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> extrapolated_u =</div>
<div class="line">              (use_bdf2_scheme ?</div>
<div class="line">                 (old_velocity_values[q] * (1 + time_step / old_time_step) -</div>
<div class="line">                  old_old_velocity_values[q] * time_step / old_time_step) :</div>
<div class="line">                 old_velocity_values[q]);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                (T_term_for_rhs * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">                 time_step * extrapolated_u * ext_grad_T * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">                 time_step * nu * ext_grad_T * grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] +</div>
<div class="line">                 time_step * gamma_values[q] * phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) *</div>
<div class="line">                temperature_fe_values.JxW(q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        temperature_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                           <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                           temperature_rhs);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">BoussinesqFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                         <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">        mp_inverse(stokes_preconditioner_matrix.block(1, 1),</div>
<div class="line">                   *Mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">        <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">        <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">        <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix, mp_inverse, *Amg_preconditioner);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(stokes_matrix.m(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * stokes_rhs.l2_norm());</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverGMRES.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> gmres(</div>
<div class="line">        solver_control,</div>
<div class="line">        <a class="code" href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(100));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; stokes_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (stokes_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">          stokes_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line">      gmres.solve(stokes_matrix, stokes_solution, stokes_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">      stokes_constraints.distribute(stokes_solution);</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot; GMRES iterations for Stokes subsystem.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    old_time_step                 = time_step;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity = get_maximal_velocity();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (maximal_velocity &gt;= 0.01)</div>
<div class="line">      time_step = 1. / (1.7 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> * <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) / temperature_degree *</div>
<div class="line">                  <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) /</div>
<div class="line">                  maximal_velocity;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      time_step = 1. / (1.7 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> * <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) / temperature_degree *</div>
<div class="line">                  <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) / .01;</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span></div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Time step: &quot;</span> &lt;&lt; time_step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    temperature_solution = old_temperature_solution;</div>
<div class="line"> </div>
<div class="line">    assemble_temperature_system(maximal_velocity);</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(temperature_matrix.m(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-8 * temperature_rhs.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">      <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(temperature_matrix);</div>
<div class="line"> </div>
<div class="line">      cg.solve(temperature_matrix,</div>
<div class="line">               temperature_solution,</div>
<div class="line">               temperature_rhs,</div>
<div class="line">               <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">      temperature_constraints.distribute(temperature_solution);</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot; CG iterations for temperature.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> min_temperature = temperature_solution(0),</div>
<div class="line">             max_temperature = temperature_solution(0);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; temperature_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          min_temperature =</div>
<div class="line">            std::min&lt;double&gt;(min_temperature, temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">          max_temperature =</div>
<div class="line">            std::max&lt;double&gt;(max_temperature, temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Temperature range: &quot;</span> &lt;&lt; min_temperature &lt;&lt; <span class="charliteral">&#39; &#39;</span></div>
<div class="line">                &lt;&lt; max_temperature &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number % 10 != 0)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;std::string&gt; stokes_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">    stokes_names.emplace_back(<span class="stringliteral">&quot;p&quot;</span>);</div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      stokes_component_interpretation(</div>
<div class="line">        <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      stokes_component_interpretation[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] =</div>
<div class="line">        <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(stokes_dof_handler,</div>
<div class="line">                             stokes_solution,</div>
<div class="line">                             stokes_names,</div>
<div class="line">                             stokes_component_interpretation);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(temperature_dof_handler,</div>
<div class="line">                             temperature_solution,</div>
<div class="line">                             <span class="stringliteral">&quot;T&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(stokes_degree, temperature_degree));</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution-&quot;</span> +</div>
<div class="line">                         <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 4) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(temperature_dof_handler,</div>
<div class="line">                                       <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(temperature_degree + 1),</div>
<div class="line">                                       {},</div>
<div class="line">                                       temperature_solution,</div>
<div class="line">                                       estimated_error_per_cell);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                      estimated_error_per_cell,</div>
<div class="line">                                                      0.8,</div>
<div class="line">                                                      0.1);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> :</div>
<div class="line">           <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators_on_level(max_grid_level))</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_temperature(2);</div>
<div class="line">    x_temperature[0]                            = temperature_solution;</div>
<div class="line">    x_temperature[1]                            = old_temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> x_stokes = stokes_solution;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> temperature_trans(</div>
<div class="line">      temperature_dof_handler);</div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> stokes_trans(</div>
<div class="line">      stokes_dof_handler);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">    temperature_trans.prepare_for_coarsening_and_refinement(x_temperature);</div>
<div class="line">    stokes_trans.prepare_for_coarsening_and_refinement(x_stokes);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp(2);</div>
<div class="line">    tmp[0].<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(temperature_solution);</div>
<div class="line">    tmp[1].<a class="code" href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(temperature_solution);</div>
<div class="line">    temperature_trans.interpolate(x_temperature, tmp);</div>
<div class="line"> </div>
<div class="line">    temperature_solution     = tmp[0];</div>
<div class="line">    old_temperature_solution = tmp[1];</div>
<div class="line"> </div>
<div class="line">    temperature_constraints.distribute(temperature_solution);</div>
<div class="line">    temperature_constraints.distribute(old_temperature_solution);</div>
<div class="line"> </div>
<div class="line">    stokes_trans.interpolate(x_stokes, stokes_solution);</div>
<div class="line"> </div>
<div class="line">    stokes_constraints.distribute(stokes_solution);</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_matrix         = <span class="keyword">true</span>;</div>
<div class="line">    rebuild_temperature_matrices  = <span class="keyword">true</span>;</div>
<div class="line">    rebuild_stokes_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">BoussinesqFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 4 : 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 4 : 3);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">    global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(initial_refinement);</div>
<div class="line"> </div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">  start_time_iteration:</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(temperature_dof_handler,</div>
<div class="line">                         temperature_constraints,</div>
<div class="line">                         <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(temperature_degree + 2),</div>
<div class="line">                         EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">                         old_temperature_solution);</div>
<div class="line"> </div>
<div class="line">    timestep_number = 0;</div>
<div class="line">    time_step = old_time_step = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_stokes_system();</div>
<div class="line">        build_stokes_preconditioner();</div>
<div class="line">        assemble_temperature_matrix();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        output_results();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; n_pre_refinement_steps))</div>
<div class="line">          {</div>
<div class="line">            refine_mesh(initial_refinement + n_pre_refinement_steps);</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 5 == 0))</div>
<div class="line">          refine_mesh(initial_refinement + n_pre_refinement_steps);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">        ++timestep_number;</div>
<div class="line"> </div>
<div class="line">        old_stokes_solution          = stokes_solution;</div>
<div class="line">        old_old_temperature_solution = old_temperature_solution;</div>
<div class="line">        old_temperature_solution     = temperature_solution;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &lt;= 100);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step31</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep31.html">Step31</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-31&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      BoussinesqFlowProblem&lt;2&gt; flow_problem;</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment -->  
<br  />

</pre><p></code></pre><p></code></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="asparse__vanka__0_8txt_html_a63f572a3b5d8c173a82cee16f5858977"><div class="ttname"><a href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a></div><div class="ttdeci">this elimination is done by the modification of the right hand and in the end these degrees of freedom do not occur in the matrix and solution vector any more at all *This system is solved and the values are updated into the destination vector the matrices are built up such that the degree of freedom associated with the Lagrange multiplier is the first one usually the upper left entry in the matrix is zero It is not clear to so it must persist longer than the Vanka object The same is true for the matrix The matrix[2.x.11] which is passed here may or may not be the same matrix for which this object shall act as preconditioner In it is conceivable that the preconditioner is build up for one matrix but is used for subsequent steps in a nonlinear process as where the matrix changes in each step slightly **Destructor Delete all allocated matrices **Parameters for SparseVanka **Constructor For the parameters see below **Constructor For the parameters see below[2.x.12] The use of this constructor is deprecated **the second and third parameters are ignored **Indices of those degrees of freedom that we shall work on **If the default constructor is used then this function needs to be called before an object of this class is used as preconditioner For more detail about possible parameters see the class documentation and the documentation of the[2.x.13] class After this function is called the preconditioner is ready to be only values for allowed indices are written to[2.x.27] dst</div><div class="ttdef"><b>Definition:</b> <a href="sparse__vanka__0_8txt_source.html#l00060">sparse_vanka_0.txt:60</a></div></div>
<div class="ttc" id="apolynomial__0_8txt_html_af1258c87f1d73d29bd17331843ac1d25"><div class="ttname"><a href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a></div><div class="ttdeci">namespace in which classes relating to the description of d polynomial spaces are declared ***Base class for all D polynomials A polynomial is represented in this class by its coefficients which are set through the constructor or by derived classes There are two paths for evaluation of polynomials One is based on the coefficients which are evaluated through the Horner scheme which is a robust general purpose scheme An alternative and more stable evaluation of high degree polynomials with roots in the unit interval is provided by a product in terms of the roots This form is available for special polynomials such as Lagrange polynomials or Legendre polynomials and used with the respective constructor To obtain this more stable evaluation form the constructor with the roots in form of a Lagrange polynomial must be used In case a manipulation is done that changes the roots the representation is switched to the coefficient form This class is a typical example of a possible template argument for the TensorProductPolynomials class **Constructor The coefficients of the polynomial are passed as and denote the i e the first element of the array denotes the constant the second the linear and so on The degree of the polynomial represented by this object is thus the number of elements in the&lt; tt &gt; coefficient&lt;/tt &gt; array minus one **Constructor creating a zero polynomial of degree *[2.x.3] *Constructor for a Lagrange polynomial and its point of evaluation The idea is to where j is the evaluation point specified as argument and the support points contain all the evaluation is based on products of the whereas the Horner scheme is used for polynomials in the coefficient form **Return the values and the derivatives of the Polynomial at point&lt; tt &gt; x&lt;/tt &gt;&lt; tt &gt; i</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__0_8txt_source.html#l00024">polynomial_0.txt:24</a></div></div>
<div class="ttc" id="alac_2solver__gmres_8h_html"><div class="ttname"><a href="lac_2solver__gmres_8h.html">solver_gmres.h</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a79cbe2f02f8dfb85026c71d783dbb703"><div class="ttname"><a href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out__dof__data_8h_source.html#l01096">data_out_dof_data.h:1096</a></div></div>
<div class="ttc" id="anamespaceStep31_1_1EquationData_html_aa1e9e1a7297b10cb39c2065f86acc66f"><div class="ttname"><a href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">Step31::EquationData::density</a></div><div class="ttdeci">constexpr double density</div><div class="ttdef"><b>Definition:</b> <a href="step-31_8cc_source.html#l00075">step-31.cc:75</a></div></div>
<div class="ttc" id="aclassIndexSet_html"><div class="ttname"><a href="classIndexSet.html">IndexSet</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l00068">index_set.h:68</a></div></div>
<div class="ttc" id="aclassFEValues_html_a21f914e63d588e2652a9514620653d77"><div class="ttname"><a href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell)</div></div>
<div class="ttc" id="anamespaceLinearAlgebraPETSc_1_1MPI_html_a326d001228d45e600ba97606c24a01c7"><div class="ttname"><a href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">LinearAlgebraPETSc::MPI::PreconditionAMG</a></div><div class="ttdeci">PETScWrappers::PreconditionBoomerAMG PreconditionAMG</div><div class="ttdef"><b>Definition:</b> <a href="lac_2generic__linear__algebra_8h_source.html#l00151">generic_linear_algebra.h:151</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1PreconditionIC_html"><div class="ttname"><a href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l00922">trilinos_precondition.h:922</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00077">fe_update_flags.h:77</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1Vector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__vector_8h_source.html#l00280">trilinos_vector.h:280</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_afec1b694405cadb2d251275096ad3563"><div class="ttname"><a href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a></div><div class="ttdeci">if we even only hold bytes per line in this sparsity we ll need GB for this object even if every single line is empty Of only million lines will be non for which we need MB plus whatever is necessary to store the actual column indices of nonzero entries Let s say we have a moderately complex problem with entries per for each of which we store the column index worth then we ll need bytes for each of the million lines that correspond to the degrees of freedom we for a total of GB And we ll need bytes for each of the million lines that we don t for a total of GB It is clear that this ratio doesn t become any better if we go to even higher numbers of processors *The solution to this problem is to really only use any memory at all for those parts of the linear system that we or need for some other reason For all other we must know that they but we can not set up any part of our data structure To this there exists a class called IndexSet that denotes a set of indices which we care for and for which we may have to allocate memory The data structures for sparsity patterns constraint matrices matrices and vector can be initialized with these IndexSet objects to really only care for those rows or entries that correspond to indices in the index set and not care about all others These objects will then ask how many indices exist in the set allocate memory for each one of and when you want to access data for global degree of freedom[2.x.28] you will be redirected to the result of calling[2.x.29] with index[2.x.30] instead Accessing data for elements[2.x.31] for which[2.x.32] is false will yield an error *The remaining question is how to identify the set of indices that correspond to degrees of freedom we need to worry about on each processor To this you can use the[2.x.33] function to get at all the indices a processor owns Note that this is a subset of the degrees of freedom that are defined on the locally owned one sometimes needs the set of all degrees of freedom on the locally owned subdomain as well as the adjacent ghost cells This information is provided by the[2.x.35] function ***A typical parallel application is dealing with two different kinds of parallel but there are of course different vector types that can each represent both ghosted vectors are typically used for data output</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00059">distributed_0.txt:59</a></div></div>
<div class="ttc" id="ahdf5__0_8txt_html_aae153b86de45d3354cd3edd5b992435e"><div class="ttname"><a href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a></div><div class="ttdeci">*Namespace containing deal II s HDF5 interface whereas writing and reading raw data in a dataset can be done independently or double</div><div class="ttdef"><b>Definition:</b> <a href="hdf5__0_8txt_source.html#l00045">hdf5_0.txt:45</a></div></div>
<div class="ttc" id="aevent__0_8txt_html_a60053d8ff825674cfcc1321aba229cd7"><div class="ttname"><a href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a></div><div class="ttdeci">*Objects of this kind are used to notify interior applications of changes provoked by an outer loop They are handed to the application through[2.x.0] and it is up to the actual application how to handle them Event is organized as an extensible binary enumerator Every class can add its own events using here is how to retrieve it knowing the name generating a clear Event **Clear all flags **Set all flags **Add the flags of the other event **Clear the flags of the other event **Test whether all the flags set in the other Event are also set in this one **Return&lt; tt &gt; true&lt;/tt &gt; if any event is set **List the flags to a stream **List all assigned events actions have to be taken by all means if this value is true</div><div class="ttdef"><b>Definition:</b> <a href="event__0_8txt_source.html#l00028">event_0.txt:28</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_afc96893388fe1a55c6ae5ae19ba52c6d"><div class="ttname"><a href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a></div><div class="ttdeci">void extract_constant_modes(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const ComponentMask &amp;component_mask, std::vector&lt; std::vector&lt; bool &gt;&gt; &amp;constant_modes)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01227">dof_tools.cc:1227</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__cg_8h_source.html#l00088">solver_cg.h:88</a></div></div>
<div class="ttc" id="apetsc__precondition__0_8txt_html_a41ebb2d49faa97a3d9eab4b4f13c2742"><div class="ttname"><a href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a></div><div class="ttdeci">*Base class for preconditioner classes using the PETSc functionality The classes in this hierarchy don t do a whole lot except for providing a function that sets the preconditioner and certain parameters on the preconditioning context of the solver These classes are basically here only to allow a similar interface as already used for the deal II solver and preconditioner classes Note that derived classes only provide interfaces to the relevant functionality of PETSc PETSc does not implement all preconditioners for all matrix types In particular some preconditioners are not going to work for parallel jobs such as for example the ILU preconditioner ***Constructor **Destructor **Destroys the preconditioner</div><div class="ttdef"><b>Definition:</b> <a href="petsc__precondition__0_8txt_source.html#l00002">petsc_precondition_0.txt:2</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga852e93b85f68573cd0eedfe62c0f6bdc"><div class="ttname"><a href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">TrilinosWrappers::PreconditionAMG::AdditionalData::elliptic</a></div><div class="ttdeci">bool elliptic</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01516">trilinos_precondition.h:1516</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a8fba07b9a84b89e6be225f5f95c3e355"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div><div class="ttdeci">the program is just and one can not intelligently work around that *It is sometimes useful to change the behavior of the[2.x.6] macro from aborting a program to throwing exceptions On the other exceptions are not allowed to propagate out of destructors of classes For this there is a variant of the called[2.x.7] that can be used in destructors These use cases are discussed further down below on this page **Dynamic such as whether an output file can be written to *These are things that shouldn t be checked because it is not guaranteed that a program for which the condition is satisfied in a debug mode run</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00022">exceptions_0.txt:22</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespaceUtilities_html_a6195c5f009ea8c7c536c6ffdf108c32f"><div class="ttname"><a href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></div><div class="ttdeci">std::string int_to_string(const unsigned int value, const unsigned int digits=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00473">utilities.cc:473</a></div></div>
<div class="ttc" id="agrid_2grid__tools_8h_html"><div class="ttname"><a href="grid_2grid__tools_8h.html">grid_tools.h</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2namespace__dealii_8h_source.html#l00026">namespace_dealii.h:26</a></div></div>
<div class="ttc" id="amatrix__free_2dof__info__0_8txt_html_afc846d40941f6f9934e92e469096f30f"><div class="ttname"><a href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a></div><div class="ttdeci">We set the granularity to **that is a number sufficiently large to minimize loop peel overhead within the this function always returns index If an index is not found in hp it returns *[2.x.2] *Populate the vector[2.x.3] with locally owned degrees of freedom stored on the cell block[2.x.4] If[2.x.5] is then the returned vector will contain indices required to resolve constraints The image below illustrates the output of this function for cell blocks zero and one with zero Dirichlet boundary conditions at the bottom of the domain Note that due to the presence of the DoFs returned by this function for the case i indices that are located on another get a temporary number by this and will later be assigned the correct index after all the ghost indices have been collected by the call to *[2.x.12] *This method assigns the correct indices to ghost indices from the temporary numbering employed by the[2.x.13] function The numbers are localized with respect to the MPI and ghosts start at the end of the locally owned range This we get direct access to all vector entries **This method reorders the way cells are gone through based on a given renumbering of the cells It also takes[2.x.14] cells together and interprets them as one cell as is needed for vectorization **Finds possible compression for the cell indices that we can apply for increased efficiency Run at the end of reorder_cells **Finds possible compression for the face indices that we can apply for increased efficiency Run at the end of reorder_cells **This function computes the connectivity of the currently stored indices in terms of connections between the individual cells and fills the structure into a sparsity pattern **In case face integrals are find out whether certain loops over the unknowns only access a subset of all the ghost dofs we keep in the main partitioner **Given[2.x.15] containing the index of cells of macro the index ordering can be improved for typical DG elements by interleaving the degrees of freedom from batches of which avoids the data transposition in[2.x.16] these more advanced features are not so there is only limited value of this function **Fills the array that defines how to zero selected ranges in the result vector within the cell filling the two member variables[2.x.17] vector_zero_range_list_index and[2.x.18] The intent of this pattern is to zero the vector entries in close temporal proximity to the first access and thus keeping the vector entries in cache **Return the memory consumption in bytes of this class **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **Prints a representation of the indices in the class to the given output stream **Enum for various storage variants of the indices This storage format is used to implement more efficient indexing schemes in case the underlying data structures allow for and to inform the access functions in[2.x.19] on which array to get the data from One example of more efficient storage is the enum value[2.x.20] which means that one can get the indices to all degrees of freedom of a cell by reading only the first index for each whereas all subsequent indices are merely an offset from the first index **This value indicates that no index compression was found and the only valid storage is to access all indices present on the possibly including constraints For a cell face of this index the data access in FEEvaluationBase is directed to the array[2.x.21] dof_indices with the index row_starts[cell_index *n_vectorization *n_components] first **This value indicates that the indices are interleaved for access with vectorized gather and scatter operation This storage variant is possible in case there are no constraints on the cell and the indices in the batch of cells are not pointing to the same global index in different slots of a vectorized the data access in FEEvaluationBase is directed to the array dof_indices_interleaved with the index row_starts[cell_index *n_vectorization *n_components] first **This value indicates that the indices within a cell are all and one can get the index to the cell by reading that single value for each of the cells in the cell batch For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **This value indicates that the indices with a cell are contiguous and interleaved for i the first DoF index on a cell to the four or eight cells in the vectorization batch come than the second DoF and so on the interleaving between cells implies that only the batches for vectorization can be accessed whereas there is a strided access for getting only some of the entries The two additional categories interleaved_contiguous_strided and interleaved_contiguous_mixed_strides are a consequence of this storage type The former is for faces where at least one of the two adjacent sides will break with the interleaved storage We then have to make a strided access as described in the next category The last category interleaved_contiguous_mixed_strides appears in the ghost see the more detailed description of that category below this is something that cannot be avoided in general once we interleave the indices between cells For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **Similar to interleaved_contiguous but for the case when the interleaved indices are only contiguous within the degrees of but not also over the components of a vectorized array This happens typically on faces with DG where the cells have interleaved_contiguous storage but the faces numbering is not the same as the cell s numbering For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **Similar to interleaved_contiguous_separate but for the case when the interleaved indices are not n_vectorization apart This happens typically within the ghost layer of DG where the remote owner has applied an interleaved storage and the current processor only sees some of the cells For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization * n_components</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2dof__info__0_8txt_source.html#l00070">dof_info_0.txt:70</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1SparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__sparse__matrix_8h_source.html#l00505">trilinos_sparse_matrix.h:505</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga0d16c332aaa652e8905a6f48208e4500"><div class="ttname"><a href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a></div><div class="ttdeci">void compute_no_normal_flux_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const unsigned int first_vector_component, const std::set&lt; types::boundary_id &gt; &amp;boundary_ids, AffineConstraints&lt; double &gt; &amp;constraints, const Mapping&lt; dim, spacedim &gt; &amp;mapping=(ReferenceCells::get_hypercube&lt; dim &gt;() .template get_default_linear_mapping&lt; dim, spacedim &gt;()))</div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00070">fe_update_flags.h:70</a></div></div>
<div class="ttc" id="aiterators__0_8txt_html_a6cf0880ba2af3a1be4aacdbbd4b90f9c"><div class="ttname"><a href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a></div><div class="ttdeci">where BaseIterator usually is one of thestandard iterators discussed above *The FilteredIterator gets an additional Predicate in its constructor and willskip all objects where this Predicate evaluates to&lt; tt &gt; false&lt;/tt &gt; Acollection of predicates already implemented can be found in the namespaceIteratorFilters ***IteratorsLoops Iterating over objects *All iterators of the same kind and iterating over thesame kind of geometrical objects traverse the mesh in the sameorder Take this code all iterators will always point to the same mesh even though&lt; tt &gt; DoFHandler&lt;/tt &gt; and&lt; tt &gt; Triangulation&lt;/tt &gt; are very different and even if the DoFHandlers are handling different finite the difference is only in the Accessor As mentioned the order in which iterators traverse the forest ofobjects is actually well but application programs should notassume any such but rather consider this an implementation detailof the library *Corresponding to above the order in which iterators traverse activeobjects is the same for all iterators in the following the difference to the previous example being that here we only consider active but theyare really rather dumb Their magic only lies in the fact that they point tosome useful in this case the Accessor For they point to anactual object that stores some data On the other the deal II when do not return a reference to an actual but returnan object that knows how to get at the data that represents cells In thisobject doesn t store itself where the vertices of a cell are or what its neighborsare it knows how to tease this sort of information from out of thearrays and tables and lists that the Triangulation class sets up to describe amesh *Accessing data that characterizes a cell is always done through the i e the expression[2.x.10] grants access to[1.x.6] attributes of this Accessor Examples of properties you can query from aniterator are ***Since dereferencing iterators yields accessor these calls are tomember etc These in turn figure out the relevant datafrom the various data structures that store this data How this is actuallydone and what data structures are used is not really of concern to authors ofapplications in deal II In by hiding the actual data structureswe are able to store data in an efficient not necessarily in a way thatmakes it easily accessible or understandable to application writers ***IteratorsTypedefs Kinds of accessors *Depending on what sort of data you want to there are different kindsof accessor and hexes that make up a triangulation</div><div class="ttdef"><b>Definition:</b> <a href="iterators__0_8txt_source.html#l00063">iterators_0.txt:63</a></div></div>
<div class="ttc" id="astep-1_8cc_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition:</b> <a href="step-1_8cc_source.html#l00086">step-1.cc:86</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga7b52b286796c23ef9ff178faf7a4b68f"><div class="ttname"><a href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">StandardExceptions::ExcNotImplemented</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcNotImplemented()</div></div>
<div class="ttc" id="amultithreading__0_8txt_html_a0759c0124e216ec36f063ad051f4dba0"><div class="ttname"><a href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a></div><div class="ttdeci">it should be big enough so that we don t spend more time on scheduling sub ranges to processors but small enough that processors can be efficiently load balanced A rule of thumb appears to be that a sub range is too small if it takes less than instructions to execute it *An example of how to use these functions are vector operations like the addition in[2.x.45] where all three objects are of type we used a[1.x.23] to on the a function object that takes two arguments and returns the sum of the two This is exactly what we needed when we want to add the individual elements of vectors[2.x.46] and[2.x.47] and write the sum of the two into the elements of[2.x.48] The function object that we get here is completely known to the compiler and when it expands the loop that results from[2.x.49] will be as if we had written the loop in its obvious thereby eliminating the overhead of calling an external function there are cases where it is inefficient to call some object or function within each iteration *An example for this case is sparse matrix vector multiplication If you know how data is stored in compressed row format like in the SparseMatrix then a matrix vector product function looks like we compute the dot product of a single row of the matrix with the right hand side vector[2.x.51] and write it into the corresponding element of the[2.x.52] vector The code is made more efficient by utilizing that the elements of the[1.x.28] row follow the ones of the current i e at the beginning of the loop body we do not have to re set the pointers that point to the values and column numbers of each row *Using the[2.x.53] function we could in principle write this code as leaving one argument open and thus allowing the[2.x.56] function to consider the passed function argument as unary Also note that we need to make the source and destination vectors neither of which is what we desired notice the grainsize of a minimum of rows of a matrix that should be processed by an individual CPU core *The point is that while this is it is not since now the function object to be called on each row is not a simple[1.x.32] any there is an implicit function call including argument passing in each iteration of the loop *A more efficient way is to let TBB split the original range into sub and then call a target function not on each individual element of the but on the entire range This is facilitated by the[2.x.61] we call the[2.x.62] function on sub ranges of at least elements so that the initial setup cost can amortize *A related operation is when the loops over elements each produce a result that must then be but let s assume for a moment that it is A sequential implementation would look like this for sparse each of which compute their part of the square of the norm</div><div class="ttdef"><b>Definition:</b> <a href="multithreading__0_8txt_source.html#l00124">multithreading_0.txt:124</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation&lt; dim &gt;</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="afe_2fe__q_8h_html"><div class="ttname"><a href="fe_2fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="alogstream__0_8txt_html_add684e6ff311806f483d928c97341d99"><div class="ttname"><a href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a></div><div class="ttdeci">&lt;/tt &gt; or with one of the special member functions is buffered in a thread storage[2.x.15] An[2.x.16] or[2.x.17] will trigger a writeout to the console invoking a as well as a call to ******A subclass allowing for the safe generation and removal of prefixes Somewhere at the beginning of a block</div><div class="ttdef"><b>Definition:</b> <a href="logstream__0_8txt_source.html#l00015">logstream_0.txt:15</a></div></div>
<div class="ttc" id="anewton__0_8txt_html_a21f536f84dd77674667ed5d2a30eb3ab"><div class="ttname"><a href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a></div><div class="ttdeci">*Operator class performing Newton s iteration with standard step size control and adaptive matrix generation This class performs a Newton iteration up to convergence determined by control If after an update the norm of the residual has become larger then step size control is activated and the update is subsequently divided by two until the residual actually becomes depending on the tends to be this method applies an adaptive reassembling strategy Only if the reduction factor for the residual is more than receiving the applications computing the residual and solving the linear respectively **Declare the parameters applicable to Newton s method **Read the parameters in the ParameterHandler **Initialize the pointer data_out for debugging **The actual Newton iteration The initial value is in&lt; tt &gt; which also contains the result after convergence Values in&lt; tt &gt; in&lt;/tt &gt; are not used by but will be handed down to the objects **Set the maximal residual reduction allowed without triggering assembling in the next step Return the previous value **Control object for the Newton iteration **The indicating that the matrix must be assembled anew upon start **A flag used to decide how many stepsize iteration should be made Default is the original value of Enter zero here to turn off stepsize control *Controlled by&lt; tt &gt; Stepsize iterations&lt;/tt &gt; in parameter file **Threshold for re assembling matrix If the quotient of two consecutive residuals is smaller than this the system matrix is not assembled in this step *This parameter should be adjusted to the residual gain of the inner solver The default values is resulting in reassembling in every Newton step **Print residual</div><div class="ttdef"><b>Definition:</b> <a href="newton__0_8txt_source.html#l00032">newton_0.txt:32</a></div></div>
<div class="ttc" id="aclassSymmetricTensor_html_ab14ac27fc9ab74d4de531698b492d8de"><div class="ttname"><a href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">SymmetricTensor::scalar_product</a></div><div class="ttdeci">constexpr ProductType&lt; Number, OtherNumber &gt;::type scalar_product(const SymmetricTensor&lt; 2, dim, Number &gt; &amp;t1, const SymmetricTensor&lt; 2, dim, OtherNumber &gt; &amp;t2)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l03792">symmetric_tensor.h:3792</a></div></div>
<div class="ttc" id="abase_2vectorization_8h_html_ae5c8b2cd70b2640bab8f1ee4ccb7f4cc"><div class="ttname"><a href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; pow(const ::VectorizedArray&lt; Number, width &gt; &amp;x, const ::VectorizedArray&lt; Number, width &gt; &amp;p)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05727">vectorization.h:5727</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2utilities_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2utilities_8h.html">utilities.h</a></div></div>
<div class="ttc" id="anumerics_2error__estimator_8h_html"><div class="ttname"><a href="numerics_2error__estimator_8h.html">error_estimator.h</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Scalar_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00095">fe_values_extractors.h:95</a></div></div>
<div class="ttc" id="alinear__operator__0_8txt_html_a64f52ea7f8959e614f32da4664cdbe50"><div class="ttname"><a href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a></div><div class="ttdeci">*A class to store the abstract concept of a linear set up and handle intermediate storage locations by hand *As an example consider the and[2.x.8] one can sparse matrices with a or larger ***In order to use Trilinos or PETSc sparse matrices and preconditioners in conjunction with the LinearOperator it is necessary to extend the functionality of the LinearOperator class by means of an additional Payload *For for may represent a composite operation The[2.x.14] therefore provides an interface extension to the LinearOperator so that it can be passed to the solver and used by the solver as if it were a Trilinos it is again necessary to provide an interface that produces the result of this composite operation that is compatible with Trilinos the resulting this function also ensures that the underlying Payload matches that of the input *[2.x.105] *****LinearOperator *Return a nulled variant of the LinearOperator[2.x.108] i e with optimized[2.x.109][2.x.110] etc functions and with[2.x.111] set to true ******LinearOperator *Return a LinearOperator that acts as a mean value filter The vmult() functions of this matrix subtract the mean values of the vector. *The function takes an[2.x.114] object[2.x.115] as an argument to initialize the[2.x.116] and[2.x.117] objects of the LinearOperator object. ***[2.x.118] **[0.x.35] *[2.x.119] LinearOperator *Return a LinearOperator that acts as a mean value filter. The vmult() functions of this matrix subtract the mean values of the vector. *The function takes a LinearOperator[2.x.120] and uses its range initializer to create an mean value filter operator.The function also ensures that the underlying Payload matches that of the input[2.x.121] ***[2.x.122] **[0.x.36] *A helper class that is responsible for the initialization of a vector to be directly usable as the destination parameter</div></div>
<div class="ttc" id="aclassBlockVectorBase_html_ae05a0e26814f032473ed2ef66da018bd"><div class="ttname"><a href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">BlockVectorBase::block</a></div><div class="ttdeci">BlockType &amp; block(const unsigned int i)</div></div>
<div class="ttc" id="amapping__info__0_8txt_html_aaed09e22b1fee38bd2273caeedfb0e90"><div class="ttname"><a href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a></div><div class="ttdeci">*An enum to identify various types of cells and faces The most general type is what we typically compute in the FEValues context but for many geometries we can save significant storage ***The cell or face is Cartesian **The cell or face can be described with an affine mapping **The face is i the normal factor on a face is the same on all quadrature points This type is not assigned for cells **There is no special information available for compressing the representation of the object under consideration **Definition of a structure that stores all cached data related to the evaluated geometry from the mapping In order to support hp adaptivity and compressed storage length can be different for different rows it allows to jump at the data of individual rows similar to compressed row storage in sparse matrices We have two different start indices for fields with different sizes The first category of offsets are the indices for Jacobians of the transformation from unit to real second JxW and normal vectors We keep separate arrays for all these data structures because a user code might access only some of them In such a one array will be gone through in a contiguous order with access to all which makes it easy for the processor to prefetch data Having all data in a single array would require some strides in the access which is much more complicated for the processor to called which contains the quadrature weights and permutations of how to go through quadrature points in case of face data The latter comes in a vector for the support of hp with several data fields for the individual quadrature formulas ***Constructor Does nothing **Set up the lengths in the various members of this struct **Set up the lengths in the various members of this struct **Returns the memory consumption in bytes **Number of quadrature points applied on the given cell or face **Original one dimensional quadrature formula applied on the given cell or face **Quadrature formula applied on the given cell or face **Quadrature weights separated by dimension for use in specific situations **A cached vector of quadrature weights in the given number the evaluation of basis functions is not in the correct order if a face is not in the standard orientation to a given element This data structure is used to re order the data evaluated on quadrature points to represent the correct order **A class describing the layout of the sections in the[2.x.2] field and also includes some data that depends on the number of quadrature points in the hp context such as the inner quadrature formula and re indexing for faces that are not in the standard orientation **Collection of quadrature formulae applied on the given face *Only filled for since faces might be quadrilateral or triangle shaped **Stores the index offset into the arrays[2.x.4][2.x.5][2.x.6] and the second derivatives Note that affine cells have shorter fields of where the others have lengths equal to the number of quadrature points of the given cell **The storage of the Jacobian i the inverse and transposed Jacobians of the transformation from the unit to the real cell Indexed by[2.x.9] Contains two fields for access from both sides for interior but the default only the upper diagonal and diagonal part are needed The first index runs through the starting with the diagonal and then continuing row i and so on The second index is the spatial coordinate Indexed by[2.x.12] Contains two fields for access from both sides for interior but the default including a compression scheme for Cartesian cells where we do not need to store the full data on all points Indexed by *[2.x.16] *Clears all data fields except the descriptor vector **Returns the quadrature index for a given number of quadrature points If not in hp mode or if the index is not this function always returns index this function does not check whether the given degree is actually present **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **Returns the memory consumption in bytes **The class that stores all geometry dependent data related with cell interiors for use in the matrix free class ***Compute the information in the given cells and faces The cells are specified by the level and the index within the a mapping and several quadrature formulas are given **Update the information in the given cells and faces that is the result of a change in the given mapping keeping the quadrature formulas and other unknowns unchanged This call is only valid if[2.x.20] has been called before **Return the type of a given cell as detected during initialization **Clear all data fields in this class **Return the memory consumption of this class in bytes **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **The given update flags for computing the geometry on the cells **The given update flags for computing the geometry on the boundary faces **The given update flags for computing the geometry on the interior faces **The given update flags for computing the geometry on the faces for cell centric loops **Stores whether a cell is has constant transform data() or is whether it represents an affine whether it is a flat face where the normal vector is the same throughout the or is following the[2.x.21] variable for the cell types **The pointer to the underlying[2.x.22] object **The pointer to the first entry of mapping_collection **Reference cell type related to each quadrature and active quadrature index **Internal function to compute the geometry for the case the mapping is a MappingQ and a single quadrature formula per i it uses a polynomial description of the cell especially when several different quadrature formulas are and consumes less memory[2.x.23] tria The triangulation to be used for setup[2.x.24] cells The actual cells of the triangulation to be worked given as a tuple of the level and index within the level as used in the main initialization of the class ::x faces The description of the connectivity from faces to cells as filled in the MatrixFree class **Computes the information in the given called within initialize **Computes the information in the given called within initialize **Computes the information in the given called within initialize **Helper function to determine which update flags must be set in the internal functions to initialize all data as requested by the user **A helper class to extract either cell or face data from mapping info for use in FEEvaluationBase **A class that is used to compare floating point c</div><div class="ttdef"><b>Definition:</b> <a href="mapping__info__0_8txt_source.html#l00116">mapping_info_0.txt:116</a></div></div>
<div class="ttc" id="aclassFunction_html_a562fc1114e95e702e6696721f71528db"><div class="ttname"><a href="classFunction.html#a562fc1114e95e702e6696721f71528db">Function::value_list</a></div><div class="ttdeci">virtual void value_list(const std::vector&lt; Point&lt; dim &gt;&gt; &amp;points, std::vector&lt; RangeNumberType &gt; &amp;values, const unsigned int component=0) const</div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1BlockVector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__parallel__block__vector_8h_source.html#l00073">trilinos_parallel_block_vector.h:73</a></div></div>
<div class="ttc" id="anamespaceStep20_1_1PrescribedSolution_html_a2ec9d2a9c0f55b8fb13bd1c83c358e38"><div class="ttname"><a href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">Step20::PrescribedSolution::beta</a></div><div class="ttdeci">constexpr double beta</div><div class="ttdef"><b>Definition:</b> <a href="step-20_8cc_source.html#l00088">step-20.cc:88</a></div></div>
<div class="ttc" id="alac_2block__sparsity__pattern_8h_html"><div class="ttname"><a href="lac_2block__sparsity__pattern_8h.html">block_sparsity_pattern.h</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ac6b404bf03cb2a742b290421cc2789fe"><div class="ttname"><a href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a></div><div class="ttdeci">void project(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const AffineConstraints&lt; typename VectorType::value_type &gt; &amp;constraints, const Quadrature&lt; dim &gt; &amp;quadrature, const Function&lt; spacedim, typename VectorType::value_type &gt; &amp;function, VectorType &amp;vec, const bool enforce_zero_boundary=false, const Quadrature&lt; dim - 1 &gt; &amp;q_boundary=(dim &gt; 1 ? QGauss&lt; dim - 1 &gt;(2) :Quadrature&lt; dim - 1 &gt;(0)), const bool project_to_boundary_first=false)</div></div>
<div class="ttc" id="aclassBlockDynamicSparsityPattern_html"><div class="ttname"><a href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparsity__pattern_8h_source.html#l00549">block_sparsity_pattern.h:549</a></div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a93f65b0385560a34ec1d3c5ec5a882b8"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">Physics::Elasticity::Kinematics::d</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; d(const Tensor&lt; 2, dim, Number &gt; &amp;F, const Tensor&lt; 2, dim, Number &gt; &amp;dF_dt)</div></div>
<div class="ttc" id="alac_2trilinos__block__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2trilinos__block__sparse__matrix_8h.html">trilinos_block_sparse_matrix.h</a></div></div>
<div class="ttc" id="alac_2affine__constraints_8h_html"><div class="ttname"><a href="lac_2affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a></div><div class="ttdeci">@ update_hessians</div><div class="ttdoc">Second derivatives of shape functions.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00084">fe_update_flags.h:84</a></div></div>
<div class="ttc" id="aparameter__handler__0_8txt_html_ad919e2b915d8e8226aef004c2d8399a8"><div class="ttname"><a href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">exception</a></div><div class="ttdeci">since default values may change in the process of program you cannot know the values of parameters not specified in the input file ****It is often convenient to have something happen as soon as a parameter value is read This could be a check that it is valid that a file that is listed in the parameter file exists **or to initiate something else in such as setting a variable outside the this action could also be initiated once all parameters are read via but it is sometimes[1.x.19] to do it right away *This is facilitated by the and can then do whatever they want with it **e save it somewhere outside the ParameterHandler in C one doesn t usually pass around the address of a but an action can be a function like object(taking a string as argument) that results from calling such as a[1.x.20] that has the form **[1.x.21] *and that is attached to a specific parameter. *A typical example of such an action would be as follows the content of the file equals the default value of the parameter the contents of files are never changed after declaration of a parameter a directory in this file system may not have a file called[2.x.20] in it In that the directory represents a subsection as declared and the directory s name will correspond to the name of the subsection It will then have no files in it at but it may have further directories in the code above will lead to a hierarchical representation of data that looks like this(the content of files is indicated at the right in a different font) this is only used when creating output for exceptions If non empty[2.x.35] is the ParameterHandler object will stop parsing lines after encountering[2.x.36] This is handy when adding extra data that shall be parsed manually If[2.x.37] the parameter handler will skip undefined sections and entries This is useful for partially parsing a parameter for example to obtain only the spatial dimension of the problem By default all entries and subsections are expected to be declared The function sets the value of all parameters it encounters in the input file to the provided value Parameters not explicitly listed in the input file are left at the value they previously which will be the default value provided to and for each parameter all associated actions that may previously have been set by or if an associated action throws an exception</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler__0_8txt_source.html#l00241">parameter_handler_0.txt:241</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga7bcc5fa85afdb96d90416e7bf182edd0"><div class="ttname"><a href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">TrilinosWrappers::PreconditionAMG::AdditionalData::smoother_sweeps</a></div><div class="ttdeci">unsigned int smoother_sweeps</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01568">trilinos_precondition.h:1568</a></div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00266">dof_handler.h:266</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a></div><div class="ttdeci">@ none</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00216">dof_tools.h:216</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga8bb24e061826fbdfb49aeb24f80e02fd"><div class="ttname"><a href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">TrilinosWrappers::PreconditionAMG::AdditionalData::higher_order_elements</a></div><div class="ttdeci">bool higher_order_elements</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01523">trilinos_precondition.h:1523</a></div></div>
<div class="ttc" id="aclassQIterated_html"><div class="ttname"><a href="classQIterated.html">QIterated</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2quadrature_8h_source.html#l00380">quadrature.h:380</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a></div><div class="ttdeci">@ component_is_part_of_vector</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00062">data_component_interpretation.h:62</a></div></div>
<div class="ttc" id="asolver__cg__0_8txt_html_a557c71e94a2542d697ca3426b8843cd4"><div class="ttname"><a href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">sqrt</a></div><div class="ttdeci">*This class implements the preconditioned Conjugate but is used in many other tutorial programs as well Like all other solver it can work on any kind of vector and matrix as long as they satisfy certain and defaults to *[2.x.2] **This version of CG is taken from D Braess s book Finite Elements It requires a symmetric the projected matrix[2.x.4] is tri diagonal Since the projection is the eigenvalues of[2.x.5] approximate those of the original preconditioned matrix[2.x.6] In after[2.x.7] where[2.x.8] is the dimension of the original the eigenvalues of both matrices are equal even for small numbers of iteration the condition number of[2.x.9] is a good estimate for the one of *[2.x.10] After[2.x.11] steps the matrix T_m can be written in terms of the coefficients[2.x.12] and[2.x.13] as the tri diagonal matrix with diagonal elements&lt; tt &gt;&lt; tt &gt; alpha_1 beta_0&lt; tt &gt;&lt; tt &gt; sqrt(beta_{m-2&lt;/tt &gt;)/alpha_</div><div class="ttdef"><b>Definition:</b> <a href="solver__cg__0_8txt_source.html#l00011">solver_cg_0.txt:11</a></div></div>
<div class="ttc" id="aclassTable_html"><div class="ttname"><a href="classTable.html">Table</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00033">array_view.h:33</a></div></div>
<div class="ttc" id="abase_2symmetric__tensor_8h_html_ab14ac27fc9ab74d4de531698b492d8de"><div class="ttname"><a href="base_2symmetric__tensor_8h.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a></div><div class="ttdeci">constexpr ProductType&lt; Number, OtherNumber &gt;::type scalar_product(const SymmetricTensor&lt; 2, dim, Number &gt; &amp;t1, const SymmetricTensor&lt; 2, dim, OtherNumber &gt; &amp;t2)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l03792">symmetric_tensor.h:3792</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00116">fe_update_flags.h:116</a></div></div>
<div class="ttc" id="aclassSubscriptor_html"><div class="ttname"><a href="classSubscriptor.html">Subscriptor</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2subscriptor_8h_source.html#l00060">subscriptor.h:60</a></div></div>
<div class="ttc" id="apolynomials__abf__0_8txt_html_a7a716deb19e461cf8ba2a26e01c6a908"><div class="ttname"><a href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a></div><div class="ttdeci">*This class implements the[1.x.0] vector valued Arnold Boffi Falk polynomials as described in the article by Arnold Boffi SIAM J Numer Anal pp **The ABF polynomials are constructed such that the divergence is in the tensor product polynomial space[1.x.1] the polynomial order of each component must be two orders higher in the corresponding yielding the polynomial spaces[1.x.2] and[1.x.3] in resp ******Constructor Creates all basis functions for Raviart Thomas polynomials of given degree[2.x.1] k</div><div class="ttdef"><b>Definition:</b> <a href="polynomials__abf__0_8txt_source.html#l00013">polynomials_abf_0.txt:13</a></div></div>
<div class="ttc" id="anumerics_2vector__tools_8h_html"><div class="ttname"><a href="numerics_2vector__tools_8h.html">vector_tools.h</a></div></div>
<div class="ttc" id="aclassVector_html_ac4a4dbef7dd65ef8ad35ae56b57d7c05"><div class="ttname"><a href="classVector.html#ac4a4dbef7dd65ef8ad35ae56b57d7c05">Vector::reinit</a></div><div class="ttdeci">virtual void reinit(const size_type N, const bool omit_zeroing_entries=false)</div></div>
<div class="ttc" id="anumerical__algorithms__0_8txt_html_a852a1e245dd2de4943eeb66beeaf65b1"><div class="ttname"><a href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">vector</a></div><div class="ttdeci">****This module groups a diverse set of classes that generally implement some sort of numerical algorithm on top all the basic and finite element classes in the library They are generally unconnected to each other *Some of the like KellyErrorEstimator and act on solutions already and compute derived quantities in the first two or help transferring a set of vectors from one mesh to another *The namespaces and VectorTools provide an assortment of such as creating a Laplace projecting or interpolating a function onto the present finite element etc The difference to the functions in the DoFTools and FETools functions is that they work on the DoFTools functions only act on a given DoFHandler object without reference to a data vector</div><div class="ttdef"><b>Definition:</b> <a href="numerical__algorithms__0_8txt_source.html#l00008">numerical_algorithms_0.txt:8</a></div></div>
<div class="ttc" id="abase_2index__set_8h_html"><div class="ttname"><a href="base_2index__set_8h.html">index_set.h</a></div></div>
<div class="ttc" id="anumerics_2solution__transfer_8h_html"><div class="ttname"><a href="numerics_2solution__transfer_8h.html">solution_transfer.h</a></div></div>
<div class="ttc" id="abase_2logstream_8h_html"><div class="ttname"><a href="base_2logstream_8h.html">logstream.h</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a></div><div class="ttdeci">@ always</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00221">dof_tools.h:221</a></div></div>
<div class="ttc" id="alac_2trilinos__precondition_8h_html"><div class="ttname"><a href="lac_2trilinos__precondition_8h.html">trilinos_precondition.h</a></div></div>
<div class="ttc" id="aclassKellyErrorEstimator_html_aa0917e696d4f8ddb983223a68c512357"><div class="ttname"><a href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a></div><div class="ttdeci">static void estimate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim - 1 &gt; &amp;quadrature, const std::map&lt; types::boundary_id, const Function&lt; spacedim, typename InputVector::value_type &gt; * &gt; &amp;neumann_bc, const InputVector &amp;solution, Vector&lt; float &gt; &amp;error, const ComponentMask &amp;component_mask=ComponentMask(), const Function&lt; spacedim &gt; *coefficients=nullptr, const unsigned int n_threads=numbers::invalid_unsigned_int, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id, const types::material_id material_id=numbers::invalid_material_id, const Strategy strategy=cell_diameter_over_24)</div></div>
<div class="ttc" id="aclassDataOutInterface_html_acad99726038e4fca7f605fdffb3317e4"><div class="ttname"><a href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">DataOutInterface::write_vtk</a></div><div class="ttdeci">void write_vtk(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07221">data_out_base.cc:7221</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Vector_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00140">fe_values_extractors.h:140</a></div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
<div class="ttc" id="alac_2trilinos__vector_8h_html"><div class="ttname"><a href="lac_2trilinos__vector_8h.html">trilinos_vector.h</a></div></div>
<div class="ttc" id="amg__transfer__0_8txt_html_a6b401cd9c6154fc787311f58ab910002"><div class="ttname"><a href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div><div class="ttdeci">MGTransferBase is defined in mg_base h ***Implementation of transfer between the global vectors and the multigrid levels for use in the derived class MGTransferPrebuilt and other classes ***Reset the object to the state it had right after the default constructor **Transfer from a vector on the global grid to vectors defined on each of the levels separately for the active degrees of freedom In for a globally refined mesh only the finest level in[2.x.0] is filled as a plain copy of[2.x.1] All the other level objects are left untouched **Transfer from multi level vector to normal vector Copies data from active portions of an MGVector into the respective positions of a&lt; tt &gt; Vector&lt; number &gt;&lt;/tt &gt; In order to keep the result constrained degrees of freedom are set to zero **Add a multi level vector to a normal vector Works as the previous but probably not for continuous elements **If this object operates on BlockVector we need to describe how the individual vector components are mapped to the blocks of a vector For for a Stokes we have dim vector components for velocity and pressure</div><div class="ttdef"><b>Definition:</b> <a href="mg__transfer__0_8txt_source.html#l00017">mg_transfer_0.txt:17</a></div></div>
<div class="ttc" id="avector__tools__point__value__0_8txt_html_ac7a5c2ceb5c739d5b51cc7e0eee8100a"><div class="ttname"><a href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a></div><div class="ttdeci">*Assembling of right hand sides **Create a right hand side vector for a point source at point[2.x.1] In other it creates a vector[2.x.2] so that[2.x.3] where[2.x.4] are the shape functions described by[2.x.5] and[2.x.6] is the point at which the delta function is located Prior content of the given[2.x.7] vector is deleted This function is for the case of a scalar finite element This function is typically used in one of these two with different values for right hand sides or and then evaluate the solution at the same point every time You could do this by calling[2.x.8] after each solve</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__point__value__0_8txt_source.html#l00015">vector_tools_point_value_0.txt:15</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gae9a45f517af1401c50811a11083f9114"><div class="ttname"><a href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">StandardExceptions::ExcMessage</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcMessage(std::string arg1)</div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a></div><div class="ttdeci">@ component_is_scalar</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00055">data_component_interpretation.h:55</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_a796721b56b3a90e4e3973c7caae4c3d8"><div class="ttname"><a href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; count_dofs_per_fe_block(const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::vector&lt; unsigned int &gt; &amp;target_block=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01943">dof_tools.cc:1943</a></div></div>
<div class="ttc" id="aclassSolverGMRES_html"><div class="ttname"><a href="classSolverGMRES.html">SolverGMRES</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__gmres_8h_source.html#l00168">solver_gmres.h:168</a></div></div>
<div class="ttc" id="aclassTensor_html"><div class="ttname"><a href="classTensor.html">Tensor&lt; 1, dim &gt;</a></div></div>
<div class="ttc" id="aclassDataOut_html_a087f63e22f0614bca326dbdca288c646"><div class="ttname"><a href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01071">data_out.cc:1071</a></div></div>
<div class="ttc" id="aclassSolutionTransfer_html"><div class="ttname"><a href="classSolutionTransfer.html">SolutionTransfer</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2solution__transfer_8h_source.html#l00277">solution_transfer.h:277</a></div></div>
<div class="ttc" id="abase_2index__set_8h_html_ad28b2e725afda38ffdef1bf61d5cadd4"><div class="ttname"><a href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a></div><div class="ttdeci">IndexSet complete_index_set(const IndexSet::size_type N)</div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l01094">index_set.h:1094</a></div></div>
<div class="ttc" id="anamespaceDoFRenumbering_html_a52c1941406d1ce2937e29a46edf111f4"><div class="ttname"><a href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a></div><div class="ttdeci">void component_wise(DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const std::vector&lt; unsigned int &gt; &amp;target_component=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering_8cc_source.html#l00681">dof_renumbering.cc:681</a></div></div>
<div class="ttc" id="ageometry__info__0_8txt_html_a30a552b07accf65da90f851e25d14d1c"><div class="ttname"><a href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div><div class="ttdeci">3, where it offers following possibilities:a face(quad) being refined in x- or y-direction(in the face-intern coordinate system) separately,([2.x.79] or([2.x.80] which corresponds to([2.x.81]). Additionally, it offers the possibilities a face can have through repeated anisotropic refinement steps performed on one of the two neighboring cells. It might be possible for example, that a face(quad) is refined with[2.x.82] and afterwards the left child is again refined with[2.x.83], so that there are three active subfaces. Note, however, that only refinement cases are allowed such that each line on a face between two hexes has not more than one hanging node. Furthermore, it is not allowed that two neighboring hexes are refined such that one of the hexes refines the common face with[2.x.84] and the other hex refines that face with[2.x.85] . In fact,[2.x.86] takes care of this situation and ensures that each face of a refined cell is completely contained in a single face of neighboring cells. The following drawings explain the SubfacePossibilities and give the corresponding subface numbers:*[1.x.4] **[2.x.87] *[0.x.68] *Possible cases of faces being subdivided into subface. See documentation to the SubfacePossibilities&lt; 3 &gt; for more details on the subface possibilities. *[0.x.69] *A class that provides all possible cases a face(in the current space dimension[2.x.88] might be subdivided into subfaces. *[2.x.89] *[0.x.70] *Constructor. Take and store a value indicating a particular subface possibility in the list of possible situations specified in the base class. *[0.x.71] *Return the numeric value stored by this class. While the presence of this operator might seem dangerous, it is useful in cases where one would like to have code like&lt; code &gt;switch(subface_case)... case[2.x.90] ...&lt;/code &gt;, which can be written as&lt; code &gt;switch[2.x.91] Another application is to use an object of the current type as an index into an array dim</div><div class="ttdef"><b>Definition:</b> <a href="geometry__info__0_8txt_source.html#l00202">geometry_info_0.txt:202</a></div></div>
<div class="ttc" id="anamespaceStep31_1_1EquationData_html_a0932f2f724c5bb6bae12cd93de21fdba"><div class="ttname"><a href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">Step31::EquationData::kappa</a></div><div class="ttdeci">constexpr double kappa</div><div class="ttdef"><b>Definition:</b> <a href="step-31_8cc_source.html#l00073">step-31.cc:73</a></div></div>
<div class="ttc" id="aclassDynamicSparsityPattern_html"><div class="ttname"><a href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2dynamic__sparsity__pattern_8h_source.html#l00340">dynamic_sparsity_pattern.h:340</a></div></div>
<div class="ttc" id="astructSolverGMRES_1_1AdditionalData_html"><div class="ttname"><a href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES::AdditionalData</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__gmres_8h_source.html#l00175">solver_gmres.h:175</a></div></div>
<div class="ttc" id="anamespaceStep20_1_1PrescribedSolution_html_a6142e18d25af27882714d1787af4ee59"><div class="ttname"><a href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">Step20::PrescribedSolution::alpha</a></div><div class="ttdeci">constexpr double alpha</div><div class="ttdef"><b>Definition:</b> <a href="step-20_8cc_source.html#l00087">step-20.cc:87</a></div></div>
<div class="ttc" id="adofs_2dof__tools_8h_html"><div class="ttname"><a href="dofs_2dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="agrid_2grid__refinement_8h_html"><div class="ttname"><a href="grid_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="afe_2fe__system_8h_html"><div class="ttname"><a href="fe_2fe__system_8h.html">fe_system.h</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f"><div class="ttname"><a href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">TrilinosWrappers::PreconditionAMG::AdditionalData::aggregation_threshold</a></div><div class="ttdeci">double aggregation_threshold</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01549">trilinos_precondition.h:1549</a></div></div>
<div class="ttc" id="anamespaceGridRefinement_html_ae90dc87c4db158b8d01f6d564ac614e5"><div class="ttname"><a href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a></div><div class="ttdeci">void refine_and_coarsen_fixed_fraction(Triangulation&lt; dim, spacedim &gt; &amp;tria, const Vector&lt; Number &gt; &amp;criteria, const double top_fraction, const double bottom_fraction, const unsigned int max_n_cells=std::numeric_limits&lt; unsigned int &gt;::max(), const VectorTools::NormType norm_type=VectorTools::NormType::L1_norm)</div><div class="ttdef"><b>Definition:</b> <a href="grid_2grid__refinement_8cc_source.html#l00390">grid_refinement.cc:390</a></div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00039">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="abase_2quadrature__lib_8h_html"><div class="ttname"><a href="base_2quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a96ecfde131843f52ee49d0e0c1180134"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div><div class="ttdeci">computing derivatives of these terms is impractical in most applications in impossible to get right Higher derivatives are even more impossible to do without computer aid Automatic or symbolic differentiation is a way out of and gets compile time</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00012">automatic_and_symbolic_differentiation_0.txt:12</a></div></div>
<div class="ttc" id="aclassSmartPointer_html"><div class="ttname"><a href="classSmartPointer.html">SmartPointer</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2smartpointer_8h_source.html#l00067">smartpointer.h:67</a></div></div>
<div class="ttc" id="aclassPoint_html_a3df8e6ab311dab9337c8d7b039c7b815"><div class="ttname"><a href="classPoint.html#a3df8e6ab311dab9337c8d7b039c7b815">Point::distance</a></div><div class="ttdeci">numbers::NumberTraits&lt; Number &gt;::real_type distance(const Point&lt; dim, Number &gt; &amp;p) const</div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_a8f384576a64c89a6fa8352847523e340"><div class="ttname"><a href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for n_q_points</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00537">fe_evaluation_0.txt:537</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="anamespaceGridTools_html_acd5ccc543d561cfb086b571d1f7818cb"><div class="ttname"><a href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a></div><div class="ttdeci">double diameter(const Triangulation&lt; dim, spacedim &gt; &amp;tria)</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools_8cc_source.html#l00081">grid_tools.cc:81</a></div></div>
<div class="ttc" id="aclassQTrapezoid_html"><div class="ttname"><a href="classQTrapezoid.html">QTrapezoid</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00126">quadrature_lib.h:126</a></div></div>
<div class="ttc" id="adofs_2dof__renumbering_8h_html"><div class="ttname"><a href="dofs_2dof__renumbering_8h.html">dof_renumbering.h</a></div></div>
<div class="ttc" id="amapping__q__internal__0_8txt_html_a55ac427dfa58d3b640a4293648e4b6d8"><div class="ttname"><a href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a></div><div class="ttdeci">namespace to implement methods specific to MappingQ1 in particular an explicit formula for the transformation from the real to the unit cell in D *There are two ways to compute xi from eta</div><div class="ttdef"><b>Definition:</b> <a href="mapping__q__internal__0_8txt_source.html#l00002">mapping_q_internal_0.txt:2</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00124">fe_update_flags.h:124</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01581">exceptions.h:1581</a></div></div>
<div class="ttc" id="anamespaceGridTools_html_a47c293eff2ec7ce4b90ba08b35d1f2e2"><div class="ttname"><a href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a></div><div class="ttdeci">double minimal_cell_diameter(const Triangulation&lt; dim, spacedim &gt; &amp;triangulation, const Mapping&lt; dim, spacedim &gt; &amp;mapping=(ReferenceCells::get_hypercube&lt; dim &gt;() .template get_default_linear_mapping&lt; dim, spacedim &gt;()))</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools_8cc_source.html#l04309">grid_tools.cc:4309</a></div></div>
<div class="ttc" id="ablock__sparse__matrix__ez__0_8txt_html_af734f4df74ac4822dd99a6cca7203600"><div class="ttname"><a href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a></div><div class="ttdeci">Matrix1 *[2.x.1] **A block matrix consisting of blocks of type SparseMatrixEZ *Like the other Block this matrix can be used like a when it comes to access to entries there are functions for the multiplication with BlockVector and access to the individual blocks the block s must be empty **Copy this operation is only allowed if the actual value to be assigned is zero This in order to be able to relay global indices into the matrix to indices into the subobjects Youmust *call this function each time after you have changed the size of the sub objects **Access the block with the given coordinates **Access the block with the given coordinates Version for constant objects **Return the number of blocks in a column **Return the number of blocks in a row **Return whether the object is empty It is empty if no memory is which is the same as that both dimensions are zero This function is just the concatenation of the respective call to all sub matrices **Return number of rows of this which equals the dimension of the which equals the dimension of the domain space It is the sum of the number of columns over the sub matrix blocks of this matrix Recall that the matrix is of size m() times n(). *[0.x.18] *Set the element&lt; tt &gt;(i</div></div>
<div class="ttc" id="alac_2full__matrix_8h_html"><div class="ttname"><a href="lac_2full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="alac_2solver__cg_8h_html"><div class="ttname"><a href="lac_2solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_acea0cbcd68e52ce8113d1134b87de403"><div class="ttname"><a href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a></div><div class="ttdeci">void hyper_cube(Triangulation&lt; dim, spacedim &gt; &amp;tria, const double left=0., const double right=1., const bool colorize=false)</div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_ac26de0c059200523177bb1d92cc25d00"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a></div><div class="ttdeci">unsigned int n_mpi_processes(const MPI_Comm &amp;mpi_communicator)</div><div class="ttdef"><b>Definition:</b> <a href="mpi_8cc_source.html#l00117">mpi.cc:117</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1BlockSparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__block__sparse__matrix_8h_source.html#l00068">trilinos_block_sparse_matrix.h:68</a></div></div>
<div class="ttc" id="anamespacenumbers_html_a8ae36952c7e0cc778b47b5371b3aeff1"><div class="ttname"><a href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a></div><div class="ttdeci">static const unsigned int invalid_unsigned_int</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00179">types.h:179</a></div></div>
<div class="ttc" id="astep-69_8cc_html_a66a64d07b4db87c87b639bdcf7b18c82"><div class="ttname"><a href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; local_dof_indices</div><div class="ttdef"><b>Definition:</b> <a href="step-69_8cc_source.html#l00534">step-69.cc:534</a></div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point&lt; dim &gt;</a></div></div>
<div class="ttc" id="achunk__sparse__matrix__0_8txt_html_a59317914f0b63e3c2c7c6bd150b8ba3e"><div class="ttname"><a href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a></div><div class="ttdeci">0&lt;/tt &gt;, which sets all elements of the matrix to zero, but keep the sparsity pattern previously used. *[0.x.66] *Reinitialize the sparse matrix with the given sparsity pattern. The latter tells the matrix how many nonzero elements there need to be reserved. Regarding memory allocation, the same applies as said above. You have to make sure that the lifetime of the sparsity structure is at least as long as that of this matrix or as long as reinit(const ChunkSparsityPattern &amp;) is not called with a new sparsity structure. The elements of the matrix are set to zero by this function. *[0.x.67] *Release all memory and return to a state just like after having called the default constructor. It also forgets the sparsity pattern it was previously tied to. *[0.x.68] *[2.x.18] Information on the matrix *[0.x.69] *Return whether the object is empty. It is empty if either both dimensions are zero or no ChunkSparsityPattern is associated. *[0.x.70] *Return the dimension of the codomain(or range) space. Note that the matrix is of dimension[2.x.19] . *[0.x.71] *Return the dimension of the domain space. Note that the matrix is of dimension[2.x.20] . *[0.x.72] *Return the number of nonzero elements of this matrix. Actually, it returns the number of entries in the sparsity pattern matrix</div><div class="ttdef"><b>Definition:</b> <a href="chunk__sparse__matrix__0_8txt_source.html#l00156">chunk_sparse_matrix_0.txt:156</a></div></div>
<div class="ttc" id="alac_2trilinos__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2trilinos__sparse__matrix_8h.html">trilinos_sparse_matrix.h</a></div></div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aauto__derivative__function__0_8txt_html_a870ed0ddfded063c8c8570352ef8c122"><div class="ttname"><a href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a></div><div class="ttdeci">*This class automatically computes the gradient of a function by employing numerical difference quotients This only if the user function does not provide the gradient function himself *The following example of an user defined function overloads and implements only the where the latter function employs numerical difference quotients *****If the user overloads and implements also the gradient of the users gradient function is called that the usage of the also applies to the see e g vector_value()</div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">VectorTools::EvaluationFlags::min</a></div><div class="ttdeci">@ min</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00062">vector_tools_evaluate.h:62</a></div></div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2function_8h_source.html#l00140">function.h:140</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ac639e1db0b03fc797eca55e266afa976"><div class="ttname"><a href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per cell</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="anamespaceLinearAlgebraDealII_html_a571e5cecdb8196589b34055adb3d0293"><div class="ttname"><a href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">LinearAlgebraDealII::SparseMatrix</a></div><div class="ttdeci">SparseMatrix&lt; double &gt; SparseMatrix</div><div class="ttdef"><b>Definition:</b> <a href="lac_2generic__linear__algebra_8h_source.html#l00058">generic_linear_algebra.h:58</a></div></div>
<div class="ttc" id="aclassSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__control_8h_source.html#l00052">solver_control.h:52</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_ac00ea19562c135512a6ff275a3cf0d8f"><div class="ttname"><a href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has this class generates all dim dimensional polynomials of the where the sum and[1.x.8] is less than or equal *[1.x.9] The i e for each dim dimensional polynomial in the polynomial space it gives the indices j</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00004">polynomial_space_0.txt:4</a></div></div>
<div class="ttc" id="abase_2vectorization_8h_html_aafbdfdd72b6cfe4eae5fa7a16385582f"><div class="ttname"><a href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; abs(const ::VectorizedArray&lt; Number, width &gt; &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05750">vectorization.h:5750</a></div></div>
<div class="ttc" id="astructTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData_html"><div class="ttname"><a href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01401">trilinos_precondition.h:1401</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">VectorTools::EvaluationFlags::max</a></div><div class="ttdeci">@ max</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00056">vector_tools_evaluate.h:56</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut&lt; dim &gt;</a></div></div>
<div class="ttc" id="afunctions__0_8txt_html_af9f808a82e8c618e2e7a19dd08a9eae3"><div class="ttname"><a href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a></div><div class="ttdeci">****Functions are used in various places in deal for example to describe boundary coefficients in forcing or exact solutions Since closed form expressions for equations are often hard to pass along as function deal II uses the Function base class to describe these objects Essentially the interface of this base class requires derived classes to implement the ability to return the value of a function at one or a list of particular locations and function objects can then be used by algorithms like[2.x.1][2.x.2] and other functions *Some functions are needed again and and are therefore already provided in deal II This includes a function with a constant value</div><div class="ttdef"><b>Definition:</b> <a href="functions__0_8txt_source.html#l00007">functions_0.txt:7</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="avector__valued__0_8txt_html_aaee87206b92ccb284e9c77fa5d847637"><div class="ttname"><a href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a></div><div class="ttdeci">each of these vectors has[2.x.174] elements containing the values of the[2.x.175] velocities and the one pressure at a quadrature point *We can use these values to then construct other things like residuals the construct is a bit awkward we have a[2.x.176] which always looks strange It is also inefficient because it implies dynamic memory allocation for the outer vector as well as for all the inner vectors maybe we are only interested in the velocities</div><div class="ttdef"><b>Definition:</b> <a href="vector__valued__0_8txt_source.html#l00155">vector_valued_0.txt:155</a></div></div>
<div class="ttc" id="aclassLinearOperator_html_a030d8712cd4dbd814efbadca59c19bb3"><div class="ttname"><a href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">LinearOperator::vmult</a></div><div class="ttdeci">std::function&lt; void(Range &amp;v, const Domain &amp;u)&gt; vmult</div><div class="ttdef"><b>Definition:</b> <a href="lac_2linear__operator_8h_source.html#l00289">linear_operator.h:289</a></div></div>
<div class="ttc" id="aclassFESystem_html"><div class="ttname"><a href="classFESystem.html">FESystem&lt; dim &gt;</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gafc0ca7ad85b3ebd64e8e51689ac85caf"><div class="ttname"><a href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a></div><div class="ttdeci">#define AssertThrow(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01699">exceptions.h:1699</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga599811b30e0ab031d3b2c7c3672ca92f"><div class="ttname"><a href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">TrilinosWrappers::PreconditionAMG::AdditionalData::constant_modes</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; bool &gt; &gt; constant_modes</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01555">trilinos_precondition.h:1555</a></div></div>
<div class="ttc" id="asparse__vanka__0_8txt_html_a96771f1712564cc2701caa2fdfb4965d"><div class="ttname"><a href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">vector&lt; bool &gt;</a></div><div class="ttdeci">this elimination is done by the modification of the right hand and in the end these degrees of freedom do not occur in the matrix and solution vector any more at all *This system is solved and the values are updated into the destination vector the matrices are built up such that the degree of freedom associated with the Lagrange multiplier is the first one usually the upper left entry in the matrix is zero It is not clear to so it must persist longer than the Vanka object The same is true for the matrix The matrix[2.x.11] which is passed here may or may not be the same matrix for which this object shall act as preconditioner In it is conceivable that the preconditioner is build up for one matrix but is used for subsequent steps in a nonlinear process as where the matrix changes in each step slightly **Destructor Delete all allocated matrices **Parameters for SparseVanka **Constructor For the parameters see below **Constructor For the parameters see below[2.x.12] The use of this constructor is deprecated **the second and third parameters are ignored **Indices of those degrees of freedom that we shall work on **If the default constructor is used then this function needs to be called before an object of this class is used as preconditioner For more detail about possible parameters see the class documentation and the documentation of the[2.x.13] class After this function is called the preconditioner is ready to be only values for allowed indices are written to[2.x.27] so the application of this function only does what is announced in the general documentation if the given mask sets all values to zero The reason for providing the mask anyway is that in derived classes we may want to apply the preconditioner to parts of the matrix in order to parallelize the application it is important to only write to some slices of[2.x.28] in order to eliminate the dependencies of threads of each other If a null pointer is passed instead of a pointer to then it is assumed that we shall work on all degrees of freedom This is then equivalent to calling the function with a&lt; tt &gt; vector&lt; bool &gt;(n_dofs, true)&lt;/tt &gt;. The[2.x.30] of this class of course calls this function with a null pointer *[0.x.17] *Determine an estimate for the memory consumption(in bytes) of this object. *[0.x.18] *Pointer to the matrix. *[0.x.19] *Indices of those degrees of freedom that we shall work on. *[0.x.20] *Array of inverse matrices</div></div>
<div class="ttc" id="alac_2trilinos__parallel__block__vector_8h_html"><div class="ttname"><a href="lac_2trilinos__parallel__block__vector_8h.html">trilinos_parallel_block_vector.h</a></div></div>
<div class="ttc" id="aclassIndexSet_html_ad28b2e725afda38ffdef1bf61d5cadd4"><div class="ttname"><a href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">IndexSet::complete_index_set</a></div><div class="ttdeci">IndexSet complete_index_set(const IndexSet::size_type N)</div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l01094">index_set.h:1094</a></div></div>
<div class="ttc" id="anamespaceStep31_html"><div class="ttname"><a href="namespaceStep31.html">Step31</a></div><div class="ttdef"><b>Definition:</b> <a href="step-31_8cc_source.html#l00063">step-31.cc:63</a></div></div>
<div class="ttc" id="afe_2fe__values__0_8txt_html_a15ff2e0c168966d6ae13c4faabcec165"><div class="ttname"><a href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a></div><div class="ttdeci">we have to work a bit harder to compute this information **Default constructor Creates an invalid object **Constructor for an object that represents a single scalar component of a FEValuesBase for the shape function and quadrature point selected by the arguments[2.x.27] shape_function Number of the shape function to be evaluated Note that this number runs from zero to dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__0_8txt_source.html#l00073">fe_values_0.txt:73</a></div></div>
<div class="ttc" id="aparsed__convergence__table__0_8txt_html_a8a90f5ba57a42a3fd4c067e00f8b8aea"><div class="ttname"><a href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a></div><div class="ttdeci">****This class simplifies the construction of convergence tables reading the options for the generation of the table from a parameter file It provides a series of methods that can be used to compute the error given a reference exact solution or the difference between two numerical solutions or any other custom computation of the error given via[2.x.1] objects *An example usage of this class is given by ****The above code constructs a ParsedConvergenceTable that works for scalar and will produce an error table with and Linfty_norm norms of the error *Whenever a call to the methods the instance of this class inspects its parameters computes all norms specified by the parameter given at construction time possibly modified via a parameter file computes all extra column entries specified using the method and writes one row of the convergence table *Once you have finished with the a call to and to the the same code can be used to estimate the errors of mixed or multi physics e and one component for the pressure field p</div><div class="ttdef"><b>Definition:</b> <a href="parsed__convergence__table__0_8txt_source.html#l00020">parsed_convergence_table_0.txt:20</a></div></div>
<div class="ttc" id="agrid_2grid__generator_8h_html"><div class="ttname"><a href="grid_2grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52f"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a></div><div class="ttdeci">UpdateFlags</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00057">fe_update_flags.h:57</a></div></div>
<div class="ttc" id="atable__0_8txt_html_aa889bb34debce4db8c9ace2f875bdf0d"><div class="ttname"><a href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a></div><div class="ttdeci">tables that store three or more dimensional then there is nothing you can do about the size of these if your program is parallelized via then a typical first implementation would create a table object on every process and fill it on every MPI process by reading the data from a file This is inefficient from two the data stored on every process is the and while every process needs to be able to read from a it is not necessary that every process stores its own either by re creating a copy of the table in the other processes memory space if by creating copies in shared memory once for all processes located on each of the machines used by the MPI job ******Integer type used to count the number of elements in this container **Default constructor Set all dimensions to zero **Constructor Initialize the array with the given dimensions in each index component **Constructor Initialize the array with the given dimensions in each index component</div><div class="ttdef"><b>Definition:</b> <a href="table__0_8txt_source.html#l00083">table_0.txt:83</a></div></div>
<div class="ttc" id="aclassUtilities_1_1MPI_1_1MPI__InitFinalize_html"><div class="ttname"><a href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2mpi_8h_source.html#l00836">mpi.h:836</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a02f5aa616d7b0799c538fe77d6c6c795"><div class="ttname"><a href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a></div><div class="ttdeci">i e</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00028">coding_conventions_0.txt:28</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a26d68db31ed452971a1cc4fc1c5c9afa"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a></div><div class="ttdeci">and situations where one is given a parameter dependent problem[2.x.4] and wants to form derivatives with regards to the for example to optimize an output functional with regards or for a sensitivity analysis with regards to[2.x.7] One should think of[2.x.8] as design the width or shape of a the stiffness coefficients of a material chosen to build an the power sent to a the chemical composition of the gases sent to a burner In all of these one should think of[2.x.9] and[2.x.10] as[1.x.0] and cumbersome to differentiate **at least when doing it by hand A relatively simple case of a nonlinear problem that already highlights the tedium of computing derivatives by hand is shown in[2.x.11] in one for think about problems such as chemically reactive flows where the fluid equations have coefficients such as the density and viscosity that depend strongly and nonlinearly on the chemical temperature</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00012">automatic_and_symbolic_differentiation_0.txt:12</a></div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
