<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_32.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-32 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-32 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_31.html">step-31</a>, <a class="el" href="step_55.html">step-55</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Usingtherightpressure"> Using the "right" pressure </a>
        <li><a href="#Thescalingofdiscretizedequations"> The scaling of discretized equations </a>
        <li><a href="#ChangestotheStokespreconditionerandsolver"> Changes to the Stokes preconditioner and solver </a>
        <li><a href="#Changestotheartificialviscositystabilization"> Changes to the artificial viscosity stabilization </a>
        <li><a href="#LocallyconservativeStokesdiscretization"> Locally conservative Stokes discretization </a>
        <li><a href="#Higherordermappingsforcurvedboundaries"> Higher order mappings for curved boundaries </a>
        <li><a href="#Parallelizationonclusters"> Parallelization on clusters </a>
        <li><a href="#Parallelizationwithinindividualnodesofacluster"> Parallelization within individual nodes of a cluster </a>
        <li><a href="#Thetestcase"> The testcase </a>
        <li><a href="#Implementationdetails"> Implementation details </a>
        <li><a href="#Outlook"> Outlook </a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#Equationdata">Equation data</a>
        <li><a href="#PreconditioningtheStokessystem">Preconditioning the Stokes system</a>
        <li><a href="#Definitionofassemblydatastructures">Definition of assembly data structures</a>
        <li><a href="#ThecodeBoussinesqFlowProblemcodeclasstemplate">The <code>BoussinesqFlowProblem</code> class template</a>
        <li><a href="#BoussinesqFlowProblemclassimplementation">BoussinesqFlowProblem class implementation</a>
      <ul>
        <li><a href="#BoussinesqFlowProblemParameters">BoussinesqFlowProblem::Parameters</a>
        <li><a href="#BoussinesqFlowProblemBoussinesqFlowProblem">BoussinesqFlowProblem::BoussinesqFlowProblem</a>
        <li><a href="#TheBoussinesqFlowProblemhelperfunctions">The BoussinesqFlowProblem helper functions</a>
      <ul>
        <li><a href="#BoussinesqFlowProblemget_maximal_velocity">BoussinesqFlowProblem::get_maximal_velocity</a>
        <li><a href="#BoussinesqFlowProblemget_cfl_number">BoussinesqFlowProblem::get_cfl_number</a>
        <li><a href="#BoussinesqFlowProblemget_entropy_variation">BoussinesqFlowProblem::get_entropy_variation</a>
        <li><a href="#BoussinesqFlowProblemget_extrapolated_temperature_range">BoussinesqFlowProblem::get_extrapolated_temperature_range</a>
        <li><a href="#BoussinesqFlowProblemcompute_viscosity">BoussinesqFlowProblem::compute_viscosity</a>
      </ul>
        <li><a href="#TheBoussinesqFlowProblemsetupfunctions">The BoussinesqFlowProblem setup functions</a>
        <li><a href="#TheBoussinesqFlowProblemassemblyfunctions">The BoussinesqFlowProblem assembly functions</a>
      <ul>
        <li><a href="#Stokespreconditionerassembly">Stokes preconditioner assembly</a>
        <li><a href="#Stokessystemassembly">Stokes system assembly</a>
        <li><a href="#Temperaturematrixassembly">Temperature matrix assembly</a>
        <li><a href="#Temperaturerighthandsideassembly">Temperature right hand side assembly</a>
      </ul>
        <li><a href="#BoussinesqFlowProblemsolve">BoussinesqFlowProblem::solve</a>
        <li><a href="#BoussinesqFlowProblemoutput_results">BoussinesqFlowProblem::output_results</a>
        <li><a href="#BoussinesqFlowProblemrefine_mesh">BoussinesqFlowProblem::refine_mesh</a>
        <li><a href="#BoussinesqFlowProblemrun">BoussinesqFlowProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Comparisonofresultswithstep31">Comparison of results with step-31</a>
        <li><a href="#Resultsfora2dcircularshelltestcase">Results for a 2d circular shell testcase</a>
        <li><a href="#Resultsfora3dsphericalshelltestcase">Results for a 3d spherical shell testcase</a>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
</p>
<p><em>This program was contributed by Martin Kronbichler, Wolfgang Bangerth, and Timo Heister.</em></p>
<p><em>This material is based upon work partly supported by the National Science Foundation under Award No. EAR-0426271 and The California Institute of Technology; and in a continuation by the National Science Foundation under Award No. EAR-0949446 and The University of California &ndash; Davis. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation, The California Institute of Technology, or of The University of California &ndash; Davis.</em></p>
<p><em>The work discussed here is also presented in the following publication: <b> M. Kronbichler, T. Heister, W. Bangerth: <em>High Accuracy Mantle Convection Simulation through Modern Numerical Methods</em>, Geophysical Journal International, 2012, 191, 12-29. <a href="http://dx.doi.org/10.1111/j.1365-246X.2012.05609.x">[DOI]</a> </b></em></p>
<p><em>The continuation of development of this program has led to the much larger open source code <em>ASPECT</em> (see <a href="http://aspect.geodynamics.org/">http://aspect.geodynamics.org/</a>) which is much more flexible in solving many kinds of related problems. </em></p>
<p><a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>This program does pretty much exactly what <a class="el" href="step_31.html">step-31</a> already does: it solves the Boussinesq equations that describe the motion of a fluid whose temperature is not in equilibrium. As such, all the equations we have described in <a class="el" href="step_31.html">step-31</a> still hold: we solve the same general partial differential equation (with only minor modifications to adjust for more realism in the problem setting), using the same finite element scheme, the same time stepping algorithm, and more or less the same stabilization method for the temperature advection-diffusion equation. As a consequence, you may first want to understand that program &mdash; and its implementation &mdash; before you work on the current one.</p>
<p>The difference between <a class="el" href="step_31.html">step-31</a> and the current program is that here we want to do things in parallel, using both the availability of many machines in a cluster (with parallelization based on MPI) as well as many processor cores within a single machine (with parallelization based on threads). This program's main job is therefore to introduce the changes that are necessary to utilize the availability of these parallel compute resources. In this regard, it builds on the <a class="el" href="step_40.html">step-40</a> program that first introduces the necessary classes for much of the parallel functionality, and on <a class="el" href="step_55.html">step-55</a> that shows how this is done for a vector-valued problem.</p>
<p>In addition to these changes, we also use a slightly different preconditioner, and we will have to make a number of changes that have to do with the fact that we want to solve a <em>realistic</em> problem here, not a model problem. The latter, in particular, will require that we think about scaling issues as well as what all those parameters and coefficients in the equations under consideration actually mean. We will discuss first the issues that affect changes in the mathematical formulation and solver structure, then how to parallelize things, and finally the actual testcase we will consider.</p>
<p><a class="anchor" id="Usingtherightpressure"></a></p><h3>Using the "right" pressure </h3>
<p>In <a class="el" href="step_31.html">step-31</a>, we used the following Stokes model for the velocity and pressure field: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; -\rho \; \beta \; T \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> The right hand side of the first equation appears a wee bit unmotivated. Here's how things should really be. We need the external forces that act on the fluid, which we assume are given by gravity only. In the current case, we assume that the fluid does expand slightly for the purposes of this gravity force, but not enough that we need to modify the incompressibility condition (the second equation). What this means is that for the purpose of the right hand side, we can assume that \(\rho=\rho(T)\). An assumption that may not be entirely justified is that we can assume that the changes of density as a function of temperature are small, leading to an expression of the form \(\rho(T) = \rho_{\text{ref}} [1-\beta(T-T_{\text{ref}})]\), i.e., the density equals \(\rho_{\text{ref}}\) at reference temperature and decreases linearly as the temperature increases (as the material expands). The force balance equation then looks properly written like this: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; \rho_{\text{ref}} [1-\beta(T-T_{\text{ref}})] \mathbf{g}. \end{eqnarray*}
</p>
<p> Now note that the gravity force results from a gravity potential as \(\mathbf g=-\nabla \varphi\), so that we can re-write this as follows: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; -\rho_{\text{ref}} \; \beta\; T\; \mathbf{g} -\rho_{\text{ref}} [1+\beta T_{\text{ref}}] \nabla\varphi. \end{eqnarray*}
</p>
<p> The second term on the right is time independent, and so we could introduce a new "dynamic" pressure \(p_{\text{dyn}}=p+\rho_{\text{ref}} [1+\beta T_{\text{ref}}] \varphi=p_{\text{total}}-p_{\text{static}}\) with which the Stokes equations would read: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p_{\text{dyn}} &amp;=&amp; -\rho_{\text{ref}} \; \beta \; T \; \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> This is exactly the form we used in <a class="el" href="step_31.html">step-31</a>, and it was appropriate to do so because all changes in the fluid flow are only driven by the dynamic pressure that results from temperature differences. (In other words: Any contribution to the right hand side that results from taking the gradient of a scalar field have no effect on the velocity field.)</p>
<p>On the other hand, we will here use the form of the Stokes equations that considers the total pressure instead: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; \rho(T)\; \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> There are several advantages to this:</p>
<ul>
<li>This way we can plot the pressure in our program in such a way that it actually shows the total pressure that includes the effects of temperature differences as well as the static pressure of the overlying rocks. Since the pressure does not appear any further in any of the other equations, whether to use one or the other is more a matter of taste than of correctness. The flow field is exactly the same, but we get a pressure that we can now compare with values that are given in geophysical books as those that hold at the bottom of the earth mantle, for example.</li>
<li>If we wanted to make the model even more realistic, we would have to take into account that many of the material parameters (e.g. the viscosity, the density, etc) not only depend on the temperature but also the <em>total</em> pressure.</li>
<li>The model above assumed a linear dependence \(\rho(T) = \rho_{\text{ref}} [1-\beta(T-T_{\text{ref}})]\) and assumed that \(\beta\) is small. In practice, this may not be so. In fact, realistic models are certainly not linear, and \(\beta\) may also not be small for at least part of the temperature range because the density's behavior is substantially dependent not only on thermal expansion but by phase changes.</li>
<li>A final reason to do this is discussed in the results section and concerns possible extensions to the model we use here. It has to do with the fact that the temperature equation (see below) we use here does not include a term that contains the pressure. It should, however: rock, like gas, heats up as you compress it. Consequently, material that rises up cools adiabatically, and cold material that sinks down heats adiabatically. We discuss this further below.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>There is, however, a downside to this procedure. In the earth, the dynamic pressure is several orders of magnitude smaller than the total pressure. If we use the equations above and solve all variables to, say, 4 digits of accuracy, then we may be able to get the velocity and the total pressure right, but we will have no accuracy at all if we compute the dynamic pressure by subtracting from the total pressure the static part \(p_\text{static}=\rho_{\text{ref}} [1+\beta T_{\text{ref}}] \varphi\). If, for example, the dynamic pressure is six orders of magnitude smaller than the static pressure, then we need to solve the overall pressure to at least seven digits of accuracy to get anything remotely accurate. That said, in practice this turns out not to be a limiting factor.</dd></dl>
<p><a class="anchor" id="Thescalingofdiscretizedequations"></a></p><h3>The scaling of discretized equations </h3>
<p>Remember that we want to solve the following set of equations: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; \rho(T) \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0, \\ \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma, \end{eqnarray*}
</p>
<p> augmented by appropriate boundary and initial conditions. As discussed in <a class="el" href="step_31.html">step-31</a>, we will solve this set of equations by solving for a Stokes problem first in each time step, and then moving the temperature equation forward by one time interval.</p>
<p>The problem under consideration in this current section is with the Stokes problem: if we discretize it as usual, we get a linear system </p><p class="formulaDsp">
\begin{eqnarray*} M \; X = \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{c} U \\ P \end{array}\right) = \left(\begin{array}{c} F_U \\ 0 \end{array}\right) = F \end{eqnarray*}
</p>
<p> which in this program we will solve with a FGMRES solver. This solver iterates until the residual of these linear equations is below a certain tolerance, i.e., until </p><p class="formulaDsp">
\[ \left\| \left(\begin{array}{c} F_U - A U^{(k)} - B P^{(k)} \\ B^T U^{(k)} \end{array}\right) \right\| &lt; \text{Tol}. \]
</p>
<p> This does not make any sense from the viewpoint of physical units: the quantities involved here have physical units so that the first part of the residual has units \(\frac{\text{Pa}}{\text{m}} \text{m}^{\text{dim}}\) (most easily established by considering the term \((\nabla \cdot \mathbf v, p)_{\Omega}\) and considering that the pressure has units \(\text{Pa}=\frac{\text{kg}}{\text{m}\;\text{s}^2}\) and the integration yields a factor of \(\text{m}^{\text{dim}}\)), whereas the second part of the residual has units \(\frac{\text{m}^{\text{dim}}}{\text{s}}\). Taking the norm of this residual vector would yield a quantity with units \(\text{m}^{\text{dim}-1} \sqrt{\left(\text{Pa}\right)^2 + \left(\frac{\text{m}}{\text{s}}\right)^2}\). This, quite obviously, does not make sense, and we should not be surprised that doing so is eventually going to come back hurting us.</p>
<p>So why is this an issue here, but not in <a class="el" href="step_31.html">step-31</a>? The reason back there is that everything was nicely balanced: velocities were on the order of one, the pressure likewise, the viscosity was one, and the domain had a diameter of \(\sqrt{2}\). As a result, while nonsensical, nothing bad happened. On the other hand, as we will explain below, things here will not be that simply scaled: \(\eta\) will be around \(10^{21}\), velocities on the order of \(10^{-8}\), pressure around \(10^8\), and the diameter of the domain is \(10^7\). In other words, the order of magnitude for the first equation is going to be \(\eta\text{div}\varepsilon(\mathbf u) \approx 10^{21} \frac{10^{-8}}{(10^7)^2} \approx 10^{-1}\), whereas the second equation will be around \(\text{div}{\mathbf u}\approx \frac{10^{-8}}{10^7} \approx 10^{-15}\). Well, so what this will lead to is this: if the solver wants to make the residual small, it will almost entirely focus on the first set of equations because they are so much bigger, and ignore the divergence equation that describes mass conservation. That's exactly what happens: unless we set the tolerance to extremely small values, the resulting flow field is definitely not divergence free. As an auxiliary problem, it turns out that it is difficult to find a tolerance that always works; in practice, one often ends up with a tolerance that requires 30 or 40 iterations for most time steps, and 10,000 for some others.</p>
<p>So what's a numerical analyst to do in a case like this? The answer is to start at the root and first make sure that everything is mathematically consistent first. In our case, this means that if we want to solve the system of Stokes equations jointly, we have to scale them so that they all have the same physical dimensions. In our case, this means multiplying the second equation by something that has units \(\frac{\text{Pa}\;\text{s}}{\text{m}}\); one choice is to multiply with \(\frac{\eta}{L}\) where \(L\) is a typical lengthscale in our domain (which experiments show is best chosen to be the diameter of plumes &mdash; around 10 km &mdash; rather than the diameter of the domain). Using these numbers for \(\eta\) and \(L\), this factor is around \(10^{17}\). So, we now get this for the Stokes system: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; \rho(T) \; \mathbf{g}, \\ \frac{\eta}{L} \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> The trouble with this is that the result is not symmetric any more (we have \(\frac{\eta}{L} \nabla \cdot\) at the bottom left, but not its transpose operator at the top right). This, however, can be cured by introducing a scaled pressure \(\hat p = \frac{L}{\eta}p\), and we get the scaled equations </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla \left(\frac{\eta}{L} \hat p\right) &amp;=&amp; \rho(T) \; \mathbf{g}, \\ \frac{\eta}{L} \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> This is now symmetric. Obviously, we can easily recover the original pressure \(p\) from the scaled pressure \(\hat p\) that we compute as a result of this procedure.</p>
<p>In the program below, we will introduce a factor <code>EquationData::pressure_scaling</code> that corresponds to \(\frac{\eta}{L}\), and we will use this factor in the assembly of the system matrix and preconditioner. Because it is annoying and error prone, we will recover the unscaled pressure immediately following the solution of the linear system, i.e., the solution vector's pressure component will immediately be unscaled to retrieve the physical pressure. Since the solver uses the fact that we can use a good initial guess by extrapolating the previous solutions, we also have to scale the pressure immediately <em>before</em> solving.</p>
<p><a class="anchor" id="ChangestotheStokespreconditionerandsolver"></a></p><h3>Changes to the Stokes preconditioner and solver </h3>
<p>In this tutorial program, we apply a variant of the preconditioner used in <a class="el" href="step_31.html">step-31</a>. That preconditioner was built to operate on the system matrix \(M\) in block form such that the product matrix </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1} M = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ S^{-1} B A^{-1} &amp; -S^{-1} \end{array}\right) \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \end{eqnarray*}
</p>
<p> is of a form that Krylov-based iterative solvers like GMRES can solve in a few iterations. We then replaced the exact inverse of \(A\) by the action of an AMG preconditioner \(\tilde{A}\) based on a vector Laplace matrix, approximated the Schur complement \(S = B A^{-1} B^T\) by a mass matrix \(M_p\) on the pressure space and wrote an <code>InverseMatrix</code> class for implementing the action of \(M_p^{-1}\approx S^{-1}\) on vectors. In the InverseMatrix class, we used a CG solve with an incomplete Cholesky (IC) preconditioner for performing the inner solves.</p>
<p>An observation one can make is that we use just the action of a preconditioner for approximating the velocity inverse \(A^{-1}\) (and the outer GMRES iteration takes care of the approximate character of the inverse), whereas we use a more or less <em>exact</em> inverse for \(M_p^{-1}\), realized by a fully converged CG solve. This appears unbalanced, but there's system to this madness: almost all the effort goes into the upper left block to which we apply the AMG preconditioner, whereas even an exact inversion of the pressure mass matrix costs basically nothing. Consequently, if it helps us reduce the overall number of iterations somewhat, then this effort is well spent.</p>
<p>That said, even though the solver worked well for <a class="el" href="step_31.html">step-31</a>, we have a problem here that is a bit more complicated (cells are deformed, the pressure varies by orders of magnitude, and we want to plan ahead for more complicated physics), and so we'll change a few things slightly:</p>
<ul>
<li>For more complex problems, it turns out that using just a single AMG V-cycle as preconditioner is not always sufficient. The outer solver converges just fine most of the time in a reasonable number of iterations (say, less than 50) but there are the occasional time step where it suddenly takes 700 or so. What exactly is going on there is hard to determine, but the problem can be avoided by using a more accurate solver for the top left block. Consequently, we'll want to use a CG iteration to invert the top left block of the preconditioner matrix, and use the AMG as a preconditioner for the CG solver.</li>
<li>The downside of this is that, of course, the Stokes preconditioner becomes much more expensive (approximately 10 times more expensive than when we just use a single V-cycle). Our strategy then is this: let's do up to 30 GMRES iterations with just the V-cycle as a preconditioner and if that doesn't yield convergence, then take the best approximation of the Stokes solution obtained after this first round of iterations and use that as the starting guess for iterations where we use the full inner solver with a rather lenient tolerance as preconditioner. In all our experiments this leads to convergence in only a few additional iterations.</li>
<li>One thing we need to pay attention to is that when using a CG with a lenient tolerance in the preconditioner, then \(y = \tilde A^{-1} r\) is no longer a linear function of \(r\) (it is, of course, if we have a very stringent tolerance in our solver, or if we only apply a single V-cycle). This is a problem since now our preconditioner is no longer a linear operator; in other words, every time GMRES uses it the preconditioner looks different. The standard GMRES solver can't deal with this, leading to slow convergence or even breakdown, but the F-GMRES variant is designed to deal with exactly this kind of situation and we consequently use it.</li>
<li>On the other hand, once we have settled on using F-GMRES we can relax the tolerance used in inverting the preconditioner for \(S\). In <a class="el" href="step_31.html">step-31</a>, we ran a preconditioned CG method on \(\tilde S\) until the residual had been reduced by 7 orders of magnitude. Here, we can again be more lenient because we know that the outer preconditioner doesn't suffer.</li>
<li>In <a class="el" href="step_31.html">step-31</a>, we used a left preconditioner in which we first invert the top left block of the preconditioner matrix, then apply the bottom left (divergence) one, and then invert the bottom right. In other words, the application of the preconditioner acts as a lower left block triangular matrix. Another option is to use a right preconditioner that here would be upper right block triangulation, i.e., we first invert the bottom right Schur complement, apply the top right (gradient) operator and then invert the elliptic top left block. To a degree, which one to choose is a matter of taste. That said, there is one significant advantage to a right preconditioner in GMRES-type solvers: the residual with which we determine whether we should stop the iteration is the true residual, not the norm of the preconditioned equations. Consequently, it is much simpler to compare it to the stopping criterion we typically use, namely the norm of the right hand side vector. In writing this code we found that the scaling issues we discussed above also made it difficult to determine suitable stopping criteria for left-preconditioned linear systems, and consequently this program uses a right preconditioner.</li>
<li>In <a class="el" href="step_31.html">step-31</a>, we used an IC (incomplete Cholesky) preconditioner for the pressure mass matrix in the Schur complement preconditioner and for the solution of the temperature system. Here, we could in principle do the same, but we do choose an even simpler preconditioner, namely a Jacobi preconditioner for both systems. This is because here we target at massively parallel computations, where the decompositions for IC/ILU would have to be performed block-wise for the locally owned degrees of freedom on each processor. This means, that the preconditioner gets more like a Jacobi preconditioner anyway, so we rather start from that variant straight away. Note that we only use the Jacobi preconditioners for CG solvers with mass matrices, where they give optimal (<em>h</em>-independent) convergence anyway, even though they usually require about twice as many iterations as an IC preconditioner.</li>
</ul>
<p>As a final note, let us remark that in <a class="el" href="step_31.html">step-31</a> we computed the Schur complement \(S=B A^{-1} B^T\) by approximating \(-\text{div}(-\eta\Delta)^{-1}\nabla \approx \frac 1{\eta} \mathbf{1}\). Now, however, we have re-scaled the \(B\) and \(B^T\) operators. So \(S\) should now approximate \(-\frac{\eta}{L}\text{div}(-\eta\Delta)^{-1}\nabla \frac{\eta}{L} \approx \left(\frac{\eta}{L}\right)^2 \frac 1{\eta} \mathbf{1}\). We use the discrete form of the right hand side of this as our approximation \(\tilde S\) to \(S\).</p>
<p><a class="anchor" id="Changestotheartificialviscositystabilization"></a></p><h3>Changes to the artificial viscosity stabilization </h3>
<p>Similarly to <a class="el" href="step_31.html">step-31</a>, we will use an artificial viscosity for stabilization based on a residual of the equation. As a difference to <a class="el" href="step_31.html">step-31</a>, we will provide two slightly different definitions of the stabilization parameter. For \(\alpha=1\), we use the same definition as in <a class="el" href="step_31.html">step-31</a>: </p><p class="formulaDsp">
\begin{eqnarray*} \nu_\alpha(T)|_K = \nu_1(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} h_K \min\left\{ 1, \frac{\|R_1(T)\|_{L^\infty(K)}}{c(\mathbf{u},T)} \right\} \end{eqnarray*}
</p>
<p> where we compute the viscosity from a residual \(\|R_1(T)\|_{L^\infty(K)}\) of the equation, limited by a diffusion proportional to the mesh size \(h_K\) in regions where the residual is large (around steep gradients). This definition has been shown to work well for the given case, \(\alpha = 1\) in <a class="el" href="step_31.html">step-31</a>, but it is usually less effective as the diffusion for \(\alpha=2\). For that case, we choose a slightly more readable definition of the viscosity, </p><p class="formulaDsp">
\begin{eqnarray*} \nu_2(T)|_K = \min (\nu_h^\mathrm{max}|_K,\nu_h^\mathrm{E}|_K) \end{eqnarray*}
</p>
<p> where the first term gives again the maximum dissipation (similarly to a first order upwind scheme), </p><p class="formulaDsp">
\begin{eqnarray*} \nu^\mathrm{max}_h|_K = \beta h_K \|\mathbf {u}\|_{L^\infty(K)} \end{eqnarray*}
</p>
<p> and the entropy viscosity is defined as </p><p class="formulaDsp">
\begin{eqnarray*} \nu^\mathrm{E}_h|_K = c_R \frac{h_K^2 \|R_\mathrm{2,E}(T)\|_{L^\infty(K)}} {\|E(T) - \bar{E}(T)\|_{L^\infty(\Omega)} }. \end{eqnarray*}
</p>
<p>This formula is described in the article <em>J.-L. Guermond, R. Pasquetti, &amp; B. Popov, 2011. Entropy viscosity method for nonlinear conservation laws, J. Comput. Phys., 230, 4248&ndash;4267.</em> Compared to the case \(\alpha = 1\), the residual is computed from the temperature entropy, \(E(T) = \frac12 (T-T_m)^2\) with \(T_m\) an average temperature (we choose the mean between the maximum and minimum temperature in the computation), which gives the following formula </p><p class="formulaDsp">
\begin{eqnarray*} R_\mathrm{E}(T) = \frac{\partial E(T)}{\partial t} + (T-T_\mathrm{m}) \left(\mathbf{u} \cdot \nabla T - \kappa \nabla^2 T - \gamma\right). \end{eqnarray*}
</p>
<p> The denominator in the formula for \(\nu^\mathrm{E}_h|_K\) is computed as the global deviation of the entropy from the space-averaged entropy \(\bar{E}(T) = \int_\Omega E(T) d\mathbf{x}/\int_\Omega d\mathbf{x}\). As in <a class="el" href="step_31.html">step-31</a>, we evaluate the artificial viscosity from the temperature and velocity at two previous time levels, in order to avoid a nonlinearity in its definition.</p>
<p>The above definitions of the viscosity are simple, but depend on two parameters, namely \(\beta\) and \(c_R\). For the current program, we want to go about this issue a bit more systematically for both parameters in the case \(\alpha =1\), using the same line of reasoning with which we chose two other parameters in our discretization, \(c_k\) and \(\beta\), in the results section of <a class="el" href="step_31.html">step-31</a>. In particular, remember that we would like to make the artificial viscosity as small as possible while keeping it as large as necessary. In the following, let us describe the general strategy one may follow. The computations shown here were done with an earlier version of the program and so the actual numerical values you get when running the program may no longer match those shown here; that said, the general approach remains valid and has been used to find the values of the parameters actually used in the program.</p>
<p>To see what is happening, note that below we will impose boundary conditions for the temperature between 973 and 4273 Kelvin, and initial conditions are also chosen in this range; for these considerations, we run the program without internal heat sources or sinks, and consequently the temperature should always be in this range, barring any internal oscillations. If the minimal temperature drops below 973 Kelvin, then we need to add stabilization by either increasing \(\beta\) or decreasing \(c_R\).</p>
<p>As we did in <a class="el" href="step_31.html">step-31</a>, we first determine an optimal value of \(\beta\) by using the "traditional" formula </p><p class="formulaDsp">
\begin{eqnarray*} \nu_\alpha(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} h_K, \end{eqnarray*}
</p>
<p> which we know to be stable if only \(\beta\) is large enough. Doing a couple hundred time steps (on a coarser mesh than the one shown in the program, and with a different viscosity that affects transport velocities and therefore time step sizes) in 2d will produce the following graph:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-32.beta.2d.png" alt="" class="inline"/></p>
<p>As can be seen, values \(\beta \le 0.05\) are too small whereas \(\beta=0.052\) appears to work, at least to the time horizon shown here. As a remark on the side, there are at least two questions one may wonder here: First, what happens at the time when the solution becomes unstable? Looking at the graphical output, we can see that with the unreasonably coarse mesh chosen for these experiments, around time \(t=10^{15}\) seconds the plumes of hot material that have been rising towards the cold outer boundary and have then spread sideways are starting to get close to each other, squeezing out the cold material in-between. This creates a layer of cells into which fluids flows from two opposite sides and flows out toward a third, apparently a scenario that then produce these instabilities without sufficient stabilization. Second: In <a class="el" href="step_31.html">step-31</a>, we used \(\beta=0.015\cdot\text{dim}\); why does this not work here? The answer to this is not entirely clear &ndash; stabilization parameters are certainly known to depend on things like the shape of cells, for which we had squares in <a class="el" href="step_31.html">step-31</a> but have trapezoids in the current program. Whatever the exact cause, we at least have a value of \(\beta\), namely 0.052 for 2d, that works for the current program. A similar set of experiments can be made in 3d where we find that \(\beta=0.078\) is a good choice &mdash; neatly leading to the formula \(\beta=0.026 \cdot \textrm{dim}\).</p>
<p>With this value fixed, we can go back to the original formula for the viscosity \(\nu\) and play with the constant \(c_R\), making it as large as possible in order to make \(\nu\) as small as possible. This gives us a picture like this:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-32.beta_cr.2d.png" alt="" class="inline"/></p>
<p>Consequently, \(c_R=0.1\) would appear to be the right value here. While this graph has been obtained for an exponent \(\alpha=1\), in the program we use \(\alpha=2\) instead, and in that case one has to re-tune the parameter (and observe that \(c_R\) appears in the numerator and not in the denominator). It turns out that \(c_R=1\) works with \(\alpha=2\).</p>
<p><a class="anchor" id="LocallyconservativeStokesdiscretization"></a></p><h3>Locally conservative Stokes discretization </h3>
<p>The standard Taylor-Hood discretization for Stokes, using the \(Q_{k+1}^d \times Q_k\) element, is globally conservative, i.e. \(\int_{\partial\Omega} \mathbf n \cdot \mathbf u_h = 0\). This can easily be seen: the weak form of the divergence equation reads \((q_h, \textrm{div}\; \mathbf u_h)=0, \forall q_h\in Q_h\). Because the pressure space does contain the function \(q_h=1\), we get </p><p class="formulaDsp">
\begin{align*} 0 = (1, \textrm{div}\; \mathbf u_h)_\Omega = \int_\Omega \textrm{div}\; \mathbf u_h = \int_{\partial\Omega} \mathbf n \cdot \mathbf u_h \end{align*}
</p>
<p> by the divergence theorem. This property is important: if we want to use the velocity field \(u_h\) to transport along other quantities (such as the temperature in the current equations, but it could also be concentrations of chemical substances or entirely artificial tracer quantities) then the conservation property guarantees that the amount of the quantity advected remains constant.</p>
<p>That said, there are applications where this <em>global</em> property is not enough. Rather, we would like that it holds <em>locally</em>, on every cell. This can be achieved by using the space \(Q_{k+1}^d \times DGP_k\) for discretization, where we have replaced the <em>continuous</em> space of tensor product polynomials of degree \(k\) for the pressure by the <em>discontinuous</em> space of the complete polynomials of the same degree. (Note that tensor product polynomials in 2d contain the functions \(1, x, y, xy\), whereas the complete polynomials only have the functions \(1,x,y\).) This space turns out to be stable for the Stokes equation.</p>
<p>Because the space is discontinuous, we can now in particular choose the test function \(q_h(\mathbf x)=\chi_K(\mathbf x)\), i.e. the characteristic function of cell \(K\). We then get in a similar fashion as above </p><p class="formulaDsp">
\begin{align*} 0 = (q_h, \textrm{div}\; \mathbf u_h)_\Omega = (1, \textrm{div}\; \mathbf u_h)_K = \int_K \textrm{div}\; \mathbf u_h = \int_{\partial K} \mathbf n \cdot \mathbf u_h, \end{align*}
</p>
<p> showing the conservation property for cell \(K\). This clearly holds for each cell individually.</p>
<p>There are good reasons to use this discretization. As mentioned above, this element guarantees conservation of advected quantities on each cell individually. A second advantage is that the pressure mass matrix we use as a preconditioner in place of the Schur complement becomes block diagonal and consequently very easy to invert. However, there are also downsides. For one, there are now more pressure variables, increasing the overall size of the problem, although this doesn't seem to cause much harm in practice. More importantly, though, the fact that now the divergence integrated over each cell is zero when it wasn't before does not guarantee that the divergence is pointwise smaller. In fact, as one can easily verify, the \(L_2\) norm of the divergence is <em>larger</em> for this than for the standard Taylor-Hood discretization. (However, both converge at the same rate to zero, since it is easy to see that \(\|\textrm{div}\; u_h\|= \|\textrm{div}\; (u-u_h)\|= \|\textrm{trace}\; \nabla (u-u_h)\|\le \|\nabla (u-u_h)\|={\cal O}(h^{k+2})\).) It is therefore not a priori clear that the error is indeed smaller just because we now have more degrees of freedom.</p>
<p>Given these considerations, it remains unclear which discretization one should prefer. Consequently, we leave that up to the user and make it a parameter in the input file which one to use.</p>
<p><a class="anchor" id="Higherordermappingsforcurvedboundaries"></a></p><h3>Higher order mappings for curved boundaries </h3>
<p>In the program, we will use a spherical shell as domain. This means that the inner and outer boundary of the domain are no longer "straight" (by which we usually mean that they are bilinear surfaces that can be represented by the <a class="el" href="classFlatManifold.html">FlatManifold</a> class). Rather, they are curved and it seems prudent to use a curved approximation in the program if we are already using higher order finite elements for the velocity. Consequently, we will introduce a member variable of type <a class="el" href="classMappingQ.html">MappingQ</a> that denotes such a mapping (<a class="el" href="step_10.html">step-10</a> and <a class="el" href="step_11.html">step-11</a> introduce such mappings for the first time) and that we will use in all computations on cells that are adjacent to the boundary. Since this only affects a relatively small fraction of cells, the additional effort is not very large and we will take the luxury of using a quartic mapping for these cells.</p>
<p><a class="anchor" id="Parallelizationonclusters"></a></p><h3>Parallelization on clusters </h3>
<p>Running convection codes in 3d with significant Rayleigh numbers requires a lot of computations &mdash; in the case of whole earth simulations on the order of one or several hundred million unknowns. This can obviously not be done with a single machine any more (at least not in 2010 when we started writing this code). Consequently, we need to parallelize it. Parallelization of scientific codes across multiple machines in a cluster of computers is almost always done using the Message Passing Interface (MPI). This program is no exception to that, and it follows the general spirit of the <a class="el" href="step_17.html">step-17</a> and <a class="el" href="step_18.html">step-18</a> programs in this though in practice it borrows more from <a class="el" href="step_40.html">step-40</a> in which we first introduced the classes and strategies we use when we want to <em>completely</em> distribute all computations, and <a class="el" href="step_55.html">step-55</a> that shows how to do that for <a class="el" href="group__vector__valued.html">vector-valued problems</a>: including, for example, splitting the mesh up into a number of parts so that each processor only stores its own share plus some ghost cells, and using strategies where no processor potentially has enough memory to hold the entries of the combined solution vector locally. The goal is to run this code on hundreds or maybe even thousands of processors, at reasonable scalability.</p>
<dl class="section note"><dt>Note</dt><dd>Even though it has a larger number, <a class="el" href="step_40.html">step-40</a> comes logically before the current program. The same is true for <a class="el" href="step_55.html">step-55</a>. You will probably want to look at these programs before you try to understand what we do here.</dd></dl>
<p>MPI is a rather awkward interface to program with. It is a semi-object oriented set of functions, and while one uses it to send data around a network, one needs to explicitly describe the data types because the MPI functions insist on getting the address of the data as <code>void*</code> objects rather than deducing the data type automatically through overloading or templates. We've already seen in <a class="el" href="step_17.html">step-17</a> and <a class="el" href="step_18.html">step-18</a> how to avoid almost all of MPI by putting all the communication necessary into either the deal.II library or, in those programs, into PETSc. We'll do something similar here: like in <a class="el" href="step_40.html">step-40</a> and <a class="el" href="step_55.html">step-55</a>, deal.II and the underlying p4est library are responsible for all the communication necessary for distributing the mesh, and we will let the Trilinos library (along with the wrappers in namespace <a class="el" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a>) deal with parallelizing the linear algebra components. We have already used Trilinos in <a class="el" href="step_31.html">step-31</a>, and will do so again here, with the difference that we will use its parallel capabilities.</p>
<p>Trilinos consists of a significant number of packages, implementing basic parallel linear algebra operations (the Epetra package), different solver and preconditioner packages, and on to things that are of less importance to deal.II (e.g., optimization, uncertainty quantification, etc). deal.II's Trilinos interfaces encapsulate many of the things Trilinos offers that are of relevance to PDE solvers, and provides wrapper classes (in namespace <a class="el" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a>) that make the Trilinos matrix, vector, solver and preconditioner classes look very much the same as deal.II's own implementations of this functionality. However, as opposed to deal.II's classes, they can be used in parallel if we give them the necessary information. As a consequence, there are two Trilinos classes that we have to deal with directly (rather than through wrappers), both of which are part of Trilinos' Epetra library of basic linear algebra and tool classes: </p><ul>
<li>
<p class="startli">The Epetra_Comm class is an abstraction of an MPI "communicator", i.e., it describes how many and which machines can communicate with each other. Each distributed object, such as a sparse matrix or a vector for which we may want to store parts on different machines, needs to have a communicator object to know how many parts there are, where they can be found, and how they can be accessed.</p>
<p class="interli">In this program, we only really use one communicator object &ndash; based on the MPI variable <code>MPI_COMM_WORLD</code> &ndash; that encompasses <em>all</em> processes that work together. It would be perfectly legitimate to start a process on \(N\) machines but only store vectors on a subset of these by producing a communicator object that only encompasses this subset of machines; there is really no compelling reason to do so here, however.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The <a class="el" href="classIndexSet.html">IndexSet</a> class is used to describe which elements of a vector or which rows of a matrix should reside on the current machine that is part of a communicator. To create such an object, you need to know (i) the total number of elements or rows, (ii) the indices of the elements you want to store locally. We will set up these <code>partitioners</code> in the <code>BoussinesqFlowProblem::setup_dofs</code> function below and then hand it to every parallel object we create.</p>
<p class="endli">Unlike PETSc, Trilinos makes no assumption that the elements of a vector need to be partitioned into contiguous chunks. At least in principle, we could store all elements with even indices on one processor and all odd ones on another. That's not very efficient, of course, but it's possible. Furthermore, the elements of these partitionings do not necessarily be mutually exclusive. This is important because when postprocessing solutions, we need access to all locally relevant or at least the locally active degrees of freedom (see the module on <a class="el" href="group__distributed.html">Parallel computing with multiple processors using</a> for a definition, as well as the discussion in <a class="el" href="step_40.html">step-40</a>). Which elements the Trilinos vector considers as locally owned is not important to us then. All we care about is that it stores those elements locally that we need. </p>
</li>
</ul>
<p>There are a number of other concepts relevant to distributing the mesh to a number of processors; you may want to take a look at the <a class="el" href="group__distributed.html">Parallel computing with multiple processors using</a> module and <a class="el" href="step_40.html">step-40</a> or <a class="el" href="step_55.html">step-55</a> before trying to understand this program. The rest of the program is almost completely agnostic about the fact that we don't store all objects completely locally. There will be a few points where we have to limit loops over all cells to those that are locally owned, or where we need to distinguish between vectors that store only locally owned elements and those that store everything that is locally relevant (see <a class="el" href="DEALGlossary.html#GlossLocallyRelevantDof">this glossary entry</a>), but by and large the amount of heavy lifting necessary to make the program run in parallel is well hidden in the libraries upon which this program builds. In any case, we will comment on these locations as we get to them in the program code.</p>
<p><a class="anchor" id="Parallelizationwithinindividualnodesofacluster"></a></p><h3>Parallelization within individual nodes of a cluster </h3>
<p>The second strategy to parallelize a program is to make use of the fact that most computers today have more than one processor that all have access to the same memory. In other words, in this model, we don't explicitly have to say which pieces of data reside where &ndash; all of the data we need is directly accessible and all we have to do is split <em>processing</em> this data between the available processors. We will then couple this with the MPI parallelization outlined above, i.e., we will have all the processors on a machine work together to, for example, assemble the local contributions to the global matrix for the cells that this machine actually "owns" but not for those cells that are owned by other machines. We will use this strategy for four kinds of operations we frequently do in this program: assembly of the Stokes and temperature matrices, assembly of the matrix that forms the Stokes preconditioner, and assembly of the right hand side of the temperature system.</p>
<p>All of these operations essentially look as follows: we need to loop over all cells for which <code>cell-&gt;<a class="el" href="tria__levels__0_8txt.html#a26cab9b2fe6e7f95a4102fbd722c02b1">subdomain_id()</a></code> equals the index our machine has within the communicator object used for all communication (i.e., <code>MPI_COMM_WORLD</code>, as explained above). The test we are actually going to use for this, and which describes in a concise way why we test this condition, is <code>cell-&gt;<a class="el" href="quadrature__point__data__0_8txt.html#a175634c053aca0ba3b25782a53938ea5">is_locally_owned()</a></code>. On each such cell we need to assemble the local contributions to the global matrix or vector, and then we have to copy each cell's contribution into the global matrix or vector. Note that the first part of this (the loop) defines a range of iterators on which something has to happen. The second part, assembly of local contributions is something that takes the majority of CPU time in this sequence of steps, and is a typical example of things that can be done in parallel: each cell's contribution is entirely independent of all other cells' contributions. The third part, copying into the global matrix, must not happen in parallel since we are modifying one object and so several threads can not at the same time read an existing matrix element, add their contribution, and write the sum back into memory without danger of producing a <a href="http://en.wikipedia.org/wiki/Race_condition">race condition</a>.</p>
<p>deal.II has a class that is made for exactly this workflow: <a class="el" href="namespaceWorkStream.html">WorkStream</a>, first discussed in <a class="el" href="step_9.html">step-9</a> and <a class="el" href="step_13.html">step-13</a>. Its use is also extensively documented in the module on <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing</a> (in the section on <a class="el" href="group__threads.html#MTWorkStream">the WorkStream class</a>) and we won't repeat here the rationale and detailed instructions laid out there, though you will want to read through this module to understand the distinction between scratch space and per-cell data. Suffice it to mention that we need the following:</p>
<ul>
<li>An iterator range for those cells on which we are supposed to work. This is provided by the <a class="el" href="classFilteredIterator.html">FilteredIterator</a> class which acts just like every other cell iterator in deal.II with the exception that it skips all cells that do not satisfy a particular predicate (i.e., a criterion that evaluates to true or false). In our case, the predicate is whether a cell is locally owned.</li>
<li>A function that does the work on each cell for each of the tasks identified above, i.e., functions that assemble the local contributions to Stokes matrix and preconditioner, temperature matrix, and temperature right hand side. These are the <code>BoussinesqFlowProblem::local_assemble_stokes_system</code>, <code>BoussinesqFlowProblem::local_assemble_stokes_preconditioner</code>, <code>BoussinesqFlowProblem::local_assemble_temperature_matrix</code>, and <code>BoussinesqFlowProblem::local_assemble_temperature_rhs</code> functions in the code below. These four functions can all have several instances running in parallel at the same time.</li>
<li>Functions that copy the result of the previous ones into the global object and that run sequentially to avoid race conditions. These are the <code>BoussinesqFlowProblem::copy_local_to_global_stokes_system</code>, <code>BoussinesqFlowProblem::copy_local_to_global_stokes_preconditioner</code>, <code>BoussinesqFlowProblem::copy_local_to_global_temperature_matrix</code>, and <code>BoussinesqFlowProblem::copy_local_to_global_temperature_rhs</code> functions.</li>
</ul>
<p>We will comment on a few more points in the actual code, but in general their structure should be clear from the discussion in <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing</a>.</p>
<p>The underlying technology for <a class="el" href="namespaceWorkStream.html">WorkStream</a> identifies "tasks" that need to be worked on (e.g. assembling local contributions on a cell) and schedules these tasks automatically to available processors. <a class="el" href="namespaceWorkStream.html">WorkStream</a> creates these tasks automatically, by splitting the iterator range into suitable chunks.</p>
<dl class="section note"><dt>Note</dt><dd>Using multiple threads within each MPI process only makes sense if you have fewer MPI processes running on each node of your cluster than there are processor cores on this machine. Otherwise, MPI will already keep your processors busy and you won't get any additional speedup from using threads. For example, if your cluster nodes have 8 cores as they often have at the time of writing this, and if your batch scheduler puts 8 MPI processes on each node, then using threads doesn't make the program any faster. Consequently, you probably want to either configure your deal.II without threads, or set the number of threads in <a class="el" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> to 1 (third argument), or "export DEAL_II_NUM_THREADS=1" before running. That said, at the time of writing this, we only use the <a class="el" href="namespaceWorkStream.html">WorkStream</a> class for assembling (parts of) linear systems, while 75% or more of the run time of the program is spent in the linear solvers that are not parallelized &mdash; in other words, the best we could hope is to parallelize the remaining 25%.</dd></dl>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase </h3>
<p>The setup for this program is mildly reminiscent of the problem we wanted to solve in the first place (see the introduction of <a class="el" href="step_31.html">step-31</a>): convection in the earth mantle. As a consequence, we choose the following data, all of which appears in the program in units of meters and seconds (the SI system) even if we list them here in other units. We do note, however, that these choices are essentially still only exemplary, and not meant to result in a completely realistic description of convection in the earth mantle: for that, more and more difficult physics would have to be implemented, and several other aspects are currently missing from this program as well. We will come back to this issue in the results section again, but state for now that providing a realistic description is a goal of the <em>ASPECT</em> code in development at the time of writing this.</p>
<p>As a reminder, let us again state the equations we want to solve are these: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla \left( \frac{\eta}{L} \hat p\right) &amp;=&amp; \rho(T) \mathbf{g}, \\ \frac{\eta}{L} \nabla \cdot {\mathbf u} &amp;=&amp; 0, \\ \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma, \end{eqnarray*}
</p>
<p> augmented by boundary and initial conditions. We then have to choose data for the following quantities: </p><ul>
<li>
<p class="startli">The domain is an annulus (in 2d) or a spherical shell (in 3d) with inner and outer radii that match that of the earth: the total radius of the earth is 6371km, with the mantle starting at a depth of around 35km (just under the solid earth <a href="http://en.wikipedia.org/wiki/Crust_(geology)" target="_top">crust</a> composed of <a href="http://en.wikipedia.org/wiki/Continental_crust" target="_top">continental</a> and <a href="http://en.wikipedia.org/wiki/Oceanic_crust" target="_top">oceanic plates</a>) to a depth of 2890km (where the <a href="http://en.wikipedia.org/wiki/Outer_core" target="_top">outer earth core</a> starts). The radii are therefore \(R_0=(6371-2890)\text{km}, R_1=(6371-35)\text{km}\). This domain is conveniently generated using the <a class="el" href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell()</a> function.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">At the interface between crust and mantle, the temperature is between 500 and 900 degrees Celsius, whereas at its bottom it is around 4000 degrees Celsius (see, for example, <a href="http://en.wikipedia.org/wiki/Mantle_(geology)" target="_top">this Wikipedia entry</a>). In Kelvin, we therefore choose \(T_0=(4000+273)\text{K}\), \(T_1=(500+273)\text{K}\) as boundary conditions at the inner and outer edge.</p>
<p class="interli">In addition to this, we also have to specify some initial conditions for the temperature field. The real temperature field of the earth is quite complicated as a consequence of the convection that has been going on for more than four billion years &ndash; in fact, it is the properties of this temperature distribution that we want to explore with programs like this. As a consequence, we don't really have anything useful to offer here, but we can hope that if we start with something and let things run for a while that the exact initial conditions don't matter that much any more &mdash; as is in fact suggested by looking at the pictures shown in the <a href="#Results">results section below</a>. The initial temperature field we use here is given in terms of the radius by </p><p class="formulaDsp">
\begin{align*} s &amp;= \frac{\|\mathbf x\|-R_0}{R_1-R_0}, \\ \varphi &amp;= \arctan \frac{y}{x}, \\ \tau &amp;= s + \frac 15 s(1-s) \sin(6\varphi) q(z), \\ T(\mathbf x) &amp;= T_0(1-\tau) + T_1\tau, \end{align*}
</p>
<p> where </p><p class="formulaDsp">
\begin{align*} q(z) = \left\{ \begin{array}{ll} 1 &amp; \text{in 2d} \\ \max\{0, \cos(\pi |z/R_1|)\} &amp; \text{in 3d} \end{array} \right. . \end{align*}
</p>
<p> This complicated function is essentially a perturbation of a linear profile between the inner and outer temperatures. In 2d, the function \(\tau=\tau(\mathbf x)\) looks like this (I got the picture from <a href="http://www.wolframalpha.com/input/?i=plot+%28sqrt%28x^2%2By^2%29%2B0.2*%28sqrt%28x^2%2By^2%29*%281-sqrt%28x^2%2By^2%29%29*sin%286*atan2%28x%2Cy%29%29%29%2C+x%3D-1+to+1%2C+y%3D-1+to+1">this page</a>):</p>
<p class="interli"><img src="https://www.dealii.org/images/steps/developer/step-32.2d-initial.png" alt="" class="inline"/></p>
<p class="interli">The point of this profile is that if we had used \(s\) instead of \(\tau\) in the definition of \(T(\mathbf x)\) then it would simply be a linear interpolation. \(\tau\) has the same function values as \(s\) on the inner and outer boundaries (zero and one, respectively), but it stretches the temperature profile a bit depending on the angle and the \(z\) value in 3d, producing an angle-dependent perturbation of the linearly interpolating field. We will see in the results section that this is an entirely unphysical temperature field (though it will make for interesting images) as the equilibrium state for the temperature will be an almost constant temperature with boundary layers at the inner and outer boundary.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The right hand side of the temperature equation contains the rate of internal heating \(\gamma\). The earth does heat naturally through several mechanisms: radioactive decay, chemical separation (heavier elements sink to the bottom, lighter ones rise to the top; the countercurrents dissipate energy equal to the loss of potential energy by this separation process); heat release by crystallization of liquid metal as the solid inner core of the earth grows; and heat dissipation from viscous friction as the fluid moves.</p>
<p class="interli">Chemical separation is difficult to model since it requires modeling mantle material as multiple phases; it is also a relatively small effect. Crystallization heat is even more difficult since it is confined to areas where temperature and pressure allow for phase changes, i.e., a discontinuous process. Given the difficulties in modeling these two phenomena, we will neglect them.</p>
<p class="interli">The other two are readily handled and, given the way we scaled the temperature equation, lead to the equation </p><p class="formulaDsp">
\[ \gamma(\mathbf x) = \frac{\rho q+2\eta \varepsilon(\mathbf u):\varepsilon(\mathbf u)} {\rho c_p}, \]
</p>
<p> where \(q\) is the radiogenic heating in \(\frac{W}{kg}\), and the second term in the enumerator is viscous friction heating. \(\rho\) is the density and \(c_p\) is the specific heat. The literature provides the following approximate values: \(c_p=1250 \frac{J}{kg\; K}, q=7.4\cdot 10^{-12}\frac{W}{kg}\). The other parameters are discussed elsewhere in this section.</p>
<p class="interli">We neglect one internal heat source, namely adiabatic heating here, which will lead to a surprising temperature field. This point is commented on in detail in the results section below.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">For the velocity we choose as boundary conditions \(\mathbf{v}=0\) at the inner radius (i.e., the fluid sticks to the earth core) and \(\mathbf{n}\cdot\mathbf{v}=0\) at the outer radius (i.e., the fluid flows tangentially along the bottom of the earth crust). Neither of these is physically overly correct: certainly, on both boundaries, fluids can flow tangentially, but they will incur a shear stress through friction against the medium at the other side of the interface (the metallic core and the crust, respectively). Such a situation could be modeled by a Robin-type boundary condition for the tangential velocity; in either case, the normal (vertical) velocity would be zero, although even that is not entirely correct since continental plates also have vertical motion (see, for example, the phenomenon of <a href="http://en.wikipedia.org/wiki/Postglacial_rebound">post-glacial rebound</a>). But to already make things worse for the tangential velocity, the medium on the other side is in motion as well, so the shear stress would, in the simplest case, be proportional to the <em>velocity difference</em>, leading to a boundary condition of the form </p><p class="formulaDsp">
\begin{align*} \mathbf{n}\cdot [2\eta \varepsilon(\mathbf v)] &amp;= s \mathbf{n} \times [\mathbf v - \mathbf v_0], \\ \mathbf{n} \cdot \mathbf v &amp;= 0, \end{align*}
</p>
<p> with a proportionality constant \(s\). Rather than going down this route, however, we go with the choice of zero (stick) and tangential flow boundary conditions.</p>
<p class="interli">As a side note of interest, we may also have chosen tangential flow conditions on both inner and outer boundary. That has a significant drawback, however: it leaves the velocity not uniquely defined. The reason is that all velocity fields \(\hat{\mathbf v}\) that correspond to a solid body rotation around the center of the domain satisfy \(\mathrm{div}\; \varepsilon(\hat{\mathbf v})=0, \mathrm{div} \;\hat{\mathbf v} = 0\), and \(\mathbf{n} \cdot \hat{\mathbf v} = 0\). As a consequence, if \(\mathbf v\) satisfies equations and boundary conditions, then so does \(\mathbf v + \hat{\mathbf v}\). That's certainly not a good situation that we would like to avoid. The traditional way to work around this is to pick an arbitrary point on the boundary and call this your fixed point by choosing the velocity to be zero in all components there. (In 3d one has to choose two points.) Since this program isn't meant to be too realistic to begin with, we avoid this complication by simply fixing the velocity along the entire interior boundary.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">To first order, the gravity vector always points downward. The question for a body as big as the earth is just: where is "up". The naive answer of course is "radially inward, towards the center of the earth". So at the surface of the earth, we have </p><p class="formulaDsp">
\[ \mathbf g = -9.81 \frac{\text{m}}{\text{s}^2} \frac{\mathbf x}{\|\mathbf x\|}, \]
</p>
<p> where \(9.81 \frac{\text{m}}{\text{s}^2}\) happens to be the average gravity acceleration at the earth surface. But in the earth interior, the question becomes a bit more complicated: at the (bary-)center of the earth, for example, you have matter pulling equally hard in all directions, and so \(\mathbf g=0\). In between, the net force is described as follows: let us define the <a href="http://en.wikipedia.org/wiki/Potential_energy#Gravitational_potential_energy" target="_top">gravity potential</a> by </p><p class="formulaDsp">
\[ \varphi(\mathbf x) = \int_{\text{earth}} -G \frac{\rho(\mathbf y)}{\|\mathbf x-\mathbf y\|} \ \text{d}y, \]
</p>
<p> then \(\mathbf g(\mathbf x) = -\nabla \varphi(\mathbf x)\). If we assume that the density \(\rho\) is constant throughout the earth, we can produce an analytical expression for the gravity vector (don't try to integrate above equation somehow &ndash; it leads to elliptic integrals; a simpler way is to notice that \(-\Delta\varphi(\mathbf x) = -4\pi G \rho \chi_{\text{earth}}(\mathbf x)\) and solving this partial differential equation in all of \({\mathbb R}^3\) exploiting the radial symmetry): </p><p class="formulaDsp">
\[ \mathbf g(\mathbf x) = \left\{ \begin{array}{ll} -\frac{4}{3}\pi G \rho \|\mathbf x\| \frac{\mathbf x}{\|\mathbf x\|} &amp; \text{for} \ \|\mathbf x\|&lt;R_1, \\ -\frac{4}{3}\pi G \rho R^3 \frac{1}{\|\mathbf x\|^2} \frac{\mathbf x}{\|\mathbf x\|} &amp; \text{for} \ \|\mathbf x\|\ge R_1. \end{array} \right. \]
</p>
<p> The factor \(-\frac{\mathbf x}{\|\mathbf x\|}\) is the unit vector pointing radially inward. Of course, within this problem, we are only interested in the branch that pertains to within the earth, i.e., \(\|\mathbf x\|&lt;R_1\). We would therefore only consider the expression </p><p class="formulaDsp">
\[ \mathbf g(\mathbf x) = -\frac{4}{3}\pi G \rho \|\mathbf x\| \frac{\mathbf x}{\|\mathbf x\|} = -\frac{4}{3}\pi G \rho \mathbf x = - 9.81 \frac{\mathbf x}{R_1} \frac{\text{m}}{\text{s}^2}, \]
</p>
<p> where we can infer the last expression because we know Earth's gravity at the surface (where \(\|x\|=R_1\)).</p>
<p class="interli">One can derive a more general expression by integrating the differential equation for \(\varphi(r)\) in the case that the density distribution is radially symmetric, i.e., \(\rho(\mathbf x)=\rho(\|\mathbf x\|)=\rho(r)\). In that case, one would get </p><p class="formulaDsp">
\[ \varphi(r) = 4\pi G \int_0^r \frac 1{s^2} \int_0^s t^2 \rho(t) \; dt \; ds. \]
</p>
<p class="interli">There are two problems with this, however: (i) The Earth is not homogeneous, i.e., the density \(\rho\) depends on \(\mathbf x\); in fact it is not even a function that only depends on the radius \(r=\|\mathbf x\|\). In reality, gravity therefore does not always decrease as we get deeper: because the earth core is so much denser than the mantle, gravity actually peaks at around \(10.7 \frac{\text{m}}{\text{s}^2}\) at the core mantle boundary (see <a href="http://en.wikipedia.org/wiki/Earth&#39;s_gravity" target="_top">this article</a>). (ii) The density, and by consequence the gravity vector, is not even constant in time: after all, the problem we want to solve is the time dependent upwelling of hot, less dense material and the downwelling of cold dense material. This leads to a gravity vector that varies with space and time, and does not always point straight down.</p>
<p class="interli">In order to not make the situation more complicated than necessary, we could use the approximation that at the inner boundary of the mantle, gravity is \(10.7 \frac{\text{m}}{\text{s}^2}\) and at the outer boundary it is \(9.81 \frac{\text{m}}{\text{s}^2}\), in each case pointing radially inward, and that in between gravity varies linearly with the radial distance from the earth center. That said, it isn't that hard to actually be slightly more realistic and assume (as we do below) that the earth mantle has constant density. In that case, the equation above can be integrated and we get an expression for \(\|\mathbf{g}\|\) where we can fit constants to match the gravity at the top and bottom of the earth mantle to obtain </p><p class="formulaDsp">
\[ \|\mathbf{g}\| = 1.245\cdot 10^{-6} \frac{1}{\textrm{s}^2} r + 7.714\cdot 10^{13} \frac{\textrm{m}^3}{\textrm{s}^2}\frac{1}{r^2}. \]
</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The density of the earth mantle varies spatially, but not by very much. \(\rho_{\text{ref}}=3300 \frac{\text{kg}}{\text{m}^3}\) is a relatively good average value for the density at reference temperature \(T_{\text{ref}}=293\) Kelvin.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The thermal expansion coefficient \(\beta\) also varies with depth (through its dependence on temperature and pressure). Close to the surface, it appears to be on the order of \(\beta=45\cdot 10^{-6} \frac 1{\text{K}}\), whereas at the core mantle boundary, it may be closer to \(\beta=10\cdot 10^{-6} \frac 1{\text{K}}\). As a reasonable value, let us choose \(\beta=2\cdot 10^{-5} \frac 1{\text{K}}\). The density as a function of temperature is then \(\rho(T)=[1-\beta(T-T_{\text{ref}})]\rho_{\text{ref}}\).</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The second to last parameter we need to specify is the viscosity \(\eta\). This is a tough one, because rocks at the temperatures and pressure typical for the earth mantle flow so slowly that the viscosity can not be determined accurately in the laboratory. So how do we know about the viscosity of the mantle? The most commonly used route is to consider that during and after ice ages, ice shields form and disappear on time scales that are shorter than the time scale of flow in the mantle. As a consequence, continents slowly sink into the earth mantle under the added weight of an ice shield, and they rise up again slowly after the ice shield has disappeared again (this is called <a href="http://en.wikipedia.org/wiki/Postglacial_rebound" target="_top"><em>postglacial rebound</em></a>). By measuring the speed of this rebound, we can infer the viscosity of the material that flows into the area vacated under the rebounding continental plates.</p>
<p class="interli">Using this technique, values around \(\eta=10^{21} \text{Pa}\;\text{s} = 10^{21} \frac{\text{N}\;\text{s}}{\text{m}^2} = 10^{21} \frac{\text{kg}}{\text{m}\;\text{s}}\) have been found as the most likely, though the error bar on this is at least one order of magnitude.</p>
<p class="interli">While we will use this value, we again have to caution that there are many physical reasons to assume that this is not the correct value. First, it should really be made dependent on temperature: hotter material is most likely to be less viscous than colder material. In reality, however, the situation is even more complex. Most rocks in the mantle undergo phase changes as temperature and pressure change: depending on temperature and pressure, different crystal configurations are thermodynamically favored over others, even if the chemical composition of the mantle were homogeneous. For example, the common mantle material MgSiO<sub>3</sub> exists in its <a href="http://en.wikipedia.org/wiki/Perovskite_(structure)" target="_top">perovskite structure</a> throughout most of the mantle, but in the lower mantle the same substance is stable only as <a href="http://en.wikipedia.org/wiki/Postperovskite" targe="_top">post-perovskite</a>. Clearly, to compute realistic viscosities, we would not only need to know the exact chemical composition of the mantle and the viscosities of all materials, but we would also have to compute the thermodynamically most stable configurations for all materials at each quadrature point. This is at the time of writing this program not a feasible suggestion.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Our last material parameter is the thermal diffusivity \(\kappa\), which is defined as \(\kappa=\frac{k}{\rho c_p}\) where \(k\) is the thermal conductivity, \(\rho\) the density, and \(c_p\) the specific heat. For this, the literature indicates that it increases from around \(0.7\) in the upper mantle to around \(1.7 \frac{\text{mm}^2}{\text{s}}\) in the lower mantle, though the exact value is not really all that important: heat transport through convection is several orders of magnitude more important than through thermal conduction. It may be of interest to know that perovskite, the most abundant material in the earth mantle, appears to become transparent at pressures above around 120 GPa (see, for example, J. Badro et al., Science 305, 383-386 (2004)); in the lower mantle, it may therefore be that heat transport through radiative transfer is more efficient than through thermal conduction.</p>
<p class="endli">In view of these considerations, let us choose \(\kappa=1 \frac{\text{mm}^2}{\text{s}} =10^{-6} \frac{\text{m}^2}{\text{s}}\) for the purpose of this program. </p>
</li>
</ul>
<p>All of these pieces of equation data are defined in the program in the <code>EquationData</code> namespace. When run, the program produces long-term maximal velocities around 10-40 centimeters per year (see the results section below), approximately the physically correct order of magnitude. We will set the end time to 1 billion years.</p>
<dl class="section note"><dt>Note</dt><dd>The choice of the constants and material parameters above follows in large part the comprehensive book "Mantle Convection in the Earth and Planets,
Part 1" by G. Schubert and D. L. Turcotte and P. Olson (Cambridge, 2001). It contains extensive discussion of ways to make the program more realistic.</dd></dl>
<p><a class="anchor" id="Implementationdetails"></a></p><h3>Implementation details </h3>
<p>Compared to <a class="el" href="step_31.html">step-31</a>, this program has a number of noteworthy differences:</p>
<ul>
<li>The <code>EquationData</code> namespace is significantly larger, reflecting the fact that we now have much more physics to deal with. That said, most of this additional physical detail is rather self-contained in functions in this one namespace, and does not proliferate throughout the rest of the program.</li>
<li>Of more obvious visibility is the fact that we have put a good number of parameters into an input file handled by the <a class="el" href="classParameterHandler.html">ParameterHandler</a> class (see, for example, <a class="el" href="step_29.html">step-29</a>, for ways to set up run-time parameter files with this class). This often makes sense when one wants to avoid re-compiling the program just because one wants to play with a single parameter (think, for example, of parameter studies determining the best values of the stabilization constants discussed above), in particular given that it takes a nontrivial amount of time to re-compile programs of the current size. To just give an overview of the kinds of parameters we have moved from fixed values into the input file, here is a listing of a typical <code>step-32.prm</code> file : <div class="fragment"><div class="line"><span class="preprocessor"># Listing of Parameters</span></div>
<div class="line"><span class="preprocessor"># ---------------------</span></div>
<div class="line"><span class="preprocessor"># The end time of the simulation in years.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> End <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>                            = 1e8</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Whether graphical output is to be generated or not. You may not want to get</span></div>
<div class="line"><span class="preprocessor"># graphical output if the number of processors is large.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Generate graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>           = <span class="keyword">false</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># The number of adaptive refinement steps performed after initial global</span></div>
<div class="line"><span class="preprocessor"># refinement.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Initial adaptive <a class="code" href="quadrature__point__data__0_8txt.html#a35c4177ef651238576ebc1395f9e116e">refinement</a>         = 1</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># The number of global refinement steps performed on the initial coarse mesh,</span></div>
<div class="line"><span class="preprocessor"># before the problem is first solved there.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Initial <a class="code" href="block__info__0_8txt.html#adf3728ee2be920ec28e2f66b5a04a213">global</a> <a class="code" href="quadrature__point__data__0_8txt.html#a35c4177ef651238576ebc1395f9e116e">refinement</a>           = 1</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># The number of time steps between each generation of graphical output files.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Time <a class="code" href="solver__cg__0_8txt.html#ab8dd1e5e6028b76d234561ae8e1d22bc">steps</a> between graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a> = 50</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># The number of time steps after which the mesh is to be adapted based on</span></div>
<div class="line"><span class="preprocessor"># computed error indicators.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Time <a class="code" href="solver__cg__0_8txt.html#ab8dd1e5e6028b76d234561ae8e1d22bc">steps</a> between <a class="code" href="distributed__0_8txt.html#a1a9fea1222a1f75ee681b6805de5f7fc">mesh</a> <a class="code" href="quadrature__point__data__0_8txt.html#a35c4177ef651238576ebc1395f9e116e">refinement</a>  = 10</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">subsection Discretization</div>
<div class="line"><span class="preprocessor">  # The polynomial degree to use for the velocity variables in the Stokes</span></div>
<div class="line"><span class="preprocessor">  # system.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Stokes <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a> <a class="code" href="polynomial__0_8txt.html#acef1a730e4f0566e0f83339e387c6dfa">polynomial</a> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>       = 2</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">  # The polynomial degree to use for the temperature variable.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Temperature <a class="code" href="polynomial__0_8txt.html#acef1a730e4f0566e0f83339e387c6dfa">polynomial</a> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>           = 2</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">  # Whether to use a Stokes discretization that is locally conservative at the</span></div>
<div class="line"><span class="preprocessor">  # expense of a larger number of degrees of freedom, or to go with a cheaper</span></div>
<div class="line"><span class="preprocessor">  # discretization that does not locally conserve mass (although it is</span></div>
<div class="line"><span class="preprocessor">  # globally conservative.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Use <a class="code" href="trilinos__sparsity__pattern__0_8txt.html#a232d55e29175b7b4f77582f2185b056c">locally</a> conservative discretization = <span class="keyword">true</span></div>
<div class="line"><a class="code" href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">subsection Stabilization <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a></div>
<div class="line"><span class="preprocessor">  # The exponent in the entropy viscosity stabilization.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 2</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">  # The beta factor in the artificial viscosity stabilization. An appropriate</span></div>
<div class="line"><span class="preprocessor">  # value for 2d is 0.052 and 0.078 for 3d.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = 0.078</div>
<div class="line"> </div>
<div class="line">  # <a class="code" href="A-headers_2fe__0_8txt.html#ac58f1344c78bfcb3556c763b59c923c6">The</a> c_R <a class="code" href="sparse__decomposition__0_8txt.html#aa36e69f7b51d00cbf24c899c1490950c">factor</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> entropy viscosity stabilization.</div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> c_R   = 0.5</div>
<div class="line">end</div>
</div><!-- fragment --></li>
<li>There are, obviously, a good number of changes that have to do with the fact that we want to run our program on a possibly very large number of machines. Although one may suspect that this requires us to completely re-structure our code, that isn't in fact the case (although the classes that implement much of this functionality in deal.II certainly look very different from an implementation viewpoint, but this doesn't reflect in their public interface). Rather, the changes are mostly subtle, and the overall structure of the main class is pretty much unchanged. That said, the devil is in the detail: getting parallel computing right, without deadlocks, ensuring that the right data is available at the right place (see, for example, the discussion on fully distributed vectors vs. vectors with ghost elements), and avoiding bottlenecks is difficult and discussions on this topic will appear in a good number of places in this program.</li>
</ul>
<p><a class="anchor" id="Outlook"></a></p><h3>Outlook </h3>
<p>This is a tutorial program. That means that at least most of its focus needs to lie on demonstrating ways of using deal.II and associated libraries, and not diluting this teaching lesson by focusing overly much on physical details. Despite the lengthy section above on the choice of physical parameters, the part of the program devoted to this is actually quite short and self contained.</p>
<p>That said, both <a class="el" href="step_31.html">step-31</a> and the current <a class="el" href="step_32.html">step-32</a> have not come about by chance but are certainly meant as wayposts along the path to a more comprehensive program that will simulate convection in the earth mantle. We call this code <em>ASPECT</em> (short for <em>Advanced Solver for Problems in Earth's ConvecTion</em>); its development is funded by the <a href="http://www.geodynamics.org">Computational Infrastructure in Geodynamics</a> initiative with support from the National Science Foundation. More information on <em>ASPECT</em> is available at its <a href="https://aspect.geodynamics.org/">homepage</a>.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The first task as usual is to include the functionality of these well-known deal.II library files and some C++ header files.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2work__stream_8h.html">deal.II/base/work_stream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2parameter__handler_8h.html">deal.II/base/parameter_handler.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__bicgstab_8h.html">deal.II/lac/solver_bicgstab.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__solver_8h.html">deal.II/lac/trilinos_solver.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2filtered__iterator_8h.html">deal.II/grid/filtered_iterator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgq_8h.html">deal.II/fe/fe_dgq.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgp_8h.html">deal.II/fe/fe_dgp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;locale&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
</div><!-- fragment --><p>This is the only include file that is new: It introduces the <a class="el" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a> equivalent of the <a class="el" href="classSolutionTransfer.html">SolutionTransfer</a> class to take a solution from on mesh to the next one upon mesh refinement, but in the case of parallel distributed triangulations:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2solution__transfer_8h.html">deal.II/distributed/solution_transfer.h</a>&gt;</span></div>
</div><!-- fragment --><p>The following classes are used in parallel distributed computations and have all already been introduced in <a class="el" href="step_40.html">step-40</a>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div>
</div><!-- fragment --><p>The next step is like in all previous tutorial programs: We put everything into a namespace of its own and then import the deal.II classes and functions into it:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep32.html">Step32</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Equationdata"></a> </p><h3>Equation data</h3>
<p>In the following namespace, we define the various pieces of equation data that describe the problem. This corresponds to the various aspects of making the problem at least slightly realistic and that were exhaustively discussed in the description of the testcase in the introduction.</p>
<p>We start with a few coefficients that have constant values (the comment after the value indicates its physical units):</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>EquationData</div>
<div class="line">{</div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a>                   = 1e21;    <span class="comment">/* Pa s       */</span></div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">kappa</a>                 = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6;    <span class="comment">/* m^2 / s    */</span></div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#acbc07b5e8caacadaf9798840a22d1603">reference_density</a>     = 3300;    <span class="comment">/* kg / m^3   */</span></div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a7abacfbb83b0ac35324d60dbc2a4ac27">reference_temperature</a> = 293;     <span class="comment">/* K          */</span></div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a3c097e8f7581f3b04d6a31eb66b11c8c">expansion_coefficient</a> = 2<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-5;    <span class="comment">/* 1/K        */</span></div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">specific_heat</a>         = 1250;    <span class="comment">/* J / K / kg */</span></div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">radiogenic_heating</a>    = 7.4e-12; <span class="comment">/* W / kg     */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a> = 6371000. - 2890000.; <span class="comment">/* m          */</span></div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a> = 6371000. - 35000.;   <span class="comment">/* m          */</span></div>
<div class="line"> </div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a1057295293dd9dfa723788107acc509e">T0</a> = 4000 + 273; <span class="comment">/* K          */</span></div>
<div class="line">  constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a00bf6e26439db0d8e3b91f11ee4fd72a">T1</a> = 700 + 273;  <span class="comment">/* K          */</span></div>
</div><!-- fragment --><p>The next set of definitions are for functions that encode the density as a function of temperature, the gravity vector, and the initial values for the temperature. Again, all of these (along with the values they compute) are discussed in the introduction:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> (</div>
<div class="line">    <a class="code" href="namespaceStep32_1_1EquationData.html#acbc07b5e8caacadaf9798840a22d1603">reference_density</a> *</div>
<div class="line">    (1 - <a class="code" href="namespaceStep32_1_1EquationData.html#a3c097e8f7581f3b04d6a31eb66b11c8c">expansion_coefficient</a> * (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> - <a class="code" href="namespaceStep32_1_1EquationData.html#a7abacfbb83b0ac35324d60dbc2a4ac27">reference_temperature</a>)));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="namespaceStep32_1_1EquationData.html#a7c001f60e6c7c0bcd347e3f7b66a5402">gravity_vector</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> r = <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>.norm();</div>
<div class="line">  <span class="keywordflow">return</span> -(1.245e-6 * r + 7.714e13 / r / r) * <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> / r;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>TemperatureInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  TemperatureInitialValues()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> r = <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>.norm();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="auto__derivative__function__0_8txt.html#af5d8dd2d035de856717fb6b5c9438dd5">h</a> = <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a> - <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> = (r - <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a>) / <a class="code" href="auto__derivative__function__0_8txt.html#af5d8dd2d035de856717fb6b5c9438dd5">h</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> q =</div>
<div class="line">    (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3) ? <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(0.0, <a class="code" href="classVectorizedArray.html#adea3423146bcdda2dce143cfb4d10ae8">cos</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> * <a class="code" href="classVectorizedArray.html#a2be646da1dcbc52f538c49923fb71c50">abs</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(2) / <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a>))) : 1.0;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> phi = <a class="code" href="namespaceDifferentiation_1_1SD.html#a130b20f2ea3522f1d123c75c63c0f67d">std::atan2</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0), <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(1));</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> tau = <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> + 0.2 * <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> * (1 - <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>) * <a class="code" href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">std::sin</a>(6 * phi) * q;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a1057295293dd9dfa723788107acc509e">T0</a> * (1.0 - tau) + <a class="code" href="namespaceStep32_1_1EquationData.html#a00bf6e26439db0d8e3b91f11ee4fd72a">T1</a> * tau;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">TemperatureInitialValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>As mentioned in the introduction we need to rescale the pressure to avoid the relative ill-conditioning of the momentum and mass conservation equations. The scaling factor is \(\frac{\eta}{L}\) where \(L\) was a typical length scale. By experimenting it turns out that a good length scale is the diameter of plumes, which is around 10 km:</p>
<div class="fragment"><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">pressure_scaling</a> = <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a> / 10000;</div>
</div><!-- fragment --><p>The final number in this namespace is a constant that denotes the number of seconds per (average, tropical) year. We use this only when generating screen output: internally, all computations of this program happen in SI units (kilogram, meter, seconds) but writing geological times in seconds yields numbers that one can't relate to reality, and so we convert to years using the factor defined here:</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">year_in_seconds</a> = 60 * 60 * 24 * 365.2425;</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace EquationData</span></div>
</div><!-- fragment --><p><a class="anchor" id="PreconditioningtheStokessystem"></a> </p><h3>Preconditioning the Stokes system</h3>
<p>This namespace implements the preconditioner. As discussed in the introduction, this preconditioner differs in a number of key portions from the one used in <a class="el" href="step_31.html">step-31</a>. Specifically, it is a right preconditioner, implementing the matrix </p><p class="formulaDsp">
\begin{align*} \left(\begin{array}{cc}A^{-1} &amp; B^T \\0 &amp; S^{-1} \end{array}\right) \end{align*}
</p>
<p> where the two inverse matrix operations are approximated by linear solvers or, if the right flag is given to the constructor of this class, by a single AMG V-cycle for the velocity block. The three code blocks of the <code>vmult</code> function implement the multiplications with the three blocks of this preconditioner matrix and should be self explanatory if you have read through <a class="el" href="step_31.html">step-31</a> or the discussion of composing solvers in <a class="el" href="step_20.html">step-20</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">  <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    BlockSchurPreconditioner(<span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">                             <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;Spre,</div>
<div class="line">                             <span class="keyword">const</span> PreconditionerTypeMp &amp;Mppreconditioner,</div>
<div class="line">                             <span class="keyword">const</span> PreconditionerTypeA &amp; Apreconditioner,</div>
<div class="line">                             <span class="keyword">const</span> <span class="keywordtype">bool</span>                  do_solve_A)</div>
<div class="line">      : stokes_matrix(&amp;S)</div>
<div class="line">      , stokes_preconditioner_matrix(&amp;Spre)</div>
<div class="line">      , mp_preconditioner(Mppreconditioner)</div>
<div class="line">      , a_preconditioner(Apreconditioner)</div>
<div class="line">      , do_solve_A(do_solve_A)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> utmp(src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line"> </div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(5000, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1).l2_norm());</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_preconditioner_matrix-&gt;block(1, 1),</div>
<div class="line">                     <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1),</div>
<div class="line">                     src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1),</div>
<div class="line">                     mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1) *= -1.0;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      {</div>
<div class="line">        stokes_matrix-&gt;block(0, 1).<a class="code" href="classSparseVanka.html#a34195e21adf1756d5d316cfc1091d843">vmult</a>(utmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1));</div>
<div class="line">        utmp *= -1.0;</div>
<div class="line">        utmp.add(src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (do_solve_A == <span class="keyword">true</span>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(5000, utmp.l2_norm() * 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-2);</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1SolverCG.html">TrilinosWrappers::SolverCG</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line">          <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix-&gt;block(0, 0),</div>
<div class="line">                       <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0),</div>
<div class="line">                       utmp,</div>
<div class="line">                       a_preconditioner);</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        a_preconditioner.vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), utmp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">      stokes_matrix;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">                                stokes_preconditioner_matrix;</div>
<div class="line">    <span class="keyword">const</span> PreconditionerTypeMp &amp;mp_preconditioner;</div>
<div class="line">    <span class="keyword">const</span> PreconditionerTypeA &amp; a_preconditioner;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span>                  do_solve_A;</div>
<div class="line">  };</div>
<div class="line">} <span class="comment">// namespace LinearSolvers</span></div>
</div><!-- fragment --><p><a class="anchor" id="Definitionofassemblydatastructures"></a> </p><h3>Definition of assembly data structures</h3>
<p>As described in the introduction, we will use the <a class="el" href="namespaceWorkStream.html">WorkStream</a> mechanism discussed in the <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing</a> module to parallelize operations among the processors of a single machine. The <a class="el" href="namespaceWorkStream.html">WorkStream</a> class requires that data is passed around in two kinds of data structures, one for scratch data and one to pass data from the assembly function to the function that copies local contributions into global objects.</p>
<p>The following namespace (and the two sub-namespaces) contains a collection of data structures that serve this purpose, one pair for each of the four operations discussed in the introduction that we will want to parallelize. Each assembly routine gets two sets of data: a Scratch array that collects all the classes and arrays that are used for the calculation of the cell contribution, and a <a class="el" href="structCopyData.html">CopyData</a> array that keeps local matrices and vectors which will be written into the global matrix. Whereas <a class="el" href="structCopyData.html">CopyData</a> is a container for the final data that is written into the global matrices and vector (and, thus, absolutely necessary), the Scratch arrays are merely there for performance reasons &mdash; it would be much more expensive to set up a <a class="el" href="classFEValues.html">FEValues</a> object on each cell, than creating it only once and updating some derivative data.</p>
<p><a class="el" href="step_31.html">step-31</a> had four assembly routines: One for the preconditioner matrix of the Stokes system, one for the Stokes matrix and right hand side, one for the temperature matrices and one for the right hand side of the temperature equation. We here organize the scratch arrays and <a class="el" href="structCopyData.html">CopyData</a> objects for each of those four assembly components using a <code>struct</code> environment (since we consider these as temporary objects we pass around, rather than classes that implement functionality of their own, though this is a more subjective point of view to distinguish between <code>struct</code>s and <code>class</code>es).</p>
<p>Regarding the Scratch objects, each struct is equipped with a constructor that creates an <a class="el" href="classFEValues.html">FEValues</a> object using the <a class="el" href="classFiniteElement.html">FiniteElement</a>, <a class="el" href="classQuadrature.html">Quadrature</a>, <a class="el" href="classMapping.html">Mapping</a> (which describes the interpolation of curved boundaries), and <a class="el" href="group__UpdateFlags.html">The interplay of UpdateFlags, Mapping, and</a> instances. Moreover, we manually implement a copy constructor (since the <a class="el" href="classFEValues.html">FEValues</a> class is not copyable by itself), and provide some additional vector fields that are used to hold intermediate data during the computation of local contributions.</p>
<p>Let us start with the scratch arrays and, specifically, the one used for assembly of the Stokes preconditioner:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>Assembly</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">namespace </span>Scratch</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>StokesPreconditioner</div>
<div class="line">    {</div>
<div class="line">      StokesPreconditioner(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">                           <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">                           <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                           <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         update_flags);</div>
<div class="line"> </div>
<div class="line">      StokesPreconditioner(<span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> stokes_fe_values;</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u;</div>
<div class="line">      std::vector&lt;double&gt;         phi_p;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         update_flags)</div>
<div class="line">      : stokes_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, stokes_fe, stokes_quadrature, update_flags)</div>
<div class="line">      , grad_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , phi_p(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> StokesPreconditioner &amp;scratch)</div>
<div class="line">      : stokes_fe_values(scratch.stokes_fe_values.get_mapping(),</div>
<div class="line">                         scratch.stokes_fe_values.get_fe(),</div>
<div class="line">                         scratch.stokes_fe_values.get_quadrature(),</div>
<div class="line">                         scratch.stokes_fe_values.get_update_flags())</div>
<div class="line">      , grad_phi_u(scratch.grad_phi_u)</div>
<div class="line">      , phi_p(scratch.phi_p)</div>
<div class="line">    {}</div>
</div><!-- fragment --><p>The next one is the scratch object used for the assembly of the full Stokes system. Observe that we derive the StokesSystem scratch class from the StokesPreconditioner class above. We do this because all the objects that are necessary for the assembly of the preconditioner are also needed for the actual matrix system and right hand side, plus some extra data. This makes the program more compact. Note also that the assembly of the Stokes system and the temperature right hand side further down requires data from temperature and velocity, respectively, so we actually need two <a class="el" href="classFEValues.html">FEValues</a> objects for those two cases.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">struct </span>StokesSystem : <span class="keyword">public</span> StokesPreconditioner&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line">  StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         stokes_update_flags,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         temperature_update_flags);</div>
<div class="line"> </div>
<div class="line">  StokesSystem(<span class="keyword">const</span> StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt;          phi_u;</div>
<div class="line">  std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; grads_phi_u;</div>
<div class="line">  std::vector&lt;double&gt;                  div_phi_u;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; old_temperature_values;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">StokesSystem&lt;dim&gt;::StokesSystem(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         stokes_update_flags,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         temperature_update_flags)</div>
<div class="line">  : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_fe,</div>
<div class="line">                              stokes_quadrature,</div>
<div class="line">                              <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                              stokes_update_flags)</div>
<div class="line">  , temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          temperature_fe,</div>
<div class="line">                          stokes_quadrature,</div>
<div class="line">                          temperature_update_flags)</div>
<div class="line">  , phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">  , grads_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">  , div_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">  , old_temperature_values(stokes_quadrature.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">StokesSystem&lt;dim&gt;::StokesSystem(<span class="keyword">const</span> StokesSystem&lt;dim&gt; &amp;scratch)</div>
<div class="line">  : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(scratch)</div>
<div class="line">  , temperature_fe_values(</div>
<div class="line">      scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">      scratch.temperature_fe_values.get_fe(),</div>
<div class="line">      scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">      scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">  , phi_u(scratch.phi_u)</div>
<div class="line">  , grads_phi_u(scratch.grads_phi_u)</div>
<div class="line">  , div_phi_u(scratch.div_phi_u)</div>
<div class="line">  , old_temperature_values(scratch.old_temperature_values)</div>
<div class="line">{}</div>
</div><!-- fragment --><p>After defining the objects used in the assembly of the Stokes system, we do the same for the assembly of the matrices necessary for the temperature system. The general structure is very similar:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">struct </span>TemperatureMatrix</div>
<div class="line">{</div>
<div class="line">  TemperatureMatrix(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   temperature_quadrature);</div>
<div class="line"> </div>
<div class="line">  TemperatureMatrix(<span class="keyword">const</span> TemperatureMatrix &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt;         phi_T;</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   temperature_quadrature)</div>
<div class="line">  : temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          temperature_fe,</div>
<div class="line">                          temperature_quadrature,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>)</div>
<div class="line">  , phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">  , grad_phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">  <span class="keyword">const</span> TemperatureMatrix &amp;scratch)</div>
<div class="line">  : temperature_fe_values(</div>
<div class="line">      scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">      scratch.temperature_fe_values.get_fe(),</div>
<div class="line">      scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">      scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">  , phi_T(scratch.phi_T)</div>
<div class="line">  , grad_phi_T(scratch.grad_phi_T)</div>
<div class="line">{}</div>
</div><!-- fragment --><p>The final scratch object is used in the assembly of the right hand side of the temperature system. This object is significantly larger than the ones above because a lot more quantities enter the computation of the right hand side of the temperature equation. In particular, the temperature values and gradients of the previous two time steps need to be evaluated at the quadrature points, as well as the velocities and the strain rates (i.e. the symmetric gradients of the velocity) that enter the right hand side as friction heating terms. Despite the number of terms, the following should be rather self explanatory:</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">struct </span>TemperatureRHS</div>
<div class="line">  {</div>
<div class="line">    TemperatureRHS(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">                   <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">                   <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                   <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>);</div>
<div class="line"> </div>
<div class="line">    TemperatureRHS(<span class="keyword">const</span> TemperatureRHS &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> stokes_fe_values;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         phi_T;</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_velocity_values;</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_velocity_values;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_strain_rates;</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_old_strain_rates;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         old_temperature_values;</div>
<div class="line">    std::vector&lt;double&gt;         old_old_temperature_values;</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_temperature_grads;</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_temperature_grads;</div>
<div class="line">    std::vector&lt;double&gt;         old_temperature_laplacians;</div>
<div class="line">    std::vector&lt;double&gt;         old_old_temperature_laplacians;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  TemperatureRHS&lt;dim&gt;::TemperatureRHS(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>)</div>
<div class="line">    : temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            temperature_fe,</div>
<div class="line">                            <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>)</div>
<div class="line">    , stokes_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                       stokes_fe,</div>
<div class="line">                       <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>,</div>
<div class="line">                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>)</div>
<div class="line">    , phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    , grad_phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    old_velocity_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_velocity_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_strain_rates(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_strain_rates(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    old_temperature_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_temperature_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_temperature_grads(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_temperature_grads(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_temperature_laplacians(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_temperature_laplacians(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  TemperatureRHS&lt;dim&gt;::TemperatureRHS(<span class="keyword">const</span> TemperatureRHS &amp;scratch)</div>
<div class="line">    : temperature_fe_values(</div>
<div class="line">        scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">        scratch.temperature_fe_values.get_fe(),</div>
<div class="line">        scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">        scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">    , stokes_fe_values(scratch.stokes_fe_values.get_mapping(),</div>
<div class="line">                       scratch.stokes_fe_values.get_fe(),</div>
<div class="line">                       scratch.stokes_fe_values.get_quadrature(),</div>
<div class="line">                       scratch.stokes_fe_values.get_update_flags())</div>
<div class="line">    , phi_T(scratch.phi_T)</div>
<div class="line">    , grad_phi_T(scratch.grad_phi_T)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    old_velocity_values(scratch.old_velocity_values)</div>
<div class="line">    , old_old_velocity_values(scratch.old_old_velocity_values)</div>
<div class="line">    , old_strain_rates(scratch.old_strain_rates)</div>
<div class="line">    , old_old_strain_rates(scratch.old_old_strain_rates)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    old_temperature_values(scratch.old_temperature_values)</div>
<div class="line">    , old_old_temperature_values(scratch.old_old_temperature_values)</div>
<div class="line">    , old_temperature_grads(scratch.old_temperature_grads)</div>
<div class="line">    , old_old_temperature_grads(scratch.old_old_temperature_grads)</div>
<div class="line">    , old_temperature_laplacians(scratch.old_temperature_laplacians)</div>
<div class="line">    , old_old_temperature_laplacians(scratch.old_old_temperature_laplacians)</div>
<div class="line">  {}</div>
<div class="line">} <span class="comment">// namespace Scratch</span></div>
</div><!-- fragment --><p>The <a class="el" href="structCopyData.html">CopyData</a> objects are even simpler than the Scratch objects as all they have to do is to store the results of local computations until they can be copied into the global matrix or vector objects. These structures therefore only need to provide a constructor, a copy operation, and some arrays for local matrix, local vectors and the relation between local and global degrees of freedom (a.k.a. <code>local_dof_indices</code>). Again, we have one such structure for each of the four operations we will parallelize using the <a class="el" href="namespaceWorkStream.html">WorkStream</a> class:</p>
<div class="fragment"><div class="line">  <span class="keyword">namespace </span><a class="code" href="structCopyData.html">CopyData</a></div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>StokesPreconditioner</div>
<div class="line">    {</div>
<div class="line">      StokesPreconditioner(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe);</div>
<div class="line">      StokesPreconditioner(<span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">      StokesPreconditioner &amp;<a class="code" href="chunk__sparse__matrix__0_8txt.html#aa747ba884f098177e9bf2b2422a461a9">operator=</a>(<span class="keyword">const</span> StokesPreconditioner &amp;) = <span class="keywordflow">default</span>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_matrix;</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe)</div>
<div class="line">      : local_matrix(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(), stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">      : local_matrix(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix)</div>
<div class="line">      , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>StokesSystem : <span class="keyword">public</span> StokesPreconditioner&lt;dim&gt;</div>
<div class="line">    {</div>
<div class="line">      StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesSystem&lt;dim&gt;::StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe)</div>
<div class="line">      : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_fe)</div>
<div class="line">      , local_rhs(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>TemperatureMatrix</div>
<div class="line">    {</div>
<div class="line">      TemperatureMatrix(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_mass_matrix;</div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_stiffness_matrix;</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe)</div>
<div class="line">      : local_mass_matrix(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                          temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , local_stiffness_matrix(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                               temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>TemperatureRHS</div>
<div class="line">    {</div>
<div class="line">      TemperatureRHS(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classVector.html">Vector&lt;double&gt;</a>                       local_rhs;</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   matrix_for_bc;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    TemperatureRHS&lt;dim&gt;::TemperatureRHS(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe)</div>
<div class="line">      : local_rhs(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , matrix_for_bc(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                      temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line">  } <span class="comment">// namespace CopyData</span></div>
<div class="line">}   <span class="comment">// namespace Assembly</span></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeBoussinesqFlowProblemcodeclasstemplate"></a> </p><h3>The <code>BoussinesqFlowProblem</code> class template</h3>
<p>This is the declaration of the main class. It is very similar to <a class="el" href="step_31.html">step-31</a> but there are a number differences we will comment on below.</p>
<p>The top of the class is essentially the same as in <a class="el" href="step_31.html">step-31</a>, listing the public methods and a set of private functions that do the heavy lifting. Compared to <a class="el" href="step_31.html">step-31</a> there are only two additions to this section: the function <code>get_cfl_number()</code> that computes the maximum CFL number over all cells which we then compute the global time step from, and the function <code>get_entropy_variation()</code> that is used in the computation of the entropy stabilization. It is akin to the <code>get_extrapolated_temperature_range()</code> we have used in <a class="el" href="step_31.html">step-31</a> for this purpose, but works on the entropy instead of the temperature instead.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>BoussinesqFlowProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">struct </span>Parameters;</div>
<div class="line">  BoussinesqFlowProblem(Parameters &amp;<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span>   setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_stokes_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span>   build_stokes_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_stokes_system();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_temperature_matrix();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_temperature_system(<span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity);</div>
<div class="line">  <span class="keywordtype">double</span> get_maximal_velocity() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_cfl_number() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_entropy_variation(<span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature) <span class="keyword">const</span>;</div>
<div class="line">  std::pair&lt;double, double&gt; get_extrapolated_temperature_range() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span>                      <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span>                      output_results();</div>
<div class="line">  <span class="keywordtype">void</span>                      refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_strain_rates,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_old_strain_rates,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_u_infty,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_T_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                average_temperature,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_entropy_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
</div><!-- fragment --><p>The first significant new component is the definition of a struct for the parameters according to the discussion in the introduction. This structure is initialized by reading from a parameter file during construction of this object.</p>
<div class="fragment"><div class="line">  <span class="keyword">struct </span>Parameters</div>
<div class="line">  {</div>
<div class="line">    Parameters(<span class="keyword">const</span> std::string &amp;parameter_filename);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">declare_parameters</a>(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line">    <span class="keywordtype">void</span>        parse_parameters(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> end_time;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_global_refinement;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_adaptive_refinement;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span>         generate_graphical_output;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> graphical_output_interval;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> adaptive_refinement_interval;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> stabilization_alpha;</div>
<div class="line">    <span class="keywordtype">double</span> stabilization_c_R;</div>
<div class="line">    <span class="keywordtype">double</span> stabilization_beta;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_velocity_degree;</div>
<div class="line">    <span class="keywordtype">bool</span>         use_locally_conservative_discretization;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> temperature_degree;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  Parameters &amp;<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>;</div>
</div><!-- fragment --><p>The <code>pcout</code> (for <em>parallel <code>std::cout</code></em>) object is used to simplify writing output: each MPI process can use this to generate output as usual, but since each of these processes will (hopefully) produce the same output it will just be replicated many times over; with the <a class="el" href="classConditionalOStream.html">ConditionalOStream</a> class, only the output generated by one MPI process will actually be printed to screen, whereas the output by all the other threads will simply be forgotten.</p>
<div class="fragment"><div class="line"><a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div>
</div><!-- fragment --><p>The following member variables will then again be similar to those in <a class="el" href="step_31.html">step-31</a> (and to other tutorial programs). As mentioned in the introduction, we fully distribute computations, so we will have to use the <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a> class (see <a class="el" href="step_40.html">step-40</a>) but the remainder of these variables is rather standard with two exceptions:</p>
<ul>
<li>The <code>mapping</code> variable is used to denote a higher-order polynomial mapping. As mentioned in the introduction, we use this mapping when forming integrals through quadrature for all cells that are adjacent to either the inner or outer boundaries of our domain where the boundary is curved.</li>
<li>In a bit of naming confusion, you will notice below that some of the variables from namespace <a class="el" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a> are taken from namespace <a class="el" href="namespaceTrilinosWrappers_1_1MPI.html">TrilinosWrappers::MPI</a> (such as the right hand side vectors) whereas others are not (such as the various matrices). This is due to legacy reasons. We will frequently have to query velocities and temperatures at arbitrary quadrature points; consequently, rather than importing ghost information of a vector whenever we need access to degrees of freedom that are relevant locally but owned by another processor, we solve linear systems in parallel but then immediately initialize a vector including ghost entries of the solution for further processing. The various <code>*_solution</code> vectors are therefore filled immediately after solving their respective linear system in parallel and will always contain values for all <a class="el" href="DEALGlossary.html#GlossLocallyRelevantDof">locally relevant degrees of freedom</a>; the fully distributed vectors that we obtain from the solution process and that only ever contain the <a class="el" href="DEALGlossary.html#GlossLocallyOwnedDof">locally owned degrees of freedom</a> are destroyed immediately after the solution process and after we have copied the relevant values into the member variable vectors.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line"><span class="keywordtype">double</span>                                    global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classMappingQ.html">MappingQ&lt;dim&gt;</a> <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>       stokes_fe;</div>
<div class="line"><a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           stokes_dof_handler;</div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> stokes_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_matrix;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_stokes_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 temperature_fe;</div>
<div class="line"><a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           temperature_dof_handler;</div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> temperature_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_mass_matrix;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_stiffness_matrix;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_matrix;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_temperature_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_temperature_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span>       time_step;</div>
<div class="line"><span class="keywordtype">double</span>       old_time_step;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionAMG&gt;    Amg_preconditioner;</div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionJacobi&gt; Mp_preconditioner;</div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionJacobi&gt; T_preconditioner;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> rebuild_stokes_matrix;</div>
<div class="line"><span class="keywordtype">bool</span> rebuild_stokes_preconditioner;</div>
<div class="line"><span class="keywordtype">bool</span> rebuild_temperature_matrices;</div>
<div class="line"><span class="keywordtype">bool</span> rebuild_temperature_preconditioner;</div>
</div><!-- fragment --><p>The next member variable, <code>computing_timer</code> is used to conveniently account for compute time spent in certain "sections" of the code that are repeatedly entered. For example, we will enter (and leave) sections for Stokes matrix assembly and would like to accumulate the run time spent in this section over all time steps. Every so many time steps as well as at the end of the program (through the destructor of the <a class="el" href="classTimerOutput.html">TimerOutput</a> class) we will then produce a nice summary of the times spent in the different sections into which we categorize the run-time of this program.</p>
<div class="fragment"><div class="line"><a class="code" href="classTimerOutput.html">TimerOutput</a> computing_timer;</div>
</div><!-- fragment --><p>After these member variables we have a number of auxiliary functions that have been broken out of the ones listed above. Specifically, there are first three functions that we call from <code>setup_dofs</code> and then the ones that do the assembling of linear systems:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> setup_stokes_matrix(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning);</div>
<div class="line"><span class="keywordtype">void</span> setup_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning);</div>
<div class="line"><span class="keywordtype">void</span> setup_temperature_matrices(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_partitioning,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_relevant_partitioning);</div>
</div><!-- fragment --><p>Following the <a class="el" href="group__threads.html#MTWorkStream">task-based parallelization</a> paradigm, we split all the assembly routines into two parts: a first part that can do all the calculations on a certain cell without taking care of other threads, and a second part (which is writing the local data into the global matrices and vectors) which can be entered by only one thread at a time. In order to implement that, we provide functions for each of those two steps for all the four assembly routines that we use in this program. The following eight functions do exactly this:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> local_assemble_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">  Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> copy_local_to_global_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> local_assemble_stokes_system(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">  Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> copy_local_to_global_stokes_system(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> local_assemble_temperature_matrix(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">  Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> copy_local_to_global_temperature_matrix(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> local_assemble_temperature_rhs(</div>
<div class="line">  <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_velocity,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_entropy_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">  Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> copy_local_to_global_temperature_rhs(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
</div><!-- fragment --><p>Finally, we forward declare a member class that we will define later on and that will be used to compute a number of quantities from our solution vectors that we'd like to put into the output files for visualization.</p>
<div class="fragment"><div class="line">  <span class="keyword">class </span>Postprocessor;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemclassimplementation"></a> </p><h3>BoussinesqFlowProblem class implementation</h3>
<p><a class="anchor" id="BoussinesqFlowProblemParameters"></a> </p><h4>BoussinesqFlowProblem::Parameters</h4>
<p>Here comes the definition of the parameters for the Stokes problem. We allow to set the end time for the simulation, the level of refinements (both global and adaptive, which in the sum specify what maximum level the cells are allowed to have), and the interval between refinements in the time stepping.</p>
<p>Then, we let the user specify constants for the stabilization parameters (as discussed in the introduction), the polynomial degree for the Stokes velocity space, whether to use the locally conservative discretization based on <a class="el" href="classFE__DGP.html">FE_DGP</a> elements for the pressure or not (<a class="el" href="classFE__Q.html">FE_Q</a> elements for pressure), and the polynomial degree for the temperature interpolation.</p>
<p>The constructor checks for a valid input file (if not, a file with default parameters for the quantities is written), and eventually parses the parameters.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::Parameters::Parameters(</div>
<div class="line">  <span class="keyword">const</span> std::string &amp;parameter_filename)</div>
<div class="line">  : end_time(1e8)</div>
<div class="line">  , initial_global_refinement(2)</div>
<div class="line">  , initial_adaptive_refinement(2)</div>
<div class="line">  , adaptive_refinement_interval(10)</div>
<div class="line">  , stabilization_alpha(2)</div>
<div class="line">  , stabilization_c_R(0.11)</div>
<div class="line">  , stabilization_beta(0.078)</div>
<div class="line">  , stokes_velocity_degree(2)</div>
<div class="line">  , use_locally_conservative_discretization(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , temperature_degree(2)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> prm;</div>
<div class="line">  <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">BoussinesqFlowProblem&lt;dim&gt;::Parameters::declare_parameters</a>(prm);</div>
<div class="line"> </div>
<div class="line">  std::ifstream parameter_file(parameter_filename);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!parameter_file)</div>
<div class="line">    {</div>
<div class="line">      parameter_file.close();</div>
<div class="line"> </div>
<div class="line">      std::ofstream parameter_out(parameter_filename);</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a4ac3a8b19ade16e96e8ea25906daf23a">print_parameters</a>(parameter_out, <a class="code" href="group__Exceptions.html#ga8364dda711b93753c6809eefe2a8e827a3a1480568c2713f53dcb21319bb28093">ParameterHandler::Text</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(</div>
<div class="line">        <span class="keyword">false</span>,</div>
<div class="line">        <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">          <span class="stringliteral">&quot;Input parameter file &lt;&quot;</span> + parameter_filename +</div>
<div class="line">          <span class="stringliteral">&quot;&gt; not found. Creating a template file of the same name.&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">parse_input</a>(parameter_file);</div>
<div class="line">  parse_parameters(prm);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Next we have a function that declares the parameters that we expect in the input file, together with their data types, default values and a description:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">BoussinesqFlowProblem&lt;dim&gt;::Parameters::declare_parameters</a>(</div>
<div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">{</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;End time&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;1e8&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                    <span class="stringliteral">&quot;The end time of the simulation in years.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Initial global refinement&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of global refinement steps performed on &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;the initial coarse mesh, before the problem is first &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;solved there.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Initial adaptive refinement&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of adaptive refinement steps performed after &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;initial global refinement.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Time steps between mesh refinement&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;10&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of time steps after which the mesh is to be &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;adapted based on computed error indicators.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Generate graphical output&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;false&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(),</div>
<div class="line">                    <span class="stringliteral">&quot;Whether graphical output is to be generated or not. &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;You may not want to get graphical output if the number &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;of processors is large.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Time steps between graphical output&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;50&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of time steps between each generation of &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;graphical output files.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Stabilization parameters&quot;</span>);</div>
<div class="line">  {</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;alpha&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(1, 2),</div>
<div class="line">                      <span class="stringliteral">&quot;The exponent in the entropy viscosity stabilization.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;c_R&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;0.11&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                      <span class="stringliteral">&quot;The c_R factor in the entropy viscosity &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;stabilization.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;beta&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;0.078&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                      <span class="stringliteral">&quot;The beta factor in the artificial viscosity &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;stabilization. An appropriate value for 2d is 0.052 &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;and 0.078 for 3d.&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Discretization&quot;</span>);</div>
<div class="line">  {</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">      <span class="stringliteral">&quot;Stokes velocity polynomial degree&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">      <span class="stringliteral">&quot;The polynomial degree to use for the velocity variables &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;in the Stokes system.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">      <span class="stringliteral">&quot;Temperature polynomial degree&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">      <span class="stringliteral">&quot;The polynomial degree to use for the temperature variable.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">      <span class="stringliteral">&quot;Use locally conservative discretization&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;true&quot;</span>,</div>
<div class="line">      <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(),</div>
<div class="line">      <span class="stringliteral">&quot;Whether to use a Stokes discretization that is locally &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;conservative at the expense of a larger number of degrees &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;of freedom, or to go with a cheaper discretization &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;that does not locally conserve mass (although it is &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;globally conservative.&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p>And then we need a function that reads the contents of the <a class="el" href="classParameterHandler.html">ParameterHandler</a> object we get by reading the input file and puts the results into variables that store the values of the parameters we have previously declared:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::Parameters::parse_parameters(</div>
<div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">{</div>
<div class="line">  end_time                  = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;End time&quot;</span>);</div>
<div class="line">  initial_global_refinement = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Initial global refinement&quot;</span>);</div>
<div class="line">  initial_adaptive_refinement =</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Initial adaptive refinement&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  adaptive_refinement_interval =</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Time steps between mesh refinement&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  generate_graphical_output = prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;Generate graphical output&quot;</span>);</div>
<div class="line">  graphical_output_interval =</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Time steps between graphical output&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Stabilization parameters&quot;</span>);</div>
<div class="line">  {</div>
<div class="line">    stabilization_alpha = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;alpha&quot;</span>);</div>
<div class="line">    stabilization_c_R   = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;c_R&quot;</span>);</div>
<div class="line">    stabilization_beta  = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;beta&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Discretization&quot;</span>);</div>
<div class="line">  {</div>
<div class="line">    stokes_velocity_degree =</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Stokes velocity polynomial degree&quot;</span>);</div>
<div class="line">    temperature_degree = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Temperature polynomial degree&quot;</span>);</div>
<div class="line">    use_locally_conservative_discretization =</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;Use locally conservative discretization&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemBoussinesqFlowProblem"></a> </p><h4>BoussinesqFlowProblem::BoussinesqFlowProblem</h4>
<p>The constructor of the problem is very similar to the constructor in <a class="el" href="step_31.html">step-31</a>. What is different is the parallel communication: Trilinos uses a message passing interface (MPI) for data distribution. When entering the BoussinesqFlowProblem class, we have to decide how the parallelization is to be done. We choose a rather simple strategy and let all processors that are running the program work together, specified by the communicator <code>MPI_COMM_WORLD</code>. Next, we create the output stream (as we already did in <a class="el" href="step_18.html">step-18</a>) that only generates output on the first MPI process and is completely forgetful on all others. The implementation of this idea is to check the process number when <code>pcout</code> gets a true argument, and it uses the <code>std::cout</code> stream for output. If we are one processor five, for instance, then we will give a <code>false</code> argument to <code>pcout</code>, which means that the output of that processor will not be printed. With the exception of the mapping object (for which we use polynomials of degree 4) all but the final member variable are exactly the same as in <a class="el" href="step_31.html">step-31</a>.</p>
<p>This final object, the <a class="el" href="classTimerOutput.html">TimerOutput</a> object, is then told to restrict output to the <code>pcout</code> stream (processor 0), and then we specify that we want to get a summary table at the end of the program which shows us wallclock times (as opposed to CPU times). We will manually also request intermediate summaries every so many time steps in the <code><a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a></code> function below.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::BoussinesqFlowProblem(Parameters &amp;parameters_)</div>
<div class="line">  : <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>(parameters_)</div>
<div class="line">  , pcout(std::cout, (<a class="code" href="namespaceUtilities.html">Utilities</a>::<a class="code" href="base_2partitioner__0_8txt.html#a6d2d0fa485d1660823c59c494fb0fb31">MPI</a>::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(MPI_COMM_WORLD) == 0))</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(MPI_COMM_WORLD,</div>
<div class="line">                typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::MeshSmoothing(</div>
<div class="line">                  <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::smoothing_on_refinement |</div>
<div class="line">                  <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::smoothing_on_coarsening))</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  global_Omega_diameter(0.)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(4)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree),</div>
<div class="line">            <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">            (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.use_locally_conservative_discretization ?</div>
<div class="line">               static_cast&lt;<a class="code" href="coding__conventions__0_8txt.html#ad54c4de985d6d1b46aaf6ae96ae8d3a1">const</a> <a class="code" href="classFiniteElement.html">FiniteElement</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt; &amp;&gt;(</div>
<div class="line">                 <a class="code" href="classFE__DGP.html">FE_DGP</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree - 1)) :</div>
<div class="line">               static_cast&lt;<a class="code" href="coding__conventions__0_8txt.html#ad54c4de985d6d1b46aaf6ae96ae8d3a1">const</a> <a class="code" href="classFiniteElement.html">FiniteElement</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt; &amp;&gt;(</div>
<div class="line">                 <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree - 1))),</div>
<div class="line">            1)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  stokes_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  temperature_fe(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree)</div>
<div class="line">  , temperature_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  time_step(0)</div>
<div class="line">  , old_time_step(0)</div>
<div class="line">  , timestep_number(0)</div>
<div class="line">  , rebuild_stokes_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , rebuild_stokes_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , rebuild_temperature_matrices(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , rebuild_temperature_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  computing_timer(MPI_COMM_WORLD,</div>
<div class="line">                  pcout,</div>
<div class="line">                  <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div>
<div class="line">                  <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="TheBoussinesqFlowProblemhelperfunctions"></a> </p><h4>The BoussinesqFlowProblem helper functions</h4>
<p><a class="anchor" id="BoussinesqFlowProblemget_maximal_velocity"></a> </p><h5>BoussinesqFlowProblem::get_maximal_velocity</h5>
<p>Except for two small details, the function to compute the global maximum of the velocity is the same as in <a class="el" href="step_31.html">step-31</a>. The first detail is actually common to all functions that implement loops over all cells in the triangulation: When operating in parallel, each processor can only work on a chunk of cells since each processor only has a certain part of the entire triangulation. This chunk of cells that we want to work on is identified via a so-called <code>subdomain_id</code>, as we also did in <a class="el" href="step_18.html">step-18</a>. All we need to change is hence to perform the cell-related operations only on cells that are owned by the current process (as opposed to ghost or artificial cells), i.e. for which the subdomain id equals the number of the process ID. Since this is a commonly used operation, there is a shortcut for this operation: we can ask whether the cell is owned by the current processor using <code>cell-&gt;<a class="el" href="quadrature__point__data__0_8txt.html#a175634c053aca0ba3b25782a53938ea5">is_locally_owned()</a></code>.</p>
<p>The second difference is the way we calculate the maximum value. Before, we could simply have a <code>double</code> variable that we checked against on each quadrature point for each cell. Now, we have to be a bit more careful since each processor only operates on a subset of cells. What we do is to first let each processor calculate the maximum among its cells, and then do a global communication operation <code><a class="el" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a></code> that computes the maximum value among all the maximum values of the individual processors. MPI provides such a call, but it's even simpler to use the respective function in namespace <a class="el" href="namespaceUtilities_1_1MPI.html">Utilities::MPI</a> using the MPI communicator object since that will do the right thing even if we work without MPI and on a single machine only. The call to <code><a class="el" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a></code> needs two arguments, namely the local maximum (input) and the MPI communicator, which is MPI_COMM_WORLD in this example.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_maximal_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                          <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          stokes_fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_local_velocity = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                  velocity_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          max_local_velocity =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(max_local_velocity, MPI_COMM_WORLD);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_cfl_number"></a> </p><h5>BoussinesqFlowProblem::get_cfl_number</h5>
<p>The next function does something similar, but we now compute the CFL number, i.e., maximal velocity on a cell divided by the cell diameter. This number is necessary to determine the time step size, as we use a semi-explicit time stepping scheme for the temperature equation (see <a class="el" href="step_31.html">step-31</a> for a discussion). We compute it in the same way as above: Compute the local maximum over all locally owned cells, then exchange it via MPI to find the global maximum.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_cfl_number()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                          <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          stokes_fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_local_cfl = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                  velocity_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> max_local_velocity = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-10;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          max_local_velocity =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">        max_local_cfl =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_cfl, max_local_velocity / <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(max_local_cfl, MPI_COMM_WORLD);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_entropy_variation"></a> </p><h5>BoussinesqFlowProblem::get_entropy_variation</h5>
<p>Next comes the computation of the global entropy variation \(\|E(T)-\bar{E}(T)\|_\infty\) where the entropy \(E\) is defined as discussed in the introduction. This is needed for the evaluation of the stabilization in the temperature equation as explained in the introduction. The entropy variation is actually only needed if we use \(\alpha=2\) as a power in the residual computation. The infinity norm is computed by the maxima over quadrature points, as usual in discrete computations.</p>
<p>In order to compute this quantity, we first have to find the space-average \(\bar{E}(T)\) and then evaluate the maximum. However, that means that we would need to perform two loops. We can avoid the overhead by noting that \(\|E(T)-\bar{E}(T)\|_\infty = \max\big(E_{\textrm{max}}(T)-\bar{E}(T), \bar{E}(T)-E_{\textrm{min}}(T)\big)\), i.e., the maximum out of the deviation from the average entropy in positive and negative directions. The four quantities we need for the latter formula (maximum entropy, minimum entropy, average entropy, area) can all be evaluated in the same loop over all cells, so we choose this simpler variant.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_entropy_variation(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha != 2)</div>
<div class="line">    <span class="keywordflow">return</span> 1.;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 1);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>       fe_values(temperature_fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
</div><!-- fragment --><p>In the two functions above we computed the maximum of numbers that were all non-negative, so we knew that zero was certainly a lower bound. On the other hand, here we need to find the maximum deviation from the average value, i.e., we will need to know the maximal and minimal values of the entropy for which we don't a priori know the sign.</p>
<p>To compute it, we can therefore start with the largest and smallest possible values we can store in a double precision number: The minimum is initialized with a bigger and the maximum with a smaller number than any one that is going to appear. We are then guaranteed that these numbers will be overwritten in the loop on the first cell or, if this processor does not own any cells, in the communication step at the latest. The following loop then computes the minimum and maximum local entropy as well as keeps track of the area/volume of the part of the domain we locally own and the integral over the entropy on it:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> min_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">       max_entropy = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(), area = 0,</div>
<div class="line">       entropy_integrated = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">    {</div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                    old_temperature_values);</div>
<div class="line">      fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                    old_old_temperature_values);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> =</div>
<div class="line">            (old_temperature_values[q] + old_old_temperature_values[q]) / 2;</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> entropy =</div>
<div class="line">            ((<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> - average_temperature) * (<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> - average_temperature));</div>
<div class="line"> </div>
<div class="line">          min_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_entropy, entropy);</div>
<div class="line">          max_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_entropy, entropy);</div>
<div class="line">          area += fe_values.JxW(q);</div>
<div class="line">          entropy_integrated += fe_values.JxW(q) * entropy;</div>
<div class="line">        }</div>
<div class="line">    }</div>
</div><!-- fragment --><p>Now we only need to exchange data between processors: we need to sum the two integrals (<code>area</code>, <code>entropy_integrated</code>), and get the extrema for maximum and minimum. We could do this through four different data exchanges, but we can it with two: <a class="el" href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a> also exists in a variant that takes an array of values that are all to be summed up. And we can also utilize the <a class="el" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a> function by realizing that forming the minimum over the minimal entropies equals forming the negative of the maximum over the negative of the minimal entropies; this maximum can then be combined with forming the maximum over the maximal entropies.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> local_sums[2]   = {entropy_integrated, area},</div>
<div class="line">             local_maxima[2] = {-min_entropy, max_entropy};</div>
<div class="line"><span class="keywordtype">double</span> global_sums[2], global_maxima[2];</div>
<div class="line"> </div>
<div class="line"><a class="code" href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a>(local_sums, MPI_COMM_WORLD, global_sums);</div>
<div class="line"><a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(local_maxima, MPI_COMM_WORLD, global_maxima);</div>
</div><!-- fragment --><p>Having computed everything this way, we can then compute the average entropy and find the \(L^\infty\) norm by taking the larger of the deviation of the maximum or minimum from the average:</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> average_entropy = global_sums[0] / global_sums[1];</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> entropy_diff    = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(global_maxima[1] - average_entropy,</div>
<div class="line">                                       average_entropy - (-global_maxima[0]));</div>
<div class="line">  <span class="keywordflow">return</span> entropy_diff;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_extrapolated_temperature_range"></a> </p><h5>BoussinesqFlowProblem::get_extrapolated_temperature_range</h5>
<p>The next function computes the minimal and maximal value of the extrapolated temperature over the entire domain. Again, this is only a slightly modified version of the respective function in <a class="el" href="step_31.html">step-31</a>. As in the function above, we collect local minima and maxima and then compute the global extrema using the same trick as above.</p>
<p>As already discussed in <a class="el" href="step_31.html">step-31</a>, the function needs to distinguish between the first and all following time steps because it uses a higher order temperature extrapolation scheme when at least two previous time steps are available.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::pair&lt;double, double&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::get_extrapolated_temperature_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                          <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>       fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          temperature_fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> min_local_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">         max_local_temperature = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                          old_temperature_values);</div>
<div class="line">            fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                          old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> =</div>
<div class="line">                  (1. + time_step / old_time_step) *</div>
<div class="line">                    old_temperature_values[q] -</div>
<div class="line">                  time_step / old_time_step * old_old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">                min_local_temperature =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                max_local_temperature =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                          old_temperature_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> = old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">                min_local_temperature =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                max_local_temperature =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> local_extrema[2] = {-min_local_temperature, max_local_temperature};</div>
<div class="line">  <span class="keywordtype">double</span> global_extrema[2];</div>
<div class="line">  <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(local_extrema, MPI_COMM_WORLD, global_extrema);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> std::make_pair(-global_extrema[0], global_extrema[1]);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemcompute_viscosity"></a> </p><h5>BoussinesqFlowProblem::compute_viscosity</h5>
<p>The function that calculates the viscosity is purely local and so needs no communication at all. It is mostly the same as in <a class="el" href="step_31.html">step-31</a> but with an updated formulation of the viscosity if \(\alpha=2\) is chosen:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_temperature,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_old_temperature,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_temperature_grads,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_old_temperature_grads,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_temperature_laplacians,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_old_temperature_laplacians,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_velocity_values,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_old_velocity_values,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_strain_rates,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_old_strain_rates,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_u_infty,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_T_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                                average_temperature,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_entropy_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                                cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (global_u_infty == 0)</div>
<div class="line">    <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 * cell_diameter;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_temperature.size();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_residual = 0;</div>
<div class="line">  <span class="keywordtype">double</span> max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u =</div>
<div class="line">        (old_velocity_values[q] + old_old_velocity_values[q]) / 2;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> strain_rate =</div>
<div class="line">        (old_strain_rates[q] + old_old_strain_rates[q]) / 2;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> = (old_temperature[q] + old_old_temperature[q]) / 2;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> dT_dt =</div>
<div class="line">        (old_temperature[q] - old_old_temperature[q]) / old_time_step;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_T =</div>
<div class="line">        u * (old_temperature_grads[q] + old_old_temperature_grads[q]) / 2;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> kappa_Delta_T =</div>
<div class="line">        <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> *</div>
<div class="line">        (old_temperature_laplacians[q] + old_old_temperature_laplacians[q]) /</div>
<div class="line">        2;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> =</div>
<div class="line">        ((<a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">EquationData::radiogenic_heating</a> * <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>) +</div>
<div class="line">          2 * <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * strain_rate * strain_rate) /</div>
<div class="line">         (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>) * <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">EquationData::specific_heat</a>));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> = <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>(dT_dt + u_grad_T - kappa_Delta_T - <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a>);</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha == 2)</div>
<div class="line">        <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> *= <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> - average_temperature);</div>
<div class="line"> </div>
<div class="line">      max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">      max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u * u), max_velocity);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> max_viscosity =</div>
<div class="line">    (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_beta * max_velocity * cell_diameter);</div>
<div class="line">  <span class="keywordflow">if</span> (timestep_number == 0)</div>
<div class="line">    <span class="keywordflow">return</span> max_viscosity;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(old_time_step &gt; 0, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> entropy_viscosity;</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha == 2)</div>
<div class="line">        entropy_viscosity =</div>
<div class="line">          (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_c_R * cell_diameter * cell_diameter *</div>
<div class="line">           max_residual / global_entropy_variation);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        entropy_viscosity =</div>
<div class="line">          (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_c_R * cell_diameter *</div>
<div class="line">           global_Omega_diameter * max_velocity * max_residual /</div>
<div class="line">           (global_u_infty * global_T_variation));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(max_viscosity, entropy_viscosity);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TheBoussinesqFlowProblemsetupfunctions"></a> </p><h4>The BoussinesqFlowProblem setup functions</h4>
<p>The following three functions set up the Stokes matrix, the matrix used for the Stokes preconditioner, and the temperature matrix. The code is mostly the same as in <a class="el" href="step_31.html">step-31</a>, but it has been broken out into three functions of their own for simplicity.</p>
<p>The main functional difference between the code here and that in <a class="el" href="step_31.html">step-31</a> is that the matrices we want to set up are distributed across multiple processors. Since we still want to build up the sparsity pattern first for efficiency reasons, we could continue to build the <em>entire</em> sparsity pattern as a <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a>, as we did in <a class="el" href="step_31.html">step-31</a>. However, that would be inefficient: every processor would build the same sparsity pattern, but only initialize a small part of the matrix using it. It also violates the principle that every processor should only work on those cells it owns (and, if necessary the layer of ghost cells around it).</p>
<p>Rather, we use an object of type <a class="el" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a>, which is (obviously) a wrapper around a sparsity pattern object provided by Trilinos. The advantage is that the Trilinos sparsity pattern class can communicate across multiple processors: if this processor fills in all the nonzero entries that result from the cells it owns, and every other processor does so as well, then at the end after some MPI communication initiated by the <code><a class="el" href="namespaceUtilities.html#a6155277fd058eddb1504f9562cb1c04d">compress()</a></code> call, we will have the globally assembled sparsity pattern available with which the global matrix can be initialized.</p>
<p>There is one important aspect when initializing Trilinos sparsity patterns in parallel: In addition to specifying the locally owned rows and columns of the matrices via the <code>stokes_partitioning</code> index set, we also supply information about all the rows we are possibly going to write into when assembling on a certain processor. The set of locally relevant rows contains all such rows (possibly also a few unnecessary ones, but it is difficult to find the exact row indices before actually getting indices on all cells and resolving constraints). This additional information allows to exactly determine the structure for the off-processor data found during assembly. While Trilinos matrices are able to collect this information on the fly as well (when initializing them from some other reinit method), it is less efficient and leads to problems when assembling matrices with multiple threads. In this program, we pessimistically assume that only one processor at a time can write into the matrix while assembly (whereas the computation is parallel), which is fine for Trilinos matrices. In practice, one can do better by hinting <a class="el" href="namespaceWorkStream.html">WorkStream</a> at cells that do not share vertices, allowing for parallelism among those cells (see the graph coloring algorithms and <a class="el" href="namespaceWorkStream.html">WorkStream</a> with colored iterators argument). However, that only works when only one MPI processor is present because Trilinos' internal data structures for accumulating off-processor data on the fly are not thread safe. With the initialization presented here, there is no such problem and one could safely introduce graph coloring for this algorithm.</p>
<p>The only other change we need to make is to tell the <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern()</a> function that it is only supposed to work on a subset of cells, namely the ones whose <code>subdomain_id</code> equals the number of the current processor, and to ignore all other cells.</p>
<p>This strategy is replicated across all three of the following functions.</p>
<p>Note that Trilinos matrices store the information contained in the sparsity patterns, so we can safely release the <code>sp</code> variable once the matrix has been given the sparsity structure.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_stokes_matrix(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning)</div>
<div class="line">{</div>
<div class="line">  stokes_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> sp(stokes_partitioning,</div>
<div class="line">                                            stokes_partitioning,</div>
<div class="line">                                            stokes_relevant_partitioning,</div>
<div class="line">                                            MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(stokes_dof_handler,</div>
<div class="line">                                  coupling,</div>
<div class="line">                                  sp,</div>
<div class="line">                                  stokes_constraints,</div>
<div class="line">                                  <span class="keyword">false</span>,</div>
<div class="line">                                  <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                    MPI_COMM_WORLD));</div>
<div class="line">  sp.compress();</div>
<div class="line"> </div>
<div class="line">  stokes_matrix.reinit(sp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning)</div>
<div class="line">{</div>
<div class="line">  Amg_preconditioner.reset();</div>
<div class="line">  Mp_preconditioner.reset();</div>
<div class="line"> </div>
<div class="line">  stokes_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> sp(stokes_partitioning,</div>
<div class="line">                                            stokes_partitioning,</div>
<div class="line">                                            stokes_relevant_partitioning,</div>
<div class="line">                                            MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(stokes_dof_handler,</div>
<div class="line">                                  coupling,</div>
<div class="line">                                  sp,</div>
<div class="line">                                  stokes_constraints,</div>
<div class="line">                                  <span class="keyword">false</span>,</div>
<div class="line">                                  <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                    MPI_COMM_WORLD));</div>
<div class="line">  sp.compress();</div>
<div class="line"> </div>
<div class="line">  stokes_preconditioner_matrix.reinit(sp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_temperature_matrices(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_partitioner,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_relevant_partitioner)</div>
<div class="line">{</div>
<div class="line">  T_preconditioner.reset();</div>
<div class="line">  temperature_mass_matrix.clear();</div>
<div class="line">  temperature_stiffness_matrix.clear();</div>
<div class="line">  temperature_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> sp(temperature_partitioner,</div>
<div class="line">                                       temperature_partitioner,</div>
<div class="line">                                       temperature_relevant_partitioner,</div>
<div class="line">                                       MPI_COMM_WORLD);</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(temperature_dof_handler,</div>
<div class="line">                                  sp,</div>
<div class="line">                                  temperature_constraints,</div>
<div class="line">                                  <span class="keyword">false</span>,</div>
<div class="line">                                  <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                    MPI_COMM_WORLD));</div>
<div class="line">  sp.compress();</div>
<div class="line"> </div>
<div class="line">  temperature_matrix.reinit(sp);</div>
<div class="line">  temperature_mass_matrix.reinit(sp);</div>
<div class="line">  temperature_stiffness_matrix.reinit(sp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The remainder of the setup function (after splitting out the three functions above) mostly has to deal with the things we need to do for parallelization across processors. Because setting all of this up is a significant compute time expense of the program, we put everything we do here into a timer group so that we can get summary information about the fraction of time spent in this part of the program at its end.</p>
<p>At the top as usual we enumerate degrees of freedom and sort them by component/block, followed by writing their numbers to the screen from processor zero. The DoFHandler::distributed_dofs() function, when applied to a <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a> object, sorts degrees of freedom in such a way that all degrees of freedom associated with subdomain zero come before all those associated with subdomain one, etc. For the Stokes part, this entails, however, that velocities and pressures become intermixed, but this is trivially solved by sorting again by blocks; it is worth noting that this latter operation leaves the relative ordering of all velocities and pressures alone, i.e. within the velocity block we will still have all those associated with subdomain zero before all velocities associated with subdomain one, etc. This is important since we store each of the blocks of this matrix distributed across all processors and want this to be done in such a way that each processor stores that part of the matrix that is roughly equal to the degrees of freedom located on those cells that it will actually work on.</p>
<p>When printing the numbers of degrees of freedom, note that these numbers are going to be large if we use many processors. Consequently, we let the stream put a comma separator in between every three digits. The state of the stream, using the locale, is saved from before to after this operation. While slightly opaque, the code works because the default locale (which we get using the constructor call <code>std::locale("")</code>) implies printing numbers with a comma separator for every third digit (i.e., thousands, millions, billions).</p>
<p>In this function as well as many below, we measure how much time we spend here and collect that in a section called "Setup dof
 systems" across function invocations. This is done using an <a class="el" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> object that gets a timer going in the section with above name of the <code>computing_timer</code> object upon construction of the local variable; the timer is stopped again when the destructor of the <code>timing_section</code> variable is called. This, of course, happens either at the end of the function, or if we leave the function through a <code>return</code> statement or when an exception is thrown somewhere &ndash; in other words, whenever we leave this function in any way. The use of such "scope" objects therefore makes sure that we do not have to manually add code that tells the timer to stop at every location where this function may be left.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing_section(computing_timer, <span class="stringliteral">&quot;Setup dof systems&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  stokes_dof_handler.distribute_dofs(stokes_fe);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;unsigned int&gt; stokes_sub_blocks(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">  stokes_sub_blocks[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">  temperature_dof_handler.distribute_dofs(temperature_fe);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; stokes_dofs_per_block =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = stokes_dofs_per_block[0],</div>
<div class="line">                     n_p = stokes_dofs_per_block[1],</div>
<div class="line">                     n_T = temperature_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">  std::locale <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> = pcout.get_stream().getloc();</div>
<div class="line">  pcout.get_stream().imbue(std::locale(<span class="stringliteral">&quot;&quot;</span>));</div>
<div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_global_active_cells()</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_T &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; n_u</div>
<div class="line">        &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_T &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">        &lt;&lt; std::endl;</div>
<div class="line">  pcout.get_stream().imbue(<a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>);</div>
</div><!-- fragment --><p>After this, we have to set up the various partitioners (of type <code><a class="el" href="classIndexSet.html">IndexSet</a></code>, see the introduction) that describe which parts of each matrix or vector will be stored where, then call the functions that actually set up the matrices, and at the end also resize the various vectors we keep around in this program.</p>
<div class="fragment"><div class="line">std::vector&lt;IndexSet&gt; stokes_partitioning, stokes_relevant_partitioning;</div>
<div class="line"><a class="code" href="classIndexSet.html">IndexSet</a>              temperature_partitioning(n_T),</div>
<div class="line">  temperature_relevant_partitioning(n_T);</div>
<div class="line"><a class="code" href="classIndexSet.html">IndexSet</a> stokes_relevant_set;</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> stokes_index_set = stokes_dof_handler.locally_owned_dofs();</div>
<div class="line">  stokes_partitioning.push_back(stokes_index_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div>
<div class="line">  stokes_partitioning.push_back(stokes_index_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(stokes_dof_handler,</div>
<div class="line">                                          stokes_relevant_set);</div>
<div class="line">  stokes_relevant_partitioning.push_back(</div>
<div class="line">    stokes_relevant_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div>
<div class="line">  stokes_relevant_partitioning.push_back(</div>
<div class="line">    stokes_relevant_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div>
<div class="line"> </div>
<div class="line">  temperature_partitioning = temperature_dof_handler.locally_owned_dofs();</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(</div>
<div class="line">    temperature_dof_handler, temperature_relevant_partitioning);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Following this, we can compute constraints for the solution vectors, including hanging node constraints and homogeneous and inhomogeneous boundary values for the Stokes and temperature fields. Note that as for everything else, the constraint objects can not hold <em>all</em> constraints on every processor. Rather, each processor needs to store only those that are actually necessary for correctness given that it only assembles linear systems on cells it owns. As discussed in the <a class="el" href="DEALGlossary.html#distributed_paper">this paper</a>, the set of constraints we need to know about is exactly the set of constraints on all locally relevant degrees of freedom, so this is what we use to initialize the constraint objects.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  stokes_constraints.clear();</div>
<div class="line">  stokes_constraints.reinit(stokes_relevant_set);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                          stokes_constraints);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocity_components(0);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">    stokes_dof_handler,</div>
<div class="line">    0,</div>
<div class="line">    <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1),</div>
<div class="line">    stokes_constraints,</div>
<div class="line">    stokes_fe.component_mask(velocity_components));</div>
<div class="line"> </div>
<div class="line">  std::set&lt;types::boundary_id&gt; no_normal_flux_boundaries;</div>
<div class="line">  no_normal_flux_boundaries.insert(1);</div>
<div class="line">  <a class="code" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                                  0,</div>
<div class="line">                                                  no_normal_flux_boundaries,</div>
<div class="line">                                                  stokes_constraints,</div>
<div class="line">                                                  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>);</div>
<div class="line">  stokes_constraints.close();</div>
<div class="line">}</div>
<div class="line">{</div>
<div class="line">  temperature_constraints.clear();</div>
<div class="line">  temperature_constraints.reinit(temperature_relevant_partitioning);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(temperature_dof_handler,</div>
<div class="line">                                          temperature_constraints);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">    temperature_dof_handler,</div>
<div class="line">    0,</div>
<div class="line">    EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">    temperature_constraints);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">    temperature_dof_handler,</div>
<div class="line">    1,</div>
<div class="line">    EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">    temperature_constraints);</div>
<div class="line">  temperature_constraints.close();</div>
<div class="line">}</div>
</div><!-- fragment --><p>All this done, we can then initialize the various matrix and vector objects to their proper sizes. At the end, we also record that all matrices and preconditioners have to be re-computed at the beginning of the next time step. Note how we initialize the vectors for the Stokes and temperature right hand sides: These are writable vectors (last boolean argument set to <code>true</code>) that have the correct one-to-one partitioning of locally owned elements but are still given the relevant partitioning for means of figuring out the vector entries that are going to be set right away. As for matrices, this allows for writing local contributions into the vector with multiple threads (always assuming that the same vector entry is not accessed by multiple threads at the same time). The other vectors only allow for read access of individual elements, including ghosts, but are not suitable for solvers.</p>
<div class="fragment"><div class="line">  setup_stokes_matrix(stokes_partitioning, stokes_relevant_partitioning);</div>
<div class="line">  setup_stokes_preconditioner(stokes_partitioning,</div>
<div class="line">                              stokes_relevant_partitioning);</div>
<div class="line">  setup_temperature_matrices(temperature_partitioning,</div>
<div class="line">                             temperature_relevant_partitioning);</div>
<div class="line"> </div>
<div class="line">  stokes_rhs.reinit(stokes_partitioning,</div>
<div class="line">                    stokes_relevant_partitioning,</div>
<div class="line">                    MPI_COMM_WORLD,</div>
<div class="line">                    <span class="keyword">true</span>);</div>
<div class="line">  stokes_solution.reinit(stokes_relevant_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_stokes_solution.reinit(stokes_solution);</div>
<div class="line"> </div>
<div class="line">  temperature_rhs.reinit(temperature_partitioning,</div>
<div class="line">                         temperature_relevant_partitioning,</div>
<div class="line">                         MPI_COMM_WORLD,</div>
<div class="line">                         <span class="keyword">true</span>);</div>
<div class="line">  temperature_solution.reinit(temperature_relevant_partitioning,</div>
<div class="line">                              MPI_COMM_WORLD);</div>
<div class="line">  old_temperature_solution.reinit(temperature_solution);</div>
<div class="line">  old_old_temperature_solution.reinit(temperature_solution);</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_matrix              = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_stokes_preconditioner      = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_temperature_matrices       = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_temperature_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TheBoussinesqFlowProblemassemblyfunctions"></a> </p><h4>The BoussinesqFlowProblem assembly functions</h4>
<p>Following the discussion in the introduction and in the <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing</a> module, we split the assembly functions into different parts:</p>
<ul>
<li>
<p class="startli">The local calculations of matrices and right hand sides, given a certain cell as input (these functions are named <code>local_assemble_*</code> below). The resulting function is, in other words, essentially the body of the loop over all cells in <a class="el" href="step_31.html">step-31</a>. Note, however, that these functions store the result from the local calculations in variables of classes from the <a class="el" href="structCopyData.html">CopyData</a> namespace.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">These objects are then given to the second step which writes the local data into the global data structures (these functions are named <code>copy_local_to_global_*</code> below). These functions are pretty trivial.</p>
<p class="endli"></p>
</li>
<li>
These two subfunctions are then used in the respective assembly routine (called <code>assemble_*</code> below), where a <a class="el" href="namespaceWorkStream.html">WorkStream</a> object is set up and runs over all the cells that belong to the processor's subdomain. </li>
</ul>
<p><a class="anchor" id="Stokespreconditionerassembly"></a> </p><h5>Stokes preconditioner assembly</h5>
<p>Let us start with the functions that builds the Stokes preconditioner. The first two of these are pretty trivial, given the discussion above. Note in particular that the main point in using the scratch data object is that we want to avoid allocating any objects on the free space each time we visit a new cell. As a consequence, the assembly function below only has automatic local variables, and everything else is accessed through the scratch data object, which is allocated only once before we start the loop over all cells:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">  Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">    scratch.stokes_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">  scratch.stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">        {</div>
<div class="line">          scratch.grad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">            scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          scratch.phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> *</div>
<div class="line">               <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(scratch.grad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>], scratch.grad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) +</div>
<div class="line">             (1. / <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a>) * <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> *</div>
<div class="line">               <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> *</div>
<div class="line">               (scratch.phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])) *</div>
<div class="line">            scratch.stokes_fe_values.JxW(q);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix,</div>
<div class="line">                                                <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                stokes_preconditioner_matrix);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now for the function that actually puts things together, using the <a class="el" href="namespaceWorkStream.html">WorkStream</a> functions. <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> needs a start and end iterator to enumerate the cells it is supposed to work on. Typically, one would use <a class="el" href="classDoFHandler.html#a9a3bef554c6d22abe312e10e9475eecf">DoFHandler::begin_active()</a> and <a class="el" href="classDoFHandler.html#a042c4bf0f59fef5e72dbcfbdd56b2782">DoFHandler::end()</a> for that but here we actually only want the subset of cells that in fact are owned by the current processor. This is where the <a class="el" href="classFilteredIterator.html">FilteredIterator</a> class comes into play: you give it a range of cells and it provides an iterator that only iterates over that subset of cells that satisfy a certain predicate (a predicate is a function of one argument that either returns true or false). The predicate we use here is <a class="el" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>, i.e., it returns true exactly if the cell is owned by the current processor. The resulting iterator range is then exactly what we need.</p>
<p>With this obstacle out of the way, we call the <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> function with this set of cells, scratch and copy objects, and with pointers to two functions: the local assembly and copy-local-to-global function. These functions need to have very specific signatures: three arguments in the first and one argument in the latter case (see the documentation of the <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> function for the meaning of these arguments). Note how we use a lambda functions to create a function object that satisfies this requirement. It uses function arguments for the local assembly function that specify cell, scratch data, and copy data, as well as function argument for the copy function that expects the data to be written into the global matrix (also see the discussion in <a class="el" href="step_13.html">step-13</a>'s <code>assemble_linear_system()</code> function). On the other hand, the implicit zeroth argument of member functions (namely the <code>this</code> pointer of the object on which that member function is to operate on) is <em>bound</em> to the <code>this</code> pointer of the current function and is captured. The <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> function, as a consequence, does not need to know anything about the object these functions work on.</p>
<p>When the <a class="el" href="namespaceWorkStream.html">WorkStream</a> is executed, it will create several local assembly routines of the first kind for several cells and let some available processors work on them. The function that needs to be synchronized, i.e., the write operation into the global matrix, however, is executed by only one thread at a time in the prescribed order. Of course, this only holds for the parallelization on a single MPI process. Different MPI processes will have their own <a class="el" href="namespaceWorkStream.html">WorkStream</a> objects and do that work completely independently (and in different memory spaces). In a distributed calculation, some data will accumulate at degrees of freedom that are not owned by the respective processor. It would be inefficient to send data around every time we encounter such a dof. What happens instead is that the Trilinos sparse matrix will keep that data and send it to the owner at the end of assembly, by calling the <code><a class="el" href="namespaceUtilities.html#a6155277fd058eddb1504f9562cb1c04d">compress()</a></code> command.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_preconditioner()</div>
<div class="line">{</div>
<div class="line">  stokes_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using</span> CellFilter =</div>
<div class="line">    <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> worker =</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">           Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">           Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;local_assemble_stokes_preconditioner(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, scratch, <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a> =</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;copy_local_to_global_stokes_preconditioner(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                             stokes_dof_handler.begin_active()),</div>
<div class="line">                  CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                             stokes_dof_handler.end()),</div>
<div class="line">                  worker,</div>
<div class="line">                  <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a>,</div>
<div class="line">                  Assembly::Scratch::StokesPreconditioner&lt;dim&gt;(</div>
<div class="line">                    stokes_fe,</div>
<div class="line">                    quadrature_formula,</div>
<div class="line">                    <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>),</div>
<div class="line">                  Assembly::CopyData::StokesPreconditioner&lt;dim&gt;(stokes_fe));</div>
<div class="line"> </div>
<div class="line">  stokes_preconditioner_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The final function in this block initiates assembly of the Stokes preconditioner matrix and then in fact builds the Stokes preconditioner. It is mostly the same as in the serial case. The only difference to <a class="el" href="step_31.html">step-31</a> is that we use a Jacobi preconditioner for the pressure mass matrix instead of IC, as discussed in the introduction.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::build_stokes_preconditioner()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_preconditioner == <span class="keyword">false</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                   <span class="stringliteral">&quot;   Build Stokes preconditioner&quot;</span>);</div>
<div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding Stokes preconditioner...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">  assemble_stokes_preconditioner();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;std::vector&lt;bool&gt;</a>&gt; constant_modes;</div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocity_components(0);</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>(stokes_dof_handler,</div>
<div class="line">                                   stokes_fe.component_mask(</div>
<div class="line">                                     velocity_components),</div>
<div class="line">                                   constant_modes);</div>
<div class="line"> </div>
<div class="line">  Mp_preconditioner =</div>
<div class="line">    std::make_shared&lt;TrilinosWrappers::PreconditionJacobi&gt;();</div>
<div class="line">  Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionAMG&gt;();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a> Amg_data;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">constant_modes</a>        = constant_modes;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">elliptic</a>              = <span class="keyword">true</span>;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">higher_order_elements</a> = <span class="keyword">true</span>;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">smoother_sweeps</a>       = 2;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">aggregation_threshold</a> = 0.02;</div>
<div class="line"> </div>
<div class="line">  Mp_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(1, 1));</div>
<div class="line">  Amg_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(0, 0),</div>
<div class="line">                                 Amg_data);</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_preconditioner = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  pcout &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Stokessystemassembly"></a> </p><h5>Stokes system assembly</h5>
<p>The next three functions implement the assembly of the Stokes system, again split up into a part performing local calculations, one for writing the local data into the global matrix and vector, and one for actually running the loop over all cells with the help of the <a class="el" href="namespaceWorkStream.html">WorkStream</a> class. Note that the assembly of the Stokes matrix needs only to be done in case we have changed the mesh. Otherwise, just the (temperature-dependent) right hand side needs to be calculated here. Since we are working with distributed matrices and vectors, we have to call the respective <code><a class="el" href="namespaceUtilities.html#a6155277fd058eddb1504f9562cb1c04d">compress()</a></code> functions in the end of the assembly in order to send non-local data to the owner process.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_stokes_system(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">  Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">    scratch.stokes_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">    scratch.stokes_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">  scratch.stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> temperature_cell(</div>
<div class="line">    &amp;<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level(), <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;index(), &amp;temperature_dof_handler);</div>
<div class="line">  scratch.temperature_fe_values.reinit(temperature_cell);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix = 0;</div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs = 0;</div>
<div class="line"> </div>
<div class="line">  scratch.temperature_fe_values.get_function_values(</div>
<div class="line">    old_temperature_solution, scratch.old_temperature_values);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> old_temperature = scratch.old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">        {</div>
<div class="line">          scratch.phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">            {</div>
<div class="line">              scratch.grads_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              scratch.div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              scratch.phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                scratch.stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">            <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">              (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * 2 *</div>
<div class="line">                 (scratch.grads_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.grads_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) -</div>
<div class="line">               (<a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> * scratch.div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">                scratch.phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) -</div>
<div class="line">               (<a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> * scratch.phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">                scratch.div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])) *</div>
<div class="line">              scratch.stokes_fe_values.JxW(q);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> gravity = <a class="code" href="namespaceStep32_1_1EquationData.html#a7c001f60e6c7c0bcd347e3f7b66a5402">EquationData::gravity_vector</a>(</div>
<div class="line">        scratch.stokes_fe_values.quadrature_point(q));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(old_temperature) *</div>
<div class="line">                              gravity * scratch.phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) *</div>
<div class="line">                             scratch.stokes_fe_values.JxW(q);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_stokes_system(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">    stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix,</div>
<div class="line">                                                  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                  stokes_matrix,</div>
<div class="line">                                                  stokes_rhs);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                  stokes_rhs);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_system()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                   <span class="stringliteral">&quot;   Assemble Stokes system&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">    stokes_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  stokes_rhs = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using</span> CellFilter =</div>
<div class="line">    <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(</div>
<div class="line">    CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">               stokes_dof_handler.begin_active()),</div>
<div class="line">    CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(), stokes_dof_handler.end()),</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">           Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">           Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;local_assemble_stokes_system(cell, scratch, data);</div>
<div class="line">    },</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;copy_local_to_global_stokes_system(data);</div>
<div class="line">    },</div>
<div class="line">    Assembly::Scratch::StokesSystem&lt;dim&gt;(</div>
<div class="line">      stokes_fe,</div>
<div class="line">      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">      quadrature_formula,</div>
<div class="line">      (<a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">       (rebuild_stokes_matrix == <span class="keyword">true</span> ? <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> : <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>(0))),</div>
<div class="line">      temperature_fe,</div>
<div class="line">      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>),</div>
<div class="line">    Assembly::CopyData::StokesSystem&lt;dim&gt;(stokes_fe));</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">    stokes_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">  stokes_rhs.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_matrix = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  pcout &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Temperaturematrixassembly"></a> </p><h5>Temperature matrix assembly</h5>
<p>The task to be performed by the next three functions is to calculate a mass matrix and a Laplace matrix on the temperature system. These will be combined in order to yield the semi-implicit time stepping matrix that consists of the mass matrix plus a time step-dependent weight factor times the Laplace matrix. This function is again essentially the body of the loop over all cells from <a class="el" href="step_31.html">step-31</a>.</p>
<p>The two following functions perform similar services as the ones above.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_temperature_matrix(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">  Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">    scratch.temperature_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">    scratch.temperature_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">  scratch.temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix      = 0;</div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">        {</div>
<div class="line">          scratch.grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">            scratch.temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          scratch.phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">              (scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">               scratch.temperature_fe_values.JxW(q));</div>
<div class="line">            <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">              (<a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> * scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">               scratch.grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] * scratch.temperature_fe_values.JxW(q));</div>
<div class="line">          }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_temperature_matrix(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  temperature_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix,</div>
<div class="line">                                                     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                     temperature_mass_matrix);</div>
<div class="line">  temperature_constraints.distribute_local_to_global(</div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix,</div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">    temperature_stiffness_matrix);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_matrix()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_temperature_matrices == <span class="keyword">false</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                   <span class="stringliteral">&quot;   Assemble temperature matrices&quot;</span>);</div>
<div class="line">  temperature_mass_matrix      = 0;</div>
<div class="line">  temperature_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using</span> CellFilter =</div>
<div class="line">    <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(</div>
<div class="line">    CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">               temperature_dof_handler.begin_active()),</div>
<div class="line">    CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">               temperature_dof_handler.end()),</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">           Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">           Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;local_assemble_temperature_matrix(cell, scratch, data);</div>
<div class="line">    },</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;copy_local_to_global_temperature_matrix(data);</div>
<div class="line">    },</div>
<div class="line">    Assembly::Scratch::TemperatureMatrix&lt;dim&gt;(temperature_fe,</div>
<div class="line">                                              <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                              quadrature_formula),</div>
<div class="line">    Assembly::CopyData::TemperatureMatrix&lt;dim&gt;(temperature_fe));</div>
<div class="line"> </div>
<div class="line">  temperature_mass_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">  temperature_stiffness_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line"> </div>
<div class="line">  rebuild_temperature_matrices       = <span class="keyword">false</span>;</div>
<div class="line">  rebuild_temperature_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Temperaturerighthandsideassembly"></a> </p><h5>Temperature right hand side assembly</h5>
<p>This is the last assembly function. It calculates the right hand side of the temperature system, which includes the convection and the stabilization terms. It includes a lot of evaluations of old solutions at the quadrature points (which are necessary for calculating the artificial viscosity of stabilization), but is otherwise similar to the other assembly functions. Notice, once again, how we resolve the dilemma of having inhomogeneous boundary conditions, by just making a right hand side at this point (compare the comments for the <code><a class="el" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">project()</a></code> function above): We create some matrix columns with exactly the values that would be entered for the temperature stiffness matrix, in case we have inhomogeneously constrained dofs. That will account for the correct balance of the right hand side vector with the matrix system of temperature.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_temperature_rhs(</div>
<div class="line">  <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_velocity,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_entropy_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">  Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">    scratch.temperature_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">    scratch.temperature_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs     = 0;</div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc = 0;</div>
<div class="line">  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line"> </div>
<div class="line">  scratch.temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> stokes_cell(</div>
<div class="line">    &amp;<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level(), <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;index(), &amp;stokes_dof_handler);</div>
<div class="line">  scratch.stokes_fe_values.reinit(stokes_cell);</div>
<div class="line"> </div>
<div class="line">  scratch.temperature_fe_values.get_function_values(</div>
<div class="line">    old_temperature_solution, scratch.old_temperature_values);</div>
<div class="line">  scratch.temperature_fe_values.get_function_values(</div>
<div class="line">    old_old_temperature_solution, scratch.old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">  scratch.temperature_fe_values.get_function_gradients(</div>
<div class="line">    old_temperature_solution, scratch.old_temperature_grads);</div>
<div class="line">  scratch.temperature_fe_values.get_function_gradients(</div>
<div class="line">    old_old_temperature_solution, scratch.old_old_temperature_grads);</div>
<div class="line"> </div>
<div class="line">  scratch.temperature_fe_values.get_function_laplacians(</div>
<div class="line">    old_temperature_solution, scratch.old_temperature_laplacians);</div>
<div class="line">  scratch.temperature_fe_values.get_function_laplacians(</div>
<div class="line">    old_old_temperature_solution, scratch.old_old_temperature_laplacians);</div>
<div class="line"> </div>
<div class="line">  scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">    stokes_solution, scratch.old_velocity_values);</div>
<div class="line">  scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">    old_stokes_solution, scratch.old_old_velocity_values);</div>
<div class="line">  scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_symmetric_gradients(</div>
<div class="line">    stokes_solution, scratch.old_strain_rates);</div>
<div class="line">  scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_symmetric_gradients(</div>
<div class="line">    old_stokes_solution, scratch.old_old_strain_rates);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">    compute_viscosity(scratch.old_temperature_values,</div>
<div class="line">                      scratch.old_old_temperature_values,</div>
<div class="line">                      scratch.old_temperature_grads,</div>
<div class="line">                      scratch.old_old_temperature_grads,</div>
<div class="line">                      scratch.old_temperature_laplacians,</div>
<div class="line">                      scratch.old_old_temperature_laplacians,</div>
<div class="line">                      scratch.old_velocity_values,</div>
<div class="line">                      scratch.old_old_velocity_values,</div>
<div class="line">                      scratch.old_strain_rates,</div>
<div class="line">                      scratch.old_old_strain_rates,</div>
<div class="line">                      global_max_velocity,</div>
<div class="line">                      global_T_range.second - global_T_range.first,</div>
<div class="line">                      0.5 * (global_T_range.second + global_T_range.first),</div>
<div class="line">                      global_entropy_variation,</div>
<div class="line">                      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">        {</div>
<div class="line">          scratch.phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          scratch.grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">            scratch.temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> T_term_for_rhs =</div>
<div class="line">        (use_bdf2_scheme ?</div>
<div class="line">           (scratch.old_temperature_values[q] *</div>
<div class="line">              (1 + time_step / old_time_step) -</div>
<div class="line">            scratch.old_old_temperature_values[q] * (time_step * time_step) /</div>
<div class="line">              (old_time_step * (time_step + old_time_step))) :</div>
<div class="line">           scratch.old_temperature_values[q]);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> ext_T =</div>
<div class="line">        (use_bdf2_scheme ? (scratch.old_temperature_values[q] *</div>
<div class="line">                              (1 + time_step / old_time_step) -</div>
<div class="line">                            scratch.old_old_temperature_values[q] *</div>
<div class="line">                              time_step / old_time_step) :</div>
<div class="line">                           scratch.old_temperature_values[q]);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> ext_grad_T =</div>
<div class="line">        (use_bdf2_scheme ? (scratch.old_temperature_grads[q] *</div>
<div class="line">                              (1 + time_step / old_time_step) -</div>
<div class="line">                            scratch.old_old_temperature_grads[q] * time_step /</div>
<div class="line">                              old_time_step) :</div>
<div class="line">                           scratch.old_temperature_grads[q]);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> extrapolated_u =</div>
<div class="line">        (use_bdf2_scheme ?</div>
<div class="line">           (scratch.old_velocity_values[q] * (1 + time_step / old_time_step) -</div>
<div class="line">            scratch.old_old_velocity_values[q] * time_step / old_time_step) :</div>
<div class="line">           scratch.old_velocity_values[q]);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> extrapolated_strain_rate =</div>
<div class="line">        (use_bdf2_scheme ?</div>
<div class="line">           (scratch.old_strain_rates[q] * (1 + time_step / old_time_step) -</div>
<div class="line">            scratch.old_old_strain_rates[q] * time_step / old_time_step) :</div>
<div class="line">           scratch.old_strain_rates[q]);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> =</div>
<div class="line">        ((<a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">EquationData::radiogenic_heating</a> * <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(ext_T) +</div>
<div class="line">          2 * <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * extrapolated_strain_rate *</div>
<div class="line">            extrapolated_strain_rate) /</div>
<div class="line">         (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(ext_T) * <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">EquationData::specific_heat</a>));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">            (T_term_for_rhs * scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">             time_step * extrapolated_u * ext_grad_T * scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">             time_step * nu * ext_grad_T * scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] +</div>
<div class="line">             time_step * <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> * scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) *</div>
<div class="line">            scratch.temperature_fe_values.JxW(q);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> (temperature_constraints.is_inhomogeneously_constrained(</div>
<div class="line">                <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]))</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  (scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">                     (use_bdf2_scheme ? ((2 * time_step + old_time_step) /</div>
<div class="line">                                         (time_step + old_time_step)) :</div>
<div class="line">                                        1.) +</div>
<div class="line">                   scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">                     <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> * time_step) *</div>
<div class="line">                  scratch.temperature_fe_values.JxW(q);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_temperature_rhs(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  temperature_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                     temperature_rhs,</div>
<div class="line">                                                     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc);</div>
<div class="line">}</div>
</div><!-- fragment --><p>In the function that runs the <a class="el" href="namespaceWorkStream.html">WorkStream</a> for actually calculating the right hand side, we also generate the final matrix. As mentioned above, it is a sum of the mass matrix and the Laplace matrix, times some time step-dependent weight. This weight is specified by the BDF-2 time integration scheme, see the introduction in <a class="el" href="step_31.html">step-31</a>. What is new in this tutorial program (in addition to the use of MPI parallelization and the <a class="el" href="namespaceWorkStream.html">WorkStream</a> class), is that we now precompute the temperature preconditioner as well. The reason is that the setup of the Jacobi preconditioner takes a noticeable time compared to the solver because we usually only need between 10 and 20 iterations for solving the temperature system (this might sound strange, as Jacobi really only consists of a diagonal, but in Trilinos it is derived from more general framework for point relaxation preconditioners which is a bit inefficient). Hence, it is more efficient to precompute the preconditioner, even though the matrix entries may slightly change because the time step might change. This is not too big a problem because we remesh every few time steps (and regenerate the preconditioner then).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_system(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (use_bdf2_scheme == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">      temperature_matrix *=</div>
<div class="line">        (2 * time_step + old_time_step) / (time_step + old_time_step);</div>
<div class="line">      temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">      temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_temperature_preconditioner == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      T_preconditioner =</div>
<div class="line">        std::make_shared&lt;TrilinosWrappers::PreconditionJacobi&gt;();</div>
<div class="line">      T_preconditioner-&gt;initialize(temperature_matrix);</div>
<div class="line">      rebuild_temperature_preconditioner = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
</div><!-- fragment --><p>The next part is computing the right hand side vectors. To do so, we first compute the average temperature \(T_m\) that we use for evaluating the artificial viscosity stabilization through the residual \(E(T) = (T-T_m)^2\). We do this by defining the midpoint between maximum and minimum temperature as average temperature in the definition of the entropy viscosity. An alternative would be to use the integral average, but the results are not very sensitive to this choice. The rest then only requires calling <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> again, binding the arguments to the <code>local_assemble_temperature_rhs</code> function that are the same in every call to the correct values:</p>
<div class="fragment"><div class="line">  temperature_rhs = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2);</div>
<div class="line">  <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range =</div>
<div class="line">    get_extrapolated_temperature_range();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature =</div>
<div class="line">    0.5 * (global_T_range.first + global_T_range.second);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_entropy_variation =</div>
<div class="line">    get_entropy_variation(average_temperature);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using</span> CellFilter =</div>
<div class="line">    <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> worker =</div>
<div class="line">    [<span class="keyword">this</span>, global_T_range, maximal_velocity, global_entropy_variation](</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">      Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">      Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;local_assemble_temperature_rhs(global_T_range,</div>
<div class="line">                                           maximal_velocity,</div>
<div class="line">                                           global_entropy_variation,</div>
<div class="line">                                           <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">                                           scratch,</div>
<div class="line">                                           <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a> = [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">    this-&gt;copy_local_to_global_temperature_rhs(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                             temperature_dof_handler.begin_active()),</div>
<div class="line">                  CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                             temperature_dof_handler.end()),</div>
<div class="line">                  worker,</div>
<div class="line">                  <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a>,</div>
<div class="line">                  Assembly::Scratch::TemperatureRHS&lt;dim&gt;(</div>
<div class="line">                    temperature_fe, stokes_fe, <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, quadrature_formula),</div>
<div class="line">                  Assembly::CopyData::TemperatureRHS&lt;dim&gt;(temperature_fe));</div>
<div class="line"> </div>
<div class="line">  temperature_rhs.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemsolve"></a> </p><h4>BoussinesqFlowProblem::solve</h4>
<p>This function solves the linear systems in each time step of the Boussinesq problem. First, we work on the Stokes system and then on the temperature system. In essence, it does the same things as the respective function in <a class="el" href="step_31.html">step-31</a>. However, there are a few changes here.</p>
<p>The first change is related to the way we store our solution: we keep the vectors with locally owned degrees of freedom plus ghost nodes on each MPI node. When we enter a solver which is supposed to perform matrix-vector products with a distributed matrix, this is not the appropriate form, though. There, we will want to have the solution vector to be distributed in the same way as the matrix, i.e. without any ghosts. So what we do first is to generate a distributed vector called <code>distributed_stokes_solution</code> and put only the locally owned dofs into that, which is neatly done by the <code>operator=</code> of the Trilinos vector.</p>
<p>Next, we scale the pressure solution (or rather, the initial guess) for the solver so that it matches with the length scales in the matrices, as discussed in the introduction. We also immediately scale the pressure solution back to the correct units after the solution is completed. We also need to set the pressure values at hanging nodes to zero. This we also did in <a class="el" href="step_31.html">step-31</a> in order not to disturb the Schur complement by some vector entries that actually are irrelevant during the solve stage. As a difference to <a class="el" href="step_31.html">step-31</a>, here we do it only for the locally owned pressure dofs. After solving for the Stokes solution, each processor copies the distributed solution back into the solution vector that also includes ghost elements.</p>
<p>The third and most obvious change is that we have two variants for the Stokes solver: A fast solver that sometimes breaks down, and a robust solver that is slower. This is what we already discussed in the introduction. Here is how we realize it: First, we perform 30 iterations with the fast solver based on the simple preconditioner based on the AMG V-cycle instead of an approximate solve (this is indicated by the <code>false</code> argument to the <code>LinearSolvers::BlockSchurPreconditioner</code> object). If we converge, everything is fine. If we do not converge, the solver control object will throw an exception <a class="el" href="classSolverControl_1_1NoConvergence.html">SolverControl::NoConvergence</a>. Usually, this would abort the program because we don't catch them in our usual <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code> functions. This is certainly not what we want to happen here. Rather, we want to switch to the strong solver and continue the solution process with whatever vector we got so far. Hence, we catch the exception with the C++ try/catch mechanism. We then simply go through the same solver sequence again in the <code>catch</code> clause, this time passing the <code>true</code> flag to the preconditioner for the strong solver, signaling an approximate CG solve.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">BoussinesqFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                     <span class="stringliteral">&quot;   Solve Stokes system&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Solving Stokes system... &quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distributed_stokes_solution(</div>
<div class="line">      stokes_rhs);</div>
<div class="line">    distributed_stokes_solution = stokes_solution;</div>
<div class="line"> </div>
<div class="line">    distributed_stokes_solution.block(1) /= <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span></div>
<div class="line">      <a class="code" href="timer__0_8txt.html#a48e9e3a8116df3cc4b62db810904e91f">start</a> = (distributed_stokes_solution.block(0).size() +</div>
<div class="line">               distributed_stokes_solution.block(1).local_range().first),</div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a>   = (distributed_stokes_solution.block(0).size() +</div>
<div class="line">             distributed_stokes_solution.block(1).local_range().second);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="timer__0_8txt.html#a48e9e3a8116df3cc4b62db810904e91f">start</a>; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (stokes_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">        distributed_stokes_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classPrimitiveVectorMemory.html">PrimitiveVectorMemory&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> mem;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  n_iterations     = 0;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>  solver_tolerance = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-8 * stokes_rhs.l2_norm();</div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(30, solver_tolerance);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">try</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">          <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div>
<div class="line">          <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix,</div>
<div class="line">                         stokes_preconditioner_matrix,</div>
<div class="line">                         *Mp_preconditioner,</div>
<div class="line">                         *Amg_preconditioner,</div>
<div class="line">                         <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverFGMRES.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(</div>
<div class="line">          solver_control,</div>
<div class="line">          mem,</div>
<div class="line">          <a class="code" href="structSolverFGMRES_1_1AdditionalData.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">            30));</div>
<div class="line">        <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix,</div>
<div class="line">                     distributed_stokes_solution,</div>
<div class="line">                     stokes_rhs,</div>
<div class="line">                     <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">        n_iterations = solver_control.last_step();</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">catch</span> (<a class="code" href="classSolverControl_1_1NoConvergence.html">SolverControl::NoConvergence</a> &amp;)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">          <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div>
<div class="line">          <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix,</div>
<div class="line">                         stokes_preconditioner_matrix,</div>
<div class="line">                         *Mp_preconditioner,</div>
<div class="line">                         *Amg_preconditioner,</div>
<div class="line">                         <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverControl.html">SolverControl</a> solver_control_refined(stokes_matrix.m(),</div>
<div class="line">                                             solver_tolerance);</div>
<div class="line">        <a class="code" href="classSolverFGMRES.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(</div>
<div class="line">          solver_control_refined,</div>
<div class="line">          mem,</div>
<div class="line">          <a class="code" href="structSolverFGMRES_1_1AdditionalData.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">            50));</div>
<div class="line">        <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix,</div>
<div class="line">                     distributed_stokes_solution,</div>
<div class="line">                     stokes_rhs,</div>
<div class="line">                     <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">        n_iterations =</div>
<div class="line">          (solver_control.last_step() + solver_control_refined.last_step());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    stokes_constraints.distribute(distributed_stokes_solution);</div>
<div class="line"> </div>
<div class="line">    distributed_stokes_solution.block(1) *= <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a>;</div>
<div class="line"> </div>
<div class="line">    stokes_solution = distributed_stokes_solution;</div>
<div class="line">    pcout &lt;&lt; n_iterations &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Now let's turn to the temperature part: First, we compute the time step size. We found that we need smaller time steps for 3D than for 2D for the shell geometry. This is because the cells are more distorted in that case (it is the smallest edge length that determines the CFL number). Instead of computing the time step from maximum velocity and minimal mesh size as in <a class="el" href="step_31.html">step-31</a>, we compute local CFL numbers, i.e., on each cell we compute the maximum velocity times the mesh size, and compute the maximum of them. Hence, we need to choose the factor in front of the time step slightly smaller.</p>
<p>After temperature right hand side assembly, we solve the linear system for temperature (with fully distributed vectors without any ghosts), apply constraints and copy the vector back to one with ghosts.</p>
<p>In the end, we extract the temperature range similarly to <a class="el" href="step_31.html">step-31</a> to produce some output (for example in order to help us choose the stabilization constants, as discussed in the introduction). The only difference is that we need to exchange maxima over all processors.</p>
<div class="fragment"><div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                     <span class="stringliteral">&quot;   Assemble temperature rhs&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    old_time_step = time_step;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> scaling = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3 ? 0.25 : 1.0);</div>
<div class="line">    time_step            = (scaling / (2.1 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> * <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) /</div>
<div class="line">                 (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree * get_cfl_number()));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity = get_maximal_velocity();</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Maximal velocity: &quot;</span></div>
<div class="line">          &lt;&lt; maximal_velocity * <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> * 100</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; cm/year&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span></div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;Time step: &quot;</span> &lt;&lt; time_step / <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a></div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; years&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    temperature_solution = old_temperature_solution;</div>
<div class="line">    assemble_temperature_system(maximal_velocity);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                     <span class="stringliteral">&quot;   Solve temperature system&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(temperature_matrix.m(),</div>
<div class="line">                                 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 * temperature_rhs.l2_norm());</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temperature_solution(</div>
<div class="line">      temperature_rhs);</div>
<div class="line">    distributed_temperature_solution = temperature_solution;</div>
<div class="line"> </div>
<div class="line">    cg.solve(temperature_matrix,</div>
<div class="line">             distributed_temperature_solution,</div>
<div class="line">             temperature_rhs,</div>
<div class="line">             *T_preconditioner);</div>
<div class="line"> </div>
<div class="line">    temperature_constraints.distribute(distributed_temperature_solution);</div>
<div class="line">    temperature_solution = distributed_temperature_solution;</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; CG iterations for temperature&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[2] = {<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">                             -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>()};</div>
<div class="line">    <span class="keywordtype">double</span> global_temperature[2];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> =</div>
<div class="line">           distributed_temperature_solution.local_range().first;</div>
<div class="line">         <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; distributed_temperature_solution.local_range().second;</div>
<div class="line">         ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0] =</div>
<div class="line">          std::min&lt;double&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0],</div>
<div class="line">                           distributed_temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[1] =</div>
<div class="line">          std::max&lt;double&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[1],</div>
<div class="line">                           distributed_temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0] *= -1.0;</div>
<div class="line">    <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>, MPI_COMM_WORLD, global_temperature);</div>
<div class="line">    global_temperature[0] *= -1.0;</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Temperature range: &quot;</span> &lt;&lt; global_temperature[0] &lt;&lt; <span class="charliteral">&#39; &#39;</span></div>
<div class="line">          &lt;&lt; global_temperature[1] &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemoutput_results"></a> </p><h4>BoussinesqFlowProblem::output_results</h4>
<p>Next comes the function that generates the output. The quantities to output could be introduced manually like we did in <a class="el" href="step_31.html">step-31</a>. An alternative is to hand this task over to a class PostProcessor that inherits from the class <a class="el" href="classDataPostprocessor.html">DataPostprocessor</a>, which can be attached to <a class="el" href="classDataOut.html">DataOut</a>. This allows us to output derived quantities from the solution, like the friction heating included in this example. It overloads the virtual function <a class="el" href="classDataPostprocessor.html#a1ba57b598d24d64365d469a854271c68">DataPostprocessor::evaluate_vector_field()</a>, which is then internally called from <a class="el" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches()</a>. We have to give it values of the numerical solution, its derivatives, normals to the cell, the actual evaluation points and any additional quantities. This follows the same procedure as discussed in <a class="el" href="step_29.html">step-29</a> and other programs.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>BoussinesqFlowProblem&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::Postprocessor</div>
<div class="line">  : <span class="keyword">public</span> <a class="code" href="classDataPostprocessor.html">DataPostprocessor</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Postprocessor(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> minimal_pressure);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classDataPostprocessor.html#a1ba57b598d24d64365d469a854271c68">evaluate_vector_field</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Vector.html">DataPostprocessorInputs::Vector&lt;dim&gt;</a> &amp;inputs,</div>
<div class="line">    <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;computed_quantities) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> std::vector&lt;std::string&gt; <a class="code" href="classDataPostprocessor.html#a254f38bcdf4bdb5aa94231b695da7d55">get_names</a>() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0">DataComponentInterpretation::DataComponentInterpretation</a>&gt;</div>
<div class="line">  <a class="code" href="classDataPostprocessor.html#ae994223acf8a16471ab5e579a4d75053">get_data_component_interpretation</a>() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a> <a class="code" href="classDataPostprocessor.html#aadecdd040447b395164397ea1196f721">get_needed_update_flags</a>() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       minimal_pressure;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::Postprocessor(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       minimal_pressure)</div>
<div class="line">  : <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>(<a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>)</div>
<div class="line">  , minimal_pressure(minimal_pressure)</div>
<div class="line">{}</div>
</div><!-- fragment --><p>Here we define the names for the variables we want to output. These are the actual solution values for velocity, pressure, and temperature, as well as the friction heating and to each cell the number of the processor that owns it. This allows us to visualize the partitioning of the domain among the processors. Except for the velocity, which is vector-valued, all other quantities are scalar.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::vector&lt;std::string&gt;</div>
<div class="line"><a class="code" href="data__postprocessor__0_8txt.html#afb21caeba7bf26aba89ce705266fedb1">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_names</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;std::string&gt; solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;p&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;T&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;friction_heating&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;partition&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> solution_names;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_data_component_interpretation()<span class="keyword"></span></div>
<div class="line"><span class="keyword">  const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    interpretation(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">                   <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line"> </div>
<div class="line">  interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> interpretation;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a></div>
<div class="line"><a class="code" href="data__postprocessor__0_8txt.html#abfdf708e97518fa7ad2b849b80afddc1">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_needed_update_flags</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now we implement the function that computes the derived quantities. As we also did for the output, we rescale the velocity from its SI units to something more readable, namely cm/year. Next, the pressure is scaled to be between 0 and the maximum pressure. This makes it more easily comparable &ndash; in essence making all pressure variables positive or zero. Temperature is taken as is, and the friction heating is computed as \(2 \eta \varepsilon(\mathbf{u}) \cdot \varepsilon(\mathbf{u})\).</p>
<p>The quantities we output here are more for illustration, rather than for actual scientific value. We come back to this briefly in the results section of this program and explain what one may in fact be interested in.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::evaluate_vector_field(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Vector.html">DataPostprocessorInputs::Vector&lt;dim&gt;</a> &amp;inputs,</div>
<div class="line">  <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;               computed_quantities)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_quadrature_points = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>.size();</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a2a918d936d56f2be4cdad1b8074c3a86">solution_gradients</a>.size() == n_quadrature_points,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(computed_quantities.size() == n_quadrature_points,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[0].size() == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 2, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_quadrature_points; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        computed_quantities[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>) = (inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>) *</div>
<div class="line">                                     <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> * 100);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a> =</div>
<div class="line">        (inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) - minimal_pressure);</div>
<div class="line">      computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) = <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>        = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">      computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1) = <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> grad_u;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        grad_u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a2a918d936d56f2be4cdad1b8074c3a86">solution_gradients</a>[q][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>];</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> strain_rate = <a class="code" href="classSymmetricTensor.html#a1b2101a1d45267f1fd4664ed178cb636">symmetrize</a>(grad_u);</div>
<div class="line">      computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 2) =</div>
<div class="line">        2 * <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * strain_rate * strain_rate;</div>
<div class="line"> </div>
<div class="line">      computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 3) = <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The <code>output_results()</code> function has a similar task to the one in <a class="el" href="step_31.html">step-31</a>. However, here we are going to demonstrate a different technique on how to merge output from different <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. The way we're going to achieve this recombination is to create a joint <a class="el" href="classDoFHandler.html">DoFHandler</a> that collects both components, the Stokes solution and the temperature solution. This can be nicely done by combining the finite elements from the two systems to form one <a class="el" href="classFESystem.html">FESystem</a>, and let this collective system define a new <a class="el" href="classDoFHandler.html">DoFHandler</a> object. To be sure that everything was done correctly, we perform a sanity check that ensures that we got all the dofs from both Stokes and temperature even in the combined system. We then combine the data vectors. Unfortunately, there is no straight-forward relation that tells us how to sort Stokes and temperature vector into the joint vector. The way we can get around this trouble is to rely on the information collected in the <a class="el" href="classFESystem.html">FESystem</a>. For each dof on a cell, the joint finite element knows to which equation component (velocity component, pressure, or temperature) it belongs – that's the information we need! So we step through all cells (with iterators into all three DoFHandlers moving in sync), and for each joint cell dof, we read out that component using the <a class="el" href="classFiniteElement.html#a95ac75dfc5b9f4e01c34d5865b4ca5a2">FiniteElement::system_to_base_index</a> function (see there for a description of what the various parts of its return value contain). We also need to keep track whether we're on a Stokes dof or a temperature dof, which is contained in joint_fe.system_to_base_index(i).first.first. Eventually, the dof_indices data structures on either of the three systems tell us how the relation between global vector and local dofs looks like on the present cell, which concludes this tedious work. We make sure that each processor only works on the subdomain it owns locally (and not on ghost or artificial cells) when building the joint solution vector. The same will then have to be done in <a class="el" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches()</a>, but that function does so automatically.</p>
<p>What we end up with is a set of patches that we can write using the functions in <a class="el" href="namespaceDataOutBase.html">DataOutBase</a> in a variety of output formats. Here, we then have to pay attention that what each processor writes is really only its own part of the domain, i.e. we will want to write each processor's contribution into a separate file. This we do by adding an additional number to the filename when we write the solution. This is not really new, we did it similarly in <a class="el" href="step_40.html">step-40</a>. Note that we write in the compressed format <code></code>.vtu instead of plain vtk files, which saves quite some storage.</p>
<p>All the rest of the work is done in the PostProcessor class.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::output_results()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer, <span class="stringliteral">&quot;Postprocessing&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> joint_fe(stokes_fe, 1, temperature_fe, 1);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> joint_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">  joint_dof_handler.distribute_dofs(joint_fe);</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_dof_handler.n_dofs() ==</div>
<div class="line">           stokes_dof_handler.n_dofs() + temperature_dof_handler.n_dofs(),</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> joint_solution;</div>
<div class="line">  joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a655ae9c8d3595133abe1131fcbb97b6d">reinit</a>(joint_dof_handler.locally_owned_dofs(),</div>
<div class="line">                        MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_joint_dof_indices(</div>
<div class="line">      joint_fe.n_dofs_per_cell());</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_stokes_dof_indices(</div>
<div class="line">      stokes_fe.n_dofs_per_cell());</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_temperature_dof_indices(</div>
<div class="line">      temperature_fe.n_dofs_per_cell());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div>
<div class="line">      joint_cell       = joint_dof_handler.<a class="code" href="classDoFHandler.html#a9a3bef554c6d22abe312e10e9475eecf">begin_active</a>(),</div>
<div class="line">      joint_endc       = joint_dof_handler.end(),</div>
<div class="line">      stokes_cell      = stokes_dof_handler.begin_active(),</div>
<div class="line">      temperature_cell = temperature_dof_handler.begin_active();</div>
<div class="line">    <span class="keywordflow">for</span> (; joint_cell != joint_endc;</div>
<div class="line">         ++joint_cell, ++stokes_cell, ++temperature_cell)</div>
<div class="line">      <span class="keywordflow">if</span> (joint_cell-&gt;is_locally_owned())</div>
<div class="line">        {</div>
<div class="line">          joint_cell-&gt;get_dof_indices(local_joint_dof_indices);</div>
<div class="line">          stokes_cell-&gt;get_dof_indices(local_stokes_dof_indices);</div>
<div class="line">          temperature_cell-&gt;get_dof_indices(local_temperature_dof_indices);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; joint_fe.n_dofs_per_cell(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">if</span> (joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 0)</div>
<div class="line">              {</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                         local_stokes_dof_indices.size(),</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">                joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) = stokes_solution(</div>
<div class="line">                  local_stokes_dof_indices[joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                                             .second]);</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              {</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 1,</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                         local_temperature_dof_indices.size(),</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) =</div>
<div class="line">                  temperature_solution(</div>
<div class="line">                    local_temperature_dof_indices</div>
<div class="line">                      [joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second]);</div>
<div class="line">              }</div>
<div class="line">        }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a7221ae06689832b475206ef54efaf0a6">compress</a>(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964caf4784f9368d9386d7508c25daea9e19d">VectorOperation::insert</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_joint_dofs(joint_dof_handler.n_dofs());</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(joint_dof_handler,</div>
<div class="line">                                          locally_relevant_joint_dofs);</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> locally_relevant_joint_solution;</div>
<div class="line">  locally_relevant_joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a655ae9c8d3595133abe1131fcbb97b6d">reinit</a>(locally_relevant_joint_dofs,</div>
<div class="line">                                         MPI_COMM_WORLD);</div>
<div class="line">  locally_relevant_joint_solution = joint_solution;</div>
<div class="line"> </div>
<div class="line">  Postprocessor <a class="code" href="data__postprocessor__0_8txt.html#a80e53cb52e5dbb182dd14ee528927a77">postprocessor</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                MPI_COMM_WORLD),</div>
<div class="line">                              stokes_solution.block(1).min());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(joint_dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_joint_solution, <a class="code" href="data__postprocessor__0_8txt.html#a80e53cb52e5dbb182dd14ee528927a77">postprocessor</a>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">int</span> out_index = 0;</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div>
<div class="line">    <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, out_index, MPI_COMM_WORLD, 5);</div>
<div class="line"> </div>
<div class="line">  out_index++;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemrefine_mesh"></a> </p><h4>BoussinesqFlowProblem::refine_mesh</h4>
<p>This function isn't really new either. Since the <code>setup_dofs</code> function that we call in the middle has its own timer section, we split timing this function into two sections. It will also allow us to easily identify which of the two is more expensive.</p>
<p>One thing of note, however, is that we only want to compute error indicators on the locally owned subdomain. In order to achieve this, we pass one additional argument to the <a class="el" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a> function. Note that the vector for error estimates is resized to the number of active cells present on the current process, which is less than the total number of active cells on all processors (but more than the number of locally owned active cells); each processor only has a few coarse cells around the locally owned ones, as also explained in <a class="el" href="step_40.html">step-40</a>.</p>
<p>The local error estimates are then handed to a parallel version of <a class="el" href="namespaceGridRefinement.html">GridRefinement</a> (in namespace <a class="el" href="namespaceparallel_1_1distributed_1_1GridRefinement.html">parallel::distributed::GridRefinement</a>, see also <a class="el" href="step_40.html">step-40</a>) which looks at the errors and finds the cells that need refinement by comparing the error values across processors. As in <a class="el" href="step_31.html">step-31</a>, we want to limit the maximum grid level. So in case some cells have been marked that are already at the finest level, we simply clear the refine flags.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a></div>
<div class="line">    temperature_trans(temperature_dof_handler);</div>
<div class="line">  <a class="code" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">                                          <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a>&gt;</div>
<div class="line">    stokes_trans(stokes_dof_handler);</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                     <span class="stringliteral">&quot;Refine mesh structure, part 1&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">      temperature_dof_handler,</div>
<div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 1),</div>
<div class="line">      <a class="code" href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">std::map</a>&lt;<a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">      temperature_solution,</div>
<div class="line">      estimated_error_per_cell,</div>
<div class="line">      <a class="code" href="classComponentMask.html">ComponentMask</a>(),</div>
<div class="line">      <span class="keyword">nullptr</span>,</div>
<div class="line">      0,</div>
<div class="line">      <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.locally_owned_subdomain());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#ae5159e3207f6786f0749fc0b66ab8ca3">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_fraction</a>(</div>
<div class="line">      <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, estimated_error_per_cell, 0.3, 0.1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> =</div>
<div class="line">             <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.begin_active(max_grid_level);</div>
<div class="line">           <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.end();</div>
<div class="line">           ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
</div><!-- fragment --><p>With all flags marked as necessary, we can then tell the <a class="el" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a> objects to get ready to transfer data from one mesh to the next, which they will do when notified by <a class="el" href="classTriangulation.html">Triangulation</a> as part of the <code>execute_coarsening_and_refinement()</code> call. The syntax is similar to the non-parallel solution transfer (with the exception that here a pointer to the vector entries is enough). The remainder of the function further down below is then concerned with setting up the data structures again after mesh refinement and restoring the solution vectors on the new mesh.</p>
<div class="fragment"><div class="line">  std::vector&lt;const TrilinosWrappers::MPI::Vector *&gt; x_temperature(2);</div>
<div class="line">  x_temperature[0] = &amp;temperature_solution;</div>
<div class="line">  x_temperature[1] = &amp;old_temperature_solution;</div>
<div class="line">  std::vector&lt;const TrilinosWrappers::MPI::BlockVector *&gt; x_stokes(2);</div>
<div class="line">  x_stokes[0] = &amp;stokes_solution;</div>
<div class="line">  x_stokes[1] = &amp;old_stokes_solution;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">  temperature_trans.prepare_for_coarsening_and_refinement(x_temperature);</div>
<div class="line">  stokes_trans.prepare_for_coarsening_and_refinement(x_stokes);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">setup_dofs();</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                   <span class="stringliteral">&quot;Refine mesh structure, part 2&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temp1(temperature_rhs);</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temp2(temperature_rhs);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector *&gt; tmp(2);</div>
<div class="line">    tmp[0] = &amp;(distributed_temp1);</div>
<div class="line">    tmp[1] = &amp;(distributed_temp2);</div>
<div class="line">    temperature_trans.interpolate(tmp);</div>
</div><!-- fragment --><p>enforce constraints to make the interpolated solution conforming on the new mesh:</p>
<div class="fragment"><div class="line">  temperature_constraints.distribute(distributed_temp1);</div>
<div class="line">  temperature_constraints.distribute(distributed_temp2);</div>
<div class="line"> </div>
<div class="line">  temperature_solution     = distributed_temp1;</div>
<div class="line">  old_temperature_solution = distributed_temp2;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distributed_stokes(stokes_rhs);</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_distributed_stokes(stokes_rhs);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;TrilinosWrappers::MPI::BlockVector *&gt; stokes_tmp(2);</div>
<div class="line">  stokes_tmp[0] = &amp;(distributed_stokes);</div>
<div class="line">  stokes_tmp[1] = &amp;(old_distributed_stokes);</div>
<div class="line"> </div>
<div class="line">  stokes_trans.interpolate(stokes_tmp);</div>
</div><!-- fragment --><p>enforce constraints to make the interpolated solution conforming on the new mesh:</p>
<div class="fragment"><div class="line">      stokes_constraints.distribute(distributed_stokes);</div>
<div class="line">      stokes_constraints.distribute(old_distributed_stokes);</div>
<div class="line"> </div>
<div class="line">      stokes_solution     = distributed_stokes;</div>
<div class="line">      old_stokes_solution = old_distributed_stokes;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemrun"></a> </p><h4>BoussinesqFlowProblem::run</h4>
<p>This is the final and controlling function in this class. It, in fact, runs the entire rest of the program and is, once more, very similar to <a class="el" href="step_31.html">step-31</a>. The only substantial difference is that we use a different mesh now (a <a class="el" href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell</a> instead of a simple cube geometry).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">BoussinesqFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                             <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(),</div>
<div class="line">                             <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">EquationData::R0</a>,</div>
<div class="line">                             <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">EquationData::R1</a>,</div>
<div class="line">                             (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3) ? 96 : 12,</div>
<div class="line">                             <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">  global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement);</div>
<div class="line"> </div>
<div class="line">  setup_dofs();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">start_time_iteration:</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(</div>
<div class="line">      temperature_dof_handler.locally_owned_dofs());</div>
</div><!-- fragment --><p><a class="el" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a> supports parallel vector classes with most standard finite elements via deal.II's own native <a class="el" href="classMatrixFree.html">MatrixFree</a> framework: since we use standard Lagrange elements of moderate order this function works well here.</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(temperature_dof_handler,</div>
<div class="line">                     temperature_constraints,</div>
<div class="line">                     <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2),</div>
<div class="line">                     EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">                     <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
</div><!-- fragment --><p>Having so computed the current temperature field, let us set the member variable that holds the temperature nodes. Strictly speaking, we really only need to set <code>old_temperature_solution</code> since the first thing we will do is to compute the Stokes solution that only requires the previous time step's temperature field. That said, nothing good can come from not initializing the other vectors as well (especially since it's a relatively cheap operation and we only have to do it once at the beginning of the program) if we ever want to extend our numerical method or physical model, and so we initialize <code>old_temperature_solution</code> and <code>old_old_temperature_solution</code> as well. The assignment makes sure that the vectors on the left hand side (which where initialized to contain ghost elements as well) also get the correct ghost elements. In other words, the assignment here requires communication between processors:</p>
<div class="fragment"><div class="line">  temperature_solution         = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  old_temperature_solution     = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  old_old_temperature_solution = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">timestep_number = 0;</div>
<div class="line">time_step = old_time_step = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">do</span></div>
<div class="line">  {</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> / <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> &lt;&lt; <span class="stringliteral">&quot; years&quot;</span></div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    assemble_stokes_system();</div>
<div class="line">    build_stokes_preconditioner();</div>
<div class="line">    assemble_temperature_matrix();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">        (pre_refinement_step &lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement))</div>
<div class="line">      {</div>
<div class="line">        refine_mesh(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement +</div>
<div class="line">                    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement);</div>
<div class="line">        ++pre_refinement_step;</div>
<div class="line">        <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp;</div>
<div class="line">             (timestep_number % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.adaptive_refinement_interval ==</div>
<div class="line">              0))</div>
<div class="line">      refine_mesh(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement +</div>
<div class="line">                  <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.generate_graphical_output == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">        (timestep_number % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.graphical_output_interval == 0))</div>
<div class="line">      output_results();</div>
</div><!-- fragment --><p>In order to speed up linear solvers, we extrapolate the solutions from the old time levels to the new one. This gives a very good initial guess, cutting the number of iterations needed in solvers by more than one half. We do not need to extrapolate in the last iteration, so if we reached the final time, we stop here.</p>
<p>As the last thing during a time step (before actually bumping up the number of the time step), we check whether the current time step number is divisible by 100, and if so we let the computing timer print a summary of CPU times spent so far.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &gt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.end_time * <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a>)</div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_old_stokes_solution;</div>
<div class="line">old_old_stokes_solution      = old_stokes_solution;</div>
<div class="line">old_stokes_solution          = stokes_solution;</div>
<div class="line">old_old_temperature_solution = old_temperature_solution;</div>
<div class="line">old_temperature_solution     = temperature_solution;</div>
<div class="line"><span class="keywordflow">if</span> (old_time_step &gt; 0)</div>
<div class="line">  {</div>
</div><!-- fragment --><p>Trilinos sadd does not like ghost vectors even as input. Copy into distributed vectors for now:</p>
<div class="fragment"><div class="line">        {</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distr_solution(stokes_rhs);</div>
<div class="line">          distr_solution = stokes_solution;</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distr_old_solution(stokes_rhs);</div>
<div class="line">          distr_old_solution = old_old_stokes_solution;</div>
<div class="line">          distr_solution.<a class="code" href="classBlockVectorBase.html#a71b0ab8295e98caf3dfe1ef14ae6b6c1">sadd</a>(1. + time_step / old_time_step,</div>
<div class="line">                              -time_step / old_time_step,</div>
<div class="line">                              distr_old_solution);</div>
<div class="line">          stokes_solution = distr_solution;</div>
<div class="line">        }</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distr_solution(temperature_rhs);</div>
<div class="line">          distr_solution = temperature_solution;</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distr_old_solution(temperature_rhs);</div>
<div class="line">          distr_old_solution = old_old_temperature_solution;</div>
<div class="line">          distr_solution.sadd(1. + time_step / old_time_step,</div>
<div class="line">                              -time_step / old_time_step,</div>
<div class="line">                              distr_old_solution);</div>
<div class="line">          temperature_solution = distr_solution;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 100 == 0))</div>
<div class="line">      computing_timer.print_summary();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">    ++timestep_number;</div>
<div class="line">  }</div>
<div class="line"><span class="keywordflow">while</span> (<span class="keyword">true</span>);</div>
</div><!-- fragment --><p>If we are generating graphical output, do so also for the last time step unless we had just done so before we left the do-while loop</p>
<div class="fragment"><div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.generate_graphical_output == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">        !((timestep_number - 1) % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.graphical_output_interval == 0))</div>
<div class="line">      output_results();</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step32</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>The main function is short as usual and very similar to the one in <a class="el" href="step_31.html">step-31</a>. Since we use a parameter file which is specified as an argument in the command line, we have to read it in here and pass it on to the Parameters class for parsing. If no filename is given in the command line, we simply use the <code>step-32.prm</code> file which is distributed together with the program.</p>
<p>Because 3d computations are simply very slow unless you throw a lot of processors at them, the program defaults to 2d. You can get the 3d version by changing the constant dimension below to 3.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep32.html">Step32</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      std::string parameter_filename;</div>
<div class="line">      <span class="keywordflow">if</span> (argc &gt;= 2)</div>
<div class="line">        parameter_filename = argv[1];</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        parameter_filename = <span class="stringliteral">&quot;step-32.prm&quot;</span>;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">int</span>                              <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> = 2;</div>
<div class="line">      <a class="code" href="structStep32_1_1BoussinesqFlowProblem_1_1Parameters.html">BoussinesqFlowProblem&lt;dim&gt;::Parameters</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>(parameter_filename);</div>
<div class="line">      BoussinesqFlowProblem&lt;dim&gt;             flow_problem(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>When run, the program simulates convection in 3d in much the same way as <a class="el" href="step_31.html">step-31</a> did, though with an entirely different testcase.</p>
<p><a class="anchor" id="Comparisonofresultswithstep31"></a></p><h3>Comparison of results with step-31</h3>
<p>Before we go to this testcase, however, let us show a few results from a slightly earlier version of this program that was solving exactly the testcase we used in <a class="el" href="step_31.html">step-31</a>, just that we now solve it in parallel and with much higher resolution. We show these results mainly for comparison.</p>
<p>Here are two images that show this higher resolution if we choose a 3d computation in <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> and if we set <code>initial_refinement=3</code> and <code>n_pre_refinement_steps=4</code>. At the time steps shown, the meshes had around 72,000 and 236,000 cells, for a total of 2,680,000 and 8,250,000 degrees of freedom, respectively, more than an order of magnitude more than we had available in <a class="el" href="step_31.html">step-31</a>:</p>
<table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32.3d.cube.0.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32.3d.cube.1.png" alt="" class="inline"/>   </td></tr>
</table>
<p>The computation was done on a subset of 50 processors of the Brazos cluster at Texas A&amp;M University.</p>
<p><a class="anchor" id="Resultsfora2dcircularshelltestcase"></a></p><h3>Results for a 2d circular shell testcase</h3>
<p>Next, we will run <a class="el" href="step_32.html">step-32</a> with the parameter file in the directory with one change: we increase the final time to 1e9. Here we are using 16 processors. The command to launch is (note that <a class="el" href="step_32.html">step-32</a>.prm is the default):</p>
<p><code> </p><pre>
$ mpirun -np 16 ./step-32
</pre><p> </code></p>
<p>Note that running a job on a cluster typically requires going through a job scheduler, which we won't discuss here. The output will look roughly like this:</p>
<p><code> </p><pre>
$ mpirun -np 16 ./step-32
Number of active cells: 12,288 (on 6 levels)
Number of degrees of freedom: 186,624 (99,840+36,864+49,920)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0 years</pre><p></code></p>
<p><code></p><pre>   Rebuilding Stokes preconditioner...
   Solving Stokes system... 41 iterations.
   Maximal velocity: 60.4935 cm/year
   Time step: 18166.9 years
   17 CG iterations for temperature
   Temperature range: 973 4273.16</pre><p></code></p>
<p><code></p><pre>Number of active cells: 15,921 (on 7 levels)
Number of degrees of freedom: 252,723 (136,640+47,763+68,320)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0 years</pre><p></code></p>
<p><code></p><pre>   Rebuilding Stokes preconditioner...
   Solving Stokes system... 50 iterations.
   Maximal velocity: 60.3223 cm/year
   Time step: 10557.6 years
   19 CG iterations for temperature
   Temperature range: 973 4273.16</pre><p></code></p>
<p><code></p><pre>Number of active cells: 19,926 (on 8 levels)
Number of degrees of freedom: 321,246 (174,312+59,778+87,156)</pre><p></code></p>
<p><code></p><pre>Timestep 0:  t=0 years</pre><p></code></p>
<p><code></p><pre>   Rebuilding Stokes preconditioner...
   Solving Stokes system... 50 iterations.
   Maximal velocity: 57.8396 cm/year
   Time step: 5453.78 years
   18 CG iterations for temperature
   Temperature range: 973 4273.16</pre><p></code></p>
<p><code></p><pre>Timestep 1:  t=5453.78 years</pre><p></code></p>
<p><code></p><pre>   Solving Stokes system... 49 iterations.
   Maximal velocity: 59.0231 cm/year
   Time step: 5345.86 years
   18 CG iterations for temperature
   Temperature range: 973 4273.16</pre><p></code></p>
<p><code></p><pre>Timestep 2:  t=10799.6 years</pre><p></code></p>
<p><code></p><pre>   Solving Stokes system... 24 iterations.
   Maximal velocity: 60.2139 cm/year
   Time step: 5241.51 years
   17 CG iterations for temperature
   Temperature range: 973 4273.16</pre><p></code></p>
<p><code></p><pre>[...]</pre><p></code></p>
<p><code></p><pre>Timestep 100:  t=272151 years</pre><p></code></p>
<p><code></p><pre>   Solving Stokes system... 21 iterations.
   Maximal velocity: 161.546 cm/year
   Time step: 1672.96 years
   17 CG iterations for temperature
   Temperature range: 973 4282.57</pre><p></code></p>
<p><code></p><pre>Number of active cells: 56,085 (on 8 levels)
Number of degrees of freedom: 903,408 (490,102+168,255+245,051)</pre><p></code></p>
<p><code></p><pre>+---------------------------------------------+------------+------------+
| Total wallclock time elapsed since start    |       115s |            |
|                                             |            |            |
| Section                         | no. calls |  wall time | % of total |
+---------------------------------+-----------+------------+------------+
| Assemble Stokes system          |       103 |      2.82s |       2.5% |
| Assemble temperature matrices   |        12 |     0.452s |      0.39% |
| Assemble temperature rhs        |       103 |      11.5s |        10% |
| Build Stokes preconditioner     |        12 |      2.09s |       1.8% |
| Solve Stokes system             |       103 |      90.4s |        79% |
| Solve temperature system        |       103 |      1.53s |       1.3% |
| Postprocessing                  |         3 |     0.532s |      0.46% |
| Refine mesh structure, part 1   |        12 |      0.93s |      0.81% |
| Refine mesh structure, part 2   |        12 |     0.384s |      0.33% |
| Setup dof systems               |        13 |      2.96s |       2.6% |
+---------------------------------+-----------+------------+------------+</pre><p></code></p>
<p><code></p><pre>[...]</pre><p></code></p>
<p><code></p><pre>+---------------------------------------------+------------+------------+
| Total wallclock time elapsed since start    |  9.14e+04s |            |
|                                             |            |            |
| Section                         | no. calls |  wall time | % of total |
+---------------------------------+-----------+------------+------------+
| Assemble Stokes system          |     47045 |  2.05e+03s |       2.2% |
| Assemble temperature matrices   |      4707 |       310s |      0.34% |
| Assemble temperature rhs        |     47045 |   8.7e+03s |       9.5% |
| Build Stokes preconditioner     |      4707 |  1.48e+03s |       1.6% |
| Solve Stokes system             |     47045 |  7.34e+04s |        80% |
| Solve temperature system        |     47045 |  1.46e+03s |       1.6% |
| Postprocessing                  |      1883 |       222s |      0.24% |
| Refine mesh structure, part 1   |      4706 |       641s |       0.7% |
| Refine mesh structure, part 2   |      4706 |       259s |      0.28% |
| Setup dof systems               |      4707 |  1.86e+03s |         2% |
+---------------------------------+-----------+------------+------------+
</pre><p> </code></p>
<p>The simulation terminates when the time reaches the 1 billion years selected in the input file. You can extrapolate from this how long a simulation would take for a different final time (the time step size ultimately settles on somewhere around 20,000 years, so computing for two billion years will take 100,000 time steps, give or take 20%). As can be seen here, we spend most of the compute time in assembling linear systems and &mdash; above all &mdash; in solving Stokes systems.</p>
<p>To demonstrate the output we show the output from every 1250th time step here: </p><table class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-000.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-050.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-100.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-150.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-200.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-250.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-300.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-350.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-400.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-450.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-500.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-550.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-time-600.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-cells.png" alt="" class="inline"/>  </td><td><img src="https://www.dealii.org/images/steps/developer/step-32-2d-partition.png" alt="" class="inline"/>   </td></tr>
</table>
<p>The last two images show the grid as well as the partitioning of the mesh for the same computation with 16 subdomains and 16 processors. The full dynamics of this simulation are really only visible by looking at an animation, for example the one <a href="https://www.dealii.org/images/steps/developer/step-32-2d-temperature.webm">shown on this site</a>. This image is well worth watching due to its artistic quality and entrancing depiction of the evolution of the magma plumes.</p>
<p>If you watch the movie, you'll see that the convection pattern goes through several stages: First, it gets rid of the instable temperature layering with the hot material overlain by the dense cold material. After this great driver is removed and we have a sort of stable situation, a few blobs start to separate from the hot boundary layer at the inner ring and rise up, with a few cold fingers also dropping down from the outer boundary layer. During this phase, the solution remains mostly symmetric, reflecting the 12-fold symmetry of the original mesh. In a final phase, the fluid enters vigorous chaotic stirring in which all symmetries are lost. This is a pattern that then continues to dominate flow.</p>
<p>These different phases can also be identified if we look at the maximal velocity as a function of time in the simulation:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-32.2d.t_vs_vmax.png" alt="" class="inline"/></p>
<p>Here, the velocity (shown in centimeters per year) becomes very large, to the order of several meters per year) at the beginning when the temperature layering is instable. It then calms down to relatively small values before picking up again in the chaotic stirring regime. There, it remains in the range of 10-40 centimeters per year, quite within the physically expected region.</p>
<p><a class="anchor" id="Resultsfora3dsphericalshelltestcase"></a></p><h3>Results for a 3d spherical shell testcase</h3>
<p>3d computations are very expensive computationally. Furthermore, as seen above, interesting behavior only starts after quite a long time requiring more CPU hours than is available on a typical cluster. Consequently, rather than showing a complete simulation here, let us simply show a couple of pictures we have obtained using the successor to this program, called <em>ASPECT</em> (short for <em>Advanced Solver for Problems in Earth's ConvecTion</em>), that is being developed independently of deal.II and that already incorporates some of the extensions discussed below. The following two pictures show isocontours of the temperature and the partition of the domain (along with the mesh) onto 512 processors:</p>
<p align="center"></p>
<p><img src="https://www.dealii.org/images/steps/developer/step-32.3d-sphere.solution.png" alt="" class="inline"/></p>
<p><img src="https://www.dealii.org/images/steps/developer/step-32.3d-sphere.partition.png" alt="" class="inline"/> </p>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p>There are many directions in which this program could be extended. As mentioned at the end of the introduction, most of these are under active development in the <em>ASPECT</em> (short for <em>Advanced Solver for Problems in Earth's ConvecTion</em>) code at the time this tutorial program is being finished. Specifically, the following are certainly topics that one should address to make the program more useful:</p>
<ul>
<li>
<p class="startli"><b>Adiabatic heating/cooling:</b> The temperature field we get in our simulations after a while is mostly constant with boundary layers at the inner and outer boundary, and streamers of cold and hot material mixing everything. Yet, this doesn't match our expectation that things closer to the earth core should be hotter than closer to the surface. The reason is that the energy equation we have used does not include a term that describes adiabatic cooling and heating: rock, like gas, heats up as you compress it. Consequently, material that rises up cools adiabatically, and cold material that sinks down heats adiabatically. The correct temperature equation would therefore look somewhat like this: </p><p class="formulaDsp">
\begin{eqnarray*} \frac{D T}{Dt} - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma + \tau\frac{Dp}{Dt}, \end{eqnarray*}
</p>
<p> or, expanding the advected derivative \(\frac{D}{Dt} = \frac{\partial}{\partial t} + \mathbf u \cdot \nabla\): </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma + \tau\left\{\frac{\partial p}{\partial t} + \mathbf u \cdot \nabla p \right\}. \end{eqnarray*}
</p>
<p> In other words, as pressure increases in a rock volume ( \(\frac{Dp}{Dt}&gt;0\)) we get an additional heat source, and vice versa.</p>
<p class="interli">The time derivative of the pressure is a bit awkward to implement. If necessary, one could approximate using the fact outlined in the introduction that the pressure can be decomposed into a dynamic component due to temperature differences and the resulting flow, and a static component that results solely from the static pressure of the overlying rock. Since the latter is much bigger, one may approximate \(p\approx p_{\text{static}}=-\rho_{\text{ref}} [1+\beta T_{\text{ref}}] \varphi\), and consequently \(\frac{Dp}{Dt} \approx \left\{- \mathbf u \cdot \nabla \rho_{\text{ref}} [1+\beta T_{\text{ref}}]\varphi\right\} = \rho_{\text{ref}} [1+\beta T_{\text{ref}}] \mathbf u \cdot \mathbf g\). In other words, if the fluid is moving in the direction of gravity (downward) it will be compressed and because in that case \(\mathbf u \cdot \mathbf g &gt; 0\) we get a positive heat source. Conversely, the fluid will cool down if it moves against the direction of gravity.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>Compressibility:</b> As already hinted at in the temperature model above, mantle rocks are not incompressible. Rather, given the enormous pressures in the earth mantle (at the core-mantle boundary, the pressure is approximately 140 GPa, equivalent to 1,400,000 times atmospheric pressure), rock actually does compress to something around 1.5 times the density it would have at surface pressure. Modeling this presents any number of difficulties. Primarily, the mass conservation equation is no longer \(\textrm{div}\;\mathbf u=0\) but should read \(\textrm{div}(\rho\mathbf u)=0\) where the density \(\rho\) is now no longer spatially constant but depends on temperature and pressure. A consequence is that the model is now no longer linear; a linearized version of the Stokes equation is also no longer symmetric requiring us to rethink preconditioners and, possibly, even the discretization. We won't go into detail here as to how this can be resolved.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>Nonlinear material models:</b> As already hinted at in various places, material parameters such as the density, the viscosity, and the various thermal parameters are not constant throughout the earth mantle. Rather, they nonlinearly depend on the pressure and temperature, and in the case of the viscosity on the strain rate \(\varepsilon(\mathbf u)\). For complicated models, the only way to solve such models accurately may be to actually iterate this dependence out in each time step, rather than simply freezing coefficients at values extrapolated from the previous time <a class="el" href="time__dependent__0_8txt.html#ab9cc54059a16283ee23a73040525b564">step(s)</a>.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>Checkpoint/restart:</b> Running this program in 2d on a number of processors allows solving realistic models in a day or two. However, in 3d, compute times are so large that one runs into two typical problems: (i) On most compute clusters, the queuing system limits run times for individual jobs are to 2 or 3 days; (ii) losing the results of a computation due to hardware failures, misconfigurations, or power outages is a shame when running on hundreds of processors for a couple of days. Both of these problems can be addressed by periodically saving the state of the program and, if necessary, restarting the program at this point. This technique is commonly called <em>checkpoint/restart</em> and it requires that the entire state of the program is written to a permanent storage location (e.g. a hard drive). Given the complexity of the data structures of this program, this is not entirely trivial (it may also involve writing gigabytes or more of data), but it can be made easier by realizing that one can save the state between two time steps where it essentially only consists of the mesh and solution vectors; during restart one would then first re-enumerate degrees of freedom in the same way as done before and then re-assemble matrices. Nevertheless, given the distributed nature of the data structures involved here, saving and restoring the state of a program is not trivial. An additional complexity is introduced by the fact that one may want to change the number of processors between runs, for example because one may wish to continue computing on a mesh that is finer than the one used to precompute a starting temperature field at an intermediate time.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>Predictive postprocessing:</b> The point of computations like this is not simply to solve the equations. Rather, it is typically the exploration of different physical models and their comparison with things that we can measure at the earth surface, in order to find which models are realistic and which are contradicted by reality. To this end, we need to compute quantities from our solution vectors that are related to what we can observe. Among these are, for example, heatfluxes at the surface of the earth, as well as seismic velocities throughout the mantle as these affect earthquake waves that are recorded by seismographs.</p>
<p class="endli"></p>
</li>
<li>
<b>Better refinement criteria:</b> As can be seen above for the 3d case, the mesh in 3d is primarily refined along the inner boundary. This is because the boundary layer there is stronger than any other transition in the domain, leading us to refine there almost exclusively and basically not at all following the plumes. One certainly needs better refinement criteria to track the parts of the solution we are really interested in better than the criterion used here, namely the <a class="el" href="classKellyErrorEstimator.html">KellyErrorEstimator</a> applied to the temperature, is able to. </li>
</ul>
<p>There are many other ways to extend the current program. However, rather than discussing them here, let us point to the much larger open source code ASPECT (see <a href="https://aspect.geodynamics.org/">https://aspect.geodynamics.org/</a> ) that constitutes the further development of <a class="el" href="step_32.html">step-32</a> and that already includes many such possible extensions.</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2008 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Martin Kronbichler, Uppsala University,</span></div>
<div class="line"><span class="comment"> *          Wolfgang Bangerth, Texas A&amp;M University,</span></div>
<div class="line"><span class="comment"> *          Timo Heister, University of Goettingen, 2008-2011</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2work__stream_8h.html">deal.II/base/work_stream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2parameter__handler_8h.html">deal.II/base/parameter_handler.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__bicgstab_8h.html">deal.II/lac/solver_bicgstab.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__solver_8h.html">deal.II/lac/trilinos_solver.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2filtered__iterator_8h.html">deal.II/grid/filtered_iterator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgq_8h.html">deal.II/fe/fe_dgq.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgp_8h.html">deal.II/fe/fe_dgp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;locale&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2solution__transfer_8h.html">deal.II/distributed/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep32.html">Step32</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>EquationData</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a>                   = 1e21;    <span class="comment">/* Pa s       */</span></div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">kappa</a>                 = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6;    <span class="comment">/* m^2 / s    */</span></div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#acbc07b5e8caacadaf9798840a22d1603">reference_density</a>     = 3300;    <span class="comment">/* kg / m^3   */</span></div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a7abacfbb83b0ac35324d60dbc2a4ac27">reference_temperature</a> = 293;     <span class="comment">/* K          */</span></div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a3c097e8f7581f3b04d6a31eb66b11c8c">expansion_coefficient</a> = 2<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-5;    <span class="comment">/* 1/K        */</span></div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">specific_heat</a>         = 1250;    <span class="comment">/* J / K / kg */</span></div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">radiogenic_heating</a>    = 7.4e-12; <span class="comment">/* W / kg     */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a> = 6371000. - 2890000.; <span class="comment">/* m          */</span></div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a> = 6371000. - 35000.;   <span class="comment">/* m          */</span></div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a1057295293dd9dfa723788107acc509e">T0</a> = 4000 + 273; <span class="comment">/* K          */</span></div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a00bf6e26439db0d8e3b91f11ee4fd72a">T1</a> = 700 + 273;  <span class="comment">/* K          */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">return</span> (</div>
<div class="line">        <a class="code" href="namespaceStep32_1_1EquationData.html#acbc07b5e8caacadaf9798840a22d1603">reference_density</a> *</div>
<div class="line">        (1 - <a class="code" href="namespaceStep32_1_1EquationData.html#a3c097e8f7581f3b04d6a31eb66b11c8c">expansion_coefficient</a> * (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> - <a class="code" href="namespaceStep32_1_1EquationData.html#a7abacfbb83b0ac35324d60dbc2a4ac27">reference_temperature</a>)));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="namespaceStep32_1_1EquationData.html#a7c001f60e6c7c0bcd347e3f7b66a5402">gravity_vector</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> r = <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>.norm();</div>
<div class="line">      <span class="keywordflow">return</span> -(1.245e-6 * r + 7.714e13 / r / r) * <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> / r;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>TemperatureInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      TemperatureInitialValues()</div>
<div class="line">        : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> r = <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>.norm();</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="auto__derivative__function__0_8txt.html#af5d8dd2d035de856717fb6b5c9438dd5">h</a> = <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a> - <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a>;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> = (r - <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a>) / <a class="code" href="auto__derivative__function__0_8txt.html#af5d8dd2d035de856717fb6b5c9438dd5">h</a>;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> q =</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3) ? <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(0.0, <a class="code" href="base_2numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">cos</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> * <a class="code" href="base_2numbers_8h.html#a0ebae11c64606a73e80a6328b1ab0802">abs</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(2) / <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a>))) : 1.0;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> phi = <a class="code" href="namespaceDifferentiation_1_1SD.html#a130b20f2ea3522f1d123c75c63c0f67d">std::atan2</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0), <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(1));</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> tau = <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> + 0.2 * <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> * (1 - <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>) * <a class="code" href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">std::sin</a>(6 * phi) * q;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a1057295293dd9dfa723788107acc509e">T0</a> * (1.0 - tau) + <a class="code" href="namespaceStep32_1_1EquationData.html#a00bf6e26439db0d8e3b91f11ee4fd72a">T1</a> * tau;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keywordtype">void</span></div>
<div class="line">    <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">TemperatureInitialValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                                <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">pressure_scaling</a> = <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a> / 10000;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">year_in_seconds</a> = 60 * 60 * 24 * 365.2425;</div>
<div class="line"> </div>
<div class="line">  } <span class="comment">// namespace EquationData</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      BlockSchurPreconditioner(<span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">                               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;Spre,</div>
<div class="line">                               <span class="keyword">const</span> PreconditionerTypeMp &amp;Mppreconditioner,</div>
<div class="line">                               <span class="keyword">const</span> PreconditionerTypeA &amp; Apreconditioner,</div>
<div class="line">                               <span class="keyword">const</span> <span class="keywordtype">bool</span>                  do_solve_A)</div>
<div class="line">        : stokes_matrix(&amp;S)</div>
<div class="line">        , stokes_preconditioner_matrix(&amp;Spre)</div>
<div class="line">        , mp_preconditioner(Mppreconditioner)</div>
<div class="line">        , a_preconditioner(Apreconditioner)</div>
<div class="line">        , do_solve_A(do_solve_A)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                 <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">      </span>{</div>
<div class="line">        <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> utmp(src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(5000, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1).l2_norm());</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_preconditioner_matrix-&gt;block(1, 1),</div>
<div class="line">                       <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1),</div>
<div class="line">                       src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1),</div>
<div class="line">                       mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1) *= -1.0;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">          stokes_matrix-&gt;block(0, 1).<a class="code" href="classSparseVanka.html#a34195e21adf1756d5d316cfc1091d843">vmult</a>(utmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1));</div>
<div class="line">          utmp *= -1.0;</div>
<div class="line">          utmp.add(src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (do_solve_A == <span class="keyword">true</span>)</div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(5000, utmp.l2_norm() * 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-2);</div>
<div class="line">            <a class="code" href="classTrilinosWrappers_1_1SolverCG.html">TrilinosWrappers::SolverCG</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line">            <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix-&gt;block(0, 0),</div>
<div class="line">                         <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0),</div>
<div class="line">                         utmp,</div>
<div class="line">                         a_preconditioner);</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          a_preconditioner.vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), utmp);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">        stokes_matrix;</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">                                  stokes_preconditioner_matrix;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerTypeMp &amp;mp_preconditioner;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerTypeA &amp; a_preconditioner;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">bool</span>                  do_solve_A;</div>
<div class="line">    };</div>
<div class="line">  } <span class="comment">// namespace LinearSolvers</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>Assembly</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">namespace </span>Scratch</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      <span class="keyword">struct </span>StokesPreconditioner</div>
<div class="line">      {</div>
<div class="line">        StokesPreconditioner(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">                             <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">                             <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                             <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         update_flags);</div>
<div class="line"> </div>
<div class="line">        StokesPreconditioner(<span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> stokes_fe_values;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u;</div>
<div class="line">        std::vector&lt;double&gt;         phi_p;</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         update_flags)</div>
<div class="line">        : stokes_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, stokes_fe, stokes_quadrature, update_flags)</div>
<div class="line">        , grad_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , phi_p(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> StokesPreconditioner &amp;scratch)</div>
<div class="line">        : stokes_fe_values(scratch.stokes_fe_values.get_mapping(),</div>
<div class="line">                           scratch.stokes_fe_values.get_fe(),</div>
<div class="line">                           scratch.stokes_fe_values.get_quadrature(),</div>
<div class="line">                           scratch.stokes_fe_values.get_update_flags())</div>
<div class="line">        , grad_phi_u(scratch.grad_phi_u)</div>
<div class="line">        , phi_p(scratch.phi_p)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      <span class="keyword">struct </span>StokesSystem : <span class="keyword">public</span> StokesPreconditioner&lt;dim&gt;</div>
<div class="line">      {</div>
<div class="line">        StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">                     <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                     <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">                     <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         stokes_update_flags,</div>
<div class="line">                     <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">                     <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         temperature_update_flags);</div>
<div class="line"> </div>
<div class="line">        StokesSystem(<span class="keyword">const</span> StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt;          phi_u;</div>
<div class="line">        std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; grads_phi_u;</div>
<div class="line">        std::vector&lt;double&gt;                  div_phi_u;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;double&gt; old_temperature_values;</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      StokesSystem&lt;dim&gt;::StokesSystem(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         stokes_update_flags,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         temperature_update_flags)</div>
<div class="line">        : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_fe,</div>
<div class="line">                                    stokes_quadrature,</div>
<div class="line">                                    <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                    stokes_update_flags)</div>
<div class="line">        , temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                temperature_fe,</div>
<div class="line">                                stokes_quadrature,</div>
<div class="line">                                temperature_update_flags)</div>
<div class="line">        , phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , grads_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , div_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , old_temperature_values(stokes_quadrature.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      StokesSystem&lt;dim&gt;::StokesSystem(<span class="keyword">const</span> StokesSystem&lt;dim&gt; &amp;scratch)</div>
<div class="line">        : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(scratch)</div>
<div class="line">        , temperature_fe_values(</div>
<div class="line">            scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">            scratch.temperature_fe_values.get_fe(),</div>
<div class="line">            scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">            scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">        , phi_u(scratch.phi_u)</div>
<div class="line">        , grads_phi_u(scratch.grads_phi_u)</div>
<div class="line">        , div_phi_u(scratch.div_phi_u)</div>
<div class="line">        , old_temperature_values(scratch.old_temperature_values)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      <span class="keyword">struct </span>TemperatureMatrix</div>
<div class="line">      {</div>
<div class="line">        TemperatureMatrix(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">                          <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   temperature_quadrature);</div>
<div class="line"> </div>
<div class="line">        TemperatureMatrix(<span class="keyword">const</span> TemperatureMatrix &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;double&gt;         phi_T;</div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T;</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   temperature_quadrature)</div>
<div class="line">        : temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                temperature_fe,</div>
<div class="line">                                temperature_quadrature,</div>
<div class="line">                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>)</div>
<div class="line">        , phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , grad_phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">        <span class="keyword">const</span> TemperatureMatrix &amp;scratch)</div>
<div class="line">        : temperature_fe_values(</div>
<div class="line">            scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">            scratch.temperature_fe_values.get_fe(),</div>
<div class="line">            scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">            scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">        , phi_T(scratch.phi_T)</div>
<div class="line">        , grad_phi_T(scratch.grad_phi_T)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      <span class="keyword">struct </span>TemperatureRHS</div>
<div class="line">      {</div>
<div class="line">        TemperatureRHS(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                       <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>);</div>
<div class="line"> </div>
<div class="line">        TemperatureRHS(<span class="keyword">const</span> TemperatureRHS &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line">        <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> stokes_fe_values;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;double&gt;         phi_T;</div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_velocity_values;</div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_velocity_values;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_strain_rates;</div>
<div class="line">        std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_old_strain_rates;</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;double&gt;         old_temperature_values;</div>
<div class="line">        std::vector&lt;double&gt;         old_old_temperature_values;</div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_temperature_grads;</div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_temperature_grads;</div>
<div class="line">        std::vector&lt;double&gt;         old_temperature_laplacians;</div>
<div class="line">        std::vector&lt;double&gt;         old_old_temperature_laplacians;</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      TemperatureRHS&lt;dim&gt;::TemperatureRHS(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>)</div>
<div class="line">        : temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                temperature_fe,</div>
<div class="line">                                <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>,</div>
<div class="line">                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>)</div>
<div class="line">        , stokes_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                           stokes_fe,</div>
<div class="line">                           <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>,</div>
<div class="line">                           <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>)</div>
<div class="line">        , phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , grad_phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        ,</div>
<div class="line"> </div>
<div class="line">        old_velocity_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        , old_old_velocity_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        , old_strain_rates(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        , old_old_strain_rates(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        ,</div>
<div class="line"> </div>
<div class="line">        old_temperature_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        , old_old_temperature_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        , old_temperature_grads(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        , old_old_temperature_grads(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        , old_temperature_laplacians(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">        , old_old_temperature_laplacians(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      TemperatureRHS&lt;dim&gt;::TemperatureRHS(<span class="keyword">const</span> TemperatureRHS &amp;scratch)</div>
<div class="line">        : temperature_fe_values(</div>
<div class="line">            scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">            scratch.temperature_fe_values.get_fe(),</div>
<div class="line">            scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">            scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">        , stokes_fe_values(scratch.stokes_fe_values.get_mapping(),</div>
<div class="line">                           scratch.stokes_fe_values.get_fe(),</div>
<div class="line">                           scratch.stokes_fe_values.get_quadrature(),</div>
<div class="line">                           scratch.stokes_fe_values.get_update_flags())</div>
<div class="line">        , phi_T(scratch.phi_T)</div>
<div class="line">        , grad_phi_T(scratch.grad_phi_T)</div>
<div class="line">        ,</div>
<div class="line"> </div>
<div class="line">        old_velocity_values(scratch.old_velocity_values)</div>
<div class="line">        , old_old_velocity_values(scratch.old_old_velocity_values)</div>
<div class="line">        , old_strain_rates(scratch.old_strain_rates)</div>
<div class="line">        , old_old_strain_rates(scratch.old_old_strain_rates)</div>
<div class="line">        ,</div>
<div class="line"> </div>
<div class="line">        old_temperature_values(scratch.old_temperature_values)</div>
<div class="line">        , old_old_temperature_values(scratch.old_old_temperature_values)</div>
<div class="line">        , old_temperature_grads(scratch.old_temperature_grads)</div>
<div class="line">        , old_old_temperature_grads(scratch.old_old_temperature_grads)</div>
<div class="line">        , old_temperature_laplacians(scratch.old_temperature_laplacians)</div>
<div class="line">        , old_old_temperature_laplacians(scratch.old_old_temperature_laplacians)</div>
<div class="line">      {}</div>
<div class="line">    } <span class="comment">// namespace Scratch</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">namespace </span><a class="code" href="structCopyData.html">CopyData</a></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      <span class="keyword">struct </span>StokesPreconditioner</div>
<div class="line">      {</div>
<div class="line">        StokesPreconditioner(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe);</div>
<div class="line">        StokesPreconditioner(<span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">        StokesPreconditioner &amp;<a class="code" href="chunk__sparse__matrix__0_8txt.html#aa747ba884f098177e9bf2b2422a461a9">operator=</a>(<span class="keyword">const</span> StokesPreconditioner &amp;) = <span class="keywordflow">default</span>;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_matrix;</div>
<div class="line">        std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe)</div>
<div class="line">        : local_matrix(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(), stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">        : local_matrix(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix)</div>
<div class="line">        , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      <span class="keyword">struct </span>StokesSystem : <span class="keyword">public</span> StokesPreconditioner&lt;dim&gt;</div>
<div class="line">      {</div>
<div class="line">        StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs;</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      StokesSystem&lt;dim&gt;::StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe)</div>
<div class="line">        : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_fe)</div>
<div class="line">        , local_rhs(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      <span class="keyword">struct </span>TemperatureMatrix</div>
<div class="line">      {</div>
<div class="line">        TemperatureMatrix(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_mass_matrix;</div>
<div class="line">        <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_stiffness_matrix;</div>
<div class="line">        std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe)</div>
<div class="line">        : local_mass_matrix(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                            temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , local_stiffness_matrix(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                                 temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      <span class="keyword">struct </span>TemperatureRHS</div>
<div class="line">      {</div>
<div class="line">        TemperatureRHS(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classVector.html">Vector&lt;double&gt;</a>                       local_rhs;</div>
<div class="line">        std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">        <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   matrix_for_bc;</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">      TemperatureRHS&lt;dim&gt;::TemperatureRHS(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe)</div>
<div class="line">        : local_rhs(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">        , matrix_for_bc(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                        temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      {}</div>
<div class="line">    } <span class="comment">// namespace CopyData</span></div>
<div class="line">  }   <span class="comment">// namespace Assembly</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>BoussinesqFlowProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">struct </span>Parameters;</div>
<div class="line">    BoussinesqFlowProblem(Parameters &amp;<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>);</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span>   setup_dofs();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_stokes_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span>   build_stokes_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_stokes_system();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_temperature_matrix();</div>
<div class="line">    <span class="keywordtype">void</span>   assemble_temperature_system(<span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity);</div>
<div class="line">    <span class="keywordtype">double</span> get_maximal_velocity() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">double</span> get_cfl_number() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">double</span> get_entropy_variation(<span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature) <span class="keyword">const</span>;</div>
<div class="line">    std::pair&lt;double, double&gt; get_extrapolated_temperature_range() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span>                      <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span>                      output_results();</div>
<div class="line">    <span class="keywordtype">void</span>                      refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_strain_rates,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_old_strain_rates,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_u_infty,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_T_variation,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                average_temperature,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_entropy_variation,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">struct </span>Parameters</div>
<div class="line">    {</div>
<div class="line">      Parameters(<span class="keyword">const</span> std::string &amp;parameter_filename);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">declare_parameters</a>(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line">      <span class="keywordtype">void</span>        parse_parameters(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> end_time;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_global_refinement;</div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_adaptive_refinement;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">bool</span>         generate_graphical_output;</div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> graphical_output_interval;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> adaptive_refinement_interval;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> stabilization_alpha;</div>
<div class="line">      <span class="keywordtype">double</span> stabilization_c_R;</div>
<div class="line">      <span class="keywordtype">double</span> stabilization_beta;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_velocity_degree;</div>
<div class="line">      <span class="keywordtype">bool</span>         use_locally_conservative_discretization;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> temperature_degree;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    Parameters &amp;<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <span class="keywordtype">double</span>                                    global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classMappingQ.html">MappingQ&lt;dim&gt;</a> <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>       stokes_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           stokes_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> stokes_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_stokes_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 temperature_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           temperature_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> temperature_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_mass_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_stiffness_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_temperature_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>       time_step;</div>
<div class="line">    <span class="keywordtype">double</span>       old_time_step;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionAMG&gt;    Amg_preconditioner;</div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionJacobi&gt; Mp_preconditioner;</div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionJacobi&gt; T_preconditioner;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_stokes_matrix;</div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_stokes_preconditioner;</div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_temperature_matrices;</div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_temperature_preconditioner;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTimerOutput.html">TimerOutput</a> computing_timer;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setup_stokes_matrix(</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning);</div>
<div class="line">    <span class="keywordtype">void</span> setup_stokes_preconditioner(</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning);</div>
<div class="line">    <span class="keywordtype">void</span> setup_temperature_matrices(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_partitioning,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_relevant_partitioning);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> local_assemble_stokes_preconditioner(</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">      Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">      Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> copy_local_to_global_stokes_preconditioner(</div>
<div class="line">      <span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> local_assemble_stokes_system(</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">      Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">      Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> copy_local_to_global_stokes_system(</div>
<div class="line">      <span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> local_assemble_temperature_matrix(</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">      Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">      Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> copy_local_to_global_temperature_matrix(</div>
<div class="line">      <span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> local_assemble_temperature_rhs(</div>
<div class="line">      <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_velocity,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_entropy_variation,</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">      Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">      Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> copy_local_to_global_temperature_rhs(</div>
<div class="line">      <span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">class </span>Postprocessor;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::Parameters::Parameters(</div>
<div class="line">    <span class="keyword">const</span> std::string &amp;parameter_filename)</div>
<div class="line">    : end_time(1e8)</div>
<div class="line">    , initial_global_refinement(2)</div>
<div class="line">    , initial_adaptive_refinement(2)</div>
<div class="line">    , adaptive_refinement_interval(10)</div>
<div class="line">    , stabilization_alpha(2)</div>
<div class="line">    , stabilization_c_R(0.11)</div>
<div class="line">    , stabilization_beta(0.078)</div>
<div class="line">    , stokes_velocity_degree(2)</div>
<div class="line">    , use_locally_conservative_discretization(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    , temperature_degree(2)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classParameterHandler.html">ParameterHandler</a> prm;</div>
<div class="line">    <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">BoussinesqFlowProblem&lt;dim&gt;::Parameters::declare_parameters</a>(prm);</div>
<div class="line"> </div>
<div class="line">    std::ifstream parameter_file(parameter_filename);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!parameter_file)</div>
<div class="line">      {</div>
<div class="line">        parameter_file.close();</div>
<div class="line"> </div>
<div class="line">        std::ofstream parameter_out(parameter_filename);</div>
<div class="line">        prm.<a class="code" href="classParameterHandler.html#a4ac3a8b19ade16e96e8ea25906daf23a">print_parameters</a>(parameter_out, <a class="code" href="group__Exceptions.html#ga8364dda711b93753c6809eefe2a8e827a3a1480568c2713f53dcb21319bb28093">ParameterHandler::Text</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(</div>
<div class="line">          <span class="keyword">false</span>,</div>
<div class="line">          <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">            <span class="stringliteral">&quot;Input parameter file &lt;&quot;</span> + parameter_filename +</div>
<div class="line">            <span class="stringliteral">&quot;&gt; not found. Creating a template file of the same name.&quot;</span>));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">parse_input</a>(parameter_file);</div>
<div class="line">    parse_parameters(prm);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">BoussinesqFlowProblem&lt;dim&gt;::Parameters::declare_parameters</a>(</div>
<div class="line">    <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">  {</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;End time&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;1e8&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                      <span class="stringliteral">&quot;The end time of the simulation in years.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Initial global refinement&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div>
<div class="line">                      <span class="stringliteral">&quot;The number of global refinement steps performed on &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;the initial coarse mesh, before the problem is first &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;solved there.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Initial adaptive refinement&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div>
<div class="line">                      <span class="stringliteral">&quot;The number of adaptive refinement steps performed after &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;initial global refinement.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Time steps between mesh refinement&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;10&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">                      <span class="stringliteral">&quot;The number of time steps after which the mesh is to be &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;adapted based on computed error indicators.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Generate graphical output&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;false&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(),</div>
<div class="line">                      <span class="stringliteral">&quot;Whether graphical output is to be generated or not. &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;You may not want to get graphical output if the number &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;of processors is large.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Time steps between graphical output&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;50&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">                      <span class="stringliteral">&quot;The number of time steps between each generation of &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;graphical output files.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Stabilization parameters&quot;</span>);</div>
<div class="line">    {</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;alpha&quot;</span>,</div>
<div class="line">                        <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                        <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(1, 2),</div>
<div class="line">                        <span class="stringliteral">&quot;The exponent in the entropy viscosity stabilization.&quot;</span>);</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;c_R&quot;</span>,</div>
<div class="line">                        <span class="stringliteral">&quot;0.11&quot;</span>,</div>
<div class="line">                        <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                        <span class="stringliteral">&quot;The c_R factor in the entropy viscosity &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;stabilization.&quot;</span>);</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;beta&quot;</span>,</div>
<div class="line">                        <span class="stringliteral">&quot;0.078&quot;</span>,</div>
<div class="line">                        <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                        <span class="stringliteral">&quot;The beta factor in the artificial viscosity &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;stabilization. An appropriate value for 2d is 0.052 &quot;</span></div>
<div class="line">                        <span class="stringliteral">&quot;and 0.078 for 3d.&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line"> </div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Discretization&quot;</span>);</div>
<div class="line">    {</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">        <span class="stringliteral">&quot;Stokes velocity polynomial degree&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">        <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">        <span class="stringliteral">&quot;The polynomial degree to use for the velocity variables &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;in the Stokes system.&quot;</span>);</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">        <span class="stringliteral">&quot;Temperature polynomial degree&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">        <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">        <span class="stringliteral">&quot;The polynomial degree to use for the temperature variable.&quot;</span>);</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">        <span class="stringliteral">&quot;Use locally conservative discretization&quot;</span>,</div>
<div class="line">        <span class="stringliteral">&quot;true&quot;</span>,</div>
<div class="line">        <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(),</div>
<div class="line">        <span class="stringliteral">&quot;Whether to use a Stokes discretization that is locally &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;conservative at the expense of a larger number of degrees &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;of freedom, or to go with a cheaper discretization &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;that does not locally conserve mass (although it is &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;globally conservative.&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::Parameters::parse_parameters(</div>
<div class="line">    <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">  {</div>
<div class="line">    end_time                  = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;End time&quot;</span>);</div>
<div class="line">    initial_global_refinement = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Initial global refinement&quot;</span>);</div>
<div class="line">    initial_adaptive_refinement =</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Initial adaptive refinement&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    adaptive_refinement_interval =</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Time steps between mesh refinement&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    generate_graphical_output = prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;Generate graphical output&quot;</span>);</div>
<div class="line">    graphical_output_interval =</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Time steps between graphical output&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Stabilization parameters&quot;</span>);</div>
<div class="line">    {</div>
<div class="line">      stabilization_alpha = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;alpha&quot;</span>);</div>
<div class="line">      stabilization_c_R   = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;c_R&quot;</span>);</div>
<div class="line">      stabilization_beta  = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;beta&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line"> </div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Discretization&quot;</span>);</div>
<div class="line">    {</div>
<div class="line">      stokes_velocity_degree =</div>
<div class="line">        prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Stokes velocity polynomial degree&quot;</span>);</div>
<div class="line">      temperature_degree = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Temperature polynomial degree&quot;</span>);</div>
<div class="line">      use_locally_conservative_discretization =</div>
<div class="line">        prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;Use locally conservative discretization&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::BoussinesqFlowProblem(Parameters &amp;parameters_)</div>
<div class="line">    : <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>(parameters_)</div>
<div class="line">    , pcout(std::cout, (<a class="code" href="namespaceUtilities.html">Utilities</a>::<a class="code" href="base_2partitioner__0_8txt.html#a6d2d0fa485d1660823c59c494fb0fb31">MPI</a>::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(MPI_COMM_WORLD) == 0))</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(MPI_COMM_WORLD,</div>
<div class="line">                  typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::MeshSmoothing(</div>
<div class="line">                    <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::smoothing_on_refinement |</div>
<div class="line">                    <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::smoothing_on_coarsening))</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    global_Omega_diameter(0.)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(4)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree),</div>
<div class="line">              <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">              (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.use_locally_conservative_discretization ?</div>
<div class="line">                 static_cast&lt;<a class="code" href="coding__conventions__0_8txt.html#ad54c4de985d6d1b46aaf6ae96ae8d3a1">const</a> <a class="code" href="classFiniteElement.html">FiniteElement</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt; &amp;&gt;(</div>
<div class="line">                   <a class="code" href="classFE__DGP.html">FE_DGP</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree - 1)) :</div>
<div class="line">                 static_cast&lt;<a class="code" href="coding__conventions__0_8txt.html#ad54c4de985d6d1b46aaf6ae96ae8d3a1">const</a> <a class="code" href="classFiniteElement.html">FiniteElement</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt; &amp;&gt;(</div>
<div class="line">                   <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree - 1))),</div>
<div class="line">              1)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    stokes_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    temperature_fe(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree)</div>
<div class="line">    , temperature_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    time_step(0)</div>
<div class="line">    , old_time_step(0)</div>
<div class="line">    , timestep_number(0)</div>
<div class="line">    , rebuild_stokes_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    , rebuild_stokes_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    , rebuild_temperature_matrices(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    , rebuild_temperature_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    computing_timer(MPI_COMM_WORLD,</div>
<div class="line">                    pcout,</div>
<div class="line">                    <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div>
<div class="line">                    <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_maximal_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                            <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            stokes_fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_local_velocity = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">        {</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                    velocity_values);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">            max_local_velocity =</div>
<div class="line">              <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(max_local_velocity, MPI_COMM_WORLD);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_cfl_number()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                            <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            stokes_fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_local_cfl = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">        {</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                    velocity_values);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordtype">double</span> max_local_velocity = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-10;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">            max_local_velocity =</div>
<div class="line">              <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">          max_local_cfl =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_cfl, max_local_velocity / <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(max_local_cfl, MPI_COMM_WORLD);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_entropy_variation(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha != 2)</div>
<div class="line">      <span class="keywordflow">return</span> 1.;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 1);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>       fe_values(temperature_fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> min_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">           max_entropy = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(), area = 0,</div>
<div class="line">           entropy_integrated = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">        {</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                        old_temperature_values);</div>
<div class="line">          fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                        old_old_temperature_values);</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> =</div>
<div class="line">                (old_temperature_values[q] + old_old_temperature_values[q]) / 2;</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> entropy =</div>
<div class="line">                ((<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> - average_temperature) * (<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> - average_temperature));</div>
<div class="line"> </div>
<div class="line">              min_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_entropy, entropy);</div>
<div class="line">              max_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_entropy, entropy);</div>
<div class="line">              area += fe_values.JxW(q);</div>
<div class="line">              entropy_integrated += fe_values.JxW(q) * entropy;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> local_sums[2]   = {entropy_integrated, area},</div>
<div class="line">                 local_maxima[2] = {-min_entropy, max_entropy};</div>
<div class="line">    <span class="keywordtype">double</span> global_sums[2], global_maxima[2];</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a>(local_sums, MPI_COMM_WORLD, global_sums);</div>
<div class="line">    <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(local_maxima, MPI_COMM_WORLD, global_maxima);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> average_entropy = global_sums[0] / global_sums[1];</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> entropy_diff    = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(global_maxima[1] - average_entropy,</div>
<div class="line">                                         average_entropy - (-global_maxima[0]));</div>
<div class="line">    <span class="keywordflow">return</span> entropy_diff;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::pair&lt;double, double&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::get_extrapolated_temperature_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                            <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>       fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            temperature_fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> min_local_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">           max_local_temperature = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">            {</div>
<div class="line">              fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">              fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                            old_temperature_values);</div>
<div class="line">              fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                            old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> =</div>
<div class="line">                    (1. + time_step / old_time_step) *</div>
<div class="line">                      old_temperature_values[q] -</div>
<div class="line">                    time_step / old_time_step * old_old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">                  min_local_temperature =</div>
<div class="line">                    <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                  max_local_temperature =</div>
<div class="line">                    <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">            {</div>
<div class="line">              fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">              fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                            old_temperature_values);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> = old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">                  min_local_temperature =</div>
<div class="line">                    <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                  max_local_temperature =</div>
<div class="line">                    <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> local_extrema[2] = {-min_local_temperature, max_local_temperature};</div>
<div class="line">    <span class="keywordtype">double</span> global_extrema[2];</div>
<div class="line">    <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(local_extrema, MPI_COMM_WORLD, global_extrema);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> std::make_pair(-global_extrema[0], global_extrema[1]);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_temperature,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_old_temperature,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_strain_rates,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_old_strain_rates,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_u_infty,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_T_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                average_temperature,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_entropy_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (global_u_infty == 0)</div>
<div class="line">      <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 * cell_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_temperature.size();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_residual = 0;</div>
<div class="line">    <span class="keywordtype">double</span> max_velocity = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u =</div>
<div class="line">          (old_velocity_values[q] + old_old_velocity_values[q]) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> strain_rate =</div>
<div class="line">          (old_strain_rates[q] + old_old_strain_rates[q]) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> = (old_temperature[q] + old_old_temperature[q]) / 2;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dT_dt =</div>
<div class="line">          (old_temperature[q] - old_old_temperature[q]) / old_time_step;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_T =</div>
<div class="line">          u * (old_temperature_grads[q] + old_old_temperature_grads[q]) / 2;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> kappa_Delta_T =</div>
<div class="line">          <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> *</div>
<div class="line">          (old_temperature_laplacians[q] + old_old_temperature_laplacians[q]) /</div>
<div class="line">          2;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> =</div>
<div class="line">          ((<a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">EquationData::radiogenic_heating</a> * <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>) +</div>
<div class="line">            2 * <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * strain_rate * strain_rate) /</div>
<div class="line">           (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>) * <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">EquationData::specific_heat</a>));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> = <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>(dT_dt + u_grad_T - kappa_Delta_T - <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a>);</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha == 2)</div>
<div class="line">          <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> *= <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> - average_temperature);</div>
<div class="line"> </div>
<div class="line">        max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">        max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u * u), max_velocity);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> max_viscosity =</div>
<div class="line">      (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_beta * max_velocity * cell_diameter);</div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number == 0)</div>
<div class="line">      <span class="keywordflow">return</span> max_viscosity;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(old_time_step &gt; 0, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> entropy_viscosity;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha == 2)</div>
<div class="line">          entropy_viscosity =</div>
<div class="line">            (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_c_R * cell_diameter * cell_diameter *</div>
<div class="line">             max_residual / global_entropy_variation);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          entropy_viscosity =</div>
<div class="line">            (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_c_R * cell_diameter *</div>
<div class="line">             global_Omega_diameter * max_velocity * max_residual /</div>
<div class="line">             (global_u_infty * global_T_variation));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(max_viscosity, entropy_viscosity);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_stokes_matrix(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning)</div>
<div class="line">  {</div>
<div class="line">    stokes_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> sp(stokes_partitioning,</div>
<div class="line">                                              stokes_partitioning,</div>
<div class="line">                                              stokes_relevant_partitioning,</div>
<div class="line">                                              MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(stokes_dof_handler,</div>
<div class="line">                                    coupling,</div>
<div class="line">                                    sp,</div>
<div class="line">                                    stokes_constraints,</div>
<div class="line">                                    <span class="keyword">false</span>,</div>
<div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                      MPI_COMM_WORLD));</div>
<div class="line">    sp.compress();</div>
<div class="line"> </div>
<div class="line">    stokes_matrix.reinit(sp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_stokes_preconditioner(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning)</div>
<div class="line">  {</div>
<div class="line">    Amg_preconditioner.reset();</div>
<div class="line">    Mp_preconditioner.reset();</div>
<div class="line"> </div>
<div class="line">    stokes_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> sp(stokes_partitioning,</div>
<div class="line">                                              stokes_partitioning,</div>
<div class="line">                                              stokes_relevant_partitioning,</div>
<div class="line">                                              MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(stokes_dof_handler,</div>
<div class="line">                                    coupling,</div>
<div class="line">                                    sp,</div>
<div class="line">                                    stokes_constraints,</div>
<div class="line">                                    <span class="keyword">false</span>,</div>
<div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                      MPI_COMM_WORLD));</div>
<div class="line">    sp.compress();</div>
<div class="line"> </div>
<div class="line">    stokes_preconditioner_matrix.reinit(sp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_temperature_matrices(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_partitioner,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_relevant_partitioner)</div>
<div class="line">  {</div>
<div class="line">    T_preconditioner.reset();</div>
<div class="line">    temperature_mass_matrix.clear();</div>
<div class="line">    temperature_stiffness_matrix.clear();</div>
<div class="line">    temperature_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> sp(temperature_partitioner,</div>
<div class="line">                                         temperature_partitioner,</div>
<div class="line">                                         temperature_relevant_partitioner,</div>
<div class="line">                                         MPI_COMM_WORLD);</div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(temperature_dof_handler,</div>
<div class="line">                                    sp,</div>
<div class="line">                                    temperature_constraints,</div>
<div class="line">                                    <span class="keyword">false</span>,</div>
<div class="line">                                    <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                      MPI_COMM_WORLD));</div>
<div class="line">    sp.compress();</div>
<div class="line"> </div>
<div class="line">    temperature_matrix.reinit(sp);</div>
<div class="line">    temperature_mass_matrix.reinit(sp);</div>
<div class="line">    temperature_stiffness_matrix.reinit(sp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing_section(computing_timer, <span class="stringliteral">&quot;Setup dof systems&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    stokes_dof_handler.distribute_dofs(stokes_fe);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;unsigned int&gt; stokes_sub_blocks(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">    stokes_sub_blocks[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">    temperature_dof_handler.distribute_dofs(temperature_fe);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; stokes_dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = stokes_dofs_per_block[0],</div>
<div class="line">                       n_p = stokes_dofs_per_block[1],</div>
<div class="line">                       n_T = temperature_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">    std::locale <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> = pcout.get_stream().getloc();</div>
<div class="line">    pcout.get_stream().imbue(std::locale(<span class="stringliteral">&quot;&quot;</span>));</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_global_active_cells()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_T &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; n_u</div>
<div class="line">          &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_T &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line">    pcout.get_stream().imbue(<a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    std::vector&lt;IndexSet&gt; stokes_partitioning, stokes_relevant_partitioning;</div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a>              temperature_partitioning(n_T),</div>
<div class="line">      temperature_relevant_partitioning(n_T);</div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> stokes_relevant_set;</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classIndexSet.html">IndexSet</a> stokes_index_set = stokes_dof_handler.locally_owned_dofs();</div>
<div class="line">      stokes_partitioning.push_back(stokes_index_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div>
<div class="line">      stokes_partitioning.push_back(stokes_index_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(stokes_dof_handler,</div>
<div class="line">                                              stokes_relevant_set);</div>
<div class="line">      stokes_relevant_partitioning.push_back(</div>
<div class="line">        stokes_relevant_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div>
<div class="line">      stokes_relevant_partitioning.push_back(</div>
<div class="line">        stokes_relevant_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div>
<div class="line"> </div>
<div class="line">      temperature_partitioning = temperature_dof_handler.locally_owned_dofs();</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(</div>
<div class="line">        temperature_dof_handler, temperature_relevant_partitioning);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      stokes_constraints.clear();</div>
<div class="line">      stokes_constraints.reinit(stokes_relevant_set);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                              stokes_constraints);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocity_components(0);</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">        stokes_dof_handler,</div>
<div class="line">        0,</div>
<div class="line">        <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1),</div>
<div class="line">        stokes_constraints,</div>
<div class="line">        stokes_fe.component_mask(velocity_components));</div>
<div class="line"> </div>
<div class="line">      std::set&lt;types::boundary_id&gt; no_normal_flux_boundaries;</div>
<div class="line">      no_normal_flux_boundaries.insert(1);</div>
<div class="line">      <a class="code" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                                      0,</div>
<div class="line">                                                      no_normal_flux_boundaries,</div>
<div class="line">                                                      stokes_constraints,</div>
<div class="line">                                                      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>);</div>
<div class="line">      stokes_constraints.close();</div>
<div class="line">    }</div>
<div class="line">    {</div>
<div class="line">      temperature_constraints.clear();</div>
<div class="line">      temperature_constraints.reinit(temperature_relevant_partitioning);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(temperature_dof_handler,</div>
<div class="line">                                              temperature_constraints);</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">        temperature_dof_handler,</div>
<div class="line">        0,</div>
<div class="line">        EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">        temperature_constraints);</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">        temperature_dof_handler,</div>
<div class="line">        1,</div>
<div class="line">        EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">        temperature_constraints);</div>
<div class="line">      temperature_constraints.close();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    setup_stokes_matrix(stokes_partitioning, stokes_relevant_partitioning);</div>
<div class="line">    setup_stokes_preconditioner(stokes_partitioning,</div>
<div class="line">                                stokes_relevant_partitioning);</div>
<div class="line">    setup_temperature_matrices(temperature_partitioning,</div>
<div class="line">                               temperature_relevant_partitioning);</div>
<div class="line"> </div>
<div class="line">    stokes_rhs.reinit(stokes_partitioning,</div>
<div class="line">                      stokes_relevant_partitioning,</div>
<div class="line">                      MPI_COMM_WORLD,</div>
<div class="line">                      <span class="keyword">true</span>);</div>
<div class="line">    stokes_solution.reinit(stokes_relevant_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_stokes_solution.reinit(stokes_solution);</div>
<div class="line"> </div>
<div class="line">    temperature_rhs.reinit(temperature_partitioning,</div>
<div class="line">                           temperature_relevant_partitioning,</div>
<div class="line">                           MPI_COMM_WORLD,</div>
<div class="line">                           <span class="keyword">true</span>);</div>
<div class="line">    temperature_solution.reinit(temperature_relevant_partitioning,</div>
<div class="line">                                MPI_COMM_WORLD);</div>
<div class="line">    old_temperature_solution.reinit(temperature_solution);</div>
<div class="line">    old_old_temperature_solution.reinit(temperature_solution);</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_matrix              = <span class="keyword">true</span>;</div>
<div class="line">    rebuild_stokes_preconditioner      = <span class="keyword">true</span>;</div>
<div class="line">    rebuild_temperature_matrices       = <span class="keyword">true</span>;</div>
<div class="line">    rebuild_temperature_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_stokes_preconditioner(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">    Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">    Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">      scratch.stokes_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    scratch.stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">          {</div>
<div class="line">            scratch.grad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">              scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            scratch.phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">            <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">              (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> *</div>
<div class="line">                 <a class="code" href="base_2symmetric__tensor_8h.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(scratch.grad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>], scratch.grad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) +</div>
<div class="line">               (1. / <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a>) * <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> *</div>
<div class="line">                 <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> *</div>
<div class="line">                 (scratch.phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])) *</div>
<div class="line">              scratch.stokes_fe_values.JxW(q);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_stokes_preconditioner(</div>
<div class="line">    <span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">  {</div>
<div class="line">    stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix,</div>
<div class="line">                                                  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                  stokes_preconditioner_matrix);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_preconditioner()</div>
<div class="line">  {</div>
<div class="line">    stokes_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> CellFilter =</div>
<div class="line">      <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> worker =</div>
<div class="line">      [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">             Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">             Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">        this-&gt;local_assemble_stokes_preconditioner(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, scratch, <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a> =</div>
<div class="line">      [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">        this-&gt;copy_local_to_global_stokes_preconditioner(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                               stokes_dof_handler.begin_active()),</div>
<div class="line">                    CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                               stokes_dof_handler.end()),</div>
<div class="line">                    worker,</div>
<div class="line">                    <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a>,</div>
<div class="line">                    Assembly::Scratch::StokesPreconditioner&lt;dim&gt;(</div>
<div class="line">                      stokes_fe,</div>
<div class="line">                      quadrature_formula,</div>
<div class="line">                      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>),</div>
<div class="line">                    Assembly::CopyData::StokesPreconditioner&lt;dim&gt;(stokes_fe));</div>
<div class="line"> </div>
<div class="line">    stokes_preconditioner_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::build_stokes_preconditioner()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_preconditioner == <span class="keyword">false</span>)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                     <span class="stringliteral">&quot;   Build Stokes preconditioner&quot;</span>);</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding Stokes preconditioner...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    assemble_stokes_preconditioner();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;std::vector&lt;bool&gt;</a>&gt; constant_modes;</div>
<div class="line">    <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocity_components(0);</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>(stokes_dof_handler,</div>
<div class="line">                                     stokes_fe.component_mask(</div>
<div class="line">                                       velocity_components),</div>
<div class="line">                                     constant_modes);</div>
<div class="line"> </div>
<div class="line">    Mp_preconditioner =</div>
<div class="line">      std::make_shared&lt;TrilinosWrappers::PreconditionJacobi&gt;();</div>
<div class="line">    Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionAMG&gt;();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a> Amg_data;</div>
<div class="line">    Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">constant_modes</a>        = constant_modes;</div>
<div class="line">    Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">elliptic</a>              = <span class="keyword">true</span>;</div>
<div class="line">    Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">higher_order_elements</a> = <span class="keyword">true</span>;</div>
<div class="line">    Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">smoother_sweeps</a>       = 2;</div>
<div class="line">    Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">aggregation_threshold</a> = 0.02;</div>
<div class="line"> </div>
<div class="line">    Mp_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(1, 1));</div>
<div class="line">    Amg_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(0, 0),</div>
<div class="line">                                   Amg_data);</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_preconditioner = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_stokes_system(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">    Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">    Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">      scratch.stokes_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">      scratch.stokes_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    scratch.stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator temperature_cell(</div>
<div class="line">      &amp;<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level(), <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;index(), &amp;temperature_dof_handler);</div>
<div class="line">    scratch.temperature_fe_values.reinit(temperature_cell);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">      <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix = 0;</div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    scratch.temperature_fe_values.get_function_values(</div>
<div class="line">      old_temperature_solution, scratch.old_temperature_values);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> old_temperature = scratch.old_temperature_values[q];</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">          {</div>
<div class="line">            scratch.phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">              {</div>
<div class="line">                scratch.grads_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                  scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                scratch.div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                  scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                scratch.phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                  scratch.stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * 2 *</div>
<div class="line">                   (scratch.grads_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.grads_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) -</div>
<div class="line">                 (<a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> * scratch.div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">                  scratch.phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) -</div>
<div class="line">                 (<a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> * scratch.phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">                  scratch.div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])) *</div>
<div class="line">                scratch.stokes_fe_values.JxW(q);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> gravity = <a class="code" href="namespaceStep32_1_1EquationData.html#a7c001f60e6c7c0bcd347e3f7b66a5402">EquationData::gravity_vector</a>(</div>
<div class="line">          scratch.stokes_fe_values.quadrature_point(q));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(old_temperature) *</div>
<div class="line">                                gravity * scratch.phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) *</div>
<div class="line">                               scratch.stokes_fe_values.JxW(q);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_stokes_system(</div>
<div class="line">    <span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">      stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix,</div>
<div class="line">                                                    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                    stokes_matrix,</div>
<div class="line">                                                    stokes_rhs);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                    stokes_rhs);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_system()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                     <span class="stringliteral">&quot;   Assemble Stokes system&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">      stokes_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    stokes_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> CellFilter =</div>
<div class="line">      <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(</div>
<div class="line">      CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                 stokes_dof_handler.begin_active()),</div>
<div class="line">      CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(), stokes_dof_handler.end()),</div>
<div class="line">      [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">             Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">             Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">        this-&gt;local_assemble_stokes_system(cell, scratch, data);</div>
<div class="line">      },</div>
<div class="line">      [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">        this-&gt;copy_local_to_global_stokes_system(data);</div>
<div class="line">      },</div>
<div class="line">      Assembly::Scratch::StokesSystem&lt;dim&gt;(</div>
<div class="line">        stokes_fe,</div>
<div class="line">        <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">        quadrature_formula,</div>
<div class="line">        (<a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">         (rebuild_stokes_matrix == <span class="keyword">true</span> ? <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> : <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>(0))),</div>
<div class="line">        temperature_fe,</div>
<div class="line">        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>),</div>
<div class="line">      Assembly::CopyData::StokesSystem&lt;dim&gt;(stokes_fe));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">      stokes_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">    stokes_rhs.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line"> </div>
<div class="line">    rebuild_stokes_matrix = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_temperature_matrix(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">    Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">    Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">      scratch.temperature_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">      scratch.temperature_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">    scratch.temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix      = 0;</div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">          {</div>
<div class="line">            scratch.grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">              scratch.temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            scratch.phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">            {</div>
<div class="line">              <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">                 scratch.temperature_fe_values.JxW(q));</div>
<div class="line">              <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (<a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> * scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">                 scratch.grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] * scratch.temperature_fe_values.JxW(q));</div>
<div class="line">            }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_temperature_matrix(</div>
<div class="line">    <span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">  {</div>
<div class="line">    temperature_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix,</div>
<div class="line">                                                       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                       temperature_mass_matrix);</div>
<div class="line">    temperature_constraints.distribute_local_to_global(</div>
<div class="line">      <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix,</div>
<div class="line">      <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">      temperature_stiffness_matrix);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_matrix()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_temperature_matrices == <span class="keyword">false</span>)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                     <span class="stringliteral">&quot;   Assemble temperature matrices&quot;</span>);</div>
<div class="line">    temperature_mass_matrix      = 0;</div>
<div class="line">    temperature_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> CellFilter =</div>
<div class="line">      <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(</div>
<div class="line">      CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                 temperature_dof_handler.begin_active()),</div>
<div class="line">      CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                 temperature_dof_handler.end()),</div>
<div class="line">      [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">             Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">             Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">        this-&gt;local_assemble_temperature_matrix(cell, scratch, data);</div>
<div class="line">      },</div>
<div class="line">      [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">        this-&gt;copy_local_to_global_temperature_matrix(data);</div>
<div class="line">      },</div>
<div class="line">      Assembly::Scratch::TemperatureMatrix&lt;dim&gt;(temperature_fe,</div>
<div class="line">                                                <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                                quadrature_formula),</div>
<div class="line">      Assembly::CopyData::TemperatureMatrix&lt;dim&gt;(temperature_fe));</div>
<div class="line"> </div>
<div class="line">    temperature_mass_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">    temperature_stiffness_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line"> </div>
<div class="line">    rebuild_temperature_matrices       = <span class="keyword">false</span>;</div>
<div class="line">    rebuild_temperature_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_temperature_rhs(</div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_velocity,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_entropy_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">    Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">    Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">      scratch.temperature_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">      scratch.temperature_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs     = 0;</div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc = 0;</div>
<div class="line">    <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line"> </div>
<div class="line">    scratch.temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator stokes_cell(</div>
<div class="line">      &amp;<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level(), <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;index(), &amp;stokes_dof_handler);</div>
<div class="line">    scratch.stokes_fe_values.reinit(stokes_cell);</div>
<div class="line"> </div>
<div class="line">    scratch.temperature_fe_values.get_function_values(</div>
<div class="line">      old_temperature_solution, scratch.old_temperature_values);</div>
<div class="line">    scratch.temperature_fe_values.get_function_values(</div>
<div class="line">      old_old_temperature_solution, scratch.old_old_temperature_values);</div>
<div class="line"> </div>
<div class="line">    scratch.temperature_fe_values.get_function_gradients(</div>
<div class="line">      old_temperature_solution, scratch.old_temperature_grads);</div>
<div class="line">    scratch.temperature_fe_values.get_function_gradients(</div>
<div class="line">      old_old_temperature_solution, scratch.old_old_temperature_grads);</div>
<div class="line"> </div>
<div class="line">    scratch.temperature_fe_values.get_function_laplacians(</div>
<div class="line">      old_temperature_solution, scratch.old_temperature_laplacians);</div>
<div class="line">    scratch.temperature_fe_values.get_function_laplacians(</div>
<div class="line">      old_old_temperature_solution, scratch.old_old_temperature_laplacians);</div>
<div class="line"> </div>
<div class="line">    scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">      stokes_solution, scratch.old_velocity_values);</div>
<div class="line">    scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">      old_stokes_solution, scratch.old_old_velocity_values);</div>
<div class="line">    scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_symmetric_gradients(</div>
<div class="line">      stokes_solution, scratch.old_strain_rates);</div>
<div class="line">    scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_symmetric_gradients(</div>
<div class="line">      old_stokes_solution, scratch.old_old_strain_rates);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">      compute_viscosity(scratch.old_temperature_values,</div>
<div class="line">                        scratch.old_old_temperature_values,</div>
<div class="line">                        scratch.old_temperature_grads,</div>
<div class="line">                        scratch.old_old_temperature_grads,</div>
<div class="line">                        scratch.old_temperature_laplacians,</div>
<div class="line">                        scratch.old_old_temperature_laplacians,</div>
<div class="line">                        scratch.old_velocity_values,</div>
<div class="line">                        scratch.old_old_velocity_values,</div>
<div class="line">                        scratch.old_strain_rates,</div>
<div class="line">                        scratch.old_old_strain_rates,</div>
<div class="line">                        global_max_velocity,</div>
<div class="line">                        global_T_range.second - global_T_range.first,</div>
<div class="line">                        0.5 * (global_T_range.second + global_T_range.first),</div>
<div class="line">                        global_entropy_variation,</div>
<div class="line">                        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">          {</div>
<div class="line">            scratch.phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            scratch.grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">              scratch.temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> T_term_for_rhs =</div>
<div class="line">          (use_bdf2_scheme ?</div>
<div class="line">             (scratch.old_temperature_values[q] *</div>
<div class="line">                (1 + time_step / old_time_step) -</div>
<div class="line">              scratch.old_old_temperature_values[q] * (time_step * time_step) /</div>
<div class="line">                (old_time_step * (time_step + old_time_step))) :</div>
<div class="line">             scratch.old_temperature_values[q]);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> ext_T =</div>
<div class="line">          (use_bdf2_scheme ? (scratch.old_temperature_values[q] *</div>
<div class="line">                                (1 + time_step / old_time_step) -</div>
<div class="line">                              scratch.old_old_temperature_values[q] *</div>
<div class="line">                                time_step / old_time_step) :</div>
<div class="line">                             scratch.old_temperature_values[q]);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> ext_grad_T =</div>
<div class="line">          (use_bdf2_scheme ? (scratch.old_temperature_grads[q] *</div>
<div class="line">                                (1 + time_step / old_time_step) -</div>
<div class="line">                              scratch.old_old_temperature_grads[q] * time_step /</div>
<div class="line">                                old_time_step) :</div>
<div class="line">                             scratch.old_temperature_grads[q]);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> extrapolated_u =</div>
<div class="line">          (use_bdf2_scheme ?</div>
<div class="line">             (scratch.old_velocity_values[q] * (1 + time_step / old_time_step) -</div>
<div class="line">              scratch.old_old_velocity_values[q] * time_step / old_time_step) :</div>
<div class="line">             scratch.old_velocity_values[q]);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> extrapolated_strain_rate =</div>
<div class="line">          (use_bdf2_scheme ?</div>
<div class="line">             (scratch.old_strain_rates[q] * (1 + time_step / old_time_step) -</div>
<div class="line">              scratch.old_old_strain_rates[q] * time_step / old_time_step) :</div>
<div class="line">             scratch.old_strain_rates[q]);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> =</div>
<div class="line">          ((<a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">EquationData::radiogenic_heating</a> * <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(ext_T) +</div>
<div class="line">            2 * <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * extrapolated_strain_rate *</div>
<div class="line">              extrapolated_strain_rate) /</div>
<div class="line">           (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(ext_T) * <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">EquationData::specific_heat</a>));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">              (T_term_for_rhs * scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">               time_step * extrapolated_u * ext_grad_T * scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] -</div>
<div class="line">               time_step * nu * ext_grad_T * scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] +</div>
<div class="line">               time_step * <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> * scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) *</div>
<div class="line">              scratch.temperature_fe_values.JxW(q);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (temperature_constraints.is_inhomogeneously_constrained(</div>
<div class="line">                  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]))</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                    (scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">                       (use_bdf2_scheme ? ((2 * time_step + old_time_step) /</div>
<div class="line">                                           (time_step + old_time_step)) :</div>
<div class="line">                                          1.) +</div>
<div class="line">                     scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * scratch.grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] *</div>
<div class="line">                       <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> * time_step) *</div>
<div class="line">                    scratch.temperature_fe_values.JxW(q);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_temperature_rhs(</div>
<div class="line">    <span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">  {</div>
<div class="line">    temperature_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                       temperature_rhs,</div>
<div class="line">                                                       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_system(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (use_bdf2_scheme == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">        temperature_matrix *=</div>
<div class="line">          (2 * time_step + old_time_step) / (time_step + old_time_step);</div>
<div class="line">        temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">        temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_temperature_preconditioner == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        T_preconditioner =</div>
<div class="line">          std::make_shared&lt;TrilinosWrappers::PreconditionJacobi&gt;();</div>
<div class="line">        T_preconditioner-&gt;initialize(temperature_matrix);</div>
<div class="line">        rebuild_temperature_preconditioner = <span class="keyword">false</span>;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    temperature_rhs = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range =</div>
<div class="line">      get_extrapolated_temperature_range();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature =</div>
<div class="line">      0.5 * (global_T_range.first + global_T_range.second);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> global_entropy_variation =</div>
<div class="line">      get_entropy_variation(average_temperature);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> CellFilter =</div>
<div class="line">      <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> worker =</div>
<div class="line">      [<span class="keyword">this</span>, global_T_range, maximal_velocity, global_entropy_variation](</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">        Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">        Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">        this-&gt;local_assemble_temperature_rhs(global_T_range,</div>
<div class="line">                                             maximal_velocity,</div>
<div class="line">                                             global_entropy_variation,</div>
<div class="line">                                             <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">                                             scratch,</div>
<div class="line">                                             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">      };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span> <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a> = [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;copy_local_to_global_temperature_rhs(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                               temperature_dof_handler.begin_active()),</div>
<div class="line">                    CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                               temperature_dof_handler.end()),</div>
<div class="line">                    worker,</div>
<div class="line">                    <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a>,</div>
<div class="line">                    Assembly::Scratch::TemperatureRHS&lt;dim&gt;(</div>
<div class="line">                      temperature_fe, stokes_fe, <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, quadrature_formula),</div>
<div class="line">                    Assembly::CopyData::TemperatureRHS&lt;dim&gt;(temperature_fe));</div>
<div class="line"> </div>
<div class="line">    temperature_rhs.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">BoussinesqFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                       <span class="stringliteral">&quot;   Solve Stokes system&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;   Solving Stokes system... &quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distributed_stokes_solution(</div>
<div class="line">        stokes_rhs);</div>
<div class="line">      distributed_stokes_solution = stokes_solution;</div>
<div class="line"> </div>
<div class="line">      distributed_stokes_solution.block(1) /= <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a>;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span></div>
<div class="line">        <a class="code" href="timer__0_8txt.html#a48e9e3a8116df3cc4b62db810904e91f">start</a> = (distributed_stokes_solution.block(0).size() +</div>
<div class="line">                 distributed_stokes_solution.block(1).local_range().first),</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a>   = (distributed_stokes_solution.block(0).size() +</div>
<div class="line">               distributed_stokes_solution.block(1).local_range().second);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="timer__0_8txt.html#a48e9e3a8116df3cc4b62db810904e91f">start</a>; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (stokes_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">          distributed_stokes_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classPrimitiveVectorMemory.html">PrimitiveVectorMemory&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> mem;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  n_iterations     = 0;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>  solver_tolerance = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-8 * stokes_rhs.l2_norm();</div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(30, solver_tolerance);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">try</span></div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">            <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">            <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div>
<div class="line">            <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix,</div>
<div class="line">                           stokes_preconditioner_matrix,</div>
<div class="line">                           *Mp_preconditioner,</div>
<div class="line">                           *Amg_preconditioner,</div>
<div class="line">                           <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classSolverFGMRES.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(</div>
<div class="line">            solver_control,</div>
<div class="line">            mem,</div>
<div class="line">            <a class="code" href="structSolverFGMRES_1_1AdditionalData.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">              30));</div>
<div class="line">          <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix,</div>
<div class="line">                       distributed_stokes_solution,</div>
<div class="line">                       stokes_rhs,</div>
<div class="line">                       <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">          n_iterations = solver_control.last_step();</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">catch</span> (<a class="code" href="classSolverControl_1_1NoConvergence.html">SolverControl::NoConvergence</a> &amp;)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">            <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">            <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div>
<div class="line">            <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix,</div>
<div class="line">                           stokes_preconditioner_matrix,</div>
<div class="line">                           *Mp_preconditioner,</div>
<div class="line">                           *Amg_preconditioner,</div>
<div class="line">                           <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classSolverControl.html">SolverControl</a> solver_control_refined(stokes_matrix.m(),</div>
<div class="line">                                               solver_tolerance);</div>
<div class="line">          <a class="code" href="classSolverFGMRES.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(</div>
<div class="line">            solver_control_refined,</div>
<div class="line">            mem,</div>
<div class="line">            <a class="code" href="structSolverFGMRES_1_1AdditionalData.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">              50));</div>
<div class="line">          <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix,</div>
<div class="line">                       distributed_stokes_solution,</div>
<div class="line">                       stokes_rhs,</div>
<div class="line">                       <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">          n_iterations =</div>
<div class="line">            (solver_control.last_step() + solver_control_refined.last_step());</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      stokes_constraints.distribute(distributed_stokes_solution);</div>
<div class="line"> </div>
<div class="line">      distributed_stokes_solution.block(1) *= <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a>;</div>
<div class="line"> </div>
<div class="line">      stokes_solution = distributed_stokes_solution;</div>
<div class="line">      pcout &lt;&lt; n_iterations &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                       <span class="stringliteral">&quot;   Assemble temperature rhs&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      old_time_step = time_step;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> scaling = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3 ? 0.25 : 1.0);</div>
<div class="line">      time_step            = (scaling / (2.1 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> * <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) /</div>
<div class="line">                   (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree * get_cfl_number()));</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity = get_maximal_velocity();</div>
<div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;   Maximal velocity: &quot;</span></div>
<div class="line">            &lt;&lt; maximal_velocity * <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> * 100</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; cm/year&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span></div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;Time step: &quot;</span> &lt;&lt; time_step / <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a></div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; years&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      temperature_solution = old_temperature_solution;</div>
<div class="line">      assemble_temperature_system(maximal_velocity);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                       <span class="stringliteral">&quot;   Solve temperature system&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(temperature_matrix.m(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 * temperature_rhs.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temperature_solution(</div>
<div class="line">        temperature_rhs);</div>
<div class="line">      distributed_temperature_solution = temperature_solution;</div>
<div class="line"> </div>
<div class="line">      cg.solve(temperature_matrix,</div>
<div class="line">               distributed_temperature_solution,</div>
<div class="line">               temperature_rhs,</div>
<div class="line">               *T_preconditioner);</div>
<div class="line"> </div>
<div class="line">      temperature_constraints.distribute(distributed_temperature_solution);</div>
<div class="line">      temperature_solution = distributed_temperature_solution;</div>
<div class="line"> </div>
<div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; CG iterations for temperature&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[2] = {<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">                               -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>()};</div>
<div class="line">      <span class="keywordtype">double</span> global_temperature[2];</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> =</div>
<div class="line">             distributed_temperature_solution.local_range().first;</div>
<div class="line">           <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; distributed_temperature_solution.local_range().second;</div>
<div class="line">           ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0] =</div>
<div class="line">            std::min&lt;double&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0],</div>
<div class="line">                             distributed_temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">          <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[1] =</div>
<div class="line">            std::max&lt;double&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[1],</div>
<div class="line">                             distributed_temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0] *= -1.0;</div>
<div class="line">      <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>, MPI_COMM_WORLD, global_temperature);</div>
<div class="line">      global_temperature[0] *= -1.0;</div>
<div class="line"> </div>
<div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;   Temperature range: &quot;</span> &lt;&lt; global_temperature[0] &lt;&lt; <span class="charliteral">&#39; &#39;</span></div>
<div class="line">            &lt;&lt; global_temperature[1] &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>BoussinesqFlowProblem&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::Postprocessor</div>
<div class="line">    : <span class="keyword">public</span> <a class="code" href="classDataPostprocessor.html">DataPostprocessor</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    Postprocessor(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> minimal_pressure);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> evaluate_vector_field(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Vector.html">DataPostprocessorInputs::Vector&lt;dim&gt;</a> &amp;inputs,</div>
<div class="line">      <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;computed_quantities) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> std::vector&lt;std::string&gt; <a class="code" href="data__postprocessor__0_8txt.html#afb21caeba7bf26aba89ce705266fedb1">get_names</a>() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0">DataComponentInterpretation::DataComponentInterpretation</a>&gt;</div>
<div class="line">    get_data_component_interpretation() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a> <a class="code" href="data__postprocessor__0_8txt.html#abfdf708e97518fa7ad2b849b80afddc1">get_needed_update_flags</a>() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       minimal_pressure;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::Postprocessor(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       minimal_pressure)</div>
<div class="line">    : <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>(<a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>)</div>
<div class="line">    , minimal_pressure(minimal_pressure)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::vector&lt;std::string&gt;</div>
<div class="line">  <a class="code" href="data__postprocessor__0_8txt.html#afb21caeba7bf26aba89ce705266fedb1">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_names</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::vector&lt;std::string&gt; solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;p&quot;</span>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;T&quot;</span>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;friction_heating&quot;</span>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;partition&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> solution_names;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_data_component_interpretation()<span class="keyword"></span></div>
<div class="line"><span class="keyword">    const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      interpretation(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">                     <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line"> </div>
<div class="line">    interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> interpretation;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a></div>
<div class="line">  <a class="code" href="data__postprocessor__0_8txt.html#abfdf708e97518fa7ad2b849b80afddc1">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_needed_update_flags</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::evaluate_vector_field(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Vector.html">DataPostprocessorInputs::Vector&lt;dim&gt;</a> &amp;inputs,</div>
<div class="line">    <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;               computed_quantities)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_quadrature_points = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>.size();</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a2a918d936d56f2be4cdad1b8074c3a86">solution_gradients</a>.size() == n_quadrature_points,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(computed_quantities.size() == n_quadrature_points,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[0].size() == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 2, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_quadrature_points; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          computed_quantities[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>) = (inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>) *</div>
<div class="line">                                       <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> * 100);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a> =</div>
<div class="line">          (inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) - minimal_pressure);</div>
<div class="line">        computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) = <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>        = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">        computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1) = <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> grad_u;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          grad_u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a2a918d936d56f2be4cdad1b8074c3a86">solution_gradients</a>[q][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>];</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> strain_rate = <a class="code" href="base_2symmetric__tensor_8h.html#a1b2101a1d45267f1fd4664ed178cb636">symmetrize</a>(grad_u);</div>
<div class="line">        computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 2) =</div>
<div class="line">          2 * <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> * strain_rate * strain_rate;</div>
<div class="line"> </div>
<div class="line">        computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 3) = <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::output_results()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer, <span class="stringliteral">&quot;Postprocessing&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> joint_fe(stokes_fe, 1, temperature_fe, 1);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> joint_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">    joint_dof_handler.distribute_dofs(joint_fe);</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_dof_handler.n_dofs() ==</div>
<div class="line">             stokes_dof_handler.n_dofs() + temperature_dof_handler.n_dofs(),</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> joint_solution;</div>
<div class="line">    joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a655ae9c8d3595133abe1131fcbb97b6d">reinit</a>(joint_dof_handler.locally_owned_dofs(),</div>
<div class="line">                          MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_joint_dof_indices(</div>
<div class="line">        joint_fe.n_dofs_per_cell());</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_stokes_dof_indices(</div>
<div class="line">        stokes_fe.n_dofs_per_cell());</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_temperature_dof_indices(</div>
<div class="line">        temperature_fe.n_dofs_per_cell());</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">typename</span> DoFHandler&lt;dim&gt;::active_cell_iterator</div>
<div class="line">        joint_cell       = joint_dof_handler.<a class="code" href="classDoFHandler.html#a9a3bef554c6d22abe312e10e9475eecf">begin_active</a>(),</div>
<div class="line">        joint_endc       = joint_dof_handler.end(),</div>
<div class="line">        stokes_cell      = stokes_dof_handler.begin_active(),</div>
<div class="line">        temperature_cell = temperature_dof_handler.begin_active();</div>
<div class="line">      <span class="keywordflow">for</span> (; joint_cell != joint_endc;</div>
<div class="line">           ++joint_cell, ++stokes_cell, ++temperature_cell)</div>
<div class="line">        <span class="keywordflow">if</span> (joint_cell-&gt;is_locally_owned())</div>
<div class="line">          {</div>
<div class="line">            joint_cell-&gt;get_dof_indices(local_joint_dof_indices);</div>
<div class="line">            stokes_cell-&gt;get_dof_indices(local_stokes_dof_indices);</div>
<div class="line">            temperature_cell-&gt;get_dof_indices(local_temperature_dof_indices);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; joint_fe.n_dofs_per_cell(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <span class="keywordflow">if</span> (joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 0)</div>
<div class="line">                {</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                           local_stokes_dof_indices.size(),</div>
<div class="line">                         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">                  joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) = stokes_solution(</div>
<div class="line">                    local_stokes_dof_indices[joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                                               .second]);</div>
<div class="line">                }</div>
<div class="line">              <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 1,</div>
<div class="line">                         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                           local_temperature_dof_indices.size(),</div>
<div class="line">                         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                  joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) =</div>
<div class="line">                    temperature_solution(</div>
<div class="line">                      local_temperature_dof_indices</div>
<div class="line">                        [joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second]);</div>
<div class="line">                }</div>
<div class="line">          }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a7221ae06689832b475206ef54efaf0a6">compress</a>(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964caf4784f9368d9386d7508c25daea9e19d">VectorOperation::insert</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_joint_dofs(joint_dof_handler.n_dofs());</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(joint_dof_handler,</div>
<div class="line">                                            locally_relevant_joint_dofs);</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> locally_relevant_joint_solution;</div>
<div class="line">    locally_relevant_joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a655ae9c8d3595133abe1131fcbb97b6d">reinit</a>(locally_relevant_joint_dofs,</div>
<div class="line">                                           MPI_COMM_WORLD);</div>
<div class="line">    locally_relevant_joint_solution = joint_solution;</div>
<div class="line"> </div>
<div class="line">    Postprocessor <a class="code" href="data__postprocessor__0_8txt.html#a80e53cb52e5dbb182dd14ee528927a77">postprocessor</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                  MPI_COMM_WORLD),</div>
<div class="line">                                stokes_solution.block(1).min());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(joint_dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_joint_solution, <a class="code" href="data__postprocessor__0_8txt.html#a80e53cb52e5dbb182dd14ee528927a77">postprocessor</a>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> out_index = 0;</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div>
<div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, out_index, MPI_COMM_WORLD, 5);</div>
<div class="line"> </div>
<div class="line">    out_index++;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  BoussinesqFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a></div>
<div class="line">      temperature_trans(temperature_dof_handler);</div>
<div class="line">    <a class="code" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">                                            <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a>&gt;</div>
<div class="line">      stokes_trans(stokes_dof_handler);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                       <span class="stringliteral">&quot;Refine mesh structure, part 1&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">        temperature_dof_handler,</div>
<div class="line">        <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 1),</div>
<div class="line">        <a class="code" href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">std::map</a>&lt;<a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">        temperature_solution,</div>
<div class="line">        estimated_error_per_cell,</div>
<div class="line">        <a class="code" href="classComponentMask.html">ComponentMask</a>(),</div>
<div class="line">        <span class="keyword">nullptr</span>,</div>
<div class="line">        0,</div>
<div class="line">        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.locally_owned_subdomain());</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#ae5159e3207f6786f0749fc0b66ab8ca3">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_fraction</a>(</div>
<div class="line">        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, estimated_error_per_cell, 0.3, 0.1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> =</div>
<div class="line">               <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.begin_active(max_grid_level);</div>
<div class="line">             <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.end();</div>
<div class="line">             ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;const TrilinosWrappers::MPI::Vector *&gt; x_temperature(2);</div>
<div class="line">      x_temperature[0] = &amp;temperature_solution;</div>
<div class="line">      x_temperature[1] = &amp;old_temperature_solution;</div>
<div class="line">      std::vector&lt;const TrilinosWrappers::MPI::BlockVector *&gt; x_stokes(2);</div>
<div class="line">      x_stokes[0] = &amp;stokes_solution;</div>
<div class="line">      x_stokes[1] = &amp;old_stokes_solution;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">      temperature_trans.prepare_for_coarsening_and_refinement(x_temperature);</div>
<div class="line">      stokes_trans.prepare_for_coarsening_and_refinement(x_stokes);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                       <span class="stringliteral">&quot;Refine mesh structure, part 2&quot;</span>);</div>
<div class="line"> </div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temp1(temperature_rhs);</div>
<div class="line">        <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temp2(temperature_rhs);</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;TrilinosWrappers::MPI::Vector *&gt; tmp(2);</div>
<div class="line">        tmp[0] = &amp;(distributed_temp1);</div>
<div class="line">        tmp[1] = &amp;(distributed_temp2);</div>
<div class="line">        temperature_trans.interpolate(tmp);</div>
<div class="line"> </div>
<div class="line">        temperature_constraints.distribute(distributed_temp1);</div>
<div class="line">        temperature_constraints.distribute(distributed_temp2);</div>
<div class="line"> </div>
<div class="line">        temperature_solution     = distributed_temp1;</div>
<div class="line">        old_temperature_solution = distributed_temp2;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distributed_stokes(stokes_rhs);</div>
<div class="line">        <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_distributed_stokes(stokes_rhs);</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;TrilinosWrappers::MPI::BlockVector *&gt; stokes_tmp(2);</div>
<div class="line">        stokes_tmp[0] = &amp;(distributed_stokes);</div>
<div class="line">        stokes_tmp[1] = &amp;(old_distributed_stokes);</div>
<div class="line"> </div>
<div class="line">        stokes_trans.interpolate(stokes_tmp);</div>
<div class="line"> </div>
<div class="line">        stokes_constraints.distribute(distributed_stokes);</div>
<div class="line">        stokes_constraints.distribute(old_distributed_stokes);</div>
<div class="line"> </div>
<div class="line">        stokes_solution     = distributed_stokes;</div>
<div class="line">        old_stokes_solution = old_distributed_stokes;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">BoussinesqFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                               <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(),</div>
<div class="line">                               <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">EquationData::R0</a>,</div>
<div class="line">                               <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">EquationData::R1</a>,</div>
<div class="line">                               (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3) ? 96 : 12,</div>
<div class="line">                               <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">    global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement);</div>
<div class="line"> </div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">  start_time_iteration:</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(</div>
<div class="line">        temperature_dof_handler.locally_owned_dofs());</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(temperature_dof_handler,</div>
<div class="line">                           temperature_constraints,</div>
<div class="line">                           <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2),</div>
<div class="line">                           EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">                           <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">      temperature_solution         = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">      old_temperature_solution     = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">      old_old_temperature_solution = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    timestep_number = 0;</div>
<div class="line">    time_step = old_time_step = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> / <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> &lt;&lt; <span class="stringliteral">&quot; years&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_stokes_system();</div>
<div class="line">        build_stokes_preconditioner();</div>
<div class="line">        assemble_temperature_matrix();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        pcout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement))</div>
<div class="line">          {</div>
<div class="line">            refine_mesh(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement +</div>
<div class="line">                        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement);</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp;</div>
<div class="line">                 (timestep_number % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.adaptive_refinement_interval ==</div>
<div class="line">                  0))</div>
<div class="line">          refine_mesh(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement +</div>
<div class="line">                      <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.generate_graphical_output == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">            (timestep_number % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.graphical_output_interval == 0))</div>
<div class="line">          output_results();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &gt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.end_time * <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a>)</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_old_stokes_solution;</div>
<div class="line">        old_old_stokes_solution      = old_stokes_solution;</div>
<div class="line">        old_stokes_solution          = stokes_solution;</div>
<div class="line">        old_old_temperature_solution = old_temperature_solution;</div>
<div class="line">        old_temperature_solution     = temperature_solution;</div>
<div class="line">        <span class="keywordflow">if</span> (old_time_step &gt; 0)</div>
<div class="line">          {</div>
<div class="line">            {</div>
<div class="line">              <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distr_solution(stokes_rhs);</div>
<div class="line">              distr_solution = stokes_solution;</div>
<div class="line">              <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distr_old_solution(stokes_rhs);</div>
<div class="line">              distr_old_solution = old_old_stokes_solution;</div>
<div class="line">              distr_solution.<a class="code" href="classBlockVectorBase.html#a71b0ab8295e98caf3dfe1ef14ae6b6c1">sadd</a>(1. + time_step / old_time_step,</div>
<div class="line">                                  -time_step / old_time_step,</div>
<div class="line">                                  distr_old_solution);</div>
<div class="line">              stokes_solution = distr_solution;</div>
<div class="line">            }</div>
<div class="line">            {</div>
<div class="line">              <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distr_solution(temperature_rhs);</div>
<div class="line">              distr_solution = temperature_solution;</div>
<div class="line">              <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distr_old_solution(temperature_rhs);</div>
<div class="line">              distr_old_solution = old_old_temperature_solution;</div>
<div class="line">              distr_solution.sadd(1. + time_step / old_time_step,</div>
<div class="line">                                  -time_step / old_time_step,</div>
<div class="line">                                  distr_old_solution);</div>
<div class="line">              temperature_solution = distr_solution;</div>
<div class="line">            }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 100 == 0))</div>
<div class="line">          computing_timer.print_summary();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">        ++timestep_number;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.generate_graphical_output == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">        !((timestep_number - 1) % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.graphical_output_interval == 0))</div>
<div class="line">      output_results();</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step32</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep32.html">Step32</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      std::string parameter_filename;</div>
<div class="line">      <span class="keywordflow">if</span> (argc &gt;= 2)</div>
<div class="line">        parameter_filename = argv[1];</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        parameter_filename = <span class="stringliteral">&quot;step-32.prm&quot;</span>;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">int</span>                              <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> = 2;</div>
<div class="line">      <a class="code" href="structStep32_1_1BoussinesqFlowProblem_1_1Parameters.html">BoussinesqFlowProblem&lt;dim&gt;::Parameters</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>(parameter_filename);</div>
<div class="line">      BoussinesqFlowProblem&lt;dim&gt;             flow_problem(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><br  />
 This tutorial depends on <a class="el" href="step_31.html">step-31</a> , <a class="el" href="step_55.html">step-55</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Usingtherightpressure"> Using the "right" pressure </a><a href="#Usingtherightpressure"> Using the "right" pressure </a>
        <li><a href="#Thescalingofdiscretizedequations"> The scaling of discretized equations </a><a href="#Thescalingofdiscretizedequations"> The scaling of discretized equations </a>
        <li><a href="#ChangestotheStokespreconditionerandsolver"> Changes to the Stokes preconditioner and solver </a><a href="#ChangestotheStokespreconditionerandsolver"> Changes to the Stokes preconditioner and solver </a>
        <li><a href="#Changestotheartificialviscositystabilization"> Changes to the artificial viscosity stabilization </a><a href="#Changestotheartificialviscositystabilization"> Changes to the artificial viscosity stabilization </a>
        <li><a href="#LocallyconservativeStokesdiscretization"> Locally conservative Stokes discretization </a><a href="#LocallyconservativeStokesdiscretization"> Locally conservative Stokes discretization </a>
        <li><a href="#Higherordermappingsforcurvedboundaries"> Higher order mappings for curved boundaries </a><a href="#Higherordermappingsforcurvedboundaries"> Higher order mappings for curved boundaries </a>
        <li><a href="#Parallelizationonclusters"> Parallelization on clusters </a><a href="#Parallelizationonclusters"> Parallelization on clusters </a>
        <li><a href="#Parallelizationwithinindividualnodesofacluster"> Parallelization within individual nodes of a cluster </a><a href="#Parallelizationwithinindividualnodesofacluster"> Parallelization within individual nodes of a cluster </a>
        <li><a href="#Thetestcase"> The testcase </a><a href="#Thetestcase"> The testcase </a>
        <li><a href="#Implementationdetails"> Implementation details </a><a href="#Implementationdetails"> Implementation details </a>
        <li><a href="#Outlook"> Outlook </a><a href="#Outlook"> Outlook </a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#Equationdata">Equation data</a><a href="#Equationdata">Equation data</a>
        <li><a href="#PreconditioningtheStokessystem">Preconditioning the Stokes system</a><a href="#PreconditioningtheStokessystem">Preconditioning the Stokes system</a>
        <li><a href="#Definitionofassemblydatastructures">Definition of assembly data structures</a><a href="#Definitionofassemblydatastructures">Definition of assembly data structures</a>
        <li><a href="#ThecodeBoussinesqFlowProblemcodeclasstemplate">The <code>BoussinesqFlowProblem</code> class template</a><a href="#ThecodeBoussinesqFlowProblemcodeclasstemplate">The <code>BoussinesqFlowProblem</code> class template</a>
        <li><a href="#BoussinesqFlowProblemclassimplementation">BoussinesqFlowProblem class implementation</a><a href="#BoussinesqFlowProblemclassimplementation">BoussinesqFlowProblem class implementation</a>
      <ul>
        <li><a href="#BoussinesqFlowProblemParameters">BoussinesqFlowProblem::Parameters</a><a href="#BoussinesqFlowProblemParameters">BoussinesqFlowProblem::Parameters</a>
        <li><a href="#BoussinesqFlowProblemBoussinesqFlowProblem">BoussinesqFlowProblem::BoussinesqFlowProblem</a><a href="#BoussinesqFlowProblemBoussinesqFlowProblem">BoussinesqFlowProblem::BoussinesqFlowProblem</a>
        <li><a href="#TheBoussinesqFlowProblemhelperfunctions">The BoussinesqFlowProblem helper functions</a><a href="#TheBoussinesqFlowProblemhelperfunctions">The BoussinesqFlowProblem helper functions</a>
      <ul>
        <li><a href="#BoussinesqFlowProblemget_maximal_velocity">BoussinesqFlowProblem::get_maximal_velocity</a><a href="#BoussinesqFlowProblemget_maximal_velocity">BoussinesqFlowProblem::get_maximal_velocity</a>
        <li><a href="#BoussinesqFlowProblemget_cfl_number">BoussinesqFlowProblem::get_cfl_number</a><a href="#BoussinesqFlowProblemget_cfl_number">BoussinesqFlowProblem::get_cfl_number</a>
        <li><a href="#BoussinesqFlowProblemget_entropy_variation">BoussinesqFlowProblem::get_entropy_variation</a><a href="#BoussinesqFlowProblemget_entropy_variation">BoussinesqFlowProblem::get_entropy_variation</a>
        <li><a href="#BoussinesqFlowProblemget_extrapolated_temperature_range">BoussinesqFlowProblem::get_extrapolated_temperature_range</a><a href="#BoussinesqFlowProblemget_extrapolated_temperature_range">BoussinesqFlowProblem::get_extrapolated_temperature_range</a>
        <li><a href="#BoussinesqFlowProblemcompute_viscosity">BoussinesqFlowProblem::compute_viscosity</a><a href="#BoussinesqFlowProblemcompute_viscosity">BoussinesqFlowProblem::compute_viscosity</a>
      </ul>
        <li><a href="#TheBoussinesqFlowProblemsetupfunctions">The BoussinesqFlowProblem setup functions</a><a href="#TheBoussinesqFlowProblemsetupfunctions">The BoussinesqFlowProblem setup functions</a>
        <li><a href="#TheBoussinesqFlowProblemassemblyfunctions">The BoussinesqFlowProblem assembly functions</a><a href="#TheBoussinesqFlowProblemassemblyfunctions">The BoussinesqFlowProblem assembly functions</a>
      <ul>
        <li><a href="#Stokespreconditionerassembly">Stokes preconditioner assembly</a><a href="#Stokespreconditionerassembly">Stokes preconditioner assembly</a>
        <li><a href="#Stokessystemassembly">Stokes system assembly</a><a href="#Stokessystemassembly">Stokes system assembly</a>
        <li><a href="#Temperaturematrixassembly">Temperature matrix assembly</a><a href="#Temperaturematrixassembly">Temperature matrix assembly</a>
        <li><a href="#Temperaturerighthandsideassembly">Temperature right hand side assembly</a><a href="#Temperaturerighthandsideassembly">Temperature right hand side assembly</a>
      </ul>
        <li><a href="#BoussinesqFlowProblemsolve">BoussinesqFlowProblem::solve</a><a href="#BoussinesqFlowProblemsolve">BoussinesqFlowProblem::solve</a>
        <li><a href="#BoussinesqFlowProblemoutput_results">BoussinesqFlowProblem::output_results</a><a href="#BoussinesqFlowProblemoutput_results">BoussinesqFlowProblem::output_results</a>
        <li><a href="#BoussinesqFlowProblemrefine_mesh">BoussinesqFlowProblem::refine_mesh</a><a href="#BoussinesqFlowProblemrefine_mesh">BoussinesqFlowProblem::refine_mesh</a>
        <li><a href="#BoussinesqFlowProblemrun">BoussinesqFlowProblem::run</a><a href="#BoussinesqFlowProblemrun">BoussinesqFlowProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Comparisonofresultswithstep31">Comparison of results with step-31</a><a href="#Comparisonofresultswithstep31">Comparison of results with step-31</a>
        <li><a href="#Resultsfora2dcircularshelltestcase">Results for a 2d circular shell testcase</a><a href="#Resultsfora2dcircularshelltestcase">Results for a 2d circular shell testcase</a>
        <li><a href="#Resultsfora3dsphericalshelltestcase">Results for a 3d spherical shell testcase</a><a href="#Resultsfora3dsphericalshelltestcase">Results for a 3d spherical shell testcase</a>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
 <br  />
 <em>This program was contributed by Martin Kronbichler, Wolfgang Bangerth, and Timo Heister.</em></p>
<p><em>This material is based upon work partly supported by the National Science Foundation under Award No. EAR-0426271 and The California Institute of Technology; and in a continuation by the National Science Foundation under Award No. EAR-0949446 and The University of California &ndash; Davis. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation, The California Institute of Technology, or of The University of California &ndash; Davis.</em></p>
<p><em>The work discussed here is also presented in the following publication: <b> M. Kronbichler, T. Heister, W. Bangerth: <em>High Accuracy Mantle Convection Simulation through Modern Numerical Methods</em><b> M. Kronbichler, T. Heister, W. Bangerth: <em>High Accuracy Mantle Convection Simulation through Modern Numerical Methods</em>, Geophysical Journal International, 2012, 191, 12-29. <a href="http://dx.doi.org/10.1111/j.1365-246X.2012.05609.x">[DOI]</a><em>High Accuracy Mantle Convection Simulation through Modern Numerical Methods</em>, Geophysical Journal International, 2012, 191, 12-29. <a href="http://dx.doi.org/10.1111/j.1365-246X.2012.05609.x">[DOI]</a> </b><a href="http://dx.doi.org/10.1111/j.1365-246X.2012.05609.x">[DOI]</a> </b></em></p>
<p><em>The continuation of development of this program has led to the much larger open source code <em>ASPECT</em><em>ASPECT</em> (see <a href="http://aspect.geodynamics.org/">http://aspect.geodynamics.org/</a>) which is much more flexible in solving many kinds of related problems. </em></p>
<p><a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>This program does pretty much exactly what <a class="el" href="step_31.html">step-31</a> already does: itsolves the Boussinesq equations that describe the motion of a fluidwhose temperature is not in equilibrium. As such, all the equations wehave described in <a class="el" href="step_31.html">step-31</a> still hold: we solve the same generalpartial differential equation (with only minor modifications to adjustfor more realism in the problem setting), using the same finiteelement scheme, the same time stepping algorithm, and more or less thesame stabilization method for the temperature advection-diffusionequation. As a consequence, you may first want to understand thatprogram &mdash; and its implementation &mdash; before you work on thecurrent one. The difference between <a class="el" href="step_31.html">step-31</a> and the current program is thathere we want to do things in parallel, using both the availability of manymachines in a cluster (with parallelization based on MPI) as well as manyprocessor cores within a single machine (with parallelization based onthreads). This program's main job is therefore to introduce the changes that arenecessary to utilize the availability of these parallel computeresources. In this regard, it builds on the <a class="el" href="step_40.html">step-40</a> program that firstintroduces the necessary classes for much of the parallelfunctionality, and on <a class="el" href="step_55.html">step-55</a> that shows how this is done for avector-valued problem. In addition to these changes, we also use a slightly differentpreconditioner, and we will have to make a number of changes that haveto do with the fact that we want to solve a <em>realistic</em> problemhere, not a model problem. The latter, in particular, will requirethat we think about scaling issues as well as what all thoseparameters and coefficients in the equations under considerationactually mean. We will discuss first the issues that affect changes inthe mathematical formulation and solver structure, then how toparallelize things, and finally the actual testcase we will consider.</p>
<p><a class="anchor" id="Usingtherightpressure"></a></p><h3>Using the "right" pressure </h3>
<p>In <a class="el" href="step_31.html">step-31</a> , we used the following Stokes model for thevelocity and pressure field: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; -\rho \; \beta \; T \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> The right hand side of the first equation appears a wee bitunmotivated. Here's how things should really be. Weneed the external forces that act on the fluid, which we assume aregiven by gravity only. In the current case, we assume that the fluiddoes expand slightly for the purposes of this gravity force, but notenough that we need to modify the incompressibility condition (thesecond equation). What this means is that for the purpose of the righthand side, we can assume that \(\rho=\rho(T)\) . An assumption that maynot be entirely justified is that we can assume that the changes ofdensity as a function of temperature are small, leading to anexpression of the form \(\rho(T) = \rho_{\text{ref}} [1-\beta(T-T_{\text{ref}})]\) , i.e., the density equals \(\rho_{\text{ref}}\) at reference temperature and decreases linearly asthe temperature increases (as the material expands). The force balanceequation then looks properly written like this: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; \rho_{\text{ref}} [1-\beta(T-T_{\text{ref}})] \mathbf{g}. \end{eqnarray*}
</p>
<p> Now note that the gravity force results from a gravity potential as \(\mathbf g=-\nabla \varphi\) , so that we can re-write this as follows: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; -\rho_{\text{ref}} \; \beta\; T\; \mathbf{g} -\rho_{\text{ref}} [1+\beta T_{\text{ref}}] \nabla\varphi. \end{eqnarray*}
</p>
<p> The second term on the right is time independent, and so we couldintroduce a new "dynamic" pressure \(p_{\text{dyn}}=p+\rho_{\text{ref}} [1+\beta T_{\text{ref}}] \varphi=p_{\text{total}}-p_{\text{static}}\) with which the Stokes equations would read: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p_{\text{dyn}} &amp;=&amp; -\rho_{\text{ref}} \; \beta \; T \; \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> This is exactly the form we used in <a class="el" href="step_31.html">step-31</a> , and it wasappropriate to do so because all changes in the fluid flow are onlydriven by the dynamic pressure that results from temperaturedifferences. (In other words: Any contribution to the right hand sidethat results from taking the gradient of a scalar field have no effecton the velocity field.) On the other hand, we will here use the form of the Stokes equationsthat considers the total pressure instead: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; \rho(T)\; \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> There are several advantages to this:</p>
<ul>
<li>This way we can plot the pressure in our program in such a way that it actually shows the total pressure that includes the effects of temperature differences as well as the static pressure of the overlying rocks. Since the pressure does not appear any further in any of the other equations, whether to use one or the other is more a matter of taste than of correctness. The flow field is exactly the same, but we get a pressure that we can now compare with values that are given in geophysical books as those that hold at the bottom of the earth mantle, for example.</li>
<li>If we wanted to make the model even more realistic, we would have to take into account that many of the material parameters (e.g. the viscosity, the density, etc) not only depend on the temperature but also the <em>total</em> pressure.</li>
<li>The model above assumed a linear dependence \(\rho(T) = \rho_{\text{ref}} [1-\beta(T-T_{\text{ref}})]\) and assumed that \(\beta\) is small. In practice, this may not be so. In fact, realistic models are certainly not linear, and \(\beta\) may also not be small for at least part of the temperature range because the density's behavior is substantially dependent not only on thermal expansion but by phase changes.</li>
<li>A final reason to do this is discussed in the results section and concerns possible extensions to the model we use here. It has to do with the fact that the temperature equation (see below) we use here does not include a term that contains the pressure. It should, however: rock, like gas, heats up as you compress it. Consequently, material that rises up cools adiabatically, and cold material that sinks down heats adiabatically. We discuss this further below. <dl class="section note"><dt>Note</dt><dd>There is, however, a downside to this procedure. In the earth,the dynamic pressure is several orders of magnitude smaller than thetotal pressure. If we use the equations above and solve all variablesto, say, 4 digits of accuracy, then we may be able to get the velocityand the total pressure right, but we will have no accuracy at all ifwe compute the dynamic pressure by subtracting from the total pressurethe static part \(p_\text{static}=\rho_{\text{ref}} [1+\beta T_{\text{ref}}] \varphi\) . If, for example, the dynamicpressure is six orders of magnitude smaller than the static pressure,then we need to solve the overall pressure to at least seven digits ofaccuracy to get anything remotely accurate. That said, in practicethis turns out not to be a limiting factor.</dd></dl>
<a class="anchor" id="Thescalingofdiscretizedequations"></a><h3>The scaling of discretized equations </h3>
</li>
</ul>
<p>Remember that we want to solve the following set of equations: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; \rho(T) \mathbf{g}, \\ \nabla \cdot {\mathbf u} &amp;=&amp; 0, \\ \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma, \end{eqnarray*}
</p>
<p> augmented by appropriate boundary and initial conditions. As discussedin <a class="el" href="step_31.html">step-31</a> , we will solve this set of equations bysolving for a Stokes problem first in each time step, and then movingthe temperature equation forward by one time interval. The problem under consideration in this current section is with theStokes problem: if we discretize it as usual, we get a linear system </p><p class="formulaDsp">
\begin{eqnarray*} M \; X = \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{c} U \\ P \end{array}\right) = \left(\begin{array}{c} F_U \\ 0 \end{array}\right) = F \end{eqnarray*}
</p>
<p> which in this program we will solve with a FGMRES solver. This solveriterates until the residual of these linear equations is below acertain tolerance, i.e., until </p><p class="formulaDsp">
\[ \left\| \left(\begin{array}{c} F_U - A U^{(k)} - B P^{(k)} \\ B^T U^{(k)} \end{array}\right) \right\| &lt; \text{Tol}. \]
</p>
<p>@_fakenlThis does not make any sense from the viewpoint of physical units: thequantities involved here have physical units so that the first part ofthe residual has units \(\frac{\text{Pa}}{\text{m}} \text{m}^{\text{dim}}\) (most easily established by considering theterm \((\nabla \cdot \mathbf v, p)_{\Omega}\) and considering that thepressure has units \(\text{Pa}=\frac{\text{kg}}{\text{m}\;\text{s}^2}\) andthe integration yields a factor of \(\text{m}^{\text{dim}}\) ), whereasthe second part of the residual has units \(\frac{\text{m}^{\text{dim}}}{\text{s}}\) . Taking the normof this residual vector would yield a quantity with units \(\text{m}^{\text{dim}-1} \sqrt{\left(\text{Pa}\right)^2 + \left(\frac{\text{m}}{\text{s}}\right)^2}\) . This,quite obviously, does not make sense, and we should not be surprisedthat doing so is eventually going to come back hurting us. So why is this an issue here, but not in <a class="el" href="step_31.html">step-31</a> ? Thereason back there is that everything was nicely balanced: velocitieswere on the order of one, the pressure likewise, the viscosity wasone, and the domain had a diameter of \(\sqrt{2}\) . As a result, whilenonsensical, nothing bad happened. On the other hand, as we will explainbelow, things here will not be that simply scaled: \(\eta\) will be around \(10^{21}\) , velocities on the order of \(10^{-8}\) , pressure around \(10^8\) , andthe diameter of the domain is \(10^7\) . In other words, the order of magnitudefor the first equation is going to be \(\eta\text{div}\varepsilon(\mathbf u) \approx 10^{21} \frac{10^{-8}}{(10^7)^2} \approx 10^{-1}\) , whereas the second equation will be around \(\text{div}{\mathbf u}\approx \frac{10^{-8}}{10^7} \approx 10^{-15}\) . Well, sowhat this will lead to is this: if the solver wants to make the residual small,it will almost entirely focus on the first set of equations because they areso much bigger, and ignore the divergence equation that describes massconservation. That's exactly what happens: unless we set the tolerance toextremely small values, the resulting flow field is definitely not divergencefree. As an auxiliary problem, it turns out that it is difficult to find atolerance that always works; in practice, one often ends up with a tolerancethat requires 30 or 40 iterations for most time steps, and 10,000 for someothers. So what's a numerical analyst to do in a case like this? The answer is tostart at the root and first make sure that everything is mathematicallyconsistent first. In our case, this means that if we want to solve the systemof Stokes equations jointly, we have to scale them so that they all have thesame physical dimensions. In our case, this means multiplying the secondequation by something that has units \(\frac{\text{Pa}\;\text{s}}{\text{m}}\) ; onechoice is to multiply with \(\frac{\eta}{L}\) where \(L\) is a typical lengthscalein our domain (which experiments show is best chosen to be the diameter ofplumes &mdash; around 10 km &mdash; rather than the diameter of thedomain). Using these numbers for \(\eta\) and \(L\) , this factor is around \(10^{17}\) . So, we now get this for the Stokes system: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla p &amp;=&amp; \rho(T) \; \mathbf{g}, \\ \frac{\eta}{L} \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> The trouble with this is that the result is not symmetric any more (we have \(\frac{\eta}{L} \nabla \cdot\) at the bottom left, but not its transposeoperator at the top right). This, however, can be cured by introducing ascaled pressure \(\hat p = \frac{L}{\eta}p\) , and we get the scaled equations </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla \left(\frac{\eta}{L} \hat p\right) &amp;=&amp; \rho(T) \; \mathbf{g}, \\ \frac{\eta}{L} \nabla \cdot {\mathbf u} &amp;=&amp; 0. \end{eqnarray*}
</p>
<p> This is now symmetric. Obviously, we can easily recover the original pressure \(p\) from the scaled pressure \(\hat p\) that we compute as a result of thisprocedure. In the program below, we will introduce a factor <code>EquationData::pressure_scaling</code> that corresponds to \(\frac{\eta}{L}\) , and we will use this factor in the assembly of the systemmatrix and preconditioner. Because it is annoying and error prone, we willrecover the unscaled pressure immediately following the solution of the linearsystem, i.e., the solution vector's pressure component will immediately beunscaled to retrieve the physical pressure. Since the solver uses the fact thatwe can use a good initial guess by extrapolating the previous solutions, wealso have to scale the pressure immediately <em>before</em> solving.</p>
<p><a class="anchor" id="ChangestotheStokespreconditionerandsolver"></a></p><h3>Changes to the Stokes preconditioner and solver </h3>
<p>In this tutorial program, we apply a variant of the preconditioner used in <a class="el" href="step_31.html">step-31</a> . That preconditioner was built to operate on thesystem matrix \(M\) in block form such that the product matrix </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1} M = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ S^{-1} B A^{-1} &amp; -S^{-1} \end{array}\right) \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \end{eqnarray*}
</p>
<p> is of a form that Krylov-based iterative solvers like GMRES can solve in afew iterations. We then replaced the exact inverse of \(A\) by the actionof an AMG preconditioner \(\tilde{A}\) based on a vector Laplace matrix,approximated the Schur complement \(S = B A^{-1} B^T\) by a mass matrix \(M_p\) on the pressure space and wrote an <code>InverseMatrix</code> class forimplementing the action of \(M_p^{-1}\approx S^{-1}\) on vectors. In theInverseMatrix class, we used a CG solve with an incomplete Cholesky (IC)preconditioner for performing the inner solves. An observation one can make is that we use just the action of apreconditioner for approximating the velocity inverse \(A^{-1}\) (and theouter GMRES iteration takes care of the approximate character of theinverse), whereas we use a more or less <em>exact</em> inverse for \(M_p^{-1}\) ,realized by a fully converged CG solve. This appears unbalanced, but there'ssystem to this madness: almost all the effort goes into the upper left blockto which we apply the AMG preconditioner, whereas even an exact inversion ofthe pressure mass matrix costs basically nothing. Consequently, if it helps usreduce the overall number of iterations somewhat, then this effort is wellspent. That said, even though the solver worked well for <a class="el" href="step_31.html">step-31</a> , we have a problemhere that is a bit more complicated (cells are deformed, the pressure variesby orders of magnitude, and we want to plan ahead for more complicatedphysics), and so we'll change a few things slightly:</p>
<ul>
<li>For more complex problems, it turns out that using just a single AMG V-cycle as preconditioner is not always sufficient. The outer solver converges just fine most of the time in a reasonable number of iterations (say, less than 50) but there are the occasional time step where it suddenly takes 700 or so. What exactly is going on there is hard to determine, but the problem can be avoided by using a more accurate solver for the top left block. Consequently, we'll want to use a CG iteration to invert the top left block of the preconditioner matrix, and use the AMG as a preconditioner for the CG solver.</li>
<li>The downside of this is that, of course, the Stokes preconditioner becomes much more expensive (approximately 10 times more expensive than when we just use a single V-cycle). Our strategy then is this: let's do up to 30 GMRES iterations with just the V-cycle as a preconditioner and if that doesn't yield convergence, then take the best approximation of the Stokes solution obtained after this first round of iterations and use that as the starting guess for iterations where we use the full inner solver with a rather lenient tolerance as preconditioner. In all our experiments this leads to convergence in only a few additional iterations.</li>
<li>One thing we need to pay attention to is that when using a CG with a lenient tolerance in the preconditioner, then \(y = \tilde A^{-1} r\) is no longer a linear function of \(r\) (it is, of course, if we have a very stringent tolerance in our solver, or if we only apply a single V-cycle). This is a problem since now our preconditioner is no longer a linear operator; in other words, every time GMRES uses it the preconditioner looks different. The standard GMRES solver can't deal with this, leading to slow convergence or even breakdown, but the F-GMRES variant is designed to deal with exactly this kind of situation and we consequently use it.</li>
<li>On the other hand, once we have settled on using F-GMRES we can relax the tolerance used in inverting the preconditioner for \(S\) . In <a class="el" href="step_31.html">step-31</a> , we ran a preconditioned CG method on \(\tilde S\) until the residual had been reduced by 7 orders of magnitude. Here, we can again be more lenient because we know that the outer preconditioner doesn't suffer.</li>
<li>In <a class="el" href="step_31.html">step-31</a> , we used a left preconditioner in which we first invert the top left block of the preconditioner matrix, then apply the bottom left (divergence) one, and then invert the bottom right. In other words, the application of the preconditioner acts as a lower left block triangular matrix. Another option is to use a right preconditioner that here would be upper right block triangulation, i.e., we first invert the bottom right Schur complement, apply the top right (gradient) operator and then invert the elliptic top left block. To a degree, which one to choose is a matter of taste. That said, there is one significant advantage to a right preconditioner in GMRES-type solvers: the residual with which we determine whether we should stop the iteration is the true residual, not the norm of the preconditioned equations. Consequently, it is much simpler to compare it to the stopping criterion we typically use, namely the norm of the right hand side vector. In writing this code we found that the scaling issues we discussed above also made it difficult to determine suitable stopping criteria for left-preconditioned linear systems, and consequently this program uses a right preconditioner.</li>
<li>In <a class="el" href="step_31.html">step-31</a> , we used an IC (incomplete Cholesky) preconditioner for the pressure mass matrix in the Schur complement preconditioner and for the solution of the temperature system. Here, we could in principle do the same, but we do choose an even simpler preconditioner, namely a Jacobi preconditioner for both systems. This is because here we target at massively parallel computations, where the decompositions for IC/ILU would have to be performed block-wise for the locally owned degrees of freedom on each processor. This means, that the preconditioner gets more like a Jacobi preconditioner anyway, so we rather start from that variant straight away. Note that we only use the Jacobi preconditioners for CG solvers with mass matrices, where they give optimal (<em>h</em>-independent) convergence anyway, even though they usually require about twice as many iterations as an IC preconditioner. As a final note, let us remark that in <a class="el" href="step_31.html">step-31</a> we computed theSchur complement \(S=B A^{-1} B^T\) by approximating \(-\text{div}(-\eta\Delta)^{-1}\nabla \approx \frac 1{\eta} \mathbf{1}\) . Now,however, we have re-scaled the \(B\) and \(B^T\) operators. So \(S\) should nowapproximate \(-\frac{\eta}{L}\text{div}(-\eta\Delta)^{-1}\nabla \frac{\eta}{L} \approx \left(\frac{\eta}{L}\right)^2 \frac 1{\eta} \mathbf{1}\) .We use the discrete form of the right hand side of this as our approximation \(\tilde S\) to \(S\) .</li>
</ul>
<p><a class="anchor" id="Changestotheartificialviscositystabilization"></a></p><h3>Changes to the artificial viscosity stabilization </h3>
<p>Similarly to <a class="el" href="step_31.html">step-31</a> , we will use an artificial viscosity for stabilizationbased on a residual of the equation. As a difference to <a class="el" href="step_31.html">step-31</a> , we willprovide two slightly different definitions of the stabilization parameter. For \(\alpha=1\) , we use the same definition as in <a class="el" href="step_31.html">step-31</a> : </p><p class="formulaDsp">
\begin{eqnarray*} \nu_\alpha(T)|_K = \nu_1(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} h_K \min\left\{ 1, \frac{\|R_1(T)\|_{L^\infty(K)}}{c(\mathbf{u},T)} \right\} \end{eqnarray*}
</p>
<p> where we compute the viscosity from a residual \(\|R_1(T)\|_{L^\infty(K)}\) ofthe equation, limited by a diffusion proportional to the mesh size \(h_K\) inregions where the residual is large (around steep gradients). This definitionhas been shown to work well for the given case, \(\alpha = 1\) in <a class="el" href="step_31.html">step-31</a> , butit is usually less effective as the diffusion for \(\alpha=2\) . For that case, wechoose a slightly more readable definition of the viscosity, </p><p class="formulaDsp">
\begin{eqnarray*} \nu_2(T)|_K = \min (\nu_h^\mathrm{max}|_K,\nu_h^\mathrm{E}|_K) \end{eqnarray*}
</p>
<p> where the first term gives again the maximum dissipation (similarly to a firstorder upwind scheme), </p><p class="formulaDsp">
\begin{eqnarray*} \nu^\mathrm{max}_h|_K = \beta h_K \|\mathbf {u}\|_{L^\infty(K)} \end{eqnarray*}
</p>
<p> and the entropy viscosity is defined as </p><p class="formulaDsp">
\begin{eqnarray*} \nu^\mathrm{E}_h|_K = c_R \frac{h_K^2 \|R_\mathrm{2,E}(T)\|_{L^\infty(K)}} {\|E(T) - \bar{E}(T)\|_{L^\infty(\Omega)} }. \end{eqnarray*}
</p>
<p>This formula is described in the article <em>J.-L. Guermond, R. Pasquetti, &amp; B. Popov, 2011. Entropy viscosity method for nonlinear conservation laws, J. Comput. Phys., 230, 4248&ndash;4267.</em> Compared to the case \(\alpha = 1\) , theresidual is computed from the temperature entropy, \(E(T) = \frac12 (T-T_m)^2\) with \(T_m\) an average temperature (we choose the mean between the maximum andminimum temperature in the computation), which gives the following formula </p><p class="formulaDsp">
\begin{eqnarray*} R_\mathrm{E}(T) = \frac{\partial E(T)}{\partial t} + (T-T_\mathrm{m}) \left(\mathbf{u} \cdot \nabla T - \kappa \nabla^2 T - \gamma\right). \end{eqnarray*}
</p>
<p> The denominator in the formula for \(\nu^\mathrm{E}_h|_K\) is computed as theglobal deviation of the entropy from the space-averaged entropy \(\bar{E}(T) = \int_\Omega E(T) d\mathbf{x}/\int_\Omega d\mathbf{x}\) . As in <a class="el" href="step_31.html">step-31</a> , weevaluate the artificial viscosity from the temperature and velocity at twoprevious time levels, in order to avoid a nonlinearity in its definition. The above definitions of the viscosity are simple, but depend on twoparameters, namely \(\beta\) and \(c_R\) . For the current program, we want to goabout this issue a bit more systematically for both parameters in the case \(\alpha =1\) , using the same line of reasoning with which we chose two otherparameters in our discretization, \(c_k\) and \(\beta\) , in the results section of <a class="el" href="step_31.html">step-31</a> . In particular, remember that we would like to make the artificialviscosity as small as possible while keeping it as large as necessary. In thefollowing, let us describe the general strategy one may follow. Thecomputations shown here were done with an earlier version of the program andso the actual numerical values you get when running the program may no longermatch those shown here; that said, the general approach remains valid and hasbeen used to find the values of the parameters actually used in the program. To see what is happening, note that below we will imposeboundary conditions for the temperature between 973 and 4273 Kelvin,and initial conditions are also chosen in this range; for theseconsiderations, we run the program without internal heat sources or sinks,and consequently the temperature shouldalways be in this range, barring any internaloscillations. If the minimal temperature drops below 973 Kelvin, thenwe need to add stabilization by either increasing \(\beta\) ordecreasing \(c_R\) . As we did in <a class="el" href="step_31.html">step-31</a> , we first determine an optimal value of \(\beta\) by using the "traditional" formula </p><p class="formulaDsp">
\begin{eqnarray*} \nu_\alpha(T)|_K = \beta \|\mathbf{u}\|_{L^\infty(K)} h_K, \end{eqnarray*}
</p>
<p> which we know to be stable if only \(\beta\) is large enough. Doing acouple hundred time steps (on a coarser mesh than the one shown in theprogram, and with a different viscosity that affects transportvelocities and therefore time step sizes) in 2d will produce thefollowing graph: <img src="https://www.dealii.org/images/steps/developer/step-32.beta.2d.png" alt="" class="inline"/> <br  />
 As can be seen, values \(\beta \le 0.05\) are too small whereas \(\beta=0.052\) appears to work, at least to the time horizon shownhere. As a remark on the side, there are at least two questions onemay wonder here: First, what happens at the time when the solutionbecomes unstable? Looking at the graphical output, we can see thatwith the unreasonably coarse mesh chosen for these experiments, aroundtime \(t=10^{15}\) seconds the plumes of hot material that have beenrising towards the cold outer boundary and have then spread sidewaysare starting to get close to each other, squeezing out the coldmaterial in-between. This creates a layer of cells into which fluidsflows from two opposite sides and flows out toward a third, apparentlya scenario that then produce these instabilities without sufficientstabilization. Second: In <a class="el" href="step_31.html">step-31</a> , we used \(\beta=0.015\cdot\text{dim}\) ; why does this not work here? The answerto this is not entirely clear</p>
<ul>
<li>stabilization parameters arecertainly known to depend on things like the shape of cells, for whichwe had squares in <a class="el" href="step_31.html">step-31</a> but have trapezoids in the currentprogram. Whatever the exact cause, we at least have a value of \(\beta\) , namely 0.052 for 2d, that works for the current program.A similar set of experiments can be made in 3d where we find that \(\beta=0.078\) is a good choice &mdash; neatly leading to the formula \(\beta=0.026 \cdot \textrm{dim}\) . With this value fixed, we can go back to the original formula for theviscosity \(\nu\) and play with the constant \(c_R\) , making it as largeas possible in order to make \(\nu\) as small as possible. This gives usa picture like this: <img src="https://www.dealii.org/images/steps/developer/step-32.beta_cr.2d.png" alt="" class="inline"/> <br  />
 Consequently, \(c_R=0.1\) would appear to be the right value here. While thisgraph has been obtained for an exponent \(\alpha=1\) , in the program we use \(\alpha=2\) instead, and in that case one has to re-tune the parameter (andobserve that \(c_R\) appears in the numerator and not in the denominator). Itturns out that \(c_R=1\) works with \(\alpha=2\) .</li>
</ul>
<p><a class="anchor" id="LocallyconservativeStokesdiscretization"></a></p><h3>Locally conservative Stokes discretization </h3>
<p>The standard Taylor-Hood discretization for Stokes, using the \(Q_{k+1}^d \times Q_k\) element, is globally conservative, i.e. \(\int_{\partial\Omega} \mathbf n \cdot \mathbf u_h = 0\) . This can easily be seen: the weak form ofthe divergence equation reads \((q_h, \textrm{div}\; \mathbf u_h)=0, \forall q_h\in Q_h\) . Because the pressure space does contain the function \(q_h=1\) , weget </p><p class="formulaDsp">
\begin{align*} 0 = (1, \textrm{div}\; \mathbf u_h)_\Omega = \int_\Omega \textrm{div}\; \mathbf u_h = \int_{\partial\Omega} \mathbf n \cdot \mathbf u_h \end{align*}
</p>
<p> by the divergence theorem. This property is important: if we want to use thevelocity field \(u_h\) to transport along other quantities (such as thetemperature in the current equations, but it could also be concentrations ofchemical substances or entirely artificial tracer quantities) then theconservation property guarantees that the amount of the quantity advectedremains constant. That said, there are applications where this <em>global</em> property is notenough. Rather, we would like that it holds <em>locally</em>, on everycell. This can be achieved by using the space \(Q_{k+1}^d \times DGP_k\) for discretization, where we have replaced the<em>continuous</em> space of tensor product polynomials of degree \(k\) for thepressure by the <em>discontinuous</em> space of the complete polynomials of thesame degree. (Note that tensor product polynomials in 2d contain the functions \(1, x, y, xy\) , whereas the complete polynomials only have the functions \(1,x,y\) .)This space turns out to be stable for the Stokes equation. Because the space is discontinuous, we can now in particular choose the testfunction \(q_h(\mathbf x)=\chi_K(\mathbf x)\) , i.e. the characteristic functionof cell \(K\) . We then get in a similar fashion as above </p><p class="formulaDsp">
\begin{align*} 0 = (q_h, \textrm{div}\; \mathbf u_h)_\Omega = (1, \textrm{div}\; \mathbf u_h)_K = \int_K \textrm{div}\; \mathbf u_h = \int_{\partial K} \mathbf n \cdot \mathbf u_h, \end{align*}
</p>
<p> showing the conservation property for cell \(K\) . This clearly holds for eachcell individually. There are good reasons to use this discretization. As mentioned above, thiselement guarantees conservation of advected quantities on each cellindividually. A second advantage is that the pressure mass matrix we use as apreconditioner in place of the Schur complement becomes block diagonal andconsequently very easy to invert. However, there are also downsides. For one,there are now more pressure variables, increasing the overall size of theproblem, although this doesn't seem to cause much harm in practice. Moreimportantly, though, the fact that now the divergence integrated over eachcell is zero when it wasn't before does not guarantee that the divergence ispointwise smaller. In fact, as one can easily verify, the \(L_2\) norm of thedivergence is <em>larger</em> for this than for the standard Taylor-Hooddiscretization. (However, both converge at the same rate to zero, since it iseasy to see that \(\|\textrm{div}\; u_h\|= \|\textrm{div}\; (u-u_h)\|= \|\textrm{trace}\; \nabla (u-u_h)\|\le \|\nabla (u-u_h)\|={\cal O}(h^{k+2})\) .) It is therefore not a priori clearthat the error is indeed smaller just because we now have more degrees offreedom. Given these considerations, it remains unclear which discretization one shouldprefer. Consequently, we leave that up to the user and make it a parameter inthe input file which one to use.</p>
<p><a class="anchor" id="Higherordermappingsforcurvedboundaries"></a></p><h3>Higher order mappings for curved boundaries </h3>
<p>In the program, we will use a spherical shell as domain. This meansthat the inner and outer boundary of the domain are no longer"straight" (by which we usually mean that they are bilinear surfacesthat can be represented by the <a class="el" href="classFlatManifold.html">FlatManifold</a> class). Rather, theyare curved and it seems prudent to use a curved approximation in theprogram if we are already using higher order finite elements for thevelocity. Consequently, we will introduce a member variable of typeMappingQ thatdenotes such a mapping ( <a class="el" href="step_10.html">step-10</a> and <a class="el" href="step_11.html">step-11</a> introduce such mappingsfor the first time) and that we will use in all computations on cellsthat are adjacent to the boundary. Since this only affects arelatively small fraction of cells, the additional effort is not verylarge and we will take the luxury of using a quartic mapping for thesecells.</p>
<p><a class="anchor" id="Parallelizationonclusters"></a></p><h3>Parallelization on clusters </h3>
<p>Running convection codes in 3d with significant Rayleigh numbers requires a lotof computations &mdash; in the case of whole earth simulations on the order ofone or several hundred million unknowns. This can obviously not be done with asingle machine any more (at least not in 2010 when we started writing thiscode). Consequently, we need to parallelize it.Parallelization of scientific codes across multiple machines in a cluster ofcomputers is almost always done using the Message Passing Interface(MPI). This program is no exception to that, and it follows the general spiritof the <a class="el" href="step_17.html">step-17</a> and <a class="el" href="step_18.html">step-18</a> programs in this though in practice it borrows morefrom <a class="el" href="step_40.html">step-40</a> in which we first introduced the classes and strategies we usewhen we want to <em>completely</em> distribute all computations, and <a class="el" href="step_55.html">step-55</a> that shows how to do that for <a class="el" href="group__vector__valued.html">vector-valued problems</a>: including, forexample, splitting the mesh up into a number of parts so that each processoronly stores its own share plus some ghost cells, and using strategies where noprocessor potentially has enough memory to hold the entries of the combinedsolution vector locally. The goal is to run this code on hundreds or maybeeven thousands of processors, at reasonable scalability. </p><dl class="section note"><dt>Note</dt><dd>Even though it has a larger number, <a class="el" href="step_40.html">step-40</a> comes logically before thecurrent program. The same is true for <a class="el" href="step_55.html">step-55</a> . You will probably wantto look at these programs before you try to understand what we do here. MPI is a rather awkward interface to program with. It is a semi-objectoriented set of functions, and while one uses it to send data around anetwork, one needs to explicitly describe the data types because the MPIfunctions insist on getting the address of the data as <code>void*</code> objects rather than deducing the data type automatically through overloadingor templates. We've already seen in <a class="el" href="step_17.html">step-17</a> and <a class="el" href="step_18.html">step-18</a> how to avoid almostall of MPI by putting all the communication necessary into either the deal.IIlibrary or, in those programs, into PETSc. We'll do something similar here:like in <a class="el" href="step_40.html">step-40</a> and <a class="el" href="step_55.html">step-55</a> , deal.II and the underlying p4est library are responsible forall the communication necessary for distributing the mesh, and we will let theTrilinos library (along with the wrappers in namespace <a class="el" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a>) dealwith parallelizing the linear algebra components. We have already usedTrilinos in <a class="el" href="step_31.html">step-31</a> , and will do so again here, with the difference that wewill use its parallel capabilities. Trilinos consists of a significant number of packages, implementing basicparallel linear algebra operations (the Epetra package), different solver andpreconditioner packages, and on to things that are of less importance todeal.II (e.g., optimization, uncertainty quantification, etc).deal.II's Trilinos interfaces encapsulate many of the things Trilinos offersthat are of relevance to PDE solvers, andprovides wrapper classes (in namespace <a class="el" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a>) that make theTrilinos matrix, vector, solver and preconditioner classes look very much thesame as deal.II's own implementations of this functionality. However, asopposed to deal.II's classes, they can be used in parallel if we give them thenecessary information. As a consequence, there are two Trilinos classes thatwe have to deal with directly (rather than through wrappers), both of whichare part of Trilinos' Epetra library of basic linear algebra and tool classes: <ul>
<li>
<p class="startli">The Epetra_Comm class is an abstraction of an MPI "communicator", i.e., it describes how many and which machines can communicate with each other. Each distributed object, such as a sparse matrix or a vector for which we may want to store parts on different machines, needs to have a communicator object to know how many parts there are, where they can be found, and how they can be accessed. In this program, we only really use one communicator object</p>
<ul>
<li>based on the MPI variable <code>MPI_COMM_WORLD</code> <br  />
</li>
<li>that encompasses <em>all</em> processes that work together. It would be perfectly legitimate to start a process on \(N\) machines but only store vectors on a subset of these by producing a communicator object that only encompasses this subset of machines; there is really no compelling reason to do so here, however. </li>
</ul>
</li>
<li>
The <a class="el" href="classIndexSet.html">IndexSet</a> class is used to describe which elements of a vector or which rows of a matrix should reside on the current machine that is part of a communicator. To create such an object, you need to know (i) the total number of elements or rows, (ii) the indices of the elements you want to store locally. We will set up these <code>partitioners</code> in the <code>BoussinesqFlowProblem::setup_dofs</code> function below and then hand it to every parallel object we create. Unlike PETSc, Trilinos makes no assumption that the elements of a vector need to be partitioned into contiguous chunks. At least in principle, we could store all elements with even indices on one processor and all odd ones on another. That's not very efficient, of course, but it's possible. Furthermore, the elements of these partitionings do not necessarily be mutually exclusive. This is important because when postprocessing solutions, we need access to all locally relevant or at least the locally active degrees of freedom (see the module on <a class="el" href="group__distributed.html">Parallel computing with multiple processors using</a> for a definition, as well as the discussion in <a class="el" href="step_40.html">step-40</a> ). Which elements the Trilinos vector considers as locally owned is not important to us then. All we care about is that it stores those elements locally that we need. </li>
</ul>
<br  />
 There are a number of other concepts relevant to distributing the meshto a number of processors; you may want to take a look at the <a class="el" href="group__distributed.html">Parallel computing with multiple processors using</a> module and <a class="el" href="step_40.html">step-40</a> or <a class="el" href="step_55.html">step-55</a> before trying to understand thisprogram. The rest of the program is almost completely agnostic aboutthe fact that we don't store all objects completely locally. Therewill be a few points where we have to limit loops over all cells tothose that are locally owned, or where we need to distinguish betweenvectors that store only locally owned elements and those that storeeverything that is locally relevant (see <a class="el" href="DEALGlossary.html#GlossLocallyRelevantDof">this glossary entry</a>), but by and large the amount of heavy liftingnecessary to make the program run in parallel is well hidden in thelibraries upon which this program builds. In any case, we will commenton these locations as we get to them in the program code.</dd></dl>
<p><a class="anchor" id="Parallelizationwithinindividualnodesofacluster"></a></p><h3>Parallelization within individual nodes of a cluster </h3>
<p>The second strategy to parallelize a program is to make use of the fact thatmost computers today have more than one processor that all have access to thesame memory. In other words, in this model, we don't explicitly have to saywhich pieces of data reside where</p>
<ul>
<li>all of the data we need is directlyaccessible and all we have to do is split <em>processing</em> this data betweenthe available processors. We will then couple this with the MPIparallelization outlined above, i.e., we will have all the processors on amachine work together to, for example, assemble the local contributions to theglobal matrix for the cells that this machine actually "owns" but not forthose cells that are owned by other machines. We will use this strategy forfour kinds of operations we frequently do in this program: assembly of theStokes and temperature matrices, assembly of the matrix that forms the Stokespreconditioner, and assembly of the right hand side of the temperature system. All of these operations essentially look as follows: we need to loop over allcells for which <code>cell-&gt;<a class="el" href="tria__levels__0_8txt.html#a26cab9b2fe6e7f95a4102fbd722c02b1">subdomain_id()</a></code> equals the index ourmachine has within the communicator object used for all communication(i.e., <code>MPI_COMM_WORLD</code> , as explained above). The test we areactually going to use for this, and which describes in a concise way why wetest this condition, is <code>cell-&gt;<a class="el" href="quadrature__point__data__0_8txt.html#a175634c053aca0ba3b25782a53938ea5">is_locally_owned()</a></code> . On eachsuch cell we need to assemble the local contributions to the global matrix orvector, and then we have to copy each cell's contribution into the globalmatrix or vector. Note that the first part of this (the loop) defines a rangeof iterators on which something has to happen. The second part, assembly oflocal contributions is something that takes the majority of CPU time in thissequence of steps, and is a typical example of things that can be done inparallel: each cell's contribution is entirely independent of all other cells'contributions. The third part, copying into the global matrix, must not happenin parallel since we are modifying one object and so several threads can notat the same time read an existing matrix element, add their contribution, andwrite the sum back into memory without danger of producing a <a href="http://en.wikipedia.org/wiki/Race_condition">race condition</a>. deal.II has a class that is made for exactly this workflow: <a class="el" href="namespaceWorkStream.html">WorkStream</a>, firstdiscussed in <a class="el" href="step_9.html">step-9</a> and <a class="el" href="step_13.html">step-13</a> . Itsuse is also extensively documented in the module on <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing</a> (in the sectionon <a class="el" href="group__threads.html#MTWorkStream">the WorkStream class</a>) and we won't repeat here therationale and detailed instructions laid out there, though you will want toread through this module to understand the distinction between scratch spaceand per-cell data. Suffice it to mention that we need the following:</li>
<li>An iterator range for those cells on which we are supposed to work. This is provided by the <a class="el" href="classFilteredIterator.html">FilteredIterator</a> class which acts just like every other cell iterator in deal.II with the exception that it skips all cells that do not satisfy a particular predicate (i.e., a criterion that evaluates to true or false). In our case, the predicate is whether a cell is locally owned.</li>
<li>A function that does the work on each cell for each of the tasks identified above, i.e., functions that assemble the local contributions to Stokes matrix and preconditioner, temperature matrix, and temperature right hand side. These are the <code>BoussinesqFlowProblem::local_assemble_stokes_system</code> , <code>BoussinesqFlowProblem::local_assemble_stokes_preconditioner</code> , <code>BoussinesqFlowProblem::local_assemble_temperature_matrix</code> , and <code>BoussinesqFlowProblem::local_assemble_temperature_rhs</code> functions in the code below. These four functions can all have several instances running in parallel at the same time.</li>
<li>Functions that copy the result of the previous ones into the global object and that run sequentially to avoid race conditions. These are the <code>BoussinesqFlowProblem::copy_local_to_global_stokes_system</code> , <code>BoussinesqFlowProblem::copy_local_to_global_stokes_preconditioner</code> , <code>BoussinesqFlowProblem::copy_local_to_global_temperature_matrix</code> , and <code>BoussinesqFlowProblem::copy_local_to_global_temperature_rhs</code> functions. We will comment on a few more points in the actual code, but in generaltheir structure should be clear from the discussion in <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing</a> . The underlying technology for <a class="el" href="namespaceWorkStream.html">WorkStream</a> identifies "tasks" that need to beworked on (e.g. assembling local contributions on a cell) and schedulesthese tasks automatically to available processors. <a class="el" href="namespaceWorkStream.html">WorkStream</a> creates thesetasks automatically, by splitting the iterator range into suitable chunks. <dl class="section note"><dt>Note</dt><dd>Using multiple threads within each MPI process only makes sense if youhave fewer MPI processes running on each node of your cluster than there areprocessor cores on this machine. Otherwise, MPI will already keep yourprocessors busy and you won't get any additional speedup from usingthreads. For example, if your cluster nodes have 8 cores as they often have atthe time of writing this, and if your batch scheduler puts 8 MPI processes oneach node, then using threads doesn't make the program anyfaster. Consequently, you probably want to either configure your deal.II withoutthreads, or set the number of threads in <a class="el" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> to 1(third argument), or "export DEAL_II_NUM_THREADS=1" before running. That said, atthe time of writing this, we only use the <a class="el" href="namespaceWorkStream.html">WorkStream</a> class for assembling(parts of) linear systems, while 75% or more of the run time of the program isspent in the linear solvers that are not parallelized &mdash; in other words,the best we could hope is to parallelize the remaining 25%.</dd></dl>
<a class="anchor" id="Thetestcase"></a><h3>The testcase </h3>
</li>
</ul>
<p>The setup for this program is mildly reminiscent of the problem we wanted tosolve in the first place (see the introduction of <a class="el" href="step_31.html">step-31</a> ):convection in the earth mantle. As a consequence, we choose the followingdata, all of which appears in the program in units of meters and seconds (theSI system) even if we list them here in other units. We do note,however, that these choices are essentially still only exemplary, andnot meant to result in a completely realistic description ofconvection in the earth mantle: for that, more and more difficultphysics would have to be implemented, and several other aspects arecurrently missing from this program as well. We will come back to thisissue in the results section again, but state for now that providing arealistic description is a goal of the <em>ASPECT</em> code indevelopment at the time of writing this. As a reminder, let us again state the equations we want to solve are these: </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot (2 \eta \varepsilon ({\mathbf u})) + \nabla \left( \frac{\eta}{L} \hat p\right) &amp;=&amp; \rho(T) \mathbf{g}, \\ \frac{\eta}{L} \nabla \cdot {\mathbf u} &amp;=&amp; 0, \\ \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma, \end{eqnarray*}
</p>
<p> augmented by boundary and initial conditions. We then have to choose data forthe following quantities: </p><ul>
<li>
The domain is an annulus (in 2d) or a spherical shell (in 3d) with inner and outer radii that match that of the earth: the total radius of the earth is 6371km, with the mantle starting at a depth of around 35km (just under the solid earth <a href="http://en.wikipedia.org/wiki/Crust_(geology)" target="_top">crust</a> composed of <a href="http://en.wikipedia.org/wiki/Continental_crust" target="_top">continental</a> and <a href="http://en.wikipedia.org/wiki/Oceanic_crust" target="_top">oceanic plates</a>) to a depth of 2890km (where the <a href="http://en.wikipedia.org/wiki/Outer_core" target="_top">outer earth core</a> starts). The radii are therefore \(R_0=(6371-2890)\text{km}, R_1=(6371-35)\text{km}\) . This domain is conveniently generated using the <a class="el" href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell()</a> function. </li>
<li>
<p class="startli">At the interface between crust and mantle, the temperature is between 500 and 900 degrees Celsius, whereas at its bottom it is around 4000 degrees Celsius (see, for example, <a href="http://en.wikipedia.org/wiki/Mantle_(geology)" target="_top">this Wikipedia entry</a>). In Kelvin, we therefore choose \(T_0=(4000+273)\text{K}\) , \(T_1=(500+273)\text{K}\) as boundary conditions at the inner and outer edge. In addition to this, we also have to specify some initial conditions for the temperature field. The real temperature field of the earth is quite complicated as a consequence of the convection that has been going on for more than four billion years</p>
<ul>
<li>in fact, it is the properties of this temperature distribution that we want to explore with programs like this. As a consequence, we don't really have anything useful to offer here, but we can hope that if we start with something and let things run for a while that the exact initial conditions don't matter that much any more &mdash; as is in fact suggested by looking at the pictures shown in the <a href="#Results">results section below</a>. The initial temperature field we use here is given in terms of the radius by <p class="formulaDsp">
\begin{align*} s &amp;= \frac{\|\mathbf x\|-R_0}{R_1-R_0}, \\ \varphi &amp;= \arctan \frac{y}{x}, \\ \tau &amp;= s + \frac 15 s(1-s) \sin(6\varphi) q(z), \\ T(\mathbf x) &amp;= T_0(1-\tau) + T_1\tau, \end{align*}
</p>
 where <p class="formulaDsp">
\begin{align*} q(z) = \left\{ \begin{array}{ll} 1 &amp; \text{in 2d} \\ \max\{0, \cos(\pi |z/R_1|)\} &amp; \text{in 3d} \end{array} \right. . \end{align*}
</p>
 This complicated function is essentially a perturbation of a linear profile between the inner and outer temperatures. In 2d, the function \(\tau=\tau(\mathbf x)\) looks like this (I got the picture from <a href="http://www.wolframalpha.com/input/?i=plot+%28sqrt%28x^2%2By^2%29%2B0.2*%28sqrt%28x^2%2By^2%29*%281-sqrt%28x^2%2By^2%29%29*sin%286*atan2%28x%2Cy%29%29%29%2C+x%3D-1+to+1%2C+y%3D-1+to+1">this page</a>): <img src="https://www.dealii.org/images/steps/developer/step-32.2d-initial.png" alt="" class="inline"/> <br  />
 The point of this profile is that if we had used \(s\) instead of \(\tau\) in the definition of \(T(\mathbf x)\) then it would simply be a linear interpolation. \(\tau\) has the same function values as \(s\) on the inner and outer boundaries (zero and one, respectively), but it stretches the temperature profile a bit depending on the angle and the \(z\) value in 3d, producing an angle-dependent perturbation of the linearly interpolating field. We will see in the results section that this is an entirely unphysical temperature field (though it will make for interesting images) as the equilibrium state for the temperature will be an almost constant temperature with boundary layers at the inner and outer boundary. </li>
</ul>
</li>
<li>
The right hand side of the temperature equation contains the rate of internal heating \(\gamma\) . The earth does heat naturally through several mechanisms: radioactive decay, chemical separation (heavier elements sink to the bottom, lighter ones rise to the top; the countercurrents dissipate energy equal to the loss of potential energy by this separation process); heat release by crystallization of liquid metal as the solid inner core of the earth grows; and heat dissipation from viscous friction as the fluid moves. Chemical separation is difficult to model since it requires modeling mantle material as multiple phases; it is also a relatively small effect. Crystallization heat is even more difficult since it is confined to areas where temperature and pressure allow for phase changes, i.e., a discontinuous process. Given the difficulties in modeling these two phenomena, we will neglect them. The other two are readily handled and, given the way we scaled the temperature equation, lead to the equation <p class="formulaDsp">
\[ \gamma(\mathbf x) = \frac{\rho q+2\eta \varepsilon(\mathbf u):\varepsilon(\mathbf u)} {\rho c_p}, \]
</p>
 where \(q\) is the radiogenic heating in \(\frac{W}{kg}\) , and the second term in the enumerator is viscous friction heating. \(\rho\) is the density and \(c_p\) is the specific heat. The literature provides the following approximate values: \(c_p=1250 \frac{J}{kg\; K}, q=7.4\cdot 10^{-12}\frac{W}{kg}\) . The other parameters are discussed elsewhere in this section. We neglect one internal heat source, namely adiabatic heating here, which will lead to a surprising temperature field. This point is commented on in detail in the results section below. </li>
<li>
For the velocity we choose as boundary conditions \(\mathbf{v}=0\) at the inner radius (i.e., the fluid sticks to the earth core) and \(\mathbf{n}\cdot\mathbf{v}=0\) at the outer radius (i.e., the fluid flows tangentially along the bottom of the earth crust). Neither of these is physically overly correct: certainly, on both boundaries, fluids can flow tangentially, but they will incur a shear stress through friction against the medium at the other side of the interface (the metallic core and the crust, respectively). Such a situation could be modeled by a Robin-type boundary condition for the tangential velocity; in either case, the normal (vertical) velocity would be zero, although even that is not entirely correct since continental plates also have vertical motion (see, for example, the phenomenon of <a href="http://en.wikipedia.org/wiki/Postglacial_rebound">post-glacial rebound</a>). But to already make things worse for the tangential velocity, the medium on the other side is in motion as well, so the shear stress would, in the simplest case, be proportional to the <em>velocity difference</em>, leading to a boundary condition of the form <p class="formulaDsp">
\begin{align*} \mathbf{n}\cdot [2\eta \varepsilon(\mathbf v)] &amp;= s \mathbf{n} \times [\mathbf v - \mathbf v_0], \\ \mathbf{n} \cdot \mathbf v &amp;= 0, \end{align*}
</p>
 with a proportionality constant \(s\) . Rather than going down this route, however, we go with the choice of zero (stick) and tangential flow boundary conditions. As a side note of interest, we may also have chosen tangential flow conditions on both inner and outer boundary. That has a significant drawback, however: it leaves the velocity not uniquely defined. The reason is that all velocity fields \(\hat{\mathbf v}\) that correspond to a solid body rotation around the center of the domain satisfy \(\mathrm{div}\; \varepsilon(\hat{\mathbf v})=0, \mathrm{div} \;\hat{\mathbf v} = 0\) , and \(\mathbf{n} \cdot \hat{\mathbf v} = 0\) . As a consequence, if \(\mathbf v\) satisfies equations and boundary conditions, then so does \(\mathbf v + \hat{\mathbf v}\) . That's certainly not a good situation that we would like to avoid. The traditional way to work around this is to pick an arbitrary point on the boundary and call this your fixed point by choosing the velocity to be zero in all components there. (In 3d one has to choose two points.) Since this program isn't meant to be too realistic to begin with, we avoid this complication by simply fixing the velocity along the entire interior boundary. </li>
<li>
<p class="startli">To first order, the gravity vector always points downward. The question for a body as big as the earth is just: where is "up". The naive answer of course is "radially inward, towards the center of the earth". So at the surface of the earth, we have </p><p class="formulaDsp">
\[ \mathbf g = -9.81 \frac{\text{m}}{\text{s}^2} \frac{\mathbf x}{\|\mathbf x\|}, \]
</p>
<p> where \(9.81 \frac{\text{m}}{\text{s}^2}\) happens to be the average gravity acceleration at the earth surface. But in the earth interior, the question becomes a bit more complicated: at the (bary-)center of the earth, for example, you have matter pulling equally hard in all directions, and so \(\mathbf g=0\) . In between, the net force is described as follows: let us define the <a href="http://en.wikipedia.org/wiki/Potential_energy#Gravitational_potential_energy" target="_top">gravity potential</a> by </p><p class="formulaDsp">
\[ \varphi(\mathbf x) = \int_{\text{earth}} -G \frac{\rho(\mathbf y)}{\|\mathbf x-\mathbf y\|} \ \text{d}y, \]
</p>
<p> then \(\mathbf g(\mathbf x) = -\nabla \varphi(\mathbf x)\) . If we assume that the density \(\rho\) is constant throughout the earth, we can produce an analytical expression for the gravity vector (don't try to integrate above equation somehow</p>
<ul>
<li><p class="startli">it leads to elliptic integrals; a simpler way is to notice that \(-\Delta\varphi(\mathbf x) = -4\pi G \rho \chi_{\text{earth}}(\mathbf x)\) and solving this partial differential equation in all of \({\mathbb R}^3\) exploiting the radial symmetry): </p><p class="formulaDsp">
\[ \mathbf g(\mathbf x) = \left\{ \begin{array}{ll} -\frac{4}{3}\pi G \rho \|\mathbf x\| \frac{\mathbf x}{\|\mathbf x\|} &amp; \text{for} \ \|\mathbf x\|&lt;R_1, \\ -\frac{4}{3}\pi G \rho R^3 \frac{1}{\|\mathbf x\|^2} \frac{\mathbf x}{\|\mathbf x\|} &amp; \text{for} \ \|\mathbf x\|\ge R_1. \end{array} \right. \]
</p>
<p> The factor \(-\frac{\mathbf x}{\|\mathbf x\|}\) is the unit vector pointing radially inward. Of course, within this problem, we are only interested in the branch that pertains to within the earth, i.e., \(\|\mathbf x\|&lt;R_1\) . We would therefore only consider the expression </p><p class="formulaDsp">
\[ \mathbf g(\mathbf x) = -\frac{4}{3}\pi G \rho \|\mathbf x\| \frac{\mathbf x}{\|\mathbf x\|} = -\frac{4}{3}\pi G \rho \mathbf x = - 9.81 \frac{\mathbf x}{R_1} \frac{\text{m}}{\text{s}^2}, \]
</p>
<p> where we can infer the last expression because we know Earth's gravity at the surface (where \(\|x\|=R_1\) ). One can derive a more general expression by integrating the differential equation for \(\varphi(r)\) in the case that the density distribution is radially symmetric, i.e., \(\rho(\mathbf x)=\rho(\|\mathbf x\|)=\rho(r)\) . In that case, one would get </p><p class="formulaDsp">
\[ \varphi(r) = 4\pi G \int_0^r \frac 1{s^2} \int_0^s t^2 \rho(t) \; dt \; ds. \]
</p>
<p class="startli">There are two problems with this, however: (i) The Earth is not homogeneous, i.e., the density \(\rho\) depends on \(\mathbf x\) ; in fact it is not even a function that only depends on the radius \(r=\|\mathbf x\|\) . In reality, gravity therefore does not always decrease as we get deeper: because the earth core is so much denser than the mantle, gravity actually peaks at around \(10.7 \frac{\text{m}}{\text{s}^2}\) at the core mantle boundary (see <a href="http://en.wikipedia.org/wiki/Earth&#39;s_gravity" target="_top">this article</a>). (ii) The density, and by consequence the gravity vector, is not even constant in time: after all, the problem we want to solve is the time dependent upwelling of hot, less dense material and the downwelling of cold dense material. This leads to a gravity vector that varies with space and time, and does not always point straight down. In order to not make the situation more complicated than necessary, we could use the approximation that at the inner boundary of the mantle, gravity is \(10.7 \frac{\text{m}}{\text{s}^2}\) and at the outer boundary it is \(9.81 \frac{\text{m}}{\text{s}^2}\) , in each case pointing radially inward, and that in between gravity varies linearly with the radial distance from the earth center. That said, it isn't that hard to actually be slightly more realistic and assume (as we do below) that the earth mantle has constant density. In that case, the equation above can be integrated and we get an expression for \(\|\mathbf{g}\|\) where we can fit constants to match the gravity at the top and bottom of the earth mantle to obtain </p><p class="formulaDsp">
\[ \|\mathbf{g}\| = 1.245\cdot 10^{-6} \frac{1}{\textrm{s}^2} r + 7.714\cdot 10^{13} \frac{\textrm{m}^3}{\textrm{s}^2}\frac{1}{r^2}. \]
</p>
 </li>
</ul>
</li>
<li>
The density of the earth mantle varies spatially, but not by very much. \(\rho_{\text{ref}}=3300 \frac{\text{kg}}{\text{m}^3}\) is a relatively good average value for the density at reference temperature \(T_{\text{ref}}=293\) Kelvin. </li>
<li>
The thermal expansion coefficient \(\beta\) also varies with depth (through its dependence on temperature and pressure). Close to the surface, it appears to be on the order of \(\beta=45\cdot 10^{-6} \frac 1{\text{K}}\) , whereas at the core mantle boundary, it may be closer to \(\beta=10\cdot 10^{-6} \frac 1{\text{K}}\) . As a reasonable value, let us choose \(\beta=2\cdot 10^{-5} \frac 1{\text{K}}\) . The density as a function of temperature is then \(\rho(T)=[1-\beta(T-T_{\text{ref}})]\rho_{\text{ref}}\) . </li>
<li>
The second to last parameter we need to specify is the viscosity \(\eta\) . This is a tough one, because rocks at the temperatures and pressure typical for the earth mantle flow so slowly that the viscosity can not be determined accurately in the laboratory. So how do we know about the viscosity of the mantle? The most commonly used route is to consider that during and after ice ages, ice shields form and disappear on time scales that are shorter than the time scale of flow in the mantle. As a consequence, continents slowly sink into the earth mantle under the added weight of an ice shield, and they rise up again slowly after the ice shield has disappeared again (this is called <a href="http://en.wikipedia.org/wiki/Postglacial_rebound" target="_top"><em>postglacial rebound</em><em>postglacial rebound</em></a>). By measuring the speed of this rebound, we can infer the viscosity of the material that flows into the area vacated under the rebounding continental plates. Using this technique, values around \(\eta=10^{21} \text{Pa}\;\text{s} = 10^{21} \frac{\text{N}\;\text{s}}{\text{m}^2} = 10^{21} \frac{\text{kg}}{\text{m}\;\text{s}}\) have been found as the most likely, though the error bar on this is at least one order of magnitude. While we will use this value, we again have to caution that there are many physical reasons to assume that this is not the correct value. First, it should really be made dependent on temperature: hotter material is most likely to be less viscous than colder material. In reality, however, the situation is even more complex. Most rocks in the mantle undergo phase changes as temperature and pressure change: depending on temperature and pressure, different crystal configurations are thermodynamically favored over others, even if the chemical composition of the mantle were homogeneous. For example, the common mantle material MgSiO<sub>3</sub> exists in its <a href="http://en.wikipedia.org/wiki/Perovskite_(structure)" target="_top">perovskite structure</a> throughout most of the mantle, but in the lower mantle the same substance is stable only as <a href="http://en.wikipedia.org/wiki/Postperovskite" targe="_top">post-perovskite</a>. Clearly, to compute realistic viscosities, we would not only need to know the exact chemical composition of the mantle and the viscosities of all materials, but we would also have to compute the thermodynamically most stable configurations for all materials at each quadrature point. This is at the time of writing this program not a feasible suggestion. </li>
<li>
Our last material parameter is the thermal diffusivity \(\kappa\) , which is defined as \(\kappa=\frac{k}{\rho c_p}\) where \(k\) is the thermal conductivity, \(\rho\) the density, and \(c_p\) the specific heat. For this, the literature indicates that it increases from around \(0.7\) in the upper mantle to around \(1.7 \frac{\text{mm}^2}{\text{s}}\) in the lower mantle, though the exact value is not really all that important: heat transport through convection is several orders of magnitude more important than through thermal conduction. It may be of interest to know that perovskite, the most abundant material in the earth mantle, appears to become transparent at pressures above around 120 GPa (see, for example, J. Badro et al., Science 305, 383-386 (2004)); in the lower mantle, it may therefore be that heat transport through radiative transfer is more efficient than through thermal conduction. In view of these considerations, let us choose \(\kappa=1 \frac{\text{mm}^2}{\text{s}} =10^{-6} \frac{\text{m}^2}{\text{s}}\) for the purpose of this program. </li>
</ul>
<p><br  />
 All of these pieces of equation data are defined in the program in the <code>EquationData</code> namespace. When run, the program produceslong-term maximal velocities around 10-40 centimeters per year (seethe results section below), approximately the physically correct orderof magnitude. We will set the end time to 1 billion years. </p><dl class="section note"><dt>Note</dt><dd>The choice of the constants and material parameters above follows inlarge part the comprehensive book "Mantle Convection in the Earth and Planets,Part 1" by G. Schubert and D. L. Turcotte and P. Olson (Cambridge, 2001). Itcontains extensive discussion of ways to make the program more realistic.</dd></dl>
<p><a class="anchor" id="Implementationdetails"></a></p><h3>Implementation details </h3>
<p>Compared to <a class="el" href="step_31.html">step-31</a> , this program has a number of noteworthy differences:</p>
<ul>
<li>The <code>EquationData</code> namespace is significantly larger, reflecting the fact that we now have much more physics to deal with. That said, most of this additional physical detail is rather self-contained in functions in this one namespace, and does not proliferate throughout the rest of the program.</li>
<li>Of more obvious visibility is the fact that we have put a good number of parameters into an input file handled by the <a class="el" href="classParameterHandler.html">ParameterHandler</a> class (see, for example, <a class="el" href="step_29.html">step-29</a> , for ways to set up run-time parameter files with this class). This often makes sense when one wants to avoid re-compiling the program just because one wants to play with a single parameter (think, for example, of parameter studies determining the best values of the stabilization constants discussed above), in particular given that it takes a nontrivial amount of time to re-compile programs of the current size. To just give an overview of the kinds of parameters we have moved from fixed values into the input file, here is a listing of a typical <code>step-32.prm</code> file : <div class="fragment"><div class="line"><span class="preprocessor"># Listing of Parameters</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line">  </div>
<div class="line">---------------------</div>
<div class="line"><span class="preprocessor"># The end time of the simulation in years.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> End <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>                            = 1e8</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor"># Whether graphical output is to be generated or not. You may not want to get</span></div>
<div class="line"><span class="preprocessor"># graphical output if the number of processors is large.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Generate graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>           = <span class="keyword">false</span></div>
<div class="line">  </div>
<div class="line"><span class="preprocessor"># The number of adaptive refinement steps performed after initial global</span></div>
<div class="line"><span class="preprocessor"># refinement.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Initial adaptive <a class="code" href="quadrature__point__data__0_8txt.html#a35c4177ef651238576ebc1395f9e116e">refinement</a>         = 1</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor"># The number of global refinement steps performed on the initial coarse mesh,</span></div>
<div class="line"><span class="preprocessor"># before the problem is first solved there.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Initial <a class="code" href="block__info__0_8txt.html#adf3728ee2be920ec28e2f66b5a04a213">global</a> <a class="code" href="quadrature__point__data__0_8txt.html#a35c4177ef651238576ebc1395f9e116e">refinement</a>           = 1</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor"># The number of time steps between each generation of graphical output files.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Time <a class="code" href="solver__cg__0_8txt.html#ab8dd1e5e6028b76d234561ae8e1d22bc">steps</a> between graphical <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a> = 50</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor"># The number of time steps after which the mesh is to be adapted based on</span></div>
<div class="line"><span class="preprocessor"># computed error indicators.</span></div>
<div class="line"><a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Time <a class="code" href="solver__cg__0_8txt.html#ab8dd1e5e6028b76d234561ae8e1d22bc">steps</a> between <a class="code" href="distributed__0_8txt.html#a1a9fea1222a1f75ee681b6805de5f7fc">mesh</a> <a class="code" href="quadrature__point__data__0_8txt.html#a35c4177ef651238576ebc1395f9e116e">refinement</a>  = 10</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">subsection Discretization</div>
<div class="line"><span class="preprocessor">  # The polynomial degree to use for the velocity variables in the Stokes</span></div>
<div class="line"><span class="preprocessor">  # system.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Stokes <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a> <a class="code" href="polynomial__0_8txt.html#acef1a730e4f0566e0f83339e387c6dfa">polynomial</a> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>       = 2</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">  # The polynomial degree to use for the temperature variable.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Temperature <a class="code" href="polynomial__0_8txt.html#acef1a730e4f0566e0f83339e387c6dfa">polynomial</a> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>           = 2</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">  # Whether to use a Stokes discretization that is locally conservative at the</span></div>
<div class="line"><span class="preprocessor">  # expense of a larger number of degrees of freedom, or to go with a cheaper</span></div>
<div class="line"><span class="preprocessor">  # discretization that does not locally conserve mass (although it is</span></div>
<div class="line"><span class="preprocessor">  # globally conservative.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> Use <a class="code" href="trilinos__sparsity__pattern__0_8txt.html#a232d55e29175b7b4f77582f2185b056c">locally</a> conservative discretization = <span class="keyword">true</span></div>
<div class="line"><a class="code" href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a></div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">subsection Stabilization <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a></div>
<div class="line"><span class="preprocessor">  # The exponent in the entropy viscosity stabilization.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 2</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">  # The beta factor in the artificial viscosity stabilization. An appropriate</span></div>
<div class="line"><span class="preprocessor">  # value for 2d is 0.052 and 0.078 for 3d.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = 0.078</div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">  # The c_R factor in the entropy viscosity stabilization.</span></div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a> c_R   = 0.5</div>
<div class="line">end</div>
</div><!-- fragment --></li>
<li>There are, obviously, a good number of changes that have to do with the fact that we want to run our program on a possibly very large number of machines. Although one may suspect that this requires us to completely re-structure our code, that isn't in fact the case (although the classes that implement much of this functionality in deal.II certainly look very different from an implementation viewpoint, but this doesn't reflect in their public interface). Rather, the changes are mostly subtle, and the overall structure of the main class is pretty much unchanged. That said, the devil is in the detail: getting parallel computing right, without deadlocks, ensuring that the right data is available at the right place (see, for example, the discussion on fully distributed vectors vs. vectors with ghost elements), and avoiding bottlenecks is difficult and discussions on this topic will appear in a good number of places in this program.</li>
</ul>
<p><a class="anchor" id="Outlook"></a></p><h3>Outlook </h3>
<p>This is a tutorial program. That means that at least most of its focus needsto lie on demonstrating ways of using deal.II and associated libraries, andnot diluting this teaching lesson by focusing overly much on physicaldetails. Despite the lengthy section above on the choice of physicalparameters, the part of the program devoted to this is actually quite shortand self contained. That said, both <a class="el" href="step_31.html">step-31</a> and the current <a class="el" href="step_32.html">step-32</a> have not come about by chancebut are certainly meant as wayposts along the path to a more comprehensiveprogram that will simulate convection in the earth mantle. We call this code<em>ASPECT</em> (short for <em>Advanced Solver for Problems in Earth's ConvecTion</em>); its development is funded bythe <a href="http://www.geodynamics.org">Computational Infrastructure in Geodynamics</a> initiative with support from the National ScienceFoundation. More information on <em>ASPECT</em> is available atits <a href="https://aspect.geodynamics.org/">homepage</a>.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The first task as usual is to include the functionality of these well-known deal.II library files and some C++ header files.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2work__stream_8h.html">deal.II/base/work_stream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2parameter__handler_8h.html">deal.II/base/parameter_handler.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__bicgstab_8h.html">deal.II/lac/solver_bicgstab.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__solver_8h.html">deal.II/lac/trilinos_solver.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2filtered__iterator_8h.html">deal.II/grid/filtered_iterator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2manifold__lib_8h.html">deal.II/grid/manifold_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgq_8h.html">deal.II/fe/fe_dgq.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__dgp_8h.html">deal.II/fe/fe_dgp.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;locale&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
</div><!-- fragment --><p>This is the only include file that is new: It introduces the <a class="el" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a> equivalent of the <a class="el" href="classSolutionTransfer.html">SolutionTransfer</a> class to take a solution from on mesh to the next one upon mesh refinement, but in the case of parallel distributed triangulations:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2solution__transfer_8h.html">deal.II/distributed/solution_transfer.h</a>&gt;</span></div>
</div><!-- fragment --><p>The following classes are used in parallel distributed computations and have all already been introduced in <a class="el" href="step_40.html">step-40</a> :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2grid__refinement_8h.html">deal.II/distributed/grid_refinement.h</a>&gt;</span></div>
</div><!-- fragment --><p>The next step is like in all previous tutorial programs: We put everything into a namespace of its own and then import the deal.II classes and functions into it:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep32.html">Step32</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Equationdata"></a> </p><h3>Equation data</h3>
<p>In the following namespace, we define the various pieces of equation data that describe the problem. This corresponds to the various aspects of making the problem at least slightly realistic and that were exhaustively discussed in the description of the testcase in the introduction. <br  />
 We start with a few coefficients that have constant values (the comment after the value indicates its physical units):</p>
<div class="fragment"><div class="line">   <span class="keyword">namespace </span>EquationData</div>
<div class="line">   {</div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a>                   = 1e21;     <span class="comment">/* Pa s       */</span> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">kappa</a>                 = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6;     <span class="comment">/* m^2 / s    */</span> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#acbc07b5e8caacadaf9798840a22d1603">reference_density</a>     = 3300;     <span class="comment">/* kg / m^3   */</span> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a7abacfbb83b0ac35324d60dbc2a4ac27">reference_temperature</a> = 293;      <span class="comment">/* K          */</span> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a3c097e8f7581f3b04d6a31eb66b11c8c">expansion_coefficient</a> = 2<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-5;     <span class="comment">/* 1/K        */</span> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">specific_heat</a>         = 1250;     <span class="comment">/* J / K / kg */</span> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">radiogenic_heating</a>    = 7.4e-12;  <span class="comment">/* W / kg     */</span> </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a> = 6371000.</div>
<div class="line">  </div>
<div class="line">- 2890000.;  <span class="comment">/* m          */</span> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a> = 6371000.</div>
<div class="line">  </div>
<div class="line">- 35000.;    <span class="comment">/* m          */</span> </div>
<div class="line">  </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a1057295293dd9dfa723788107acc509e">T0</a> = 4000 + 273;  <span class="comment">/* K          */</span> </div>
<div class="line">     constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a00bf6e26439db0d8e3b91f11ee4fd72a">T1</a> = 700 + 273;   <span class="comment">/* K          */</span> </div>
</div><!-- fragment --><p>The next set of definitions are for functions that encode the density as a function of temperature, the gravity vector, and the initial values for the temperature. Again, all of these (along with the values they compute) are discussed in the introduction:</p>
<div class="fragment"><div class="line">     <span class="keywordtype">double</span> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">density</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>)</div>
<div class="line">     {</div>
<div class="line">       <span class="keywordflow">return</span> (</div>
<div class="line">         <a class="code" href="namespaceStep32_1_1EquationData.html#acbc07b5e8caacadaf9798840a22d1603">reference_density</a></div>
<div class="line">         (1</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="namespaceStep32_1_1EquationData.html#a3c097e8f7581f3b04d6a31eb66b11c8c">expansion_coefficient</a> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a></div>
<div class="line">  </div>
<div class="line">- <a class="code" href="namespaceStep32_1_1EquationData.html#a7abacfbb83b0ac35324d60dbc2a4ac27">reference_temperature</a>)));</div>
<div class="line">     }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="namespaceStep32_1_1EquationData.html#a7c001f60e6c7c0bcd347e3f7b66a5402">gravity_vector</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">     {</div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> r = <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>.norm();</div>
<div class="line">       <span class="keywordflow">return</span></div>
<div class="line">  </div>
<div class="line">-(1.245e-6 r + 7.714e13 / r / r) <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> / r;</div>
<div class="line">     }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     <span class="keyword">class </span>TemperatureInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">     {</div>
<div class="line">     <span class="keyword">public</span>:</div>
<div class="line">       TemperatureInitialValues()</div>
<div class="line">         : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">       {}</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                 <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>) <span class="keyword">const override</span>;</div>
<div class="line">     };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> r = <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>.norm();</div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="auto__derivative__function__0_8txt.html#af5d8dd2d035de856717fb6b5c9438dd5">h</a> = <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a></div>
<div class="line">  </div>
<div class="line">- <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a>;</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> = (r</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">R0</a>) / <a class="code" href="auto__derivative__function__0_8txt.html#af5d8dd2d035de856717fb6b5c9438dd5">h</a>;</div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> q =</div>
<div class="line">         (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3) ? <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(0.0, <a class="code" href="classVectorizedArray.html#adea3423146bcdda2dce143cfb4d10ae8">cos</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> <a class="code" href="classVectorizedArray.html#a2be646da1dcbc52f538c49923fb71c50">abs</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(2) / <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">R1</a>))) : 1.0;</div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> phi = <a class="code" href="namespaceDifferentiation_1_1SD.html#a130b20f2ea3522f1d123c75c63c0f67d">std::atan2</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(0), <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>(1));</div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> tau = <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> + 0.2 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> (1</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>) <a class="code" href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">std::sin</a>(6 phi) q;</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">return</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a1057295293dd9dfa723788107acc509e">T0</a> (1.0</div>
<div class="line">  </div>
<div class="line">- tau) + <a class="code" href="namespaceStep32_1_1EquationData.html#a00bf6e26439db0d8e3b91f11ee4fd72a">T1</a> tau;</div>
<div class="line">     }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     <span class="keywordtype">void</span></div>
<div class="line">     <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">TemperatureInitialValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                                 <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">         <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">TemperatureInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">     }</div>
</div><!-- fragment --><p>As mentioned in the introduction we need to rescale the pressure to avoid the relative ill-conditioning of the momentum and mass conservation equations. The scaling factor is \(\frac{\eta}{L}\) where \(L\) was a typical length scale. By experimenting it turns out that a good length scale is the diameter of plumes, which is around 10 km:</p>
<div class="fragment"><div class="line">constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">pressure_scaling</a> = <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a> / 10000;</div>
</div><!-- fragment --><p>The final number in this namespace is a constant that denotes the number of seconds per (average, tropical) year. We use this only when generating screen output: internally, all computations of this program happen in SI units (kilogram, meter, seconds) but writing geological times in seconds yields numbers that one can't relate to reality, and so we convert to years using the factor defined here:</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">year_in_seconds</a> = 60 60 24 365.2425;</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace EquationData</span></div>
</div><!-- fragment --><p><a class="anchor" id="PreconditioningtheStokessystem"></a> </p><h3>Preconditioning the Stokes system</h3>
<p>This namespace implements the preconditioner. As discussed in the introduction, this preconditioner differs in a number of key portions from the one used in <a class="el" href="step_31.html">step-31</a> . Specifically, it is a right preconditioner, implementing the matrix</p>
<p class="formulaDsp">
\begin{align*} \left(\begin{array}{cc}A^{-1} &amp; B^T \\0 &amp; S^{-1} \end{array}\right) \end{align*}
</p>
<p> where the two inverse matrix operations are approximated by linear solvers or, if the right flag is given to the constructor of this class, by a single AMG V-cycle for the velocity block. The three code blocks of the <code>vmult</code> function implement the multiplications with the three blocks of this preconditioner matrix and should be self explanatory if you have read through <a class="el" href="step_31.html">step-31</a> or the discussion of composing solvers in <a class="el" href="step_20.html">step-20</a> .</p>
<div class="fragment"><div class="line">   <span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">     <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">     {</div>
<div class="line">     <span class="keyword">public</span>:</div>
<div class="line">       BlockSchurPreconditioner(<span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">                                <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;Spre,</div>
<div class="line">                                <span class="keyword">const</span> PreconditionerTypeMp &amp;Mppreconditioner,</div>
<div class="line">                                <span class="keyword">const</span> PreconditionerTypeA &amp; Apreconditioner,</div>
<div class="line">                                <span class="keyword">const</span> <span class="keywordtype">bool</span>                  do_solve_A)</div>
<div class="line">         : stokes_matrix(&amp;S)</div>
<div class="line">         , stokes_preconditioner_matrix(&amp;Spre)</div>
<div class="line">         , mp_preconditioner(Mppreconditioner)</div>
<div class="line">         , a_preconditioner(Apreconditioner)</div>
<div class="line">         , do_solve_A(do_solve_A)</div>
<div class="line">       {}</div>
<div class="line">  </div>
<div class="line">       <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                  <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">       </span>{</div>
<div class="line">         <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> utmp(src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">  </div>
<div class="line">         {</div>
<div class="line">           <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(5000, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1).l2_norm());</div>
<div class="line">  </div>
<div class="line">           <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line">  </div>
<div class="line">           <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_preconditioner_matrix-&gt;block(1, 1),</div>
<div class="line">                        <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1),</div>
<div class="line">                        src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1),</div>
<div class="line">                        mp_preconditioner);</div>
<div class="line">  </div>
<div class="line">           <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1)=</div>
<div class="line">  </div>
<div class="line">-1.0;</div>
<div class="line">         }</div>
<div class="line">  </div>
<div class="line">         {</div>
<div class="line">           stokes_matrix-&gt;block(0, 1).<a class="code" href="classSparseVanka.html#a34195e21adf1756d5d316cfc1091d843">vmult</a>(utmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1));</div>
<div class="line">           utmp=</div>
<div class="line">  </div>
<div class="line">-1.0;</div>
<div class="line">           utmp.add(src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">         }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">if</span> (do_solve_A == <span class="keyword">true</span>)</div>
<div class="line">           {</div>
<div class="line">             <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(5000, utmp.l2_norm() 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-2);</div>
<div class="line">             <a class="code" href="classTrilinosWrappers_1_1SolverCG.html">TrilinosWrappers::SolverCG</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line">             <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix-&gt;block(0, 0),</div>
<div class="line">                          <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0),</div>
<div class="line">                          utmp,</div>
<div class="line">                          a_preconditioner);</div>
<div class="line">           }</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">           a_preconditioner.vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), utmp);</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">private</span>:</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">         stokes_matrix;</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">                                   stokes_preconditioner_matrix;</div>
<div class="line">       <span class="keyword">const</span> PreconditionerTypeMp &amp;mp_preconditioner;</div>
<div class="line">       <span class="keyword">const</span> PreconditionerTypeA &amp; a_preconditioner;</div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">bool</span>                  do_solve_A;</div>
<div class="line">     };</div>
<div class="line">   } <span class="comment">// namespace LinearSolvers</span></div>
</div><!-- fragment --><p><a class="anchor" id="Definitionofassemblydatastructures"></a> </p><h3>Definition of assembly data structures</h3>
<p><br  />
 As described in the introduction, we will use the <a class="el" href="namespaceWorkStream.html">WorkStream</a> mechanism discussed in the <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing</a> module to parallelize operations among the processors of a single machine. The <a class="el" href="namespaceWorkStream.html">WorkStream</a> class requires that data is passed around in two kinds of data structures, one for scratch data and one to pass data from the assembly function to the function that copies local contributions into global objects. <br  />
 The following namespace (and the two sub-namespaces) contains a collection of data structures that serve this purpose, one pair for each of the four operations discussed in the introduction that we will want to parallelize. Each assembly routine gets two sets of data: a Scratch array that collects all the classes and arrays that are used for the calculation of the cell contribution, and a <a class="el" href="structCopyData.html">CopyData</a> array that keeps local matrices and vectors which will be written into the global matrix. Whereas <a class="el" href="structCopyData.html">CopyData</a> is a container for the final data that is written into the global matrices and vector (and, thus, absolutely necessary), the Scratch arrays are merely there for performance reasons &mdash; it would be much more expensive to set up a <a class="el" href="classFEValues.html">FEValues</a> object on each cell, than creating it only once and updating some derivative data. <br  />
 <a class="el" href="step_31.html">step-31</a> had four assembly routines: One for the preconditioner matrix of the Stokes system, one for the Stokes matrix and right hand side, one for the temperature matrices and one for the right hand side of the temperature equation. We here organize the scratch arrays and <a class="el" href="structCopyData.html">CopyData</a> objects for each of those four assembly components using a <code>struct</code> environment (since we consider these as temporary objects we pass around, rather than classes that implement functionality of their own, though this is a more subjective point of view to distinguish between <code>struct</code>s and <code>class</code> es). <br  />
 Regarding the Scratch objects, each struct is equipped with a constructor that creates an <a class="el" href="classFEValues.html">FEValues</a> object using the <a class="el" href="classFiniteElement.html">FiniteElement</a> , <a class="el" href="classQuadrature.html">Quadrature</a>, <a class="el" href="classMapping.html">Mapping</a> (which describes the interpolation of curved boundaries), and <a class="el" href="group__UpdateFlags.html">The interplay of UpdateFlags, Mapping, and</a> instances. Moreover, we manually implement a copy constructor (since the <a class="el" href="classFEValues.html">FEValues</a> class is not copyable by itself), and provide some additional vector fields that are used to hold intermediate data during the computation of local contributions. <br  />
 Let us start with the scratch arrays and, specifically, the one used for assembly of the Stokes preconditioner:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>Assembly</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">namespace </span>Scratch</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>StokesPreconditioner</div>
<div class="line">    {</div>
<div class="line">      StokesPreconditioner(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">                           <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">                           <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                           <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         update_flags);</div>
<div class="line"> </div>
<div class="line">      StokesPreconditioner(<span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> stokes_fe_values;</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;Tensor&lt;2, dim&gt;&gt; grad_phi_u;</div>
<div class="line">      std::vector&lt;double&gt;         phi_p;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         update_flags)</div>
<div class="line">      : stokes_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, stokes_fe, stokes_quadrature, update_flags)</div>
<div class="line">      , grad_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , phi_p(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> StokesPreconditioner &amp;scratch)</div>
<div class="line">      : stokes_fe_values(scratch.stokes_fe_values.get_mapping(),</div>
<div class="line">                         scratch.stokes_fe_values.get_fe(),</div>
<div class="line">                         scratch.stokes_fe_values.get_quadrature(),</div>
<div class="line">                         scratch.stokes_fe_values.get_update_flags())</div>
<div class="line">      , grad_phi_u(scratch.grad_phi_u)</div>
<div class="line">      , phi_p(scratch.phi_p)</div>
<div class="line">    {}</div>
</div><!-- fragment --><p>The next one is the scratch object used for the assembly of the full Stokes system. Observe that we derive the StokesSystem scratch class from the StokesPreconditioner class above. We do this because all the objects that are necessary for the assembly of the preconditioner are also needed for the actual matrix system and right hand side, plus some extra data. This makes the program more compact. Note also that the assembly of the Stokes system and the temperature right hand side further down requires data from temperature and velocity, respectively, so we actually need two <a class="el" href="classFEValues.html">FEValues</a> objects for those two cases.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">struct </span>StokesSystem : <span class="keyword">public</span> StokesPreconditioner&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line">  StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         stokes_update_flags,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         temperature_update_flags);</div>
<div class="line"> </div>
<div class="line">  StokesSystem(<span class="keyword">const</span> StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt;          phi_u;</div>
<div class="line">  std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; grads_phi_u;</div>
<div class="line">  std::vector&lt;double&gt;                  div_phi_u;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; old_temperature_values;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">StokesSystem&lt;dim&gt;::StokesSystem(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   stokes_quadrature,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         stokes_update_flags,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>         temperature_update_flags)</div>
<div class="line">  : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_fe,</div>
<div class="line">                              stokes_quadrature,</div>
<div class="line">                              <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                              stokes_update_flags)</div>
<div class="line">  , temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          temperature_fe,</div>
<div class="line">                          stokes_quadrature,</div>
<div class="line">                          temperature_update_flags)</div>
<div class="line">  , phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">  , grads_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">  , div_phi_u(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">  , old_temperature_values(stokes_quadrature.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">StokesSystem&lt;dim&gt;::StokesSystem(<span class="keyword">const</span> StokesSystem&lt;dim&gt; &amp;scratch)</div>
<div class="line">  : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(scratch)</div>
<div class="line">  , temperature_fe_values(</div>
<div class="line">      scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">      scratch.temperature_fe_values.get_fe(),</div>
<div class="line">      scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">      scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">  , phi_u(scratch.phi_u)</div>
<div class="line">  , grads_phi_u(scratch.grads_phi_u)</div>
<div class="line">  , div_phi_u(scratch.div_phi_u)</div>
<div class="line">  , old_temperature_values(scratch.old_temperature_values)</div>
<div class="line">{}</div>
</div><!-- fragment --><p>After defining the objects used in the assembly of the Stokes system, we do the same for the assembly of the matrices necessary for the temperature system. The general structure is very similar:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">struct </span>TemperatureMatrix</div>
<div class="line">{</div>
<div class="line">  TemperatureMatrix(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   temperature_quadrature);</div>
<div class="line"> </div>
<div class="line">  TemperatureMatrix(<span class="keyword">const</span> TemperatureMatrix &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt;         phi_T;</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   temperature_quadrature)</div>
<div class="line">  : temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          temperature_fe,</div>
<div class="line">                          temperature_quadrature,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>)</div>
<div class="line">  , phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">  , grad_phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">  <span class="keyword">const</span> TemperatureMatrix &amp;scratch)</div>
<div class="line">  : temperature_fe_values(</div>
<div class="line">      scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">      scratch.temperature_fe_values.get_fe(),</div>
<div class="line">      scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">      scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">  , phi_T(scratch.phi_T)</div>
<div class="line">  , grad_phi_T(scratch.grad_phi_T)</div>
<div class="line">{}</div>
</div><!-- fragment --><p>The final scratch object is used in the assembly of the right hand side of the temperature system. This object is significantly larger than the ones above because a lot more quantities enter the computation of the right hand side of the temperature equation. In particular, the temperature values and gradients of the previous two time steps need to be evaluated at the quadrature points, as well as the velocities and the strain rates (i.e. the symmetric gradients of the velocity) that enter the right hand side as friction heating terms. Despite the number of terms, the following should be rather self explanatory:</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">struct </span>TemperatureRHS</div>
<div class="line">  {</div>
<div class="line">    TemperatureRHS(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">                   <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">                   <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                   <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>);</div>
<div class="line"> </div>
<div class="line">    TemperatureRHS(<span class="keyword">const</span> TemperatureRHS &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> temperature_fe_values;</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> stokes_fe_values;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         phi_T;</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_T;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_velocity_values;</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_velocity_values;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_strain_rates;</div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; old_old_strain_rates;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         old_temperature_values;</div>
<div class="line">    std::vector&lt;double&gt;         old_old_temperature_values;</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_temperature_grads;</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_temperature_grads;</div>
<div class="line">    std::vector&lt;double&gt;         old_temperature_laplacians;</div>
<div class="line">    std::vector&lt;double&gt;         old_old_temperature_laplacians;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  TemperatureRHS&lt;dim&gt;::TemperatureRHS(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classMapping.html">Mapping&lt;dim&gt;</a> &amp;      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQuadrature.html">Quadrature&lt;dim&gt;</a> &amp;   <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>)</div>
<div class="line">    : temperature_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                            temperature_fe,</div>
<div class="line">                            <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>)</div>
<div class="line">    , stokes_fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                       stokes_fe,</div>
<div class="line">                       <a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>,</div>
<div class="line">                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>)</div>
<div class="line">    , phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    , grad_phi_T(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    old_velocity_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_velocity_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_strain_rates(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_strain_rates(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    old_temperature_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_temperature_values(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_temperature_grads(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_temperature_grads(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_temperature_laplacians(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">    , old_old_temperature_laplacians(<a class="code" href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a>.<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>())</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  TemperatureRHS&lt;dim&gt;::TemperatureRHS(<span class="keyword">const</span> TemperatureRHS &amp;scratch)</div>
<div class="line">    : temperature_fe_values(</div>
<div class="line">        scratch.temperature_fe_values.get_mapping(),</div>
<div class="line">        scratch.temperature_fe_values.get_fe(),</div>
<div class="line">        scratch.temperature_fe_values.get_quadrature(),</div>
<div class="line">        scratch.temperature_fe_values.get_update_flags())</div>
<div class="line">    , stokes_fe_values(scratch.stokes_fe_values.get_mapping(),</div>
<div class="line">                       scratch.stokes_fe_values.get_fe(),</div>
<div class="line">                       scratch.stokes_fe_values.get_quadrature(),</div>
<div class="line">                       scratch.stokes_fe_values.get_update_flags())</div>
<div class="line">    , phi_T(scratch.phi_T)</div>
<div class="line">    , grad_phi_T(scratch.grad_phi_T)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    old_velocity_values(scratch.old_velocity_values)</div>
<div class="line">    , old_old_velocity_values(scratch.old_old_velocity_values)</div>
<div class="line">    , old_strain_rates(scratch.old_strain_rates)</div>
<div class="line">    , old_old_strain_rates(scratch.old_old_strain_rates)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    old_temperature_values(scratch.old_temperature_values)</div>
<div class="line">    , old_old_temperature_values(scratch.old_old_temperature_values)</div>
<div class="line">    , old_temperature_grads(scratch.old_temperature_grads)</div>
<div class="line">    , old_old_temperature_grads(scratch.old_old_temperature_grads)</div>
<div class="line">    , old_temperature_laplacians(scratch.old_temperature_laplacians)</div>
<div class="line">    , old_old_temperature_laplacians(scratch.old_old_temperature_laplacians)</div>
<div class="line">  {}</div>
<div class="line">} <span class="comment">// namespace Scratch</span></div>
</div><!-- fragment --><p>The <a class="el" href="structCopyData.html">CopyData</a> objects are even simpler than the Scratch objects as all they have to do is to store the results of local computations until they can be copied into the global matrix or vector objects. These structures therefore only need to provide a constructor, a copy operation, and some arrays for local matrix, local vectors and the relation between local and global degrees of freedom (a.k.a. <code>local_dof_indices</code> ). Again, we have one such structure for each of the four operations we will parallelize using the <a class="el" href="namespaceWorkStream.html">WorkStream</a> class:</p>
<div class="fragment"><div class="line">  <span class="keyword">namespace </span><a class="code" href="structCopyData.html">CopyData</a></div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>StokesPreconditioner</div>
<div class="line">    {</div>
<div class="line">      StokesPreconditioner(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe);</div>
<div class="line">      StokesPreconditioner(<span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">      StokesPreconditioner &amp;<a class="code" href="chunk__sparse__matrix__0_8txt.html#aa747ba884f098177e9bf2b2422a461a9">operator=</a>(<span class="keyword">const</span> StokesPreconditioner &amp;) = <span class="keywordflow">default</span>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_matrix;</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe)</div>
<div class="line">      : local_matrix(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(), stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesPreconditioner&lt;dim&gt;::StokesPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> StokesPreconditioner &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">      : local_matrix(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix)</div>
<div class="line">      , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>StokesSystem : <span class="keyword">public</span> StokesPreconditioner&lt;dim&gt;</div>
<div class="line">    {</div>
<div class="line">      StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    StokesSystem&lt;dim&gt;::StokesSystem(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;stokes_fe)</div>
<div class="line">      : StokesPreconditioner&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(stokes_fe)</div>
<div class="line">      , local_rhs(stokes_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>TemperatureMatrix</div>
<div class="line">    {</div>
<div class="line">      TemperatureMatrix(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_mass_matrix;</div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   local_stiffness_matrix;</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    TemperatureMatrix&lt;dim&gt;::TemperatureMatrix(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe)</div>
<div class="line">      : local_mass_matrix(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                          temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , local_stiffness_matrix(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                               temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">struct </span>TemperatureRHS</div>
<div class="line">    {</div>
<div class="line">      TemperatureRHS(<span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classVector.html">Vector&lt;double&gt;</a>                       local_rhs;</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>;</div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a>                   matrix_for_bc;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    TemperatureRHS&lt;dim&gt;::TemperatureRHS(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;temperature_fe)</div>
<div class="line">      : local_rhs(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">      , matrix_for_bc(temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>(),</div>
<div class="line">                      temperature_fe.<a class="code" href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a>())</div>
<div class="line">    {}</div>
<div class="line">  } <span class="comment">// namespace CopyData</span></div>
<div class="line">}   <span class="comment">// namespace Assembly</span></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeBoussinesqFlowProblemcodeclasstemplate"></a> </p><h3>The <code>BoussinesqFlowProblem</code> class template</h3>
<p><br  />
 This is the declaration of the main class. It is very similar to <a class="el" href="step_31.html">step-31</a> but there are a number differences we will comment on below. <br  />
 The top of the class is essentially the same as in <a class="el" href="step_31.html">step-31</a> , listing the public methods and a set of private functions that do the heavy lifting. Compared to <a class="el" href="step_31.html">step-31</a> there are only two additions to this section: the function <code>get_cfl_number()</code> that computes the maximum CFL number over all cells which we then compute the global time step from, and the function <code>get_entropy_variation()</code> that is used in the computation of the entropy stabilization. It is akin to the <code>get_extrapolated_temperature_range()</code> we have used in <a class="el" href="step_31.html">step-31</a> for this purpose, but works on the entropy instead of the temperature instead.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>BoussinesqFlowProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">struct </span>Parameters;</div>
<div class="line">  BoussinesqFlowProblem(Parameters &amp;<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span>   setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_stokes_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span>   build_stokes_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_stokes_system();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_temperature_matrix();</div>
<div class="line">  <span class="keywordtype">void</span>   assemble_temperature_system(<span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity);</div>
<div class="line">  <span class="keywordtype">double</span> get_maximal_velocity() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_cfl_number() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_entropy_variation(<span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature) <span class="keyword">const</span>;</div>
<div class="line">  std::pair&lt;double, double&gt; get_extrapolated_temperature_range() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span>                      <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span>                      output_results();</div>
<div class="line">  <span class="keywordtype">void</span>                      refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_temperature_grads,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_temperature_laplacians,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_velocity_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_strain_rates,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_old_strain_rates,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_u_infty,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_T_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                average_temperature,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_entropy_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
</div><!-- fragment --><p>The first significant new component is the definition of a struct for the parameters according to the discussion in the introduction. This structure is initialized by reading from a parameter file during construction of this object.</p>
<div class="fragment"><div class="line">  <span class="keyword">struct </span>Parameters</div>
<div class="line">  {</div>
<div class="line">    Parameters(<span class="keyword">const</span> std::string &amp;parameter_filename);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">declare_parameters</a>(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line">    <span class="keywordtype">void</span>        parse_parameters(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> end_time;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_global_refinement;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_adaptive_refinement;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span>         generate_graphical_output;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> graphical_output_interval;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> adaptive_refinement_interval;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> stabilization_alpha;</div>
<div class="line">    <span class="keywordtype">double</span> stabilization_c_R;</div>
<div class="line">    <span class="keywordtype">double</span> stabilization_beta;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_velocity_degree;</div>
<div class="line">    <span class="keywordtype">bool</span>         use_locally_conservative_discretization;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> temperature_degree;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  Parameters &amp;<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>;</div>
</div><!-- fragment --><p>The <code>pcout</code> (for <em>parallel <code>std::cout</code></em>) object is used to simplify writing output: each MPI process can use this to generate output as usual, but since each of these processes will (hopefully) produce the same output it will just be replicated many times over; with the <a class="el" href="classConditionalOStream.html">ConditionalOStream</a> class, only the output generated by one MPI process will actually be printed to screen, whereas the output by all the other threads will simply be forgotten.</p>
<div class="fragment"><div class="line"><a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div>
</div><!-- fragment --><p>The following member variables will then again be similar to those in <a class="el" href="step_31.html">step-31</a> (and to other tutorial programs). As mentioned in the introduction, we fully distribute computations, so we will have to use the <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a> class (see <a class="el" href="step_40.html">step-40</a> ) but the remainder of these variables is rather standard with two exceptions:</p>
<ul>
<li>The <code>mapping</code> variable is used to denote a higher-order polynomial mapping. As mentioned in the introduction, we use this mapping when forming integrals through quadrature for all cells that are adjacent to either the inner or outer boundaries of our domain where the boundary is curved.</li>
<li>In a bit of naming confusion, you will notice below that some of the variables from namespace <a class="el" href="namespaceTrilinosWrappers.html">TrilinosWrappers</a> are taken from namespace <a class="el" href="namespaceTrilinosWrappers_1_1MPI.html">TrilinosWrappers::MPI</a> (such as the right hand side vectors) whereas others are not (such as the various matrices). This is due to legacy reasons. We will frequently have to query velocities and temperatures at arbitrary quadrature points; consequently, rather than importing ghost information of a vector whenever we need access to degrees of freedom that are relevant locally but owned by another processor, we solve linear systems in parallel but then immediately initialize a vector including ghost entries of the solution for further processing. The various <code>*_solution</code> vectors are therefore filled immediately after solving their respective linear system in parallel and will always contain values for all <a class="el" href="DEALGlossary.html#GlossLocallyRelevantDof">locally relevant degrees of freedom</a>; the fully distributed vectors that we obtain from the solution process and that only ever contain the <a class="el" href="DEALGlossary.html#GlossLocallyOwnedDof">locally owned degrees of freedom</a> are destroyed immediately after the solution process and after we have copied the relevant values into the member variable vectors.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line"><span class="keywordtype">double</span>                                    global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classMappingQ.html">MappingQ&lt;dim&gt;</a> <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>       stokes_fe;</div>
<div class="line"><a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           stokes_dof_handler;</div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> stokes_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_matrix;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> stokes_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_stokes_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> stokes_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 temperature_fe;</div>
<div class="line"><a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           temperature_dof_handler;</div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> temperature_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_mass_matrix;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_stiffness_matrix;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> temperature_matrix;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_temperature_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_temperature_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> temperature_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span>       time_step;</div>
<div class="line"><span class="keywordtype">double</span>       old_time_step;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionAMG&gt;    Amg_preconditioner;</div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionJacobi&gt; Mp_preconditioner;</div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionJacobi&gt; T_preconditioner;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> rebuild_stokes_matrix;</div>
<div class="line"><span class="keywordtype">bool</span> rebuild_stokes_preconditioner;</div>
<div class="line"><span class="keywordtype">bool</span> rebuild_temperature_matrices;</div>
<div class="line"><span class="keywordtype">bool</span> rebuild_temperature_preconditioner;</div>
</div><!-- fragment --><p>The next member variable, <code>computing_timer</code> is used to conveniently account for compute time spent in certain "sections" of the code that are repeatedly entered. For example, we will enter (and leave) sections for Stokes matrix assembly and would like to accumulate the run time spent in this section over all time steps. Every so many time steps as well as at the end of the program (through the destructor of the <a class="el" href="classTimerOutput.html">TimerOutput</a> class) we will then produce a nice summary of the times spent in the different sections into which we categorize the run-time of this program.</p>
<div class="fragment"><div class="line"><a class="code" href="classTimerOutput.html">TimerOutput</a> computing_timer;</div>
</div><!-- fragment --><p>After these member variables we have a number of auxiliary functions that have been broken out of the ones listed above. Specifically, there are first three functions that we call from <code>setup_dofs</code> and then the ones that do the assembling of linear systems:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> setup_stokes_matrix(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning);</div>
<div class="line"><span class="keywordtype">void</span> setup_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning);</div>
<div class="line"><span class="keywordtype">void</span> setup_temperature_matrices(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_partitioning,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_relevant_partitioning);</div>
</div><!-- fragment --><p>Following the <a class="el" href="group__threads.html#MTWorkStream">task-based parallelization</a> paradigm, we split all the assembly routines into two parts: a first part that can do all the calculations on a certain cell without taking care of other threads, and a second part (which is writing the local data into the global matrices and vectors) which can be entered by only one thread at a time. In order to implement that, we provide functions for each of those two steps for all the four assembly routines that we use in this program. The following eight functions do exactly this:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> local_assemble_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">  Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> copy_local_to_global_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> local_assemble_stokes_system(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">  Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> copy_local_to_global_stokes_system(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> local_assemble_temperature_matrix(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">  Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> copy_local_to_global_temperature_matrix(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> local_assemble_temperature_rhs(</div>
<div class="line">  <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_velocity,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_entropy_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">  Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> copy_local_to_global_temperature_rhs(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
</div><!-- fragment --><p>Finally, we forward declare a member class that we will define later on and that will be used to compute a number of quantities from our solution vectors that we'd like to put into the output files for visualization.</p>
<div class="fragment"><div class="line">  <span class="keyword">class </span>Postprocessor;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemclassimplementation"></a> </p><h3>BoussinesqFlowProblem class implementation</h3>
<pre class="fragment">&lt;a name="BoussinesqFlowProblemParameters"&gt;&lt;/a&gt;  &lt;h4&gt;BoussinesqFlowProblem::Parameters&lt;/h4&gt;   
Here comes the definition of the parameters for the Stokes problem. We allow to set the end time for the simulation, the level of refinements (both global and adaptive, which in the sum specify what maximum level the cells are allowed to have), and the interval between refinements in the time stepping.   
Then, we let the user specify constants for the stabilization parameters (as discussed in the introduction), the polynomial degree for the Stokes velocity space, whether to use the locally conservative discretization based on FE_DGP elements for the pressure or not (FE_Q elements for pressure), and the polynomial degree for the temperature interpolation.   
The constructor checks for a valid input file (if not, a file with default parameters for the quantities is written), and eventually parses the parameters.
</pre><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::Parameters::Parameters(</div>
<div class="line">  <span class="keyword">const</span> std::string &amp;parameter_filename)</div>
<div class="line">  : end_time(1e8)</div>
<div class="line">  , initial_global_refinement(2)</div>
<div class="line">  , initial_adaptive_refinement(2)</div>
<div class="line">  , adaptive_refinement_interval(10)</div>
<div class="line">  , stabilization_alpha(2)</div>
<div class="line">  , stabilization_c_R(0.11)</div>
<div class="line">  , stabilization_beta(0.078)</div>
<div class="line">  , stokes_velocity_degree(2)</div>
<div class="line">  , use_locally_conservative_discretization(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  , temperature_degree(2)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> prm;</div>
<div class="line">  <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">BoussinesqFlowProblem&lt;dim&gt;::Parameters::declare_parameters</a>(prm);</div>
<div class="line"> </div>
<div class="line">  std::ifstream parameter_file(parameter_filename);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (!parameter_file)</div>
<div class="line">    {</div>
<div class="line">      parameter_file.close();</div>
<div class="line"> </div>
<div class="line">      std::ofstream parameter_out(parameter_filename);</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a4ac3a8b19ade16e96e8ea25906daf23a">print_parameters</a>(parameter_out, <a class="code" href="group__Exceptions.html#ga8364dda711b93753c6809eefe2a8e827a3a1480568c2713f53dcb21319bb28093">ParameterHandler::Text</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(</div>
<div class="line">        <span class="keyword">false</span>,</div>
<div class="line">        <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">          <span class="stringliteral">&quot;Input parameter file &lt;&quot;</span> + parameter_filename +</div>
<div class="line">          <span class="stringliteral">&quot;&gt; not found. Creating a template file of the same name.&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">parse_input</a>(parameter_file);</div>
<div class="line">  parse_parameters(prm);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Next we have a function that declares the parameters that we expect in the input file, together with their data types, default values and a description:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">BoussinesqFlowProblem&lt;dim&gt;::Parameters::declare_parameters</a>(</div>
<div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">{</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;End time&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;1e8&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                    <span class="stringliteral">&quot;The end time of the simulation in years.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Initial global refinement&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of global refinement steps performed on &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;the initial coarse mesh, before the problem is first &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;solved there.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Initial adaptive refinement&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(0),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of adaptive refinement steps performed after &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;initial global refinement.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Time steps between mesh refinement&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;10&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of time steps after which the mesh is to be &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;adapted based on computed error indicators.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Generate graphical output&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;false&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(),</div>
<div class="line">                    <span class="stringliteral">&quot;Whether graphical output is to be generated or not. &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;You may not want to get graphical output if the number &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;of processors is large.&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Time steps between graphical output&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;50&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of time steps between each generation of &quot;</span></div>
<div class="line">                    <span class="stringliteral">&quot;graphical output files.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Stabilization parameters&quot;</span>);</div>
<div class="line">  {</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;alpha&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(1, 2),</div>
<div class="line">                      <span class="stringliteral">&quot;The exponent in the entropy viscosity stabilization.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;c_R&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;0.11&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                      <span class="stringliteral">&quot;The c_R factor in the entropy viscosity &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;stabilization.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;beta&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;0.078&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(0),</div>
<div class="line">                      <span class="stringliteral">&quot;The beta factor in the artificial viscosity &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;stabilization. An appropriate value for 2d is 0.052 &quot;</span></div>
<div class="line">                      <span class="stringliteral">&quot;and 0.078 for 3d.&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Discretization&quot;</span>);</div>
<div class="line">  {</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">      <span class="stringliteral">&quot;Stokes velocity polynomial degree&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">      <span class="stringliteral">&quot;The polynomial degree to use for the velocity variables &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;in the Stokes system.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">      <span class="stringliteral">&quot;Temperature polynomial degree&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(1),</div>
<div class="line">      <span class="stringliteral">&quot;The polynomial degree to use for the temperature variable.&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">      <span class="stringliteral">&quot;Use locally conservative discretization&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;true&quot;</span>,</div>
<div class="line">      <a class="code" href="classPatterns_1_1Bool.html">Patterns::Bool</a>(),</div>
<div class="line">      <span class="stringliteral">&quot;Whether to use a Stokes discretization that is locally &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;conservative at the expense of a larger number of degrees &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;of freedom, or to go with a cheaper discretization &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;that does not locally conserve mass (although it is &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;globally conservative.&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p>And then we need a function that reads the contents of the <a class="el" href="classParameterHandler.html">ParameterHandler</a> object we get by reading the input file and puts the results into variables that store the values of the parameters we have previously declared:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::Parameters::parse_parameters(</div>
<div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">{</div>
<div class="line">  end_time                  = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;End time&quot;</span>);</div>
<div class="line">  initial_global_refinement = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Initial global refinement&quot;</span>);</div>
<div class="line">  initial_adaptive_refinement =</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Initial adaptive refinement&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  adaptive_refinement_interval =</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Time steps between mesh refinement&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  generate_graphical_output = prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;Generate graphical output&quot;</span>);</div>
<div class="line">  graphical_output_interval =</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Time steps between graphical output&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Stabilization parameters&quot;</span>);</div>
<div class="line">  {</div>
<div class="line">    stabilization_alpha = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;alpha&quot;</span>);</div>
<div class="line">    stabilization_c_R   = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;c_R&quot;</span>);</div>
<div class="line">    stabilization_beta  = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;beta&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line"> </div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">enter_subsection</a>(<span class="stringliteral">&quot;Discretization&quot;</span>);</div>
<div class="line">  {</div>
<div class="line">    stokes_velocity_degree =</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Stokes velocity polynomial degree&quot;</span>);</div>
<div class="line">    temperature_degree = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Temperature polynomial degree&quot;</span>);</div>
<div class="line">    use_locally_conservative_discretization =</div>
<div class="line">      prm.<a class="code" href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">get_bool</a>(<span class="stringliteral">&quot;Use locally conservative discretization&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">leave_subsection</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemBoussinesqFlowProblem"></a> </p><h4>BoussinesqFlowProblem::BoussinesqFlowProblem</h4>
<p><br  />
 The constructor of the problem is very similar to the constructor in <a class="el" href="step_31.html">step-31</a> . What is different is the parallel communication: Trilinos uses a message passing interface (MPI) for data distribution. When entering the BoussinesqFlowProblem class, we have to decide how the parallelization is to be done. We choose a rather simple strategy and let all processors that are running the program work together, specified by the communicator <code>MPI_COMM_WORLD</code> . Next, we create the output stream (as we already did in <a class="el" href="step_18.html">step-18</a> ) that only generates output on the first MPI process and is completely forgetful on all others. The implementation of this idea is to check the process number when <code>pcout</code> gets a true argument, and it uses the <code>std::cout</code> stream for output. If we are one processor five, for instance, then we will give a <code>false</code> argument to <code>pcout</code> , which means that the output of that processor will not be printed. With the exception of the mapping object (for which we use polynomials of degree 4) all but the final member variable are exactly the same as in <a class="el" href="step_31.html">step-31</a> . <br  />
 This final object, the <a class="el" href="classTimerOutput.html">TimerOutput</a> object, is then told to restrict output to the <code>pcout</code> stream (processor 0), and then we specify that we want to get a summary table at the end of the program which shows us wallclock times (as opposed to CPU times). We will manually also request intermediate summaries every so many time steps in the <code><a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a></code> function below.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   BoussinesqFlowProblem&lt;dim&gt;::BoussinesqFlowProblem(Parameters &amp;parameters_)</div>
<div class="line">     : <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>(parameters_)</div>
<div class="line">     , pcout(std::cout, (<a class="code" href="namespaceUtilities.html">Utilities</a>::<a class="code" href="base_2partitioner__0_8txt.html#a6d2d0fa485d1660823c59c494fb0fb31">MPI</a>::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(MPI_COMM_WORLD) == 0))</div>
<div class="line">     ,</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(MPI_COMM_WORLD,</div>
<div class="line">                   typename <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::MeshSmoothing(</div>
<div class="line">                     <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::smoothing_on_refinement |</div>
<div class="line">                     <a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::smoothing_on_coarsening))</div>
<div class="line">     ,</div>
<div class="line">  </div>
<div class="line">     global_Omega_diameter(0.)</div>
<div class="line">     ,</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(4)</div>
<div class="line">     ,</div>
<div class="line">  </div>
<div class="line">     stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree),</div>
<div class="line">               <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">               (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.use_locally_conservative_discretization ?</div>
<div class="line">                  static_cast&lt;<a class="code" href="coding__conventions__0_8txt.html#ad54c4de985d6d1b46aaf6ae96ae8d3a1">const</a> <a class="code" href="classFiniteElement.html">FiniteElement</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt; &amp;&gt;(</div>
<div class="line">                    <a class="code" href="classFE__DGP.html">FE_DGP</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree</div>
<div class="line">  </div>
<div class="line">- 1)) :</div>
<div class="line">                  static_cast&lt;<a class="code" href="coding__conventions__0_8txt.html#ad54c4de985d6d1b46aaf6ae96ae8d3a1">const</a> <a class="code" href="classFiniteElement.html">FiniteElement</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt; &amp;&gt;(</div>
<div class="line">                    <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree</div>
<div class="line">  </div>
<div class="line">- 1))),</div>
<div class="line">               1)</div>
<div class="line">     ,</div>
<div class="line">  </div>
<div class="line">     stokes_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">     ,</div>
<div class="line">  </div>
<div class="line">     temperature_fe(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree)</div>
<div class="line">     , temperature_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">     ,</div>
<div class="line">  </div>
<div class="line">     time_step(0)</div>
<div class="line">     , old_time_step(0)</div>
<div class="line">     , timestep_number(0)</div>
<div class="line">     , rebuild_stokes_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">     , rebuild_stokes_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">     , rebuild_temperature_matrices(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">     , rebuild_temperature_preconditioner(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">     ,</div>
<div class="line">  </div>
<div class="line">     computing_timer(MPI_COMM_WORLD,</div>
<div class="line">                     pcout,</div>
<div class="line">                     <a class="code" href="classTimerOutput.html">TimerOutput</a>::summary,</div>
<div class="line">                     <a class="code" href="classTimerOutput.html">TimerOutput</a>::wall_times)</div>
<div class="line">   {}</div>
</div><!-- fragment --><p><a class="anchor" id="TheBoussinesqFlowProblemhelperfunctions"></a> </p><h4>The BoussinesqFlowProblem helper functions</h4>
<p><a class="anchor" id="BoussinesqFlowProblemget_maximal_velocity"></a> </p><h5>BoussinesqFlowProblem::get_maximal_velocity</h5>
<p>Except for two small details, the function to compute the global maximum of the velocity is the same as in <a class="el" href="step_31.html">step-31</a> . The first detail is actually common to all functions that implement loops over all cells in the triangulation: When operating in parallel, each processor can only work on a chunk of cells since each processor only has a certain part of the entire triangulation. This chunk of cells that we want to work on is identified via a so-called <code>subdomain_id</code> , as we also did in <a class="el" href="step_18.html">step-18</a> . All we need to change is hence to perform the cell-related operations only on cells that are owned by the current process (as opposed to ghost or artificial cells), i.e. for which the subdomain id equals the number of the process ID. Since this is a commonly used operation, there is a shortcut for this operation: we can ask whether the cell is owned by the current processor using <code>cell-&gt;<a class="el" href="quadrature__point__data__0_8txt.html#a175634c053aca0ba3b25782a53938ea5">is_locally_owned()</a></code> . <br  />
 The second difference is the way we calculate the maximum value. Before, we could simply have a <code>double</code> variable that we checked against on each quadrature point for each cell. Now, we have to be a bit more careful since each processor only operates on a subset of cells. What we do is to first let each processor calculate the maximum among its cells, and then do a global communication operation <code><a class="el" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a></code> that computes the maximum value among all the maximum values of the individual processors. MPI provides such a call, but it's even simpler to use the respective function in namespace <a class="el" href="namespaceUtilities_1_1MPI.html">Utilities::MPI</a> using the MPI communicator object since that will do the right thing even if we work without MPI and on a single machine only. The call to <code><a class="el" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a></code> needs two arguments, namely the local maximum (input) and the MPI communicator, which is MPI_COMM_WORLD in this example.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_maximal_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                          <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          stokes_fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_local_velocity = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                  velocity_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          max_local_velocity =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(max_local_velocity, MPI_COMM_WORLD);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_cfl_number"></a> </p><h5>BoussinesqFlowProblem::get_cfl_number</h5>
<p>The next function does something similar, but we now compute the CFL number, i.e., maximal velocity on a cell divided by the cell diameter. This number is necessary to determine the time step size, as we use a semi-explicit time stepping scheme for the temperature equation (see <a class="el" href="step_31.html">step-31</a> for a discussion). We compute it in the same way as above: Compute the local maximum over all locally owned cells, then exchange it via MPI to find the global maximum.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_cfl_number()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                          <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                          stokes_fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; velocity_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_local_cfl = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : stokes_dof_handler.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(stokes_solution,</div>
<div class="line">                                                  velocity_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> max_local_velocity = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-10;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          max_local_velocity =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_velocity, velocity_values[q].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line">        max_local_cfl =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_cfl, max_local_velocity / <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(max_local_cfl, MPI_COMM_WORLD);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_entropy_variation"></a> </p><h5>BoussinesqFlowProblem::get_entropy_variation</h5>
<p>Next comes the computation of the global entropy variation \(\|E(T)-\bar{E}(T)\|_\infty\) where the entropy \(E\) is defined as discussed in the introduction. This is needed for the evaluation of the stabilization in the temperature equation as explained in the introduction. The entropy variation is actually only needed if we use \(\alpha=2\) as a power in the residual computation. The infinity norm is computed by the maxima over quadrature points, as usual in discrete computations. <br  />
 In order to compute this quantity, we first have to find the space-average \(\bar{E}(T)\) and then evaluate the maximum. However, that means that we would need to perform two loops. We can avoid the overhead by noting that \(\|E(T)-\bar{E}(T)\|_\infty = \max\big(E_{\textrm{max}}(T)-\bar{E}(T), \bar{E}(T)-E_{\textrm{min}}(T)\big)\) , i.e., the maximum out of the deviation from the average entropy in positive and negative directions. The four quantities we need for the latter formula (maximum entropy, minimum entropy, average entropy, area) can all be evaluated in the same loop over all cells, so we choose this simpler variant.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::get_entropy_variation(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha != 2)</div>
<div class="line">    <span class="keywordflow">return</span> 1.;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 1);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>       fe_values(temperature_fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
</div><!-- fragment --><p>In the two functions above we computed the maximum of numbers that were all non-negative, so we knew that zero was certainly a lower bound. On the other hand, here we need to find the maximum deviation from the average value, i.e., we will need to know the maximal and minimal values of the entropy for which we don't a priori know the sign. <br  />
 To compute it, we can therefore start with the largest and smallest possible values we can store in a double precision number: The minimum is initialized with a bigger and the maximum with a smaller number than any one that is going to appear. We are then guaranteed that these numbers will be overwritten in the loop on the first cell or, if this processor does not own any cells, in the communication step at the latest. The following loop then computes the minimum and maximum local entropy as well as keeps track of the area/volume of the part of the domain we locally own and the integral over the entropy on it:</p>
<div class="fragment"><div class="line">     <span class="keywordtype">double</span> min_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">            max_entropy =</div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(), area = 0,</div>
<div class="line">            entropy_integrated = 0;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">       <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">         {</div>
<div class="line">           fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">           fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                         old_temperature_values);</div>
<div class="line">           fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                         old_old_temperature_values);</div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">             {</div>
<div class="line">               <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> =</div>
<div class="line">                 (old_temperature_values[q] + old_old_temperature_values[q]) / 2;</div>
<div class="line">               <span class="keyword">const</span> <span class="keywordtype">double</span> entropy =</div>
<div class="line">                 ((<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a></div>
<div class="line">  </div>
<div class="line">- average_temperature) (<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a></div>
<div class="line">  </div>
<div class="line">- average_temperature));</div>
<div class="line">  </div>
<div class="line">               min_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_entropy, entropy);</div>
<div class="line">               max_entropy = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_entropy, entropy);</div>
<div class="line">               area += fe_values.JxW(q);</div>
<div class="line">               entropy_integrated += fe_values.JxW(q) entropy;</div>
<div class="line">             }</div>
<div class="line">         }</div>
</div><!-- fragment --><p>Now we only need to exchange data between processors: we need to sum the two integrals ( <code>area</code>, <code>entropy_integrated</code> ), and get the extrema for maximum and minimum. We could do this through four different data exchanges, but we can it with two: <a class="el" href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a> also exists in a variant that takes an array of values that are all to be summed up. And we can also utilize the <a class="el" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a> function by realizing that forming the minimum over the minimal entropies equals forming the negative of the maximum over the negative of the minimal entropies; this maximum can then be combined with forming the maximum over the maximal entropies.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> local_sums[2]   = {entropy_integrated, area},</div>
<div class="line">             local_maxima[2] = {-min_entropy, max_entropy};</div>
<div class="line"><span class="keywordtype">double</span> global_sums[2], global_maxima[2];</div>
<div class="line"> </div>
<div class="line"><a class="code" href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a>(local_sums, MPI_COMM_WORLD, global_sums);</div>
<div class="line"><a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(local_maxima, MPI_COMM_WORLD, global_maxima);</div>
</div><!-- fragment --><p>Having computed everything this way, we can then compute the average entropy and find the \(L^\infty\) norm by taking the larger of the deviation of the maximum or minimum from the average:</p>
<div class="fragment"><div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> average_entropy = global_sums[0] / global_sums[1];</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> entropy_diff    = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(global_maxima[1]</div>
<div class="line">  </div>
<div class="line">- average_entropy,</div>
<div class="line">                                          average_entropy</div>
<div class="line">  </div>
<div class="line">- (-global_maxima[0]));</div>
<div class="line">     <span class="keywordflow">return</span> entropy_diff;</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemget_extrapolated_temperature_range"></a> </p><h5>BoussinesqFlowProblem::get_extrapolated_temperature_range</h5>
<p>The next function computes the minimal and maximal value of the extrapolated temperature over the entire domain. Again, this is only a slightly modified version of the respective function in <a class="el" href="step_31.html">step-31</a> . As in the function above, we collect local minima and maxima and then compute the global extrema using the same trick as above. <br  />
 As already discussed in <a class="el" href="step_31.html">step-31</a> , the function needs to distinguish between the first and all following time steps because it uses a higher order temperature extrapolation scheme when at least two previous time steps are available.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   std::pair&lt;double, double&gt;</div>
<div class="line">   BoussinesqFlowProblem&lt;dim&gt;::get_extrapolated_temperature_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classQIterated.html">QIterated&lt;dim&gt;</a> quadrature_formula(<a class="code" href="classQTrapezoid.html">QTrapezoid&lt;1&gt;</a>(),</div>
<div class="line">                                             <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree);</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>   <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>       fe_values(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                             temperature_fe,</div>
<div class="line">                             quadrature_formula,</div>
<div class="line">                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_old_temperature_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordtype">double</span> min_local_temperature = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">            max_local_temperature =</div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">           <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">             {</div>
<div class="line">               fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">               fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                             old_temperature_values);</div>
<div class="line">               fe_values.get_function_values(old_old_temperature_solution,</div>
<div class="line">                                             old_old_temperature_values);</div>
<div class="line">  </div>
<div class="line">               <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">                 {</div>
<div class="line">                   <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> =</div>
<div class="line">                     (1. + time_step / old_time_step)</div>
<div class="line">                       old_temperature_values[q]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                     time_step / old_time_step old_old_temperature_values[q];</div>
<div class="line">  </div>
<div class="line">                   min_local_temperature =</div>
<div class="line">                     <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                   max_local_temperature =</div>
<div class="line">                     <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                 }</div>
<div class="line">             }</div>
<div class="line">       }</div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       {</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : temperature_dof_handler.active_cell_iterators())</div>
<div class="line">           <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;is_locally_owned())</div>
<div class="line">             {</div>
<div class="line">               fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">               fe_values.get_function_values(old_temperature_solution,</div>
<div class="line">                                             old_temperature_values);</div>
<div class="line">  </div>
<div class="line">               <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">                 {</div>
<div class="line">                   <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a> = old_temperature_values[q];</div>
<div class="line">  </div>
<div class="line">                   min_local_temperature =</div>
<div class="line">                     <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                   max_local_temperature =</div>
<div class="line">                     <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_temperature, <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>);</div>
<div class="line">                 }</div>
<div class="line">             }</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <span class="keywordtype">double</span> local_extrema[2] = {-min_local_temperature, max_local_temperature};</div>
<div class="line">     <span class="keywordtype">double</span> global_extrema[2];</div>
<div class="line">     <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(local_extrema, MPI_COMM_WORLD, global_extrema);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">return</span> std::make_pair(-global_extrema[0], global_extrema[1]);</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemcompute_viscosity"></a> </p><h5>BoussinesqFlowProblem::compute_viscosity</h5>
<p>The function that calculates the viscosity is purely local and so needs no communication at all. It is mostly the same as in <a class="el" href="step_31.html">step-31</a> but with an updated formulation of the viscosity if \(\alpha=2\) is chosen:</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">double</span> BoussinesqFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_temperature,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_old_temperature,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_temperature_grads,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_old_temperature_grads,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_temperature_laplacians,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;                 old_old_temperature_laplacians,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_velocity_values,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         old_old_velocity_values,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_strain_rates,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;old_old_strain_rates,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_u_infty,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_T_variation,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                                average_temperature,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_entropy_variation,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                                cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keywordflow">if</span> (global_u_infty == 0)</div>
<div class="line">       <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 cell_diameter;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_temperature.size();</div>
<div class="line">  </div>
<div class="line">     <span class="keywordtype">double</span> max_residual = 0;</div>
<div class="line">     <span class="keywordtype">double</span> max_velocity = 0;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">       {</div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u =</div>
<div class="line">           (old_velocity_values[q] + old_old_velocity_values[q]) / 2;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> strain_rate =</div>
<div class="line">           (old_strain_rates[q] + old_old_strain_rates[q]) / 2;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a> = (old_temperature[q] + old_old_temperature[q]) / 2;</div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> dT_dt =</div>
<div class="line">           (old_temperature[q]</div>
<div class="line">  </div>
<div class="line">- old_old_temperature[q]) / old_time_step;</div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_T =</div>
<div class="line">           u (old_temperature_grads[q] + old_old_temperature_grads[q]) / 2;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> kappa_Delta_T =</div>
<div class="line">           <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a></div>
<div class="line">           (old_temperature_laplacians[q] + old_old_temperature_laplacians[q]) /</div>
<div class="line">           2;</div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> =</div>
<div class="line">           ((<a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">EquationData::radiogenic_heating</a> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>) +</div>
<div class="line">             2 <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> strain_rate strain_rate) /</div>
<div class="line">            (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a>) <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">EquationData::specific_heat</a>));</div>
<div class="line">  </div>
<div class="line">         <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> = <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>(dT_dt + u_grad_T</div>
<div class="line">  </div>
<div class="line">- kappa_Delta_T</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a>);</div>
<div class="line">         <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha == 2)</div>
<div class="line">           <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>= <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>(<a class="code" href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">T</a></div>
<div class="line">  </div>
<div class="line">- average_temperature);</div>
<div class="line">  </div>
<div class="line">         max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">         max_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u u), max_velocity);</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> max_viscosity =</div>
<div class="line">       (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_beta max_velocity cell_diameter);</div>
<div class="line">     <span class="keywordflow">if</span> (timestep_number == 0)</div>
<div class="line">       <span class="keywordflow">return</span> max_viscosity;</div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       {</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(old_time_step &gt; 0, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">  </div>
<div class="line">         <span class="keywordtype">double</span> entropy_viscosity;</div>
<div class="line">         <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_alpha == 2)</div>
<div class="line">           entropy_viscosity =</div>
<div class="line">             (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_c_R cell_diameter cell_diameter</div>
<div class="line">              max_residual / global_entropy_variation);</div>
<div class="line">         <span class="keywordflow">else</span></div>
<div class="line">           entropy_viscosity =</div>
<div class="line">             (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stabilization_c_R cell_diameter</div>
<div class="line">              global_Omega_diameter max_velocity max_residual /</div>
<div class="line">              (global_u_infty global_T_variation));</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">return</span> <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(max_viscosity, entropy_viscosity);</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="TheBoussinesqFlowProblemsetupfunctions"></a> </p><h4>The BoussinesqFlowProblem setup functions</h4>
<p>The following three functions set up the Stokes matrix, the matrix used for the Stokes preconditioner, and the temperature matrix. The code is mostly the same as in <a class="el" href="step_31.html">step-31</a> , but it has been broken out into three functions of their own for simplicity. <br  />
 The main functional difference between the code here and that in <a class="el" href="step_31.html">step-31</a> is that the matrices we want to set up are distributed across multiple processors. Since we still want to build up the sparsity pattern first for efficiency reasons, we could continue to build the <em>entire</em> sparsity pattern as a <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a>, as we did in <a class="el" href="step_31.html">step-31</a> . However, that would be inefficient: every processor would build the same sparsity pattern, but only initialize a small part of the matrix using it. It also violates the principle that every processor should only work on those cells it owns (and, if necessary the layer of ghost cells around it). <br  />
 Rather, we use an object of type <a class="el" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a>, which is (obviously) a wrapper around a sparsity pattern object provided by Trilinos. The advantage is that the Trilinos sparsity pattern class can communicate across multiple processors: if this processor fills in all the nonzero entries that result from the cells it owns, and every other processor does so as well, then at the end after some MPI communication initiated by the <code><a class="el" href="namespaceUtilities.html#a6155277fd058eddb1504f9562cb1c04d">compress()</a></code> call, we will have the globally assembled sparsity pattern available with which the global matrix can be initialized. <br  />
 There is one important aspect when initializing Trilinos sparsity patterns in parallel: In addition to specifying the locally owned rows and columns of the matrices via the <code>stokes_partitioning</code> index set, we also supply information about all the rows we are possibly going to write into when assembling on a certain processor. The set of locally relevant rows contains all such rows (possibly also a few unnecessary ones, but it is difficult to find the exact row indices before actually getting indices on all cells and resolving constraints). This additional information allows to exactly determine the structure for the off-processor data found during assembly. While Trilinos matrices are able to collect this information on the fly as well (when initializing them from some other reinit method), it is less efficient and leads to problems when assembling matrices with multiple threads. In this program, we pessimistically assume that only one processor at a time can write into the matrix while assembly (whereas the computation is parallel), which is fine for Trilinos matrices. In practice, one can do better by hinting <a class="el" href="namespaceWorkStream.html">WorkStream</a> at cells that do not share vertices, allowing for parallelism among those cells (see the graph coloring algorithms and <a class="el" href="namespaceWorkStream.html">WorkStream</a> with colored iterators argument). However, that only works when only one MPI processor is present because Trilinos' internal data structures for accumulating off-processor data on the fly are not thread safe. With the initialization presented here, there is no such problem and one could safely introduce graph coloring for this algorithm. <br  />
 The only other change we need to make is to tell the <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern()</a> function that it is only supposed to work on a subset of cells, namely the ones whose <code>subdomain_id</code> equals the number of the current processor, and to ignore all other cells. <br  />
 This strategy is replicated across all three of the following functions. <br  />
 Note that Trilinos matrices store the information contained in the sparsity patterns, so we can safely release the <code>sp</code> variable once the matrix has been given the sparsity structure.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_stokes_matrix(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning)</div>
<div class="line">{</div>
<div class="line">  stokes_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> sp(stokes_partitioning,</div>
<div class="line">                                            stokes_partitioning,</div>
<div class="line">                                            stokes_relevant_partitioning,</div>
<div class="line">                                            MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(stokes_dof_handler,</div>
<div class="line">                                  coupling,</div>
<div class="line">                                  sp,</div>
<div class="line">                                  stokes_constraints,</div>
<div class="line">                                  <span class="keyword">false</span>,</div>
<div class="line">                                  <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                    MPI_COMM_WORLD));</div>
<div class="line">  sp.compress();</div>
<div class="line"> </div>
<div class="line">  stokes_matrix.reinit(sp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_partitioning,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;IndexSet&gt; &amp;stokes_relevant_partitioning)</div>
<div class="line">{</div>
<div class="line">  Amg_preconditioner.reset();</div>
<div class="line">  Mp_preconditioner.reset();</div>
<div class="line"> </div>
<div class="line">  stokes_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a> sp(stokes_partitioning,</div>
<div class="line">                                            stokes_partitioning,</div>
<div class="line">                                            stokes_relevant_partitioning,</div>
<div class="line">                                            MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(stokes_dof_handler,</div>
<div class="line">                                  coupling,</div>
<div class="line">                                  sp,</div>
<div class="line">                                  stokes_constraints,</div>
<div class="line">                                  <span class="keyword">false</span>,</div>
<div class="line">                                  <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                    MPI_COMM_WORLD));</div>
<div class="line">  sp.compress();</div>
<div class="line"> </div>
<div class="line">  stokes_preconditioner_matrix.reinit(sp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_temperature_matrices(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_partitioner,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classIndexSet.html">IndexSet</a> &amp;temperature_relevant_partitioner)</div>
<div class="line">{</div>
<div class="line">  T_preconditioner.reset();</div>
<div class="line">  temperature_mass_matrix.clear();</div>
<div class="line">  temperature_stiffness_matrix.clear();</div>
<div class="line">  temperature_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a> sp(temperature_partitioner,</div>
<div class="line">                                       temperature_partitioner,</div>
<div class="line">                                       temperature_relevant_partitioner,</div>
<div class="line">                                       MPI_COMM_WORLD);</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(temperature_dof_handler,</div>
<div class="line">                                  sp,</div>
<div class="line">                                  temperature_constraints,</div>
<div class="line">                                  <span class="keyword">false</span>,</div>
<div class="line">                                  <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                    MPI_COMM_WORLD));</div>
<div class="line">  sp.compress();</div>
<div class="line"> </div>
<div class="line">  temperature_matrix.reinit(sp);</div>
<div class="line">  temperature_mass_matrix.reinit(sp);</div>
<div class="line">  temperature_stiffness_matrix.reinit(sp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The remainder of the setup function (after splitting out the three functions above) mostly has to deal with the things we need to do for parallelization across processors. Because setting all of this up is a significant compute time expense of the program, we put everything we do here into a timer group so that we can get summary information about the fraction of time spent in this part of the program at its end. <br  />
 At the top as usual we enumerate degrees of freedom and sort them by component/block, followed by writing their numbers to the screen from processor zero. The DoFHandler::distributed_dofs() function, when applied to a <a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a> object, sorts degrees of freedom in such a way that all degrees of freedom associated with subdomain zero come before all those associated with subdomain one, etc. For the Stokes part, this entails, however, that velocities and pressures become intermixed, but this is trivially solved by sorting again by blocks; it is worth noting that this latter operation leaves the relative ordering of all velocities and pressures alone, i.e. within the velocity block we will still have all those associated with subdomain zero before all velocities associated with subdomain one, etc. This is important since we store each of the blocks of this matrix distributed across all processors and want this to be done in such a way that each processor stores that part of the matrix that is roughly equal to the degrees of freedom located on those cells that it will actually work on. <br  />
 When printing the numbers of degrees of freedom, note that these numbers are going to be large if we use many processors. Consequently, we let the stream put a comma separator in between every three digits. The state of the stream, using the locale, is saved from before to after this operation. While slightly opaque, the code works because the default locale (which we get using the constructor call <code>std::locale("")</code> ) implies printing numbers with a comma separator for every third digit (i.e., thousands, millions, billions). <br  />
 In this function as well as many below, we measure how much time we spend here and collect that in a section called "Setup dof systems" across function invocations. This is done using an <a class="el" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> object that gets a timer going in the section with above name of the <code>computing_timer</code> object upon construction of the local variable; the timer is stopped again when the destructor of the <code>timing_section</code> variable is called. This, of course, happens either at the end of the function, or if we leave the function through a <code>return</code> statement or when an exception is thrown somewhere</p>
<ul>
<li>in other words, whenever we leave this function in any way. The use of such "scope" objects therefore makes sure that we do not have to manually add code that tells the timer to stop at every location where this function may be left.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timing_section(computing_timer, <span class="stringliteral">&quot;Setup dof systems&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  stokes_dof_handler.distribute_dofs(stokes_fe);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;unsigned int&gt; stokes_sub_blocks(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">  stokes_sub_blocks[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">  temperature_dof_handler.distribute_dofs(temperature_fe);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; stokes_dofs_per_block =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(stokes_dof_handler, stokes_sub_blocks);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = stokes_dofs_per_block[0],</div>
<div class="line">                     n_p = stokes_dofs_per_block[1],</div>
<div class="line">                     n_T = temperature_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">  std::locale <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a> = pcout.get_stream().getloc();</div>
<div class="line">  pcout.get_stream().imbue(std::locale(<span class="stringliteral">&quot;&quot;</span>));</div>
<div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_global_active_cells()</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_T &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; n_u</div>
<div class="line">        &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_T &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">        &lt;&lt; std::endl;</div>
<div class="line">  pcout.get_stream().imbue(<a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>);</div>
</div><!-- fragment --><p>After this, we have to set up the various partitioners (of type <code><a class="el" href="classIndexSet.html">IndexSet</a></code> , see the introduction) that describe which parts of each matrix or vector will be stored where, then call the functions that actually set up the matrices, and at the end also resize the various vectors we keep around in this program.</p>
<div class="fragment"><div class="line">std::vector&lt;IndexSet&gt; stokes_partitioning, stokes_relevant_partitioning;</div>
<div class="line"><a class="code" href="classIndexSet.html">IndexSet</a>              temperature_partitioning(n_T),</div>
<div class="line">  temperature_relevant_partitioning(n_T);</div>
<div class="line"><a class="code" href="classIndexSet.html">IndexSet</a> stokes_relevant_set;</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> stokes_index_set = stokes_dof_handler.locally_owned_dofs();</div>
<div class="line">  stokes_partitioning.push_back(stokes_index_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div>
<div class="line">  stokes_partitioning.push_back(stokes_index_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(stokes_dof_handler,</div>
<div class="line">                                          stokes_relevant_set);</div>
<div class="line">  stokes_relevant_partitioning.push_back(</div>
<div class="line">    stokes_relevant_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(0, n_u));</div>
<div class="line">  stokes_relevant_partitioning.push_back(</div>
<div class="line">    stokes_relevant_set.<a class="code" href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">get_view</a>(n_u, n_u + n_p));</div>
<div class="line"> </div>
<div class="line">  temperature_partitioning = temperature_dof_handler.locally_owned_dofs();</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(</div>
<div class="line">    temperature_dof_handler, temperature_relevant_partitioning);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Following this, we can compute constraints for the solution vectors, including hanging node constraints and homogeneous and inhomogeneous boundary values for the Stokes and temperature fields. Note that as for everything else, the constraint objects can not hold <em>all</em> constraints on every processor. Rather, each processor needs to store only those that are actually necessary for correctness given that it only assembles linear systems on cells it owns. As discussed in the <a class="el" href="DEALGlossary.html#distributed_paper">this paper</a>, the set of constraints we need to know about is exactly the set of constraints on all locally relevant degrees of freedom, so this is what we use to initialize the constraint objects.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  stokes_constraints.clear();</div>
<div class="line">  stokes_constraints.reinit(stokes_relevant_set);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                          stokes_constraints);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocity_components(0);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">    stokes_dof_handler,</div>
<div class="line">    0,</div>
<div class="line">    <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1),</div>
<div class="line">    stokes_constraints,</div>
<div class="line">    stokes_fe.component_mask(velocity_components));</div>
<div class="line"> </div>
<div class="line">  std::set&lt;types::boundary_id&gt; no_normal_flux_boundaries;</div>
<div class="line">  no_normal_flux_boundaries.insert(1);</div>
<div class="line">  <a class="code" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a>(stokes_dof_handler,</div>
<div class="line">                                                  0,</div>
<div class="line">                                                  no_normal_flux_boundaries,</div>
<div class="line">                                                  stokes_constraints,</div>
<div class="line">                                                  <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>);</div>
<div class="line">  stokes_constraints.close();</div>
<div class="line">}</div>
<div class="line">{</div>
<div class="line">  temperature_constraints.clear();</div>
<div class="line">  temperature_constraints.reinit(temperature_relevant_partitioning);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(temperature_dof_handler,</div>
<div class="line">                                          temperature_constraints);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">    temperature_dof_handler,</div>
<div class="line">    0,</div>
<div class="line">    EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">    temperature_constraints);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">    temperature_dof_handler,</div>
<div class="line">    1,</div>
<div class="line">    EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">    temperature_constraints);</div>
<div class="line">  temperature_constraints.close();</div>
<div class="line">}</div>
</div><!-- fragment --><p>All this done, we can then initialize the various matrix and vector objects to their proper sizes. At the end, we also record that all matrices and preconditioners have to be re-computed at the beginning of the next time step. Note how we initialize the vectors for the Stokes and temperature right hand sides: These are writable vectors (last boolean argument set to <code>true</code>) that have the correct one-to-one partitioning of locally owned elements but are still given the relevant partitioning for means of figuring out the vector entries that are going to be set right away. As for matrices, this allows for writing local contributions into the vector with multiple threads (always assuming that the same vector entry is not accessed by multiple threads at the same time). The other vectors only allow for read access of individual elements, including ghosts, but are not suitable for solvers.</p>
<div class="fragment"><div class="line">  setup_stokes_matrix(stokes_partitioning, stokes_relevant_partitioning);</div>
<div class="line">  setup_stokes_preconditioner(stokes_partitioning,</div>
<div class="line">                              stokes_relevant_partitioning);</div>
<div class="line">  setup_temperature_matrices(temperature_partitioning,</div>
<div class="line">                             temperature_relevant_partitioning);</div>
<div class="line"> </div>
<div class="line">  stokes_rhs.reinit(stokes_partitioning,</div>
<div class="line">                    stokes_relevant_partitioning,</div>
<div class="line">                    MPI_COMM_WORLD,</div>
<div class="line">                    <span class="keyword">true</span>);</div>
<div class="line">  stokes_solution.reinit(stokes_relevant_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_stokes_solution.reinit(stokes_solution);</div>
<div class="line"> </div>
<div class="line">  temperature_rhs.reinit(temperature_partitioning,</div>
<div class="line">                         temperature_relevant_partitioning,</div>
<div class="line">                         MPI_COMM_WORLD,</div>
<div class="line">                         <span class="keyword">true</span>);</div>
<div class="line">  temperature_solution.reinit(temperature_relevant_partitioning,</div>
<div class="line">                              MPI_COMM_WORLD);</div>
<div class="line">  old_temperature_solution.reinit(temperature_solution);</div>
<div class="line">  old_old_temperature_solution.reinit(temperature_solution);</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_matrix              = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_stokes_preconditioner      = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_temperature_matrices       = <span class="keyword">true</span>;</div>
<div class="line">  rebuild_temperature_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TheBoussinesqFlowProblemassemblyfunctions"></a> </p><h4>The BoussinesqFlowProblem assembly functions</h4>
<p><br  />
 Following the discussion in the introduction and in the <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing</a> module, we split the assembly functions into different parts: <br  />
 </p><ul>
<li>
The local calculations of matrices and right hand sides, given a certain cell as input (these functions are named <code>local_assemble_*</code> below). The resulting function is, in other words, essentially the body of the loop over all cells in <a class="el" href="step_31.html">step-31</a> . Note, however, that these functions store the result from the local calculations in variables of classes from the <a class="el" href="structCopyData.html">CopyData</a> namespace. <br  />
 </li>
<li>
These objects are then given to the second step which writes the local data into the global data structures (these functions are named <code>copy_local_to_global_*</code> below). These functions are pretty trivial. <br  />
 </li>
<li>
These two subfunctions are then used in the respective assembly routine (called <code>assemble_*</code> below), where a <a class="el" href="namespaceWorkStream.html">WorkStream</a> object is set up and runs over all the cells that belong to the processor's subdomain. </li>
</ul>
<p><br  />
</p>
<pre class="fragment">&lt;a name="Stokespreconditionerassembly"&gt;&lt;/a&gt;  &lt;h5&gt;Stokes preconditioner assembly&lt;/h5&gt;   
Let us start with the functions that builds the Stokes preconditioner. The first two of these are pretty trivial, given the discussion above. Note in particular that the main point in using the scratch data object is that we want to avoid allocating any objects on the free space each time we visit a new cell. As a consequence, the assembly function below only has automatic local variables, and everything else is accessed through the scratch data object, which is allocated only once before we start the loop over all cells:
</pre><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">  Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = stokes_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">    scratch.stokes_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">  scratch.stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">        {</div>
<div class="line">          scratch.grad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">            scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          scratch.phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">            (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a></div>
<div class="line">               <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(scratch.grad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>], scratch.grad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) +</div>
<div class="line">             (1. / <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a>) <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a></div>
<div class="line">               <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a></div>
<div class="line">               (scratch.phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] scratch.phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]))</div>
<div class="line">            scratch.stokes_fe_values.JxW(q);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_stokes_preconditioner(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix,</div>
<div class="line">                                                <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                stokes_preconditioner_matrix);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now for the function that actually puts things together, using the <a class="el" href="namespaceWorkStream.html">WorkStream</a> functions. <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> needs a start and end iterator to enumerate the cells it is supposed to work on. Typically, one would use <a class="el" href="classDoFHandler.html#a9a3bef554c6d22abe312e10e9475eecf">DoFHandler::begin_active()</a> and <a class="el" href="classDoFHandler.html#a042c4bf0f59fef5e72dbcfbdd56b2782">DoFHandler::end()</a> for that but here we actually only want the subset of cells that in fact are owned by the current processor. This is where the <a class="el" href="classFilteredIterator.html">FilteredIterator</a> class comes into play: you give it a range of cells and it provides an iterator that only iterates over that subset of cells that satisfy a certain predicate (a predicate is a function of one argument that either returns true or false). The predicate we use here is <a class="el" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>, i.e., it returns true exactly if the cell is owned by the current processor. The resulting iterator range is then exactly what we need. <br  />
 With this obstacle out of the way, we call the <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> function with this set of cells, scratch and copy objects, and with pointers to two functions: the local assembly and copy-local-to-global function. These functions need to have very specific signatures: three arguments in the first and one argument in the latter case (see the documentation of the <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> function for the meaning of these arguments). Note how we use a lambda functions to create a function object that satisfies this requirement. It uses function arguments for the local assembly function that specify cell, scratch data, and copy data, as well as function argument for the copy function that expects the data to be written into the global matrix (also see the discussion in <a class="el" href="step_13.html">step-13</a> 's <code>assemble_linear_system()</code> function). On the other hand, the implicit zeroth argument of member functions (namely the <code>this</code> pointer of the object on which that member function is to operate on) is <em>bound</em> to the <code>this</code> pointer of the current function and is captured. The <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> function, as a consequence, does not need to know anything about the object these functions work on. <br  />
 When the <a class="el" href="namespaceWorkStream.html">WorkStream</a> is executed, it will create several local assembly routines of the first kind for several cells and let some available processors work on them. The function that needs to be synchronized, i.e., the write operation into the global matrix, however, is executed by only one thread at a time in the prescribed order. Of course, this only holds for the parallelization on a single MPI process. Different MPI processes will have their own <a class="el" href="namespaceWorkStream.html">WorkStream</a> objects and do that work completely independently (and in different memory spaces). In a distributed calculation, some data will accumulate at degrees of freedom that are not owned by the respective processor. It would be inefficient to send data around every time we encounter such a dof. What happens instead is that the Trilinos sparse matrix will keep that data and send it to the owner at the end of assembly, by calling the <code><a class="el" href="namespaceUtilities.html#a6155277fd058eddb1504f9562cb1c04d">compress()</a></code> command.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_preconditioner()</div>
<div class="line">{</div>
<div class="line">  stokes_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using</span> CellFilter =</div>
<div class="line">    <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> worker =</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">           Assembly::Scratch::StokesPreconditioner&lt;dim&gt; &amp;        scratch,</div>
<div class="line">           Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;local_assemble_stokes_preconditioner(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, scratch, <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a> =</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::StokesPreconditioner&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;copy_local_to_global_stokes_preconditioner(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                             stokes_dof_handler.begin_active()),</div>
<div class="line">                  CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                             stokes_dof_handler.end()),</div>
<div class="line">                  worker,</div>
<div class="line">                  <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a>,</div>
<div class="line">                  Assembly::Scratch::StokesPreconditioner&lt;dim&gt;(</div>
<div class="line">                    stokes_fe,</div>
<div class="line">                    quadrature_formula,</div>
<div class="line">                    <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>),</div>
<div class="line">                  Assembly::CopyData::StokesPreconditioner&lt;dim&gt;(stokes_fe));</div>
<div class="line"> </div>
<div class="line">  stokes_preconditioner_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The final function in this block initiates assembly of the Stokes preconditioner matrix and then in fact builds the Stokes preconditioner. It is mostly the same as in the serial case. The only difference to <a class="el" href="step_31.html">step-31</a> is that we use a Jacobi preconditioner for the pressure mass matrix instead of IC, as discussed in the introduction.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::build_stokes_preconditioner()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_stokes_preconditioner == <span class="keyword">false</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                   <span class="stringliteral">&quot;   Build Stokes preconditioner&quot;</span>);</div>
<div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding Stokes preconditioner...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">  assemble_stokes_preconditioner();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">std::vector&lt;std::vector&lt;bool&gt;</a>&gt; constant_modes;</div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a>     velocity_components(0);</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a>(stokes_dof_handler,</div>
<div class="line">                                   stokes_fe.component_mask(</div>
<div class="line">                                     velocity_components),</div>
<div class="line">                                   constant_modes);</div>
<div class="line"> </div>
<div class="line">  Mp_preconditioner =</div>
<div class="line">    std::make_shared&lt;TrilinosWrappers::PreconditionJacobi&gt;();</div>
<div class="line">  Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionAMG&gt;();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a> Amg_data;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">constant_modes</a>        = constant_modes;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">elliptic</a>              = <span class="keyword">true</span>;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">higher_order_elements</a> = <span class="keyword">true</span>;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">smoother_sweeps</a>       = 2;</div>
<div class="line">  Amg_data.<a class="code" href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">aggregation_threshold</a> = 0.02;</div>
<div class="line"> </div>
<div class="line">  Mp_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(1, 1));</div>
<div class="line">  Amg_preconditioner-&gt;initialize(stokes_preconditioner_matrix.block(0, 0),</div>
<div class="line">                                 Amg_data);</div>
<div class="line"> </div>
<div class="line">  rebuild_stokes_preconditioner = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  pcout &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Stokessystemassembly"></a> </p><h5>Stokes system assembly</h5>
<p>The next three functions implement the assembly of the Stokes system, again split up into a part performing local calculations, one for writing the local data into the global matrix and vector, and one for actually running the loop over all cells with the help of the <a class="el" href="namespaceWorkStream.html">WorkStream</a> class. Note that the assembly of the Stokes matrix needs only to be done in case we have changed the mesh. Otherwise, just the (temperature-dependent) right hand side needs to be calculated here. Since we are working with distributed matrices and vectors, we have to call the respective <code><a class="el" href="namespaceUtilities.html#a6155277fd058eddb1504f9562cb1c04d">compress()</a></code> functions in the end of the assembly in order to send non-local data to the owner process.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_stokes_system(</div>
<div class="line">     <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">     Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">     Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">       scratch.stokes_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">       scratch.stokes_fe_values.n_quadrature_points;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">  </div>
<div class="line">     scratch.stokes_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> temperature_cell(</div>
<div class="line">       &amp;<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level(), <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;index(), &amp;temperature_dof_handler);</div>
<div class="line">     scratch.temperature_fe_values.reinit(temperature_cell);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">       <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix = 0;</div>
<div class="line">     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs = 0;</div>
<div class="line">  </div>
<div class="line">     scratch.temperature_fe_values.get_function_values(</div>
<div class="line">       old_temperature_solution, scratch.old_temperature_values);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">       {</div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> old_temperature = scratch.old_temperature_values[q];</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">           {</div>
<div class="line">             scratch.phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">             <span class="keywordflow">if</span> (rebuild_stokes_matrix)</div>
<div class="line">               {</div>
<div class="line">                 scratch.grads_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                   scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                 scratch.div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                   scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                 scratch.phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                   scratch.stokes_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                 (<a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> 2</div>
<div class="line">                    (scratch.grads_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] scratch.grads_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                  (<a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> scratch.div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">                   scratch.phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                  (<a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a> scratch.phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">                   scratch.div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]))</div>
<div class="line">                 scratch.stokes_fe_values.JxW(q);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> gravity = <a class="code" href="namespaceStep32_1_1EquationData.html#a7c001f60e6c7c0bcd347e3f7b66a5402">EquationData::gravity_vector</a>(</div>
<div class="line">           scratch.stokes_fe_values.quadrature_point(q));</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">           <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(old_temperature)</div>
<div class="line">                                 gravity scratch.phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>])</div>
<div class="line">                                scratch.stokes_fe_values.JxW(q);</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_stokes_system(</div>
<div class="line">     <span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">   {</div>
<div class="line">     <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">       stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_matrix,</div>
<div class="line">                                                     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                     stokes_matrix,</div>
<div class="line">                                                     stokes_rhs);</div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       stokes_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                     stokes_rhs);</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_stokes_system()</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                      <span class="stringliteral">&quot;   Assemble Stokes system&quot;</span>);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">       stokes_matrix = 0;</div>
<div class="line">  </div>
<div class="line">     stokes_rhs = 0;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.stokes_velocity_degree + 1);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">using</span> CellFilter =</div>
<div class="line">       <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(</div>
<div class="line">       CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                  stokes_dof_handler.begin_active()),</div>
<div class="line">       CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(), stokes_dof_handler.end()),</div>
<div class="line">       [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">              Assembly::Scratch::StokesSystem&lt;dim&gt; &amp;                scratch,</div>
<div class="line">              Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;               <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">         this-&gt;local_assemble_stokes_system(cell, scratch, data);</div>
<div class="line">       },</div>
<div class="line">       [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::StokesSystem&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">         this-&gt;copy_local_to_global_stokes_system(data);</div>
<div class="line">       },</div>
<div class="line">       Assembly::Scratch::StokesSystem&lt;dim&gt;(</div>
<div class="line">         stokes_fe,</div>
<div class="line">         <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">         quadrature_formula,</div>
<div class="line">         (<a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">          (rebuild_stokes_matrix == <span class="keyword">true</span> ? <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> : <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a>(0))),</div>
<div class="line">         temperature_fe,</div>
<div class="line">         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>),</div>
<div class="line">       Assembly::CopyData::StokesSystem&lt;dim&gt;(stokes_fe));</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (rebuild_stokes_matrix == <span class="keyword">true</span>)</div>
<div class="line">       stokes_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">     stokes_rhs.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">  </div>
<div class="line">     rebuild_stokes_matrix = <span class="keyword">false</span>;</div>
<div class="line">  </div>
<div class="line">     pcout &lt;&lt; std::endl;</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="Temperaturematrixassembly"></a> </p><h5>Temperature matrix assembly</h5>
<p>The task to be performed by the next three functions is to calculate a mass matrix and a Laplace matrix on the temperature system. These will be combined in order to yield the semi-implicit time stepping matrix that consists of the mass matrix plus a time step- dependent weight factor times the Laplace matrix. This function is again essentially the body of the loop over all cells from <a class="el" href="step_31.html">step-31</a> . <br  />
 The two following functions perform similar services as the ones above.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_temperature_matrix(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">  Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">  Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">    scratch.temperature_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">    scratch.temperature_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">  scratch.temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix      = 0;</div>
<div class="line">  <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">        {</div>
<div class="line">          scratch.grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">            scratch.temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          scratch.phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">              (scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] scratch.phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]</div>
<div class="line">               scratch.temperature_fe_values.JxW(q));</div>
<div class="line">            <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">              (<a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">               scratch.grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] scratch.temperature_fe_values.JxW(q));</div>
<div class="line">          }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_temperature_matrix(</div>
<div class="line">  <span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">{</div>
<div class="line">  temperature_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_mass_matrix,</div>
<div class="line">                                                     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                     temperature_mass_matrix);</div>
<div class="line">  temperature_constraints.distribute_local_to_global(</div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_stiffness_matrix,</div>
<div class="line">    <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">    temperature_stiffness_matrix);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_matrix()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_temperature_matrices == <span class="keyword">false</span>)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                   <span class="stringliteral">&quot;   Assemble temperature matrices&quot;</span>);</div>
<div class="line">  temperature_mass_matrix      = 0;</div>
<div class="line">  temperature_stiffness_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using</span> CellFilter =</div>
<div class="line">    <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(</div>
<div class="line">    CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">               temperature_dof_handler.begin_active()),</div>
<div class="line">    CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">               temperature_dof_handler.end()),</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">           Assembly::Scratch::TemperatureMatrix&lt;dim&gt; &amp;           scratch,</div>
<div class="line">           Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;          <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;local_assemble_temperature_matrix(cell, scratch, data);</div>
<div class="line">    },</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::TemperatureMatrix&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;copy_local_to_global_temperature_matrix(data);</div>
<div class="line">    },</div>
<div class="line">    Assembly::Scratch::TemperatureMatrix&lt;dim&gt;(temperature_fe,</div>
<div class="line">                                              <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,</div>
<div class="line">                                              quadrature_formula),</div>
<div class="line">    Assembly::CopyData::TemperatureMatrix&lt;dim&gt;(temperature_fe));</div>
<div class="line"> </div>
<div class="line">  temperature_mass_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">  temperature_stiffness_matrix.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line"> </div>
<div class="line">  rebuild_temperature_matrices       = <span class="keyword">false</span>;</div>
<div class="line">  rebuild_temperature_preconditioner = <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Temperaturerighthandsideassembly"></a> </p><h5>Temperature right hand side assembly</h5>
<p>This is the last assembly function. It calculates the right hand side of the temperature system, which includes the convection and the stabilization terms. It includes a lot of evaluations of old solutions at the quadrature points (which are necessary for calculating the artificial viscosity of stabilization), but is otherwise similar to the other assembly functions. Notice, once again, how we resolve the dilemma of having inhomogeneous boundary conditions, by just making a right hand side at this point (compare the comments for the <code><a class="el" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">project()</a></code> function above): We create some matrix columns with exactly the values that would be entered for the temperature stiffness matrix, in case we have inhomogeneously constrained dofs. That will account for the correct balance of the right hand side vector with the matrix system of temperature.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::local_assemble_temperature_rhs(</div>
<div class="line">     <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_velocity,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_entropy_variation,</div>
<div class="line">     <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">     Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">     Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">       scratch.temperature_fe_values.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> =</div>
<div class="line">       scratch.temperature_fe_values.n_quadrature_points;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs     = 0;</div>
<div class="line">     <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc = 0;</div>
<div class="line">     <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices);</div>
<div class="line">  </div>
<div class="line">     scratch.temperature_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> stokes_cell(</div>
<div class="line">       &amp;<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level(), <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;index(), &amp;stokes_dof_handler);</div>
<div class="line">     scratch.stokes_fe_values.reinit(stokes_cell);</div>
<div class="line">  </div>
<div class="line">     scratch.temperature_fe_values.get_function_values(</div>
<div class="line">       old_temperature_solution, scratch.old_temperature_values);</div>
<div class="line">     scratch.temperature_fe_values.get_function_values(</div>
<div class="line">       old_old_temperature_solution, scratch.old_old_temperature_values);</div>
<div class="line">  </div>
<div class="line">     scratch.temperature_fe_values.get_function_gradients(</div>
<div class="line">       old_temperature_solution, scratch.old_temperature_grads);</div>
<div class="line">     scratch.temperature_fe_values.get_function_gradients(</div>
<div class="line">       old_old_temperature_solution, scratch.old_old_temperature_grads);</div>
<div class="line">  </div>
<div class="line">     scratch.temperature_fe_values.get_function_laplacians(</div>
<div class="line">       old_temperature_solution, scratch.old_temperature_laplacians);</div>
<div class="line">     scratch.temperature_fe_values.get_function_laplacians(</div>
<div class="line">       old_old_temperature_solution, scratch.old_old_temperature_laplacians);</div>
<div class="line">  </div>
<div class="line">     scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">       stokes_solution, scratch.old_velocity_values);</div>
<div class="line">     scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_values(</div>
<div class="line">       old_stokes_solution, scratch.old_old_velocity_values);</div>
<div class="line">     scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_symmetric_gradients(</div>
<div class="line">       stokes_solution, scratch.old_strain_rates);</div>
<div class="line">     scratch.stokes_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].get_function_symmetric_gradients(</div>
<div class="line">       old_stokes_solution, scratch.old_old_strain_rates);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">       compute_viscosity(scratch.old_temperature_values,</div>
<div class="line">                         scratch.old_old_temperature_values,</div>
<div class="line">                         scratch.old_temperature_grads,</div>
<div class="line">                         scratch.old_old_temperature_grads,</div>
<div class="line">                         scratch.old_temperature_laplacians,</div>
<div class="line">                         scratch.old_old_temperature_laplacians,</div>
<div class="line">                         scratch.old_velocity_values,</div>
<div class="line">                         scratch.old_old_velocity_values,</div>
<div class="line">                         scratch.old_strain_rates,</div>
<div class="line">                         scratch.old_old_strain_rates,</div>
<div class="line">                         global_max_velocity,</div>
<div class="line">                         global_T_range.second</div>
<div class="line">  </div>
<div class="line">- global_T_range.first,</div>
<div class="line">                         0.5 (global_T_range.second + global_T_range.first),</div>
<div class="line">                         global_entropy_variation,</div>
<div class="line">                         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;diameter());</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">           {</div>
<div class="line">             scratch.phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = scratch.temperature_fe_values.shape_value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">             scratch.grad_phi_T[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">               scratch.temperature_fe_values.shape_grad(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> T_term_for_rhs =</div>
<div class="line">           (use_bdf2_scheme ?</div>
<div class="line">              (scratch.old_temperature_values[q]</div>
<div class="line">                 (1 + time_step / old_time_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">               scratch.old_old_temperature_values[q] (time_step time_step) /</div>
<div class="line">                 (old_time_step (time_step + old_time_step))) :</div>
<div class="line">              scratch.old_temperature_values[q]);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> ext_T =</div>
<div class="line">           (use_bdf2_scheme ? (scratch.old_temperature_values[q]</div>
<div class="line">                                 (1 + time_step / old_time_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                               scratch.old_old_temperature_values[q]</div>
<div class="line">                                 time_step / old_time_step) :</div>
<div class="line">                              scratch.old_temperature_values[q]);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> ext_grad_T =</div>
<div class="line">           (use_bdf2_scheme ? (scratch.old_temperature_grads[q]</div>
<div class="line">                                 (1 + time_step / old_time_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                               scratch.old_old_temperature_grads[q] time_step /</div>
<div class="line">                                 old_time_step) :</div>
<div class="line">                              scratch.old_temperature_grads[q]);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> extrapolated_u =</div>
<div class="line">           (use_bdf2_scheme ?</div>
<div class="line">              (scratch.old_velocity_values[q] (1 + time_step / old_time_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">               scratch.old_old_velocity_values[q] time_step / old_time_step) :</div>
<div class="line">              scratch.old_velocity_values[q]);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> extrapolated_strain_rate =</div>
<div class="line">           (use_bdf2_scheme ?</div>
<div class="line">              (scratch.old_strain_rates[q] (1 + time_step / old_time_step)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">               scratch.old_old_strain_rates[q] time_step / old_time_step) :</div>
<div class="line">              scratch.old_strain_rates[q]);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> =</div>
<div class="line">           ((<a class="code" href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">EquationData::radiogenic_heating</a> <a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(ext_T) +</div>
<div class="line">             2 <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> extrapolated_strain_rate</div>
<div class="line">               extrapolated_strain_rate) /</div>
<div class="line">            (<a class="code" href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">EquationData::density</a>(ext_T) <a class="code" href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">EquationData::specific_heat</a>));</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">           {</div>
<div class="line">             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">               (T_term_for_rhs scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                time_step extrapolated_u ext_grad_T scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                time_step nu ext_grad_T scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] +</div>
<div class="line">                time_step <a class="code" href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">gamma</a> scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>])</div>
<div class="line">               scratch.temperature_fe_values.JxW(q);</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">if</span> (temperature_constraints.is_inhomogeneously_constrained(</div>
<div class="line">                   <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]))</div>
<div class="line">               {</div>
<div class="line">                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                   <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                     (scratch.phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] scratch.phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]</div>
<div class="line">                        (use_bdf2_scheme ? ((2 time_step + old_time_step) /</div>
<div class="line">                                            (time_step + old_time_step)) :</div>
<div class="line">                                           1.) +</div>
<div class="line">                      scratch.grad_phi_T[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] scratch.grad_phi_T[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]</div>
<div class="line">                        <a class="code" href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">EquationData::kappa</a> time_step)</div>
<div class="line">                     scratch.temperature_fe_values.JxW(q);</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">       }</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::copy_local_to_global_temperature_rhs(</div>
<div class="line">     <span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>)</div>
<div class="line">   {</div>
<div class="line">     temperature_constraints.distribute_local_to_global(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_rhs,</div>
<div class="line">                                                        <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.local_dof_indices,</div>
<div class="line">                                                        temperature_rhs,</div>
<div class="line">                                                        <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>.matrix_for_bc);</div>
<div class="line">   }</div>
</div><!-- fragment --><p>In the function that runs the <a class="el" href="namespaceWorkStream.html">WorkStream</a> for actually calculating the right hand side, we also generate the final matrix. As mentioned above, it is a sum of the mass matrix and the Laplace matrix, times some time step- dependent weight. This weight is specified by the BDF-2 time integration scheme, see the introduction in <a class="el" href="step_31.html">step-31</a> . What is new in this tutorial program (in addition to the use of MPI parallelization and the <a class="el" href="namespaceWorkStream.html">WorkStream</a> class), is that we now precompute the temperature preconditioner as well. The reason is that the setup of the Jacobi preconditioner takes a noticeable time compared to the solver because we usually only need between 10 and 20 iterations for solving the temperature system (this might sound strange, as Jacobi really only consists of a diagonal, but in Trilinos it is derived from more general framework for point relaxation preconditioners which is a bit inefficient). Hence, it is more efficient to precompute the preconditioner, even though the matrix entries may slightly change because the time step might change. This is not too big a problem because we remesh every few time steps (and regenerate the preconditioner then).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::assemble_temperature_system(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> use_bdf2_scheme = (timestep_number != 0);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (use_bdf2_scheme == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">      temperature_matrix=</div>
<div class="line">        (2 time_step + old_time_step) / (time_step + old_time_step);</div>
<div class="line">      temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      temperature_matrix.copy_from(temperature_mass_matrix);</div>
<div class="line">      temperature_matrix.add(time_step, temperature_stiffness_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_temperature_preconditioner == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      T_preconditioner =</div>
<div class="line">        std::make_shared&lt;TrilinosWrappers::PreconditionJacobi&gt;();</div>
<div class="line">      T_preconditioner-&gt;initialize(temperature_matrix);</div>
<div class="line">      rebuild_temperature_preconditioner = <span class="keyword">false</span>;</div>
<div class="line">    }</div>
</div><!-- fragment --><p>The next part is computing the right hand side vectors. To do so, we first compute the average temperature \(T_m\) that we use for evaluating the artificial viscosity stabilization through the residual \(E(T) = (T-T_m)^2\) . We do this by defining the midpoint between maximum and minimum temperature as average temperature in the definition of the entropy viscosity. An alternative would be to use the integral average, but the results are not very sensitive to this choice. The rest then only requires calling <a class="el" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a> again, binding the arguments to the <code>local_assemble_temperature_rhs</code> function that are the same in every call to the correct values:</p>
<div class="fragment"><div class="line">  temperature_rhs = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2);</div>
<div class="line">  <span class="keyword">const</span> std::pair&lt;double, double&gt; global_T_range =</div>
<div class="line">    get_extrapolated_temperature_range();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> average_temperature =</div>
<div class="line">    0.5 (global_T_range.first + global_T_range.second);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_entropy_variation =</div>
<div class="line">    get_entropy_variation(average_temperature);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">using</span> CellFilter =</div>
<div class="line">    <a class="code" href="classFilteredIterator.html">FilteredIterator&lt;typename DoFHandler&lt;2&gt;::active_cell_iterator</a>&gt;;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> worker =</div>
<div class="line">    [<span class="keyword">this</span>, global_T_range, maximal_velocity, global_entropy_variation](</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">      Assembly::Scratch::TemperatureRHS&lt;dim&gt; &amp;              scratch,</div>
<div class="line">      Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;             <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">      this-&gt;local_assemble_temperature_rhs(global_T_range,</div>
<div class="line">                                           maximal_velocity,</div>
<div class="line">                                           global_entropy_variation,</div>
<div class="line">                                           <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>,</div>
<div class="line">                                           scratch,</div>
<div class="line">                                           <a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span> <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a> = [<span class="keyword">this</span>](<span class="keyword">const</span> Assembly::CopyData::TemperatureRHS&lt;dim&gt; &amp;<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>) {</div>
<div class="line">    this-&gt;copy_local_to_global_temperature_rhs(<a class="code" href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a>);</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a>(CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                             temperature_dof_handler.begin_active()),</div>
<div class="line">                  CellFilter(<a class="code" href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a>(),</div>
<div class="line">                             temperature_dof_handler.end()),</div>
<div class="line">                  worker,</div>
<div class="line">                  <a class="code" href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a>,</div>
<div class="line">                  Assembly::Scratch::TemperatureRHS&lt;dim&gt;(</div>
<div class="line">                    temperature_fe, stokes_fe, <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, quadrature_formula),</div>
<div class="line">                  Assembly::CopyData::TemperatureRHS&lt;dim&gt;(temperature_fe));</div>
<div class="line"> </div>
<div class="line">  temperature_rhs.compress(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemsolve"></a> </p><h4>BoussinesqFlowProblem::solve</h4>
<p>This function solves the linear systems in each time step of the Boussinesq problem. First, we work on the Stokes system and then on the temperature system. In essence, it does the same things as the respective function in <a class="el" href="step_31.html">step-31</a> . However, there are a few changes here. <br  />
 The first change is related to the way we store our solution: we keep the vectors with locally owned degrees of freedom plus ghost nodes on each MPI node. When we enter a solver which is supposed to perform matrix-vector products with a distributed matrix, this is not the appropriate form, though. There, we will want to have the solution vector to be distributed in the same way as the matrix, i.e. without any ghosts. So what we do first is to generate a distributed vector called <code>distributed_stokes_solution</code> and put only the locally owned dofs into that, which is neatly done by the <code>operator=</code> of the Trilinos vector. <br  />
 Next, we scale the pressure solution (or rather, the initial guess) for the solver so that it matches with the length scales in the matrices, as discussed in the introduction. We also immediately scale the pressure solution back to the correct units after the solution is completed. We also need to set the pressure values at hanging nodes to zero. This we also did in <a class="el" href="step_31.html">step-31</a> in order not to disturb the Schur complement by some vector entries that actually are irrelevant during the solve stage. As a difference to <a class="el" href="step_31.html">step-31</a> , here we do it only for the locally owned pressure dofs. After solving for the Stokes solution, each processor copies the distributed solution back into the solution vector that also includes ghost elements. <br  />
 The third and most obvious change is that we have two variants for the Stokes solver: A fast solver that sometimes breaks down, and a robust solver that is slower. This is what we already discussed in the introduction. Here is how we realize it: First, we perform 30 iterations with the fast solver based on the simple preconditioner based on the AMG V-cycle instead of an approximate solve (this is indicated by the <code>false</code> argument to the <code>LinearSolvers::BlockSchurPreconditioner</code> object). If we converge, everything is fine. If we do not converge, the solver control object will throw an exception <a class="el" href="classSolverControl_1_1NoConvergence.html">SolverControl::NoConvergence</a>. Usually, this would abort the program because we don't catch them in our usual <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code> functions. This is certainly not what we want to happen here. Rather, we want to switch to the strong solver and continue the solution process with whatever vector we got so far. Hence, we catch the exception with the C++ try/catch mechanism. We then simply go through the same solver sequence again in the <code>catch</code> clause, this time passing the <code>true</code> flag to the preconditioner for the strong solver, signaling an approximate CG solve.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">BoussinesqFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                     <span class="stringliteral">&quot;   Solve Stokes system&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Solving Stokes system... &quot;</span> &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distributed_stokes_solution(</div>
<div class="line">      stokes_rhs);</div>
<div class="line">    distributed_stokes_solution = stokes_solution;</div>
<div class="line"> </div>
<div class="line">    distributed_stokes_solution.block(1) /= <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span></div>
<div class="line">      <a class="code" href="timer__0_8txt.html#a48e9e3a8116df3cc4b62db810904e91f">start</a> = (distributed_stokes_solution.block(0).size() +</div>
<div class="line">               distributed_stokes_solution.block(1).local_range().first),</div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a>   = (distributed_stokes_solution.block(0).size() +</div>
<div class="line">             distributed_stokes_solution.block(1).local_range().second);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = <a class="code" href="timer__0_8txt.html#a48e9e3a8116df3cc4b62db810904e91f">start</a>; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (stokes_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">        distributed_stokes_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classPrimitiveVectorMemory.html">PrimitiveVectorMemory&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> mem;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  n_iterations     = 0;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>  solver_tolerance = 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-8 stokes_rhs.l2_norm();</div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(30, solver_tolerance);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">try</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">          <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div>
<div class="line">          <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix,</div>
<div class="line">                         stokes_preconditioner_matrix,</div>
<div class="line">                        Mp_preconditioner,</div>
<div class="line">                        Amg_preconditioner,</div>
<div class="line">                         <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverFGMRES.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(</div>
<div class="line">          solver_control,</div>
<div class="line">          mem,</div>
<div class="line">          <a class="code" href="structSolverFGMRES_1_1AdditionalData.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">            30));</div>
<div class="line">        <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix,</div>
<div class="line">                     distributed_stokes_solution,</div>
<div class="line">                     stokes_rhs,</div>
<div class="line">                     <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">        n_iterations = solver_control.last_step();</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">catch</span> (<a class="code" href="classSolverControl_1_1NoConvergence.html">SolverControl::NoConvergence</a> &amp;)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">          <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">TrilinosWrappers::PreconditionAMG</a>,</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a>&gt;</div>
<div class="line">          <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(stokes_matrix,</div>
<div class="line">                         stokes_preconditioner_matrix,</div>
<div class="line">                        Mp_preconditioner,</div>
<div class="line">                        Amg_preconditioner,</div>
<div class="line">                         <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverControl.html">SolverControl</a> solver_control_refined(stokes_matrix.m(),</div>
<div class="line">                                             solver_tolerance);</div>
<div class="line">        <a class="code" href="classSolverFGMRES.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(</div>
<div class="line">          solver_control_refined,</div>
<div class="line">          mem,</div>
<div class="line">          <a class="code" href="structSolverFGMRES_1_1AdditionalData.html">SolverFGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">            50));</div>
<div class="line">        <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(stokes_matrix,</div>
<div class="line">                     distributed_stokes_solution,</div>
<div class="line">                     stokes_rhs,</div>
<div class="line">                     <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">        n_iterations =</div>
<div class="line">          (solver_control.last_step() + solver_control_refined.last_step());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    stokes_constraints.distribute(distributed_stokes_solution);</div>
<div class="line"> </div>
<div class="line">    distributed_stokes_solution.block(1)= <a class="code" href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">EquationData::pressure_scaling</a>;</div>
<div class="line"> </div>
<div class="line">    stokes_solution = distributed_stokes_solution;</div>
<div class="line">    pcout &lt;&lt; n_iterations &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Now let's turn to the temperature part: First, we compute the time step size. We found that we need smaller time steps for 3D than for 2D for the shell geometry. This is because the cells are more distorted in that case (it is the smallest edge length that determines the CFL number). Instead of computing the time step from maximum velocity and minimal mesh size as in <a class="el" href="step_31.html">step-31</a> , we compute local CFL numbers, i.e., on each cell we compute the maximum velocity times the mesh size, and compute the maximum of them. Hence, we need to choose the factor in front of the time step slightly smaller. <br  />
 After temperature right hand side assembly, we solve the linear system for temperature (with fully distributed vectors without any ghosts), apply constraints and copy the vector back to one with ghosts. <br  />
 In the end, we extract the temperature range similarly to <a class="el" href="step_31.html">step-31</a> to produce some output (for example in order to help us choose the stabilization constants, as discussed in the introduction). The only difference is that we need to exchange maxima over all processors.</p>
<div class="fragment"><div class="line">     {</div>
<div class="line">       <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                        <span class="stringliteral">&quot;   Assemble temperature rhs&quot;</span>);</div>
<div class="line">  </div>
<div class="line">       old_time_step = time_step;</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> scaling = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3 ? 0.25 : 1.0);</div>
<div class="line">       time_step            = (scaling / (2.1 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(1. <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)) /</div>
<div class="line">                    (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree get_cfl_number()));</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> maximal_velocity = get_maximal_velocity();</div>
<div class="line">       pcout &lt;&lt; <span class="stringliteral">&quot;   Maximal velocity: &quot;</span></div>
<div class="line">             &lt;&lt; maximal_velocity <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> 100</div>
<div class="line">             &lt;&lt; <span class="stringliteral">&quot; cm/year&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">       pcout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span></div>
<div class="line">             &lt;&lt; <span class="stringliteral">&quot;Time step: &quot;</span> &lt;&lt; time_step / <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a></div>
<div class="line">             &lt;&lt; <span class="stringliteral">&quot; years&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  </div>
<div class="line">       temperature_solution = old_temperature_solution;</div>
<div class="line">       assemble_temperature_system(maximal_velocity);</div>
<div class="line">     }</div>
<div class="line">  </div>
<div class="line">     {</div>
<div class="line">       <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                        <span class="stringliteral">&quot;   Solve temperature system&quot;</span>);</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(temperature_matrix.m(),</div>
<div class="line">                                    1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12 temperature_rhs.l2_norm());</div>
<div class="line">       <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temperature_solution(</div>
<div class="line">         temperature_rhs);</div>
<div class="line">       distributed_temperature_solution = temperature_solution;</div>
<div class="line">  </div>
<div class="line">       cg.solve(temperature_matrix,</div>
<div class="line">                distributed_temperature_solution,</div>
<div class="line">                temperature_rhs,</div>
<div class="line">               T_preconditioner);</div>
<div class="line">  </div>
<div class="line">       temperature_constraints.distribute(distributed_temperature_solution);</div>
<div class="line">       temperature_solution = distributed_temperature_solution;</div>
<div class="line">  </div>
<div class="line">       pcout &lt;&lt; <span class="stringliteral">&quot;   &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">             &lt;&lt; <span class="stringliteral">&quot; CG iterations for temperature&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  </div>
<div class="line">       <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[2] = {<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>()};</div>
<div class="line">       <span class="keywordtype">double</span> global_temperature[2];</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> =</div>
<div class="line">              distributed_temperature_solution.local_range().first;</div>
<div class="line">            <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; distributed_temperature_solution.local_range().second;</div>
<div class="line">            ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">         {</div>
<div class="line">           <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0] =</div>
<div class="line">             std::min&lt;double&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0],</div>
<div class="line">                              distributed_temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">           <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[1] =</div>
<div class="line">             std::max&lt;double&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[1],</div>
<div class="line">                              distributed_temperature_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>));</div>
<div class="line">         }</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>[0]=</div>
<div class="line">  </div>
<div class="line">-1.0;</div>
<div class="line">       <a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>, MPI_COMM_WORLD, global_temperature);</div>
<div class="line">       global_temperature[0]=</div>
<div class="line">  </div>
<div class="line">-1.0;</div>
<div class="line">  </div>
<div class="line">       pcout &lt;&lt; <span class="stringliteral">&quot;   Temperature range: &quot;</span> &lt;&lt; global_temperature[0] &lt;&lt; <span class="charliteral">&#39; &#39;</span></div>
<div class="line">             &lt;&lt; global_temperature[1] &lt;&lt; std::endl;</div>
<div class="line">     }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemoutput_results"></a> </p><h4>BoussinesqFlowProblem::output_results</h4>
<p>Next comes the function that generates the output. The quantities to output could be introduced manually like we did in <a class="el" href="step_31.html">step-31</a> . An alternative is to hand this task over to a class PostProcessor that inherits from the class <a class="el" href="classDataPostprocessor.html">DataPostprocessor</a>, which can be attached to <a class="el" href="classDataOut.html">DataOut</a>. This allows us to output derived quantities from the solution, like the friction heating included in this example. It overloads the virtual function <a class="el" href="classDataPostprocessor.html#a1ba57b598d24d64365d469a854271c68">DataPostprocessor::evaluate_vector_field()</a>, which is then internally called from <a class="el" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches()</a>. We have to give it values of the numerical solution, its derivatives, normals to the cell, the actual evaluation points and any additional quantities. This follows the same procedure as discussed in <a class="el" href="step_29.html">step-29</a> and other programs.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>BoussinesqFlowProblem&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::Postprocessor</div>
<div class="line">  : <span class="keyword">public</span> <a class="code" href="classDataPostprocessor.html">DataPostprocessor</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  Postprocessor(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> minimal_pressure);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classDataPostprocessor.html#a1ba57b598d24d64365d469a854271c68">evaluate_vector_field</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Vector.html">DataPostprocessorInputs::Vector&lt;dim&gt;</a> &amp;inputs,</div>
<div class="line">    <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;computed_quantities) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> std::vector&lt;std::string&gt; <a class="code" href="classDataPostprocessor.html#a254f38bcdf4bdb5aa94231b695da7d55">get_names</a>() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0">DataComponentInterpretation::DataComponentInterpretation</a>&gt;</div>
<div class="line">  <a class="code" href="classDataPostprocessor.html#ae994223acf8a16471ab5e579a4d75053">get_data_component_interpretation</a>() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a> <a class="code" href="classDataPostprocessor.html#aadecdd040447b395164397ea1196f721">get_needed_update_flags</a>() <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       minimal_pressure;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::Postprocessor(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       minimal_pressure)</div>
<div class="line">  : <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>(<a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>)</div>
<div class="line">  , minimal_pressure(minimal_pressure)</div>
<div class="line">{}</div>
</div><!-- fragment --><p>Here we define the names for the variables we want to output. These are the actual solution values for velocity, pressure, and temperature, as well as the friction heating and to each cell the number of the processor that owns it. This allows us to visualize the partitioning of the domain among the processors. Except for the velocity, which is vector-valued, all other quantities are scalar.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::vector&lt;std::string&gt;</div>
<div class="line"><a class="code" href="data__postprocessor__0_8txt.html#afb21caeba7bf26aba89ce705266fedb1">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_names</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;std::string&gt; solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;p&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;T&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;friction_heating&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;partition&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> solution_names;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_data_component_interpretation()<span class="keyword"></span></div>
<div class="line"><span class="keyword">  const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    interpretation(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">                   <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line"> </div>
<div class="line">  interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  interpretation.push_back(<a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> interpretation;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a></div>
<div class="line"><a class="code" href="data__postprocessor__0_8txt.html#abfdf708e97518fa7ad2b849b80afddc1">BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::get_needed_update_flags</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now we implement the function that computes the derived quantities. As we also did for the output, we rescale the velocity from its SI units to something more readable, namely cm/year. Next, the pressure is scaled to be between 0 and the maximum pressure. This makes it more easily comparable</p>
<ul>
<li>in essence making all pressure variables positive or zero. Temperature is taken as is, and the friction heating is computed as \(2 \eta \varepsilon(\mathbf{u}) \cdot \varepsilon(\mathbf{u})\) . <br  />
 The quantities we output here are more for illustration, rather than for actual scientific value. We come back to this briefly in the results section of this program and explain what one may in fact be interested in.</li>
</ul>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::Postprocessor::evaluate_vector_field(</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Vector.html">DataPostprocessorInputs::Vector&lt;dim&gt;</a> &amp;inputs,</div>
<div class="line">     <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;               computed_quantities)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_quadrature_points = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>.size();</div>
<div class="line">     <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a2a918d936d56f2be4cdad1b8074c3a86">solution_gradients</a>.size() == n_quadrature_points,</div>
<div class="line">            <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">     <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(computed_quantities.size() == n_quadrature_points,</div>
<div class="line">            <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">     <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[0].size() == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 2, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_quadrature_points; ++q)</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">           computed_quantities[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>) = (inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">                                        <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> 100);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a> =</div>
<div class="line">           (inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)</div>
<div class="line">  </div>
<div class="line">- minimal_pressure);</div>
<div class="line">         computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) = <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>        = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">solution_values</a>[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">         computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1) = <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a>;</div>
<div class="line">  </div>
<div class="line">         <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> grad_u;</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">           grad_u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = inputs.<a class="code" href="structDataPostprocessorInputs_1_1Vector.html#a2a918d936d56f2be4cdad1b8074c3a86">solution_gradients</a>[q][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>];</div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a> strain_rate = <a class="code" href="classSymmetricTensor.html#a1b2101a1d45267f1fd4664ed178cb636">symmetrize</a>(grad_u);</div>
<div class="line">         computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 2) =</div>
<div class="line">           2 <a class="code" href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">EquationData::eta</a> strain_rate strain_rate;</div>
<div class="line">  </div>
<div class="line">         computed_quantities[q](<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 3) = <a class="code" href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a>;</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p>The <code>output_results()</code> function has a similar task to the one in <a class="el" href="step_31.html">step-31</a> . However, here we are going to demonstrate a different technique on how to merge output from different <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. The way we're going to achieve this recombination is to create a joint <a class="el" href="classDoFHandler.html">DoFHandler</a> that collects both components, the Stokes solution and the temperature solution. This can be nicely done by combining the finite elements from the two systems to form one <a class="el" href="classFESystem.html">FESystem</a>, and let this collective system define a new <a class="el" href="classDoFHandler.html">DoFHandler</a> object. To be sure that everything was done correctly, we perform a sanity check that ensures that we got all the dofs from both Stokes and temperature even in the combined system. We then combine the data vectors. Unfortunately, there is no straight-forward relation that tells us how to sort Stokes and temperature vector into the joint vector. The way we can get around this trouble is to rely on the information collected in the <a class="el" href="classFESystem.html">FESystem</a>. For each dof on a cell, the joint finite element knows to which equation component (velocity component, pressure, or temperature) it belongs – that's the information we need! So we step through all cells (with iterators into all three DoFHandlers moving in sync), and for each joint cell dof, we read out that component using the <a class="el" href="classFiniteElement.html#a95ac75dfc5b9f4e01c34d5865b4ca5a2">FiniteElement::system_to_base_index</a> function (see there for a description of what the various parts of its return value contain). We also need to keep track whether we're on a Stokes dof or a temperature dof, which is contained in joint_fe.system_to_base_index(i).first.first. Eventually, the dof_indices data structures on either of the three systems tell us how the relation between global vector and local dofs looks like on the present cell, which concludes this tedious work. We make sure that each processor only works on the subdomain it owns locally (and not on ghost or artificial cells) when building the joint solution vector. The same will then have to be done in <a class="el" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches()</a>, but that function does so automatically. <br  />
 What we end up with is a set of patches that we can write using the functions in <a class="el" href="namespaceDataOutBase.html">DataOutBase</a> in a variety of output formats. Here, we then have to pay attention that what each processor writes is really only its own part of the domain, i.e. we will want to write each processor's contribution into a separate file. This we do by adding an additional number to the filename when we write the solution. This is not really new, we did it similarly in <a class="el" href="step_40.html">step-40</a> . Note that we write in the compressed format <code></code>.vtu instead of plain vtk files, which saves quite some storage. <br  />
 All the rest of the work is done in the PostProcessor class.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> BoussinesqFlowProblem&lt;dim&gt;::output_results()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer, <span class="stringliteral">&quot;Postprocessing&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> joint_fe(stokes_fe, 1, temperature_fe, 1);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> joint_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">  joint_dof_handler.distribute_dofs(joint_fe);</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_dof_handler.n_dofs() ==</div>
<div class="line">           stokes_dof_handler.n_dofs() + temperature_dof_handler.n_dofs(),</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> joint_solution;</div>
<div class="line">  joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a655ae9c8d3595133abe1131fcbb97b6d">reinit</a>(joint_dof_handler.locally_owned_dofs(),</div>
<div class="line">                        MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_joint_dof_indices(</div>
<div class="line">      joint_fe.n_dofs_per_cell());</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_stokes_dof_indices(</div>
<div class="line">      stokes_fe.n_dofs_per_cell());</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_temperature_dof_indices(</div>
<div class="line">      temperature_fe.n_dofs_per_cell());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;::active_cell_iterator</a></div>
<div class="line">      joint_cell       = joint_dof_handler.<a class="code" href="classDoFHandler.html#a9a3bef554c6d22abe312e10e9475eecf">begin_active</a>(),</div>
<div class="line">      joint_endc       = joint_dof_handler.end(),</div>
<div class="line">      stokes_cell      = stokes_dof_handler.begin_active(),</div>
<div class="line">      temperature_cell = temperature_dof_handler.begin_active();</div>
<div class="line">    <span class="keywordflow">for</span> (; joint_cell != joint_endc;</div>
<div class="line">         ++joint_cell, ++stokes_cell, ++temperature_cell)</div>
<div class="line">      <span class="keywordflow">if</span> (joint_cell-&gt;is_locally_owned())</div>
<div class="line">        {</div>
<div class="line">          joint_cell-&gt;get_dof_indices(local_joint_dof_indices);</div>
<div class="line">          stokes_cell-&gt;get_dof_indices(local_stokes_dof_indices);</div>
<div class="line">          temperature_cell-&gt;get_dof_indices(local_temperature_dof_indices);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; joint_fe.n_dofs_per_cell(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">if</span> (joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 0)</div>
<div class="line">              {</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                         local_stokes_dof_indices.size(),</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">                joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) = stokes_solution(</div>
<div class="line">                  local_stokes_dof_indices[joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                                             .second]);</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              {</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 1,</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                         local_temperature_dof_indices.size(),</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) =</div>
<div class="line">                  temperature_solution(</div>
<div class="line">                    local_temperature_dof_indices</div>
<div class="line">                      [joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second]);</div>
<div class="line">              }</div>
<div class="line">        }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a7221ae06689832b475206ef54efaf0a6">compress</a>(<a class="code" href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964caf4784f9368d9386d7508c25daea9e19d">VectorOperation::insert</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_joint_dofs(joint_dof_handler.n_dofs());</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(joint_dof_handler,</div>
<div class="line">                                          locally_relevant_joint_dofs);</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> locally_relevant_joint_solution;</div>
<div class="line">  locally_relevant_joint_solution.<a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a655ae9c8d3595133abe1131fcbb97b6d">reinit</a>(locally_relevant_joint_dofs,</div>
<div class="line">                                         MPI_COMM_WORLD);</div>
<div class="line">  locally_relevant_joint_solution = joint_solution;</div>
<div class="line"> </div>
<div class="line">  Postprocessor <a class="code" href="data__postprocessor__0_8txt.html#a80e53cb52e5dbb182dd14ee528927a77">postprocessor</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(</div>
<div class="line">                                MPI_COMM_WORLD),</div>
<div class="line">                              stokes_solution.block(1).min());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(joint_dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(locally_relevant_joint_solution, <a class="code" href="data__postprocessor__0_8txt.html#a80e53cb52e5dbb182dd14ee528927a77">postprocessor</a>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">int</span> out_index = 0;</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div>
<div class="line">    <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, out_index, MPI_COMM_WORLD, 5);</div>
<div class="line"> </div>
<div class="line">  out_index++;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemrefine_mesh"></a> </p><h4>BoussinesqFlowProblem::refine_mesh</h4>
<p>This function isn't really new either. Since the <code>setup_dofs</code> function that we call in the middle has its own timer section, we split timing this function into two sections. It will also allow us to easily identify which of the two is more expensive. <br  />
 One thing of note, however, is that we only want to compute error indicators on the locally owned subdomain. In order to achieve this, we pass one additional argument to the <a class="el" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a> function. Note that the vector for error estimates is resized to the number of active cells present on the current process, which is less than the total number of active cells on all processors (but more than the number of locally owned active cells); each processor only has a few coarse cells around the locally owned ones, as also explained in <a class="el" href="step_40.html">step-40</a> . <br  />
 The local error estimates are then handed to a parallel version of <a class="el" href="namespaceGridRefinement.html">GridRefinement</a> (in namespace <a class="el" href="namespaceparallel_1_1distributed_1_1GridRefinement.html">parallel::distributed::GridRefinement</a>, see also <a class="el" href="step_40.html">step-40</a> ) which looks at the errors and finds the cells that need refinement by comparing the error values across processors. As in <a class="el" href="step_31.html">step-31</a> , we want to limit the maximum grid level. So in case some cells have been marked that are already at the finest level, we simply clear the refine flags.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span></div>
<div class="line">   BoussinesqFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a></div>
<div class="line">       temperature_trans(temperature_dof_handler);</div>
<div class="line">     <a class="code" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>,</div>
<div class="line">                                             <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a>&gt;</div>
<div class="line">       stokes_trans(stokes_dof_handler);</div>
<div class="line">  </div>
<div class="line">     {</div>
<div class="line">       <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                        <span class="stringliteral">&quot;Refine mesh structure, part 1&quot;</span>);</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">         temperature_dof_handler,</div>
<div class="line">         <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt;(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 1),</div>
<div class="line">         <a class="code" href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">std::map</a>&lt;<a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a>&gt;(),</div>
<div class="line">         temperature_solution,</div>
<div class="line">         estimated_error_per_cell,</div>
<div class="line">         <a class="code" href="classComponentMask.html">ComponentMask</a>(),</div>
<div class="line">         <span class="keyword">nullptr</span>,</div>
<div class="line">         0,</div>
<div class="line">         <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.locally_owned_subdomain());</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="namespaceparallel_1_1distributed_1_1GridRefinement.html#ae5159e3207f6786f0749fc0b66ab8ca3">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_fraction</a>(</div>
<div class="line">         <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, estimated_error_per_cell, 0.3, 0.1);</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">if</span> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> =</div>
<div class="line">                <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.begin_active(max_grid_level);</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.end();</div>
<div class="line">              ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">           <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
</div><!-- fragment --><p>With all flags marked as necessary, we can then tell the <a class="el" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a> objects to get ready to transfer data from one mesh to the next, which they will do when notified by <a class="el" href="classTriangulation.html">Triangulation</a> as part of the <code>execute_coarsening_and_refinement()</code> call. The syntax is similar to the non-parallel solution transfer (with the exception that here a pointer to the vector entries is enough). The remainder of the function further down below is then concerned with setting up the data structures again after mesh refinement and restoring the solution vectors on the new mesh.</p>
<div class="fragment"><div class="line">  std::vector&lt;const TrilinosWrappers::MPI::Vector&gt; x_temperature(2);</div>
<div class="line">  x_temperature[0] = &amp;temperature_solution;</div>
<div class="line">  x_temperature[1] = &amp;old_temperature_solution;</div>
<div class="line">  std::vector&lt;const TrilinosWrappers::MPI::BlockVector&gt; x_stokes(2);</div>
<div class="line">  x_stokes[0] = &amp;stokes_solution;</div>
<div class="line">  x_stokes[1] = &amp;old_stokes_solution;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">  temperature_trans.prepare_for_coarsening_and_refinement(x_temperature);</div>
<div class="line">  stokes_trans.prepare_for_coarsening_and_refinement(x_stokes);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">setup_dofs();</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a> timer_section(computing_timer,</div>
<div class="line">                                   <span class="stringliteral">&quot;Refine mesh structure, part 2&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temp1(temperature_rhs);</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distributed_temp2(temperature_rhs);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp(2);</div>
<div class="line">    tmp[0] = &amp;(distributed_temp1);</div>
<div class="line">    tmp[1] = &amp;(distributed_temp2);</div>
<div class="line">    temperature_trans.interpolate(tmp);</div>
</div><!-- fragment --><p>enforce constraints to make the interpolated solution conforming on the new mesh:</p>
<div class="fragment"><div class="line">  temperature_constraints.distribute(distributed_temp1);</div>
<div class="line">  temperature_constraints.distribute(distributed_temp2);</div>
<div class="line"> </div>
<div class="line">  temperature_solution     = distributed_temp1;</div>
<div class="line">  old_temperature_solution = distributed_temp2;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distributed_stokes(stokes_rhs);</div>
<div class="line">  <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_distributed_stokes(stokes_rhs);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; stokes_tmp(2);</div>
<div class="line">  stokes_tmp[0] = &amp;(distributed_stokes);</div>
<div class="line">  stokes_tmp[1] = &amp;(old_distributed_stokes);</div>
<div class="line"> </div>
<div class="line">  stokes_trans.interpolate(stokes_tmp);</div>
</div><!-- fragment --><p>enforce constraints to make the interpolated solution conforming on the new mesh:</p>
<div class="fragment"><div class="line">      stokes_constraints.distribute(distributed_stokes);</div>
<div class="line">      stokes_constraints.distribute(old_distributed_stokes);</div>
<div class="line"> </div>
<div class="line">      stokes_solution     = distributed_stokes;</div>
<div class="line">      old_stokes_solution = old_distributed_stokes;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="BoussinesqFlowProblemrun"></a> </p><h4>BoussinesqFlowProblem::run</h4>
<p>This is the final and controlling function in this class. It, in fact, runs the entire rest of the program and is, once more, very similar to <a class="el" href="step_31.html">step-31</a> . The only substantial difference is that we use a different mesh now (a <a class="el" href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell</a> instead of a simple cube geometry).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">BoussinesqFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                             <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(),</div>
<div class="line">                             <a class="code" href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">EquationData::R0</a>,</div>
<div class="line">                             <a class="code" href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">EquationData::R1</a>,</div>
<div class="line">                             (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3) ? 96 : 12,</div>
<div class="line">                             <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">  global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement);</div>
<div class="line"> </div>
<div class="line">  setup_dofs();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">start_time_iteration:</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>(</div>
<div class="line">      temperature_dof_handler.locally_owned_dofs());</div>
</div><!-- fragment --> <pre class="fragment">VectorTools::project   supports parallel vector classes with most standard finite elements via deal.II's own native MatrixFree framework: since we use standard Lagrange elements of moderate order this function works well here.
</pre><div class="fragment"><div class="line"><a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(temperature_dof_handler,</div>
<div class="line">                     temperature_constraints,</div>
<div class="line">                     <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.temperature_degree + 2),</div>
<div class="line">                     EquationData::TemperatureInitialValues&lt;dim&gt;(),</div>
<div class="line">                     <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
</div><!-- fragment --><p>Having so computed the current temperature field, let us set the member variable that holds the temperature nodes. Strictly speaking, we really only need to set <code>old_temperature_solution</code> since the first thing we will do is to compute the Stokes solution that only requires the previous time step's temperature field. That said, nothing good can come from not initializing the other vectors as well (especially since it's a relatively cheap operation and we only have to do it once at the beginning of the program) if we ever want to extend our numerical method or physical model, and so we initialize <code>old_temperature_solution</code> and <code>old_old_temperature_solution</code> as well. The assignment makes sure that the vectors on the left hand side (which where initialized to contain ghost elements as well) also get the correct ghost elements. In other words, the assignment here requires communication between processors:</p>
<div class="fragment"><div class="line">  temperature_solution         = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  old_temperature_solution     = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  old_old_temperature_solution = <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">timestep_number = 0;</div>
<div class="line">time_step = old_time_step = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">do</span></div>
<div class="line">  {</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> / <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a> &lt;&lt; <span class="stringliteral">&quot; years&quot;</span></div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    assemble_stokes_system();</div>
<div class="line">    build_stokes_preconditioner();</div>
<div class="line">    assemble_temperature_matrix();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">        (pre_refinement_step &lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement))</div>
<div class="line">      {</div>
<div class="line">        refine_mesh(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement +</div>
<div class="line">                    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement);</div>
<div class="line">        ++pre_refinement_step;</div>
<div class="line">        <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp;</div>
<div class="line">             (timestep_number % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.adaptive_refinement_interval ==</div>
<div class="line">              0))</div>
<div class="line">      refine_mesh(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_global_refinement +</div>
<div class="line">                  <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.initial_adaptive_refinement);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.generate_graphical_output == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">        (timestep_number % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.graphical_output_interval == 0))</div>
<div class="line">      output_results();</div>
</div><!-- fragment --><p>In order to speed up linear solvers, we extrapolate the solutions from the old time levels to the new one. This gives a very good initial guess, cutting the number of iterations needed in solvers by more than one half. We do not need to extrapolate in the last iteration, so if we reached the final time, we stop here. <br  />
 As the last thing during a time step (before actually bumping up the number of the time step), we check whether the current time step number is divisible by 100, and if so we let the computing timer print a summary of CPU times spent so far.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &gt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.end_time <a class="code" href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">EquationData::year_in_seconds</a>)</div>
<div class="line">  <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> old_old_stokes_solution;</div>
<div class="line">old_old_stokes_solution      = old_stokes_solution;</div>
<div class="line">old_stokes_solution          = stokes_solution;</div>
<div class="line">old_old_temperature_solution = old_temperature_solution;</div>
<div class="line">old_temperature_solution     = temperature_solution;</div>
<div class="line"><span class="keywordflow">if</span> (old_time_step &gt; 0)</div>
<div class="line">  {</div>
</div><!-- fragment --><p>Trilinos sadd does not like ghost vectors even as input. Copy into distributed vectors for now:</p>
<div class="fragment"><div class="line">             {</div>
<div class="line">               <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distr_solution(stokes_rhs);</div>
<div class="line">               distr_solution = stokes_solution;</div>
<div class="line">               <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> distr_old_solution(stokes_rhs);</div>
<div class="line">               distr_old_solution = old_old_stokes_solution;</div>
<div class="line">               distr_solution.<a class="code" href="classBlockVectorBase.html#a71b0ab8295e98caf3dfe1ef14ae6b6c1">sadd</a>(1. + time_step / old_time_step,</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-time_step / old_time_step,</div>
<div class="line">                                   distr_old_solution);</div>
<div class="line">               stokes_solution = distr_solution;</div>
<div class="line">             }</div>
<div class="line">             {</div>
<div class="line">               <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distr_solution(temperature_rhs);</div>
<div class="line">               distr_solution = temperature_solution;</div>
<div class="line">               <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> distr_old_solution(temperature_rhs);</div>
<div class="line">               distr_old_solution = old_old_temperature_solution;</div>
<div class="line">               distr_solution.sadd(1. + time_step / old_time_step,</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-time_step / old_time_step,</div>
<div class="line">                                   distr_old_solution);</div>
<div class="line">               temperature_solution = distr_solution;</div>
<div class="line">             }</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 100 == 0))</div>
<div class="line">           computing_timer.print_summary();</div>
<div class="line">  </div>
<div class="line">         <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">         ++timestep_number;</div>
<div class="line">       }</div>
<div class="line">     <span class="keywordflow">while</span> (<span class="keyword">true</span>);</div>
</div><!-- fragment --><p>If we are generating graphical output, do so also for the last time step unless we had just done so before we left the do-while loop</p>
<div class="fragment"><div class="line">     <span class="keywordflow">if</span> ((<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.generate_graphical_output == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">         !((timestep_number</div>
<div class="line">  </div>
<div class="line">- 1) % <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>.graphical_output_interval == 0))</div>
<div class="line">       output_results();</div>
<div class="line">   }</div>
<div class="line"> } <span class="comment">// namespace Step32</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>The main function is short as usual and very similar to the one in <a class="el" href="step_31.html">step-31</a> . Since we use a parameter file which is specified as an argument in the command line, we have to read it in here and pass it on to the Parameters class for parsing. If no filename is given in the command line, we simply use the <code>step-32.prm</code> file which is distributed together with the program.</p>
<p>Because 3d computations are simply very slow unless you throw a lot of processors at them, the program defaults to 2d. You can get the 3d version by changing the constant dimension below to 3.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, charargv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep32.html">Step32</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      std::string parameter_filename;</div>
<div class="line">      <span class="keywordflow">if</span> (argc &gt;= 2)</div>
<div class="line">        parameter_filename = argv[1];</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        parameter_filename = <span class="stringliteral">&quot;step-32.prm&quot;</span>;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">int</span>                              <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> = 2;</div>
<div class="line">      <a class="code" href="structStep32_1_1BoussinesqFlowProblem_1_1Parameters.html">BoussinesqFlowProblem&lt;dim&gt;::Parameters</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>(parameter_filename);</div>
<div class="line">      BoussinesqFlowProblem&lt;dim&gt;             flow_problem(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a>);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>When run, the program simulates convection in 3d in much the same wayas <a class="el" href="step_31.html">step-31</a> did, though with an entirely different testcase.</p>
<p><a class="anchor" id="Comparisonofresultswithstep31"></a></p><h3>Comparison of results with step-31</h3>
<p>Before we go to this testcase, however, let us show a few results from aslightly earlier version of this program that was solving exactly thetestcase we used in <a class="el" href="step_31.html">step-31</a> , just that we now solve it in parallel and withmuch higher resolution. We show these results mainly for comparison. Here are two images that show this higher resolution if we choose a 3dcomputation in <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> and if we set <code>initial_refinement=3</code> and <code>n_pre_refinement_steps=4</code> . At the time steps shown, themeshes had around 72,000 and 236,000 cells, for a total of 2,680,000and 8,250,000 degrees of freedom, respectively, more than an order ofmagnitude more than we had available in <a class="el" href="step_31.html">step-31</a> : </p><table align="center" class="doxtable">
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32.3d.cube.0.png" alt="" class="inline"/>   </td></tr>
<tr>
<td><img src="https://www.dealii.org/images/steps/developer/step-32.3d.cube.1.png" alt="" class="inline"/>   </td></tr>
</table>
<p><br  />
 The computation was done on a subset of 50 processors of the Brazoscluster at Texas A&amp;M University.</p>
<p><a class="anchor" id="Resultsfora2dcircularshelltestcase"></a></p><h3>Results for a 2d circular shell testcase</h3>
<p>Next, we will run <a class="el" href="step_32.html">step-32</a> with the parameter file in the directory with onechange: we increase the final time to 1e9. Here we are using 16 processors. Thecommand to launch is (note that <a class="el" href="step_32.html">step-32</a> .prm is the default): <code></p><pre>\ \( mpirun -np 16 ./step-32 &lt;/pre&gt; &lt;/code&gt; Note that running a job on a cluster typically requires going through a job scheduler, which we won&#39;t discuss here. The output will look roughly like this: &lt;code&gt; &lt;pre&gt; $ mpirun - p 16 ./ @ref step_32 &quot;step-32&quot; Number of active cells: 12,288 (on 6 levels)Number of degrees of freedom: 186,624 (99,840+36,864+49,920) Timestep 0: t=0 years Rebuilding Stokes preconditioner... Solving Stokes system... 41 iterations. Maximal velocity: 60.4935 cm/year Time step: 18166.9 years 17 CG iterations for temperature Temperature range: 973 4273.16 Number of active cells: 15,921 (on 7 levels)Number of degrees of freedom: 252,723 (136,640+47,763+68,320) Timestep 0: t=0 years Rebuilding Stokes preconditioner... Solving Stokes system... 50 iterations. Maximal velocity: 60.3223 cm/year Time step: 10557.6 years 19 CG iterations for temperature Temperature range: 973 4273.16 Number of active cells: 19,926 (on 8 levels)Number of degrees of freedom: 321,246 (174,312+59,778+87,156) Timestep 0: t=0 years Rebuilding Stokes preconditioner... Solving Stokes system... 50 iterations. Maximal velocity: 57.8396 cm/year Time step: 5453.78 years 18 CG iterations for temperature Temperature range: 973 4273.16 Timestep 1: t=5453.78 years Solving Stokes system... 49 iterations. Maximal velocity: 59.0231 cm/year Time step: 5345.86 years 18 CG iterations for temperature Temperature range: 973 4273.16 Timestep 2: t=10799.6 years Solving Stokes system... 24 iterations. Maximal velocity: 60.2139 cm/year Time step: 5241.51 years 17 CG iterations for temperature Temperature range: 973 4273.16 [...] Timestep 100: t=272151 years Solving Stokes system... 21 iterations. Maximal velocity: 161.546 cm/year Time step: 1672.96 years 17 CG iterations for temperature Temperature range: 973 4282.57 Number of active cells: 56,085 (on 8 levels)Number of degrees of freedom: 903,408 (490,102+168,255+245,051) +---------------------------------------------+------------+------------+| Total wallclock time elapsed since start | 115s | || | | || Section | no. calls | wall time | % of total |+---------------------------------+-----------+------------+------------+| Assemble Stokes system | 103 | 2.82s | 2.5% || Assemble temperature matrices | 12 | 0.452s | 0.39% || Assemble temperature rhs | 103 | 11.5s | 10% || Build Stokes preconditioner | 12 | 2.09s | 1.8% || Solve Stokes system | 103 | 90.4s | 79% || Solve temperature system | 103 | 1.53s | 1.3% || Postprocessing | 3 | 0.532s | 0.46% || Refine mesh structure, part 1 | 12 | 0.93s | 0.81% || Refine mesh structure, part 2 | 12 | 0.384s | 0.33% || Setup dof systems | 13 | 2.96s | 2.6% |+---------------------------------+-----------+------------+------------+ [...] +---------------------------------------------+------------+------------+| Total wallclock time elapsed since start | 9.14e+04s | || | | || Section | no. calls | wall time | % of total |+---------------------------------+-----------+------------+------------+| Assemble Stokes system | 47045 | 2.05e+03s | 2.2% || Assemble temperature matrices | 4707 | 310s | 0.34% || Assemble temperature rhs | 47045 | 8.7e+03s | 9.5% || Build Stokes preconditioner | 4707 | 1.48e+03s | 1.6% || Solve Stokes system | 47045 | 7.34e+04s | 80% || Solve temperature system | 47045 | 1.46e+03s | 1.6% || Postprocessing | 1883 | 222s | 0.24% || Refine mesh structure, part 1 | 4706 | 641s | 0.7% || Refine mesh structure, part 2 | 4706 | 259s | 0.28% || Setup dof systems | 4707 | 1.86e+03s | 2% |+---------------------------------+-----------+------------+------------+&lt;/pre&gt;&lt;/code&gt; The simulation terminates when the time reaches the 1 billion yearsselected in the input file. You can extrapolate from this how long asimulation would take for a different final time (the time step sizeultimately settles on somewhere around 20,000 years, so computing fortwo billion years will take 100,000 time steps, give or take 20%). Ascan be seen here, we spend most of the compute time in assemblinglinear systems and &mdash; above all &mdash; in solving Stokessystems. To demonstrate the output we show the output from every 1250th time step here: &lt;table&gt; &lt;tr&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-000.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-050.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-100.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-150.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-200.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-250.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-300.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-350.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-400.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-450.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-500.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-550.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-time-600.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-cells.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;td&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-partition.png&quot; alt=&quot;&quot;&gt; &lt;/td&gt; &lt;/tr&gt; &lt;/table&gt; &lt;br&gt; The last two images show the grid as well as the partitioning of the mesh forthe same computation with 16 subdomains and 16 processors. The full dynamics ofthis simulation are really only visible by looking at an animation, for examplethe one &lt;a href=&quot;https://www.dealii.org/images/steps/developer/step-32-2d-temperature.webm&quot;&gt;shown on this site&lt;/a&gt;. This image is well worth watching due to its artistic qualityand entrancing depiction of the evolution of the magma plumes. If you watch the movie, you&#39;ll see that the convection pattern goesthrough several stages: First, it gets rid of the instable temperaturelayering with the hot material overlain by the dense coldmaterial. After this great driver is removed and we have a sort ofstable situation, a few blobs start to separate from the hot boundarylayer at the inner ring and rise up, with a few cold fingers alsodropping down from the outer boundary layer. During this phase, the solutionremains mostly symmetric, reflecting the 12-fold symmetry of theoriginal mesh. In a final phase, the fluid enters vigorous chaoticstirring in which all symmetries are lost. This is a pattern that thencontinues to dominate flow. These different phases can also be identified if we look at themaximal velocity as a function of time in the simulation: &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32.2d.t_vs_vmax.png&quot; alt=&quot;&quot;&gt; &lt;br&gt; Here, the velocity (shown in centimeters per year) becomes very large,to the order of several meters per year) at the beginning when thetemperature layering is instable. It then calms down to relativelysmall values before picking up again in the chaotic stirringregime. There, it remains in the range of 10-40 centimeters per year,quite within the physically expected region. &lt;a name=&quot;Resultsfora3dsphericalshelltestcase&quot;&gt;&lt;/a&gt;&lt;h3&gt;Results for a 3d spherical shell testcase&lt;/h3&gt; 3d computations are very expensive computationally. Furthermore, asseen above, interesting behavior only starts after quite a long timerequiring more CPU hours than is available on a typicalcluster. Consequently, rather than showing a complete simulation here,let us simply show a couple of pictures we have obtained using thesuccessor to this program, called &lt;i&gt;ASPECT&lt;/i&gt; (short for &lt;i&gt;Advanced %Solver for Problems in Earth&#39;s ConvecTion&lt;/i&gt;), that is beingdeveloped independently of deal.II and that already incorporates someof the extensions discussed below. The following two pictures showisocontours of the temperature and the partition of the domain (alongwith the mesh) onto 512 processors: &lt;p align=&quot;center&quot;&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32.3d-sphere.solution.png&quot; alt=&quot;&quot;&gt; &lt;img src=&quot;https://www.dealii.org/images/steps/developer/step-32.3d-sphere.partition.png&quot; alt=&quot;&quot;&gt; &lt;/p&gt; &lt;br&gt; &lt;a name=&quot;extensions&quot;&gt;&lt;/a&gt;&lt;a name=&quot;Possibilitiesforextensions&quot;&gt;&lt;/a&gt;&lt;h3&gt;Possibilities for extensions&lt;/h3&gt; There are many directions in which this program could be extended. Asmentioned at the end of the introduction, most of these are under activedevelopment in the &lt;i&gt;ASPECT&lt;/i&gt; (short for &lt;i&gt;Advanced %Solver for Problems in Earth&#39;s ConvecTion&lt;/i&gt;) code at the time this tutorial program is beingfinished. Specifically, the following are certainly topics that one shouldaddress to make the program more useful: &lt;ul&gt; &lt;li&gt; &lt;b&gt;Adiabatic heating/cooling:&lt;/b&gt; The temperature field we get in our simulations after a while is mostly constant with boundary layers at the inner and outer boundary, and streamers of cold and hot material mixing everything. Yet, this doesn&#39;t match our expectation that things closer to the earth core should be hotter than closer to the surface. The reason is that the energy equation we have used does not include a term that describes adiabatic cooling and heating: rock, like gas, heats up as you compress it. Consequently, material that rises up cools adiabatically, and cold material that sinks down heats adiabatically. The correct temperature equation would therefore look somewhat like this: @f{eqnarray*} \frac{D T}{Dt} - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma + \tau\frac{Dp}{Dt}, @f} or, expanding the advected derivative \)\frac{D}{Dt} =
  \frac{\partial}{\partial t} + \mathbf u \cdot \nabla \( : @f{eqnarray*} \frac{\partial T}{\partial t} + {\mathbf u} \cdot \nabla T - \nabla \cdot \kappa \nabla T &amp;=&amp; \gamma + \tau\left\{\frac{\partial p}{\partial t} + \mathbf u \cdot \nabla p \right\}. @f} In other words, as pressure increases in a rock volume ( \)\frac{Dp}{Dt}&gt;0 \( ) we get an additional heat source, and vice versa. The time derivative of the pressure is a bit awkward to implement. If necessary, one could approximate using the fact outlined in the introduction that the pressure can be decomposed into a dynamic component due to temperature differences and the resulting flow, and a static component that results solely from the static pressure of the overlying rock. Since the latter is much bigger, one may approximate \)@_fakenlp\approx p_{\text{static}}=-\rho_{\text{ref}}
  [1+\beta T_{\text{ref}}] \varphi \( , and consequently \)\frac{Dp}{Dt} \approx \left\{- \mathbf u \cdot \nabla \rho_{\text{ref}}
  [1+\beta T_{\text{ref}}]\varphi\right\} = \rho_{\text{ref}}
  [1+\beta T_{\text{ref}}] \mathbf u \cdot \mathbf g \( . In other words, if the fluid is moving in the direction of gravity (downward) it will be compressed and because in that case \)\mathbf u
  \cdot \mathbf g &gt; 0 \( we get a positive heat source. Conversely, the fluid will cool down if it moves against the direction of gravity. &lt;li&gt; &lt;b&gt;Compressibility:&lt;/b&gt; As already hinted at in the temperature model above, mantle rocks are not incompressible. Rather, given the enormous pressures in the earth mantle (at the core-mantle boundary, the pressure is approximately 140 GPa, equivalent to 1,400,000 times atmospheric pressure), rock actually does compress to something around 1.5 times the density it would have at surface pressure. Modeling this presents any number of difficulties. Primarily, the mass conservation equation is no longer \)\textrm{div}\;\mathbf u=0 \( but should read \)\textrm{div}(\rho\mathbf u)=0 \( where the density \)\rho \( is now no longer spatially constant but depends on temperature and pressure. A consequence is that the model is now no longer linear; a linearized version of the Stokes equation is also no longer symmetric requiring us to rethink preconditioners and, possibly, even the discretization. We won&#39;t go into detail here as to how this can be resolved. &lt;li&gt; &lt;b&gt;Nonlinear material models:&lt;/b&gt; As already hinted at in various places, material parameters such as the density, the viscosity, and the various thermal parameters are not constant throughout the earth mantle. Rather, they nonlinearly depend on the pressure and temperature, and in the case of the viscosity on the strain rate \)\varepsilon(\mathbf u)
</pre><p></code></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="asparse__vanka__0_8txt_html_a63f572a3b5d8c173a82cee16f5858977"><div class="ttname"><a href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a></div><div class="ttdeci">this elimination is done by the modification of the right hand and in the end these degrees of freedom do not occur in the matrix and solution vector any more at all *This system is solved and the values are updated into the destination vector the matrices are built up such that the degree of freedom associated with the Lagrange multiplier is the first one usually the upper left entry in the matrix is zero It is not clear to so it must persist longer than the Vanka object The same is true for the matrix The matrix[2.x.11] which is passed here may or may not be the same matrix for which this object shall act as preconditioner In it is conceivable that the preconditioner is build up for one matrix but is used for subsequent steps in a nonlinear process as where the matrix changes in each step slightly **Destructor Delete all allocated matrices **Parameters for SparseVanka **Constructor For the parameters see below **Constructor For the parameters see below[2.x.12] The use of this constructor is deprecated **the second and third parameters are ignored **Indices of those degrees of freedom that we shall work on **If the default constructor is used then this function needs to be called before an object of this class is used as preconditioner For more detail about possible parameters see the class documentation and the documentation of the[2.x.13] class After this function is called the preconditioner is ready to be only values for allowed indices are written to[2.x.27] dst</div><div class="ttdef"><b>Definition:</b> <a href="sparse__vanka__0_8txt_source.html#l00060">sparse_vanka_0.txt:60</a></div></div>
<div class="ttc" id="apolynomial__0_8txt_html_af1258c87f1d73d29bd17331843ac1d25"><div class="ttname"><a href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a></div><div class="ttdeci">namespace in which classes relating to the description of d polynomial spaces are declared ***Base class for all D polynomials A polynomial is represented in this class by its coefficients which are set through the constructor or by derived classes There are two paths for evaluation of polynomials One is based on the coefficients which are evaluated through the Horner scheme which is a robust general purpose scheme An alternative and more stable evaluation of high degree polynomials with roots in the unit interval is provided by a product in terms of the roots This form is available for special polynomials such as Lagrange polynomials or Legendre polynomials and used with the respective constructor To obtain this more stable evaluation form the constructor with the roots in form of a Lagrange polynomial must be used In case a manipulation is done that changes the roots the representation is switched to the coefficient form This class is a typical example of a possible template argument for the TensorProductPolynomials class **Constructor The coefficients of the polynomial are passed as and denote the i e the first element of the array denotes the constant the second the linear and so on The degree of the polynomial represented by this object is thus the number of elements in the&lt; tt &gt; coefficient&lt;/tt &gt; array minus one **Constructor creating a zero polynomial of degree *[2.x.3] *Constructor for a Lagrange polynomial and its point of evaluation The idea is to where j is the evaluation point specified as argument and the support points contain all the evaluation is based on products of the whereas the Horner scheme is used for polynomials in the coefficient form **Return the values and the derivatives of the Polynomial at point&lt; tt &gt; x&lt;/tt &gt;&lt; tt &gt; i</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__0_8txt_source.html#l00024">polynomial_0.txt:24</a></div></div>
<div class="ttc" id="alac_2solver__gmres_8h_html"><div class="ttname"><a href="lac_2solver__gmres_8h.html">solver_gmres.h</a></div></div>
<div class="ttc" id="afe_2fe__dgq_8h_html"><div class="ttname"><a href="fe_2fe__dgq_8h.html">fe_dgq.h</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a79cbe2f02f8dfb85026c71d783dbb703"><div class="ttname"><a href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out__dof__data_8h_source.html#l01096">data_out_dof_data.h:1096</a></div></div>
<div class="ttc" id="anamespaceStep31_1_1EquationData_html_aa1e9e1a7297b10cb39c2065f86acc66f"><div class="ttname"><a href="namespaceStep31_1_1EquationData.html#aa1e9e1a7297b10cb39c2065f86acc66f">Step31::EquationData::density</a></div><div class="ttdeci">constexpr double density</div><div class="ttdef"><b>Definition:</b> <a href="step-31_8cc_source.html#l00075">step-31.cc:75</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a3c097e8f7581f3b04d6a31eb66b11c8c"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a3c097e8f7581f3b04d6a31eb66b11c8c">Step32::EquationData::expansion_coefficient</a></div><div class="ttdeci">constexpr double expansion_coefficient</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00093">step-32.cc:93</a></div></div>
<div class="ttc" id="aclassIndexSet_html"><div class="ttname"><a href="classIndexSet.html">IndexSet</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l00068">index_set.h:68</a></div></div>
<div class="ttc" id="aclassDataPostprocessor_html"><div class="ttname"><a href="classDataPostprocessor.html">DataPostprocessor</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__postprocessor_8h_source.html#l00477">data_postprocessor.h:477</a></div></div>
<div class="ttc" id="aclassFEValues_html_a21f914e63d588e2652a9514620653d77"><div class="ttname"><a href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell)</div></div>
<div class="ttc" id="anamespaceLinearAlgebraPETSc_1_1MPI_html_a326d001228d45e600ba97606c24a01c7"><div class="ttname"><a href="namespaceLinearAlgebraPETSc_1_1MPI.html#a326d001228d45e600ba97606c24a01c7">LinearAlgebraPETSc::MPI::PreconditionAMG</a></div><div class="ttdeci">PETScWrappers::PreconditionBoomerAMG PreconditionAMG</div><div class="ttdef"><b>Definition:</b> <a href="lac_2generic__linear__algebra_8h_source.html#l00151">generic_linear_algebra.h:151</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_ad915880b4ba02f609ab427ea61a29d41"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#ad915880b4ba02f609ab427ea61a29d41">Step32::EquationData::year_in_seconds</a></div><div class="ttdeci">const double year_in_seconds</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00168">step-32.cc:168</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00077">fe_update_flags.h:77</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1Vector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__vector_8h_source.html#l00280">trilinos_vector.h:280</a></div></div>
<div class="ttc" id="aclassMappingQ_html"><div class="ttname"><a href="classMappingQ.html">MappingQ&lt; dim &gt;</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_afec1b694405cadb2d251275096ad3563"><div class="ttname"><a href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a></div><div class="ttdeci">if we even only hold bytes per line in this sparsity we ll need GB for this object even if every single line is empty Of only million lines will be non for which we need MB plus whatever is necessary to store the actual column indices of nonzero entries Let s say we have a moderately complex problem with entries per for each of which we store the column index worth then we ll need bytes for each of the million lines that correspond to the degrees of freedom we for a total of GB And we ll need bytes for each of the million lines that we don t for a total of GB It is clear that this ratio doesn t become any better if we go to even higher numbers of processors *The solution to this problem is to really only use any memory at all for those parts of the linear system that we or need for some other reason For all other we must know that they but we can not set up any part of our data structure To this there exists a class called IndexSet that denotes a set of indices which we care for and for which we may have to allocate memory The data structures for sparsity patterns constraint matrices matrices and vector can be initialized with these IndexSet objects to really only care for those rows or entries that correspond to indices in the index set and not care about all others These objects will then ask how many indices exist in the set allocate memory for each one of and when you want to access data for global degree of freedom[2.x.28] you will be redirected to the result of calling[2.x.29] with index[2.x.30] instead Accessing data for elements[2.x.31] for which[2.x.32] is false will yield an error *The remaining question is how to identify the set of indices that correspond to degrees of freedom we need to worry about on each processor To this you can use the[2.x.33] function to get at all the indices a processor owns Note that this is a subset of the degrees of freedom that are defined on the locally owned one sometimes needs the set of all degrees of freedom on the locally owned subdomain as well as the adjacent ghost cells This information is provided by the[2.x.35] function ***A typical parallel application is dealing with two different kinds of parallel but there are of course different vector types that can each represent both ghosted vectors are typically used for data output</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00059">distributed_0.txt:59</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_aeaf3c7846747695b1f327677e3716ec5"><div class="ttname"><a href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">ParameterHandler::get_double</a></div><div class="ttdeci">double get_double(const std::string &amp;entry_name) const</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l01068">parameter_handler.cc:1068</a></div></div>
<div class="ttc" id="aevent__0_8txt_html_a60053d8ff825674cfcc1321aba229cd7"><div class="ttname"><a href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a></div><div class="ttdeci">*Objects of this kind are used to notify interior applications of changes provoked by an outer loop They are handed to the application through[2.x.0] and it is up to the actual application how to handle them Event is organized as an extensible binary enumerator Every class can add its own events using here is how to retrieve it knowing the name generating a clear Event **Clear all flags **Set all flags **Add the flags of the other event **Clear the flags of the other event **Test whether all the flags set in the other Event are also set in this one **Return&lt; tt &gt; true&lt;/tt &gt; if any event is set **List the flags to a stream **List all assigned events actions have to be taken by all means if this value is true</div><div class="ttdef"><b>Definition:</b> <a href="event__0_8txt_source.html#l00028">event_0.txt:28</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_afc96893388fe1a55c6ae5ae19ba52c6d"><div class="ttname"><a href="namespaceDoFTools.html#afc96893388fe1a55c6ae5ae19ba52c6d">DoFTools::extract_constant_modes</a></div><div class="ttdeci">void extract_constant_modes(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const ComponentMask &amp;component_mask, std::vector&lt; std::vector&lt; bool &gt;&gt; &amp;constant_modes)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01227">dof_tools.cc:1227</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__cg_8h_source.html#l00088">solver_cg.h:88</a></div></div>
<div class="ttc" id="apetsc__precondition__0_8txt_html_a41ebb2d49faa97a3d9eab4b4f13c2742"><div class="ttname"><a href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a></div><div class="ttdeci">*Base class for preconditioner classes using the PETSc functionality The classes in this hierarchy don t do a whole lot except for providing a function that sets the preconditioner and certain parameters on the preconditioning context of the solver These classes are basically here only to allow a similar interface as already used for the deal II solver and preconditioner classes Note that derived classes only provide interfaces to the relevant functionality of PETSc PETSc does not implement all preconditioners for all matrix types In particular some preconditioners are not going to work for parallel jobs such as for example the ILU preconditioner ***Constructor **Destructor **Destroys the preconditioner</div><div class="ttdef"><b>Definition:</b> <a href="petsc__precondition__0_8txt_source.html#l00002">petsc_precondition_0.txt:2</a></div></div>
<div class="ttc" id="aclassTimerOutput_1_1Scope_html"><div class="ttname"><a href="classTimerOutput_1_1Scope.html">TimerOutput::Scope</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2timer_8h_source.html#l00600">timer.h:600</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga852e93b85f68573cd0eedfe62c0f6bdc"><div class="ttname"><a href="group__TrilinosWrappers.html#ga852e93b85f68573cd0eedfe62c0f6bdc">TrilinosWrappers::PreconditionAMG::AdditionalData::elliptic</a></div><div class="ttdeci">bool elliptic</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01516">trilinos_precondition.h:1516</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a8fba07b9a84b89e6be225f5f95c3e355"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div><div class="ttdeci">the program is just and one can not intelligently work around that *It is sometimes useful to change the behavior of the[2.x.6] macro from aborting a program to throwing exceptions On the other exceptions are not allowed to propagate out of destructors of classes For this there is a variant of the called[2.x.7] that can be used in destructors These use cases are discussed further down below on this page **Dynamic such as whether an output file can be written to *These are things that shouldn t be checked because it is not guaranteed that a program for which the condition is satisfied in a debug mode run</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00022">exceptions_0.txt:22</a></div></div>
<div class="ttc" id="astructDataPostprocessorInputs_1_1Vector_html_a904b46a59d224ec214e4816e584cba5f"><div class="ttname"><a href="structDataPostprocessorInputs_1_1Vector.html#a904b46a59d224ec214e4816e584cba5f">DataPostprocessorInputs::Vector::solution_values</a></div><div class="ttdeci">std::vector&lt;::Vector&lt; double &gt; &gt; solution_values</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__postprocessor_8h_source.html#l00330">data_postprocessor.h:330</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q&lt; dim &gt;</a></div></div>
<div class="ttc" id="aclassSolverControl_1_1NoConvergence_html"><div class="ttname"><a href="classSolverControl_1_1NoConvergence.html">SolverControl::NoConvergence</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__control_8h_source.html#l00082">solver_control.h:82</a></div></div>
<div class="ttc" id="aclassSymmetricTensor_html"><div class="ttname"><a href="classSymmetricTensor.html">SymmetricTensor&lt; 2, dim &gt;</a></div></div>
<div class="ttc" id="agrid_2grid__tools_8h_html"><div class="ttname"><a href="grid_2grid__tools_8h.html">grid_tools.h</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2namespace__dealii_8h_source.html#l00026">namespace_dealii.h:26</a></div></div>
<div class="ttc" id="amatrix__free_2dof__info__0_8txt_html_afc846d40941f6f9934e92e469096f30f"><div class="ttname"><a href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a></div><div class="ttdeci">We set the granularity to **that is a number sufficiently large to minimize loop peel overhead within the this function always returns index If an index is not found in hp it returns *[2.x.2] *Populate the vector[2.x.3] with locally owned degrees of freedom stored on the cell block[2.x.4] If[2.x.5] is then the returned vector will contain indices required to resolve constraints The image below illustrates the output of this function for cell blocks zero and one with zero Dirichlet boundary conditions at the bottom of the domain Note that due to the presence of the DoFs returned by this function for the case i indices that are located on another get a temporary number by this and will later be assigned the correct index after all the ghost indices have been collected by the call to *[2.x.12] *This method assigns the correct indices to ghost indices from the temporary numbering employed by the[2.x.13] function The numbers are localized with respect to the MPI and ghosts start at the end of the locally owned range This we get direct access to all vector entries **This method reorders the way cells are gone through based on a given renumbering of the cells It also takes[2.x.14] cells together and interprets them as one cell as is needed for vectorization **Finds possible compression for the cell indices that we can apply for increased efficiency Run at the end of reorder_cells **Finds possible compression for the face indices that we can apply for increased efficiency Run at the end of reorder_cells **This function computes the connectivity of the currently stored indices in terms of connections between the individual cells and fills the structure into a sparsity pattern **In case face integrals are find out whether certain loops over the unknowns only access a subset of all the ghost dofs we keep in the main partitioner **Given[2.x.15] containing the index of cells of macro the index ordering can be improved for typical DG elements by interleaving the degrees of freedom from batches of which avoids the data transposition in[2.x.16] these more advanced features are not so there is only limited value of this function **Fills the array that defines how to zero selected ranges in the result vector within the cell filling the two member variables[2.x.17] vector_zero_range_list_index and[2.x.18] The intent of this pattern is to zero the vector entries in close temporal proximity to the first access and thus keeping the vector entries in cache **Return the memory consumption in bytes of this class **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **Prints a representation of the indices in the class to the given output stream **Enum for various storage variants of the indices This storage format is used to implement more efficient indexing schemes in case the underlying data structures allow for and to inform the access functions in[2.x.19] on which array to get the data from One example of more efficient storage is the enum value[2.x.20] which means that one can get the indices to all degrees of freedom of a cell by reading only the first index for each whereas all subsequent indices are merely an offset from the first index **This value indicates that no index compression was found and the only valid storage is to access all indices present on the possibly including constraints For a cell face of this index the data access in FEEvaluationBase is directed to the array[2.x.21] dof_indices with the index row_starts[cell_index *n_vectorization *n_components] first **This value indicates that the indices are interleaved for access with vectorized gather and scatter operation This storage variant is possible in case there are no constraints on the cell and the indices in the batch of cells are not pointing to the same global index in different slots of a vectorized the data access in FEEvaluationBase is directed to the array dof_indices_interleaved with the index row_starts[cell_index *n_vectorization *n_components] first **This value indicates that the indices within a cell are all and one can get the index to the cell by reading that single value for each of the cells in the cell batch For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **This value indicates that the indices with a cell are contiguous and interleaved for i the first DoF index on a cell to the four or eight cells in the vectorization batch come than the second DoF and so on the interleaving between cells implies that only the batches for vectorization can be accessed whereas there is a strided access for getting only some of the entries The two additional categories interleaved_contiguous_strided and interleaved_contiguous_mixed_strides are a consequence of this storage type The former is for faces where at least one of the two adjacent sides will break with the interleaved storage We then have to make a strided access as described in the next category The last category interleaved_contiguous_mixed_strides appears in the ghost see the more detailed description of that category below this is something that cannot be avoided in general once we interleave the indices between cells For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **Similar to interleaved_contiguous but for the case when the interleaved indices are only contiguous within the degrees of but not also over the components of a vectorized array This happens typically on faces with DG where the cells have interleaved_contiguous storage but the faces numbering is not the same as the cell s numbering For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **Similar to interleaved_contiguous_separate but for the case when the interleaved indices are not n_vectorization apart This happens typically within the ghost layer of DG where the remote owner has applied an interleaved storage and the current processor only sees some of the cells For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization * n_components</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2dof__info__0_8txt_source.html#l00070">dof_info_0.txt:70</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1SparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__sparse__matrix_8h_source.html#l00505">trilinos_sparse_matrix.h:505</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga0d16c332aaa652e8905a6f48208e4500"><div class="ttname"><a href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a></div><div class="ttdeci">void compute_no_normal_flux_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const unsigned int first_vector_component, const std::set&lt; types::boundary_id &gt; &amp;boundary_ids, AffineConstraints&lt; double &gt; &amp;constraints, const Mapping&lt; dim, spacedim &gt; &amp;mapping=(ReferenceCells::get_hypercube&lt; dim &gt;() .template get_default_linear_mapping&lt; dim, spacedim &gt;()))</div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00070">fe_update_flags.h:70</a></div></div>
<div class="ttc" id="aiterators__0_8txt_html_a6cf0880ba2af3a1be4aacdbbd4b90f9c"><div class="ttname"><a href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a></div><div class="ttdeci">where BaseIterator usually is one of thestandard iterators discussed above *The FilteredIterator gets an additional Predicate in its constructor and willskip all objects where this Predicate evaluates to&lt; tt &gt; false&lt;/tt &gt; Acollection of predicates already implemented can be found in the namespaceIteratorFilters ***IteratorsLoops Iterating over objects *All iterators of the same kind and iterating over thesame kind of geometrical objects traverse the mesh in the sameorder Take this code all iterators will always point to the same mesh even though&lt; tt &gt; DoFHandler&lt;/tt &gt; and&lt; tt &gt; Triangulation&lt;/tt &gt; are very different and even if the DoFHandlers are handling different finite the difference is only in the Accessor As mentioned the order in which iterators traverse the forest ofobjects is actually well but application programs should notassume any such but rather consider this an implementation detailof the library *Corresponding to above the order in which iterators traverse activeobjects is the same for all iterators in the following the difference to the previous example being that here we only consider active but theyare really rather dumb Their magic only lies in the fact that they point tosome useful in this case the Accessor For they point to anactual object that stores some data On the other the deal II when do not return a reference to an actual but returnan object that knows how to get at the data that represents cells In thisobject doesn t store itself where the vertices of a cell are or what its neighborsare it knows how to tease this sort of information from out of thearrays and tables and lists that the Triangulation class sets up to describe amesh *Accessing data that characterizes a cell is always done through the i e the expression[2.x.10] grants access to[1.x.6] attributes of this Accessor Examples of properties you can query from aniterator are ***Since dereferencing iterators yields accessor these calls are tomember etc These in turn figure out the relevant datafrom the various data structures that store this data How this is actuallydone and what data structures are used is not really of concern to authors ofapplications in deal II In by hiding the actual data structureswe are able to store data in an efficient not necessarily in a way thatmakes it easily accessible or understandable to application writers ***IteratorsTypedefs Kinds of accessors *Depending on what sort of data you want to there are different kindsof accessor and hexes that make up a triangulation</div><div class="ttdef"><b>Definition:</b> <a href="iterators__0_8txt_source.html#l00063">iterators_0.txt:63</a></div></div>
<div class="ttc" id="ageodynamics__0_8txt_html_a47b3a2cd492d04754f4796002e14ed13"><div class="ttname"><a href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a></div><div class="ttdeci">all others have started as modifications of one of the tutorial programs *The tutorial programs we propose to write will provide students and researchers with a reference implementation of current numerical technology such as higher order sophisticated linear and nonlinear stabilization etc Providing these as starting points for further development by others will also serve the goal of training a new generation of geodynamicists in modern numerical algorithms *In deal it is fairly simple to extend a set of equations by another for example an additional advected quantity that enters the existing equations as a right hand side or in one of the coefficients Since applications typically use blocked matrices rather than the one big matrix for everything it is also not complicated to find suitable linear solvers for augmented equations deal II is a good tool for trying out more complex formulations of or more complete models and their effects on the accuracy of solutions *deal II provides many interchangeable components that allow rapid prototyping of finite element kinds and stabilization or linear solvers For typically only a few lines of code have to be changed to replace low order by high order elements Through it becomes relatively simple to try out higher order a different block elimination solver</div><div class="ttdef"><b>Definition:</b> <a href="geodynamics__0_8txt_source.html#l00033">geodynamics_0.txt:33</a></div></div>
<div class="ttc" id="astep-1_8cc_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition:</b> <a href="step-1_8cc_source.html#l00086">step-1.cc:86</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_a6bb45dc67787e3fab7882461929b5fbe"><div class="ttname"><a href="classParameterHandler.html#a6bb45dc67787e3fab7882461929b5fbe">ParameterHandler::get_bool</a></div><div class="ttdeci">bool get_bool(const std::string &amp;entry_name) const</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l01113">parameter_handler.cc:1113</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1Vector_html_a7221ae06689832b475206ef54efaf0a6"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a7221ae06689832b475206ef54efaf0a6">TrilinosWrappers::MPI::Vector::compress</a></div><div class="ttdeci">void compress(::VectorOperation::values operation)</div><div class="ttdef"><b>Definition:</b> <a href="trilinos__vector_8cc_source.html#l00582">trilinos_vector.cc:582</a></div></div>
<div class="ttc" id="adata__out__base__0_8txt_html_a918b7763318d7dd4fc059a2898fe1ef6"><div class="ttname"><a href="data__out__base__0_8txt.html#a918b7763318d7dd4fc059a2898fe1ef6">declare_parameters</a></div><div class="ttdeci">derived classes use their own type to fill in the so that&lt; tt &gt; memory_consumption&lt;/tt &gt; works correctly See the Wikipedia page on the pattern for more information ***Declare all flags with name and type as offered by this for use in input files This method does but child classes may override this method to add fields to&lt; tt &gt; prm&lt;/tt &gt; **Read the parameters declared in declare_parameters() and set the flags for this output format accordingly. This method does nothing</div></div>
<div class="ttc" id="amultithreading__0_8txt_html_a0759c0124e216ec36f063ad051f4dba0"><div class="ttname"><a href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a></div><div class="ttdeci">it should be big enough so that we don t spend more time on scheduling sub ranges to processors but small enough that processors can be efficiently load balanced A rule of thumb appears to be that a sub range is too small if it takes less than instructions to execute it *An example of how to use these functions are vector operations like the addition in[2.x.45] where all three objects are of type we used a[1.x.23] to on the a function object that takes two arguments and returns the sum of the two This is exactly what we needed when we want to add the individual elements of vectors[2.x.46] and[2.x.47] and write the sum of the two into the elements of[2.x.48] The function object that we get here is completely known to the compiler and when it expands the loop that results from[2.x.49] will be as if we had written the loop in its obvious thereby eliminating the overhead of calling an external function there are cases where it is inefficient to call some object or function within each iteration *An example for this case is sparse matrix vector multiplication If you know how data is stored in compressed row format like in the SparseMatrix then a matrix vector product function looks like we compute the dot product of a single row of the matrix with the right hand side vector[2.x.51] and write it into the corresponding element of the[2.x.52] vector The code is made more efficient by utilizing that the elements of the[1.x.28] row follow the ones of the current i e at the beginning of the loop body we do not have to re set the pointers that point to the values and column numbers of each row *Using the[2.x.53] function we could in principle write this code as leaving one argument open and thus allowing the[2.x.56] function to consider the passed function argument as unary Also note that we need to make the source and destination vectors neither of which is what we desired notice the grainsize of a minimum of rows of a matrix that should be processed by an individual CPU core *The point is that while this is it is not since now the function object to be called on each row is not a simple[1.x.32] any there is an implicit function call including argument passing in each iteration of the loop *A more efficient way is to let TBB split the original range into sub and then call a target function not on each individual element of the but on the entire range This is facilitated by the[2.x.61] we call the[2.x.62] function on sub ranges of at least elements so that the initial setup cost can amortize *A related operation is when the loops over elements each produce a result that must then be but let s assume for a moment that it is A sequential implementation would look like this for sparse each of which compute their part of the square of the norm</div><div class="ttdef"><b>Definition:</b> <a href="multithreading__0_8txt_source.html#l00124">multithreading_0.txt:124</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8h_source.html#l01033">tria.h:1033</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="asolver__cg__0_8txt_html_ab8dd1e5e6028b76d234561ae8e1d22bc"><div class="ttname"><a href="solver__cg__0_8txt.html#ab8dd1e5e6028b76d234561ae8e1d22bc">steps</a></div><div class="ttdeci">*This class implements the preconditioned Conjugate but is used in many other tutorial programs as well Like all other solver it can work on any kind of vector and matrix as long as they satisfy certain and defaults to *[2.x.2] **This version of CG is taken from D Braess s book Finite Elements It requires a symmetric the projected matrix[2.x.4] is tri diagonal Since the projection is the eigenvalues of[2.x.5] approximate those of the original preconditioned matrix[2.x.6] In after[2.x.7] steps</div><div class="ttdef"><b>Definition:</b> <a href="solver__cg__0_8txt_source.html#l00010">solver_cg_0.txt:10</a></div></div>
<div class="ttc" id="astructCopyData_html"><div class="ttname"><a href="structCopyData.html">CopyData</a></div><div class="ttdef"><b>Definition:</b> <a href="step-50_8cc_source.html#l01104">step-50.cc:1104</a></div></div>
<div class="ttc" id="abase_2parameter__handler_8h_html"><div class="ttname"><a href="base_2parameter__handler_8h.html">parameter_handler.h</a></div></div>
<div class="ttc" id="aupdate__flags__0_8txt_html_a5873b8f7eeaefb5e7a99005c6c93b175"><div class="ttname"><a href="update__flags__0_8txt.html#a5873b8f7eeaefb5e7a99005c6c93b175">quadrature</a></div><div class="ttdeci">and a mapping object that provides the Jacobian as well as its determinant Dealing with all these objects would be cumbersome and error prone *On the other these three kinds of objects almost always appear and it is in fact very rare for deal II application codes to do anything with quadrature</div><div class="ttdef"><b>Definition:</b> <a href="update__flags__0_8txt_source.html#l00019">update_flags_0.txt:19</a></div></div>
<div class="ttc" id="afe_2fe__q_8h_html"><div class="ttname"><a href="fe_2fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="ampi__remote__point__evaluation__0_8txt_html_a45c57074a631760cdab557f450e880e0"><div class="ttname"><a href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a></div><div class="ttdeci">*Helper class to access values on non matching grids *The name of the fields are chosen with the method quantities are computed at specified arbitrary positioned which receive the result and resort the result according to the points **Constructor[2.x.1] tolerance Tolerance in terms of unit cell coordinates for determining all cells around a point passed to the class during it might be necessary to adjust the tolerance in order to be able to identify a cell Floating point arithmetic implies that a point in not lie exactly on a or face[2.x.2] enforce_unique_mapping Enforce unique mapping</div><div class="ttdef"><b>Definition:</b> <a href="mpi__remote__point__evaluation__0_8txt_source.html#l00005">mpi_remote_point_evaluation_0.txt:5</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_a6d65f458be69e23a348221cb67fc411d"><div class="ttname"><a href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">ParameterHandler::declare_entry</a></div><div class="ttdeci">void declare_entry(const std::string &amp;entry, const std::string &amp;default_value, const Patterns::PatternBase &amp;pattern=Patterns::Anything(), const std::string &amp;documentation=&quot;&quot;, const bool has_to_be_set=false)</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l00796">parameter_handler.cc:796</a></div></div>
<div class="ttc" id="anamespaceStep32_html"><div class="ttname"><a href="namespaceStep32.html">Step32</a></div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00082">step-32.cc:82</a></div></div>
<div class="ttc" id="anewton__0_8txt_html_a21f536f84dd77674667ed5d2a30eb3ab"><div class="ttname"><a href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a></div><div class="ttdeci">*Operator class performing Newton s iteration with standard step size control and adaptive matrix generation This class performs a Newton iteration up to convergence determined by control If after an update the norm of the residual has become larger then step size control is activated and the update is subsequently divided by two until the residual actually becomes depending on the tends to be this method applies an adaptive reassembling strategy Only if the reduction factor for the residual is more than receiving the applications computing the residual and solving the linear respectively **Declare the parameters applicable to Newton s method **Read the parameters in the ParameterHandler **Initialize the pointer data_out for debugging **The actual Newton iteration The initial value is in&lt; tt &gt; which also contains the result after convergence Values in&lt; tt &gt; in&lt;/tt &gt; are not used by but will be handed down to the objects **Set the maximal residual reduction allowed without triggering assembling in the next step Return the previous value **Control object for the Newton iteration **The indicating that the matrix must be assembled anew upon start **A flag used to decide how many stepsize iteration should be made Default is the original value of Enter zero here to turn off stepsize control *Controlled by&lt; tt &gt; Stepsize iterations&lt;/tt &gt; in parameter file **Threshold for re assembling matrix If the quotient of two consecutive residuals is smaller than this the system matrix is not assembled in this step *This parameter should be adjusted to the residual gain of the inner solver The default values is resulting in reassembling in every Newton step **Print residual</div><div class="ttdef"><b>Definition:</b> <a href="newton__0_8txt_source.html#l00032">newton_0.txt:32</a></div></div>
<div class="ttc" id="aclassSymmetricTensor_html_ab14ac27fc9ab74d4de531698b492d8de"><div class="ttname"><a href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">SymmetricTensor::scalar_product</a></div><div class="ttdeci">constexpr ProductType&lt; Number, OtherNumber &gt;::type scalar_product(const SymmetricTensor&lt; 2, dim, Number &gt; &amp;t1, const SymmetricTensor&lt; 2, dim, OtherNumber &gt; &amp;t2)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l03792">symmetric_tensor.h:3792</a></div></div>
<div class="ttc" id="awork__stream__0_8txt_html_ab1f7b2d0d351b91b988585df989cc234"><div class="ttname"><a href="work__stream__0_8txt.html#ab1f7b2d0d351b91b988585df989cc234">copier</a></div><div class="ttdeci">for for the purpose of assembling matrices or evaluating error an item could be a cell The TBB library determines how many threads are but the number of items that may be active at any given time is specified by the argument to the constructor It should be bigger or equal to the number of processor cores **the default is four times the number of cores on the current system *Items are created upon request by the TBB whenever one of the worker threads is idle or is expected to become idle It is then handed off to a worker typically a member function of a main class These worker functions are run in parallel on a number of and there is no guarantee that they are asked to work on items in any particular in particular not necessarily in the order in which items are generated from the iterator range worker functions need additional for example FEValues input data some of which can not be shared among threads To this the which designates a type objects of which are stored with each item and which threads can use as private data without having to share them with other threads The worker functions store their results in objects of template type CopyData These are then handed off to a separate called copier</div><div class="ttdef"><b>Definition:</b> <a href="work__stream__0_8txt_source.html#l00010">work_stream_0.txt:10</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2utilities_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2utilities_8h.html">utilities.h</a></div></div>
<div class="ttc" id="anumerics_2error__estimator_8h_html"><div class="ttname"><a href="numerics_2error__estimator_8h.html">error_estimator.h</a></div></div>
<div class="ttc" id="aclassDoFHandler_html_a9a3bef554c6d22abe312e10e9475eecf"><div class="ttname"><a href="classDoFHandler.html#a9a3bef554c6d22abe312e10e9475eecf">DoFHandler::begin_active</a></div><div class="ttdeci">active_cell_iterator begin_active(const unsigned int level=0) const</div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Scalar_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00095">fe_values_extractors.h:95</a></div></div>
<div class="ttc" id="abase_2timer_8h_html"><div class="ttname"><a href="base_2timer_8h.html">timer.h</a></div></div>
<div class="ttc" id="alinear__operator__0_8txt_html_a64f52ea7f8959e614f32da4664cdbe50"><div class="ttname"><a href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a></div><div class="ttdeci">*A class to store the abstract concept of a linear set up and handle intermediate storage locations by hand *As an example consider the and[2.x.8] one can sparse matrices with a or larger ***In order to use Trilinos or PETSc sparse matrices and preconditioners in conjunction with the LinearOperator it is necessary to extend the functionality of the LinearOperator class by means of an additional Payload *For for may represent a composite operation The[2.x.14] therefore provides an interface extension to the LinearOperator so that it can be passed to the solver and used by the solver as if it were a Trilinos it is again necessary to provide an interface that produces the result of this composite operation that is compatible with Trilinos the resulting this function also ensures that the underlying Payload matches that of the input *[2.x.105] *****LinearOperator *Return a nulled variant of the LinearOperator[2.x.108] i e with optimized[2.x.109][2.x.110] etc functions and with[2.x.111] set to true ******LinearOperator *Return a LinearOperator that acts as a mean value filter The vmult() functions of this matrix subtract the mean values of the vector. *The function takes an[2.x.114] object[2.x.115] as an argument to initialize the[2.x.116] and[2.x.117] objects of the LinearOperator object. ***[2.x.118] **[0.x.35] *[2.x.119] LinearOperator *Return a LinearOperator that acts as a mean value filter. The vmult() functions of this matrix subtract the mean values of the vector. *The function takes a LinearOperator[2.x.120] and uses its range initializer to create an mean value filter operator.The function also ensures that the underlying Payload matches that of the input[2.x.121] ***[2.x.122] **[0.x.36] *A helper class that is responsible for the initialization of a vector to be directly usable as the destination parameter</div></div>
<div class="ttc" id="astructDataPostprocessorInputs_1_1Vector_html_a2a918d936d56f2be4cdad1b8074c3a86"><div class="ttname"><a href="structDataPostprocessorInputs_1_1Vector.html#a2a918d936d56f2be4cdad1b8074c3a86">DataPostprocessorInputs::Vector::solution_gradients</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; Tensor&lt; 1, spacedim &gt; &gt; &gt; solution_gradients</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__postprocessor_8h_source.html#l00347">data_postprocessor.h:347</a></div></div>
<div class="ttc" id="aclassBlockVectorBase_html_ae05a0e26814f032473ed2ef66da018bd"><div class="ttname"><a href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">BlockVectorBase::block</a></div><div class="ttdeci">BlockType &amp; block(const unsigned int i)</div></div>
<div class="ttc" id="aclassPatterns_1_1Bool_html"><div class="ttname"><a href="classPatterns_1_1Bool.html">Patterns::Bool</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2patterns_8h_source.html#l01054">patterns.h:1054</a></div></div>
<div class="ttc" id="abase_2numbers_8h_html_a02761f62f66f685e954daed42bcb3a1b"><div class="ttname"><a href="base_2numbers_8h.html#a02761f62f66f685e954daed42bcb3a1b">std::cos</a></div><div class="ttdeci">::VectorizedArray&lt; Number, width &gt; cos(const ::VectorizedArray&lt; Number, width &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05605">vectorization.h:5605</a></div></div>
<div class="ttc" id="amapping__info__0_8txt_html_aaed09e22b1fee38bd2273caeedfb0e90"><div class="ttname"><a href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a></div><div class="ttdeci">*An enum to identify various types of cells and faces The most general type is what we typically compute in the FEValues context but for many geometries we can save significant storage ***The cell or face is Cartesian **The cell or face can be described with an affine mapping **The face is i the normal factor on a face is the same on all quadrature points This type is not assigned for cells **There is no special information available for compressing the representation of the object under consideration **Definition of a structure that stores all cached data related to the evaluated geometry from the mapping In order to support hp adaptivity and compressed storage length can be different for different rows it allows to jump at the data of individual rows similar to compressed row storage in sparse matrices We have two different start indices for fields with different sizes The first category of offsets are the indices for Jacobians of the transformation from unit to real second JxW and normal vectors We keep separate arrays for all these data structures because a user code might access only some of them In such a one array will be gone through in a contiguous order with access to all which makes it easy for the processor to prefetch data Having all data in a single array would require some strides in the access which is much more complicated for the processor to called which contains the quadrature weights and permutations of how to go through quadrature points in case of face data The latter comes in a vector for the support of hp with several data fields for the individual quadrature formulas ***Constructor Does nothing **Set up the lengths in the various members of this struct **Set up the lengths in the various members of this struct **Returns the memory consumption in bytes **Number of quadrature points applied on the given cell or face **Original one dimensional quadrature formula applied on the given cell or face **Quadrature formula applied on the given cell or face **Quadrature weights separated by dimension for use in specific situations **A cached vector of quadrature weights in the given number the evaluation of basis functions is not in the correct order if a face is not in the standard orientation to a given element This data structure is used to re order the data evaluated on quadrature points to represent the correct order **A class describing the layout of the sections in the[2.x.2] field and also includes some data that depends on the number of quadrature points in the hp context such as the inner quadrature formula and re indexing for faces that are not in the standard orientation **Collection of quadrature formulae applied on the given face *Only filled for since faces might be quadrilateral or triangle shaped **Stores the index offset into the arrays[2.x.4][2.x.5][2.x.6] and the second derivatives Note that affine cells have shorter fields of where the others have lengths equal to the number of quadrature points of the given cell **The storage of the Jacobian i the inverse and transposed Jacobians of the transformation from the unit to the real cell Indexed by[2.x.9] Contains two fields for access from both sides for interior but the default only the upper diagonal and diagonal part are needed The first index runs through the starting with the diagonal and then continuing row i and so on The second index is the spatial coordinate Indexed by[2.x.12] Contains two fields for access from both sides for interior but the default including a compression scheme for Cartesian cells where we do not need to store the full data on all points Indexed by *[2.x.16] *Clears all data fields except the descriptor vector **Returns the quadrature index for a given number of quadrature points If not in hp mode or if the index is not this function always returns index this function does not check whether the given degree is actually present **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **Returns the memory consumption in bytes **The class that stores all geometry dependent data related with cell interiors for use in the matrix free class ***Compute the information in the given cells and faces The cells are specified by the level and the index within the a mapping and several quadrature formulas are given **Update the information in the given cells and faces that is the result of a change in the given mapping keeping the quadrature formulas and other unknowns unchanged This call is only valid if[2.x.20] has been called before **Return the type of a given cell as detected during initialization **Clear all data fields in this class **Return the memory consumption of this class in bytes **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **The given update flags for computing the geometry on the cells **The given update flags for computing the geometry on the boundary faces **The given update flags for computing the geometry on the interior faces **The given update flags for computing the geometry on the faces for cell centric loops **Stores whether a cell is has constant transform data() or is whether it represents an affine whether it is a flat face where the normal vector is the same throughout the or is following the[2.x.21] variable for the cell types **The pointer to the underlying[2.x.22] object **The pointer to the first entry of mapping_collection **Reference cell type related to each quadrature and active quadrature index **Internal function to compute the geometry for the case the mapping is a MappingQ and a single quadrature formula per i it uses a polynomial description of the cell especially when several different quadrature formulas are and consumes less memory[2.x.23] tria The triangulation to be used for setup[2.x.24] cells The actual cells of the triangulation to be worked given as a tuple of the level and index within the level as used in the main initialization of the class ::x faces The description of the connectivity from faces to cells as filled in the MatrixFree class **Computes the information in the given called within initialize **Computes the information in the given called within initialize **Computes the information in the given called within initialize **Helper function to determine which update flags must be set in the internal functions to initialize all data as requested by the user **A helper class to extract either cell or face data from mapping info for use in FEEvaluationBase **A class that is used to compare floating point c</div><div class="ttdef"><b>Definition:</b> <a href="mapping__info__0_8txt_source.html#l00116">mapping_info_0.txt:116</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ad54c4de985d6d1b46aaf6ae96ae8d3a1"><div class="ttname"><a href="coding__conventions__0_8txt.html#ad54c4de985d6d1b46aaf6ae96ae8d3a1">const</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked const</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00023">coding_conventions_0.txt:23</a></div></div>
<div class="ttc" id="astructStep32_1_1BoussinesqFlowProblem_1_1Parameters_html"><div class="ttname"><a href="structStep32_1_1BoussinesqFlowProblem_1_1Parameters.html">Step32::BoussinesqFlowProblem::Parameters</a></div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00625">step-32.cc:625</a></div></div>
<div class="ttc" id="aclassIndexSet_html_add590b083cdde3fa61e637a058b51835"><div class="ttname"><a href="classIndexSet.html#add590b083cdde3fa61e637a058b51835">IndexSet::get_view</a></div><div class="ttdeci">IndexSet get_view(const size_type begin, const size_type end) const</div><div class="ttdef"><b>Definition:</b> <a href="index__set_8cc_source.html#l00211">index_set.cc:211</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1BlockVector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__parallel__block__vector_8h_source.html#l00073">trilinos_parallel_block_vector.h:73</a></div></div>
<div class="ttc" id="agrid_2filtered__iterator_8h_html"><div class="ttname"><a href="grid_2filtered__iterator_8h.html">filtered_iterator.h</a></div></div>
<div class="ttc" id="anamespaceStep20_1_1PrescribedSolution_html_a2ec9d2a9c0f55b8fb13bd1c83c358e38"><div class="ttname"><a href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">Step20::PrescribedSolution::beta</a></div><div class="ttdeci">constexpr double beta</div><div class="ttdef"><b>Definition:</b> <a href="step-20_8cc_source.html#l00088">step-20.cc:88</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a7c001f60e6c7c0bcd347e3f7b66a5402"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a7c001f60e6c7c0bcd347e3f7b66a5402">Step32::EquationData::gravity_vector</a></div><div class="ttdeci">Tensor&lt; 1, dim &gt; gravity_vector(const Point&lt; dim &gt; &amp;p)</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00114">step-32.cc:114</a></div></div>
<div class="ttc" id="alac_2block__sparsity__pattern_8h_html"><div class="ttname"><a href="lac_2block__sparsity__pattern_8h.html">block_sparsity_pattern.h</a></div></div>
<div class="ttc" id="aclassComponentMask_html"><div class="ttname"><a href="classComponentMask.html">ComponentMask</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2component__mask_8h_source.html#l00080">component_mask.h:80</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ac6b404bf03cb2a742b290421cc2789fe"><div class="ttname"><a href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a></div><div class="ttdeci">void project(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const AffineConstraints&lt; typename VectorType::value_type &gt; &amp;constraints, const Quadrature&lt; dim &gt; &amp;quadrature, const Function&lt; spacedim, typename VectorType::value_type &gt; &amp;function, VectorType &amp;vec, const bool enforce_zero_boundary=false, const Quadrature&lt; dim - 1 &gt; &amp;q_boundary=(dim &gt; 1 ? QGauss&lt; dim - 1 &gt;(2) :Quadrature&lt; dim - 1 &gt;(0)), const bool project_to_boundary_first=false)</div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a93f65b0385560a34ec1d3c5ec5a882b8"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">Physics::Elasticity::Kinematics::d</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; d(const Tensor&lt; 2, dim, Number &gt; &amp;F, const Tensor&lt; 2, dim, Number &gt; &amp;dF_dt)</div></div>
<div class="ttc" id="alac_2trilinos__block__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2trilinos__block__sparse__matrix_8h.html">trilinos_block_sparse_matrix.h</a></div></div>
<div class="ttc" id="aconstraints__0_8txt_html_a9132c79972fe954d265b941f34bebed9"><div class="ttname"><a href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a></div><div class="ttdeci">******This module deals with constraints on degrees of freedom The central class to deal with constraints is the AffineConstraints class *Constraints typically come from several for one usually enforces them by requiring that degrees of freedom on the boundary have particular for example[2.x.3] if the boundary condition[2.x.4] requires that the finite element solution[2.x.5] at the location of degree of freedom has the value Such constraints are generated by those versions of the[2.x.6] function that take a AffineConstraints for example no normal as happens in flow problems and is handled by the[2.x.11] function or prescribed tangential as happens in electromagnetic problems and is handled by the[2.x.13] function For the former imagine for example that we are at at vertex where the normal vector has the form[2.x.14] and that the[2.x.15]</div><div class="ttdef"><b>Definition:</b> <a href="constraints__0_8txt_source.html#l00020">constraints_0.txt:20</a></div></div>
<div class="ttc" id="adata__postprocessor__0_8txt_html_a80e53cb52e5dbb182dd14ee528927a77"><div class="ttname"><a href="data__postprocessor__0_8txt.html#a80e53cb52e5dbb182dd14ee528927a77">postprocessor</a></div><div class="ttdeci">the current data is generated on a coarser mesh for the background color corresponds to the magnitude of the gradient vector and the vector glyphs to the gradient itself It may be surprising at first to see that from each multiple vectors going in different directions But that is because the solution is only the gradient is discontinuous across and so the multiple vectors originating from each vertex simply represent the differing gradients of the solution at each adjacent cell *The output above the gradient[2.x.114] of the solution **corresponds to the temperature gradient if one interpreted[2.x.115] as solving a steady state heat transfer problem It is very small in the central part of the domain because in[2.x.116] we are solving an equation that has a coefficient[2.x.117] that is large in the central part and small on the outside This can be thought as a material that conducts heat and consequently the temperature gradient is small On the other the heat flux corresponds to the quantity[2.x.118] For the solution of that the flux should be continuous across the interface This is easily verified by the following modification of the postprocessor</div><div class="ttdef"><b>Definition:</b> <a href="data__postprocessor__0_8txt_source.html#l00138">data_postprocessor_0.txt:138</a></div></div>
<div class="ttc" id="aclassIteratorFilters_1_1LocallyOwnedCell_html"><div class="ttname"><a href="classIteratorFilters_1_1LocallyOwnedCell.html">IteratorFilters::LocallyOwnedCell</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2filtered__iterator_8h_source.html#l00196">filtered_iterator.h:196</a></div></div>
<div class="ttc" id="aclassDataOutInterface_html_a0864e51eb173c87e2a3edc9391ea8009"><div class="ttname"><a href="classDataOutInterface.html#a0864e51eb173c87e2a3edc9391ea8009">DataOutInterface::write_vtu_with_pvtu_record</a></div><div class="ttdeci">std::string write_vtu_with_pvtu_record(const std::string &amp;directory, const std::string &amp;filename_without_extension, const unsigned int counter, const MPI_Comm &amp;mpi_communicator, const unsigned int n_digits_for_counter=numbers::invalid_unsigned_int, const unsigned int n_groups=0) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07370">data_out_base.cc:7370</a></div></div>
<div class="ttc" id="agroup__Vectors_html_ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b"><div class="ttname"><a href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964cad11ac5bd2488371d9fa940c84241f82b">VectorOperation::add</a></div><div class="ttdeci">@ add</div><div class="ttdef"><b>Definition:</b> <a href="lac_2vector__operation_8h_source.html#l00056">vector_operation.h:56</a></div></div>
<div class="ttc" id="alac_2affine__constraints_8h_html"><div class="ttname"><a href="lac_2affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="adata__postprocessor__0_8txt_html_afb21caeba7bf26aba89ce705266fedb1"><div class="ttname"><a href="data__postprocessor__0_8txt.html#afb21caeba7bf26aba89ce705266fedb1">get_names</a></div><div class="ttdeci">note that this is only determined by the number of components in the finite element in and not by whether the data computed by a class derived from the current one is scalar or vector valued derived classes have to implement the get_names() function</div></div>
<div class="ttc" id="adistributed__0_8txt_html_ac2b339f054fd752a401e197097db8cfe"><div class="ttname"><a href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a></div><div class="ttdeci">********clusters ***deal II can use multiple machines connected via MPI to parallelize in addition to the parallelization within a shared memory machine discussed in the[2.x.4] module There are essentially two ways to utilize multiple but only a share of the global sparsity and solution vector is stored on each machine ****The mesh and DoF handler are also i e each processor stores only a share of the cells and degrees of freedom No processor has knowledge of the entire or solution</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00025">distributed_0.txt:25</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa378cbcddbdf54fb3f9f0acf47b1c4719">update_hessians</a></div><div class="ttdeci">@ update_hessians</div><div class="ttdoc">Second derivatives of shape functions.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00084">fe_update_flags.h:84</a></div></div>
<div class="ttc" id="aparameter__handler__0_8txt_html_ad919e2b915d8e8226aef004c2d8399a8"><div class="ttname"><a href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">exception</a></div><div class="ttdeci">since default values may change in the process of program you cannot know the values of parameters not specified in the input file ****It is often convenient to have something happen as soon as a parameter value is read This could be a check that it is valid that a file that is listed in the parameter file exists **or to initiate something else in such as setting a variable outside the this action could also be initiated once all parameters are read via but it is sometimes[1.x.19] to do it right away *This is facilitated by the and can then do whatever they want with it **e save it somewhere outside the ParameterHandler in C one doesn t usually pass around the address of a but an action can be a function like object(taking a string as argument) that results from calling such as a[1.x.20] that has the form **[1.x.21] *and that is attached to a specific parameter. *A typical example of such an action would be as follows the content of the file equals the default value of the parameter the contents of files are never changed after declaration of a parameter a directory in this file system may not have a file called[2.x.20] in it In that the directory represents a subsection as declared and the directory s name will correspond to the name of the subsection It will then have no files in it at but it may have further directories in the code above will lead to a hierarchical representation of data that looks like this(the content of files is indicated at the right in a different font) this is only used when creating output for exceptions If non empty[2.x.35] is the ParameterHandler object will stop parsing lines after encountering[2.x.36] This is handy when adding extra data that shall be parsed manually If[2.x.37] the parameter handler will skip undefined sections and entries This is useful for partially parsing a parameter for example to obtain only the spatial dimension of the problem By default all entries and subsections are expected to be declared The function sets the value of all parameters it encounters in the input file to the provided value Parameters not explicitly listed in the input file are left at the value they previously which will be the default value provided to and for each parameter all associated actions that may previously have been set by or if an associated action throws an exception</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler__0_8txt_source.html#l00241">parameter_handler_0.txt:241</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga7bcc5fa85afdb96d90416e7bf182edd0"><div class="ttname"><a href="group__TrilinosWrappers.html#ga7bcc5fa85afdb96d90416e7bf182edd0">TrilinosWrappers::PreconditionAMG::AdditionalData::smoother_sweeps</a></div><div class="ttdeci">unsigned int smoother_sweeps</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01568">trilinos_precondition.h:1568</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a6ed7c846331069f406b8c9933c37fda4"><div class="ttname"><a href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandler&lt; dim, spacedim &gt; &amp;)</div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00266">dof_handler.h:266</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a></div><div class="ttdeci">@ none</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00216">dof_tools.h:216</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1SparsityPattern_html"><div class="ttname"><a href="classTrilinosWrappers_1_1SparsityPattern.html">TrilinosWrappers::SparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__sparsity__pattern_8h_source.html#l00298">trilinos_sparsity_pattern.h:298</a></div></div>
<div class="ttc" id="aclassVectorizedArray_html_adea3423146bcdda2dce143cfb4d10ae8"><div class="ttname"><a href="classVectorizedArray.html#adea3423146bcdda2dce143cfb4d10ae8">VectorizedArray::cos</a></div><div class="ttdeci">VectorizedArray&lt; Number, width &gt; cos(const ::VectorizedArray&lt; Number, width &gt; &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05605">vectorization.h:5605</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga8bb24e061826fbdfb49aeb24f80e02fd"><div class="ttname"><a href="group__TrilinosWrappers.html#ga8bb24e061826fbdfb49aeb24f80e02fd">TrilinosWrappers::PreconditionAMG::AdditionalData::higher_order_elements</a></div><div class="ttdeci">bool higher_order_elements</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01523">trilinos_precondition.h:1523</a></div></div>
<div class="ttc" id="aclassQIterated_html"><div class="ttname"><a href="classQIterated.html">QIterated</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2quadrature_8h_source.html#l00380">quadrature.h:380</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a></div><div class="ttdeci">@ component_is_part_of_vector</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00062">data_component_interpretation.h:62</a></div></div>
<div class="ttc" id="asolver__cg__0_8txt_html_a557c71e94a2542d697ca3426b8843cd4"><div class="ttname"><a href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">sqrt</a></div><div class="ttdeci">*This class implements the preconditioned Conjugate but is used in many other tutorial programs as well Like all other solver it can work on any kind of vector and matrix as long as they satisfy certain and defaults to *[2.x.2] **This version of CG is taken from D Braess s book Finite Elements It requires a symmetric the projected matrix[2.x.4] is tri diagonal Since the projection is the eigenvalues of[2.x.5] approximate those of the original preconditioned matrix[2.x.6] In after[2.x.7] where[2.x.8] is the dimension of the original the eigenvalues of both matrices are equal even for small numbers of iteration the condition number of[2.x.9] is a good estimate for the one of *[2.x.10] After[2.x.11] steps the matrix T_m can be written in terms of the coefficients[2.x.12] and[2.x.13] as the tri diagonal matrix with diagonal elements&lt; tt &gt;&lt; tt &gt; alpha_1 beta_0&lt; tt &gt;&lt; tt &gt; sqrt(beta_{m-2&lt;/tt &gt;)/alpha_</div><div class="ttdef"><b>Definition:</b> <a href="solver__cg__0_8txt_source.html#l00011">solver_cg_0.txt:11</a></div></div>
<div class="ttc" id="aclassTable_html"><div class="ttname"><a href="classTable.html">Table</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00033">array_view.h:33</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a7abacfbb83b0ac35324d60dbc2a4ac27"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a7abacfbb83b0ac35324d60dbc2a4ac27">Step32::EquationData::reference_temperature</a></div><div class="ttdeci">constexpr double reference_temperature</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00092">step-32.cc:92</a></div></div>
<div class="ttc" id="abase_2symmetric__tensor_8h_html_ab14ac27fc9ab74d4de531698b492d8de"><div class="ttname"><a href="base_2symmetric__tensor_8h.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a></div><div class="ttdeci">constexpr ProductType&lt; Number, OtherNumber &gt;::type scalar_product(const SymmetricTensor&lt; 2, dim, Number &gt; &amp;t1, const SymmetricTensor&lt; 2, dim, OtherNumber &gt; &amp;t2)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l03792">symmetric_tensor.h:3792</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00116">fe_update_flags.h:116</a></div></div>
<div class="ttc" id="aclassSubscriptor_html"><div class="ttname"><a href="classSubscriptor.html">Subscriptor</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2subscriptor_8h_source.html#l00060">subscriptor.h:60</a></div></div>
<div class="ttc" id="anamespaceWorkStream_html_ab8ceb010811941c351803b671a19fb73"><div class="ttname"><a href="namespaceWorkStream.html#ab8ceb010811941c351803b671a19fb73">WorkStream::run</a></div><div class="ttdeci">void run(const std::vector&lt; std::vector&lt; Iterator &gt;&gt; &amp;colored_iterators, Worker worker, Copier copier, const ScratchData &amp;sample_scratch_data, const CopyData &amp;sample_copy_data, const unsigned int queue_length=2 *MultithreadInfo::n_threads(), const unsigned int chunk_size=8)</div><div class="ttdef"><b>Definition:</b> <a href="base_2work__stream_8h_source.html#l01313">work_stream.h:1313</a></div></div>
<div class="ttc" id="apolynomials__abf__0_8txt_html_a7a716deb19e461cf8ba2a26e01c6a908"><div class="ttname"><a href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a></div><div class="ttdeci">*This class implements the[1.x.0] vector valued Arnold Boffi Falk polynomials as described in the article by Arnold Boffi SIAM J Numer Anal pp **The ABF polynomials are constructed such that the divergence is in the tensor product polynomial space[1.x.1] the polynomial order of each component must be two orders higher in the corresponding yielding the polynomial spaces[1.x.2] and[1.x.3] in resp ******Constructor Creates all basis functions for Raviart Thomas polynomials of given degree[2.x.1] k</div><div class="ttdef"><b>Definition:</b> <a href="polynomials__abf__0_8txt_source.html#l00013">polynomials_abf_0.txt:13</a></div></div>
<div class="ttc" id="anumerics_2vector__tools_8h_html"><div class="ttname"><a href="numerics_2vector__tools_8h.html">vector_tools.h</a></div></div>
<div class="ttc" id="abase_2function_8h_html"><div class="ttname"><a href="base_2function_8h.html">function.h</a></div></div>
<div class="ttc" id="aclassTimerOutput_html"><div class="ttname"><a href="classTimerOutput.html">TimerOutput</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2timer_8h_source.html#l00591">timer.h:591</a></div></div>
<div class="ttc" id="anamespaceDifferentiation_1_1SD_html_a130b20f2ea3522f1d123c75c63c0f67d"><div class="ttname"><a href="namespaceDifferentiation_1_1SD.html#a130b20f2ea3522f1d123c75c63c0f67d">Differentiation::SD::atan2</a></div><div class="ttdeci">Expression atan2(const Expression &amp;y, const Expression &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="symengine__math_8cc_source.html#l00154">symengine_math.cc:154</a></div></div>
<div class="ttc" id="anumerical__algorithms__0_8txt_html_a852a1e245dd2de4943eeb66beeaf65b1"><div class="ttname"><a href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">vector</a></div><div class="ttdeci">****This module groups a diverse set of classes that generally implement some sort of numerical algorithm on top all the basic and finite element classes in the library They are generally unconnected to each other *Some of the like KellyErrorEstimator and act on solutions already and compute derived quantities in the first two or help transferring a set of vectors from one mesh to another *The namespaces and VectorTools provide an assortment of such as creating a Laplace projecting or interpolating a function onto the present finite element etc The difference to the functions in the DoFTools and FETools functions is that they work on the DoFTools functions only act on a given DoFHandler object without reference to a data vector</div><div class="ttdef"><b>Definition:</b> <a href="numerical__algorithms__0_8txt_source.html#l00008">numerical_algorithms_0.txt:8</a></div></div>
<div class="ttc" id="aclassDataPostprocessor_html_a1ba57b598d24d64365d469a854271c68"><div class="ttname"><a href="classDataPostprocessor.html#a1ba57b598d24d64365d469a854271c68">DataPostprocessor::evaluate_vector_field</a></div><div class="ttdeci">virtual void evaluate_vector_field(const DataPostprocessorInputs::Vector&lt; dim &gt; &amp;input_data, std::vector&lt; Vector&lt; double &gt;&gt; &amp;computed_quantities) const</div><div class="ttdef"><b>Definition:</b> <a href="data__postprocessor_8cc_source.html#l00037">data_postprocessor.cc:37</a></div></div>
<div class="ttc" id="abase_2index__set_8h_html"><div class="ttname"><a href="base_2index__set_8h.html">index_set.h</a></div></div>
<div class="ttc" id="anamespacetypes_html_aaf4eb6ec214fa642dfd956f11a9cd2d7"><div class="ttname"><a href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a></div><div class="ttdeci">unsigned int boundary_id</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00117">types.h:117</a></div></div>
<div class="ttc" id="anamespaceLAPACKSupport_html_a8cac1e477eff052db622c8a9a9426ea3"><div class="ttname"><a href="namespaceLAPACKSupport.html#a8cac1e477eff052db622c8a9a9426ea3">LAPACKSupport::T</a></div><div class="ttdeci">static const char T</div><div class="ttdef"><b>Definition:</b> <a href="lac_2lapack__support_8h_source.html#l00177">lapack_support.h:177</a></div></div>
<div class="ttc" id="anumerics_2solution__transfer_8h_html"><div class="ttname"><a href="numerics_2solution__transfer_8h.html">solution_transfer.h</a></div></div>
<div class="ttc" id="aauto__derivative__function__0_8txt_html_af5d8dd2d035de856717fb6b5c9438dd5"><div class="ttname"><a href="auto__derivative__function__0_8txt.html#af5d8dd2d035de856717fb6b5c9438dd5">h</a></div><div class="ttdeci">*This class automatically computes the gradient of a function by employing numerical difference quotients This only if the user function does not provide the gradient function himself *The following example of an user defined function overloads and implements only the where the latter function employs numerical difference quotients *****If the user overloads and implements also the gradient of the users gradient function is called that the usage of the also applies to the see e g respectively *Furthermore that an object of this class does[1.x.1] represent the derivative of a like that gives a directional derivative by calling the this class the AutoDerivativeFunction class can substitute the Function class as base class for user defined classes This class implements the gradient() functions for automatic computation of numerical difference quotients and serves as intermediate class between the base Function class and the user defined function class. ***[2.x.2] **[0.x.1] *Names of difference formulas. *[0.x.2] *The symmetric Euler formula of second order absolutely necessary in this case **Choose the difference formula See the enum DifferenceFormula for available choices **Takes the difference step size&lt; tt &gt; h&lt;/tt &gt; It s within the user s responsibility to choose an appropriate value here&lt; tt &gt; h&lt;/tt &gt; should be chosen taking into account the absolute value of as well as the amount of variation of the function Setting&lt; tt &gt; h</div><div class="ttdef"><b>Definition:</b> <a href="auto__derivative__function__0_8txt_source.html#l00034">auto_derivative_function_0.txt:34</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a6272720f5146b05de94c888f42bf143f"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a6272720f5146b05de94c888f42bf143f">Step32::EquationData::radiogenic_heating</a></div><div class="ttdeci">constexpr double radiogenic_heating</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00095">step-32.cc:95</a></div></div>
<div class="ttc" id="aclassMapping_html"><div class="ttname"><a href="classMapping.html">Mapping</a></div><div class="ttdoc">Abstract base class for mapping classes. This class declares the interface for the functionality to d...</div><div class="ttdef"><b>Definition:</b> <a href="fe_2mapping_8h_source.html#l00270">mapping.h:270</a></div></div>
<div class="ttc" id="abase_2logstream_8h_html"><div class="ttname"><a href="base_2logstream_8h.html">logstream.h</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a></div><div class="ttdeci">@ always</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00221">dof_tools.h:221</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1SolverCG_html"><div class="ttname"><a href="classTrilinosWrappers_1_1SolverCG.html">TrilinosWrappers::SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__solver_8h_source.html#l00390">trilinos_solver.h:390</a></div></div>
<div class="ttc" id="alac_2trilinos__precondition_8h_html"><div class="ttname"><a href="lac_2trilinos__precondition_8h.html">trilinos_precondition.h</a></div></div>
<div class="ttc" id="aclassKellyErrorEstimator_html_aa0917e696d4f8ddb983223a68c512357"><div class="ttname"><a href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a></div><div class="ttdeci">static void estimate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim - 1 &gt; &amp;quadrature, const std::map&lt; types::boundary_id, const Function&lt; spacedim, typename InputVector::value_type &gt; * &gt; &amp;neumann_bc, const InputVector &amp;solution, Vector&lt; float &gt; &amp;error, const ComponentMask &amp;component_mask=ComponentMask(), const Function&lt; spacedim &gt; *coefficients=nullptr, const unsigned int n_threads=numbers::invalid_unsigned_int, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id, const types::material_id material_id=numbers::invalid_material_id, const Strategy strategy=cell_diameter_over_24)</div></div>
<div class="ttc" id="anumerics_2matrix__tools_8h_html"><div class="ttname"><a href="numerics_2matrix__tools_8h.html">matrix_tools.h</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Vector_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00140">fe_values_extractors.h:140</a></div></div>
<div class="ttc" id="amapping__fe__0_8txt_html_a0af9c36aca1d2fa34a8615b4521ad4de"><div class="ttname"><a href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">map</a></div><div class="ttdeci">where is the first fundamental form of the map</div><div class="ttdef"><b>Definition:</b> <a href="mapping__fe__0_8txt_source.html#l00084">mapping_fe_0.txt:84</a></div></div>
<div class="ttc" id="aclassFilteredIterator_html"><div class="ttname"><a href="classFilteredIterator.html">FilteredIterator</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2filtered__iterator_8h_source.html#l00531">filtered_iterator.h:531</a></div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
<div class="ttc" id="amg__transfer__0_8txt_html_a6b401cd9c6154fc787311f58ab910002"><div class="ttname"><a href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div><div class="ttdeci">MGTransferBase is defined in mg_base h ***Implementation of transfer between the global vectors and the multigrid levels for use in the derived class MGTransferPrebuilt and other classes ***Reset the object to the state it had right after the default constructor **Transfer from a vector on the global grid to vectors defined on each of the levels separately for the active degrees of freedom In for a globally refined mesh only the finest level in[2.x.0] is filled as a plain copy of[2.x.1] All the other level objects are left untouched **Transfer from multi level vector to normal vector Copies data from active portions of an MGVector into the respective positions of a&lt; tt &gt; Vector&lt; number &gt;&lt;/tt &gt; In order to keep the result constrained degrees of freedom are set to zero **Add a multi level vector to a normal vector Works as the previous but probably not for continuous elements **If this object operates on BlockVector we need to describe how the individual vector components are mapped to the blocks of a vector For for a Stokes we have dim vector components for velocity and pressure</div><div class="ttdef"><b>Definition:</b> <a href="mg__transfer__0_8txt_source.html#l00017">mg_transfer_0.txt:17</a></div></div>
<div class="ttc" id="avector__tools__point__value__0_8txt_html_ac7a5c2ceb5c739d5b51cc7e0eee8100a"><div class="ttname"><a href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a></div><div class="ttdeci">*Assembling of right hand sides **Create a right hand side vector for a point source at point[2.x.1] In other it creates a vector[2.x.2] so that[2.x.3] where[2.x.4] are the shape functions described by[2.x.5] and[2.x.6] is the point at which the delta function is located Prior content of the given[2.x.7] vector is deleted This function is for the case of a scalar finite element This function is typically used in one of these two with different values for right hand sides or and then evaluate the solution at the same point every time You could do this by calling[2.x.8] after each solve</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__point__value__0_8txt_source.html#l00015">vector_tools_point_value_0.txt:15</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gae9a45f517af1401c50811a11083f9114"><div class="ttname"><a href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">StandardExceptions::ExcMessage</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcMessage(std::string arg1)</div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a></div><div class="ttdeci">@ component_is_scalar</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00055">data_component_interpretation.h:55</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_ad85de345ccd86a53e63746709c8e1dfc"><div class="ttname"><a href="namespaceGridGenerator.html#ad85de345ccd86a53e63746709c8e1dfc">GridGenerator::hyper_shell</a></div><div class="ttdeci">void hyper_shell(Triangulation&lt; dim &gt; &amp;tria, const Point&lt; dim &gt; &amp;center, const double inner_radius, const double outer_radius, const unsigned int n_cells=0, bool colorize=false)</div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a9261a9f89e9ac2f736f13cac115d1135"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a9261a9f89e9ac2f736f13cac115d1135">Step32::EquationData::specific_heat</a></div><div class="ttdeci">constexpr double specific_heat</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00094">step-32.cc:94</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_a796721b56b3a90e4e3973c7caae4c3d8"><div class="ttname"><a href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; count_dofs_per_fe_block(const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::vector&lt; unsigned int &gt; &amp;target_block=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01943">dof_tools.cc:1943</a></div></div>
<div class="ttc" id="atrilinos__sparsity__pattern__0_8txt_html_a232d55e29175b7b4f77582f2185b056c"><div class="ttname"><a href="trilinos__sparsity__pattern__0_8txt.html#a232d55e29175b7b4f77582f2185b056c">locally</a></div><div class="ttdeci">*Accessor class for iterators into sparsity patterns This class is also the base class for both const and non const accessor classes into sparse matrices Note that this class only allows read access to elements providing their row and column number It does not allow modifying the sparsity pattern itself ***Declare type for container size **Constructor **Row number of the element represented by this object **Index in row of the element represented by this object **Column number of the element represented by this object **Exception **Exception **The matrix accessed **Current row number **Current index in row **Cache where we store the column indices of the present row This is since Trilinos makes access to the elements of its matrices rather and it is much more efficient to copy all column entries of a row once when we enter it than repeatedly asking Trilinos for individual ones This also makes some sense since it is likely that we will access them sequentially anyway In order to make copying of iterators accessor of acceptable we keep a shared pointer to these entries so that more than one accessor can access this data if necessary **Discard the old row if both iterators point to the same matrix position **Inverse with the difference that this class can work fully in parallel according to a partitioning of the sparsity pattern rows This class has many similarities to the DynamicSparsityPattern since it can dynamically add elements to the pattern without any memory being previously reserved for it However it also has a method[2.x.3] that finalizes the pattern and enables its use with Trilinos sparse matrices ****Declare type for container size **Declare an alias for the iterator class **Basic constructors and initialization **Default constructor Generates an having[2.x.7] rows and[2.x.8] columns The resulting matrix will be completely stored locally</div><div class="ttdef"><b>Definition:</b> <a href="trilinos__sparsity__pattern__0_8txt_source.html#l00067">trilinos_sparsity_pattern_0.txt:67</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_a61fa98fdc0c52980a5b1de0ee1fc5bb2"><div class="ttname"><a href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">ParameterHandler::get_integer</a></div><div class="ttdeci">long int get_integer(const std::string &amp;entry_string) const</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l01025">parameter_handler.cc:1025</a></div></div>
<div class="ttc" id="alac_2trilinos__solver_8h_html"><div class="ttname"><a href="lac_2trilinos__solver_8h.html">trilinos_solver.h</a></div></div>
<div class="ttc" id="aclassTensor_html"><div class="ttname"><a href="classTensor.html">Tensor&lt; 1, dim &gt;</a></div></div>
<div class="ttc" id="aclassDataOut_html_a087f63e22f0614bca326dbdca288c646"><div class="ttname"><a href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01071">data_out.cc:1071</a></div></div>
<div class="ttc" id="anamespaceDoFRenumbering_html_a52c1941406d1ce2937e29a46edf111f4"><div class="ttname"><a href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a></div><div class="ttdeci">void component_wise(DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const std::vector&lt; unsigned int &gt; &amp;target_component=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering_8cc_source.html#l00681">dof_renumbering.cc:681</a></div></div>
<div class="ttc" id="ageometry__info__0_8txt_html_a30a552b07accf65da90f851e25d14d1c"><div class="ttname"><a href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div><div class="ttdeci">3, where it offers following possibilities:a face(quad) being refined in x- or y-direction(in the face-intern coordinate system) separately,([2.x.79] or([2.x.80] which corresponds to([2.x.81]). Additionally, it offers the possibilities a face can have through repeated anisotropic refinement steps performed on one of the two neighboring cells. It might be possible for example, that a face(quad) is refined with[2.x.82] and afterwards the left child is again refined with[2.x.83], so that there are three active subfaces. Note, however, that only refinement cases are allowed such that each line on a face between two hexes has not more than one hanging node. Furthermore, it is not allowed that two neighboring hexes are refined such that one of the hexes refines the common face with[2.x.84] and the other hex refines that face with[2.x.85] . In fact,[2.x.86] takes care of this situation and ensures that each face of a refined cell is completely contained in a single face of neighboring cells. The following drawings explain the SubfacePossibilities and give the corresponding subface numbers:*[1.x.4] **[2.x.87] *[0.x.68] *Possible cases of faces being subdivided into subface. See documentation to the SubfacePossibilities&lt; 3 &gt; for more details on the subface possibilities. *[0.x.69] *A class that provides all possible cases a face(in the current space dimension[2.x.88] might be subdivided into subfaces. *[2.x.89] *[0.x.70] *Constructor. Take and store a value indicating a particular subface possibility in the list of possible situations specified in the base class. *[0.x.71] *Return the numeric value stored by this class. While the presence of this operator might seem dangerous, it is useful in cases where one would like to have code like&lt; code &gt;switch(subface_case)... case[2.x.90] ...&lt;/code &gt;, which can be written as&lt; code &gt;switch[2.x.91] Another application is to use an object of the current type as an index into an array dim</div><div class="ttdef"><b>Definition:</b> <a href="geometry__info__0_8txt_source.html#l00202">geometry_info_0.txt:202</a></div></div>
<div class="ttc" id="ablock__info__0_8txt_html_adf3728ee2be920ec28e2f66b5a04a213"><div class="ttname"><a href="block__info__0_8txt.html#adf3728ee2be920ec28e2f66b5a04a213">global</a></div><div class="ttdeci">*** global</div><div class="ttdef"><b>Definition:</b> <a href="block__info__0_8txt_source.html#l00005">block_info_0.txt:5</a></div></div>
<div class="ttc" id="aclassparallel_1_1distributed_1_1Triangulation_html"><div class="ttname"><a href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt; dim &gt;</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_af85863b31be0cbd660acba99051e0634"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#af85863b31be0cbd660acba99051e0634">data</a></div><div class="ttdeci">****This module contains classes that are used in the exception mechanism of deal II **Exceptions are used in two different not in static assertions are typically used to check that parameters to functions satisfy certain that internal data structures are and similar assertions For static assertions are used to make sure that two vectors that are added together have the same number of components **everything else would not make any sense anyway *Such checks are performed by the[2.x.3] macro in several thousand places within the library several tutorial programs starting with[2.x.4] show how to do this *If static a assertion is the exception mechanism generates an exception of a type that indicates what exactly goes wrong displays appropriate information including the exact location where the problem was detected and then aborts the program **if you try to add two vectors of different there is nothing that can be done within the program to cope with the you have to go fix the program code instead There is generally not even a reason to[2.x.5] an exception object using the usual C exception mechanism because there is nothing a function higher up could do in such cases to rectify the situation and deal with it in a useful way **it s not that the program received bad data</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00015">exceptions_0.txt:15</a></div></div>
<div class="ttc" id="anamespaceStep31_1_1EquationData_html_a0932f2f724c5bb6bae12cd93de21fdba"><div class="ttname"><a href="namespaceStep31_1_1EquationData.html#a0932f2f724c5bb6bae12cd93de21fdba">Step31::EquationData::kappa</a></div><div class="ttdeci">constexpr double kappa</div><div class="ttdef"><b>Definition:</b> <a href="step-31_8cc_source.html#l00073">step-31.cc:73</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_a4ac3a8b19ade16e96e8ea25906daf23a"><div class="ttname"><a href="classParameterHandler.html#a4ac3a8b19ade16e96e8ea25906daf23a">ParameterHandler::print_parameters</a></div><div class="ttdeci">std::ostream &amp; print_parameters(std::ostream &amp;out, const OutputStyle style) const</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l01250">parameter_handler.cc:1250</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_ab544a3bf3301a6dd3e705ee352c5551b"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ab544a3bf3301a6dd3e705ee352c5551b">Utilities::MPI::sum</a></div><div class="ttdeci">T sum(const T &amp;t, const MPI_Comm &amp;mpi_communicator)</div></div>
<div class="ttc" id="anamespaceVectorTools_html_ab2562d41bb26f362043f9719a8cd9b87"><div class="ttname"><a href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></div><div class="ttdeci">void interpolate_boundary_values(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::map&lt; types::boundary_id, const Function&lt; spacedim, number &gt; * &gt; &amp;function_map, std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
<div class="ttc" id="adistributed_2grid__refinement_8h_html"><div class="ttname"><a href="distributed_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a00bf6e26439db0d8e3b91f11ee4fd72a"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a00bf6e26439db0d8e3b91f11ee4fd72a">Step32::EquationData::T1</a></div><div class="ttdeci">constexpr double T1</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00102">step-32.cc:102</a></div></div>
<div class="ttc" id="aclassSparseVanka_html_a34195e21adf1756d5d316cfc1091d843"><div class="ttname"><a href="classSparseVanka.html#a34195e21adf1756d5d316cfc1091d843">SparseVanka::vmult</a></div><div class="ttdeci">void vmult(Vector&lt; number2 &gt; &amp;dst, const Vector&lt; number2 &gt; &amp;src) const</div></div>
<div class="ttc" id="agroup__Exceptions_html_ga8364dda711b93753c6809eefe2a8e827a3a1480568c2713f53dcb21319bb28093"><div class="ttname"><a href="group__Exceptions.html#ga8364dda711b93753c6809eefe2a8e827a3a1480568c2713f53dcb21319bb28093">ParameterHandler::Text</a></div><div class="ttdeci">@ Text</div><div class="ttdef"><b>Definition:</b> <a href="base_2parameter__handler_8h_source.html#l00880">parameter_handler.h:880</a></div></div>
<div class="ttc" id="aA-headers_2fe__0_8txt_html_abbd000c1bb0a029706ba0d8934597f39"><div class="ttname"><a href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a></div><div class="ttdeci">****All classes related to shape functions and to access to shape functions This concerns the actual values of finite elements For the numbering of degrees of freedom refer to the module on *[2.x.1] The classes and functions of this module fall into several sub groups that are discussed in their respective sub modules listed above In the FETools class provides functions that provide information on finite elements transformations between elements etc *In the grand scheme of the pieces of this module interact with a variety of other parts of the without actually implementing a concrete element For the FiniteElement base class declares the virtual functions a derived class has to implement if it wants to describe a finite element space Likewise the FiniteElementData holds variables that describe certain values characterizing a finite element such as the number of degrees of freedom per vertex line or face *On the other classes like FE_Poly and FE_PolyTensor are higher abstractions They describe finite elements that are built atop polynomial descriptions of the shape functions on the unit cell Classes derived from them then only have to provide a description of the particular polynomial from which a finite element is built For the FE_Q class that implements the usual Lagrange elements uses the FE_Poly base class to generate a finite element by providing it with a set of Lagrange interpolation polynomials corresponding to an equidistant subdivision of interpolation points the FESystem class is used for vector valued problems There one may want to couple a number of for Navier Stokes one may want to use three Q1 elements for the three components of the velocity</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2fe__0_8txt_source.html#l00021">fe_0.txt:21</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a07cc42f575df3d9738a6ba4845989852"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a07cc42f575df3d9738a6ba4845989852">Step32::EquationData::pressure_scaling</a></div><div class="ttdeci">constexpr double pressure_scaling</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00166">step-32.cc:166</a></div></div>
<div class="ttc" id="aclassFunction_html_acbfcab66b2fc63bfea59268f40772bb4"><div class="ttname"><a href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">Function::value</a></div><div class="ttdeci">virtual RangeNumberType value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const</div></div>
<div class="ttc" id="alac_2solver__bicgstab_8h_html"><div class="ttname"><a href="lac_2solver__bicgstab_8h.html">solver_bicgstab.h</a></div></div>
<div class="ttc" id="anamespaceStep20_1_1PrescribedSolution_html_a6142e18d25af27882714d1787af4ee59"><div class="ttname"><a href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">Step20::PrescribedSolution::alpha</a></div><div class="ttdeci">constexpr double alpha</div><div class="ttdef"><b>Definition:</b> <a href="step-20_8cc_source.html#l00087">step-20.cc:87</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1BlockSparsityPattern_html"><div class="ttname"><a href="classTrilinosWrappers_1_1BlockSparsityPattern.html">TrilinosWrappers::BlockSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparsity__pattern_8h_source.html#l00664">block_sparsity_pattern.h:664</a></div></div>
<div class="ttc" id="adofs_2dof__tools_8h_html"><div class="ttname"><a href="dofs_2dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="agrid_2grid__refinement_8h_html"><div class="ttname"><a href="grid_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="afe_2fe__system_8h_html"><div class="ttname"><a href="fe_2fe__system_8h.html">fe_system.h</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f"><div class="ttname"><a href="group__TrilinosWrappers.html#ga36b8fa00a7ce0a5ed1ab0cddd41e4f9f">TrilinosWrappers::PreconditionAMG::AdditionalData::aggregation_threshold</a></div><div class="ttdeci">double aggregation_threshold</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01549">trilinos_precondition.h:1549</a></div></div>
<div class="ttc" id="avector__valued__0_8txt_html_add141cdc4d28d06d71948acb7f0c7150"><div class="ttname"><a href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a></div><div class="ttdeci">each of these vectors has[2.x.174] elements containing the values of the[2.x.175] velocities and the one pressure at a quadrature point *We can use these values to then construct other things like residuals the construct is a bit awkward we have a[2.x.176] s</div><div class="ttdef"><b>Definition:</b> <a href="vector__valued__0_8txt_source.html#l00155">vector_valued_0.txt:155</a></div></div>
<div class="ttc" id="agroup__Vectors_html_ga40c50779cd14ba89bbf0bd9b4561964caf4784f9368d9386d7508c25daea9e19d"><div class="ttname"><a href="group__Vectors.html#ga40c50779cd14ba89bbf0bd9b4561964caf4784f9368d9386d7508c25daea9e19d">VectorOperation::insert</a></div><div class="ttdeci">@ insert</div><div class="ttdef"><b>Definition:</b> <a href="lac_2vector__operation_8h_source.html#l00051">vector_operation.h:51</a></div></div>
<div class="ttc" id="aclassFiniteElement_html"><div class="ttname"><a href="classFiniteElement.html">FiniteElement&lt; dim &gt;</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a602682024ec652b990be121b5665f8ce"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a602682024ec652b990be121b5665f8ce">set</a></div><div class="ttdeci">&lt;/tt &gt; **If the&lt; tt &gt;&lt;/tt &gt; preprocessor directive is set</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00031">exceptions_0.txt:31</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_a1a9fea1222a1f75ee681b6805de5f7fc"><div class="ttname"><a href="distributed__0_8txt.html#a1a9fea1222a1f75ee681b6805de5f7fc">mesh</a></div><div class="ttdeci">********clusters ***deal II can use multiple machines connected via MPI to parallelize in addition to the parallelization within a shared memory machine discussed in the[2.x.4] module There are essentially two ways to utilize multiple but only a share of the global sparsity and solution vector is stored on each machine ****The mesh and DoF handler are also i e each processor stores only a share of the cells and degrees of freedom No processor has knowledge of the entire mesh</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00025">distributed_0.txt:25</a></div></div>
<div class="ttc" id="aA-headers_2fe__0_8txt_html_ac58f1344c78bfcb3556c763b59c923c6"><div class="ttname"><a href="A-headers_2fe__0_8txt.html#ac58f1344c78bfcb3556c763b59c923c6">The</a></div><div class="ttdeci">****All classes related to shape functions and to access to shape functions This concerns the actual values of finite elements For the numbering of degrees of freedom refer to the module on *[2.x.1] The classes and functions of this module fall into several sub groups that are discussed in their respective sub modules listed above In the FETools class provides functions that provide information on finite elements transformations between elements etc *In the grand scheme of the pieces of this module interact with a variety of other parts of the without actually implementing a concrete element For the FiniteElement base class declares the virtual functions a derived class has to implement if it wants to describe a finite element space Likewise the FiniteElementData holds variables that describe certain values characterizing a finite element such as the number of degrees of freedom per vertex line or face *On the other classes like FE_Poly and FE_PolyTensor are higher abstractions They describe finite elements that are built atop polynomial descriptions of the shape functions on the unit cell Classes derived from them then only have to provide a description of the particular polynomial from which a finite element is built For the FE_Q class that implements the usual Lagrange elements uses the FE_Poly base class to generate a finite element by providing it with a set of Lagrange interpolation polynomials corresponding to an equidistant subdivision of interpolation points the FESystem class is used for vector valued problems There one may want to couple a number of for Navier Stokes one may want to use three Q1 elements for the three components of the and a piecewise constant Q0 element for the pressure The FESystem class can be used to couple these four base elements together into a single vector valued element with vector components The[2.x.3]</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2fe__0_8txt_source.html#l00021">fe_0.txt:21</a></div></div>
<div class="ttc" id="aclassBlockVectorBase_html_a71b0ab8295e98caf3dfe1ef14ae6b6c1"><div class="ttname"><a href="classBlockVectorBase.html#a71b0ab8295e98caf3dfe1ef14ae6b6c1">BlockVectorBase::sadd</a></div><div class="ttdeci">void sadd(const value_type s, const BlockVectorBase &amp;V)</div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00039">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_a03a2f48682e29e39f7bccc11a7d1c4d1"><div class="ttname"><a href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has degree[1.x.4]</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00003">polynomial_space_0.txt:3</a></div></div>
<div class="ttc" id="abase_2quadrature__lib_8h_html"><div class="ttname"><a href="base_2quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a96ecfde131843f52ee49d0e0c1180134"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div><div class="ttdeci">computing derivatives of these terms is impractical in most applications in impossible to get right Higher derivatives are even more impossible to do without computer aid Automatic or symbolic differentiation is a way out of and gets compile time</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00012">automatic_and_symbolic_differentiation_0.txt:12</a></div></div>
<div class="ttc" id="anamespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">EvaluationFlags::values</a></div><div class="ttdeci">@ values</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2evaluation__flags_8h_source.html#l00055">evaluation_flags.h:55</a></div></div>
<div class="ttc" id="agrid_2manifold__lib_8h_html"><div class="ttname"><a href="grid_2manifold__lib_8h.html">manifold_lib.h</a></div></div>
<div class="ttc" id="aclassSmartPointer_html"><div class="ttname"><a href="classSmartPointer.html">SmartPointer</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2smartpointer_8h_source.html#l00067">smartpointer.h:67</a></div></div>
<div class="ttc" id="afunction__time__0_8txt_html_aec9d63e7b1c02618470be701525a5211"><div class="ttname"><a href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">sin</a></div><div class="ttdeci">*Support for time dependent functions The library was also designed for time dependent problems For this the function objects also contain a field which stores the as well as functions manipulating them Time independent problems should not access or even abuse them for other but since one normally does not create thousands of function the gain in generality weighs out the fact that we need not store the time value for not time dependent problems The second advantage is that the derived standard classes like&lt; tt &gt;&lt; tt &gt; ConstantFunction&lt;/tt &gt; etc also work for time dependent problems *Access to the time goes through the following so that derived classes can perform computations which need only be done once for every new time For if a time dependent function had a factor&lt; tt &gt; sin(t)&lt;/tt &gt;</div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_a8f384576a64c89a6fa8352847523e340"><div class="ttname"><a href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for n_q_points</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00537">fe_evaluation_0.txt:537</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga31978c026b8b6b5116df30b8e748f6b7"><div class="ttname"><a href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">StandardExceptions::ExcInternalError</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcInternalError()</div></div>
<div class="ttc" id="adistributed_2tria_8h_html"><div class="ttname"><a href="distributed_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="anamespaceGridTools_html_acd5ccc543d561cfb086b571d1f7818cb"><div class="ttname"><a href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a></div><div class="ttdeci">double diameter(const Triangulation&lt; dim, spacedim &gt; &amp;tria)</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools_8cc_source.html#l00081">grid_tools.cc:81</a></div></div>
<div class="ttc" id="aclassQTrapezoid_html"><div class="ttname"><a href="classQTrapezoid.html">QTrapezoid</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00126">quadrature_lib.h:126</a></div></div>
<div class="ttc" id="adofs_2dof__renumbering_8h_html"><div class="ttname"><a href="dofs_2dof__renumbering_8h.html">dof_renumbering.h</a></div></div>
<div class="ttc" id="amapping__q__internal__0_8txt_html_a55ac427dfa58d3b640a4293648e4b6d8"><div class="ttname"><a href="mapping__q__internal__0_8txt.html#a55ac427dfa58d3b640a4293648e4b6d8">eta</a></div><div class="ttdeci">namespace to implement methods specific to MappingQ1 in particular an explicit formula for the transformation from the real to the unit cell in D *There are two ways to compute xi from eta</div><div class="ttdef"><b>Definition:</b> <a href="mapping__q__internal__0_8txt_source.html#l00002">mapping_q_internal_0.txt:2</a></div></div>
<div class="ttc" id="aclassPrimitiveVectorMemory_html"><div class="ttname"><a href="classPrimitiveVectorMemory.html">PrimitiveVectorMemory</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2lac_2vector__memory_8h_source.html#l00231">vector_memory.h:231</a></div></div>
<div class="ttc" id="afe_2fe__dgp_8h_html"><div class="ttname"><a href="fe_2fe__dgp_8h.html">fe_dgp.h</a></div></div>
<div class="ttc" id="adistributed_2solution__transfer_8h_html"><div class="ttname"><a href="distributed_2solution__transfer_8h.html">solution_transfer.h</a></div></div>
<div class="ttc" id="afe__q__base__0_8txt_html_af36d3d5134aa2e6fa02ba348a4c3295f"><div class="ttname"><a href="fe__q__base__0_8txt.html#af36d3d5134aa2e6fa02ba348a4c3295f">n_dofs_per_cell</a></div><div class="ttdeci">*This class collects the basic methods used in FE_Q FE_Q_DG0 and FE_Q_Bubbles There is no public constructor for this class as it is not functional as a stand alone The completion of definitions is left to the derived classes ***Constructor **Return the matrix interpolating from the given finite element to the present one The size of the matrix is then[2.x.0] times&lt; tt &gt; source n_dofs_per_cell()&lt;/tt &gt;. These matrices are only available if the source element is also a[2.x.1] element. Otherwise</div></div>
<div class="ttc" id="arepartitioning__policy__tools__0_8txt_html_ad72b731ec4910675337cb83132a0f916"><div class="ttname"><a href="repartitioning__policy__tools__0_8txt.html#ad72b731ec4910675337cb83132a0f916">partition</a></div><div class="ttdeci">namespace with repartitioning policies These classes return vectors of of the new owners of the active locally owned and ghost cells of a Triangulation object The returned vectors can be used e g in[2.x.0] to create a[2.x.1] based on a given Triangulation and the predescribed partition</div><div class="ttdef"><b>Definition:</b> <a href="repartitioning__policy__tools__0_8txt_source.html#l00002">repartitioning_policy_tools_0.txt:2</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00124">fe_update_flags.h:124</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01581">exceptions.h:1581</a></div></div>
<div class="ttc" id="abase_2conditional__ostream_8h_html"><div class="ttname"><a href="base_2conditional__ostream_8h.html">conditional_ostream.h</a></div></div>
<div class="ttc" id="aclassSymmetricTensor_html_a1b2101a1d45267f1fd4664ed178cb636"><div class="ttname"><a href="classSymmetricTensor.html#a1b2101a1d45267f1fd4664ed178cb636">SymmetricTensor::symmetrize</a></div><div class="ttdeci">constexpr SymmetricTensor&lt; 2, dim, Number &gt; symmetrize(const Tensor&lt; 2, dim, Number &gt; &amp;t)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l03588">symmetric_tensor.h:3588</a></div></div>
<div class="ttc" id="aclassVectorizedArray_html_a2be646da1dcbc52f538c49923fb71c50"><div class="ttname"><a href="classVectorizedArray.html#a2be646da1dcbc52f538c49923fb71c50">VectorizedArray::abs</a></div><div class="ttdeci">VectorizedArray&lt; Number, width &gt; abs(const ::VectorizedArray&lt; Number, width &gt; &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="origin_2base_2vectorization_8h_source.html#l05397">vectorization.h:5397</a></div></div>
<div class="ttc" id="aclassFE__DGP_html"><div class="ttname"><a href="classFE__DGP.html">FE_DGP</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__dgp_8h_source.html#l00286">fe_dgp.h:286</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_ade22ffd9fb5b07842daa504929244aa7"><div class="ttname"><a href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">FEValuesBase::get_fe</a></div><div class="ttdeci">const FiniteElement&lt; dim, spacedim &gt; &amp; get_fe() const</div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_a895dcd8223a0ee6f0e6a80b80e2d5982"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a></div><div class="ttdeci">unsigned int this_mpi_process(const MPI_Comm &amp;mpi_communicator)</div><div class="ttdef"><b>Definition:</b> <a href="mpi_8cc_source.html#l00128">mpi.cc:128</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a680d8b0d6d9162296d224196cfd47028"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a680d8b0d6d9162296d224196cfd47028">parameters</a></div><div class="ttdeci">and situations where one is given a parameter dependent problem[2.x.4] and wants to form derivatives with regards to the parameters[2.x.5]</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00010">automatic_and_symbolic_differentiation_0.txt:10</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_acbc07b5e8caacadaf9798840a22d1603"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#acbc07b5e8caacadaf9798840a22d1603">Step32::EquationData::reference_density</a></div><div class="ttdeci">constexpr double reference_density</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00091">step-32.cc:91</a></div></div>
<div class="ttc" id="alac_2full__matrix_8h_html"><div class="ttname"><a href="lac_2full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="alac_2solver__cg_8h_html"><div class="ttname"><a href="lac_2solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="abase_2work__stream_8h_html"><div class="ttname"><a href="base_2work__stream_8h.html">work_stream.h</a></div></div>
<div class="ttc" id="asparse__decomposition__0_8txt_html_aa36e69f7b51d00cbf24c899c1490950c"><div class="ttname"><a href="sparse__decomposition__0_8txt.html#aa36e69f7b51d00cbf24c899c1490950c">factor</a></div><div class="ttdeci">Preconditioners *[2.x.1] **Abstract base class for incomplete decompositions of a sparse matrix into sparse factors This class can t be used by itself but only as the base class of derived classes that actually implement particular decompositions such as SparseILU or SparseMIC *The decomposition is stored as a sparse matrix which is why this class is derived from the SparseMatrix Since it is not a matrix in the usual the derivation is&lt; tt &gt; protected&lt;/tt &gt; rather than&lt; tt &gt; public&lt;/tt &gt; ***Sparse decompositions are frequently used with additional fill i the sparsity structure of the decomposition is denser than that of the matrix to be decomposed The i e the sparsity pattern of the decomposition is a superset of the sparsity pattern in the original matrix *Such fill in can be accomplished by various one of which is the copy constructor of the SparsityPattern class that allows the addition of side diagonals to a given sparsity structure ***While objects of this class can not be used derived classes such as SparseILU and SparseMIC can be used in the usual form as preconditioners For this each it copies the sparsity of[2.x.3] and adds a specific number of extra off diagonal entries specified by *[2.x.4] By setting[2.x.5] the sparsity is not recreated but the sparsity of the previous as for example several Newton iteration steps on the same triangulation The default is *[2.x.6] It is possible to give a user defined sparsity to[2.x.7] no sparsity is created but[2.x.8] is used to store the decomposed matrix For restrictions on the sparsity see section Fill in above ***It is enough to override the like the true or the Cholesky decomposition if that decomposition needs fine tuned diagonal strengthening on a per row it may override the but only its derived classes **Deletes all member variables Leaves the class in the state that it had directly after calling the constructor **Parameters for SparseDecomposition **Constructor For the parameters see below **times the sum of absolute row entries is added to the diagonal entries Per this value is i e the diagonal is not strengthened **By the[2.x.10] function creates its own sparsity This sparsity has the same SparsityPattern as[2.x.11] with some extra off diagonals the number of which is specified by[2.x.12] The user can give a SparsityPattern to[2.x.13] Then this sparsity is used and the[2.x.14] argument is ignored **If this flag is true the as for example several Newton iteration steps on the same triangulation **When a SparsityPattern is given to this the as well as filtering out some elements in the matrix **This function needs to be called before an object of this class is used as preconditioner For more detail about possible parameters see the class documentation and the documentation of the[2.x.17] class According to this function creates a new SparsityPattern or keeps the previous sparsity or takes the sparsity given by the user to[2.x.19] this function performs the LU decomposition After this function is called the preconditioner is ready to be determines the strengthening factor(through get_strengthen_diagonal()) sf and multiplies the diagonal entry with[2.x.28] . *[0.x.23] *In the decomposition phase</div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1BlockSparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__block__sparse__matrix_8h_source.html#l00068">trilinos_block_sparse_matrix.h:68</a></div></div>
<div class="ttc" id="aclassConditionalOStream_html"><div class="ttname"><a href="classConditionalOStream.html">ConditionalOStream</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2conditional__ostream_8h_source.html#l00083">conditional_ostream.h:83</a></div></div>
<div class="ttc" id="anamespacenumbers_html_a8ae36952c7e0cc778b47b5371b3aeff1"><div class="ttname"><a href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a></div><div class="ttdeci">static const unsigned int invalid_unsigned_int</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00179">types.h:179</a></div></div>
<div class="ttc" id="astep-69_8cc_html_a66a64d07b4db87c87b639bdcf7b18c82"><div class="ttname"><a href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; local_dof_indices</div><div class="ttdef"><b>Definition:</b> <a href="step-69_8cc_source.html#l00534">step-69.cc:534</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a177c697348e3052c514824563807ea3b"><div class="ttname"><a href="coding__conventions__0_8txt.html#a177c697348e3052c514824563807ea3b">end</a></div><div class="ttdeci">**Throughout deal we strive to keep our programming style and the kind ofinterfaces we provide as consistent as possible To this end</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00003">coding_conventions_0.txt:3</a></div></div>
<div class="ttc" id="aclassFunction_html_ae316ebc05d21989d573024f8a23c49cb"><div class="ttname"><a href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">Function::vector_value</a></div><div class="ttdeci">virtual void vector_value(const Point&lt; dim &gt; &amp;p, Vector&lt; RangeNumberType &gt; &amp;values) const</div></div>
<div class="ttc" id="aquadrature__point__data__0_8txt_html_a35c4177ef651238576ebc1395f9e116e"><div class="ttname"><a href="quadrature__point__data__0_8txt.html#a35c4177ef651238576ebc1395f9e116e">refinement</a></div><div class="ttdeci">i a property that varies discontinuously within a solid In such trying to transfer data from the quadrature points to a finite element field that is once evaluated at a different set of quadrature the quadrature rule[2.x.94] used to integrate its mass matrix and finally the quadrature rule[2.x.95] which is used to store[2.x.96][2.x.97][2.x.98] has to be scalar valued *Since this class does projection on cell by cell basis[2.x.100] is only required to be continuous within the cell **Prepare for coarsening and refinement of a triangulation[2.x.101][2.x.102] represents the cell data which should be transferred and it should be initialized for each locally owned active cell *Although CellDataStorage class allows storing on different cells different objects derived from the base class here we assume that[2.x.104] contains objects of the same more specifically they pack unpack the same data **Interpolate the data previously stored in this object before the mesh was refined or coarsened onto the quadrature points of the currently active set of cells *Before calling this function the user is expected to populate the data stored in the[2.x.106] object provided to an exception will be thrown in debug mode **A callback function used to pack the data on the current mesh into objects that can later be retrieved after refinement</div><div class="ttdef"><b>Definition:</b> <a href="quadrature__point__data__0_8txt_source.html#l00085">quadrature_point_data_0.txt:85</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1Vector_html_a655ae9c8d3595133abe1131fcbb97b6d"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1Vector.html#a655ae9c8d3595133abe1131fcbb97b6d">TrilinosWrappers::MPI::Vector::reinit</a></div><div class="ttdeci">void reinit(const Vector &amp;v, const bool omit_zeroing_entries=false, const bool allow_different_maps=false)</div><div class="ttdef"><b>Definition:</b> <a href="trilinos__vector_8cc_source.html#l00198">trilinos_vector.cc:198</a></div></div>
<div class="ttc" id="astructSolverFGMRES_1_1AdditionalData_html"><div class="ttname"><a href="structSolverFGMRES_1_1AdditionalData.html">SolverFGMRES::AdditionalData</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__gmres_8h_source.html#l00488">solver_gmres.h:488</a></div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point&lt; dim &gt;</a></div></div>
<div class="ttc" id="aclassFunctions_1_1ZeroFunction_html"><div class="ttname"><a href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2function_8h_source.html#l00516">function.h:516</a></div></div>
<div class="ttc" id="atimer__0_8txt_html_a48e9e3a8116df3cc4b62db810904e91f"><div class="ttname"><a href="timer__0_8txt.html#a48e9e3a8116df3cc4b62db810904e91f">start</a></div><div class="ttdeci">*A compatible with the[2.x.0] notion of a whose by in multiples of of a second and POSIX uses so go with microseconds for uniformity **Signed integral type used to store the value returned by this requires platform specific so this function returns on platforms that are neither Windows nor POSIX **The Timer class provides a way to measure both the amount of wall or[2.x.1] as well as the total time elapsed over all laps Here is an you can also restart the timer instead of resetting it The times between successive calls to start() and stop()(i.e.</div></div>
<div class="ttc" id="alac_2trilinos__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2trilinos__sparse__matrix_8h.html">trilinos_sparse_matrix.h</a></div></div>
<div class="ttc" id="aclassParameterHandler_html"><div class="ttname"><a href="classParameterHandler.html">ParameterHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2parameter__handler_8h_source.html#l00820">parameter_handler.h:820</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_af29c20cde6d44186806d559beb468696"><div class="ttname"><a href="classParameterHandler.html#af29c20cde6d44186806d559beb468696">ParameterHandler::enter_subsection</a></div><div class="ttdeci">void enter_subsection(const std::string &amp;subsection)</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l00939">parameter_handler.cc:939</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_acad7e0841b9046eaafddc4c617ab1d9d"><div class="ttname"><a href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a></div><div class="ttdeci">void extract_locally_relevant_dofs(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, IndexSet &amp;dof_set)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01133">dof_tools.cc:1133</a></div></div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="anamespaceEuler__DG_html_a286a4c601bf0caec1702358838814327"><div class="ttname"><a href="namespaceEuler__DG.html#a286a4c601bf0caec1702358838814327">Euler_DG::gamma</a></div><div class="ttdeci">constexpr double gamma</div><div class="ttdef"><b>Definition:</b> <a href="step-67_8cc_source.html#l00066">step-67.cc:66</a></div></div>
<div class="ttc" id="aauto__derivative__function__0_8txt_html_a870ed0ddfded063c8c8570352ef8c122"><div class="ttname"><a href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a></div><div class="ttdeci">*This class automatically computes the gradient of a function by employing numerical difference quotients This only if the user function does not provide the gradient function himself *The following example of an user defined function overloads and implements only the where the latter function employs numerical difference quotients *****If the user overloads and implements also the gradient of the users gradient function is called that the usage of the also applies to the see e g vector_value()</div></div>
<div class="ttc" id="aclassDataPostprocessor_html_aadecdd040447b395164397ea1196f721"><div class="ttname"><a href="classDataPostprocessor.html#aadecdd040447b395164397ea1196f721">DataPostprocessor::get_needed_update_flags</a></div><div class="ttdeci">virtual UpdateFlags get_needed_update_flags() const =0</div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a1057295293dd9dfa723788107acc509e"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a1057295293dd9dfa723788107acc509e">Step32::EquationData::T0</a></div><div class="ttdeci">constexpr double T0</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00101">step-32.cc:101</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ad83f9d9d8b603ed71c3483de199bc7a7"><div class="ttname"><a href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a></div><div class="ttdeci">their purpose is merely to keepdeal II as uniform as possible Uniformity reduces the number of bugs weproduce because we for always assume that input arguments comebefore output arguments of a function call They also simplify reading codebecause some things become clear already by looking at the style a piece ofcode is without having to look up the exact definition of something **deal II uses[2.x.2] to normalize indentation Astyle file is provided at ***Before a you should run **on each of your files This will make sure indentation is conforming to thestyle guidelines outlined in this page *This is cumbersome and more you can just run **in whatever directory you set up the library to be compiled in</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00013">coding_conventions_0.txt:13</a></div></div>
<div class="ttc" id="adata__postprocessor__0_8txt_html_abfdf708e97518fa7ad2b849b80afddc1"><div class="ttname"><a href="data__postprocessor__0_8txt.html#abfdf708e97518fa7ad2b849b80afddc1">get_needed_update_flags</a></div><div class="ttdeci">is not the size of the solution then if the solution is real valued the solution_values variable below will be an array with as many entries as there are evaluation points on a and each entry is a vector of length[2.x.31] representing the[2.x.32] solution functions evaluated at a point On the other if the solution is complex then the solution_values member variable of this class will have[2.x.34] entries for each evaluation point The first[2.x.35] of these entries represent the real parts of the and the second[2.x.36] entries correspond to the imaginary parts of the solution evaluated at the evaluation point The same layout is used for the solution_gradients and solution_hessians then all the gradients Hessians of the imaginary components There is more information about the subject in the documentation of the DataPostprocessor class itself[2.x.37] provides an example of how this class is used in a complex valued situation Through the fields in the CommonInputs base class this class also makes available access to the locations of evaluations points normal and which cell data is currently being evaluated or other object The outer vector runs over the evaluation whereas the inner vector runs over the components of the finite element field for which output will be generated **An array of gradients of a vector valued solution at each of the evaluation points used to create graphical output from one or other object The outer vector runs over the evaluation whereas the inner vector runs over the components of the finite element field for which output will be generated This array is only filled if a user derived class overloads the[2.x.38] and the function a class derived from DataPostprocessorScalar DataPostprocessorVector or DataPostprocessorTensor may pass this flag to the constructor of these three classes **An array of second derivatives of a vector valued solution at each of the evaluation points used to create graphical output from one or other object The outer vector runs over the evaluation whereas the inner vector runs over the components of the finite element field for which output will be generated This array is only filled if a user derived class overloads the[2.x.40] and the function a class derived from DataPostprocessorScalar DataPostprocessorVector or DataPostprocessorTensor may pass this flag to the constructor of these three classes **This class provides an interface to compute derived quantities from a solution that can then be output in graphical formats for visualization using facilities such as the DataOut class *For which are calculated from the values of the solution and possibly the first and second derivatives of the solution Examples are the calculation of Mach numbers from velocity and density in supersonic flow or the computation of the magnitude of a complex valued solution as demonstrated in[2.x.42] the functions of this class can be overloaded to compute new quantities *A data vector and an object of a class derived from the current one can be given to the[2.x.46] in reality the object of your derived class has to live until the DataOut object is destroyed as the latter keeps a pointer to the former and will complain if the object pointed to is destroyed while the latter still has a pointer to it If both the data postprocessor and DataOut objects are variables of a then you can avoid this error by declaring the data postprocessor variable before the DataOut variable as objects are destroyed in reverse order of declaration *In order not to perform needless DataPostprocessor has to provide information which input data is needed for the calculation of the derived i e whether it needs the the first derivative and or the second derivative of the provided data DataPostprocessor objects which are used in combination with a DataOutFaces object can also ask for the normal vectors at each point The information which data is needed has to be provided via the UpdateFlags returned by virtual the function get_needed_update_flags(). It is your responsibility to use only those values which were updated in the calculation of derived quantities. The DataOut object will provide references to the requested data in the call to evaluate_scalar_field() or evaluate_vector_field()(DataOut decides which of the two functions to call depending on whether the finite element in use has only a single</div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">VectorTools::EvaluationFlags::min</a></div><div class="ttdeci">@ min</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00062">vector_tools_evaluate.h:62</a></div></div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2function_8h_source.html#l00140">function.h:140</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ac639e1db0b03fc797eca55e266afa976"><div class="ttname"><a href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per cell</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="aclassparallel_1_1distributed_1_1SolutionTransfer_html"><div class="ttname"><a href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a></div><div class="ttdef"><b>Definition:</b> <a href="distributed_2solution__transfer_8h_source.html#l00206">solution_transfer.h:206</a></div></div>
<div class="ttc" id="aclassSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__control_8h_source.html#l00052">solver_control.h:52</a></div></div>
<div class="ttc" id="abase_2partitioner__0_8txt_html_a6d2d0fa485d1660823c59c494fb0fb31"><div class="ttname"><a href="base_2partitioner__0_8txt.html#a6d2d0fa485d1660823c59c494fb0fb31">MPI</a></div><div class="ttdeci">*This class defines a model for the partitioning of a it includes a structure for the point to point communication patterns It allows the inclusion of ghost it also stores the other processors ghost indices belonging to the current which are the indices where other processors might require information from In a these import indices form the dual of the ghost indices This information is gathered once when constructing the which obviates subsequent global communication steps when exchanging data The figure below gives an example of index space[2.x.2] being split into four parts that are each owned by one MPI the next four lines indicate which elements of the overall array each processor wants to know about **this is generally a superset of the locally owned with the difference being what are called ghost elements To understand the remaining pieces of the remember that in MPI</div><div class="ttdef"><b>Definition:</b> <a href="base_2partitioner__0_8txt_source.html#l00004">partitioner_0.txt:4</a></div></div>
<div class="ttc" id="aclassSolverFGMRES_html"><div class="ttname"><a href="classSolverFGMRES.html">SolverFGMRES</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__gmres_8h_source.html#l00481">solver_gmres.h:481</a></div></div>
<div class="ttc" id="abase_2numbers_8h_html_a0ebae11c64606a73e80a6328b1ab0802"><div class="ttname"><a href="base_2numbers_8h.html#a0ebae11c64606a73e80a6328b1ab0802">std::abs</a></div><div class="ttdeci">::VectorizedArray&lt; Number, width &gt; abs(const ::VectorizedArray&lt; Number, width &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05750">vectorization.h:5750</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1PreconditionJacobi_html"><div class="ttname"><a href="classTrilinosWrappers_1_1PreconditionJacobi.html">TrilinosWrappers::PreconditionJacobi</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l00293">trilinos_precondition.h:293</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_ac00ea19562c135512a6ff275a3cf0d8f"><div class="ttname"><a href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has this class generates all dim dimensional polynomials of the where the sum and[1.x.8] is less than or equal *[1.x.9] The i e for each dim dimensional polynomial in the polynomial space it gives the indices j</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00004">polynomial_space_0.txt:4</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0">DataComponentInterpretation::DataComponentInterpretation</a></div><div class="ttdeci">DataComponentInterpretation</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00048">data_component_interpretation.h:48</a></div></div>
<div class="ttc" id="abase_2vectorization_8h_html_aafbdfdd72b6cfe4eae5fa7a16385582f"><div class="ttname"><a href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; abs(const ::VectorizedArray&lt; Number, width &gt; &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05750">vectorization.h:5750</a></div></div>
<div class="ttc" id="apolynomial__0_8txt_html_acef1a730e4f0566e0f83339e387c6dfa"><div class="ttname"><a href="polynomial__0_8txt.html#acef1a730e4f0566e0f83339e387c6dfa">polynomial</a></div><div class="ttdeci">namespace in which classes relating to the description of d polynomial spaces are declared ***Base class for all D polynomials A polynomial is represented in this class by its coefficients which are set through the constructor or by derived classes There are two paths for evaluation of polynomials One is based on the coefficients which are evaluated through the Horner scheme which is a robust general purpose scheme An alternative and more stable evaluation of high degree polynomials with roots in the unit interval is provided by a product in terms of the roots This form is available for special polynomials such as Lagrange polynomials or Legendre polynomials and used with the respective constructor To obtain this more stable evaluation form the constructor with the roots in form of a Lagrange polynomial must be used In case a manipulation is done that changes the roots the representation is switched to the coefficient form This class is a typical example of a possible template argument for the TensorProductPolynomials class **Constructor The coefficients of the polynomial are passed as and denote the polynomial[2.x.2]</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__0_8txt_source.html#l00012">polynomial_0.txt:12</a></div></div>
<div class="ttc" id="achunk__sparse__matrix__0_8txt_html_aa747ba884f098177e9bf2b2422a461a9"><div class="ttname"><a href="chunk__sparse__matrix__0_8txt.html#aa747ba884f098177e9bf2b2422a461a9">operator=</a></div><div class="ttdeci">namespace in which we declare iterators over the elements of sparse matrices ***General template for sparse matrix accessors The first template argument denotes the underlying numeric the second the constness of the matrix The general template is not only the specializations for the two possible values of the second template argument the interface listed here only serves as a template provided since doxygen does not link the specializations **Value of this matrix entry **Value of this matrix entry **Return a reference to the matrix into which this accessor points Note that in the present this is a constant reference **Accessor class for constant matrices used in the const_iterators This class builds on the accessor classes used for sparsity patterns to loop over all nonzero entries and only adds the accessor functions to gain access to the actual value stored at a certain location **Typedef for the this is a constant reference **Pointer to the matrix we use **Make the advance function of the base class available **Accessor class for non constant matrices used in the iterators This class builds on the accessor classes used for sparsity patterns to loop over all nonzero entries and only adds the accessor functions to gain access to the actual value stored at a certain location **Reference class This is what the accessor class returns when you call the i e you can read and write you can add and multiply to but since the matrix does not give away the address of this matrix we have to go through functions to do all this The constructor takes a pointer to an accessor object that describes which element of the matrix it points to This creates an ambiguity when one writes code like iterator since the right hand side is an integer that can both be converted to a&lt; tt &gt; adding another overload operator=(int) doesn 't seem to cure the problem. We avoid it</div></div>
<div class="ttc" id="afe_2mapping__q_8h_html"><div class="ttname"><a href="fe_2mapping__q_8h.html">mapping_q.h</a></div></div>
<div class="ttc" id="anamespaceparallel_1_1distributed_1_1GridRefinement_html_ae5159e3207f6786f0749fc0b66ab8ca3"><div class="ttname"><a href="namespaceparallel_1_1distributed_1_1GridRefinement.html#ae5159e3207f6786f0749fc0b66ab8ca3">parallel::distributed::GridRefinement::refine_and_coarsen_fixed_fraction</a></div><div class="ttdeci">void refine_and_coarsen_fixed_fraction(parallel::distributed::Triangulation&lt; dim, spacedim &gt; &amp;tria, const ::Vector&lt; Number &gt; &amp;criteria, const double top_fraction_of_error, const double bottom_fraction_of_error, const VectorTools::NormType norm_type=VectorTools::NormType::L1_norm)</div><div class="ttdef"><b>Definition:</b> <a href="distributed_2grid__refinement_8cc_source.html#l00566">grid_refinement.cc:566</a></div></div>
<div class="ttc" id="astructTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData_html"><div class="ttname"><a href="structTrilinosWrappers_1_1PreconditionAMG_1_1AdditionalData.html">TrilinosWrappers::PreconditionAMG::AdditionalData</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01401">trilinos_precondition.h:1401</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_a599462cacd492e2f712bf7369507dcff"><div class="ttname"><a href="classParameterHandler.html#a599462cacd492e2f712bf7369507dcff">ParameterHandler::leave_subsection</a></div><div class="ttdeci">void leave_subsection()</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l00953">parameter_handler.cc:953</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">VectorTools::EvaluationFlags::max</a></div><div class="ttdeci">@ max</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00056">vector_tools_evaluate.h:56</a></div></div>
<div class="ttc" id="aclassDataPostprocessor_html_a254f38bcdf4bdb5aa94231b695da7d55"><div class="ttname"><a href="classDataPostprocessor.html#a254f38bcdf4bdb5aa94231b695da7d55">DataPostprocessor::get_names</a></div><div class="ttdeci">virtual std::vector&lt; std::string &gt; get_names() const =0</div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aclassQuadrature_html"><div class="ttname"><a href="classQuadrature.html">Quadrature</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2quadrature_8h_source.html#l00075">quadrature.h:75</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_aab75469b86c44566880555a1da433349"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#aab75469b86c44566880555a1da433349">Step32::EquationData::R1</a></div><div class="ttdeci">constexpr double R1</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00099">step-32.cc:99</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespacenumbers_html_a3e24f194a9cb9b6ff4442b8a7a877d4a"><div class="ttname"><a href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a></div><div class="ttdeci">static constexpr double PI</div><div class="ttdef"><b>Definition:</b> <a href="base_2numbers_8h_source.html#l00237">numbers.h:237</a></div></div>
<div class="ttc" id="afunctions__0_8txt_html_af9f808a82e8c618e2e7a19dd08a9eae3"><div class="ttname"><a href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a></div><div class="ttdeci">****Functions are used in various places in deal for example to describe boundary coefficients in forcing or exact solutions Since closed form expressions for equations are often hard to pass along as function deal II uses the Function base class to describe these objects Essentially the interface of this base class requires derived classes to implement the ability to return the value of a function at one or a list of particular locations and function objects can then be used by algorithms like[2.x.1][2.x.2] and other functions *Some functions are needed again and and are therefore already provided in deal II This includes a function with a constant value</div><div class="ttdef"><b>Definition:</b> <a href="functions__0_8txt_source.html#l00007">functions_0.txt:7</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="avector__valued__0_8txt_html_aaee87206b92ccb284e9c77fa5d847637"><div class="ttname"><a href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a></div><div class="ttdeci">each of these vectors has[2.x.174] elements containing the values of the[2.x.175] velocities and the one pressure at a quadrature point *We can use these values to then construct other things like residuals the construct is a bit awkward we have a[2.x.176] which always looks strange It is also inefficient because it implies dynamic memory allocation for the outer vector as well as for all the inner vectors maybe we are only interested in the velocities</div><div class="ttdef"><b>Definition:</b> <a href="vector__valued__0_8txt_source.html#l00155">vector_valued_0.txt:155</a></div></div>
<div class="ttc" id="aclassFESystem_html"><div class="ttname"><a href="classFESystem.html">FESystem&lt; dim &gt;</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gafc0ca7ad85b3ebd64e8e51689ac85caf"><div class="ttname"><a href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a></div><div class="ttdeci">#define AssertThrow(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01699">exceptions.h:1699</a></div></div>
<div class="ttc" id="agroup__TrilinosWrappers_html_ga599811b30e0ab031d3b2c7c3672ca92f"><div class="ttname"><a href="group__TrilinosWrappers.html#ga599811b30e0ab031d3b2c7c3672ca92f">TrilinosWrappers::PreconditionAMG::AdditionalData::constant_modes</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; bool &gt; &gt; constant_modes</div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l01555">trilinos_precondition.h:1555</a></div></div>
<div class="ttc" id="asparse__vanka__0_8txt_html_a96771f1712564cc2701caa2fdfb4965d"><div class="ttname"><a href="sparse__vanka__0_8txt.html#a96771f1712564cc2701caa2fdfb4965d">vector&lt; bool &gt;</a></div><div class="ttdeci">this elimination is done by the modification of the right hand and in the end these degrees of freedom do not occur in the matrix and solution vector any more at all *This system is solved and the values are updated into the destination vector the matrices are built up such that the degree of freedom associated with the Lagrange multiplier is the first one usually the upper left entry in the matrix is zero It is not clear to so it must persist longer than the Vanka object The same is true for the matrix The matrix[2.x.11] which is passed here may or may not be the same matrix for which this object shall act as preconditioner In it is conceivable that the preconditioner is build up for one matrix but is used for subsequent steps in a nonlinear process as where the matrix changes in each step slightly **Destructor Delete all allocated matrices **Parameters for SparseVanka **Constructor For the parameters see below **Constructor For the parameters see below[2.x.12] The use of this constructor is deprecated **the second and third parameters are ignored **Indices of those degrees of freedom that we shall work on **If the default constructor is used then this function needs to be called before an object of this class is used as preconditioner For more detail about possible parameters see the class documentation and the documentation of the[2.x.13] class After this function is called the preconditioner is ready to be only values for allowed indices are written to[2.x.27] so the application of this function only does what is announced in the general documentation if the given mask sets all values to zero The reason for providing the mask anyway is that in derived classes we may want to apply the preconditioner to parts of the matrix in order to parallelize the application it is important to only write to some slices of[2.x.28] in order to eliminate the dependencies of threads of each other If a null pointer is passed instead of a pointer to then it is assumed that we shall work on all degrees of freedom This is then equivalent to calling the function with a&lt; tt &gt; vector&lt; bool &gt;(n_dofs, true)&lt;/tt &gt;. The[2.x.30] of this class of course calls this function with a null pointer *[0.x.17] *Determine an estimate for the memory consumption(in bytes) of this object. *[0.x.18] *Pointer to the matrix. *[0.x.19] *Indices of those degrees of freedom that we shall work on. *[0.x.20] *Array of inverse matrices</div></div>
<div class="ttc" id="aclassParameterHandler_html_a0ddaa05c5463c6c0b7701e18005717a9"><div class="ttname"><a href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">ParameterHandler::parse_input</a></div><div class="ttdeci">virtual void parse_input(std::istream &amp;input, const std::string &amp;filename=&quot;input file&quot;, const std::string &amp;last_line=&quot;&quot;, const bool skip_undefined=false)</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l00399">parameter_handler.cc:399</a></div></div>
<div class="ttc" id="alac_2trilinos__parallel__block__vector_8h_html"><div class="ttname"><a href="lac_2trilinos__parallel__block__vector_8h.html">trilinos_parallel_block_vector.h</a></div></div>
<div class="ttc" id="afe_2fe__values__0_8txt_html_a15ff2e0c168966d6ae13c4faabcec165"><div class="ttname"><a href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a></div><div class="ttdeci">we have to work a bit harder to compute this information **Default constructor Creates an invalid object **Constructor for an object that represents a single scalar component of a FEValuesBase for the shape function and quadrature point selected by the arguments[2.x.27] shape_function Number of the shape function to be evaluated Note that this number runs from zero to dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__0_8txt_source.html#l00073">fe_values_0.txt:73</a></div></div>
<div class="ttc" id="astructDataPostprocessorInputs_1_1Vector_html"><div class="ttname"><a href="structDataPostprocessorInputs_1_1Vector.html">DataPostprocessorInputs::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__postprocessor_8h_source.html#l00319">data_postprocessor.h:319</a></div></div>
<div class="ttc" id="anamespaceUtilities_html"><div class="ttname"><a href="namespaceUtilities.html">Utilities</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2communication__pattern__base_8h_source.html#l00030">communication_pattern_base.h:30</a></div></div>
<div class="ttc" id="aclassPatterns_1_1Double_html"><div class="ttname"><a href="classPatterns_1_1Double.html">Patterns::Double</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2patterns_8h_source.html#l00307">patterns.h:307</a></div></div>
<div class="ttc" id="aparsed__convergence__table__0_8txt_html_a8a90f5ba57a42a3fd4c067e00f8b8aea"><div class="ttname"><a href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a></div><div class="ttdeci">****This class simplifies the construction of convergence tables reading the options for the generation of the table from a parameter file It provides a series of methods that can be used to compute the error given a reference exact solution or the difference between two numerical solutions or any other custom computation of the error given via[2.x.1] objects *An example usage of this class is given by ****The above code constructs a ParsedConvergenceTable that works for scalar and will produce an error table with and Linfty_norm norms of the error *Whenever a call to the methods the instance of this class inspects its parameters computes all norms specified by the parameter given at construction time possibly modified via a parameter file computes all extra column entries specified using the method and writes one row of the convergence table *Once you have finished with the a call to and to the the same code can be used to estimate the errors of mixed or multi physics e and one component for the pressure field p</div><div class="ttdef"><b>Definition:</b> <a href="parsed__convergence__table__0_8txt_source.html#l00020">parsed_convergence_table_0.txt:20</a></div></div>
<div class="ttc" id="agrid_2grid__generator_8h_html"><div class="ttname"><a href="grid_2grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_ad2f716b789abe53715d6659f38aa7815"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a></div><div class="ttdeci">T max(const T &amp;t, const MPI_Comm &amp;mpi_communicator)</div></div>
<div class="ttc" id="aclassDataPostprocessor_html_ae994223acf8a16471ab5e579a4d75053"><div class="ttname"><a href="classDataPostprocessor.html#ae994223acf8a16471ab5e579a4d75053">DataPostprocessor::get_data_component_interpretation</a></div><div class="ttdeci">virtual std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; get_data_component_interpretation() const</div><div class="ttdef"><b>Definition:</b> <a href="data__postprocessor_8cc_source.html#l00048">data_postprocessor.cc:48</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52f"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52f">UpdateFlags</a></div><div class="ttdeci">UpdateFlags</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00057">fe_update_flags.h:57</a></div></div>
<div class="ttc" id="anamespaceStep32_1_1EquationData_html_a5be2c8b4fd986d982965ff214a6165bd"><div class="ttname"><a href="namespaceStep32_1_1EquationData.html#a5be2c8b4fd986d982965ff214a6165bd">Step32::EquationData::R0</a></div><div class="ttdeci">constexpr double R0</div><div class="ttdef"><b>Definition:</b> <a href="step-32_8cc_source.html#l00098">step-32.cc:98</a></div></div>
<div class="ttc" id="atable__0_8txt_html_aa889bb34debce4db8c9ace2f875bdf0d"><div class="ttname"><a href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a></div><div class="ttdeci">tables that store three or more dimensional then there is nothing you can do about the size of these if your program is parallelized via then a typical first implementation would create a table object on every process and fill it on every MPI process by reading the data from a file This is inefficient from two the data stored on every process is the and while every process needs to be able to read from a it is not necessary that every process stores its own either by re creating a copy of the table in the other processes memory space if by creating copies in shared memory once for all processes located on each of the machines used by the MPI job ******Integer type used to count the number of elements in this container **Default constructor Set all dimensions to zero **Constructor Initialize the array with the given dimensions in each index component **Constructor Initialize the array with the given dimensions in each index component</div><div class="ttdef"><b>Definition:</b> <a href="table__0_8txt_source.html#l00083">table_0.txt:83</a></div></div>
<div class="ttc" id="afunction__0_8txt_html_a4f780342f2d5d632f82cf7fd90158a66"><div class="ttname"><a href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a></div><div class="ttdeci">it defaults to i e the first component **Return all components of a vector valued function at a given point&lt; tt &gt; values&lt;/tt &gt; shall have the right size i e **Set&lt; tt &gt; values&lt;/tt &gt; to the point values of the specified component of the function at the&lt; tt &gt; points&lt;/tt &gt; It is assumed that&lt; tt &gt; values&lt;/tt &gt; already has the right size</div><div class="ttdef"><b>Definition:</b> <a href="function__0_8txt_source.html#l00052">function_0.txt:52</a></div></div>
<div class="ttc" id="aclassUtilities_1_1MPI_1_1MPI__InitFinalize_html"><div class="ttname"><a href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2mpi_8h_source.html#l00836">mpi.h:836</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a02f5aa616d7b0799c538fe77d6c6c795"><div class="ttname"><a href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a></div><div class="ttdeci">i e</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00028">coding_conventions_0.txt:28</a></div></div>
<div class="ttc" id="aclassPatterns_1_1Integer_html"><div class="ttname"><a href="classPatterns_1_1Integer.html">Patterns::Integer</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2patterns_8h_source.html#l00198">patterns.h:198</a></div></div>
<div class="ttc" id="abase_2symmetric__tensor_8h_html_a1b2101a1d45267f1fd4664ed178cb636"><div class="ttname"><a href="base_2symmetric__tensor_8h.html#a1b2101a1d45267f1fd4664ed178cb636">symmetrize</a></div><div class="ttdeci">constexpr SymmetricTensor&lt; 2, dim, Number &gt; symmetrize(const Tensor&lt; 2, dim, Number &gt; &amp;t)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l03588">symmetric_tensor.h:3588</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a26d68db31ed452971a1cc4fc1c5c9afa"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a26d68db31ed452971a1cc4fc1c5c9afa">temperature</a></div><div class="ttdeci">and situations where one is given a parameter dependent problem[2.x.4] and wants to form derivatives with regards to the for example to optimize an output functional with regards or for a sensitivity analysis with regards to[2.x.7] One should think of[2.x.8] as design the width or shape of a the stiffness coefficients of a material chosen to build an the power sent to a the chemical composition of the gases sent to a burner In all of these one should think of[2.x.9] and[2.x.10] as[1.x.0] and cumbersome to differentiate **at least when doing it by hand A relatively simple case of a nonlinear problem that already highlights the tedium of computing derivatives by hand is shown in[2.x.11] in one for think about problems such as chemically reactive flows where the fluid equations have coefficients such as the density and viscosity that depend strongly and nonlinearly on the chemical temperature</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00012">automatic_and_symbolic_differentiation_0.txt:12</a></div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
