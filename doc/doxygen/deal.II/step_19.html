<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_19.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-19 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-19 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_6.html">step-6</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Timediscretization">Time discretization</a>
        <li><a href="#Spatialdiscretization">Spatial discretization</a>
        <li><a href="#Dealingwithparticlesprogrammatically">Dealing with particles programmatically</a>
        <li><a href="#Thetestcase">The test case</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#Globaldefinitions">Global definitions</a>
        <li><a href="#Themainclass">The main class</a>
        <li><a href="#ThecodeCathodeRaySimulatorcodeclassimplementation">The <code>CathodeRaySimulator</code> class implementation</a>
      <ul>
        <li><a href="#ThecodeCathodeRaySimulatorcodeconstructor">The <code>CathodeRaySimulator</code> constructor</a>
        <li><a href="#ThecodeCathodeRaySimulatormake_gridcodefunction">The <code>CathodeRaySimulator::make_grid</code> function</a>
        <li><a href="#ThecodeCathodeRaySimulatorsetup_systemcodefunction">The <code>CathodeRaySimulator::setup_system</code> function</a>
        <li><a href="#ThecodeCathodeRaySimulatorassemble_systemcodefunction">The <code>CathodeRaySimulator::assemble_system</code> function</a>
        <li><a href="#CathodeRaySimulatorsolve">CathodeRaySimulator::solve</a>
        <li><a href="#CathodeRaySimulatorrefine_grid">CathodeRaySimulator::refine_grid</a>
        <li><a href="#CathodeRaySimulatorcreate_particles">CathodeRaySimulator::create_particles</a>
        <li><a href="#CathodeRaySimulatormove_particles">CathodeRaySimulator::move_particles</a>
        <li><a href="#CathodeRaySimulatortrack_lost_particle">CathodeRaySimulator::track_lost_particle</a>
        <li><a href="#CathodeRaySimulatorupdate_timestep_size">CathodeRaySimulator::update_timestep_size</a>
        <li><a href="#ThecodeCathodeRaySimulatoroutput_resultscodefunction">The <code>CathodeRaySimulator::output_results()</code> function</a>
        <li><a href="#CathodeRaySimulatorrun">CathodeRaySimulator::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
      <ul>
        <li><a href="#Avoidingaperformancebottleneckwithparticles"> Avoiding a performance bottleneck with particles </a>
        <li><a href="#Morestatisticsaboutelectrons"> More statistics about electrons </a>
        <li><a href="#Abettersynchronizedvisualization"> A better-synchronized visualization </a>
        <li><a href="#Abettertimeintegrator"> A better time integrator </a>
        <li><a href="#Parallelization"> Parallelization </a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
</p>
<p><br  />
</p>
<p><em> This program was contributed by Wolfgang Bangerth, Rene Gassmoeller, and Peter Munch.</em></p>
<p><em>Wolfgang Bangerth acknowledges support through NSF awards DMS-1821210, EAR-1550901, and OAC-1835673. </em></p>
<dl class="section note"><dt>Note</dt><dd>Support for particles exists in deal.II primarily due to the initial efforts of Rene Gassmoeller. Please acknowledge this work by citing the publication <b>[GLHPW2018]</b> if you use particle functionality in your own work.</dd></dl>
<p><a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>The finite element method in general, and deal.II in particular, were invented to solve partial differential equations &ndash; in other words, to solve <a href="https://en.wikipedia.org/wiki/Continuum_mechanics">continuum mechanics</a> problems. On the other hand, sometimes one wants to solve problems in which it is useful to track individual objects ("particles") and how their positions evolve. If this simply leads to a set of ordinary differential equations, for example if you want to track the positions of the planets in the solar system over time, then deal.II is clearly not your right tool. On the other hand, if this evolution is due to the interaction with the solution of partial differential equation, or if having a mesh to determine which particles interact with others (such as in the <a href="https://en.wikipedia.org/wiki/Smoothed-particle_hydrodynamics">smoothed particle hydrodynamics (SPH)</a> method), then deal.II has support for you.</p>
<p>The case we will consider here is how electrically charged particles move through an electric field. As motivation, we will consider <a href="https://en.wikipedia.org/wiki/Cathode_ray">cathode rays</a>: Electrons emitted by a heated piece of metal that is negatively charged (the "cathode"), and that are then accelerated by an electric field towards the positively charged electrode (the "anode"). The anode is typically ring-shaped so that the majority of electrons can fly through the hole in the form of an electron beam. In the olden times, they might then have illuminated the screen of a TV built from a <a href="https://en.wikipedia.org/wiki/Cathode-ray_tube">cathode ray tube</a>. Today, instead, electron beams are useful in <a href="https://en.wikipedia.org/wiki/X-ray_tube">X-ray machines</a>, <a href="https://en.wikipedia.org/wiki/Electron-beam_lithography">electron beam lithography</a>, <a href="https://en.wikipedia.org/wiki/Electron-beam_welding">electron beam welding</a>, and a number of other areas.</p>
<p>The equations we will then consider are as follows: First, we need to describe the electric field. This is most easily accomplished by noting that the electric potential \(V\) satisfied the equation </p><p class="formulaDsp">
\[ -\epsilon_0 \Delta V = \rho \]
</p>
<p> where \(\epsilon_0\) is the dielectric constant of vacuum, and \(\rho\) is the charge density. This is augmented by boundary conditions that we will choose as follows: </p><p class="formulaDsp">
\begin{align*} V &amp;= -V_0 &amp;&amp; \text{on}\; \Gamma_\text{cathode}\subset\partial\Omega \\ V &amp;= +V_0 &amp;&amp; \text{on}\; \Gamma_\text{anode}\subset\partial\Omega \\ \epsilon\frac{\partial V}{\partial n} &amp;= 0 &amp;&amp; \text{on}\; \partial\Omega\setminus\Gamma_\text{cathode}\setminus\Gamma_\text{anode}. \end{align*}
</p>
<p> In other words, we prescribe voltages \(+V_0\) and \(-V_0\) at the two electrodes and insulating (Neumann) boundary conditions elsewhere. Since the dynamics of the particles are purely due to the electric field \(\mathbf E=\nabla V\), we could as well have prescribed \(2V_0\) and \(0\) at the two electrodes &ndash; all that matters is the voltage difference at the two electrodes.</p>
<p>Given this electric potential \(V\) and the electric field \(\mathbf E=\nabla V\), we can describe the trajectory of the \(i\)th particle using the differential equation </p><p class="formulaDsp">
\[ m {\ddot {\mathbf x}}_i = e\mathbf E, \]
</p>
<p> where \(m,e\) are the mass and electric charge of each particle. In practice, it is convenient to write this as a system of first-order differential equations in the position \(\mathbf x\) and velocity \(\mathbf v\): </p><p class="formulaDsp">
\begin{align*} {\dot {\mathbf v}}_i &amp;= \frac{e\mathbf E}{m}, \\ {\dot {\mathbf x}}_i &amp;= {\mathbf v}_i. \end{align*}
</p>
<p> The deal.II class we will use to deal with particles, <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a>, stores particles in a way so that the position \(\mathbf x_i\) is part of the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> data structures. (It stores particles sorted by cell they are in, and consequently needs to know where each particle is.) The velocity \(\mathbf v_i\), on the other hand, is of no concern to <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> and consequently we will store it as a "property" of each particle that we will update in each time step. Properties can also be used to store any other quantity we might care about each particle: its charge, or if they were larger than just an electron, its color, mass, attitude in space, chemical composition, etc.</p>
<p>There remain two things to discuss to complete the model: Where particles start and what the charge density \(\rho\) is.</p>
<p>First, historically, cathode rays used very large electric fields to pull electrons out of the metal. This produces only a relatively small current. One can do better by heating the cathode: a statistical fraction of electrons in that case have enough thermal energy to leave the metal; the electric field then just has to be strong enough to pull them away from the attraction of their host body. We will model this in the following way: We will create a new particle if (i) the electric field points away from the electrode, i.e., if \(\mathbf E \cdot \mathbf n &lt; 0\) where \(\mathbf n\) is the normal vector at a face pointing out of the domain (into the electrode), and (ii) the electric field exceeds a threshold value \(|\mathbf E|\ge E_\text{threshold}\). This is surely not a sufficiently accurate model for what really happens, but is good enough for our current tutorial program.</p>
<p>Second, in principle we would have to model the charge density via </p><p class="formulaDsp">
\[ \rho(\mathbf x) = \sum_i e\delta(\mathbf x-\mathbf x_i). \]
</p>
<dl class="section note"><dt>Note</dt><dd>The issue now is that in reality, a cathode ray tube in an old television yields a current of somewhere around a few milli-Amperes. In the much higher energy beams of particle accelerators, the current may only be a few nano-Ampere. But an Ampere is \(6\times 10^{18}\) electrons flowing per second. Now, as you will see in the results section, we really only simulate a few microseconds ( \(10^{-5}\) seconds), but that still results in very very large numbers of electrons &ndash; far more than we can hope to simulate with a program as small as the current one. As a consequence, let us presume that each particle represents \(N\) electrons. Then the particle mass and charge are also \(Nm\) and \(Ne\) and the equations we have to solve are <p class="formulaDsp">
\[ (Nm) {\ddot {\mathbf x}}_i = (Ne)\mathbf E, \]
</p>
 which is of course exactly the same as above. On the other hand, the charge density for these "clumps" of electrons is given by <p class="formulaDsp">
\[ \rho(\mathbf x) = \sum_i (Ne)\delta(\mathbf x-\mathbf x_i). \]
</p>
 It is this form that we will implement in the program, where \(N\) is chosen rather large in the program to ensure that the particles actually affect the electric field. (This may not be realistic in practice: In most cases, there are just not enough electrons to actually affect the overall electric field. But realism is not our goal here.)</dd>
<dd>
One may wonder why the equation for the electric field (or, rather, the electric potential) has no time derivative whereas the equations for the electron positions do. In essence, this is a modeling assumption: We assume that the particles move so slowly that at any given time the electric field is in equilibrium. This is saying, in other words, that the velocity of the electrons is much less than the speed of light. In yet other words, we can rephrase this in terms of the electrode voltage \(V_0\): Since every volt of electric potential accelerates electrons by approximately 600 km/s (neglecting relativistic effects), requiring \(|\mathbf v_i\|\ll c\) is equivalent to saying that \(2V_0 \ll 500 \text{V}\). Under this assumption (and the assumption that the total number of electrons is small), one can also neglect the creation of magnetic fields by the moving charges, which would otherwise also affect the movement of the electrons.</dd></dl>
<p><a class="anchor" id="Timediscretization"></a></p><h3>Time discretization</h3>
<p>The equations outlined above form a set of coupled differential equations. Let us bring them all together in one place again to make that clear: </p><p class="formulaDsp">
\begin{align*} -\epsilon_0 \Delta V &amp;= \sum_i e\delta(\mathbf x-\mathbf x_i) \\ {\dot {\mathbf x}}_i &amp;= {\mathbf v}_i, \\ {\dot {\mathbf v}}_i &amp;= \frac{e\mathbf E}{m} = \frac{e\mathbf \nabla V}{m}. \end{align*}
</p>
<p> Because of the awkward dependence of the electric potential on the particle locations, we don't want to solve this as a coupled system but instead use a decoupled approach where we first solve for the potential in each time step and then the particle locations. (One could also do it the other way around, of course.) This is very much in the same spirit as we do in <a class="el" href="step_21.html">step-21</a>, <a class="el" href="step_31.html">step-31</a>, and <a class="el" href="step_32.html">step-32</a>, to name just a few, and can all be understood in the context of the operator splitting methods discussed in <a class="el" href="step_58.html">step-58</a>.</p>
<p>So, if we denote by an upper index \(n\) the time step, and if we use a simple time discretization for the ODE, then this means that we have to solve the following set of equations in each time step: </p><p class="formulaDsp">
\begin{align*} -\epsilon_0 \Delta V^{(n)} &amp;= \sum_i e\delta(\mathbf x-\mathbf x_i^{(n-1)}) \\ \frac{{\mathbf v}_i^{(n)}-{\mathbf v}_i^{(n-1)}}{\Delta t} &amp;= \frac{e\nabla V^{(n)}}{m} \\ \frac{{\mathbf x}_i^{(n)}-{\mathbf x}_i^{(n-1)}}{\Delta t} &amp;= {\mathbf v}_i^{(n)}. \end{align*}
</p>
<p> There are of course many better ways to do a time discretization (for example the simple <a href="https://en.wikipedia.org/wiki/Leapfrog_integration">leapfrog scheme</a>) but this isn't the point of the tutorial program, and so we will be content with what we have here. (We will comment on a piece of this puzzle in the <a href="#extensions">possibilities for extensions</a> section of this program, however.)</p>
<p>There remains the question of how we should choose the time step size \(\Delta t\). The limitation here is that the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class needs to keep track of which cell each particle is in. This is particularly an issue if we are running computations in parallel (say, in <a class="el" href="step_70.html">step-70</a>) because in that case every process only stores those cells it owns plus one layer of "ghost cells". That's not relevant here, but in general we should make sure that over the course of each time step, a particle moves only from one cell to any of its immediate neighbors (face, edge, or vertex neighbors). If we can ensure that, then <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> is guaranteed to be able to figure out which cell a particle ends up in. To do this, a useful rule of thumb is that we should choose the time step so that for all particles the expected distance the particle moves by is less than one cell diameter: </p><p class="formulaDsp">
\[ \Delta t \le \frac{h_i}{\|\mathbf v_i\|} \qquad\qquad \forall i, \]
</p>
<p> or equivalently </p><p class="formulaDsp">
\[ \Delta t \le \min_i \frac{h_i}{\|\mathbf v_i\|}. \]
</p>
<p> Here, \(h_i\) is the length of the shortest edge of the cell on which particle \(i\) is located &ndash; in essence, a measure of the size of a cell.</p>
<p>On the other hand, a particle might already be at the boundary of one cell and the neighboring cell might be once further refined. So then the time to cross that <em>neighboring</em> cell would actually be half the amount above, suggesting </p><p class="formulaDsp">
\[ \Delta t \le \min_i \frac{\tfrac 12 h_i}{\|\mathbf v_i\|}. \]
</p>
<p>But even that is not good enough: The formula above updates the particle positions in each time using the formula </p><p class="formulaDsp">
\[ \frac{{\mathbf x}_i^{(n)}-{\mathbf x}_i^{(n-1)}}{\Delta t} = {\mathbf v}_i^{(n)}, \]
</p>
<p> that is, using the <em>current</em> velocity \({\mathbf v}_i^{n}\). But we don't have the current velocity yet at the time when we need to choose \(\Delta t\) &ndash; which is after we have updated the potential \(V^{(n)}\) but before we update the velocity from \({\mathbf v}_i^{(n-1)}\) to \({\mathbf v}_i^{(n)}\). All we have is \({\mathbf v}_i^{(n-1)}\). So we need an additional safety factor for our final choice: </p><p class="formulaDsp">
\[ \Delta t^{(n)} = c_\text{safety} \min_i \frac{\tfrac 12 h_i}{\|\mathbf v_i^{(n-1)}\|}. \]
</p>
<p> How large should \(c_\text{safety}\) be? That depends on how much of underestimate \(\|\mathbf v_i^{(n-1)}\|\) might be compared to \(\|\mathbf v_i^{(n)}\|\), and that is actually quite easy to assess: A particle created in one time step with zero velocity will roughly pick up equal velocity increments in each successive time step if the electric field it encounters along the way were roughly constant. So the maximal difference between \(\|\mathbf v_i^{(n-1)}\|\) and \(\|\mathbf v_i^{(n)}\|\) would be a factor of two. As a consequence, we will choose \(c_\text{safety}=0.5\).</p>
<p>There is only one other case we ought to consider: What happens in the very first time step? There, any particles to be moved along have just been created, but they have a zero velocity. So we don't know what velocity we should choose for them. Of course, in all other time steps there are also particles that have just been created, but in general, the particles with the highest velocity limit the time step size and so the newly created particles with their zero velocity don't matter. But if we <em>only</em> have such particles?</p>
<p>In that case, we can use the following approximation: If a particle starts at \(\mathbf v^{(0)}=0\), then the update formula tells us that </p><p class="formulaDsp">
\[ {\mathbf v}_i^{(1)} = \frac{e\nabla V^{(1)}}{m} \Delta t, \]
</p>
<p> and consequently </p><p class="formulaDsp">
\[ \frac{{\mathbf x}_i^{(1)}-{\mathbf x}_i^{(0)}}{\Delta t} = {\mathbf v}_i^{(1)}, \]
</p>
<p> which we can write as </p><p class="formulaDsp">
\[ {\mathbf x}_i^{(1)} - {\mathbf x}_i^{(0)} = \frac{e\nabla V^{(1)}}{m} \Delta t^2. \]
</p>
<p> Not wanting to move a particle by more than \(\frac 12 h_i\) then implies that we should choose the time step as </p><p class="formulaDsp">
\[ \Delta t \le \min_i \sqrt{ \frac{h_i m}{e \|\nabla V^{(1)}\| }}. \]
</p>
<p> Using the same argument about neighboring cells possibly being smaller by a factor of two then leads to the final formula for time step zero: </p><p class="formulaDsp">
\[ \Delta t = \min_i \sqrt{ \frac{\frac 12 h_i m}{e \|\nabla V^{(1)}\| } }. \]
</p>
<p>Strictly speaking, we would have to evaluate the electric potential \(V^{(1)}\) at the location of each particle, but a good enough approximation is to use the maximum of the values at the vertices of the respective cell. (Why the vertices and not the midpoint? Because the gradient of the solution of the Laplace equation, i.e., the electric field, is largest in corner singularities which are located at the vertices of cells.) This has the advantage that we can make good use of the <a class="el" href="classFEValues.html">FEValues</a> functionality which can recycle pre-computed material as long as the quadrature points are the same from one cell to the next.</p>
<p>We could always run this kind of scheme to estimate the difference between \(\mathbf v_i^{(n-1)}\) and \(\mathbf v_i^{(n)}\), but it relies on evaluating the electric field \(\mathbf E\) on each cell, and that is expensive. As a consequence, we will limit this approach to the very first time step.</p>
<p><a class="anchor" id="Spatialdiscretization"></a></p><h3>Spatial discretization</h3>
<p>Having discussed the time discretization, the discussion of the spatial discretization is going to be short: We use quadratic finite elements, i.e., the space \(Q_2\), to approximate the electric potential \(V\). The mesh is adapted a couple of times during the initial time step. All of this is entirely standard if you have read <a class="el" href="step_6.html">step-6</a>, and the implementation does not provide for any kind of surprise.</p>
<p><a class="anchor" id="Dealingwithparticlesprogrammatically"></a></p><h3>Dealing with particles programmatically</h3>
<p>Adding and moving particles is, in practice, not very difficult in deal.II. To add one, the <code>create_particles()</code> function of this program simply uses a code snippet of the following form: </p><div class="fragment"><div class="line"><a class="code" href="classParticles_1_1Particle.html">Particles::Particle&lt;dim&gt;</a> new_particle;</div>
<div class="line">new_particle.<a class="code" href="classParticles_1_1Particle.html#afbe52b594cf4a8dd11431679c4ef2b52">set_location</a>(<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>);</div>
<div class="line">new_particle.<a class="code" href="classParticles_1_1Particle.html#a57efa2034baca617ba3160ccfbbc7cd7">set_reference_location</a></div>
<div class="line">    (<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>.transform_real_to_unit_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>));</div>
<div class="line">new_particle.<a class="code" href="classParticles_1_1Particle.html#af792bce47ec4746ad2c78e7e800299a8">set_id</a>(n_current_particles);</div>
<div class="line"> </div>
<div class="line">particle_handler.insert_particle(new_particle, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
</div><!-- fragment --><p> In other words, it is not all that different from inserting an object into a <code>std::set</code> or <code>std::map</code>: Create the object, set its properties (here, the current location, its reference cell location, and its id) and call <code>insert_particle</code>. The only thing that may be surprising is the reference location: In order to evaluate things such as \(\nabla V(\mathbf x_i)\), it is necessary to evaluate finite element fields at locations \(\mathbf x_i\). But this requires evaluating the finite element shape functions at points on the reference cell \(\hat{\mathbf x}_i\). To make this efficient, every particle doesn't just store its location and the cell it is on, but also what location that point corresponds to in the cell's reference coordinate system.</p>
<p>Updating a particle's position is then no more difficult: One just has to call </p><div class="fragment"><div class="line"><a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_location(new_location);</div>
</div><!-- fragment --><p> We do this in the <code>move_particles()</code> function. The only difference is that we then have to tell the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class to also find what cell that position corresponds to (and, when computing in parallel, which process owns this cell). For efficiency reason, this is most easily done after updating all particles' locations, and is achieved via the <a class="el" href="classParticles_1_1ParticleHandler.html#ad817e16828f2355b0cad6fef8db7df81">Particles::ParticleHandler::sort_particles_into_subdomains_and_cells()</a> function.</p>
<p>There are, of course, times where a particle may leave the domain in question. In that case, <a class="el" href="classParticles_1_1ParticleHandler.html#ad817e16828f2355b0cad6fef8db7df81">Particles::ParticleHandler::sort_particles_into_subdomains_and_cells()</a> can not find a surrounding cell and simply deletes the particle. But, it is often useful to track the number of particles that have been lost this way, and for this the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class offers a "signal" that one can attach to. We show how to do this in the constructor of the main class to count how many particles were lost in each time step. Specifically, the way this works is that the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class has a "signal" to which one can attach a function that will be executed whenever the signal is triggered. Here, this looks as follows: </p><div class="fragment"><div class="line">particle_handler.signals.particle_lost.connect(</div>
<div class="line">  [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">         <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">  {</div>
<div class="line">    this-&gt;track_lost_particle(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  });</div>
</div><!-- fragment --><p> That's a bit of a mouthful, but what's happening is this: We declare a lambda function that "captures" the <code>this</code> pointer (so that we can access member functions of the surrounding object inside the lambda function), and that takes two arguments:</p><ul>
<li>A reference to the particle that has been "lost".</li>
<li>A reference to the cell it was on last. The lambda function then simply calls the <code>CathodeRaySimulator::track_lost_particle</code> function with these arguments. When we attach this lambda function to the signal, the <a class="el" href="classParticles_1_1ParticleHandler.html#ad817e16828f2355b0cad6fef8db7df81">Particles::ParticleHandler::sort_particles_into_subdomains_and_cells()</a> function will trigger the signal for every particle for which it can't find a new home. This gives us the chance to record where the particle is, and to record statistics on it.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>In this tutorial program, we insert particles by hand and at locations we specifically choose based on conditions that include the solution of the electrostatic problem. But there are other cases where one primarily wants to use particles as passive objects, for example to trace and visualize the flow field of a fluid flow problem. In those cases, there are numerous functions in the <a class="el" href="namespaceParticles_1_1Generators.html">Particles::Generators</a> namespace that can generate particles automatically. One of the functions of this namespace is also used in the <a class="el" href="step_70.html">step-70</a> tutorial program, for example.</dd></dl>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The test case</h3>
<p>The test case here is not meant to be a realistic depiction of a cathode ray tube, but it has the right general characteristics and the point is, in any case, only to demonstrate how one would implement deal.II codes that use particles.</p>
<p>The following picture shows the geometry that we're going to use:</p>
<p align="center"></p>
<p><img src="https://www.dealii.org/images/steps/developer/step-19.geometry.png" alt="The geometry used in this program" width="600" class="inline"/> </p>
<p>In this picture, the parts of the boundary marked in red and blue are the cathode, held at an electric potential \(V=-V_0\). The part of the cathode shown in red is the part that is heated, leading to electrons leaving the metal and then being accelerated by the electric field (a few electric field lines are also shown). The green part of the boundary is the anode, held at \(V=+V_0\). The rest of the boundary satisfies a Neumann boundary condition.</p>
<p>This setup mimics real devices. The re-entrant corner results in an electric potential \(V\) whose derivative (the electric field \(\mathbf E\)) has a singularity &ndash; in other words, it becomes very large in the vicinity of the corner, allowing it to rip electrons away from the metal. These electrons are then accelerated towards the (green) anode which has a hole in the middle through which the electrons can escape the device and fly on to hit the screen, where they excite the "phosphor" to then emit the light that we see from these old-style TV screens. The non-heated part of the cathode is not subject to the emission of electrons &ndash; in the code, we will mark this as the "focussing element" of the tube, because its negative electric voltage repels the electrons and makes sure that they do not just fly away from the heated part of the cathode perpendicular to the boundary, but in fact bend their paths towards the anode on the right.</p>
<p>The electric field lines also shown in the picture illustrate that the electric field connects the negative and positive electrodes, respectively. The accelerating force the electrons experience is along these field lines. Finally, the picture shows the mesh used in the computation, illustrating that there are singularities at the tip of the re-rentrant corner as well as at all places where the boundary conditions change; these singularities are visible because the mesh is refined in these locations.</p>
<p>Of practical interest is to figure out which fraction of the electrons emitted from the cathode actually make it through the hole in the anode &ndash; electrons that just bounce into the anode itself are not actually doing anything useful other than converting electricity into heat. As a consequence, in the <code>track_lost_particle()</code> function (which is called for each particle that leaves the domain, see above), we will estimate where it might have left the domain and report this in the output.</p>
<dl class="section note"><dt>Note</dt><dd>It is worth repeating that neither the geometry used here, nor in fact any other aspect of this program is intended to represent anything even half-way realistic. Tutorial programs are our tools to teach how deal.II works, and we often use situations for which we have some kind of intuition since this helps us interpret the output of a program, but that's about the extent to which we intend the program to do anything of use besides being a teaching tool.</dd></dl>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The majority of the include files used in this program are well known from <a class="el" href="step_6.html">step-6</a> and similar programs:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__free_2fe__point__evaluation_8h.html">deal.II/matrix_free/fe_point_evaluation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
</div><!-- fragment --><p>The ones that are new are only the following three: The first declares the <a class="el" href="classDiscreteTime.html">DiscreteTime</a> class that helps us keep track of time in a time-dependent simulation. The latter two provide all of the particle functionality, namely a way to keep track of particles located on a mesh (the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class) and the ability to output these particles' locations and their properties for the purposes of visualization (the <a class="el" href="classParticles_1_1DataOut.html">Particles::DataOut</a> class).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2discrete__time_8h.html">deal.II/base/discrete_time.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="particles_2particle__handler_8h.html">deal.II/particles/particle_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="particles_2data__out_8h.html">deal.II/particles/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Globaldefinitions"></a> </p><h3>Global definitions</h3>
<p>As is customary, we put everything that corresponds to the details of the program into a namespace of its own. At the top, we define a few constants for which we would rather use symbolic names than hard-coded numbers.</p>
<p>Specifically, we define numbers for <a class="el" href="DEALGlossary.html#GlossBoundaryIndicator">boundary indicators</a> for the various parts of the geometry, as well as the physical properties of electrons and other specifics of the setup we use here.</p>
<p>For the boundary indicators, let us start enumerating at some random value 101. The principle here is to use numbers that are uncommon*. If there are pre-defined boundary indicators previously set by the <code><a class="el" href="namespaceGridGenerator.html">GridGenerator</a></code> functions, they will likely be small integers starting from zero, but not in this rather randomly chosen range. Using numbers such as those below avoids the possibility for conflicts, and also reduces the temptation to just spell these numbers out in the program (because you will probably never remember which is which, whereas you might have been tempted if they had started at 0).</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep19.html">Step19</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">namespace </span>BoundaryIds</div>
<div class="line">  {</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#ad34dd0ea81c30b8db904e23d54e1b323">open</a>          = 101;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">cathode</a>       = 102;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">focus_element</a> = 103;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>         = 104;</div>
<div class="line">  } <span class="comment">// namespace BoundaryIds</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>Constants</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">electron_mass</a>   = 9.1093837015e-31;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">electron_charge</a> = 1.602176634e-19;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">V0</a> = 1;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">E_threshold</a> = 0.05;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">electrons_per_particle</a> = 3e15;</div>
<div class="line">  } <span class="comment">// namespace Constants</span></div>
</div><!-- fragment --><p><a class="anchor" id="Themainclass"></a> </p><h3>The main class</h3>
<p>The following is then the main class of this program. It has, fundamentally, the same structure as <a class="el" href="step_6.html">step-6</a> and many other tutorial programs. This includes the majority of the member functions (with the purpose of the rest probably self-explanatory from their names) as well as only a small number of member variables beyond those of <a class="el" href="step_6.html">step-6</a>, all of which are related to dealing with particles.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>CathodeRaySimulator</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  CathodeRaySimulator();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">  <span class="keywordtype">void</span> setup_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">  <span class="keywordtype">void</span> solve_field();</div>
<div class="line">  <span class="keywordtype">void</span> refine_grid();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> create_particles();</div>
<div class="line">  <span class="keywordtype">void</span> move_particles();</div>
<div class="line">  <span class="keywordtype">void</span> track_lost_particle(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> update_timestep_size();</div>
<div class="line">  <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler&lt;dim&gt;</a> particle_handler;</div>
<div class="line">  <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           next_unused_particle_id;</div>
<div class="line">  <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_recently_lost_particles;</div>
<div class="line">  <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_total_lost_particles;</div>
<div class="line">  <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_particles_lost_through_anode;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDiscreteTime.html">DiscreteTime</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatorcodeclassimplementation"></a> </p><h3>The <code>CathodeRaySimulator</code> class implementation</h3>
<p><a class="anchor" id="ThecodeCathodeRaySimulatorcodeconstructor"></a> </p><h4>The <code>CathodeRaySimulator</code> constructor</h4>
<p>So then let us get started on the implementation. What the constructor does is really only a straight-forward initialization of all of the member variables at the top. The only two worth mentioning are the <code>particle_handler</code>, which is handed a reference to the triangulation on which the particles will live (currently of course still empty, but the particle handler stores the reference and will use it once particles are added &ndash; which happens after the triangulation is built). The other piece of information it gets is how many "properties" each particle needs to store. Here, all we need each particle to remember is its current velocity, i.e., a vector with <code>dim</code> components. There are, however, other intrinsic properties that each particle has and that the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class automatically and always makes sure are available; in particular, these are the current location of a particle, the cell it is on, it's reference location within that cell, and the particle's ID.</p>
<p>The only other variable of interest is <code>time</code>, an object of type <a class="el" href="classDiscreteTime.html">DiscreteTime</a>. It keeps track of the current time we are in a time-dependent simulation, and is initialized with the start time (zero) and end time ( \(10^{-4}\)). We will later set the time step size in <code>update_timestep_size()</code>.</p>
<p>The body of the constructor consists of a piece of code we have already discussed in the introduction. Namely, we make sure that the <code>track_lost_particle()</code> function is called by the <code>particle_handler</code> object every time a particle leaves the domain.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">CathodeRaySimulator&lt;dim&gt;::CathodeRaySimulator()</div>
<div class="line">  : <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1)</div>
<div class="line">  , <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(2)</div>
<div class="line">  , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  , particle_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, <span class="comment">/*n_properties=*/</span><a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)</div>
<div class="line">  , next_unused_particle_id(0)</div>
<div class="line">  , n_recently_lost_particles(0)</div>
<div class="line">  , n_total_lost_particles(0)</div>
<div class="line">  , n_particles_lost_through_anode(0)</div>
<div class="line">  , <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>(0, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4)</div>
<div class="line">{</div>
<div class="line">  particle_handler.signals.particle_lost.connect(</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">           <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) {</div>
<div class="line">      this-&gt;track_lost_particle(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    });</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatormake_gridcodefunction"></a> </p><h4>The <code>CathodeRaySimulator::make_grid</code> function</h4>
<p align="center">The next function is then responsible for generating the mesh on which we want to solve. Recall how the domain looks like: </p>
<p><img src="https://www.dealii.org/images/steps/developer/step-19.geometry.png" alt="The geometry used in this program" width="600" class="inline"/> </p>
<p>We subdivide this geometry into a mesh of \(4\times 2\) cells that looks like this: </p><div class="CodeFragmentInTutorialComment"> <div class="fragment"><div class="line"> ---*---*---*---*</div>
<div class="line">\   |   |   |   |</div>
<div class="line">  --*---*---*---*</div>
<div class="line">/   |   |   |   |</div>
<div class="line"> ---*---*---*---*</div>
</div><!-- fragment --> </div><p> The way this is done is by first defining where the \(15=5\times 3\) vertices are located &ndash; here, we say that they are on integer points with the middle one on the left side moved to the right by a value of <code>delta=0.5</code>.</p>
<p>In the following, we then have to say which vertices together form the 8 cells. The following code is then entirely equivalent to what we also do in <a class="el" href="step_14.html">step-14</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">CathodeRaySimulator&lt;dim&gt;::make_grid</a>()</div>
<div class="line">{</div>
<div class="line">  static_assert(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2,</div>
<div class="line">                <span class="stringliteral">&quot;This function is currently only implemented for 2d.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       delta = 0.5;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nx    = 5;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ny    = 3;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;Point&lt;dim&gt;&gt; <a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a> </div>
<div class="line">    = {{0, 0},</div>
<div class="line">       {1, 0},</div>
<div class="line">       {2, 0},</div>
<div class="line">       {3, 0},</div>
<div class="line">       {4, 0},</div>
<div class="line">       {delta, 1},</div>
<div class="line">       {1, 1},</div>
<div class="line">       {2, 1},</div>
<div class="line">       {3, 1},</div>
<div class="line">       {4, 1},</div>
<div class="line">       {0, 2},</div>
<div class="line">       {1, 2},</div>
<div class="line">       {2, 2},</div>
<div class="line">       {3, 2},</div>
<div class="line">       {4, 2}};</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(<a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a>.size(), nx * ny);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;unsigned int&gt; cell_vertices[(nx - 1) * (ny - 1)] = {</div>
<div class="line">    {0, 1, nx + 0, nx + 1},</div>
<div class="line">    {1, 2, nx + 1, nx + 2},</div>
<div class="line">    {2, 3, nx + 2, nx + 3},</div>
<div class="line">    {3, 4, nx + 3, nx + 4},</div>
<div class="line"> </div>
<div class="line">    {5, nx + 1, 2 * nx + 0, 2 * nx + 1},</div>
<div class="line">    {nx + 1, nx + 2, 2 * nx + 1, 2 * nx + 2},</div>
<div class="line">    {nx + 2, nx + 3, 2 * nx + 2, 2 * nx + 3},</div>
<div class="line">    {nx + 3, nx + 4, 2 * nx + 3, 2 * nx + 4}};</div>
</div><!-- fragment --><p>With these arrays out of the way, we can move to slightly higher higher-level data structures. We create a vector of <a class="el" href="structCellData.html">CellData</a> objects that store for each cell to be created the vertices in question as well as the <a class="el" href="DEALGlossary.html#GlossMaterialId">material id</a> (which we will here simply set to zero since we don't use it in the program).</p>
<p>This information is then handed to the <a class="el" href="classTriangulation.html#ab2eeef6a38fa053814433870a9c35a0c">Triangulation::create_triangulation()</a> function, and the mesh is twice globally refined.</p>
<div class="fragment"><div class="line">std::vector&lt;CellData&lt;dim&gt;&gt; <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>((nx - 1) * (ny - 1), <a class="code" href="structCellData.html">CellData&lt;dim&gt;</a>());</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>].vertices    = cell_vertices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>];</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>].material_id = 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.create_triangulation(</div>
<div class="line">  <a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a>,</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>,</div>
<div class="line">  <a class="code" href="structSubCellData.html">SubCellData</a>()); <span class="comment">// No boundary information</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(2);</div>
</div><!-- fragment --><p>The remaining part of the function loops over all cells and their faces, and if a face is at the boundary determines which boundary indicator should be applied to it. The various conditions should make sense if you compare the code with the picture of the geometry above.</p>
<p>Once done with this step, we refine the mesh once more globally.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &lt; 0.5) &amp;&amp;</div>
<div class="line">              (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &lt; 2))</div>
<div class="line">            <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>);</div>
<div class="line">          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &lt; 2))</div>
<div class="line">            <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">BoundaryIds::focus_element</a>);</div>
<div class="line">          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 4 - 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12) &amp;&amp;</div>
<div class="line">                   ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &gt; 1.5) || (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &lt; 0.5)))</div>
<div class="line">            <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">BoundaryIds::anode</a>);</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="function__restriction__0_8txt.html#a93564637b88550ce91447da5d5661dc2">BoundaryIds::open</a>);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(1);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatorsetup_systemcodefunction"></a> </p><h4>The <code>CathodeRaySimulator::setup_system</code> function</h4>
<p>The next function in this program deals with setting up the various objects related to solving the partial differential equations. It is in essence a copy of the corresponding function in <a class="el" href="step_6.html">step-6</a> and requires no further discussion.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::setup_system()</div>
<div class="line">{</div>
<div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">  system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>,</div>
<div class="line">                                           <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                             -<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">BoundaryIds::focus_element</a>,</div>
<div class="line">                                           <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                             -<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">BoundaryIds::anode</a>,</div>
<div class="line">                                           <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                             +<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                  dsp,</div>
<div class="line">                                  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                  <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">false</span>);</div>
<div class="line">  <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">  system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatorassemble_systemcodefunction"></a> </p><h4>The <code>CathodeRaySimulator::assemble_system</code> function</h4>
<p>The function that computes the matrix entries is again in essence a copy of the corresponding function in <a class="el" href="step_6.html">step-6</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::assemble_system()</div>
<div class="line">{</div>
<div class="line">  system_matrix = 0;</div>
<div class="line">  system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line">      cell_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.quadrature_point_indices())</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> : fe_values.dof_indices())</div>
<div class="line">              <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_index) * <span class="comment">// grad phi_i(x_q)</span></div>
<div class="line">                 fe_values.shape_grad(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_index) * <span class="comment">// grad phi_j(x_q)</span></div>
<div class="line">                 fe_values.JxW(q_index));           <span class="comment">// dx</span></div>
<div class="line">          }</div>
</div><!-- fragment --><p>The only interesting part of this function is how it forms the right hand side of the linear system. Recall that the right hand side of the PDE is </p><p class="formulaDsp">
\[ \sum_p (N e)\delta(\mathbf x-\mathbf x_p), \]
</p>
<p> where we have used \(p\) to index the particles here to avoid confusion with the shape function \(\varphi_i\); \(\mathbf x_p\) is the position of the \(p\)th particle.</p>
<p>When multiplied by a test function \(\varphi_i\) and integrated over the domain results in a right hand side vector </p><p class="formulaDsp">
\begin{align*} F_i &amp;= \int_\Omega \varphi_i (\mathbf x)\left[ \sum_p (N e)\delta(\mathbf x-\mathbf x_p) \right] dx \\ &amp;= \sum_p (N e) \varphi_i(\mathbf x_p). \end{align*}
</p>
<p> Note that the final line no longer contains an integral, and consequently also no occurrence of \(dx\) which would require the appearance of the <code>JxW</code> symbol in our code.</p>
<p>For a given cell \(K\), this cell's contribution to the right hand side is then </p><p class="formulaDsp">
\begin{align*} F_i^K &amp;= \sum_{p, \mathbf x_p\in K} (N e) \varphi_i(\mathbf x_p), \end{align*}
</p>
<p> i.e., we only have to worry about those particles that are actually located on the current cell \(K\).</p>
<p>In practice, what we do here is the following: If there are any particles on the current cell, then we first obtain an iterator range pointing to the first particle of that cell as well as the particle past the last one on this cell (or the end iterator) &ndash; i.e., a half-open range as is common for C++ functions. Knowing now the list of particles, we query their reference locations (with respect to the reference cell), evaluate the shape functions in these reference locations, and compute the force according to the formula above (without any FEValues::JxW).</p>
<dl class="section note"><dt>Note</dt><dd>It is worth pointing out that calling the <a class="el" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">Particles::ParticleHandler::particles_in_cell()</a> and <a class="el" href="classParticles_1_1ParticleHandler.html#ac043a4ea224ed50a03b8e9c3d3b98aec">Particles::ParticleHandler::n_particles_in_cell()</a> functions is not very efficient on problems with a large number of particles. But it illustrates the easiest way to write this algorithm, and so we are willing to incur this cost for the moment for expository purposes. We discuss the issue in more detail in the <a href="#extensions">"possibilities for extensions" section</a> below, and use a better approach in <a class="el" href="step_70.html">step-70</a>, for example.</dd></dl>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> : particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;reference_location =</div>
<div class="line">        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_reference_location();</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">        cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">          (<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFE__Poly.html#a9205cb50b9901b40adc7220dd92ded5c">shape_value</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, reference_location) * <span class="comment">// phi_i(x_p)</span></div>
<div class="line">           (-<a class="code" href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">Constants::electrons_per_particle</a> *   <span class="comment">// N</span></div>
<div class="line">            <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a>));          <span class="comment">// e</span></div>
<div class="line">    }</div>
</div><!-- fragment --><p>Finally, we can copy the contributions of this cell into the global matrix and right hand side vector:</p>
<div class="fragment"><div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>, cell_rhs, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, system_matrix, system_rhs);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorsolve"></a> </p><h4>CathodeRaySimulator::solve</h4>
<p>The function that solves the linear system is then again exactly as in <a class="el" href="step_6.html">step-6</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::solve_field()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(1000, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12);</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">  <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(system_matrix, 1.2);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorrefine_grid"></a> </p><h4>CathodeRaySimulator::refine_grid</h4>
<p>The final field-related function is the one that refines the grid. We will call it a number of times in the first time step to obtain a mesh that is well-adapted to the structure of the solution and, in particular, resolves the various singularities in the solution that are due to re-entrant corners and places where the boundary condition type changes. You might want to refer to <a class="el" href="step_6.html">step-6</a> again for more details:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::refine_grid()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(dof_handler,</div>
<div class="line">                                     <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div>
<div class="line">                                     {},</div>
<div class="line">                                     <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">                                     estimated_error_per_cell);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                  estimated_error_per_cell,</div>
<div class="line">                                                  0.1,</div>
<div class="line">                                                  0.03);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorcreate_particles"></a> </p><h4>CathodeRaySimulator::create_particles</h4>
<p>Let us now turn to the functions that deal with particles. The first one is about the creation of particles. As mentioned in the introduction, we want to create a particle at points of the cathode if the the electric field \(\mathbf E=\nabla V\) exceeds a certain threshold, i.e., if \(|\mathbf E| \ge E_\text{threshold}\), and if furthermore the electric field points into the domain (i.e., if \(\mathbf E \cdot \mathbf n &lt; 0\)). As is common in the finite element method, we evaluate fields (and their derivatives) at specific evaluation points; typically, these are "quadrature points", and so we create a "quadrature formula" that we will use to designate the points at which we want to evaluate the solution. Here, we will simply take <a class="el" href="classQMidpoint.html">QMidpoint</a> implying that we will only check the threshold condition at the midpoints of faces. We then use this to initialize an object of type <a class="el" href="classFEFaceValues.html">FEFaceValues</a> to evaluate the solution at these points.</p>
<p>All of this will then be used in a loop over all cells, their faces, and specifically those faces that are at the boundary and, moreover, the cathode part of the boundary.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::create_particles()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> fe_face_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                   <a class="code" href="classQMidpoint.html">QMidpoint&lt;dim - 1&gt;</a>(),</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; solution_gradients(</div>
<div class="line">    fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">          (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>))</div>
<div class="line">        {</div>
<div class="line">          fe_face_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
</div><!-- fragment --><p>So we have found a face on the cathode. Next, we let the <a class="el" href="classFEFaceValues.html">FEFaceValues</a> object compute the gradient of the solution at each "quadrature" point, and extract the electric field vector from the gradient in the form of a <a class="el" href="classTensor.html">Tensor</a> variable through the methods discussed in the <a class="el" href="group__vector__valued.html">vector-valued problems</a> documentation module.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> electric_potential(0);</div>
<div class="line">fe_face_values[electric_potential].<a class="code" href="classFEValuesBase.html#ad1f4e0deb5d982e8172d82141c634a67">get_function_gradients</a>(</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, solution_gradients);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point :</div>
<div class="line">     fe_face_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> = solution_gradients[q_point];</div>
</div><!-- fragment --><p>Electrons can only escape the cathode if the electric field strength exceeds a threshold and, crucially, if the electric field points <em>into</em> the domain. Once we have that checked, we create a new <a class="el" href="classParticles_1_1Particle.html">Particles::Particle</a> object at this location and insert it into the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> object with a unique ID.</p>
<p>The only thing that may be not obvious here is that we also associate with this particle the location in the reference coordinates of the cell we are currently on. This is done because we will in downstream functions compute quantities such as the electric field at the location of the particle (e.g., to compute the forces that act on it when updating its position in each time step). Evaluating a finite element field at arbitrary coordinates is quite an expensive operation because shape functions are really only defined on the reference cell, and so when asking for the electric field at an arbitrary point requires us first to determine what the reference coordinates of that point are. To avoid having to do this over and over, we determine these coordinates once and for all and then store these reference coordinates directly with the particle.</p>
<div class="fragment"><div class="line">      <span class="keywordflow">if</span> ((<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> * fe_face_values.<a class="code" href="classFEValuesBase.html#ac25ec6835799c3b6c7c842f8acb05eb3">normal_vector</a>(q_point) &lt; 0) &amp;&amp;</div>
<div class="line">          (<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a>.norm() &gt; <a class="code" href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">Constants::E_threshold</a>))</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a> =</div>
<div class="line">            fe_face_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_point);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classParticles_1_1Particle.html">Particles::Particle&lt;dim&gt;</a> new_particle;</div>
<div class="line">          new_particle.<a class="code" href="classParticles_1_1Particle.html#afbe52b594cf4a8dd11431679c4ef2b52">set_location</a>(<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>);</div>
<div class="line">          new_particle.<a class="code" href="classParticles_1_1Particle.html#a57efa2034baca617ba3160ccfbbc7cd7">set_reference_location</a>(</div>
<div class="line">            <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>.transform_real_to_unit_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>));</div>
<div class="line">          new_particle.<a class="code" href="classParticles_1_1Particle.html#af792bce47ec4746ad2c78e7e800299a8">set_id</a>(next_unused_particle_id);</div>
<div class="line">          particle_handler.insert_particle(new_particle, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">          ++next_unused_particle_id;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>At the end of all of these insertions, we let the <code>particle_handler</code> update some internal statistics about the particles it stores.</p>
<div class="fragment"><div class="line">  particle_handler.update_cached_numbers();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatormove_particles"></a> </p><h4>CathodeRaySimulator::move_particles</h4>
<p>The second particle-related function is the one that moves the particles in each time step. To do this, we have to loop over all cells, the particles in each cell, and evaluate the electric field at each of the particles' positions.</p>
<p>The approach used here is conceptually the same used in the <code>assemble_system()</code> function: We loop over all cells, find the particles located there (with the same caveat about the inefficiency of the algorithm used here to find these particles), and use <a class="el" href="classFEPointEvaluation.html">FEPointEvaluation</a> object to evaluate the gradient at these positions:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::move_particles()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> dt = <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_next_step_size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>            solution_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">  <a class="code" href="classFEPointEvaluation.html">FEPointEvaluation&lt;1, dim&gt;</a> evaluator(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a>&lt;</div>
<div class="line">          <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::particle_iterator_range particles_in_cell =</div>
<div class="line">          particle_handler.<a class="code" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">particles_in_cell</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;Point&lt;dim&gt;&gt; particle_positions;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> : particles_in_cell)</div>
<div class="line">          particle_positions.push_back(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_reference_location());</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_values(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, solution_values);</div>
</div><!-- fragment --><p>Then we can ask the <a class="el" href="classFEPointEvaluation.html">FEPointEvaluation</a> object for the gradients of the solution (i.e., the electric field \(\mathbf E\)) at these locations and loop over the individual particles:</p>
<div class="fragment"><div class="line">evaluator.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, particle_positions);</div>
<div class="line">evaluator.evaluate(<a class="code" href="classArrayView.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a>(solution_values),</div>
<div class="line">                   <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeadde91684ebb2c6ec5c5c5293123f6a04">EvaluationFlags::gradients</a>);</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleHandler&lt;dim&gt;::particle_iterator</a></div>
<div class="line">    <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> = particles_in_cell.<a class="code" href="classArrayView.html#a1a1c62a26e5f55bfe124894c0a31386f">begin</a>();</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a> = 0;</div>
<div class="line">       <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> != particles_in_cell.<a class="code" href="classArrayView.html#a775e02d2deaf2f769e24dee0c3e7a582">end</a>();</div>
<div class="line">       ++<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, ++<a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> &amp;<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> =</div>
<div class="line">        evaluator.get_gradient(<a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a>);</div>
</div><!-- fragment --><p>Having now obtained the electric field at the location of one of the particles, we use this to update first the velocity and then the position. To do so, let us first get the old velocity out of the properties stored with the particle, compute the acceleration, update the velocity, and store this new velocity again in the properties of the particle. Recall that this corresponds to the first of the following set of update equations discussed in the introduction: </p><p class="formulaDsp">
\begin{align*} \frac{{\mathbf v}_i^{(n)} -{\mathbf v}_i^{(n-1)}}{\Delta t} &amp;= \frac{e\nabla V^{(n)}}{m} \\ \frac{{\mathbf x}_i^{(n)}-{\mathbf x}_i^{(n-1)}} {\Delta t} &amp;= {\mathbf v}_i^{(n)}. \end{align*}
</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> old_velocity(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_properties());</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> acceleration =</div>
<div class="line">  <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a> / <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Constants::electron_mass</a> * <a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> new_velocity =</div>
<div class="line">  old_velocity + acceleration * dt;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_properties(<a class="code" href="classArrayView.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a>(new_velocity));</div>
</div><!-- fragment --><p>With the new velocity, we can then also update the location of the particle and tell the particle about it.</p>
<div class="fragment"><div class="line">        <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> new_location =</div>
<div class="line">          <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_location() + dt * new_velocity;</div>
<div class="line">        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_location(new_location);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Having updated the locations and properties (i.e., velocities) of all particles, we need to make sure that the <code>particle_handler</code> again knows which cells they are in, and what their locations in the coordinate system of the reference cell are. The following function does that. (It also makes sure that, in parallel computations, particles are moved from one processor to another processor if a particle moves from the subdomain owned by the former to the subdomain owned by the latter.)</p>
<div class="fragment"><div class="line">  particle_handler.sort_particles_into_subdomains_and_cells();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatortrack_lost_particle"></a> </p><h4>CathodeRaySimulator::track_lost_particle</h4>
<p>The final particle-related function is the one that is called whenever a particle is lost from the simulation. This typically happens if it leaves the domain. If that happens, this function is called both the cell (which we can ask for its new location) and the cell it was previously on. The function then keeps track of updating the number of particles lost in this time step, the total number of lost particles, and then estimates whether the particle left through the hole in the middle of the anode. We do so by first checking whether the cell it was in last had an \(x\) coordinate to the left of the right boundary (located at \(x=4\)) and the particle now has a position to the right of the right boundary. If that is so, we compute a direction vector of its motion that is normalized so that the \(x\) component of the direction vector is equal to \(1\). With this direction vector, we can compute where it would have intersected the line \(x=4\). If this intersect is between \(0.5\) and \(1.5\), then we claim that the particle left through the hole and increment a counter.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::track_lost_particle(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">{</div>
<div class="line">  ++n_recently_lost_particles;</div>
<div class="line">  ++n_total_lost_particles;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> current_location              = <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_location();</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> approximate_previous_location = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ((approximate_previous_location[0] &lt; 4) &amp;&amp; (current_location[0] &gt; 4))</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a> =</div>
<div class="line">        (current_location - approximate_previous_location) /</div>
<div class="line">        (current_location[0] - approximate_previous_location[0]);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> right_boundary_intercept =</div>
<div class="line">        approximate_previous_location[1] +</div>
<div class="line">        (4 - approximate_previous_location[0]) * <a class="code" href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a>[1];</div>
<div class="line">      <span class="keywordflow">if</span> ((right_boundary_intercept &gt; 0.5) &amp;&amp;</div>
<div class="line">          (right_boundary_intercept &lt; 1.5))</div>
<div class="line">        ++n_particles_lost_through_anode;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorupdate_timestep_size"></a> </p><h4>CathodeRaySimulator::update_timestep_size</h4>
<p>As discussed at length in the introduction, we need to respect a time step condition whereby particles can not move further than one cell in one time step. To ensure that this is the case, we again first compute the maximal speed of all particles on each cell, and divide the cell size by that speed. We then compute the next time step size as the minimum of this quantity over all cells, using the safety factor discussed in the introduction, and set this as the desired time step size using the DiscreteTime::set_desired_time_step_size() function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::update_timestep_size()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number() &gt; 0)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> min_cell_size_over_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">        <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> cell_size = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;minimum_vertex_distance();</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">double</span> max_particle_velocity(0.0);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> :</div>
<div class="line">                 particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_properties());</div>
<div class="line">                max_particle_velocity =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_particle_velocity, <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>.norm());</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (max_particle_velocity &gt; 0)</div>
<div class="line">              min_cell_size_over_velocity =</div>
<div class="line">                <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_cell_size_over_velocity,</div>
<div class="line">                         cell_size / max_particle_velocity);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">      constexpr <span class="keywordtype">double</span> c_safety = 0.5;</div>
<div class="line">      <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.set_desired_next_step_size(c_safety * 0.5 *</div>
<div class="line">                                      min_cell_size_over_velocity);</div>
<div class="line">    }</div>
</div><!-- fragment --><p>As mentioned in the introduction, we have to treat the very first time step differently since there, particles are not available yet or do not yet have the information associated that we need for the computation of a reasonable step length. The formulas below follow the discussion in the introduction.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;dim&gt;</a> vertex_quadrature;</div>
<div class="line">      <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>, vertex_quadrature, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;Tensor&lt;1, dim&gt;&gt; field_gradients(vertex_quadrature.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> min_timestep = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">        <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> cell_size = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;minimum_vertex_distance();</div>
<div class="line"> </div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_gradients(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, field_gradients);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">double</span> max_E = 0;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">              max_E = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_E, field_gradients[q_point].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (max_E &gt; 0)</div>
<div class="line">              min_timestep =</div>
<div class="line">                <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_timestep,</div>
<div class="line">                         <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(0.5 * cell_size *</div>
<div class="line">                                   <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Constants::electron_mass</a> /</div>
<div class="line">                                   <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a> / max_E));</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.set_desired_next_step_size(min_timestep);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatoroutput_resultscodefunction"></a> </p><h4>The <code>CathodeRaySimulator::output_results()</code> function</h4>
<p>The final function implementing pieces of the overall algorithm is the one that generates graphical output. In the current context, we want to output both the electric potential field as well as the particle locations and velocities. But we also want to output the electric field, i.e., the gradient of the solution.</p>
<p>deal.II has a general way how one can compute derived quantities from the solution and output those as well. Here, this is the electric field, but it could also be some other quantity &ndash; say, the norm of the electric field, or in fact anything else one could want to compute from the solution \(V_h(\mathbf x)\) or its derivatives. This general solution uses the <a class="el" href="classDataPostprocessor.html">DataPostprocessor</a> class and, in cases like the one here where we want to output a quantity that represents a vector field, the <a class="el" href="classDataPostprocessorVector.html">DataPostprocessorVector</a> class.</p>
<p>Rather than try and explain how this class works, let us simply refer to the documentation of the <a class="el" href="classDataPostprocessorVector.html">DataPostprocessorVector</a> class that has essentially this case as a well-documented example.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>ElectricFieldPostprocessor : <span class="keyword">public</span> <a class="code" href="classDataPostprocessorVector.html">DataPostprocessorVector</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  ElectricFieldPostprocessor()</div>
<div class="line">    : <a class="code" href="classDataPostprocessorVector.html">DataPostprocessorVector</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<span class="stringliteral">&quot;electric_field&quot;</span>, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classDataPostprocessor.html#a07ebcf764cf911c6d78f21c32ea1d2d0">evaluate_scalar_field</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Scalar.html">DataPostprocessorInputs::Scalar&lt;dim&gt;</a> &amp;input_data,</div>
<div class="line">    <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;computed_quantities)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>.size(),</div>
<div class="line">                    computed_quantities.size());</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(computed_quantities[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>(), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          computed_quantities[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>];</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">};</div>
</div><!-- fragment --><p>With this, the <code>output_results()</code> function becomes relatively straightforward: We use the <a class="el" href="classDataOut.html">DataOut</a> class as we have in almost every one of the previous tutorial programs to output the solution (the "electric
 potential") and we use the postprocessor defined above to also output its gradient (the "electric field"). This all is then written into a file in VTU format after also associating the current time and time step number with this file.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  {</div>
<div class="line">    ElectricFieldPostprocessor&lt;dim&gt; electric_field;</div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a>                    data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, <span class="stringliteral">&quot;electric_potential&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, electric_field);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(</div>
<div class="line">      <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time(), <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number()));</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution-&quot;</span> +</div>
<div class="line">                         <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number(), 4) +</div>
<div class="line">                         <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Output the particle positions and properties is not more complicated. The <a class="el" href="classParticles_1_1DataOut.html">Particles::DataOut</a> class plays the role of the <a class="el" href="classDataOut.html">DataOut</a> class for particles, and all we have to do is tell that class where to take particles from and how to interpret the <code>dim</code> components of the properties &ndash; namely, as a single vector indicating the velocity, rather than as <code>dim</code> scalar properties. The rest is then the same as above:</p>
<div class="fragment"><div class="line">  {</div>
<div class="line">    <a class="code" href="classParticles_1_1DataOut.html">Particles::DataOut&lt;dim, dim&gt;</a> particle_out;</div>
<div class="line">    particle_out.<a class="code" href="classParticles_1_1DataOut.html#adf095165dc286310226584b2b9972701">build_patches</a>(</div>
<div class="line">      particle_handler,</div>
<div class="line">      std::vector&lt;std::string&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>),</div>
<div class="line">      std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;(</div>
<div class="line">        <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>));</div>
<div class="line"> </div>
<div class="line">    particle_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(</div>
<div class="line">      <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time(), <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number()));</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;particles-&quot;</span> +</div>
<div class="line">                         <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number(), 4) +</div>
<div class="line">                         <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">    particle_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorrun"></a> </p><h4>CathodeRaySimulator::run</h4>
<p>The last member function of the principal class of this program is then the driver. At the top, it refines the mesh a number of times by solving the problem (with not particles yet created) on a sequence of finer and finer meshes.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">CathodeRaySimulator&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
</div><!-- fragment --><p>do a few refinement cycles up front</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_cycles = 3;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0;</div>
<div class="line">     refinement_cycle &lt; n_pre_refinement_cycles;</div>
<div class="line">     ++refinement_cycle)</div>
<div class="line">  {</div>
<div class="line">    setup_system();</div>
<div class="line">    assemble_system();</div>
<div class="line">    solve_field();</div>
<div class="line">    refine_grid();</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Now do the loop over time. The sequence of steps follows closely the outline of the algorithm discussed in the introduction. As discussed in great detail in the documentation of the <a class="el" href="classDiscreteTime.html">DiscreteTime</a> class, while we move the field and particle information forward by one time step, the time stored in the <code>time</code> variable is not consistent with where (some of) these quantities are (in the diction of <a class="el" href="classDiscreteTime.html">DiscreteTime</a>, this is the "update
 stage"). The call to <code>time.advance_time()</code> makes everything consistent again by setting the <code>time</code> variable to the time at which the field and particles already are, and once we are in this "consistent stage", we can generate graphical output and write information about the current state of the simulation to screen.</p>
<div class="fragment"><div class="line">    setup_system();</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number() + 1 &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Field degrees of freedom:                 &quot;</span></div>
<div class="line">                  &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_system();</div>
<div class="line">        solve_field();</div>
<div class="line"> </div>
<div class="line">        create_particles();</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Total number of particles in simulation:  &quot;</span></div>
<div class="line">                  &lt;&lt; particle_handler.n_global_particles() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        n_recently_lost_particles = 0;</div>
<div class="line">        update_timestep_size();</div>
<div class="line">        move_particles();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.advance_time();</div>
<div class="line"> </div>
<div class="line">        output_results();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Number of particles lost this time step:  &quot;</span></div>
<div class="line">                  &lt;&lt; n_recently_lost_particles &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">if</span> (n_total_lost_particles &gt; 0)</div>
<div class="line">          std::cout &lt;&lt; <span class="stringliteral">&quot;  Fraction of particles lost through anode: &quot;</span></div>
<div class="line">                    &lt;&lt; 1. * n_particles_lost_through_anode /</div>
<div class="line">                         n_total_lost_particles</div>
<div class="line">                    &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;  Now at t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;, dt=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_previous_step_size() &lt;&lt; <span class="charliteral">&#39;.&#39;</span></div>
<div class="line">                  &lt;&lt; std::endl</div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.is_at_end() == <span class="keyword">false</span>);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step19</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>The final function of the program is then again the <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> function. It is unchanged in all tutorial programs since <a class="el" href="step_6.html">step-6</a> and so there is nothing new to discuss:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classStep19_1_1CathodeRaySimulator.html">Step19::CathodeRaySimulator&lt;2&gt;</a> cathode_ray_simulator_2d;</div>
<div class="line">      cathode_ray_simulator_2d.<a class="code" href="classStep19_1_1CathodeRaySimulator.html#acceda54ac84d5e31aa1ae329bd1a0381">run</a>();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>When this program is run, it produces output that looks as follows: </p><div class="fragment"><div class="line">Timestep 1</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  20</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  0</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=2.12647e-07, dt=2.12647e-07.</div>
<div class="line"> </div>
<div class="line">Timestep 2</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  24</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  0</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=4.14362e-07, dt=2.01715e-07.</div>
<div class="line"> </div>
<div class="line">Timestep 3</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  28</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  0</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=5.96019e-07, dt=1.81657e-07.</div>
<div class="line"> </div>
<div class="line">Timestep 4</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  32</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  0</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=7.42634e-07, dt=1.46614e-07.</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  Timestep 1000</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  44</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  6</div>
<div class="line">  Fraction <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> through <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>: 0.0601266</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=4.93276e-05, dt=4.87463e-08.</div>
<div class="line"> </div>
<div class="line">Timestep 1001</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  44</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  0</div>
<div class="line">  Fraction <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> through <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>: 0.0601266</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=4.93759e-05, dt=4.82873e-08.</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Timestep 2091</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  44</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  0</div>
<div class="line">  Fraction <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> through <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>: 0.0503338</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=9.99237e-05, dt=4.26254e-08.</div>
<div class="line"> </div>
<div class="line">Timestep 2092</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  44</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  0</div>
<div class="line">  Fraction <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> through <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>: 0.0503338</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=9.99661e-05, dt=4.24442e-08.</div>
<div class="line"> </div>
<div class="line">Timestep 2093</div>
<div class="line">  Field <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>:                 4989</div>
<div class="line">  Total <a class="code" href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a> <a class="code" href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a>:  44</div>
<div class="line">  <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> <span class="keyword">this</span> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> <a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>:  2</div>
<div class="line">  Fraction <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a> through <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>: 0.050308</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a> <a class="code" href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a> t=0.0001, dt=3.38577e-08.</div>
</div><!-- fragment --><p>Picking a random few time steps, we can visualize the solution in the form of streamlines for the electric field and dots for the electrons: </p><div class="twocolumn" style="width: 80%"> <div> <img src="https://www.dealii.org/images/steps/developer/step-19.solution.0000.png" alt="The solution at time step 0 (t=0 seconds)." width="500" class="inline"/> <br  />
 Solution at time step 0 (t=0 seconds). <br  />
 </div> <div> <img src="https://www.dealii.org/images/steps/developer/step-19.solution.1400.png" alt="The solution at time step 1400 (t=0.000068 seconds)." width="500" class="inline"/> <br  />
 Solution at time step 1400 (t=0.000068 seconds). <br  />
 </div> <div> <img src="https://www.dealii.org/images/steps/developer/step-19.solution.0700.png" alt="The solution at time step 700 (t=0.000035 seconds)." width="500" class="inline"/> <br  />
 Solution at time step 700 (t=0.000035 seconds). <br  />
 </div> <div> <img src="https://www.dealii.org/images/steps/developer/step-19.solution.2092.png" alt="The solution at time step 2092 (t=0.0001 seconds)." width="500" class="inline"/> <br  />
 Solution at time step 2092 (t=0.0001 seconds). <br  />
 </div> </div><p>That said, a more appropriate way to visualize the results of this program are by creating a video that shows how these electrons move, and how the electric field changes in response to their motion:</p>
<p> 
<p align="center">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/HwUtE7xuteE"
   frameborder="0"
   allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
   allowfullscreen></iframe>
 </p>
</p>
<p>What you can see here is how the "focus element" of the boundary with its negative voltage repels the electrons and makes sure that they do not just fly away perpendicular from the cathode (as they do in the initial part of their trajectories). It also shows how the electric field lines move around over time, in response to the charges flying by &ndash; in other words, the feedback the particles have on the electric field that itself drives the motion of the electrons.</p>
<p>The movie suggests that electrons move in "bunches" or "bursts". One element of this appearance is an artifact of how the movie was created: Every frame of the movie corresponds to one time step, but the time step length varies. More specifically, the fastest particle moving through the smallest cell determines the length of the time step (see the discussion in the introduction), and consequently time steps are small whenever a (fast) particle moves through the small cells at the right edge of the domain; time steps are longer again once the particle has left the domain. This slowing-accelerating effect can easily be visualized by plotting the time step length shown in the screen output.</p>
<p>The second part of this is real, however: The simulation creates a large group of particles in the beginning, and fewer after about the 300th time step. This is probably because of the negative charge of the particles in the simulation: They reduce the magnitude of the electric field at the (also negatively charged electrode) and consequently reduce the number of points on the cathode at which the magnitude exceeds the threshold necessary to draw an electron out of the electrode.</p>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p><a class="anchor" id="Avoidingaperformancebottleneckwithparticles"></a></p><h4>Avoiding a performance bottleneck with particles </h4>
<p>The <code>assemble_system()</code>, <code>move_particles()</code>, and <code>update_timestep_size()</code> functions all call <a class="el" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">Particles::ParticleHandler::particles_in_cell()</a> and <a class="el" href="classParticles_1_1ParticleHandler.html#ac043a4ea224ed50a03b8e9c3d3b98aec">Particles::ParticleHandler::n_particles_in_cell()</a> that query information about the particles located on the current cell. While this is convenient, it's also inefficient. To understand why this is so, one needs to know how particles are stored in <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a>: namely, in a data structure in which particles are ordered in some kind of linear fashion sorted by the cell they are on. Consequently, in order to find the particles associated with a given cell, these functions need to search for the first (and possibly last) particle on a given cell &ndash; an effort that costs \({\cal O}(\log N)\) operations where \(N\) is the number of particles. But this is repeated on every cell; assuming that for large computations, the number of cells and particles are roughly proportional, the accumulated cost of these function calls is then \({\cal O}(N \log N)\) and consequently larger than the \({\cal O}(N)\) cost that we should shoot for with all parts of a program.</p>
<p>We can make this cheaper, though. First, instead of calling <a class="el" href="classParticles_1_1ParticleHandler.html#ac043a4ea224ed50a03b8e9c3d3b98aec">Particles::ParticleHandler::n_particles_in_cell()</a>, we might first call <a class="el" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">Particles::ParticleHandler::particles_in_cell()</a> and then compute the number of particles on a cell by just computing the distance of the last to the first particle on the current cell: </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleHandler.html#a655ae2bdfe026f1ed172a2ec4c6c3d60">Particles::ParticleHandler&lt;dim, spacedim&gt;::particle_iterator_range</a></div>
<div class="line">  particles_in_cell = particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span></div>
<div class="line">  <a class="code" href="particle__handler__0_8txt.html#a5ebacea68cda561e1adc199d23e1de40">n_particles_in_cell</a> = std::distance (particles_in_cell.<a class="code" href="classParticles_1_1ParticleHandler.html#a958a15b3aa325db82b4876cdb9feb527">begin</a>(),</div>
<div class="line">                                       particles_in_cell.<a class="code" href="classParticles_1_1ParticleHandler.html#ab5f542a397843198eb82d8537602daf3">end</a>());</div>
</div><!-- fragment --><p> The first of these calls is of course still \({\cal O}(\log N)\), but at least the second call only takes a compute time proportional to the number of particles on the current cell and so, when accumulated over all cells, has a cost of \({\cal O}(N)\).</p>
<p>But we can even get rid of the first of these calls with some proper algorithm design. That's because particles are ordered in the same way as cells, and so we can just walk them as we move along on the cells. The following outline of an algorithm does this: </p><div class="fragment"><div class="line"><span class="keyword">auto</span> begin_particle_on_cell = particle_handler.begin();</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_particles_on_cell = 0;</div>
<div class="line">    <span class="keyword">auto</span> end_particle_on_cell = begin_particle_on_cell;</div>
<div class="line">    <span class="keywordflow">while</span> (end_particle_on_cell-&gt;get_surrounding_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">           == <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">      {</div>
<div class="line">        ++n_particles_on_cell;</div>
<div class="line">        ++end_particle_on_cell;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    ...now <a class="code" href="work__stream__0_8txt.html#a96b33355a5c2a51e5f573fa286e92491">operate</a> <a class="code" href="data__out__base__0_8txt.html#a1a0f08903e9f2a25a073261a20b86e26">on</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="synchronous__iterator__0_8txt.html#a3e447fe5e17c249965365f92a0755913">range</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="discrete__time__0_8txt.html#aea6d70f72c4e549e943e681a41fdb8d9">from</a> begin_particle_on_cell</div>
<div class="line">       <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a23e8d7ec9b1cf01acce4516431c61616">to</a> end_particle_on_cell, <a class="code" href="update__flags__0_8txt.html#a5f3fcf87333f5770d16608f67ad88d19">all</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__base__0_8txt.html#ab42576dfdd4ffe69354987b53ad19f20">which</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#ae32ad430917839b4e435a4d04c5d975a">are</a> <a class="code" href="function__0_8txt.html#a8f6aa3983c7a97f1d27b94ad1d160c10">known</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a23e8d7ec9b1cf01acce4516431c61616">to</a> <a class="code" href="coding__conventions__0_8txt.html#a2ea3312e08a7e3658bf73660b48f0aa4">be</a> <a class="code" href="data__out__base__0_8txt.html#a1a0f08903e9f2a25a073261a20b86e26">on</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> current</div>
<div class="line">       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>...;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Move the begin iterator forward so that it points to the first</span></div>
<div class="line">    <span class="comment">// particle on the next cell</span></div>
<div class="line">    begin_particle_on_cell = end_particle_on_cell;</div>
<div class="line">  }</div>
</div><!-- fragment --><p>In this code, we touch every cell exactly once and we never have to search the big data structure for the first or last particle on each cell. As a consequence, the algorithm costs a total of \({\cal O}(N)\) for a complete sweep of all particles and all cells.</p>
<p>It would not be very difficult to implement this scheme for all three of the functions in this program that have this issue.</p>
<p><a class="anchor" id="Morestatisticsaboutelectrons"></a></p><h4>More statistics about electrons </h4>
<p>The program already computes the fraction of the electrons that leave the domain through the hole in the anode. But there are other quantities one might be interested in. For example, the average velocity of these particles. It would not be very difficult to obtain each particle's velocity from its properties, in the same way as we do in the <code>move_particles()</code> function, and compute statistics from it.</p>
<p><a class="anchor" id="Abettersynchronizedvisualization"></a></p><h4>A better-synchronized visualization </h4>
<p>As discussed above, there is a varying time difference between different frames of the video because we create output for every time step. A better way to create movies would be to generate a new output file in fixed time intervals, regardless of how many time steps lie between each such point.</p>
<p><a class="anchor" id="Abettertimeintegrator"></a></p><h4>A better time integrator </h4>
<p>The problem we are considering in this program is a coupled, multiphysics problem. But the way we solve it is by first computing the (electric) potential field and then update the particle locations. This is what is called an "operator-splitting method", a concept we will investigate in more detail in <a class="el" href="step_58.html">step-58</a>.</p>
<p>While it is awkward to think of a way to solve this problem that does not involve splitting the problem into a PDE piece and a particles piece, one can* (and probably should!) think of a better way to update the particle locations. Specifically, the equations we use to update the particle location are </p><p class="formulaDsp">
\begin{align*} \frac{{\mathbf v}_i^{(n)}-{\mathbf v}_i^{(n-1)}}{\Delta t} &amp;= \frac{e\nabla V^{(n)}}{m} \\ \frac{{\mathbf x}_i^{(n)}-{\mathbf x}_i^{(n-1)}}{\Delta t} &amp;= {\mathbf v}_i^{(n)}. \end{align*}
</p>
<p> This corresponds to a simple forward-Euler time discretization &ndash; a method of first order accuracy in the time step size \(\Delta t\) that we know we should avoid because we can do better. Rather, one might want to consider a scheme such as the <a href="https://en.wikipedia.org/wiki/Leapfrog_integration">leapfrog scheme</a> or more generally <a href="https://en.wikipedia.org/wiki/Symplectic_integrator">symplectic integrators</a> such as the <a href="https://en.wikipedia.org/wiki/Verlet_integration">Verlet scheme</a>.</p>
<p><a class="anchor" id="Parallelization"></a></p><h4>Parallelization </h4>
<p>In release mode, the program runs in about 3.5 minutes on one of the author's laptops at the time of writing this. That's acceptable. But what if we wanted to make the simulation three-dimensional? If we wanted to not use a maximum of around 100 particles at any given time (as happens with the parameters used here) but 100,000? If we needed a substantially finer mesh?</p>
<p>In those cases, one would want to run the program not just on a single processor, but in fact on as many as one has available. This requires parallelization both the PDE solution as well as over particles. In practice, while there are substantial challenges to making this efficient and scale well, these challenges are all addressed in deal.II itself. For example, <a class="el" href="step_40.html">step-40</a> shows how to parallelize the finite element part, and <a class="el" href="step_70.html">step-70</a> shows how one can then also parallelize the particles part.</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2020 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Wolfgang Bangerth, Rene Gassmoeller, Peter Munch, 2020.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__free_2fe__point__evaluation_8h.html">deal.II/matrix_free/fe_point_evaluation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2discrete__time_8h.html">deal.II/base/discrete_time.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="particles_2particle__handler_8h.html">deal.II/particles/particle_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="particles_2data__out_8h.html">deal.II/particles/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep19.html">Step19</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">namespace </span>BoundaryIds</div>
<div class="line">  {</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="function__restriction__0_8txt.html#a93564637b88550ce91447da5d5661dc2">open</a>          = 101;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">cathode</a>       = 102;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">focus_element</a> = 103;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>         = 104;</div>
<div class="line">  } <span class="comment">// namespace BoundaryIds</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>Constants</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">electron_mass</a>   = 9.1093837015e-31;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">electron_charge</a> = 1.602176634e-19;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">V0</a> = 1;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">E_threshold</a> = 0.05;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">electrons_per_particle</a> = 3e15;</div>
<div class="line">  } <span class="comment">// namespace Constants</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>CathodeRaySimulator</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    CathodeRaySimulator();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">    <span class="keywordtype">void</span> setup_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">    <span class="keywordtype">void</span> solve_field();</div>
<div class="line">    <span class="keywordtype">void</span> refine_grid();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> create_particles();</div>
<div class="line">    <span class="keywordtype">void</span> move_particles();</div>
<div class="line">    <span class="keywordtype">void</span> track_lost_particle(</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> update_timestep_size();</div>
<div class="line">    <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler&lt;dim&gt;</a> particle_handler;</div>
<div class="line">    <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           next_unused_particle_id;</div>
<div class="line">    <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_recently_lost_particles;</div>
<div class="line">    <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_total_lost_particles;</div>
<div class="line">    <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_particles_lost_through_anode;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDiscreteTime.html">DiscreteTime</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  CathodeRaySimulator&lt;dim&gt;::CathodeRaySimulator()</div>
<div class="line">    : <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1)</div>
<div class="line">    , <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(2)</div>
<div class="line">    , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    , particle_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, <span class="comment">/*n_properties=*/</span><a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)</div>
<div class="line">    , next_unused_particle_id(0)</div>
<div class="line">    , n_recently_lost_particles(0)</div>
<div class="line">    , n_total_lost_particles(0)</div>
<div class="line">    , n_particles_lost_through_anode(0)</div>
<div class="line">    , <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>(0, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4)</div>
<div class="line">  {</div>
<div class="line">    particle_handler.signals.particle_lost.connect(</div>
<div class="line">      [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">             <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) {</div>
<div class="line">        this-&gt;track_lost_particle(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      });</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">CathodeRaySimulator&lt;dim&gt;::make_grid</a>()</div>
<div class="line">  {</div>
<div class="line">    static_assert(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2,</div>
<div class="line">                  <span class="stringliteral">&quot;This function is currently only implemented for 2d.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       delta = 0.5;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nx    = 5;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ny    = 3;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;Point&lt;dim&gt;&gt; <a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a> </div>
<div class="line">      = {{0, 0},</div>
<div class="line">         {1, 0},</div>
<div class="line">         {2, 0},</div>
<div class="line">         {3, 0},</div>
<div class="line">         {4, 0},</div>
<div class="line">         {delta, 1},</div>
<div class="line">         {1, 1},</div>
<div class="line">         {2, 1},</div>
<div class="line">         {3, 1},</div>
<div class="line">         {4, 1},</div>
<div class="line">         {0, 2},</div>
<div class="line">         {1, 2},</div>
<div class="line">         {2, 2},</div>
<div class="line">         {3, 2},</div>
<div class="line">         {4, 2}};</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(<a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a>.size(), nx * ny);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;unsigned int&gt; cell_vertices[(nx - 1) * (ny - 1)] = {</div>
<div class="line">      {0, 1, nx + 0, nx + 1},</div>
<div class="line">      {1, 2, nx + 1, nx + 2},</div>
<div class="line">      {2, 3, nx + 2, nx + 3},</div>
<div class="line">      {3, 4, nx + 3, nx + 4},</div>
<div class="line"> </div>
<div class="line">      {5, nx + 1, 2 * nx + 0, 2 * nx + 1},</div>
<div class="line">      {nx + 1, nx + 2, 2 * nx + 1, 2 * nx + 2},</div>
<div class="line">      {nx + 2, nx + 3, 2 * nx + 2, 2 * nx + 3},</div>
<div class="line">      {nx + 3, nx + 4, 2 * nx + 3, 2 * nx + 4}};</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;CellData&lt;dim&gt;&gt; <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>((nx - 1) * (ny - 1), <a class="code" href="structCellData.html">CellData&lt;dim&gt;</a>());</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>].vertices    = cell_vertices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>];</div>
<div class="line">        <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>].material_id = 0;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.create_triangulation(</div>
<div class="line">      <a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a>,</div>
<div class="line">      <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>,</div>
<div class="line">      <a class="code" href="structSubCellData.html">SubCellData</a>()); <span class="comment">// No boundary information</span></div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(2);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &lt; 0.5) &amp;&amp;</div>
<div class="line">                (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &lt; 2))</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &lt; 2))</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">BoundaryIds::focus_element</a>);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 4 - 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12) &amp;&amp;</div>
<div class="line">                     ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &gt; 1.5) || (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &lt; 0.5)))</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">BoundaryIds::anode</a>);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="function__restriction__0_8txt.html#a93564637b88550ce91447da5d5661dc2">BoundaryIds::open</a>);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(1);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::setup_system()</div>
<div class="line">  {</div>
<div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">    system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>,</div>
<div class="line">                                             <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                               -<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">BoundaryIds::focus_element</a>,</div>
<div class="line">                                             <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                               -<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">BoundaryIds::anode</a>,</div>
<div class="line">                                             <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                               +<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                    dsp,</div>
<div class="line">                                    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                    <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::assemble_system()</div>
<div class="line">  {</div>
<div class="line">    system_matrix = 0;</div>
<div class="line">    system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line">        cell_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.quadrature_point_indices())</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> : fe_values.dof_indices())</div>
<div class="line">                <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_index) * <span class="comment">// grad phi_i(x_q)</span></div>
<div class="line">                   fe_values.shape_grad(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_index) * <span class="comment">// grad phi_j(x_q)</span></div>
<div class="line">                   fe_values.JxW(q_index));           <span class="comment">// dx</span></div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> : particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;reference_location =</div>
<div class="line">                <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_reference_location();</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  (<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFE__Poly.html#a9205cb50b9901b40adc7220dd92ded5c">shape_value</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, reference_location) * <span class="comment">// phi_i(x_p)</span></div>
<div class="line">                   (-<a class="code" href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">Constants::electrons_per_particle</a> *   <span class="comment">// N</span></div>
<div class="line">                    <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a>));          <span class="comment">// e</span></div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(</div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>, cell_rhs, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, system_matrix, system_rhs);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::solve_field()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(1000, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12);</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">    <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(system_matrix, 1.2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::refine_grid()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(dof_handler,</div>
<div class="line">                                       <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div>
<div class="line">                                       {},</div>
<div class="line">                                       <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">                                       estimated_error_per_cell);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                    estimated_error_per_cell,</div>
<div class="line">                                                    0.1,</div>
<div class="line">                                                    0.03);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::create_particles()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> fe_face_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                     <a class="code" href="classQMidpoint.html">QMidpoint&lt;dim - 1&gt;</a>(),</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; solution_gradients(</div>
<div class="line">      fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>))</div>
<div class="line">          {</div>
<div class="line">            fe_face_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> electric_potential(0);</div>
<div class="line">            fe_face_values[electric_potential].<a class="code" href="classFEValuesBase.html#ad1f4e0deb5d982e8172d82141c634a67">get_function_gradients</a>(</div>
<div class="line">              <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, solution_gradients);</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point :</div>
<div class="line">                 fe_face_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> = solution_gradients[q_point];</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> ((<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> * fe_face_values.<a class="code" href="classFEValuesBase.html#ac25ec6835799c3b6c7c842f8acb05eb3">normal_vector</a>(q_point) &lt; 0) &amp;&amp;</div>
<div class="line">                    (<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a>.norm() &gt; <a class="code" href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">Constants::E_threshold</a>))</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a> =</div>
<div class="line">                      fe_face_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_point);</div>
<div class="line"> </div>
<div class="line">                    <a class="code" href="classParticles_1_1Particle.html">Particles::Particle&lt;dim&gt;</a> new_particle;</div>
<div class="line">                    new_particle.<a class="code" href="classParticles_1_1Particle.html#afbe52b594cf4a8dd11431679c4ef2b52">set_location</a>(<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>);</div>
<div class="line">                    new_particle.<a class="code" href="classParticles_1_1Particle.html#a57efa2034baca617ba3160ccfbbc7cd7">set_reference_location</a>(</div>
<div class="line">                      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>.transform_real_to_unit_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>));</div>
<div class="line">                    new_particle.<a class="code" href="classParticles_1_1Particle.html#af792bce47ec4746ad2c78e7e800299a8">set_id</a>(next_unused_particle_id);</div>
<div class="line">                    particle_handler.insert_particle(new_particle, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">                    ++next_unused_particle_id;</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">    particle_handler.update_cached_numbers();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::move_particles()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> dt = <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_next_step_size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>            solution_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">    <a class="code" href="classFEPointEvaluation.html">FEPointEvaluation&lt;1, dim&gt;</a> evaluator(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a>&lt;</div>
<div class="line">            <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::particle_iterator_range particles_in_cell =</div>
<div class="line">            particle_handler.<a class="code" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">particles_in_cell</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">          std::vector&lt;Point&lt;dim&gt;&gt; particle_positions;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> : particles_in_cell)</div>
<div class="line">            particle_positions.push_back(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_reference_location());</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_values(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, solution_values);</div>
<div class="line"> </div>
<div class="line">          evaluator.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, particle_positions);</div>
<div class="line">          evaluator.evaluate(<a class="code" href="base_2array__view_8h.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a>(solution_values),</div>
<div class="line">                             <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeadde91684ebb2c6ec5c5c5293123f6a04">EvaluationFlags::gradients</a>);</div>
<div class="line"> </div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleHandler&lt;dim&gt;::particle_iterator</a></div>
<div class="line">              <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> = particles_in_cell.<a class="code" href="classArrayView.html#a1a1c62a26e5f55bfe124894c0a31386f">begin</a>();</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a> = 0;</div>
<div class="line">                 <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> != particles_in_cell.<a class="code" href="classArrayView.html#a775e02d2deaf2f769e24dee0c3e7a582">end</a>();</div>
<div class="line">                 ++<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, ++<a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> &amp;<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> =</div>
<div class="line">                  evaluator.get_gradient(<a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a>);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> old_velocity(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_properties());</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> acceleration =</div>
<div class="line">                  <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a> / <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Constants::electron_mass</a> * <a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a>;</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> new_velocity =</div>
<div class="line">                  old_velocity + acceleration * dt;</div>
<div class="line"> </div>
<div class="line">                <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_properties(<a class="code" href="base_2array__view_8h.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a>(new_velocity));</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> new_location =</div>
<div class="line">                  <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_location() + dt * new_velocity;</div>
<div class="line">                <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_location(new_location);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    particle_handler.sort_particles_into_subdomains_and_cells();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::track_lost_particle(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">  {</div>
<div class="line">    ++n_recently_lost_particles;</div>
<div class="line">    ++n_total_lost_particles;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> current_location              = <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_location();</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> approximate_previous_location = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((approximate_previous_location[0] &lt; 4) &amp;&amp; (current_location[0] &gt; 4))</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a> =</div>
<div class="line">          (current_location - approximate_previous_location) /</div>
<div class="line">          (current_location[0] - approximate_previous_location[0]);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> right_boundary_intercept =</div>
<div class="line">          approximate_previous_location[1] +</div>
<div class="line">          (4 - approximate_previous_location[0]) * <a class="code" href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a>[1];</div>
<div class="line">        <span class="keywordflow">if</span> ((right_boundary_intercept &gt; 0.5) &amp;&amp;</div>
<div class="line">            (right_boundary_intercept &lt; 1.5))</div>
<div class="line">          ++n_particles_lost_through_anode;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::update_timestep_size()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number() &gt; 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_cell_size_over_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">          <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> cell_size = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;minimum_vertex_distance();</div>
<div class="line"> </div>
<div class="line">              <span class="keywordtype">double</span> max_particle_velocity(0.0);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> :</div>
<div class="line">                   particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_properties());</div>
<div class="line">                  max_particle_velocity =</div>
<div class="line">                    <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_particle_velocity, <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>.norm());</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">if</span> (max_particle_velocity &gt; 0)</div>
<div class="line">                min_cell_size_over_velocity =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_cell_size_over_velocity,</div>
<div class="line">                           cell_size / max_particle_velocity);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        constexpr <span class="keywordtype">double</span> c_safety = 0.5;</div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.set_desired_next_step_size(c_safety * 0.5 *</div>
<div class="line">                                        min_cell_size_over_velocity);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;dim&gt;</a> vertex_quadrature;</div>
<div class="line">        <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>, vertex_quadrature, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt; field_gradients(vertex_quadrature.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> min_timestep = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">          <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> cell_size = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;minimum_vertex_distance();</div>
<div class="line"> </div>
<div class="line">              fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">              fe_values.get_function_gradients(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, field_gradients);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordtype">double</span> max_E = 0;</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">                max_E = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_E, field_gradients[q_point].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">if</span> (max_E &gt; 0)</div>
<div class="line">                min_timestep =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_timestep,</div>
<div class="line">                           <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(0.5 * cell_size *</div>
<div class="line">                                     <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Constants::electron_mass</a> /</div>
<div class="line">                                     <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a> / max_E));</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.set_desired_next_step_size(min_timestep);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>ElectricFieldPostprocessor : <span class="keyword">public</span> <a class="code" href="classDataPostprocessorVector.html">DataPostprocessorVector</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    ElectricFieldPostprocessor()</div>
<div class="line">      : <a class="code" href="classDataPostprocessorVector.html">DataPostprocessorVector</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<span class="stringliteral">&quot;electric_field&quot;</span>, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> evaluate_scalar_field(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Scalar.html">DataPostprocessorInputs::Scalar&lt;dim&gt;</a> &amp;input_data,</div>
<div class="line">      <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;computed_quantities)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>.size(),</div>
<div class="line">                      computed_quantities.size());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(computed_quantities[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>(), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            computed_quantities[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>];</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    {</div>
<div class="line">      ElectricFieldPostprocessor&lt;dim&gt; electric_field;</div>
<div class="line">      <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a>                    data_out;</div>
<div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, <span class="stringliteral">&quot;electric_potential&quot;</span>);</div>
<div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, electric_field);</div>
<div class="line">      data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">      data_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(</div>
<div class="line">        <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time(), <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number()));</div>
<div class="line"> </div>
<div class="line">      std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution-&quot;</span> +</div>
<div class="line">                           <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number(), 4) +</div>
<div class="line">                           <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">      data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classParticles_1_1DataOut.html">Particles::DataOut&lt;dim, dim&gt;</a> particle_out;</div>
<div class="line">      particle_out.<a class="code" href="classParticles_1_1DataOut.html#adf095165dc286310226584b2b9972701">build_patches</a>(</div>
<div class="line">        particle_handler,</div>
<div class="line">        std::vector&lt;std::string&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>),</div>
<div class="line">        std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;(</div>
<div class="line">          <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>));</div>
<div class="line"> </div>
<div class="line">      particle_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(</div>
<div class="line">        <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time(), <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number()));</div>
<div class="line"> </div>
<div class="line">      std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;particles-&quot;</span> +</div>
<div class="line">                           <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number(), 4) +</div>
<div class="line">                           <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">      particle_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">CathodeRaySimulator&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_cycles = 3;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0;</div>
<div class="line">         refinement_cycle &lt; n_pre_refinement_cycles;</div>
<div class="line">         ++refinement_cycle)</div>
<div class="line">      {</div>
<div class="line">        setup_system();</div>
<div class="line">        assemble_system();</div>
<div class="line">        solve_field();</div>
<div class="line">        refine_grid();</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    setup_system();</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number() + 1 &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Field degrees of freedom:                 &quot;</span></div>
<div class="line">                  &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_system();</div>
<div class="line">        solve_field();</div>
<div class="line"> </div>
<div class="line">        create_particles();</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Total number of particles in simulation:  &quot;</span></div>
<div class="line">                  &lt;&lt; particle_handler.n_global_particles() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        n_recently_lost_particles = 0;</div>
<div class="line">        update_timestep_size();</div>
<div class="line">        move_particles();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.advance_time();</div>
<div class="line"> </div>
<div class="line">        output_results();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Number of particles lost this time step:  &quot;</span></div>
<div class="line">                  &lt;&lt; n_recently_lost_particles &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">if</span> (n_total_lost_particles &gt; 0)</div>
<div class="line">          std::cout &lt;&lt; <span class="stringliteral">&quot;  Fraction of particles lost through anode: &quot;</span></div>
<div class="line">                    &lt;&lt; 1. * n_particles_lost_through_anode /</div>
<div class="line">                         n_total_lost_particles</div>
<div class="line">                    &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;  Now at t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;, dt=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_previous_step_size() &lt;&lt; <span class="charliteral">&#39;.&#39;</span></div>
<div class="line">                  &lt;&lt; std::endl</div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.is_at_end() == <span class="keyword">false</span>);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step19</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classStep19_1_1CathodeRaySimulator.html">Step19::CathodeRaySimulator&lt;2&gt;</a> cathode_ray_simulator_2d;</div>
<div class="line">      cathode_ray_simulator_2d.<a class="code" href="classStep19_1_1CathodeRaySimulator.html#acceda54ac84d5e31aa1ae329bd1a0381">run</a>();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><br  />
 This tutorial depends on <a class="el" href="step_6.html">step-6</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Timediscretization">Time discretization</a><a href="#Timediscretization">Time discretization</a>
        <li><a href="#Spatialdiscretization">Spatial discretization</a><a href="#Spatialdiscretization">Spatial discretization</a>
        <li><a href="#Dealingwithparticlesprogrammatically">Dealing with particles programmatically</a><a href="#Dealingwithparticlesprogrammatically">Dealing with particles programmatically</a>
        <li><a href="#Thetestcase">The test case</a><a href="#Thetestcase">The test case</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#Globaldefinitions">Global definitions</a><a href="#Globaldefinitions">Global definitions</a>
        <li><a href="#Themainclass">The main class</a><a href="#Themainclass">The main class</a>
        <li><a href="#ThecodeCathodeRaySimulatorcodeclassimplementation">The <code>CathodeRaySimulator</code> class implementation</a><a href="#ThecodeCathodeRaySimulatorcodeclassimplementation">The <code>CathodeRaySimulator</code> class implementation</a>
      <ul>
        <li><a href="#ThecodeCathodeRaySimulatorcodeconstructor">The <code>CathodeRaySimulator</code> constructor</a><a href="#ThecodeCathodeRaySimulatorcodeconstructor">The <code>CathodeRaySimulator</code> constructor</a>
        <li><a href="#ThecodeCathodeRaySimulatormake_gridcodefunction">The <code>CathodeRaySimulator::make_grid</code> function</a><a href="#ThecodeCathodeRaySimulatormake_gridcodefunction">The <code>CathodeRaySimulator::make_grid</code> function</a>
        <li><a href="#ThecodeCathodeRaySimulatorsetup_systemcodefunction">The <code>CathodeRaySimulator::setup_system</code> function</a><a href="#ThecodeCathodeRaySimulatorsetup_systemcodefunction">The <code>CathodeRaySimulator::setup_system</code> function</a>
        <li><a href="#ThecodeCathodeRaySimulatorassemble_systemcodefunction">The <code>CathodeRaySimulator::assemble_system</code> function</a><a href="#ThecodeCathodeRaySimulatorassemble_systemcodefunction">The <code>CathodeRaySimulator::assemble_system</code> function</a>
        <li><a href="#CathodeRaySimulatorsolve">CathodeRaySimulator::solve</a><a href="#CathodeRaySimulatorsolve">CathodeRaySimulator::solve</a>
        <li><a href="#CathodeRaySimulatorrefine_grid">CathodeRaySimulator::refine_grid</a><a href="#CathodeRaySimulatorrefine_grid">CathodeRaySimulator::refine_grid</a>
        <li><a href="#CathodeRaySimulatorcreate_particles">CathodeRaySimulator::create_particles</a><a href="#CathodeRaySimulatorcreate_particles">CathodeRaySimulator::create_particles</a>
        <li><a href="#CathodeRaySimulatormove_particles">CathodeRaySimulator::move_particles</a><a href="#CathodeRaySimulatormove_particles">CathodeRaySimulator::move_particles</a>
        <li><a href="#CathodeRaySimulatortrack_lost_particle">CathodeRaySimulator::track_lost_particle</a><a href="#CathodeRaySimulatortrack_lost_particle">CathodeRaySimulator::track_lost_particle</a>
        <li><a href="#CathodeRaySimulatorupdate_timestep_size">CathodeRaySimulator::update_timestep_size</a><a href="#CathodeRaySimulatorupdate_timestep_size">CathodeRaySimulator::update_timestep_size</a>
        <li><a href="#ThecodeCathodeRaySimulatoroutput_resultscodefunction">The <code>CathodeRaySimulator::output_results()</code> function</a><a href="#ThecodeCathodeRaySimulatoroutput_resultscodefunction">The <code>CathodeRaySimulator::output_results()</code> function</a>
        <li><a href="#CathodeRaySimulatorrun">CathodeRaySimulator::run</a><a href="#CathodeRaySimulatorrun">CathodeRaySimulator::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
      <ul>
        <li><a href="#Avoidingaperformancebottleneckwithparticles"> Avoiding a performance bottleneck with particles </a><a href="#Avoidingaperformancebottleneckwithparticles"> Avoiding a performance bottleneck with particles </a>
        <li><a href="#Morestatisticsaboutelectrons"> More statistics about electrons </a><a href="#Morestatisticsaboutelectrons"> More statistics about electrons </a>
        <li><a href="#Abettersynchronizedvisualization"> A better-synchronized visualization </a><a href="#Abettersynchronizedvisualization"> A better-synchronized visualization </a>
        <li><a href="#Abettertimeintegrator"> A better time integrator </a><a href="#Abettertimeintegrator"> A better time integrator </a>
        <li><a href="#Parallelization"> Parallelization </a><a href="#Parallelization"> Parallelization </a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 </p><pre class="fragment">&lt;br&gt;  
</pre><p> <em> This program was contributed by Wolfgang Bangerth, Rene Gassmoeller, and Peter Munch.</em></p>
<p><em>Wolfgang Bangerth acknowledges support through NSF awards DMS-1821210, EAR-1550901, and OAC-1835673. </em> </p><dl class="section note"><dt>Note</dt><dd>Support for particles exists in deal.II primarily due to the initial efforts of Rene Gassmoeller. Please acknowledge this work by citing the publication <b>[GLHPW2018]</b> if you use particle functionality in your own work. <a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a><h1>Introduction</h1>
</dd></dl>
<p>The finite element method in general, and deal.II in particular, were inventedto solve partial differential equations</p>
<ul>
<li>in other words, to solve<a href="https://en.wikipedia.org/wiki/Continuum_mechanics">continuum mechanics</a> problems.On the other hand, sometimes one wants to solve problems in which it is usefulto track individual objects ("particles") and how their positions evolve. Ifthis simply leads to a set of ordinary differential equations, for exampleif you want to track the positions of the planets in the solar system overtime, then deal.II is clearly not your right tool. On the other hand, ifthis evolution is due to the interaction with the solution of partial differentialequation, or if having a mesh to determine which particles interactwith others (such as in the<a href="https://en.wikipedia.org/wiki/Smoothed-particle_hydrodynamics">smoothed particle hydrodynamics (SPH)</a>method), then deal.II has support for you. The case we will consider here is how electrically charged particles move throughan electric field. As motivation, we will consider<a href="https://en.wikipedia.org/wiki/Cathode_ray">cathode rays</a>: Electrons emitted by aheated piece of metal that is negatively charged (the "cathode"), and that arethen accelerated by an electric field towards the positively charged electrode(the "anode"). The anode is typically ring-shaped so that the majority ofelectrons can fly through the hole in the form of an electron beam. In the oldentimes, they might then have illuminated the screen of a TV built from a<a href="https://en.wikipedia.org/wiki/Cathode-ray_tube">cathode ray tube</a>.Today, instead, electron beams are useful in<a href="https://en.wikipedia.org/wiki/X-ray_tube">X-ray machines</a>,<a href="https://en.wikipedia.org/wiki/Electron-beam_lithography">electron beam lithography</a>,<a href="https://en.wikipedia.org/wiki/Electron-beam_welding">electron beam welding</a>, anda number of other areas. The equations we will then consider are as follows: First, we need to describethe electric field. This is most easily accomplished by noting that the electricpotential \(V\) satisfied the equation <p class="formulaDsp">
\[ -\epsilon_0 \Delta V = \rho \]
</p>
@_fakenlwhere \(\epsilon_0\) is the dielectric constant of vacuum, and \(\rho\) is the chargedensity. This is augmented by boundary conditions that we will choose as follows: <p class="formulaDsp">
\begin{align*} V &amp;= -V_0 &amp;&amp; \text{on}\; \Gamma_\text{cathode}\subset\partial\Omega \\ V &amp;= +V_0 &amp;&amp; \text{on}\; \Gamma_\text{anode}\subset\partial\Omega \\ \epsilon\frac{\partial V}{\partial n} &amp;= 0 &amp;&amp; \text{on}\; \partial\Omega\setminus\Gamma_\text{cathode}\setminus\Gamma_\text{anode}. \end{align*}
</p>
 In other words, we prescribe voltages \(+V_0\) and \(-V_0\) at the two electrodesand insulating (Neumann) boundary conditions elsewhere. Since the dynamics of theparticles are purely due to the electric field \(\mathbf E=\nabla V\) , we couldas well have prescribed \(2V_0\) and \(0\) at the two electrodes</li>
<li>all that mattersis the voltage difference at the two electrodes. Given this electric potential \(V\) and the electric field \(\mathbf E=\nabla V\) ,we can describe the trajectory of the \(i\) th particle using the differentialequation <p class="formulaDsp">
\[ m {\ddot {\mathbf x}}_i = e\mathbf E, \]
</p>
@_fakenlwhere \(m,e\) are the mass and electric charge of each particle. In practice, itis convenient to write this as a system of first-order differential equationsin the position \(\mathbf x\) and velocity \(\mathbf v\) : <p class="formulaDsp">
\begin{align*} {\dot {\mathbf v}}_i &amp;= \frac{e\mathbf E}{m}, \\ {\dot {\mathbf x}}_i &amp;= {\mathbf v}_i. \end{align*}
</p>
 The deal.II class we will use to deal with particles, <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a>, stores particles in a way so that the position \(\mathbf x_i\) is part of the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> data structures. (It stores particles sortedby cell they are in, and consequently needs to know where each particle is.)The velocity \(\mathbf v_i\) , on the other hand, is of no concern to <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> and consequently we will store it as a"property" of each particle that we will update in each time step. Propertiescan also be used to store any other quantity we might care about each particle:its charge, or if they were larger than just an electron, its color, mass,attitude in space, chemical composition, etc. There remain two things to discuss to complete the model:Where particles start and what the charge density \(\rho\) is. First, historically, cathode rays used very large electric fields to pullelectrons out of the metal. This produces only a relatively small current. Onecan do better by heating the cathode: a statistical fraction of electrons in thatcase have enough thermal energy to leave the metal; the electric field then justhas to be strong enough to pull them away from the attraction of their hostbody. We will model this in the following way: We will create a new particle if(i) the electric field points away from the electrode, i.e., if \(\mathbf E \cdot \mathbf n &lt; 0\) where \(\mathbf n\) is the normal vector at aface pointing out of the domain (into the electrode), and (ii) the electricfield exceeds a threshold value \(|\mathbf E|\ge E_\text{threshold}\) . This issurely not a sufficiently accurate model for what really happens, but is goodenough for our current tutorial program. Second, in principle we would have to model the charge density via <p class="formulaDsp">
\[ \rho(\mathbf x) = \sum_i e\delta(\mathbf x-\mathbf x_i). \]
</p>
 <dl class="section note"><dt>Note</dt><dd>The issue now is that in reality, a cathode ray tube in an old televisionyields a current of somewhere around a few milli-Amperes. In the much higherenergy beams of particle accelerators, the current may only be a fewnano-Ampere. But an Ampere is \(6\times 10^{18}\) electrons flowing persecond. Now, as you will see in the results section, we really only simulatea few microseconds ( \(10^{-5}\) seconds), but that still results in very verylarge numbers of electrons</dd></dl>
</li>
<li>far more than we can hope to simulatewith a program as small as the current one. As a consequence, let uspresume that each particle represents \(N\) electrons. Then the particlemass and charge are also \(Nm\) and \(Ne\) and the equations we have tosolve are <p class="formulaDsp">
\[ (Nm) {\ddot {\mathbf x}}_i = (Ne)\mathbf E, \]
</p>
@_fakenlwhich is of course exactly the same as above. On the other hand, the chargedensity for these "clumps" of electrons is given by <p class="formulaDsp">
\[ \rho(\mathbf x) = \sum_i (Ne)\delta(\mathbf x-\mathbf x_i). \]
</p>
@_fakenlIt is this form that we will implement in the program, where \(N\) is chosenrather large in the program to ensure that the particles actually affectthe electric field. (This may not be realistic in practice: In most cases,there are just not enough electrons to actually affect the overallelectric field. But realism is not our goal here.)</li>
</ul>
<pre class="fragment">@note   One may wonder why the equation for the electric field (or, rather,the electric potential) has no time derivative whereas the equations forthe electron positions do. In essence, this is a modeling assumption: Weassume that the particles move so slowly that at any given time theelectric field is in equilibrium. This is saying, in other words, thatthe velocity of the electrons is much less than the speed of light. Inyet other words, we can rephrase this in terms of the electrode voltage  @f$V_0@f$  : Since every volt of electric potential accelerates electrons byapproximately 600 km/s (neglecting relativistic effects), requiring  @f$|\mathbf v_i\|\ll c@f$   is equivalent to saying that   @f$2V_0 \ll 500 \text{V}@f$  .Under this assumption (and the assumption that the total numberof electrons is small), one can also neglect the creation ofmagnetic fields by the moving charges, which would otherwise also affectthe movement of the electrons.
</pre><p><a class="anchor" id="Timediscretization"></a></p><h3>Time discretization</h3>
<p>The equations outlined above form a set of coupled differential equations.Let us bring them all together in one place again to make that clear: </p><p class="formulaDsp">
\begin{align*} -\epsilon_0 \Delta V &amp;= \sum_i e\delta(\mathbf x-\mathbf x_i) \\ {\dot {\mathbf x}}_i &amp;= {\mathbf v}_i, \\ {\dot {\mathbf v}}_i &amp;= \frac{e\mathbf E}{m} = \frac{e\mathbf \nabla V}{m}. \end{align*}
</p>
<p> Because of the awkward dependence of the electric potential on theparticle locations, we don't want to solve this as a coupled systembut instead use a decoupled approach where we first solve for thepotential in each time step and then the particle locations. (Onecould also do it the other way around, of course.) This is verymuch in the same spirit as we do in <a class="el" href="step_21.html">step-21</a> , <a class="el" href="step_31.html">step-31</a> , and <a class="el" href="step_32.html">step-32</a> ,to name just a few, and can all be understood in the context ofthe operator splitting methods discussed in <a class="el" href="step_58.html">step-58</a> . So, if we denote by an upper index \(n\) the time step, and if weuse a simple time discretization for the ODE, then this meansthat we have to solve the following set of equations in each timestep: </p><p class="formulaDsp">
\begin{align*} -\epsilon_0 \Delta V^{(n)} &amp;= \sum_i e\delta(\mathbf x-\mathbf x_i^{(n-1)}) \\ \frac{{\mathbf v}_i^{(n)}-{\mathbf v}_i^{(n-1)}}{\Delta t} &amp;= \frac{e\nabla V^{(n)}}{m} \\ \frac{{\mathbf x}_i^{(n)}-{\mathbf x}_i^{(n-1)}}{\Delta t} &amp;= {\mathbf v}_i^{(n)}. \end{align*}
</p>
<p> There are of course many better ways to do a time discretization (forexample the simple <a href="https://en.wikipedia.org/wiki/Leapfrog_integration">leapfrog scheme</a>)but this isn't the point of the tutorial program, and so we will be contentwith what we have here. (We will comment on a piece of this puzzle in the<a href="#extensions">possibilities for extensions</a> section of this program,however.) There remains the question of how we should choose the time step size \(\Delta t\) .The limitation here is that the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class needs tokeep track of which cell each particle is in. This is particularly an issue ifwe are running computations in parallel (say, in <a class="el" href="step_70.html">step-70</a> ) because in that caseevery process only stores those cells it owns plus one layer of "ghost cells".That's not relevant here, but in general we should make sure that over thecourse of each time step, a particle moves only from one cell to anyof its immediate neighbors (face, edge, or vertex neighbors). If we can ensurethat, then <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> is guaranteed to be able to figure outwhich cell a particle ends up in. To do this, a useful rule of thumbis that we should choose the time step so that for all particles the expecteddistance the particle moves by is less than one cell diameter: </p><p class="formulaDsp">
\[ \Delta t \le \frac{h_i}{\|\mathbf v_i\|} \qquad\qquad \forall i, \]
</p>
<p>@_fakenlor equivalently </p><p class="formulaDsp">
\[ \Delta t \le \min_i \frac{h_i}{\|\mathbf v_i\|}. \]
</p>
<p>@_fakenlHere, \(h_i\) is the length of the shortest edge of the cell on which particle \(i\) is located</p>
<ul>
<li>in essence, a measure of the size of a cell. On the other hand, a particle might already be at the boundary of one celland the neighboring cell might be once further refined. So then the time tocross thatneighboring* cell would actually be half the amount above,suggesting <p class="formulaDsp">
\[ \Delta t \le \min_i \frac{\tfrac 12 h_i}{\|\mathbf v_i\|}. \]
</p>
 But even that is not good enough: The formula above updates the particlepositions in each time using the formula <p class="formulaDsp">
\[ \frac{{\mathbf x}_i^{(n)}-{\mathbf x}_i^{(n-1)}}{\Delta t} = {\mathbf v}_i^{(n)}, \]
</p>
@_fakenlthat is, using thecurrent* velocity \({\mathbf v}_i^{n}\) . But we don't havethe current velocity yet at the time when we need to choose \(\Delta t\)</li>
<li>whichis after we have updated the potential \(V^{(n)}\) but before we update thevelocity from \({\mathbf v}_i^{(n-1)}\) to \({\mathbf v}_i^{(n)}\) . All we have is \({\mathbf v}_i^{(n-1)}\) . So we need an additional safety factor for our finalchoice: <p class="formulaDsp">
\[ \Delta t^{(n)} = c_\text{safety} \min_i \frac{\tfrac 12 h_i}{\|\mathbf v_i^{(n-1)}\|}. \]
</p>
@_fakenlHow large should \(c_\text{safety}\) be? That depends on how much of underestimate \(\|\mathbf v_i^{(n-1)}\|\) might be compared to \(\|\mathbf v_i^{(n)}\|\) , and thatis actually quite easy to assess: A particle created in one time step withzero velocity will roughly pick up equal velocity increments in each successivetime step if the electric field it encounters along the way were roughlyconstant. So the maximal difference between \(\|\mathbf v_i^{(n-1)}\|\) and \(\|\mathbf v_i^{(n)}\|\) would be a factor of two. As a consequence,we will choose \(c_\text{safety}=0.5\) . There is only one other case we ought to consider: What happens inthe very first time step? There, any particles to be moved along have justbeen created, but they have a zero velocity. So we don't know whatvelocity we should choose for them. Of course, in all other time stepsthere are also particles that have just been created, but in general,the particles with the highest velocity limit the time step size and so thenewly created particles with their zero velocity don't matter. But if weonly* have such particles? In that case, we can use the following approximation: If a particlestarts at \(\mathbf v^{(0)}=0\) , then the update formula tells us that <p class="formulaDsp">
\[ {\mathbf v}_i^{(1)} = \frac{e\nabla V^{(1)}}{m} \Delta t, \]
</p>
@_fakenland consequently <p class="formulaDsp">
\[ \frac{{\mathbf x}_i^{(1)}-{\mathbf x}_i^{(0)}}{\Delta t} = {\mathbf v}_i^{(1)}, \]
</p>
@_fakenlwhich we can write as <p class="formulaDsp">
\[ {\mathbf x}_i^{(1)} - {\mathbf x}_i^{(0)} = \frac{e\nabla V^{(1)}}{m} \Delta t^2. \]
</p>
@_fakenlNot wanting to move a particle by more than \(\frac 12 h_i\) then implies that we shouldchoose the time step as <p class="formulaDsp">
\[ \Delta t \le \min_i \sqrt{ \frac{h_i m}{e \|\nabla V^{(1)}\| }}. \]
</p>
@_fakenlUsing the same argument about neighboring cells possibly being smaller bya factor of two then leads to the final formula for time step zero: <p class="formulaDsp">
\[ \Delta t = \min_i \sqrt{ \frac{\frac 12 h_i m}{e \|\nabla V^{(1)}\| } }. \]
</p>
 Strictly speaking, we would have to evaluate the electric potential \(V^{(1)}\) atthe location of each particle, but a good enough approximation is to use themaximum of the values at the vertices of the respective cell. (Why the verticesand not the midpoint? Because the gradient of the solution of the Laplace equation,i.e., the electric field, is largest in corner singularities which are locatedat the vertices of cells.) This has the advantage that we can make good use of theFEValues functionality which can recycle pre-computed material as long as thequadrature points are the same from one cell to the next. We could always run this kind of scheme to estimate the difference between \(\mathbf v_i^{(n-1)}\) and \(\mathbf v_i^{(n)}\) , but it relies on evaluating theelectric field \(\mathbf E\) on each cell, and that is expensive. As aconsequence, we will limit this approach to the very first time step.</li>
</ul>
<p><a class="anchor" id="Spatialdiscretization"></a></p><h3>Spatial discretization</h3>
<p>Having discussed the time discretization, the discussion of the spatialdiscretization is going to be short: We use quadratic finite elements,i.e., the space \(Q_2\) , to approximate the electric potential \(V\) . Themesh is adapted a couple of times during the initial time step. Allof this is entirely standard if you have read <a class="el" href="step_6.html">step-6</a> , and the implementationdoes not provide for any kind of surprise.</p>
<p><a class="anchor" id="Dealingwithparticlesprogrammatically"></a></p><h3>Dealing with particles programmatically</h3>
<p>Adding and moving particles is, in practice, not very difficult in deal.II.To add one, the <code>create_particles()</code> function of this program simplyuses a code snippet of the following form: </p><div class="fragment"><div class="line"><a class="code" href="classParticles_1_1Particle.html">Particles::Particle&lt;dim&gt;</a> new_particle;</div>
<div class="line">new_particle.<a class="code" href="classParticles_1_1Particle.html#afbe52b594cf4a8dd11431679c4ef2b52">set_location</a>(<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>);</div>
<div class="line">new_particle.<a class="code" href="classParticles_1_1Particle.html#a57efa2034baca617ba3160ccfbbc7cd7">set_reference_location</a></div>
<div class="line">    (<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>.transform_real_to_unit_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>));</div>
<div class="line">new_particle.<a class="code" href="classParticles_1_1Particle.html#af792bce47ec4746ad2c78e7e800299a8">set_id</a>(n_current_particles);</div>
<div class="line"> </div>
<div class="line">particle_handler.insert_particle(new_particle, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
</div><!-- fragment --><p> In other words, it is not all that different from inserting an objectinto a <code>std::set</code> or <code>std::map</code>: Create the object, set its properties(here, the current location, its reference cell location, and its id)and call <code>insert_particle</code>. The only thing that may be surprising isthe reference location: In order to evaluate things such as \(\nabla V(\mathbf x_i)\) , it is necessary to evaluate finite elementfields at locations \(\mathbf x_i\) . But this requires evaluating thefinite element shape functions at points on the reference cell \(\hat{\mathbf x}_i\) . To make this efficient, every particle doesn'tjust store its location and the cell it is on, but also what locationthat point corresponds to in the cell's reference coordinate system. Updating a particle's position is then no more difficult: One just hasto call </p><div class="fragment"><div class="line"><a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_location(new_location);</div>
</div><!-- fragment --><p> We do this in the <code>move_particles()</code> function. The only differenceis that we then have to tell the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> classto also find what cell that position corresponds to (and, when computingin parallel, which process owns this cell). For efficiency reason,this is most easily done after updating all particles' locations,and is achieved via the <a class="el" href="classParticles_1_1ParticleHandler.html#ad817e16828f2355b0cad6fef8db7df81">Particles::ParticleHandler::sort_particles_into_subdomains_and_cells()</a> function. There are, of course, times where a particle may leave the domain inquestion. In that case, <a class="el" href="classParticles_1_1ParticleHandler.html#ad817e16828f2355b0cad6fef8db7df81">Particles::ParticleHandler::sort_particles_into_subdomains_and_cells()</a> can not find a surrounding cell and simply deletes the particle. But, itis often useful to track the number of particles that have been lostthis way, and for this the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class offers a"signal" that one can attach to. We show how to do this in theconstructor of the main class to count how many particles were lostin each time step. Specifically, the way this works is thatthe <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class has a "signal" to which onecan attach a function that will be executed whenever the signalis triggered. Here, this looks as follows: </p><div class="fragment"><div class="line">particle_handler.signals.particle_lost.connect(</div>
<div class="line">  [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">         <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">  {</div>
<div class="line">    this-&gt;track_lost_particle(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">  });</div>
</div><!-- fragment --><p> That's a bit of a mouthful, but what's happening is this: We declarea lambda function that "captures" the <code>this</code> pointer (so that we can accessmember functions of the surrounding object inside the lambda function), andthat takes two arguments:</p>
<ul>
<li>A reference to the particle that has been "lost".</li>
<li>A reference to the cell it was on last.The lambda function then simply calls the <code>CathodeRaySimulator::track_lost_particle</code> function with these arguments. When we attach this lambda function to thesignal, the <a class="el" href="classParticles_1_1ParticleHandler.html#ad817e16828f2355b0cad6fef8db7df81">Particles::ParticleHandler::sort_particles_into_subdomains_and_cells()</a> function will trigger the signal for every particle for which it can'tfind a new home. This gives us the chance to record where the particleis, and to record statistics on it.</li>
</ul>
<pre class="fragment">@note   In this tutorial program, we insert particles by hand and at  locations we specifically choose based on conditions that include  the solution of the electrostatic problem. But there are other cases  where one primarily wants to use particles as passive objects, for  example to trace and visualize the flow field of a fluid flow  problem. In those cases, there are numerous functions in the    Particles::Generators   namespace that can generate particles  automatically. One of the functions of this namespace is also used  in the   @ref step_70 "step-70"   tutorial program, for example.
</pre><p><a class="anchor" id="Thetestcase"></a></p><h3>The test case</h3>
<p align="center">The test case here is not meant to be a realistic depiction of a cathoderay tube, but it has the right general characteristics and the point is,in any case, only to demonstrate how one would implement deal.II codesthat use particles. The following picture shows the geometry that we're going to use: </p>
<p><img src="https://www.dealii.org/images/steps/developer/step-19.geometry.png" alt="The geometry used in this program" width="600" class="inline"/> </p>
<p><br  />
 In this picture, the parts of the boundary marked in red and blue are thecathode, held at an electric potential \(V=-V_0\) . The part of the cathode shownin red is the part that is heated, leading to electrons leaving the metaland then being accelerated by the electric field (a few electricfield lines are also shown). The green part of the boundary is the anode,held at \(V=+V_0\) . The rest of the boundary satisfies a Neumann boundarycondition. This setup mimics real devices. The re-entrant corner results in anelectric potential \(V\) whose derivative (the electric field \(\mathbf E\) )has a singularity</p>
<ul>
<li>in other words, it becomes very large in the vicinityof the corner, allowing it to rip electrons away from the metal. Theseelectrons are then accelerated towards the (green) anode which has ahole in the middle through which the electrons can escape the device andfly on to hit the screen, where they excite the "phosphor" to then emitthe light that we see from these old-style TV screens. The non-heatedpart of the cathode is not subjectto the emission of electrons</li>
<li>in the code, we will mark this as the"focussing element" of the tube, because its negative electric voltagerepels the electrons and makes sure that they do not just flyaway from the heated part of the cathode perpendicular to the boundary,but in fact bend their paths towards the anode on the right. The electric field lines also shown in the picture illustratethat the electric field connects the negative and positiveelectrodes, respectively. The accelerating force the electronsexperience is along these field lines. Finally, the picture shows themesh used in the computation, illustrating that there aresingularities at the tip of the re-rentrant corner as wellas at all places where the boundary conditions change; thesesingularities are visible because the mesh is refined in theselocations. Of practical interest is to figure out which fraction of theelectrons emitted from the cathode actually make it through thehole in the anode</li>
<li>electrons that just bounce into the anodeitself are not actually doing anything useful other than convertingelectricity into heat. As a consequence, in the <code>track_lost_particle()</code>function (which is called for each particle that leaves the domain,see above), we will estimate where it might have left the domainand report this in the output.</li>
</ul>
<pre class="fragment">@note   It is worth repeating that neither the geometry used here,nor in fact any other aspect of this program is intended to representanything even half-way realistic. Tutorial programs are our tools toteach how deal.II works, and we often use situations for which wehave some kind of intuition since this helps us interpret the outputof a program, but that's about the extent to which we intend theprogram to do anything of use besides being a teaching tool.
</pre><p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The majority of the include files used in this program are well known from <a class="el" href="step_6.html">step-6</a> and similar programs:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__free_2fe__point__evaluation_8h.html">deal.II/matrix_free/fe_point_evaluation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
</div><!-- fragment --><p>The ones that are new are only the following three: The first declares the <a class="el" href="classDiscreteTime.html">DiscreteTime</a> class that helps us keep track of time in a time-dependent simulation. The latter two provide all of the particle functionality, namely a way to keep track of particles located on a mesh (the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class) and the ability to output these particles' locations and their properties for the purposes of visualization (the <a class="el" href="classParticles_1_1DataOut.html">Particles::DataOut</a> class).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2discrete__time_8h.html">deal.II/base/discrete_time.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="particles_2particle__handler_8h.html">deal.II/particles/particle_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="particles_2data__out_8h.html">deal.II/particles/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Globaldefinitions"></a> </p><h3>Global definitions</h3>
<p>As is customary, we put everything that corresponds to the details of the program into a namespace of its own. At the top, we define a few constants for which we would rather use symbolic names than hard-coded numbers.</p>
<p>Specifically, we define numbers for <a class="el" href="DEALGlossary.html#GlossBoundaryIndicator">boundary indicators</a> for the various parts of the geometry, as well as the physical properties of electrons and other specifics of the setup we use here.</p>
<p>For the boundary indicators, let us start enumerating at some random value 101. The principle here is to use numbers that areuncommon*. If there are pre-defined boundary indicators previously set by the <code><a class="el" href="namespaceGridGenerator.html">GridGenerator</a></code> functions, they will likely be small integers starting from zero, but not in this rather randomly chosen range. Using numbers such as those below avoids the possibility for conflicts, and also reduces the temptation to just spell these numbers out in the program (because you will probably never remember which is which, whereas you might have been tempted if they had started at 0).</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep19.html">Step19</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">namespace </span>BoundaryIds</div>
<div class="line">  {</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#ad34dd0ea81c30b8db904e23d54e1b323">open</a>          = 101;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">cathode</a>       = 102;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">focus_element</a> = 103;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>         = 104;</div>
<div class="line">  } <span class="comment">// namespace BoundaryIds</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>Constants</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">electron_mass</a>   = 9.1093837015e-31;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">electron_charge</a> = 1.602176634e-19;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">V0</a> = 1;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">E_threshold</a> = 0.05;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">electrons_per_particle</a> = 3e15;</div>
<div class="line">  } <span class="comment">// namespace Constants</span></div>
</div><!-- fragment --><p><a class="anchor" id="Themainclass"></a> </p><h3>The main class</h3>
<p>The following is then the main class of this program. It has, fundamentally, the same structure as <a class="el" href="step_6.html">step-6</a> and many other tutorial programs. This includes the majority of the member functions (with the purpose of the rest probably self-explanatory from their names) as well as only a small number of member variables beyond those of <a class="el" href="step_6.html">step-6</a> , all of which are related to dealing with particles.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>CathodeRaySimulator</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  CathodeRaySimulator();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">  <span class="keywordtype">void</span> setup_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">  <span class="keywordtype">void</span> solve_field();</div>
<div class="line">  <span class="keywordtype">void</span> refine_grid();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> create_particles();</div>
<div class="line">  <span class="keywordtype">void</span> move_particles();</div>
<div class="line">  <span class="keywordtype">void</span> track_lost_particle(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> update_timestep_size();</div>
<div class="line">  <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler&lt;dim&gt;</a> particle_handler;</div>
<div class="line">  <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           next_unused_particle_id;</div>
<div class="line">  <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_recently_lost_particles;</div>
<div class="line">  <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_total_lost_particles;</div>
<div class="line">  <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_particles_lost_through_anode;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDiscreteTime.html">DiscreteTime</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatorcodeclassimplementation"></a> </p><h3>The <code>CathodeRaySimulator</code> class implementation</h3>
<pre class="fragment">&lt;a name="ThecodeCathodeRaySimulatorcodeconstructor"&gt;&lt;/a&gt;  &lt;h4&gt;The &lt;code&gt;CathodeRaySimulator&lt;/code&gt; constructor&lt;/h4&gt;
</pre><p>So then let us get started on the implementation. What the constructor does is really only a straight-forward initialization of all of the member variables at the top. The only two worth mentioning are the <code>particle_handler</code>, which is handed a reference to the triangulation on which the particles will live (currently of course still empty, but the particle handler stores the reference and will use it once particles are added</p>
<ul>
<li>which happens after the triangulation is built). The other piece of information it gets is how many "properties" each particle needs to store. Here, all we need each particle to remember is its current velocity, i.e., a vector with <code>dim</code> components. There are, however, other intrinsic properties that each particle has and that the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> class automatically and always makes sure are available; in particular, these are the current location of a particle, the cell it is on, it's reference location within that cell, and the particle's ID. <br  />
 The only other variable of interest is <code>time</code>, an object of type <a class="el" href="classDiscreteTime.html">DiscreteTime</a>. It keeps track of the current time we are in a time-dependent simulation, and is initialized with the start time (zero) and end time ( \(10^{-4}\) ). We will later set the time step size in <code>update_timestep_size()</code>. <br  />
 The body of the constructor consists of a piece of code we have already discussed in the introduction. Namely, we make sure that the <code>track_lost_particle()</code> function is called by the <code>particle_handler</code> object every time a particle leaves the domain.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">CathodeRaySimulator&lt;dim&gt;::CathodeRaySimulator()</div>
<div class="line">  : <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1)</div>
<div class="line">  , <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(2)</div>
<div class="line">  , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  , particle_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>,  <span class="comment">/*n_properties=*/</span> <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)</div>
<div class="line">  , next_unused_particle_id(0)</div>
<div class="line">  , n_recently_lost_particles(0)</div>
<div class="line">  , n_total_lost_particles(0)</div>
<div class="line">  , n_particles_lost_through_anode(0)</div>
<div class="line">  , <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>(0, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4)</div>
<div class="line">{</div>
<div class="line">  particle_handler.signals.particle_lost.connect(</div>
<div class="line">    [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">           <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) {</div>
<div class="line">      this-&gt;track_lost_particle(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    });</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatormake_gridcodefunction"></a> </p><h4>The <code>CathodeRaySimulator::make_grid</code> function</h4>
<p align="center">The next function is then responsible for generating the mesh on which we want to solve. Recall how the domain looks like: </p>
<p><img src="https://www.dealii.org/images/steps/developer/step-19.geometry.png" alt="The geometry used in this program" width="600" class="inline"/> </p>
<p>We subdivide this geometry into a mesh of \(4\times 2\) cells that looks like this: </p><div class="CodeFragmentInTutorialComment"></div><div class="CodeFragmentInTutorialComment"><div class="fragment"><div class="line">---*---*---*---*</div>
<div class="line">   \   |   |   |   |</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">--*---*---*---*</div>
<div class="line">   /   |   |   |   |</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">---*---*---*---*</div>
</div><!-- fragment --></div><div class="CodeFragmentInTutorialComment"> </div><p> The way this is done is by first defining where the \(15=5\times 3\) vertices are located</p>
<ul>
<li>here, we say that they are on integer points with the middle one on the left side moved to the right by a value of <code>delta=0.5</code>. <br  />
 In the following, we then have to say which vertices together form the 8 cells. The following code is then entirely equivalent to what we also do in <a class="el" href="step_14.html">step-14</a> :</li>
</ul>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">CathodeRaySimulator&lt;dim&gt;::make_grid</a>()</div>
<div class="line">   {</div>
<div class="line">     static_assert(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2,</div>
<div class="line">                   <span class="stringliteral">&quot;This function is currently only implemented for 2d.&quot;</span>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>       delta = 0.5;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nx    = 5;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ny    = 3;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;Point&lt;dim&gt;&gt; <a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a> </div>
<div class="line">       = {{0, 0},</div>
<div class="line">          {1, 0},</div>
<div class="line">          {2, 0},</div>
<div class="line">          {3, 0},</div>
<div class="line">          {4, 0},</div>
<div class="line">          {delta, 1},</div>
<div class="line">          {1, 1},</div>
<div class="line">          {2, 1},</div>
<div class="line">          {3, 1},</div>
<div class="line">          {4, 1},</div>
<div class="line">          {0, 2},</div>
<div class="line">          {1, 2},</div>
<div class="line">          {2, 2},</div>
<div class="line">          {3, 2},</div>
<div class="line">          {4, 2}};</div>
<div class="line">     <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(<a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a>.size(), nx ny);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;unsigned int&gt; cell_vertices[(nx</div>
<div class="line">  </div>
<div class="line">- 1) (ny</div>
<div class="line">  </div>
<div class="line">- 1)] = {</div>
<div class="line">       {0, 1, nx + 0, nx + 1},</div>
<div class="line">       {1, 2, nx + 1, nx + 2},</div>
<div class="line">       {2, 3, nx + 2, nx + 3},</div>
<div class="line">       {3, 4, nx + 3, nx + 4},</div>
<div class="line">  </div>
<div class="line">       {5, nx + 1, 2 nx + 0, 2 nx + 1},</div>
<div class="line">       {nx + 1, nx + 2, 2 nx + 1, 2 nx + 2},</div>
<div class="line">       {nx + 2, nx + 3, 2 nx + 2, 2 nx + 3},</div>
<div class="line">       {nx + 3, nx + 4, 2 nx + 3, 2 nx + 4}};</div>
</div><!-- fragment --><p>With these arrays out of the way, we can move to slightly higher higher-level data structures. We create a vector of <a class="el" href="structCellData.html">CellData</a> objects that store for each cell to be created the vertices in question as well as the <a class="el" href="DEALGlossary.html#GlossMaterialId">material id</a> (which we will here simply set to zero since we don't use it in the program). <br  />
 This information is then handed to the <a class="el" href="classTriangulation.html#ab2eeef6a38fa053814433870a9c35a0c">Triangulation::create_triangulation()</a> function, and the mesh is twice globally refined.</p>
<div class="fragment"><div class="line">     std::vector&lt;CellData&lt;dim&gt;&gt; <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>((nx</div>
<div class="line">  </div>
<div class="line">- 1) (ny</div>
<div class="line">  </div>
<div class="line">- 1), <a class="code" href="structCellData.html">CellData&lt;dim&gt;</a>());</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">       {</div>
<div class="line">         <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>].vertices    = cell_vertices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>];</div>
<div class="line">         <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>].material_id = 0;</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.create_triangulation(</div>
<div class="line">       <a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a>,</div>
<div class="line">       <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>,</div>
<div class="line">       <a class="code" href="structSubCellData.html">SubCellData</a>()); <span class="comment">// No boundary information</span></div>
<div class="line">  </div>
<div class="line">     <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(2);</div>
</div><!-- fragment --><p>The remaining part of the function loops over all cells and their faces, and if a face is at the boundary determines which boundary indicator should be applied to it. The various conditions should make sense if you compare the code with the picture of the geometry above. <br  />
 Once done with this step, we refine the mesh once more globally.</p>
<div class="fragment"><div class="line">     <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">         <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">           {</div>
<div class="line">             <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &lt; 0.5) &amp;&amp;</div>
<div class="line">                 (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &lt; 2))</div>
<div class="line">               <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>);</div>
<div class="line">             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &lt; 2))</div>
<div class="line">               <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">BoundaryIds::focus_element</a>);</div>
<div class="line">             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 4</div>
<div class="line">  </div>
<div class="line">- 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12) &amp;&amp;</div>
<div class="line">                      ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &gt; 1.5) || (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &lt; 0.5)))</div>
<div class="line">               <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">BoundaryIds::anode</a>);</div>
<div class="line">             <span class="keywordflow">else</span></div>
<div class="line">               <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="function__restriction__0_8txt.html#a93564637b88550ce91447da5d5661dc2">BoundaryIds::open</a>);</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(1);</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatorsetup_systemcodefunction"></a> </p><h4>The <code>CathodeRaySimulator::setup_system</code> function</h4>
<p>The next function in this program deals with setting up the various objects related to solving the partial differential equations. It is in essence a copy of the corresponding function in <a class="el" href="step_6.html">step-6</a> and requires no further discussion.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::setup_system()</div>
<div class="line">   {</div>
<div class="line">     dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">     system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">     <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                              <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>,</div>
<div class="line">                                              <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                              <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">     <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                              <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">BoundaryIds::focus_element</a>,</div>
<div class="line">                                              <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                              <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">     <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                              <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">BoundaryIds::anode</a>,</div>
<div class="line">                                              <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                                +<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                              <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">     <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">     <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                     dsp,</div>
<div class="line">                                     <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                      <span class="comment">/*keep_constrained_dofs = */</span>  <span class="keyword">false</span>);</div>
<div class="line">     <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line">  </div>
<div class="line">     system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatorassemble_systemcodefunction"></a> </p><h4>The <code>CathodeRaySimulator::assemble_system</code> function</h4>
<p>The function that computes the matrix entries is again in essence a copy of the corresponding function in <a class="el" href="step_6.html">step-6</a> :</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::assemble_system()</div>
<div class="line">{</div>
<div class="line">  system_matrix = 0;</div>
<div class="line">  system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line">      cell_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.quadrature_point_indices())</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> : fe_values.dof_indices())</div>
<div class="line">              <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                (fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_index) <span class="comment">// grad phi_i(x_q)</span></div>
<div class="line">                 fe_values.shape_grad(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_index) <span class="comment">// grad phi_j(x_q)</span></div>
<div class="line">                 fe_values.JxW(q_index));           <span class="comment">// dx</span></div>
<div class="line">          }</div>
</div><!-- fragment --><p>The only interesting part of this function is how it forms the right hand side of the linear system. Recall that the right hand side of the PDE is </p><p class="formulaDsp">
\[ \sum_p (N e)\delta(\mathbf x-\mathbf x_p), \]
</p>
<p> where we have used \(p\) to index the particles here to avoid confusion with the shape function \(\varphi_i\) ; \(\mathbf x_p\) is the position of the \(p\) th particle. When multiplied by a test function \(\varphi_i\) and integrated over the domain results in a right hand side vector</p>
<p class="formulaDsp">
\begin{align*} F_i &amp;= \int_\Omega \varphi_i (\mathbf x)\left[ \sum_p (N e)\delta(\mathbf x-\mathbf x_p) \right] dx \\ &amp;= \sum_p (N e) \varphi_i(\mathbf x_p). \end{align*}
</p>
<p> Note that the final line no longer contains an integral, and consequently also no occurrence of \(dx\) which would require the appearance of the <code>JxW</code> symbol in our code. <br  />
 For a given cell \(K\) , this cell's contribution to the right hand side is then</p>
<p class="formulaDsp">
\begin{align*} F_i^K &amp;= \sum_{p, \mathbf x_p\in K} (N e) \varphi_i(\mathbf x_p), \end{align*}
</p>
<p> i.e., we only have to worry about those particles that are actually located on the current cell \(K\) . <br  />
 In practice, what we do here is the following: If there are any particles on the current cell, then we first obtain an iterator range pointing to the first particle of that cell as well as the particle past the last one on this cell (or the end iterator)</p>
<ul>
<li>i.e., a half-open range as is common for C++ functions. Knowing now the list of particles, we query their reference locations (with respect to the reference cell), evaluate the shape functions in these reference locations, and compute the force according to the formula above (without any FEValues::JxW). <br  />
</li>
</ul>
<pre class="fragment">@note   It is worth pointing out that calling the   Particles::ParticleHandler::particles_in_cell()   and   Particles::ParticleHandler::n_particles_in_cell()   functions is not very efficient on problems with a large number of particles. But it illustrates the easiest way to write this algorithm, and so we are willing to incur this cost for the moment for expository purposes. We discuss the issue in more detail in the &lt;a href="#extensions"&gt;"possibilities for extensions" section&lt;/a&gt; below, and use a better approach in   @ref step_70 "step-70"  , for example.
</pre><div class="fragment"><div class="line"><span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> : particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;reference_location =</div>
<div class="line">        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_reference_location();</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">        cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">          (<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFE__Poly.html#a9205cb50b9901b40adc7220dd92ded5c">shape_value</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, reference_location) <span class="comment">// phi_i(x_p)</span></div>
<div class="line">           (-<a class="code" href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">Constants::electrons_per_particle</a>   <span class="comment">// N</span></div>
<div class="line">            <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a>));          <span class="comment">// e</span></div>
<div class="line">    }</div>
</div><!-- fragment --><p>Finally, we can copy the contributions of this cell into the global matrix and right hand side vector:</p>
<div class="fragment"><div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>, cell_rhs, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, system_matrix, system_rhs);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorsolve"></a> </p><h4>CathodeRaySimulator::solve</h4>
<p>The function that solves the linear system is then again exactly as in <a class="el" href="step_6.html">step-6</a> :</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::solve_field()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(1000, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12);</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">  <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(system_matrix, 1.2);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorrefine_grid"></a> </p><h4>CathodeRaySimulator::refine_grid</h4>
<p>The final field-related function is the one that refines the grid. We will call it a number of times in the first time step to obtain a mesh that is well-adapted to the structure of the solution and, in particular, resolves the various singularities in the solution that are due to re-entrant corners and places where the boundary condition type changes. You might want to refer to <a class="el" href="step_6.html">step-6</a> again for more details:</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::refine_grid()</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(dof_handler,</div>
<div class="line">                                        <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt;(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div>
<div class="line">                                        {},</div>
<div class="line">                                        <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">                                        estimated_error_per_cell);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                     estimated_error_per_cell,</div>
<div class="line">                                                     0.1,</div>
<div class="line">                                                     0.03);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorcreate_particles"></a> </p><h4>CathodeRaySimulator::create_particles</h4>
<p>Let us now turn to the functions that deal with particles. The first one is about the creation of particles. As mentioned in the introduction, we want to create a particle at points of the cathode if the the electric field \(\mathbf E=\nabla V\) exceeds a certain threshold, i.e., if \(|\mathbf E| \ge E_\text{threshold}\) , and if furthermore the electric field points into the domain (i.e., if \(\mathbf E \cdot \mathbf n &lt; 0\) ). As is common in the finite element method, we evaluate fields (and their derivatives) at specific evaluation points; typically, these are "quadrature points", and so we create a "quadrature formula" that we will use to designate the points at which we want to evaluate the solution. Here, we will simply take <a class="el" href="classQMidpoint.html">QMidpoint</a> implying that we will only check the threshold condition at the midpoints of faces. We then use this to initialize an object of type <a class="el" href="classFEFaceValues.html">FEFaceValues</a> to evaluate the solution at these points. <br  />
 All of this will then be used in a loop over all cells, their faces, and specifically those faces that are at the boundary and, moreover, the cathode part of the boundary.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::create_particles()</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> fe_face_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                      <a class="code" href="classQMidpoint.html">QMidpoint</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt;(),</div>
<div class="line">                                      <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;Tensor&lt;1, dim&gt;&gt; solution_gradients(</div>
<div class="line">       fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">         <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">             (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>))</div>
<div class="line">           {</div>
<div class="line">             fe_face_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
</div><!-- fragment --><p>So we have found a face on the cathode. Next, we let the <a class="el" href="classFEFaceValues.html">FEFaceValues</a> object compute the gradient of the solution at each "quadrature" point, and extract the electric field vector from the gradient in the form of a <a class="el" href="classTensor.html">Tensor</a> variable through the methods discussed in the <a class="el" href="group__vector__valued.html">vector-valued problems</a> documentation module.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> electric_potential(0);</div>
<div class="line">fe_face_values[electric_potential].<a class="code" href="classFEValuesBase.html#ad1f4e0deb5d982e8172d82141c634a67">get_function_gradients</a>(</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, solution_gradients);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point :</div>
<div class="line">     fe_face_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> = solution_gradients[q_point];</div>
</div><!-- fragment --><p>Electrons can only escape the cathode if the electric field strength exceeds a threshold and, crucially, if the electric field pointsinto* the domain. Once we have that checked, we create a new <a class="el" href="classParticles_1_1Particle.html">Particles::Particle</a> object at this location and insert it into the <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a> object with a unique ID. <br  />
 The only thing that may be not obvious here is that we also associate with this particle the location in the reference coordinates of the cell we are currently on. This is done because we will in downstream functions compute quantities such as the electric field at the location of the particle (e.g., to compute the forces that act on it when updating its position in each time step). Evaluating a finite element field at arbitrary coordinates is quite an expensive operation because shape functions are really only defined on the reference cell, and so when asking for the electric field at an arbitrary point requires us first to determine what the reference coordinates of that point are. To avoid having to do this over and over, we determine these coordinates once and for all and then store these reference coordinates directly with the particle.</p>
<div class="fragment"><div class="line">      <span class="keywordflow">if</span> ((<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> fe_face_values.<a class="code" href="classFEValuesBase.html#ac25ec6835799c3b6c7c842f8acb05eb3">normal_vector</a>(q_point) &lt; 0) &amp;&amp;</div>
<div class="line">          (<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a>.norm() &gt; <a class="code" href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">Constants::E_threshold</a>))</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a> =</div>
<div class="line">            fe_face_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_point);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classParticles_1_1Particle.html">Particles::Particle&lt;dim&gt;</a> new_particle;</div>
<div class="line">          new_particle.<a class="code" href="classParticles_1_1Particle.html#afbe52b594cf4a8dd11431679c4ef2b52">set_location</a>(<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>);</div>
<div class="line">          new_particle.<a class="code" href="classParticles_1_1Particle.html#a57efa2034baca617ba3160ccfbbc7cd7">set_reference_location</a>(</div>
<div class="line">            <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>.transform_real_to_unit_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>));</div>
<div class="line">          new_particle.<a class="code" href="classParticles_1_1Particle.html#af792bce47ec4746ad2c78e7e800299a8">set_id</a>(next_unused_particle_id);</div>
<div class="line">          particle_handler.insert_particle(new_particle, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">          ++next_unused_particle_id;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>At the end of all of these insertions, we let the <code>particle_handler</code> update some internal statistics about the particles it stores.</p>
<div class="fragment"><div class="line">  particle_handler.update_cached_numbers();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatormove_particles"></a> </p><h4>CathodeRaySimulator::move_particles</h4>
<p>The second particle-related function is the one that moves the particles in each time step. To do this, we have to loop over all cells, the particles in each cell, and evaluate the electric field at each of the particles' positions. <br  />
 The approach used here is conceptually the same used in the <code>assemble_system()</code> function: We loop over all cells, find the particles located there (with the same caveat about the inefficiency of the algorithm used here to find these particles), and use <a class="el" href="classFEPointEvaluation.html">FEPointEvaluation</a> object to evaluate the gradient at these positions:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::move_particles()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> dt = <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_next_step_size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>            solution_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">  <a class="code" href="classFEPointEvaluation.html">FEPointEvaluation&lt;1, dim&gt;</a> evaluator(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a>&lt;</div>
<div class="line">          <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::particle_iterator_range particles_in_cell =</div>
<div class="line">          particle_handler.<a class="code" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">particles_in_cell</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;Point&lt;dim&gt;&gt; particle_positions;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> : particles_in_cell)</div>
<div class="line">          particle_positions.push_back(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_reference_location());</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_values(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, solution_values);</div>
</div><!-- fragment --><p>Then we can ask the <a class="el" href="classFEPointEvaluation.html">FEPointEvaluation</a> object for the gradients of the solution (i.e., the electric field \(\mathbf E\) ) at these locations and loop over the individual particles:</p>
<div class="fragment"><div class="line">evaluator.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, particle_positions);</div>
<div class="line">evaluator.evaluate(<a class="code" href="classArrayView.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a>(solution_values),</div>
<div class="line">                   <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeadde91684ebb2c6ec5c5c5293123f6a04">EvaluationFlags::gradients</a>);</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleHandler&lt;dim&gt;::particle_iterator</a></div>
<div class="line">    <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> = particles_in_cell.<a class="code" href="classArrayView.html#a1a1c62a26e5f55bfe124894c0a31386f">begin</a>();</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a> = 0;</div>
<div class="line">       <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> != particles_in_cell.<a class="code" href="classArrayView.html#a775e02d2deaf2f769e24dee0c3e7a582">end</a>();</div>
<div class="line">       ++<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, ++<a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a>)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> &amp;<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> =</div>
<div class="line">        evaluator.get_gradient(<a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a>);</div>
</div><!-- fragment --><p>Having now obtained the electric field at the location of one of the particles, we use this to update first the velocity and then the position. To do so, let us first get the old velocity out of the properties stored with the particle, compute the acceleration, update the velocity, and store this new velocity again in the properties of the particle. Recall that this corresponds to the first of the following set of update equations discussed in the introduction:</p>
<p class="formulaDsp">
\begin{align*} \frac{{\mathbf v}_i^{(n)} -{\mathbf v}_i^{(n-1)}}{\Delta t} &amp;= \frac{e\nabla V^{(n)}}{m} \\ \frac{{\mathbf x}_i^{(n)}-{\mathbf x}_i^{(n-1)}} {\Delta t} &amp;= {\mathbf v}_i^{(n)}. \end{align*}
</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> old_velocity(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_properties());</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> acceleration =</div>
<div class="line">  <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a> / <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Constants::electron_mass</a> <a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> new_velocity =</div>
<div class="line">  old_velocity + acceleration dt;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_properties(<a class="code" href="classArrayView.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a>(new_velocity));</div>
</div><!-- fragment --><p>With the new velocity, we can then also update the location of the particle and tell the particle about it.</p>
<div class="fragment"><div class="line">        <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> new_location =</div>
<div class="line">          <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_location() + dt new_velocity;</div>
<div class="line">        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_location(new_location);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Having updated the locations and properties (i.e., velocities) of all particles, we need to make sure that the <code>particle_handler</code> again knows which cells they are in, and what their locations in the coordinate system of the reference cell are. The following function does that. (It also makes sure that, in parallel computations, particles are moved from one processor to another processor if a particle moves from the subdomain owned by the former to the subdomain owned by the latter.)</p>
<div class="fragment"><div class="line">  particle_handler.sort_particles_into_subdomains_and_cells();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatortrack_lost_particle"></a> </p><h4>CathodeRaySimulator::track_lost_particle</h4>
<p>The final particle-related function is the one that is called whenever a particle is lost from the simulation. This typically happens if it leaves the domain. If that happens, this function is called both the cell (which we can ask for its new location) and the cell it was previously on. The function then keeps track of updating the number of particles lost in this time step, the total number of lost particles, and then estimates whether the particle left through the hole in the middle of the anode. We do so by first checking whether the cell it was in last had an \(x\) coordinate to the left of the right boundary (located at \(x=4\) ) and the particle now has a position to the right of the right boundary. If that is so, we compute a direction vector of its motion that is normalized so that the \(x\) component of the direction vector is equal to \(1\) . With this direction vector, we can compute where it would have intersected the line \(x=4\) . If this intersect is between \(0.5\) and \(1.5\) , then we claim that the particle left through the hole and increment a counter.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::track_lost_particle(</div>
<div class="line">     <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">     <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">   {</div>
<div class="line">     ++n_recently_lost_particles;</div>
<div class="line">     ++n_total_lost_particles;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> current_location              = <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_location();</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> approximate_previous_location = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center();</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> ((approximate_previous_location[0] &lt; 4) &amp;&amp; (current_location[0] &gt; 4))</div>
<div class="line">       {</div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a> =</div>
<div class="line">           (current_location</div>
<div class="line">  </div>
<div class="line">- approximate_previous_location) /</div>
<div class="line">           (current_location[0]</div>
<div class="line">  </div>
<div class="line">- approximate_previous_location[0]);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> right_boundary_intercept =</div>
<div class="line">           approximate_previous_location[1] +</div>
<div class="line">           (4</div>
<div class="line">  </div>
<div class="line">- approximate_previous_location[0]) <a class="code" href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a>[1];</div>
<div class="line">         <span class="keywordflow">if</span> ((right_boundary_intercept &gt; 0.5) &amp;&amp;</div>
<div class="line">             (right_boundary_intercept &lt; 1.5))</div>
<div class="line">           ++n_particles_lost_through_anode;</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorupdate_timestep_size"></a> </p><h4>CathodeRaySimulator::update_timestep_size</h4>
<p>As discussed at length in the introduction, we need to respect a time step condition whereby particles can not move further than one cell in one time step. To ensure that this is the case, we again first compute the maximal speed of all particles on each cell, and divide the cell size by that speed. We then compute the next time step size as the minimum of this quantity over all cells, using the safety factor discussed in the introduction, and set this as the desired time step size using the DiscreteTime::set_desired_time_step_size() function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::update_timestep_size()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number() &gt; 0)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> min_cell_size_over_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">        <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> cell_size = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;minimum_vertex_distance();</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">double</span> max_particle_velocity(0.0);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> :</div>
<div class="line">                 particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_properties());</div>
<div class="line">                max_particle_velocity =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_particle_velocity, <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>.norm());</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (max_particle_velocity &gt; 0)</div>
<div class="line">              min_cell_size_over_velocity =</div>
<div class="line">                <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_cell_size_over_velocity,</div>
<div class="line">                         cell_size / max_particle_velocity);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">      constexpr <span class="keywordtype">double</span> c_safety = 0.5;</div>
<div class="line">      <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.set_desired_next_step_size(c_safety 0.5</div>
<div class="line">                                      min_cell_size_over_velocity);</div>
<div class="line">    }</div>
</div><!-- fragment --><p>As mentioned in the introduction, we have to treat the very first time step differently since there, particles are not available yet or do not yet have the information associated that we need for the computation of a reasonable step length. The formulas below follow the discussion in the introduction.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;dim&gt;</a> vertex_quadrature;</div>
<div class="line">      <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>, vertex_quadrature, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;Tensor&lt;1, dim&gt;&gt; field_gradients(vertex_quadrature.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> min_timestep = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">        <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> cell_size = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;minimum_vertex_distance();</div>
<div class="line"> </div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_gradients(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, field_gradients);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordtype">double</span> max_E = 0;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">              max_E = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_E, field_gradients[q_point].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (max_E &gt; 0)</div>
<div class="line">              min_timestep =</div>
<div class="line">                <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_timestep,</div>
<div class="line">                         <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(0.5 cell_size</div>
<div class="line">                                   <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Constants::electron_mass</a> /</div>
<div class="line">                                   <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a> / max_E));</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.set_desired_next_step_size(min_timestep);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeCathodeRaySimulatoroutput_resultscodefunction"></a> </p><h4>The <code>CathodeRaySimulator::output_results()</code> function</h4>
<p>The final function implementing pieces of the overall algorithm is the one that generates graphical output. In the current context, we want to output both the electric potential field as well as the particle locations and velocities. But we also want to output the electric field, i.e., the gradient of the solution. <br  />
 deal.II has a general way how one can compute derived quantities from the solution and output those as well. Here, this is the electric field, but it could also be some other quantity</p>
<ul>
<li>say, the norm of the electric field, or in fact anything else one could want to compute from the solution \(V_h(\mathbf x)\) or its derivatives. This general solution uses the <a class="el" href="classDataPostprocessor.html">DataPostprocessor</a> class and, in cases like the one here where we want to output a quantity that represents a vector field, the <a class="el" href="classDataPostprocessorVector.html">DataPostprocessorVector</a> class. <br  />
 Rather than try and explain how this class works, let us simply refer to the documentation of the <a class="el" href="classDataPostprocessorVector.html">DataPostprocessorVector</a> class that has essentially this case as a well-documented example.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>ElectricFieldPostprocessor : <span class="keyword">public</span> <a class="code" href="classDataPostprocessorVector.html">DataPostprocessorVector</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  ElectricFieldPostprocessor()</div>
<div class="line">    : <a class="code" href="classDataPostprocessorVector.html">DataPostprocessorVector</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<span class="stringliteral">&quot;electric_field&quot;</span>, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classDataPostprocessor.html#a07ebcf764cf911c6d78f21c32ea1d2d0">evaluate_scalar_field</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Scalar.html">DataPostprocessorInputs::Scalar&lt;dim&gt;</a> &amp;input_data,</div>
<div class="line">    <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;computed_quantities)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>.size(),</div>
<div class="line">                    computed_quantities.size());</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(computed_quantities[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>(), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          computed_quantities[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>];</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">};</div>
</div><!-- fragment --><p>With this, the <code>output_results()</code> function becomes relatively straightforward: We use the <a class="el" href="classDataOut.html">DataOut</a> class as we have in almost every one of the previous tutorial programs to output the solution (the "electric potential") and we use the postprocessor defined above to also output its gradient (the "electric field"). This all is then written into a file in VTU format after also associating the current time and time step number with this file.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  {</div>
<div class="line">    ElectricFieldPostprocessor&lt;dim&gt; electric_field;</div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a>                    data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, <span class="stringliteral">&quot;electric_potential&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, electric_field);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(</div>
<div class="line">      <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time(), <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number()));</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution-&quot;</span> +</div>
<div class="line">                         <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number(), 4) +</div>
<div class="line">                         <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Output the particle positions and properties is not more complicated. The <a class="el" href="classParticles_1_1DataOut.html">Particles::DataOut</a> class plays the role of the <a class="el" href="classDataOut.html">DataOut</a> class for particles, and all we have to do is tell that class where to take particles from and how to interpret the <code>dim</code> components of the properties</p>
<ul>
<li>namely, as a single vector indicating the velocity, rather than as <code>dim</code> scalar properties. The rest is then the same as above:</li>
</ul>
<div class="fragment"><div class="line">  {</div>
<div class="line">    <a class="code" href="classParticles_1_1DataOut.html">Particles::DataOut&lt;dim, dim&gt;</a> particle_out;</div>
<div class="line">    particle_out.<a class="code" href="classParticles_1_1DataOut.html#adf095165dc286310226584b2b9972701">build_patches</a>(</div>
<div class="line">      particle_handler,</div>
<div class="line">      std::vector&lt;std::string&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>),</div>
<div class="line">      std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;(</div>
<div class="line">        <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>));</div>
<div class="line"> </div>
<div class="line">    particle_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(</div>
<div class="line">      <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time(), <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number()));</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;particles-&quot;</span> +</div>
<div class="line">                         <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number(), 4) +</div>
<div class="line">                         <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">    particle_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="CathodeRaySimulatorrun"></a> </p><h4>CathodeRaySimulator::run</h4>
<p>The last member function of the principal class of this program is then the driver. At the top, it refines the mesh a number of times by solving the problem (with not particles yet created) on a sequence of finer and finer meshes.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">CathodeRaySimulator&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
</div><!-- fragment --><p>do a few refinement cycles up front</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_cycles = 3;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0;</div>
<div class="line">     refinement_cycle &lt; n_pre_refinement_cycles;</div>
<div class="line">     ++refinement_cycle)</div>
<div class="line">  {</div>
<div class="line">    setup_system();</div>
<div class="line">    assemble_system();</div>
<div class="line">    solve_field();</div>
<div class="line">    refine_grid();</div>
<div class="line">  }</div>
</div><!-- fragment --><p>Now do the loop over time. The sequence of steps follows closely the outline of the algorithm discussed in the introduction. As discussed in great detail in the documentation of the <a class="el" href="classDiscreteTime.html">DiscreteTime</a> class, while we move the field and particle information forward by one time step, the time stored in the <code>time</code> variable is not consistent with where (some of) these quantities are (in the diction of <a class="el" href="classDiscreteTime.html">DiscreteTime</a>, this is the "update stage"). The call to <code>time.advance_time()</code> makes everything consistent again by setting the <code>time</code> variable to the time at which the field and particles already are, and once we are in this "consistent stage", we can generate graphical output and write information about the current state of the simulation to screen.</p>
<div class="fragment"><div class="line">    setup_system();</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number() + 1 &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Field degrees of freedom:                 &quot;</span></div>
<div class="line">                  &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_system();</div>
<div class="line">        solve_field();</div>
<div class="line"> </div>
<div class="line">        create_particles();</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Total number of particles in simulation:  &quot;</span></div>
<div class="line">                  &lt;&lt; particle_handler.n_global_particles() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        n_recently_lost_particles = 0;</div>
<div class="line">        update_timestep_size();</div>
<div class="line">        move_particles();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.advance_time();</div>
<div class="line"> </div>
<div class="line">        output_results();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Number of particles lost this time step:  &quot;</span></div>
<div class="line">                  &lt;&lt; n_recently_lost_particles &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">if</span> (n_total_lost_particles &gt; 0)</div>
<div class="line">          std::cout &lt;&lt; <span class="stringliteral">&quot;  Fraction of particles lost through anode: &quot;</span></div>
<div class="line">                    &lt;&lt; 1. n_particles_lost_through_anode /</div>
<div class="line">                         n_total_lost_particles</div>
<div class="line">                    &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;  Now at t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;, dt=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_previous_step_size() &lt;&lt; <span class="charliteral">&#39;.&#39;</span></div>
<div class="line">                  &lt;&lt; std::endl</div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.is_at_end() == <span class="keyword">false</span>);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step19</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>The final function of the program is then again the <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> function. It is unchanged in all tutorial programs since <a class="el" href="step_6.html">step-6</a> and so there is nothing new to discuss:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classStep19_1_1CathodeRaySimulator.html">Step19::CathodeRaySimulator&lt;2&gt;</a> cathode_ray_simulator_2d;</div>
<div class="line">      cathode_ray_simulator_2d.<a class="code" href="classStep19_1_1CathodeRaySimulator.html#acceda54ac84d5e31aa1ae329bd1a0381">run</a>();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>When this program is run, it produces output that looks as follows:```Timestep 1 Field degrees of freedom: 4989 Total number of particles in simulation: 20 Number of particles lost this time step: 0 Now at t=2.12647e-07, dt=2.12647e-07. Timestep 2 Field degrees of freedom: 4989 Total number of particles in simulation: 24 Number of particles lost this time step: 0 Now at t=4.14362e-07, dt=2.01715e-07. Timestep 3 Field degrees of freedom: 4989 Total number of particles in simulation: 28 Number of particles lost this time step: 0 Now at t=5.96019e-07, dt=1.81657e-07. Timestep 4 Field degrees of freedom: 4989 Total number of particles in simulation: 32 Number of particles lost this time step: 0 Now at t=7.42634e-07, dt=1.46614e-07.</p>
<p>...</p>
<p>Timestep 1000 Field degrees of freedom: 4989 Total number of particles in simulation: 44 Number of particles lost this time step: 6 Fraction of particles lost through anode: 0.0601266 Now at t=4.93276e-05, dt=4.87463e-08. Timestep 1001 Field degrees of freedom: 4989 Total number of particles in simulation: 44 Number of particles lost this time step: 0 Fraction of particles lost through anode: 0.0601266 Now at t=4.93759e-05, dt=4.82873e-08.</p>
<p>...</p>
<p>Timestep 2091 Field degrees of freedom: 4989 Total number of particles in simulation: 44 Number of particles lost this time step: 0 Fraction of particles lost through anode: 0.0503338 Now at t=9.99237e-05, dt=4.26254e-08. Timestep 2092 Field degrees of freedom: 4989 Total number of particles in simulation: 44 Number of particles lost this time step: 0 Fraction of particles lost through anode: 0.0503338 Now at t=9.99661e-05, dt=4.24442e-08. Timestep 2093 Field degrees of freedom: 4989 Total number of particles in simulation: 44 Number of particles lost this time step: 2 Fraction of particles lost through anode: 0.050308 Now at t=0.0001, dt=3.38577e-08.``` Picking a random few time steps, we can visualize the solution in theform of streamlines for the electric field and dots for the electrons: </p><div class="twocolumn" style="width: 80%"> <div> <img src="https://www.dealii.org/images/steps/developer/step-19.solution.0000.png" alt="The solution at time step 0 (t=0 seconds)." width="500" class="inline"/> <br  />
 Solution at time step 0 (t=0 seconds). <br  />
 </div> <div> <img src="https://www.dealii.org/images/steps/developer/step-19.solution.1400.png" alt="The solution at time step 1400 (t=0.000068 seconds)." width="500" class="inline"/> <br  />
 Solution at time step 1400 (t=0.000068 seconds). <br  />
 </div> <div> <img src="https://www.dealii.org/images/steps/developer/step-19.solution.0700.png" alt="The solution at time step 700 (t=0.000035 seconds)." width="500" class="inline"/> <br  />
 Solution at time step 700 (t=0.000035 seconds). <br  />
 </div> <div> <img src="https://www.dealii.org/images/steps/developer/step-19.solution.2092.png" alt="The solution at time step 2092 (t=0.0001 seconds)." width="500" class="inline"/> <br  />
 Solution at time step 2092 (t=0.0001 seconds). <br  />
 </div> </div><p> <br  />
 That said, a more appropriate way to visualize the results of thisprogram are by creating a video that shows how these electrons move, and howthe electric field changes in response to their motion:  
<p align="center">
  <iframe width="560" height="315" src="https://www.youtube.com/embed/HwUtE7xuteE"
   frameborder="0"
   allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
   allowfullscreen></iframe>
 </p>
</p>
<p>What you can see here is how the "focus element" of the boundary with its negativevoltage repels the electrons and makes sure that they do not just fly awayperpendicular from the cathode (as they do in the initial part of theirtrajectories). It also shows how the electric field linesmove around over time, in response to the charges flying by</p>
<ul>
<li>in other words,the feedback the particles have on the electric field that itself drives themotion of the electrons. The movie suggests that electrons move in "bunches" or "bursts". One element ofthis appearance is an artifact of how the movie was created: Every frame of themovie corresponds to one time step, but the time step length varies. More specifically,the fastest particle moving through the smallest cell determines the length of thetime step (see the discussion in the introduction), and consequently time stepsare small whenever a (fast) particle moves through the small cells at the rightedge of the domain; time steps are longer again once the particle has leftthe domain. This slowing-accelerating effect can easily be visualized by plottingthe time step length shown in the screen output. The second part of this is real, however: The simulation creates a large groupof particles in the beginning, and fewer after about the 300th time step. Thisis probably because of the negative charge of the particles in the simulation:They reduce the magnitude of the electric field at the (also negatively chargedelectrode) and consequently reduce the number of points on the cathode at whichthe magnitude exceeds the threshold necessary to draw an electron out of theelectrode.</li>
</ul>
<p><a class="anchor" id="extensions"></a><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p><a class="anchor" id="Avoidingaperformancebottleneckwithparticles"></a></p><h4>Avoiding a performance bottleneck with particles </h4>
<p>The <code>assemble_system()</code>, <code>move_particles()</code>, and <code>update_timestep_size()</code>functions all call <a class="el" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">Particles::ParticleHandler::particles_in_cell()</a> and <a class="el" href="classParticles_1_1ParticleHandler.html#ac043a4ea224ed50a03b8e9c3d3b98aec">Particles::ParticleHandler::n_particles_in_cell()</a> that query informationabout the particles located on the current cell. While this is convenient,it's also inefficient. To understand why this is so, one needs to knowhow particles are stored in <a class="el" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a>: namely, in adata structure in which particles are ordered in some kind of linearfashion sorted by the cell they are on. Consequently, in order to findthe particles associated with a given cell, these functions need tosearch for the first (and possibly last) particle on a given cell</p>
<ul>
<li>an effort that costs \({\cal O}(\log N)\) operations where \(N\) is thenumber of particles. But this is repeated on every cell; assuming thatfor large computations, the number of cells and particles are roughlyproportional, the accumulated cost of these function calls is then \({\cal O}(N \log N)\) and consequently larger than the \({\cal O}(N)\) cost that we should shoot for with all parts of a program. We can make this cheaper, though. First, instead of calling <a class="el" href="classParticles_1_1ParticleHandler.html#ac043a4ea224ed50a03b8e9c3d3b98aec">Particles::ParticleHandler::n_particles_in_cell()</a>, we might first call <a class="el" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">Particles::ParticleHandler::particles_in_cell()</a> and then compute thenumber of particles on a cell by just computing the distance of the lastto the first particle on the current cell: <div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleHandler.html#a655ae2bdfe026f1ed172a2ec4c6c3d60">Particles::ParticleHandler&lt;dim, spacedim&gt;::particle_iterator_range</a></div>
<div class="line">  particles_in_cell = particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span></div>
<div class="line">  <a class="code" href="particle__handler__0_8txt.html#a5ebacea68cda561e1adc199d23e1de40">n_particles_in_cell</a> = std::distance (particles_in_cell.<a class="code" href="classParticles_1_1ParticleHandler.html#a958a15b3aa325db82b4876cdb9feb527">begin</a>(),</div>
<div class="line">                                       particles_in_cell.<a class="code" href="classParticles_1_1ParticleHandler.html#ab5f542a397843198eb82d8537602daf3">end</a>());</div>
</div><!-- fragment --> The first of these calls is of course still \({\cal O}(\log N)\) ,but at least the second call only takes a compute time proportional tothe number of particles on the current cell and so, when accumulatedover all cells, has a cost of \({\cal O}(N)\) . But we can even get rid of the first of these calls with some proper algorithmdesign. That's because particles are ordered in the same way as cells, and sowe can just walk them as we move along on the cells. The following outlineof an algorithm does this: <div class="fragment"><div class="line"><span class="keyword">auto</span> begin_particle_on_cell = particle_handler.begin();</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_particles_on_cell = 0;</div>
<div class="line">    <span class="keyword">auto</span> end_particle_on_cell = begin_particle_on_cell;</div>
<div class="line">    <span class="keywordflow">while</span> (end_particle_on_cell-&gt;get_surrounding_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">           == <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">      {</div>
<div class="line">        ++n_particles_on_cell;</div>
<div class="line">        ++end_particle_on_cell;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    ...now <a class="code" href="work__stream__0_8txt.html#a96b33355a5c2a51e5f573fa286e92491">operate</a> <a class="code" href="data__out__base__0_8txt.html#a1a0f08903e9f2a25a073261a20b86e26">on</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> <a class="code" href="synchronous__iterator__0_8txt.html#a3e447fe5e17c249965365f92a0755913">range</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a> <a class="code" href="discrete__time__0_8txt.html#aea6d70f72c4e549e943e681a41fdb8d9">from</a> begin_particle_on_cell</div>
<div class="line">       <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a23e8d7ec9b1cf01acce4516431c61616">to</a> end_particle_on_cell, <a class="code" href="update__flags__0_8txt.html#a5f3fcf87333f5770d16608f67ad88d19">all</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__base__0_8txt.html#ab42576dfdd4ffe69354987b53ad19f20">which</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#ae32ad430917839b4e435a4d04c5d975a">are</a> <a class="code" href="function__0_8txt.html#a8f6aa3983c7a97f1d27b94ad1d160c10">known</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a23e8d7ec9b1cf01acce4516431c61616">to</a> <a class="code" href="coding__conventions__0_8txt.html#a2ea3312e08a7e3658bf73660b48f0aa4">be</a> <a class="code" href="data__out__base__0_8txt.html#a1a0f08903e9f2a25a073261a20b86e26">on</a> <a class="code" href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a> current</div>
<div class="line">       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>...;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Move the begin iterator forward so that it points to the first</span></div>
<div class="line">    <span class="comment">// particle on the next cell</span></div>
<div class="line">    begin_particle_on_cell = end_particle_on_cell;</div>
<div class="line">  }</div>
</div><!-- fragment --></li>
</ul>
<p>In this code, we touch every cell exactly once and we never have to searchthe big data structure for the first or last particle on each cell. As aconsequence, the algorithm costs a total of \({\cal O}(N)\) for a completesweep of all particles and all cells. It would not be very difficult to implement this scheme for all three of thefunctions in this program that have this issue.</p>
<p><a class="anchor" id="Morestatisticsaboutelectrons"></a></p><h4>More statistics about electrons </h4>
<p>The program already computes the fraction of the electrons that leave thedomain through the hole in the anode. But there are other quantities one might beinterested in. For example, the average velocity of these particles. It wouldnot be very difficult to obtain each particle's velocity from its properties,in the same way as we do in the <code>move_particles()</code> function, and computestatistics from it.</p>
<p><a class="anchor" id="Abettersynchronizedvisualization"></a></p><h4>A better-synchronized visualization </h4>
<p>As discussed above, there is a varying time difference between different framesof the video because we create output for every time step. A better way tocreate movies would be to generate a new output file in fixed time intervals,regardless of how many time steps lie between each such point.</p>
<p><a class="anchor" id="Abettertimeintegrator"></a></p><h4>A better time integrator </h4>
<p>The problem we are considering in this program is a coupled, multiphysicsproblem. But the way we solve it is by first computing the (electric) potentialfield and then update the particle locations. This is what is called an"operator-splitting method", a concept we will investigate in more detailin <a class="el" href="step_58.html">step-58</a> . While it is awkward to think of a way to solve this problem that does not involvesplitting the problem into a PDE piece and a particles piece, one can* (and probably should!) think of a better way to update the particlelocations. Specifically, the equations we use to update the particle locationare </p><p class="formulaDsp">
\begin{align*} \frac{{\mathbf v}_i^{(n)}-{\mathbf v}_i^{(n-1)}}{\Delta t} &amp;= \frac{e\nabla V^{(n)}}{m} \\ \frac{{\mathbf x}_i^{(n)}-{\mathbf x}_i^{(n-1)}}{\Delta t} &amp;= {\mathbf v}_i^{(n)}. \end{align*}
</p>
<p> This corresponds to a simple forward-Euler time discretization</p>
<ul>
<li>a method offirst order accuracy in the time step size \(\Delta t\) that we know we shouldavoid because we can do better. Rather, one might want to consider a scheme suchas the<a href="https://en.wikipedia.org/wiki/Leapfrog_integration">leapfrog scheme</a>or more generally<a href="https://en.wikipedia.org/wiki/Symplectic_integrator">symplectic integrators</a>such as the<a href="https://en.wikipedia.org/wiki/Verlet_integration">Verlet scheme</a>.</li>
</ul>
<p><a class="anchor" id="Parallelization"></a></p><h4>Parallelization </h4>
<p>In release mode, the program runs in about 3.5 minutes on one of the author'slaptops at the time of writing this. That's acceptable. But what if we wantedto make the simulation three-dimensional? If we wanted to not use a maximumof around 100 particles at any given time (as happens with the parametersused here) but 100,000? If we needed a substantially finer mesh? In those cases, one would want to run the program not just on a single processor,but in fact on as many as one has available. This requires parallelizationboth the PDE solution as well as over particles. In practice, while thereare substantial challenges to making this efficient and scale well, thesechallenges are all addressed in deal.II itself. For example, <a class="el" href="step_40.html">step-40</a> showshow to parallelize the finite element part, and <a class="el" href="step_70.html">step-70</a> shows how one canthen also parallelize the particles part.</p>
<p><a class="anchor" id="PlainProg"></a></p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2020 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Wolfgang Bangerth, Rene Gassmoeller, Peter Munch, 2020.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2mapping__q_8h.html">deal.II/fe/mapping_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__free_2fe__point__evaluation_8h.html">deal.II/matrix_free/fe_point_evaluation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2discrete__time_8h.html">deal.II/base/discrete_time.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="particles_2particle__handler_8h.html">deal.II/particles/particle_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="particles_2data__out_8h.html">deal.II/particles/data_out.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep19.html">Step19</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">namespace </span>BoundaryIds</div>
<div class="line">  {</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="function__restriction__0_8txt.html#a93564637b88550ce91447da5d5661dc2">open</a>          = 101;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">cathode</a>       = 102;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">focus_element</a> = 103;</div>
<div class="line">    constexpr <a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a> <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">anode</a>         = 104;</div>
<div class="line">  } <span class="comment">// namespace BoundaryIds</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>Constants</div>
<div class="line">  {</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">electron_mass</a>   = 9.1093837015e-31;</div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">electron_charge</a> = 1.602176634e-19;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">V0</a> = 1;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">E_threshold</a> = 0.05;</div>
<div class="line"> </div>
<div class="line">    constexpr <span class="keywordtype">double</span> <a class="code" href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">electrons_per_particle</a> = 3e15;</div>
<div class="line">  } <span class="comment">// namespace Constants</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>CathodeRaySimulator</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    CathodeRaySimulator();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line">    <span class="keywordtype">void</span> setup_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">    <span class="keywordtype">void</span> solve_field();</div>
<div class="line">    <span class="keywordtype">void</span> refine_grid();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> create_particles();</div>
<div class="line">    <span class="keywordtype">void</span> move_particles();</div>
<div class="line">    <span class="keywordtype">void</span> track_lost_particle(</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> update_timestep_size();</div>
<div class="line">    <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a>      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler&lt;dim&gt;</a> particle_handler;</div>
<div class="line">    <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           next_unused_particle_id;</div>
<div class="line">    <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_recently_lost_particles;</div>
<div class="line">    <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_total_lost_particles;</div>
<div class="line">    <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a>           n_particles_lost_through_anode;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDiscreteTime.html">DiscreteTime</a> <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  CathodeRaySimulator&lt;dim&gt;::CathodeRaySimulator()</div>
<div class="line">    : <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>(1)</div>
<div class="line">    , <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(2)</div>
<div class="line">    , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    , particle_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, <span class="comment">/*n_properties=*/</span><a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)</div>
<div class="line">    , next_unused_particle_id(0)</div>
<div class="line">    , n_recently_lost_particles(0)</div>
<div class="line">    , n_total_lost_particles(0)</div>
<div class="line">    , n_particles_lost_through_anode(0)</div>
<div class="line">    , <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>(0, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-4)</div>
<div class="line">  {</div>
<div class="line">    particle_handler.signals.particle_lost.connect(</div>
<div class="line">      [<span class="keyword">this</span>](<span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">             <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) {</div>
<div class="line">        this-&gt;track_lost_particle(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      });</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">CathodeRaySimulator&lt;dim&gt;::make_grid</a>()</div>
<div class="line">  {</div>
<div class="line">    static_assert(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2,</div>
<div class="line">                  <span class="stringliteral">&quot;This function is currently only implemented for 2d.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       delta = 0.5;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nx    = 5;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ny    = 3;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;Point&lt;dim&gt;&gt; <a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a> </div>
<div class="line">      = {{0, 0},</div>
<div class="line">         {1, 0},</div>
<div class="line">         {2, 0},</div>
<div class="line">         {3, 0},</div>
<div class="line">         {4, 0},</div>
<div class="line">         {delta, 1},</div>
<div class="line">         {1, 1},</div>
<div class="line">         {2, 1},</div>
<div class="line">         {3, 1},</div>
<div class="line">         {4, 1},</div>
<div class="line">         {0, 2},</div>
<div class="line">         {1, 2},</div>
<div class="line">         {2, 2},</div>
<div class="line">         {3, 2},</div>
<div class="line">         {4, 2}};</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(<a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a>.size(), nx * ny);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;unsigned int&gt; cell_vertices[(nx - 1) * (ny - 1)] = {</div>
<div class="line">      {0, 1, nx + 0, nx + 1},</div>
<div class="line">      {1, 2, nx + 1, nx + 2},</div>
<div class="line">      {2, 3, nx + 2, nx + 3},</div>
<div class="line">      {3, 4, nx + 3, nx + 4},</div>
<div class="line"> </div>
<div class="line">      {5, nx + 1, 2 * nx + 0, 2 * nx + 1},</div>
<div class="line">      {nx + 1, nx + 2, 2 * nx + 1, 2 * nx + 2},</div>
<div class="line">      {nx + 2, nx + 3, 2 * nx + 2, 2 * nx + 3},</div>
<div class="line">      {nx + 3, nx + 4, 2 * nx + 3, 2 * nx + 4}};</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;CellData&lt;dim&gt;&gt; <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>((nx - 1) * (ny - 1), <a class="code" href="structCellData.html">CellData&lt;dim&gt;</a>());</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>].vertices    = cell_vertices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>];</div>
<div class="line">        <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>].material_id = 0;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.create_triangulation(</div>
<div class="line">      <a class="code" href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a>,</div>
<div class="line">      <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>,</div>
<div class="line">      <a class="code" href="structSubCellData.html">SubCellData</a>()); <span class="comment">// No boundary information</span></div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(2);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &lt; 0.5) &amp;&amp;</div>
<div class="line">                (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &lt; 2))</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 0) &amp;&amp; (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &lt; 2))</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">BoundaryIds::focus_element</a>);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[0] &gt; 4 - 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12) &amp;&amp;</div>
<div class="line">                     ((<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &gt; 1.5) || (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[1] &lt; 0.5)))</div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">BoundaryIds::anode</a>);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_boundary_id(<a class="code" href="function__restriction__0_8txt.html#a93564637b88550ce91447da5d5661dc2">BoundaryIds::open</a>);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(1);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::setup_system()</div>
<div class="line">  {</div>
<div class="line">    dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">    system_rhs.reinit(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>,</div>
<div class="line">                                             <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                               -<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">BoundaryIds::focus_element</a>,</div>
<div class="line">                                             <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                               -<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">BoundaryIds::anode</a>,</div>
<div class="line">                                             <a class="code" href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt;dim&gt;</a>(</div>
<div class="line">                                               +<a class="code" href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Constants::V0</a>),</div>
<div class="line">                                             <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>());</div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                    dsp,</div>
<div class="line">                                    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                    <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">false</span>);</div>
<div class="line">    <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::assemble_system()</div>
<div class="line">  {</div>
<div class="line">    system_matrix = 0;</div>
<div class="line">    system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">dofs_per_cell</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a> = 0;</div>
<div class="line">        cell_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index : fe_values.quadrature_point_indices())</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">            {</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> : fe_values.dof_indices())</div>
<div class="line">                <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q_index) * <span class="comment">// grad phi_i(x_q)</span></div>
<div class="line">                   fe_values.shape_grad(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q_index) * <span class="comment">// grad phi_j(x_q)</span></div>
<div class="line">                   fe_values.JxW(q_index));           <span class="comment">// dx</span></div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> : particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;reference_location =</div>
<div class="line">                <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_reference_location();</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> : fe_values.dof_indices())</div>
<div class="line">                cell_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  (<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFE__Poly.html#a9205cb50b9901b40adc7220dd92ded5c">shape_value</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, reference_location) * <span class="comment">// phi_i(x_p)</span></div>
<div class="line">                   (-<a class="code" href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">Constants::electrons_per_particle</a> *   <span class="comment">// N</span></div>
<div class="line">                    <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a>));          <span class="comment">// e</span></div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(</div>
<div class="line">          <a class="code" href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a>, cell_rhs, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, system_matrix, system_rhs);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::solve_field()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(1000, 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-12);</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">    <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(system_matrix, 1.2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a>.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::refine_grid()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(dof_handler,</div>
<div class="line">                                       <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div>
<div class="line">                                       {},</div>
<div class="line">                                       <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">                                       estimated_error_per_cell);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                    estimated_error_per_cell,</div>
<div class="line">                                                    0.1,</div>
<div class="line">                                                    0.03);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::create_particles()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> fe_face_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                                     <a class="code" href="classQMidpoint.html">QMidpoint&lt;dim - 1&gt;</a>(),</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; solution_gradients(</div>
<div class="line">      fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary() &amp;&amp;</div>
<div class="line">            (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;boundary_id() == <a class="code" href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">BoundaryIds::cathode</a>))</div>
<div class="line">          {</div>
<div class="line">            fe_face_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> electric_potential(0);</div>
<div class="line">            fe_face_values[electric_potential].<a class="code" href="classFEValuesBase.html#ad1f4e0deb5d982e8172d82141c634a67">get_function_gradients</a>(</div>
<div class="line">              <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, solution_gradients);</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point :</div>
<div class="line">                 fe_face_values.<a class="code" href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">quadrature_point_indices</a>())</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> = solution_gradients[q_point];</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> ((<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> * fe_face_values.<a class="code" href="classFEValuesBase.html#ac25ec6835799c3b6c7c842f8acb05eb3">normal_vector</a>(q_point) &lt; 0) &amp;&amp;</div>
<div class="line">                    (<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a>.norm() &gt; <a class="code" href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">Constants::E_threshold</a>))</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a> =</div>
<div class="line">                      fe_face_values.<a class="code" href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">quadrature_point</a>(q_point);</div>
<div class="line"> </div>
<div class="line">                    <a class="code" href="classParticles_1_1Particle.html">Particles::Particle&lt;dim&gt;</a> new_particle;</div>
<div class="line">                    new_particle.<a class="code" href="classParticles_1_1Particle.html#afbe52b594cf4a8dd11431679c4ef2b52">set_location</a>(<a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>);</div>
<div class="line">                    new_particle.<a class="code" href="classParticles_1_1Particle.html#a57efa2034baca617ba3160ccfbbc7cd7">set_reference_location</a>(</div>
<div class="line">                      <a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>.transform_real_to_unit_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a>));</div>
<div class="line">                    new_particle.<a class="code" href="classParticles_1_1Particle.html#af792bce47ec4746ad2c78e7e800299a8">set_id</a>(next_unused_particle_id);</div>
<div class="line">                    particle_handler.insert_particle(new_particle, <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">                    ++next_unused_particle_id;</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">    particle_handler.update_cached_numbers();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::move_particles()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> dt = <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_next_step_size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>            solution_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">    <a class="code" href="classFEPointEvaluation.html">FEPointEvaluation&lt;1, dim&gt;</a> evaluator(<a class="code" href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a>, <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">      <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler</a>&lt;</div>
<div class="line">            <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::particle_iterator_range particles_in_cell =</div>
<div class="line">            particle_handler.<a class="code" href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">particles_in_cell</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line"> </div>
<div class="line">          std::vector&lt;Point&lt;dim&gt;&gt; particle_positions;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> : particles_in_cell)</div>
<div class="line">            particle_positions.push_back(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_reference_location());</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_values(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, solution_values);</div>
<div class="line"> </div>
<div class="line">          evaluator.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, particle_positions);</div>
<div class="line">          evaluator.evaluate(<a class="code" href="base_2array__view_8h.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a>(solution_values),</div>
<div class="line">                             <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeadde91684ebb2c6ec5c5c5293123f6a04">EvaluationFlags::gradients</a>);</div>
<div class="line"> </div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleHandler&lt;dim&gt;::particle_iterator</a></div>
<div class="line">              <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> = particles_in_cell.<a class="code" href="classArrayView.html#a1a1c62a26e5f55bfe124894c0a31386f">begin</a>();</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a> = 0;</div>
<div class="line">                 <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> != particles_in_cell.<a class="code" href="classArrayView.html#a775e02d2deaf2f769e24dee0c3e7a582">end</a>();</div>
<div class="line">                 ++<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>, ++<a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> &amp;<a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a> =</div>
<div class="line">                  evaluator.get_gradient(<a class="code" href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">particle_index</a>);</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> old_velocity(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_properties());</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> acceleration =</div>
<div class="line">                  <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a> / <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Constants::electron_mass</a> * <a class="code" href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a>;</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> new_velocity =</div>
<div class="line">                  old_velocity + acceleration * dt;</div>
<div class="line"> </div>
<div class="line">                <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_properties(<a class="code" href="base_2array__view_8h.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a>(new_velocity));</div>
<div class="line"> </div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> new_location =</div>
<div class="line">                  <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_location() + dt * new_velocity;</div>
<div class="line">                <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;set_location(new_location);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    particle_handler.sort_particles_into_subdomains_and_cells();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::track_lost_particle(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator&lt;dim&gt;</a> &amp;        <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;::active_cell_iterator</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>)</div>
<div class="line">  {</div>
<div class="line">    ++n_recently_lost_particles;</div>
<div class="line">    ++n_total_lost_particles;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> current_location              = <a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>-&gt;get_location();</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> approximate_previous_location = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;center();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((approximate_previous_location[0] &lt; 4) &amp;&amp; (current_location[0] &gt; 4))</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a> =</div>
<div class="line">          (current_location - approximate_previous_location) /</div>
<div class="line">          (current_location[0] - approximate_previous_location[0]);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> right_boundary_intercept =</div>
<div class="line">          approximate_previous_location[1] +</div>
<div class="line">          (4 - approximate_previous_location[0]) * <a class="code" href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a>[1];</div>
<div class="line">        <span class="keywordflow">if</span> ((right_boundary_intercept &gt; 0.5) &amp;&amp;</div>
<div class="line">            (right_boundary_intercept &lt; 1.5))</div>
<div class="line">          ++n_particles_lost_through_anode;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::update_timestep_size()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number() &gt; 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_cell_size_over_velocity = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">          <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> cell_size = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;minimum_vertex_distance();</div>
<div class="line"> </div>
<div class="line">              <span class="keywordtype">double</span> max_particle_velocity(0.0);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a> :</div>
<div class="line">                   particle_handler.particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>))</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>(<a class="code" href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a>.get_properties());</div>
<div class="line">                  max_particle_velocity =</div>
<div class="line">                    <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_particle_velocity, <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>.norm());</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">if</span> (max_particle_velocity &gt; 0)</div>
<div class="line">                min_cell_size_over_velocity =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_cell_size_over_velocity,</div>
<div class="line">                           cell_size / max_particle_velocity);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        constexpr <span class="keywordtype">double</span> c_safety = 0.5;</div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.set_desired_next_step_size(c_safety * 0.5 *</div>
<div class="line">                                        min_cell_size_over_velocity);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classQTrapezoid.html">QTrapezoid&lt;dim&gt;</a> vertex_quadrature;</div>
<div class="line">        <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>, vertex_quadrature, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;Tensor&lt;1, dim&gt;&gt; field_gradients(vertex_quadrature.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> min_timestep = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">          <span class="keywordflow">if</span> (particle_handler.n_particles_in_cell(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>) &gt; 0)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> cell_size = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;minimum_vertex_distance();</div>
<div class="line"> </div>
<div class="line">              fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">              fe_values.get_function_gradients(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, field_gradients);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordtype">double</span> max_E = 0;</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> q_point : fe_values.quadrature_point_indices())</div>
<div class="line">                max_E = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_E, field_gradients[q_point].<a class="code" href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a>());</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">if</span> (max_E &gt; 0)</div>
<div class="line">                min_timestep =</div>
<div class="line">                  <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_timestep,</div>
<div class="line">                           <a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(0.5 * cell_size *</div>
<div class="line">                                     <a class="code" href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Constants::electron_mass</a> /</div>
<div class="line">                                     <a class="code" href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Constants::electron_charge</a> / max_E));</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.set_desired_next_step_size(min_timestep);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>ElectricFieldPostprocessor : <span class="keyword">public</span> <a class="code" href="classDataPostprocessorVector.html">DataPostprocessorVector</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    ElectricFieldPostprocessor()</div>
<div class="line">      : <a class="code" href="classDataPostprocessorVector.html">DataPostprocessorVector</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<span class="stringliteral">&quot;electric_field&quot;</span>, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> evaluate_scalar_field(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="structDataPostprocessorInputs_1_1Scalar.html">DataPostprocessorInputs::Scalar&lt;dim&gt;</a> &amp;input_data,</div>
<div class="line">      <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;computed_quantities)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>.size(),</div>
<div class="line">                      computed_quantities.size());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(computed_quantities[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].<a class="code" href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a>(), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            computed_quantities[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = input_data.<a class="code" href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">solution_gradients</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>];</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> CathodeRaySimulator&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    {</div>
<div class="line">      ElectricFieldPostprocessor&lt;dim&gt; electric_field;</div>
<div class="line">      <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a>                    data_out;</div>
<div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, <span class="stringliteral">&quot;electric_potential&quot;</span>);</div>
<div class="line">      data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, electric_field);</div>
<div class="line">      data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">      data_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(</div>
<div class="line">        <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time(), <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number()));</div>
<div class="line"> </div>
<div class="line">      std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;solution-&quot;</span> +</div>
<div class="line">                           <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number(), 4) +</div>
<div class="line">                           <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">      data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classParticles_1_1DataOut.html">Particles::DataOut&lt;dim, dim&gt;</a> particle_out;</div>
<div class="line">      particle_out.<a class="code" href="classParticles_1_1DataOut.html#adf095165dc286310226584b2b9972701">build_patches</a>(</div>
<div class="line">        particle_handler,</div>
<div class="line">        std::vector&lt;std::string&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>),</div>
<div class="line">        std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;(</div>
<div class="line">          <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>));</div>
<div class="line"> </div>
<div class="line">      particle_out.<a class="code" href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">set_flags</a>(</div>
<div class="line">        <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time(), <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number()));</div>
<div class="line"> </div>
<div class="line">      std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(<span class="stringliteral">&quot;particles-&quot;</span> +</div>
<div class="line">                           <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number(), 4) +</div>
<div class="line">                           <span class="stringliteral">&quot;.vtu&quot;</span>);</div>
<div class="line">      particle_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">CathodeRaySimulator&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_cycles = 3;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0;</div>
<div class="line">         refinement_cycle &lt; n_pre_refinement_cycles;</div>
<div class="line">         ++refinement_cycle)</div>
<div class="line">      {</div>
<div class="line">        setup_system();</div>
<div class="line">        assemble_system();</div>
<div class="line">        solve_field();</div>
<div class="line">        refine_grid();</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    setup_system();</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_step_number() + 1 &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Field degrees of freedom:                 &quot;</span></div>
<div class="line">                  &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_system();</div>
<div class="line">        solve_field();</div>
<div class="line"> </div>
<div class="line">        create_particles();</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Total number of particles in simulation:  &quot;</span></div>
<div class="line">                  &lt;&lt; particle_handler.n_global_particles() &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        n_recently_lost_particles = 0;</div>
<div class="line">        update_timestep_size();</div>
<div class="line">        move_particles();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.advance_time();</div>
<div class="line"> </div>
<div class="line">        output_results();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;  Number of particles lost this time step:  &quot;</span></div>
<div class="line">                  &lt;&lt; n_recently_lost_particles &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">if</span> (n_total_lost_particles &gt; 0)</div>
<div class="line">          std::cout &lt;&lt; <span class="stringliteral">&quot;  Fraction of particles lost through anode: &quot;</span></div>
<div class="line">                    &lt;&lt; 1. * n_particles_lost_through_anode /</div>
<div class="line">                         n_total_lost_particles</div>
<div class="line">                    &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;  Now at t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_current_time()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;, dt=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.get_previous_step_size() &lt;&lt; <span class="charliteral">&#39;.&#39;</span></div>
<div class="line">                  &lt;&lt; std::endl</div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>.is_at_end() == <span class="keyword">false</span>);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step19</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classStep19_1_1CathodeRaySimulator.html">Step19::CathodeRaySimulator&lt;2&gt;</a> cathode_ray_simulator_2d;</div>
<div class="line">      cathode_ray_simulator_2d.<a class="code" href="classStep19_1_1CathodeRaySimulator.html#acceda54ac84d5e31aa1ae329bd1a0381">run</a>();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="aclassDataPostprocessorVector_html"><div class="ttname"><a href="classDataPostprocessorVector.html">DataPostprocessorVector</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__postprocessor_8h_source.html#l00833">data_postprocessor.h:833</a></div></div>
<div class="ttc" id="anamespaceStep19_1_1BoundaryIds_html_ad34dd0ea81c30b8db904e23d54e1b323"><div class="ttname"><a href="namespaceStep19_1_1BoundaryIds.html#ad34dd0ea81c30b8db904e23d54e1b323">Step19::BoundaryIds::open</a></div><div class="ttdeci">constexpr types::boundary_id open</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00063">step-19.cc:63</a></div></div>
<div class="ttc" id="apolynomial__0_8txt_html_af1258c87f1d73d29bd17331843ac1d25"><div class="ttname"><a href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a></div><div class="ttdeci">namespace in which classes relating to the description of d polynomial spaces are declared ***Base class for all D polynomials A polynomial is represented in this class by its coefficients which are set through the constructor or by derived classes There are two paths for evaluation of polynomials One is based on the coefficients which are evaluated through the Horner scheme which is a robust general purpose scheme An alternative and more stable evaluation of high degree polynomials with roots in the unit interval is provided by a product in terms of the roots This form is available for special polynomials such as Lagrange polynomials or Legendre polynomials and used with the respective constructor To obtain this more stable evaluation form the constructor with the roots in form of a Lagrange polynomial must be used In case a manipulation is done that changes the roots the representation is switched to the coefficient form This class is a typical example of a possible template argument for the TensorProductPolynomials class **Constructor The coefficients of the polynomial are passed as and denote the i e the first element of the array denotes the constant the second the linear and so on The degree of the polynomial represented by this object is thus the number of elements in the&lt; tt &gt; coefficient&lt;/tt &gt; array minus one **Constructor creating a zero polynomial of degree *[2.x.3] *Constructor for a Lagrange polynomial and its point of evaluation The idea is to where j is the evaluation point specified as argument and the support points contain all the evaluation is based on products of the whereas the Horner scheme is used for polynomials in the coefficient form **Return the values and the derivatives of the Polynomial at point&lt; tt &gt; x&lt;/tt &gt;&lt; tt &gt; i</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__0_8txt_source.html#l00024">polynomial_0.txt:24</a></div></div>
<div class="ttc" id="anamespaceStep19_1_1Constants_html_a4e3b1121a8f508ed1526c4b407c7aaa1"><div class="ttname"><a href="namespaceStep19_1_1Constants.html#a4e3b1121a8f508ed1526c4b407c7aaa1">Step19::Constants::V0</a></div><div class="ttdeci">constexpr double V0</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00074">step-19.cc:74</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a79cbe2f02f8dfb85026c71d783dbb703"><div class="ttname"><a href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out__dof__data_8h_source.html#l01096">data_out_dof_data.h:1096</a></div></div>
<div class="ttc" id="aclassArrayView_html_a1a1c62a26e5f55bfe124894c0a31386f"><div class="ttname"><a href="classArrayView.html#a1a1c62a26e5f55bfe124894c0a31386f">ArrayView::begin</a></div><div class="ttdeci">iterator begin() const</div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00602">array_view.h:602</a></div></div>
<div class="ttc" id="aclassFEValues_html_a21f914e63d588e2652a9514620653d77"><div class="ttname"><a href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell)</div></div>
<div class="ttc" id="anewton__0_8txt_html_af4dc1cb00f59a52e48df46a4c205a8e6"><div class="ttname"><a href="newton__0_8txt.html#af4dc1cb00f59a52e48df46a4c205a8e6">number</a></div><div class="ttdeci">*Operator class performing Newton s iteration with standard step size control and adaptive matrix generation This class performs a Newton iteration up to convergence determined by control If after an update the norm of the residual has become larger then step size control is activated and the update is subsequently divided by two until the residual actually becomes depending on the tends to be this method applies an adaptive reassembling strategy Only if the reduction factor for the residual is more than receiving the applications computing the residual and solving the linear respectively **Declare the parameters applicable to Newton s method **Read the parameters in the ParameterHandler **Initialize the pointer data_out for debugging **The actual Newton iteration The initial value is in&lt; tt &gt; which also contains the result after convergence Values in&lt; tt &gt; in&lt;/tt &gt; are not used by but will be handed down to the objects **Set the maximal residual reduction allowed without triggering assembling in the next step Return the previous value **Control object for the Newton iteration **The indicating that the matrix must be assembled anew upon start **A flag used to decide how many stepsize iteration should be made Default is the original value of Enter zero here to turn off stepsize control *Controlled by&lt; tt &gt; Stepsize iterations&lt;/tt &gt; in parameter file **Threshold for re assembling matrix If the quotient of two consecutive residuals is smaller than this the system matrix is not assembled in this step *This parameter should be adjusted to the residual gain of the inner solver The default values is resulting in reassembling in every Newton step **Print update and updated solution after each step into file&lt; tt &gt; Newton_NNN&lt;/tt &gt; **Write debug output to[2.x.3] the higher the number</div><div class="ttdef"><b>Definition:</b> <a href="newton__0_8txt_source.html#l00034">newton_0.txt:34</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="aclassParticles_1_1ParticleHandler_html_acaf1232ffce0746baa64122a5c65822e"><div class="ttname"><a href="classParticles_1_1ParticleHandler.html#acaf1232ffce0746baa64122a5c65822e">Particles::ParticleHandler::particles_in_cell</a></div><div class="ttdeci">particle_iterator_range particles_in_cell(const typename Triangulation&lt; dim, spacedim &gt;::active_cell_iterator &amp;cell)</div><div class="ttdef"><b>Definition:</b> <a href="particle__handler_8cc_source.html#l00318">particle_handler.cc:318</a></div></div>
<div class="ttc" id="aclassArrayView_html_a775e02d2deaf2f769e24dee0c3e7a582"><div class="ttname"><a href="classArrayView.html#a775e02d2deaf2f769e24dee0c3e7a582">ArrayView::end</a></div><div class="ttdeci">iterator end() const</div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00611">array_view.h:611</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00077">fe_update_flags.h:77</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_afec1b694405cadb2d251275096ad3563"><div class="ttname"><a href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a></div><div class="ttdeci">if we even only hold bytes per line in this sparsity we ll need GB for this object even if every single line is empty Of only million lines will be non for which we need MB plus whatever is necessary to store the actual column indices of nonzero entries Let s say we have a moderately complex problem with entries per for each of which we store the column index worth then we ll need bytes for each of the million lines that correspond to the degrees of freedom we for a total of GB And we ll need bytes for each of the million lines that we don t for a total of GB It is clear that this ratio doesn t become any better if we go to even higher numbers of processors *The solution to this problem is to really only use any memory at all for those parts of the linear system that we or need for some other reason For all other we must know that they but we can not set up any part of our data structure To this there exists a class called IndexSet that denotes a set of indices which we care for and for which we may have to allocate memory The data structures for sparsity patterns constraint matrices matrices and vector can be initialized with these IndexSet objects to really only care for those rows or entries that correspond to indices in the index set and not care about all others These objects will then ask how many indices exist in the set allocate memory for each one of and when you want to access data for global degree of freedom[2.x.28] you will be redirected to the result of calling[2.x.29] with index[2.x.30] instead Accessing data for elements[2.x.31] for which[2.x.32] is false will yield an error *The remaining question is how to identify the set of indices that correspond to degrees of freedom we need to worry about on each processor To this you can use the[2.x.33] function to get at all the indices a processor owns Note that this is a subset of the degrees of freedom that are defined on the locally owned one sometimes needs the set of all degrees of freedom on the locally owned subdomain as well as the adjacent ghost cells This information is provided by the[2.x.35] function ***A typical parallel application is dealing with two different kinds of parallel but there are of course different vector types that can each represent both ghosted vectors are typically used for data output</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00059">distributed_0.txt:59</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_adcfa97993e5162228eec03e06ac05330"><div class="ttname"><a href="distributed__0_8txt.html#adcfa97993e5162228eec03e06ac05330">at</a></div><div class="ttdeci">********clusters ***deal II can use multiple machines connected via MPI to parallelize in addition to the parallelization within a shared memory machine discussed in the[2.x.4] module There are essentially two ways to utilize multiple but only a share of the global sparsity and solution vector is stored on each machine ****The mesh and DoF handler are also i e each processor stores only a share of the cells and degrees of freedom No processor has knowledge of the entire or and in fact problems solved in this mode are usually so and handling distributed and linear solvers is something for which good external libraries such as Trilinos or PETSc exist that can make things look almost exactly the same as they would if everything was available locally The use of this mode of parallelization is explained in the tutorial and[2.x.6] and will not be discussed here in more detail *The use of truly distributed meshes is somewhat more complex because it changes or makes impossible some of the things that can otherwise be done with deal II DoF etc This module documents these issues with a vantage point at</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00027">distributed_0.txt:27</a></div></div>
<div class="ttc" id="afunction__restriction__0_8txt_html_a93564637b88550ce91447da5d5661dc2"><div class="ttname"><a href="function__restriction__0_8txt.html#a93564637b88550ce91447da5d5661dc2">open</a></div><div class="ttdeci">*This class takes a function in dim dimensions and creates a new function in one dimension lower by restricting one of the coordinates to a given value Mathematically this corresponds to taking a a fixed and defining a new this translates to **The dim dimensional coordinates on the restriction are ordered starting from the this means that if the[2.x.3] coordinate is locked to[2.x.4] the coordinates are ordered as[2.x.5] on the takes so the function must have a longer lifetime than the created restriction **This class creates a dimensional function from a dim dimensional function by restricting dim of the coordinate values to a given point Mathematically this corresponds to taking a and a and defining a new function[2.x.10] Using this this translates to **The coordinates of the point will be expanded in the higher dimensional functions coordinates starting from the open if we restrict to a point[2.x.11] and choose to keep the y direction open</div><div class="ttdef"><b>Definition:</b> <a href="function__restriction__0_8txt_source.html#l00010">function_restriction_0.txt:10</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__cg_8h_source.html#l00088">solver_cg.h:88</a></div></div>
<div class="ttc" id="apetsc__precondition__0_8txt_html_a41ebb2d49faa97a3d9eab4b4f13c2742"><div class="ttname"><a href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a></div><div class="ttdeci">*Base class for preconditioner classes using the PETSc functionality The classes in this hierarchy don t do a whole lot except for providing a function that sets the preconditioner and certain parameters on the preconditioning context of the solver These classes are basically here only to allow a similar interface as already used for the deal II solver and preconditioner classes Note that derived classes only provide interfaces to the relevant functionality of PETSc PETSc does not implement all preconditioners for all matrix types In particular some preconditioners are not going to work for parallel jobs such as for example the ILU preconditioner ***Constructor **Destructor **Destroys the preconditioner</div><div class="ttdef"><b>Definition:</b> <a href="petsc__precondition__0_8txt_source.html#l00002">petsc_precondition_0.txt:2</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a8fba07b9a84b89e6be225f5f95c3e355"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div><div class="ttdeci">the program is just and one can not intelligently work around that *It is sometimes useful to change the behavior of the[2.x.6] macro from aborting a program to throwing exceptions On the other exceptions are not allowed to propagate out of destructors of classes For this there is a variant of the called[2.x.7] that can be used in destructors These use cases are discussed further down below on this page **Dynamic such as whether an output file can be written to *These are things that shouldn t be checked because it is not guaranteed that a program for which the condition is satisfied in a debug mode run</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00022">exceptions_0.txt:22</a></div></div>
<div class="ttc" id="astructDataPostprocessorInputs_1_1Scalar_html_a43cf8ae15e93c88dc41aed35b42eadd3"><div class="ttname"><a href="structDataPostprocessorInputs_1_1Scalar.html#a43cf8ae15e93c88dc41aed35b42eadd3">DataPostprocessorInputs::Scalar::solution_gradients</a></div><div class="ttdeci">std::vector&lt; Tensor&lt; 1, spacedim &gt; &gt; solution_gradients</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__postprocessor_8h_source.html#l00264">data_postprocessor.h:264</a></div></div>
<div class="ttc" id="aparticle__handler__0_8txt_html_a5ebacea68cda561e1adc199d23e1de40"><div class="ttname"><a href="particle__handler__0_8txt.html#a5ebacea68cda561e1adc199d23e1de40">n_particles_in_cell</a></div><div class="ttdeci">*This class manages the storage and handling of particles It provides the data structures necessary to store particles efficiently accessor functions to iterate over particles and find particles and algorithms to distribute particles in parallel domains Note that the class is designed in a similar way as the triangulation class In particular we call particles in the domain of the local process local particles and particles that belong to neighbor processes and live in the ghost cells around the locally owned domain ghost particles This class is used in *[2.x.0] **A type that can be used to iterate over all particles in the domain **A type that represents a range of particles **Default constructor **Constructor that initializes the particle handler with a given triangulation and mapping Since particles are stored in respect to their surrounding cells this information is necessary to correctly organize the particle collection This constructor is equivalent to calling the default constructor and the initialize function **Destructor **Initialize the particle handler This function does not clear the internal data it just sets the triangulation and the mapping to be used **Copy the state of particle handler[2.x.2] into the current object This will copy all particles and properties and leave this object as an identical copy of[2.x.3] Existing particles in this object are deleted Be aware that this does not copy functions that are connected to the signals of[2.x.4] nor does it connect the current object s member functions to triangulation which must be done by the caller if that is if the[2.x.5] had connected functions This function is expensive as it has to duplicate all data in[2.x.6] and insert it into this which may be a significant amount of data it can be useful to save the state of a particle collection at a certain point in time and reset this state later under certain for example if a timestep has to be undone and repeated **Clear all particle related data **Only clear particle but keep cache information about number of particles This is useful during reorganization of particle data between processes **Update all internally cached numbers Note that all functions that modify internal data structures and act on multiple particles will call this function while functions that act on single particles will not call this it is not an efficient function to use if the number of particles is large That is because to find the particles that are located in one cell costs[2.x.9] where[2.x.10] is the number of overall particles Since you will likely do this for every and assuming that the number of particles and the number of cells are roughly you end up with an[2.x.11] algorithm A better approach is to use the fact that particles are arranged in the order of the active cells they are in In other if you iterate over all you will encounter them in the same order as you walk over the active cells You can exploit this by keeping an iterator to the first particle of the first and when you move to the next you increment the particle iterator as well until you find a particle located on that next cell Counting how many steps this took will then give you the number you are looking at a cost of[2.x.12] when accumulated over all cells This is the approach used for example The approach is also detailed in the Possibilities for extensions section of *[2.x.14] *Return a pair of particle iterators that mark the begin and end of the particles in a particular cell The last iterator is the first particle that is no longer in the cell The number of elements in the returned range equals what the n_particles_in_cell() function returns. *[2.x.15] While this function is used in[2.x.16]</div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespaceUtilities_html_a6195c5f009ea8c7c536c6ffdf108c32f"><div class="ttname"><a href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></div><div class="ttdeci">std::string int_to_string(const unsigned int value, const unsigned int digits=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00473">utilities.cc:473</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2namespace__dealii_8h_source.html#l00026">namespace_dealii.h:26</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_aada8380792b5e6a1f91dcba94b558cb8"><div class="ttname"><a href="classFEValuesBase.html#aada8380792b5e6a1f91dcba94b558cb8">FEValuesBase::quadrature_point_indices</a></div><div class="ttdeci">std_cxx20::ranges::iota_view&lt; unsigned int, unsigned int &gt; quadrature_point_indices() const</div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00070">fe_update_flags.h:70</a></div></div>
<div class="ttc" id="anamespaceStep19_1_1BoundaryIds_html_a93a0d4c7e51e6dd495d9e2d373ce46e9"><div class="ttname"><a href="namespaceStep19_1_1BoundaryIds.html#a93a0d4c7e51e6dd495d9e2d373ce46e9">Step19::BoundaryIds::focus_element</a></div><div class="ttdeci">constexpr types::boundary_id focus_element</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00065">step-19.cc:65</a></div></div>
<div class="ttc" id="aiterators__0_8txt_html_a6cf0880ba2af3a1be4aacdbbd4b90f9c"><div class="ttname"><a href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a></div><div class="ttdeci">where BaseIterator usually is one of thestandard iterators discussed above *The FilteredIterator gets an additional Predicate in its constructor and willskip all objects where this Predicate evaluates to&lt; tt &gt; false&lt;/tt &gt; Acollection of predicates already implemented can be found in the namespaceIteratorFilters ***IteratorsLoops Iterating over objects *All iterators of the same kind and iterating over thesame kind of geometrical objects traverse the mesh in the sameorder Take this code all iterators will always point to the same mesh even though&lt; tt &gt; DoFHandler&lt;/tt &gt; and&lt; tt &gt; Triangulation&lt;/tt &gt; are very different and even if the DoFHandlers are handling different finite the difference is only in the Accessor As mentioned the order in which iterators traverse the forest ofobjects is actually well but application programs should notassume any such but rather consider this an implementation detailof the library *Corresponding to above the order in which iterators traverse activeobjects is the same for all iterators in the following the difference to the previous example being that here we only consider active but theyare really rather dumb Their magic only lies in the fact that they point tosome useful in this case the Accessor For they point to anactual object that stores some data On the other the deal II when do not return a reference to an actual but returnan object that knows how to get at the data that represents cells In thisobject doesn t store itself where the vertices of a cell are or what its neighborsare it knows how to tease this sort of information from out of thearrays and tables and lists that the Triangulation class sets up to describe amesh *Accessing data that characterizes a cell is always done through the i e the expression[2.x.10] grants access to[1.x.6] attributes of this Accessor Examples of properties you can query from aniterator are ***Since dereferencing iterators yields accessor these calls are tomember etc These in turn figure out the relevant datafrom the various data structures that store this data How this is actuallydone and what data structures are used is not really of concern to authors ofapplications in deal II In by hiding the actual data structureswe are able to store data in an efficient not necessarily in a way thatmakes it easily accessible or understandable to application writers ***IteratorsTypedefs Kinds of accessors *Depending on what sort of data you want to there are different kindsof accessor and hexes that make up a triangulation</div><div class="ttdef"><b>Definition:</b> <a href="iterators__0_8txt_source.html#l00063">iterators_0.txt:63</a></div></div>
<div class="ttc" id="aclassStep19_1_1CathodeRaySimulator_html"><div class="ttname"><a href="classStep19_1_1CathodeRaySimulator.html">Step19::CathodeRaySimulator</a></div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00084">step-19.cc:84</a></div></div>
<div class="ttc" id="ageodynamics__0_8txt_html_a47b3a2cd492d04754f4796002e14ed13"><div class="ttname"><a href="geodynamics__0_8txt.html#a47b3a2cd492d04754f4796002e14ed13">solver</a></div><div class="ttdeci">all others have started as modifications of one of the tutorial programs *The tutorial programs we propose to write will provide students and researchers with a reference implementation of current numerical technology such as higher order sophisticated linear and nonlinear stabilization etc Providing these as starting points for further development by others will also serve the goal of training a new generation of geodynamicists in modern numerical algorithms *In deal it is fairly simple to extend a set of equations by another for example an additional advected quantity that enters the existing equations as a right hand side or in one of the coefficients Since applications typically use blocked matrices rather than the one big matrix for everything it is also not complicated to find suitable linear solvers for augmented equations deal II is a good tool for trying out more complex formulations of or more complete models and their effects on the accuracy of solutions *deal II provides many interchangeable components that allow rapid prototyping of finite element kinds and stabilization or linear solvers For typically only a few lines of code have to be changed to replace low order by high order elements Through it becomes relatively simple to try out higher order a different block elimination solver</div><div class="ttdef"><b>Definition:</b> <a href="geodynamics__0_8txt_source.html#l00033">geodynamics_0.txt:33</a></div></div>
<div class="ttc" id="astep-1_8cc_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition:</b> <a href="step-1_8cc_source.html#l00086">step-1.cc:86</a></div></div>
<div class="ttc" id="astructCellData_html"><div class="ttname"><a href="structCellData.html">CellData</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria__description_8h_source.html#l00054">tria_description.h:54</a></div></div>
<div class="ttc" id="anamespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aeadde91684ebb2c6ec5c5c5293123f6a04"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeadde91684ebb2c6ec5c5c5293123f6a04">EvaluationFlags::gradients</a></div><div class="ttdeci">@ gradients</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2evaluation__flags_8h_source.html#l00060">evaluation_flags.h:60</a></div></div>
<div class="ttc" id="areference__cell__0_8txt_html_a14fb536d69bd51b1ccdb58bd99e7bffe"><div class="ttname"><a href="reference__cell__0_8txt.html#a14fb536d69bd51b1ccdb58bd99e7bffe">Now</a></div><div class="ttdeci">it is an object of type MappingFE initialized with with or with the term linear in the name of the function has to be understood as[2.x.19] QGaussWedge[2.x.20] n_points_1D The number of quadrature points in each if the current object is[2.x.26] then face_no must be between in the interval[2.x.27] and the function will always return[2.x.28] If the current object is[2.x.29] then face_no must be between in the interval[2.x.30] and the function will always return[2.x.31] For wedges and the returned object may be either[2.x.32] or[2.x.33] depending on the given index ****Relationships between objects in the cell and on faces *[2.x.36] *Return which child cells are adjacent to a certain face of the mother cell For in the layout of a quadrilateral cell is as faces also with their directions Now</div><div class="ttdef"><b>Definition:</b> <a href="reference__cell__0_8txt_source.html#l00069">reference_cell_0.txt:69</a></div></div>
<div class="ttc" id="amultithreading__0_8txt_html_a0759c0124e216ec36f063ad051f4dba0"><div class="ttname"><a href="multithreading__0_8txt.html#a0759c0124e216ec36f063ad051f4dba0">norm</a></div><div class="ttdeci">it should be big enough so that we don t spend more time on scheduling sub ranges to processors but small enough that processors can be efficiently load balanced A rule of thumb appears to be that a sub range is too small if it takes less than instructions to execute it *An example of how to use these functions are vector operations like the addition in[2.x.45] where all three objects are of type we used a[1.x.23] to on the a function object that takes two arguments and returns the sum of the two This is exactly what we needed when we want to add the individual elements of vectors[2.x.46] and[2.x.47] and write the sum of the two into the elements of[2.x.48] The function object that we get here is completely known to the compiler and when it expands the loop that results from[2.x.49] will be as if we had written the loop in its obvious thereby eliminating the overhead of calling an external function there are cases where it is inefficient to call some object or function within each iteration *An example for this case is sparse matrix vector multiplication If you know how data is stored in compressed row format like in the SparseMatrix then a matrix vector product function looks like we compute the dot product of a single row of the matrix with the right hand side vector[2.x.51] and write it into the corresponding element of the[2.x.52] vector The code is made more efficient by utilizing that the elements of the[1.x.28] row follow the ones of the current i e at the beginning of the loop body we do not have to re set the pointers that point to the values and column numbers of each row *Using the[2.x.53] function we could in principle write this code as leaving one argument open and thus allowing the[2.x.56] function to consider the passed function argument as unary Also note that we need to make the source and destination vectors neither of which is what we desired notice the grainsize of a minimum of rows of a matrix that should be processed by an individual CPU core *The point is that while this is it is not since now the function object to be called on each row is not a simple[1.x.32] any there is an implicit function call including argument passing in each iteration of the loop *A more efficient way is to let TBB split the original range into sub and then call a target function not on each individual element of the but on the entire range This is facilitated by the[2.x.61] we call the[2.x.62] function on sub ranges of at least elements so that the initial setup cost can amortize *A related operation is when the loops over elements each produce a result that must then be but let s assume for a moment that it is A sequential implementation would look like this for sparse each of which compute their part of the square of the norm</div><div class="ttdef"><b>Definition:</b> <a href="multithreading__0_8txt_source.html#l00124">multithreading_0.txt:124</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8h_source.html#l01033">tria.h:1033</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="afe_2fe__q_8h_html"><div class="ttname"><a href="fe_2fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="ampi__remote__point__evaluation__0_8txt_html_a45c57074a631760cdab557f450e880e0"><div class="ttname"><a href="mpi__remote__point__evaluation__0_8txt.html#a45c57074a631760cdab557f450e880e0">mapping</a></div><div class="ttdeci">*Helper class to access values on non matching grids *The name of the fields are chosen with the method quantities are computed at specified arbitrary positioned which receive the result and resort the result according to the points **Constructor[2.x.1] tolerance Tolerance in terms of unit cell coordinates for determining all cells around a point passed to the class during it might be necessary to adjust the tolerance in order to be able to identify a cell Floating point arithmetic implies that a point in not lie exactly on a or face[2.x.2] enforce_unique_mapping Enforce unique mapping</div><div class="ttdef"><b>Definition:</b> <a href="mpi__remote__point__evaluation__0_8txt_source.html#l00005">mpi_remote_point_evaluation_0.txt:5</a></div></div>
<div class="ttc" id="aclassMappingQGeneric_html"><div class="ttname"><a href="classMappingQGeneric.html">MappingQGeneric&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespaceGridRefinement_html_a48e5395381ed87155942a61a1edd134d"><div class="ttname"><a href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a></div><div class="ttdeci">void refine_and_coarsen_fixed_number(Triangulation&lt; dim, spacedim &gt; &amp;triangulation, const Vector&lt; Number &gt; &amp;criteria, const double top_fraction_of_cells, const double bottom_fraction_of_cells, const unsigned int max_n_cells=std::numeric_limits&lt; unsigned int &gt;::max())</div><div class="ttdef"><b>Definition:</b> <a href="grid_2grid__refinement_8cc_source.html#l00322">grid_refinement.cc:322</a></div></div>
<div class="ttc" id="adofs__0_8txt_html_ae704d52abb496c815f42849c4de0f458"><div class="ttname"><a href="dofs__0_8txt.html#ae704d52abb496c815f42849c4de0f458">direction</a></div><div class="ttdeci">among its functions are ones that sort degrees of freedom in downstream direction</div><div class="ttdef"><b>Definition:</b> <a href="dofs__0_8txt_source.html#l00009">dofs_0.txt:9</a></div></div>
<div class="ttc" id="anumerics_2error__estimator_8h_html"><div class="ttname"><a href="numerics_2error__estimator_8h.html">error_estimator.h</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Scalar_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00095">fe_values_extractors.h:95</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_ac25ec6835799c3b6c7c842f8acb05eb3"><div class="ttname"><a href="classFEValuesBase.html#ac25ec6835799c3b6c7c842f8acb05eb3">FEValuesBase::normal_vector</a></div><div class="ttdeci">const Tensor&lt; 1, spacedim &gt; &amp; normal_vector(const unsigned int i) const</div></div>
<div class="ttc" id="amapping__q__generic__0_8txt_html_ac7cd8e58269a91d2c5ebf4f3b594c5d7"><div class="ttname"><a href="mapping__q__generic__0_8txt.html#ac7cd8e58269a91d2c5ebf4f3b594c5d7">location</a></div><div class="ttdeci">a full discussion of manifolds is provided in *[2.x.8] ***If you are working on meshes that describe i if then every cell is at the boundary of the domain you will likely already have attached a manifold object to all cells that can then also be used by the mapping classes for higher order mappings **As described one often only knows a manifold description of a surface but not the interior of the computational domain In such a a FlatManifold object will be assigned to the interior entities that describes a usual planar coordinate system where the additional points for the higher order mapping are placed exactly according to a bi trilinear mapping When combined with a non flat manifold on the for example a circle bulging into the interior of a square the two manifold descriptions are in general incompatible For a FlatManifold defined solely through the cell s vertices would put an interior point located at some small distance epsilon away from the boundary along a straight line and thus in general outside the concave part of a circle If the polynomial degree of MappingQ is sufficiently the transformation from the reference cell to such a cell would in general contain inverted regions close to the boundary *In order to avoid this this class applies an algorithm for making this transition smooth using a so called transfinite interpolation that is essentially a linear blend between the descriptions along the surrounding entities In the algorithm that computes additional points the all the entities of the cells are passed through starting from the lines to the quads and finally hexes Points on objects higher up in the hierarchy are obtained from the manifold associated with that taking into account all the points previously computed by the manifolds associated with the lower dimensional not just the vertices If only a line is assigned a curved boundary but the adjacent quad is on a flat the flat manifold on the quad will take the points on the deformed line into account when interpolating the position of the additional points inside the quad and thus always result in a well defined transformation *The interpolation scheme used in this class makes sure that curved descriptions can go over to flat descriptions within a single layer of elements maintaining the overall optimal convergence rates of the finite element interpolation However one does often get better solution qualities if the transition between curved boundaries and flat interior domains is spread over a larger range as the mesh is refined This is provided by the special manifold TransfiniteInterpolationManifold ***Constructor[2.x.9] denotes the polynomial degree of the polynomials that are used to map cells from the reference to the real cell **Copy constructor **Return the degree of the i e the value which was passed to the constructor **Always returns[2.x.10] because the default implementation of functions in this class preserves vertex locations **Mapping points between reference and real cells *[2.x.12] ***Functions to transform tensors from reference to real coordinates *[2.x.15] ***Interface with FEValues and friends *[2.x.18] *Storage for internal data of polynomial mappings See[2.x.19] for an extensive description For the current the InternalData class stores data that is computed once when the object is or this function calls or higher order derivatives are computed is determined by which of the member arrays have nonzero sizes They are typically set to their appropriate sizes by the which indeed call this function internally it is in[2.x.20] and need to re compute the mapping and its derivatives at this location</div><div class="ttdef"><b>Definition:</b> <a href="mapping__q__generic__0_8txt_source.html#l00050">mapping_q_generic_0.txt:50</a></div></div>
<div class="ttc" id="afe__base__0_8txt_html_ab42576dfdd4ffe69354987b53ad19f20"><div class="ttname"><a href="fe__base__0_8txt.html#ab42576dfdd4ffe69354987b53ad19f20">which</a></div><div class="ttdeci">this is so despite the fact that the element has a shape function of the which</div><div class="ttdef"><b>Definition:</b> <a href="fe__base__0_8txt_source.html#l00153">fe_base_0.txt:153</a></div></div>
<div class="ttc" id="aclassSparseMatrix_html"><div class="ttname"><a href="classSparseMatrix.html">SparseMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassFunctions_1_1ConstantFunction_html"><div class="ttname"><a href="classFunctions_1_1ConstantFunction.html">Functions::ConstantFunction&lt; dim &gt;</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_aafea668ad0c451ac7a0fae0f558c36d7"><div class="ttname"><a href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a></div><div class="ttdeci">in the area occupied by these artificial cells</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00037">distributed_0.txt:37</a></div></div>
<div class="ttc" id="anamespaceStep19_1_1Constants_html_a516fb864517c8db6f612b8a0119c1d27"><div class="ttname"><a href="namespaceStep19_1_1Constants.html#a516fb864517c8db6f612b8a0119c1d27">Step19::Constants::E_threshold</a></div><div class="ttdeci">constexpr double E_threshold</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00076">step-19.cc:76</a></div></div>
<div class="ttc" id="aclassParticles_1_1ParticleHandler_html_a655ae2bdfe026f1ed172a2ec4c6c3d60"><div class="ttname"><a href="classParticles_1_1ParticleHandler.html#a655ae2bdfe026f1ed172a2ec4c6c3d60">Particles::ParticleHandler::particle_iterator_range</a></div><div class="ttdeci">boost::iterator_range&lt; particle_iterator &gt; particle_iterator_range</div><div class="ttdef"><b>Definition:</b> <a href="particles_2particle__handler_8h_source.html#l00073">particle_handler.h:73</a></div></div>
<div class="ttc" id="aclassDataOutInterface_html_a93c780f93105e0daaa76c6c43694b4ae"><div class="ttname"><a href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">DataOutInterface::write_vtu</a></div><div class="ttdeci">void write_vtu(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07232">data_out_base.cc:7232</a></div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a93f65b0385560a34ec1d3c5ec5a882b8"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">Physics::Elasticity::Kinematics::d</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; d(const Tensor&lt; 2, dim, Number &gt; &amp;F, const Tensor&lt; 2, dim, Number &gt; &amp;dF_dt)</div></div>
<div class="ttc" id="aconstraints__0_8txt_html_a9132c79972fe954d265b941f34bebed9"><div class="ttname"><a href="constraints__0_8txt.html#a9132c79972fe954d265b941f34bebed9">the</a></div><div class="ttdeci">******This module deals with constraints on degrees of freedom The central class to deal with constraints is the AffineConstraints class *Constraints typically come from several for one usually enforces them by requiring that degrees of freedom on the boundary have particular for example[2.x.3] if the boundary condition[2.x.4] requires that the finite element solution[2.x.5] at the location of degree of freedom has the value Such constraints are generated by those versions of the[2.x.6] function that take a AffineConstraints for example no normal as happens in flow problems and is handled by the[2.x.11] function or prescribed tangential as happens in electromagnetic problems and is handled by the[2.x.13] function For the former imagine for example that we are at at vertex where the normal vector has the form[2.x.14] and that the[2.x.15]</div><div class="ttdef"><b>Definition:</b> <a href="constraints__0_8txt_source.html#l00020">constraints_0.txt:20</a></div></div>
<div class="ttc" id="alac_2affine__constraints_8h_html"><div class="ttname"><a href="lac_2affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="aclassParticles_1_1ParticleIterator_html"><div class="ttname"><a href="classParticles_1_1ParticleIterator.html">Particles::ParticleIterator</a></div><div class="ttdef"><b>Definition:</b> <a href="particles_2particle__iterator_8h_source.html#l00040">particle_iterator.h:40</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_ac2b339f054fd752a401e197097db8cfe"><div class="ttname"><a href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a></div><div class="ttdeci">********clusters ***deal II can use multiple machines connected via MPI to parallelize in addition to the parallelization within a shared memory machine discussed in the[2.x.4] module There are essentially two ways to utilize multiple but only a share of the global sparsity and solution vector is stored on each machine ****The mesh and DoF handler are also i e each processor stores only a share of the cells and degrees of freedom No processor has knowledge of the entire or solution</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00025">distributed_0.txt:25</a></div></div>
<div class="ttc" id="aparameter__handler__0_8txt_html_ad919e2b915d8e8226aef004c2d8399a8"><div class="ttname"><a href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">exception</a></div><div class="ttdeci">since default values may change in the process of program you cannot know the values of parameters not specified in the input file ****It is often convenient to have something happen as soon as a parameter value is read This could be a check that it is valid that a file that is listed in the parameter file exists **or to initiate something else in such as setting a variable outside the this action could also be initiated once all parameters are read via but it is sometimes[1.x.19] to do it right away *This is facilitated by the and can then do whatever they want with it **e save it somewhere outside the ParameterHandler in C one doesn t usually pass around the address of a but an action can be a function like object(taking a string as argument) that results from calling such as a[1.x.20] that has the form **[1.x.21] *and that is attached to a specific parameter. *A typical example of such an action would be as follows the content of the file equals the default value of the parameter the contents of files are never changed after declaration of a parameter a directory in this file system may not have a file called[2.x.20] in it In that the directory represents a subsection as declared and the directory s name will correspond to the name of the subsection It will then have no files in it at but it may have further directories in the code above will lead to a hierarchical representation of data that looks like this(the content of files is indicated at the right in a different font) this is only used when creating output for exceptions If non empty[2.x.35] is the ParameterHandler object will stop parsing lines after encountering[2.x.36] This is handy when adding extra data that shall be parsed manually If[2.x.37] the parameter handler will skip undefined sections and entries This is useful for partially parsing a parameter for example to obtain only the spatial dimension of the problem By default all entries and subsections are expected to be declared The function sets the value of all parameters it encounters in the input file to the provided value Parameters not explicitly listed in the input file are left at the value they previously which will be the default value provided to and for each parameter all associated actions that may previously have been set by or if an associated action throws an exception</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler__0_8txt_source.html#l00241">parameter_handler_0.txt:241</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a6ed7c846331069f406b8c9933c37fda4"><div class="ttname"><a href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandler&lt; dim, spacedim &gt; &amp;)</div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00266">dof_handler.h:266</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_ad1f4e0deb5d982e8172d82141c634a67"><div class="ttname"><a href="classFEValuesBase.html#ad1f4e0deb5d982e8172d82141c634a67">FEValuesBase::get_function_gradients</a></div><div class="ttdeci">void get_function_gradients(const InputVector &amp;fe_function, std::vector&lt; Tensor&lt; 1, spacedim, typename InputVector::value_type &gt;&gt; &amp;gradients) const</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8cc_source.html#l03664">fe_values.cc:3664</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a></div><div class="ttdeci">@ component_is_part_of_vector</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00062">data_component_interpretation.h:62</a></div></div>
<div class="ttc" id="asolver__cg__0_8txt_html_a557c71e94a2542d697ca3426b8843cd4"><div class="ttname"><a href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">sqrt</a></div><div class="ttdeci">*This class implements the preconditioned Conjugate but is used in many other tutorial programs as well Like all other solver it can work on any kind of vector and matrix as long as they satisfy certain and defaults to *[2.x.2] **This version of CG is taken from D Braess s book Finite Elements It requires a symmetric the projected matrix[2.x.4] is tri diagonal Since the projection is the eigenvalues of[2.x.5] approximate those of the original preconditioned matrix[2.x.6] In after[2.x.7] where[2.x.8] is the dimension of the original the eigenvalues of both matrices are equal even for small numbers of iteration the condition number of[2.x.9] is a good estimate for the one of *[2.x.10] After[2.x.11] steps the matrix T_m can be written in terms of the coefficients[2.x.12] and[2.x.13] as the tri diagonal matrix with diagonal elements&lt; tt &gt;&lt; tt &gt; alpha_1 beta_0&lt; tt &gt;&lt; tt &gt; sqrt(beta_{m-2&lt;/tt &gt;)/alpha_</div><div class="ttdef"><b>Definition:</b> <a href="solver__cg__0_8txt_source.html#l00011">solver_cg_0.txt:11</a></div></div>
<div class="ttc" id="anamespaceStep19_1_1BoundaryIds_html_a1348f59a451109003fe3d85d6a2edd8a"><div class="ttname"><a href="namespaceStep19_1_1BoundaryIds.html#a1348f59a451109003fe3d85d6a2edd8a">Step19::BoundaryIds::anode</a></div><div class="ttdeci">constexpr types::boundary_id anode</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00066">step-19.cc:66</a></div></div>
<div class="ttc" id="aclassDoFHandler_html_a553ca864aaf70330d9be86bc78f36d1e"><div class="ttname"><a href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">DoFHandler::distribute_dofs</a></div><div class="ttdeci">void distribute_dofs(const FiniteElement&lt; dim, spacedim &gt; &amp;fe)</div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00116">fe_update_flags.h:116</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_a2cbf5ad6b464871261dbd054bced18a8"><div class="ttname"><a href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">FiniteElementData::degree</a></div><div class="ttdeci">const unsigned int degree</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__base_8h_source.html#l00428">fe_base.h:428</a></div></div>
<div class="ttc" id="aclassFEPointEvaluation_html"><div class="ttname"><a href="classFEPointEvaluation.html">FEPointEvaluation</a></div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2fe__point__evaluation_8h_source.html#l00396">fe_point_evaluation.h:396</a></div></div>
<div class="ttc" id="aclassParticles_1_1Particle_html_a57efa2034baca617ba3160ccfbbc7cd7"><div class="ttname"><a href="classParticles_1_1Particle.html#a57efa2034baca617ba3160ccfbbc7cd7">Particles::Particle::set_reference_location</a></div><div class="ttdeci">void set_reference_location(const Point&lt; dim &gt; &amp;new_reference_location)</div><div class="ttdef"><b>Definition:</b> <a href="particles_2particle_8h_source.html#l00473">particle.h:473</a></div></div>
<div class="ttc" id="anamespaceStep19_1_1Constants_html_a720939d8c325360146b87a1719ff55fd"><div class="ttname"><a href="namespaceStep19_1_1Constants.html#a720939d8c325360146b87a1719ff55fd">Step19::Constants::electrons_per_particle</a></div><div class="ttdeci">constexpr double electrons_per_particle</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00078">step-19.cc:78</a></div></div>
<div class="ttc" id="aclassParticles_1_1Particle_html_afbe52b594cf4a8dd11431679c4ef2b52"><div class="ttname"><a href="classParticles_1_1Particle.html#afbe52b594cf4a8dd11431679c4ef2b52">Particles::Particle::set_location</a></div><div class="ttdeci">void set_location(const Point&lt; spacedim &gt; &amp;new_location)</div><div class="ttdef"><b>Definition:</b> <a href="particles_2particle_8h_source.html#l00455">particle.h:455</a></div></div>
<div class="ttc" id="anumerics_2vector__tools_8h_html"><div class="ttname"><a href="numerics_2vector__tools_8h.html">vector_tools.h</a></div></div>
<div class="ttc" id="amultithreading__0_8txt_html_a33468e75b7ea6d2e64b7e88c6ff1217a"><div class="ttname"><a href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a></div><div class="ttdeci">namespace are implemented the way they are More information on their implementation can be found in the[2.x.72] WorkStream paper To see the WorkStream class used in practice on tasks like the ones outlined above take a look at or[2.x.78] tutorial programs *To begin given the brief description the way the[2.x.79] function could then be written is like this(note that this is not quite the correct syntax, as will be described below) we recycle these objects after they have been used by[2.x.101] and feed them back into another instance of[2.x.102]</div><div class="ttdef"><b>Definition:</b> <a href="multithreading__0_8txt_source.html#l00171">multithreading_0.txt:171</a></div></div>
<div class="ttc" id="anumerical__algorithms__0_8txt_html_a852a1e245dd2de4943eeb66beeaf65b1"><div class="ttname"><a href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">vector</a></div><div class="ttdeci">****This module groups a diverse set of classes that generally implement some sort of numerical algorithm on top all the basic and finite element classes in the library They are generally unconnected to each other *Some of the like KellyErrorEstimator and act on solutions already and compute derived quantities in the first two or help transferring a set of vectors from one mesh to another *The namespaces and VectorTools provide an assortment of such as creating a Laplace projecting or interpolating a function onto the present finite element etc The difference to the functions in the DoFTools and FETools functions is that they work on the DoFTools functions only act on a given DoFHandler object without reference to a data vector</div><div class="ttdef"><b>Definition:</b> <a href="numerical__algorithms__0_8txt_source.html#l00008">numerical_algorithms_0.txt:8</a></div></div>
<div class="ttc" id="aclassParticles_1_1Particle_html"><div class="ttname"><a href="classParticles_1_1Particle.html">Particles::Particle</a></div><div class="ttdef"><b>Definition:</b> <a href="particles_2particle_8h_source.html#l00072">particle.h:72</a></div></div>
<div class="ttc" id="anamespacetypes_html_aaf4eb6ec214fa642dfd956f11a9cd2d7"><div class="ttname"><a href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a></div><div class="ttdeci">unsigned int boundary_id</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00117">types.h:117</a></div></div>
<div class="ttc" id="achunk__sparsity__pattern__0_8txt_html_af92b3b758a3aff288812d65b16690c89"><div class="ttname"><a href="chunk__sparsity__pattern__0_8txt.html#af92b3b758a3aff288812d65b16690c89">lost</a></div><div class="ttdeci">&lt;/tt &gt; with&lt; tt &gt; v&lt;/tt &gt; a vector of ChunkSparsityPattern objects it is sufficient to use the keyword to disallow unwanted but this does not work for[2.x.6] Since copying a structure like this is not useful anyway because multiple matrices can use the same sparsity copies are only allowed for empty as described above **Initialize a rectangular matrix[2.x.7] m number of rows[2.x.8] n number of columns[2.x.9] max_per_row maximum number of nonzero entries per row **Initialize a rectangular matrix[2.x.10] m number of rows[2.x.11] n number of columns[2.x.12] row_lengths possible number of nonzero entries for each row This vector must have one entry for each row **Initialize a quadratic matrix of dimension&lt; tt &gt; n&lt;/tt &gt; with at most&lt; tt &gt; max_per_row&lt;/tt &gt; nonzero entries per row This constructor automatically enables optimized storage of diagonal elements To avoid use the constructor taking row and column numbers separately **Initialize a quadratic matrix[2.x.13] m number of rows and columns[2.x.14] row_lengths possible number of nonzero entries for each row This vector must have one entry for each row **Destructor **Copy subsequent calls to note that a sparse matrix can be described by a sequence of each of which is represented by a sequence of pairs of column indices and values In the present the one representing one row The distance between or any other iterator satisfying the requirements of a forward iterator The objects pointed to by these or simply an through some template magic While the order of the outer iterators denotes the different rows of the the order of the inner iterator denoting the columns does not as they are sorted internal to this function anyway Since that all sounds very consider the following example which may be used to fill a sparsity where we initialize a whole not only a sparsity the first of which we take as column index As the outer[2.x.21] could be replaced by[2.x.22] and the inner[2.x.23] could be replaced by[2.x.24]&lt;/tt &gt; or a list or set of such as they all return iterators that point to such pairs **Copy data from an object of type DynamicSparsityPattern Previous content of this object is lost</div><div class="ttdef"><b>Definition:</b> <a href="chunk__sparsity__pattern__0_8txt_source.html#l00104">chunk_sparsity_pattern_0.txt:104</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a373fbdacd8c486e675b8d2bff8943192"><div class="ttname"><a href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global</a></div><div class="ttdeci">void distribute_local_to_global(const InVector &amp;local_vector, const std::vector&lt; size_type &gt; &amp;local_dof_indices, OutVector &amp;global_vector) const</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02250">affine_constraints.h:2250</a></div></div>
<div class="ttc" id="aconstraints__0_8txt_html_a5abc878123b65e2a7a16e57bba0e282e"><div class="ttname"><a href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a></div><div class="ttdeci">******This module deals with constraints on degrees of freedom The central class to deal with constraints is the AffineConstraints class *Constraints typically come from several for one usually enforces them by requiring that degrees of freedom on the boundary have particular for example[2.x.3] if the boundary condition[2.x.4] requires that the finite element solution[2.x.5] at the location of degree of freedom has the value Such constraints are generated by those versions of the[2.x.6] function that take a AffineConstraints for example no normal as happens in flow problems and is handled by the[2.x.11] function or prescribed tangential as happens in electromagnetic problems and is handled by the[2.x.13] function For the former imagine for example that we are at at vertex where the normal vector has the form[2.x.14] and that and[2.x.17] components of the flow field at this vertex are associated with degrees of and Then the no normal flux condition means that we need to have the condition[2.x.18] The prescribed tangential component leads to similar constraints though there is often something on the right hand side ****If you have hanging node constraints</div><div class="ttdef"><b>Definition:</b> <a href="constraints__0_8txt_source.html#l00020">constraints_0.txt:20</a></div></div>
<div class="ttc" id="aclassKellyErrorEstimator_html_aa0917e696d4f8ddb983223a68c512357"><div class="ttname"><a href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a></div><div class="ttdeci">static void estimate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim - 1 &gt; &amp;quadrature, const std::map&lt; types::boundary_id, const Function&lt; spacedim, typename InputVector::value_type &gt; * &gt; &amp;neumann_bc, const InputVector &amp;solution, Vector&lt; float &gt; &amp;error, const ComponentMask &amp;component_mask=ComponentMask(), const Function&lt; spacedim &gt; *coefficients=nullptr, const unsigned int n_threads=numbers::invalid_unsigned_int, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id, const types::material_id material_id=numbers::invalid_material_id, const Strategy strategy=cell_diameter_over_24)</div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
<div class="ttc" id="awork__stream__0_8txt_html_a96b33355a5c2a51e5f573fa286e92491"><div class="ttname"><a href="work__stream__0_8txt.html#a96b33355a5c2a51e5f573fa286e92491">operate</a></div><div class="ttdeci">we want the order in which contributions are added to the global matrix to be always the same because floating point addition is not commutative and adding contributions to the global matrix in different orders leads to subtly different results that can affect the number of iterations for iterative solvers as well as the round off error in the solution in random ways we want to ensure that only one thread at a time writes into the global and that results are copied in a stable and reproducible order *This class implements a framework for this work model It works with a stream of objects given by an iterator range runs a worker function in parallel on all of these objects and then passes each object to a postprocessor function that runs sequentially and gets objects in exactly the order in which they appear in the input iterator range None of the synchronization work is exposed to the user of this class the range given to the which are then distributed according to some internal algorithm onto the number of available threads An item is an element of the range of iterators on which we are to operate</div><div class="ttdef"><b>Definition:</b> <a href="work__stream__0_8txt_source.html#l00005">work_stream_0.txt:5</a></div></div>
<div class="ttc" id="ahdf5__0_8txt_html_ad6cce9b6ca1bffa8c04aa138acb0692c"><div class="ttname"><a href="hdf5__0_8txt.html#ad6cce9b6ca1bffa8c04aa138acb0692c">simulation</a></div><div class="ttdeci">*Namespace containing deal II s HDF5 interface whereas writing and reading raw data in a dataset can be done independently or int and unsigned int[2.x.35][2.x.36][2.x.37] etc can be used with all of these datatypes Note that the dataset datatype can not be the reason is that it can not be assumed that[2.x.38] stores the elements in a contiguous way ****The following python script writes the parameters for a deal II simulation</div><div class="ttdef"><b>Definition:</b> <a href="hdf5__0_8txt_source.html#l00050">hdf5_0.txt:50</a></div></div>
<div class="ttc" id="aclassParticles_1_1DataOut_html_adf095165dc286310226584b2b9972701"><div class="ttname"><a href="classParticles_1_1DataOut.html#adf095165dc286310226584b2b9972701">Particles::DataOut::build_patches</a></div><div class="ttdeci">void build_patches(const Particles::ParticleHandler&lt; dim, spacedim &gt; &amp;particles, const std::vector&lt; std::string &gt; &amp;data_component_names={}, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretations={})</div><div class="ttdef"><b>Definition:</b> <a href="particles_2data__out_8cc_source.html#l00028">data_out.cc:28</a></div></div>
<div class="ttc" id="alac_2dynamic__sparsity__pattern_8h_html"><div class="ttname"><a href="lac_2dynamic__sparsity__pattern_8h.html">dynamic_sparsity_pattern.h</a></div></div>
<div class="ttc" id="afunction__0_8txt_html_a8f6aa3983c7a97f1d27b94ad1d160c10"><div class="ttname"><a href="function__0_8txt.html#a8f6aa3983c7a97f1d27b94ad1d160c10">known</a></div><div class="ttdeci">*This class is a model for a general function that given a point at which to evaluate the function returns a vector of values with one or more components *The class serves the purpose of representing both scalar and vector valued functions To this end we consider scalar functions as a special case of vector valued functions in the former case only having a single component return vector Since handling vectors is comparatively expensive the interface of this class has functions which only ask for a single component of the vector valued results(this is what you will usually need in case you know that your function is scalar-valued) as well as functions you can ask for an entire vector of results with as many components as the function object represents. Access to function objects therefore is through the following methods the functions returning several values at a and gradient while those ones will throw an exception when called but not overloaded the functions returning all components of the function at one or several will[2.x.0] not[2.x.1] call the function returning one component at one point once for each point and component The reason is you should therefore also provide overloads of virtual the functions for all components at a time *Also that unless only called a very small number of you should overload all sets of since the cost of evaluation of a point value is often less than virtual the function call itself *Support for time dependent functions can be found in the base class FunctionTime ***If the functions you are dealing with have a number of components that are a priori known(for example,&lt; tt &gt;dim&lt;/tt &gt; elements)</div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a23e8d7ec9b1cf01acce4516431c61616"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a23e8d7ec9b1cf01acce4516431c61616">to</a></div><div class="ttdeci">and situations where one is given a parameter dependent problem[2.x.4] and wants to form derivatives with regards to the for example to optimize an output functional with regards to[2.x.6]</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00010">automatic_and_symbolic_differentiation_0.txt:10</a></div></div>
<div class="ttc" id="aclassStep19_1_1CathodeRaySimulator_html_acceda54ac84d5e31aa1ae329bd1a0381"><div class="ttname"><a href="classStep19_1_1CathodeRaySimulator.html#acceda54ac84d5e31aa1ae329bd1a0381">Step19::CathodeRaySimulator::run</a></div><div class="ttdeci">void run()</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00634">step-19.cc:634</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_ae2fa3b8d578ba488b4f37061bb0278bb"><div class="ttname"><a href="classFiniteElementData.html#ae2fa3b8d578ba488b4f37061bb0278bb">FiniteElementData::dofs_per_cell</a></div><div class="ttdeci">const unsigned int dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__base_8h_source.html#l00410">fe_base.h:410</a></div></div>
<div class="ttc" id="astructDataPostprocessorInputs_1_1Scalar_html"><div class="ttname"><a href="structDataPostprocessorInputs_1_1Scalar.html">DataPostprocessorInputs::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__postprocessor_8h_source.html#l00241">data_postprocessor.h:241</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a></div><div class="ttdeci">@ update_normal_vectors</div><div class="ttdoc">Normal vectors.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00132">fe_update_flags.h:132</a></div></div>
<div class="ttc" id="aclassTensor_html"><div class="ttname"><a href="classTensor.html">Tensor&lt; 1, dim &gt;</a></div></div>
<div class="ttc" id="aclassParticles_1_1Particle_html_af792bce47ec4746ad2c78e7e800299a8"><div class="ttname"><a href="classParticles_1_1Particle.html#af792bce47ec4746ad2c78e7e800299a8">Particles::Particle::set_id</a></div><div class="ttdeci">void set_id(const types::particle_index &amp;new_id)</div><div class="ttdef"><b>Definition:</b> <a href="particles_2particle_8h_source.html#l00500">particle.h:500</a></div></div>
<div class="ttc" id="aclassDataOut_html_a087f63e22f0614bca326dbdca288c646"><div class="ttname"><a href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01071">data_out.cc:1071</a></div></div>
<div class="ttc" id="aupdate__flags__0_8txt_html_a5f3fcf87333f5770d16608f67ad88d19"><div class="ttname"><a href="update__flags__0_8txt.html#a5f3fcf87333f5770d16608f67ad88d19">all</a></div><div class="ttdeci">this property does not hold for the shape functions of Raviart Thomas which must be rotated with the cell This allows further optimization of the computations underlying assembly ***Let s say you want to compute the Laplace matrix as shown above In that you need to specify the[2.x.20] the finite element requires the computation of the inverse of the full Jacobian and not just the determinant of the and to compute the inverse of the it is also necessary to compute the Jacobian matrix first *Since these are requirements that are not important to the it is not necessary to specify this in user code given a set of update the FEValues object first asks the finite element object what information it needs to compute in order to satisfy the user s request provided in the update flags The finite element object may therefore add other flags to the update FEValues then asks the mapping whether it also wants to add more flags to the list to satisfy the needs of both the user and the finite element by the FEValues object then asks both the finite element object and mapping object to create temporary structures into which they can store some temporary information that can be computed once and for all</div><div class="ttdef"><b>Definition:</b> <a href="update__flags__0_8txt_source.html#l00026">update_flags_0.txt:26</a></div></div>
<div class="ttc" id="ageometry__info__0_8txt_html_a30a552b07accf65da90f851e25d14d1c"><div class="ttname"><a href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div><div class="ttdeci">3, where it offers following possibilities:a face(quad) being refined in x- or y-direction(in the face-intern coordinate system) separately,([2.x.79] or([2.x.80] which corresponds to([2.x.81]). Additionally, it offers the possibilities a face can have through repeated anisotropic refinement steps performed on one of the two neighboring cells. It might be possible for example, that a face(quad) is refined with[2.x.82] and afterwards the left child is again refined with[2.x.83], so that there are three active subfaces. Note, however, that only refinement cases are allowed such that each line on a face between two hexes has not more than one hanging node. Furthermore, it is not allowed that two neighboring hexes are refined such that one of the hexes refines the common face with[2.x.84] and the other hex refines that face with[2.x.85] . In fact,[2.x.86] takes care of this situation and ensures that each face of a refined cell is completely contained in a single face of neighboring cells. The following drawings explain the SubfacePossibilities and give the corresponding subface numbers:*[1.x.4] **[2.x.87] *[0.x.68] *Possible cases of faces being subdivided into subface. See documentation to the SubfacePossibilities&lt; 3 &gt; for more details on the subface possibilities. *[0.x.69] *A class that provides all possible cases a face(in the current space dimension[2.x.88] might be subdivided into subfaces. *[2.x.89] *[0.x.70] *Constructor. Take and store a value indicating a particular subface possibility in the list of possible situations specified in the base class. *[0.x.71] *Return the numeric value stored by this class. While the presence of this operator might seem dangerous, it is useful in cases where one would like to have code like&lt; code &gt;switch(subface_case)... case[2.x.90] ...&lt;/code &gt;, which can be written as&lt; code &gt;switch[2.x.91] Another application is to use an object of the current type as an index into an array dim</div><div class="ttdef"><b>Definition:</b> <a href="geometry__info__0_8txt_source.html#l00202">geometry_info_0.txt:202</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a69730bc7f91dd1be17fd083a66514e73"><div class="ttname"><a href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a></div><div class="ttdeci">their purpose is merely to keepdeal II as uniform as possible Uniformity reduces the number of bugs weproduce because we for always assume that input arguments comebefore output arguments of a function call They also simplify reading codebecause some things become clear already by looking at the style a piece ofcode is without having to look up the exact definition of something **deal II uses[2.x.2] to normalize indentation Astyle file is provided at ***Before a you should run **on each of your files This will make sure indentation is conforming to thestyle guidelines outlined in this page *This is cumbersome and more you can just run **in whatever directory you set up the library to be compiled to indent allsource files that have been changed recently If you want to make sure thatthe indenting is correct for all your you might want to set up apre commit hook One way to do is to copy[2.x.4] to[2.x.5] and make sure it isexecutable *If the system you are working on has more than one version of[2.x.6] degrees of freedom</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00018">coding_conventions_0.txt:18</a></div></div>
<div class="ttc" id="atrilinos__sparse__matrix__0_8txt_html_ab4e34663c28496ee1b07f40fd5d00fa1"><div class="ttname"><a href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a></div><div class="ttdeci">all column elements of a row are stored on the same processor in any case The vector&lt; tt &gt; n_entries_per_row&lt;/tt &gt; specifies the number of entries in each row of the newly generated matrix **This function is initializes the Trilinos Epetra matrix according to the specified sparsity_pattern</div><div class="ttdef"><b>Definition:</b> <a href="trilinos__sparse__matrix__0_8txt_source.html#l00162">trilinos_sparse_matrix_0.txt:162</a></div></div>
<div class="ttc" id="aclassDynamicSparsityPattern_html"><div class="ttname"><a href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2dynamic__sparsity__pattern_8h_source.html#l00340">dynamic_sparsity_pattern.h:340</a></div></div>
<div class="ttc" id="aclassSparsityPattern_html"><div class="ttname"><a href="classSparsityPattern.html">SparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2sparsity__pattern_8h_source.html#l00900">sparsity_pattern.h:900</a></div></div>
<div class="ttc" id="anamespaceStep19_1_1BoundaryIds_html_a563e91e3ccf3b5e91103d322278a36f4"><div class="ttname"><a href="namespaceStep19_1_1BoundaryIds.html#a563e91e3ccf3b5e91103d322278a36f4">Step19::BoundaryIds::cathode</a></div><div class="ttdeci">constexpr types::boundary_id cathode</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00064">step-19.cc:64</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ab2562d41bb26f362043f9719a8cd9b87"><div class="ttname"><a href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></div><div class="ttdeci">void interpolate_boundary_values(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::map&lt; types::boundary_id, const Function&lt; spacedim, number &gt; * &gt; &amp;function_map, std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
<div class="ttc" id="agroup__Exceptions_html_ga9442b63275c9ef3fab29bc222831c49c"><div class="ttname"><a href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a></div><div class="ttdeci">#define AssertDimension(dim1, dim2)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01749">exceptions.h:1749</a></div></div>
<div class="ttc" id="adata__out__base__0_8txt_html_a1a0f08903e9f2a25a073261a20b86e26"><div class="ttname"><a href="data__out__base__0_8txt.html#a1a0f08903e9f2a25a073261a20b86e26">on</a></div><div class="ttdeci">several of the example programs show how to do this **All functions take a parameter which is a structure of type&lt; tt &gt; where&lt; tt &gt; X&lt;/tt &gt; is the name of the output format To find out what flags are presently read the documentation of the different structures *Note that usually the output formats used for scientific visualization programs have no or very few like Postscript or Povray need to be given a lot more since there the output file has to contain all details of the light etc **An abstraction layer has been introduced to facilitate coding backends for additional visualization tools It is applicable for data formats separating the information into a field of a field of connection information for the grid cells and data fields *For each of these output functions are namely a format specific output stream must be following the examples of VtkStream and so on</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base__0_8txt_source.html#l00030">data_out_base_0.txt:30</a></div></div>
<div class="ttc" id="aA-headers_2fe__0_8txt_html_abbd000c1bb0a029706ba0d8934597f39"><div class="ttname"><a href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a></div><div class="ttdeci">****All classes related to shape functions and to access to shape functions This concerns the actual values of finite elements For the numbering of degrees of freedom refer to the module on *[2.x.1] The classes and functions of this module fall into several sub groups that are discussed in their respective sub modules listed above In the FETools class provides functions that provide information on finite elements transformations between elements etc *In the grand scheme of the pieces of this module interact with a variety of other parts of the without actually implementing a concrete element For the FiniteElement base class declares the virtual functions a derived class has to implement if it wants to describe a finite element space Likewise the FiniteElementData holds variables that describe certain values characterizing a finite element such as the number of degrees of freedom per vertex line or face *On the other classes like FE_Poly and FE_PolyTensor are higher abstractions They describe finite elements that are built atop polynomial descriptions of the shape functions on the unit cell Classes derived from them then only have to provide a description of the particular polynomial from which a finite element is built For the FE_Q class that implements the usual Lagrange elements uses the FE_Poly base class to generate a finite element by providing it with a set of Lagrange interpolation polynomials corresponding to an equidistant subdivision of interpolation points the FESystem class is used for vector valued problems There one may want to couple a number of for Navier Stokes one may want to use three Q1 elements for the three components of the velocity</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2fe__0_8txt_source.html#l00021">fe_0.txt:21</a></div></div>
<div class="ttc" id="anamespaceStep19_html"><div class="ttname"><a href="namespaceStep19.html">Step19</a></div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00059">step-19.cc:59</a></div></div>
<div class="ttc" id="aclassParticles_1_1ParticleHandler_html_ab5f542a397843198eb82d8537602daf3"><div class="ttname"><a href="classParticles_1_1ParticleHandler.html#ab5f542a397843198eb82d8537602daf3">Particles::ParticleHandler::end</a></div><div class="ttdeci">particle_iterator end() const</div><div class="ttdef"><b>Definition:</b> <a href="particles_2particle__handler_8h_source.html#l01045">particle_handler.h:1045</a></div></div>
<div class="ttc" id="adiscrete__time__0_8txt_html_aea6d70f72c4e549e943e681a41fdb8d9"><div class="ttname"><a href="discrete__time__0_8txt.html#aea6d70f72c4e549e943e681a41fdb8d9">from</a></div><div class="ttdeci">*This class provides a means to keep track of the simulation time in a time dependent simulation It manages stepping forward from a start time[2.x.0] to an end time[2.x.1] It also allows adjusting the time step size during the simulation This class provides the necessary interface to be incorporated in any time dependent simulation The usage of this class is demonstrated in[2.x.2] and *[2.x.3] This class provides a number of invariants that are guaranteed to be true at all times *The current simulation time is within the closed interval between the start time and the end the step size is time advances in strictly ascending but may be adjusted slightly towards the end of the simulation to ensure that the simulation time hits the end time exactly The adjustment is useful for the following if you like this the equivalent while the time is advanced from[2.x.10] and finally it reaches the end time at[2.x.14] the final step size needs to be reduced from its desired value of to[2.x.15] in order to ensure that we finish the simulation exactly at the specified end time In you should assume that not only the last time step length may be but also previously ones **for this class may take the liberty to spread the decrease in time step size out over several time steps and increment time from[2.x.16]</div><div class="ttdef"><b>Definition:</b> <a href="discrete__time__0_8txt_source.html#l00017">discrete_time_0.txt:17</a></div></div>
<div class="ttc" id="adofs_2dof__tools_8h_html"><div class="ttname"><a href="dofs_2dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="agrid_2grid__refinement_8h_html"><div class="ttname"><a href="grid_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="astep-2_8cc_html_ab108b7b7bca84a81aceda045aaef1961"><div class="ttname"><a href="step-2_8cc.html#ab108b7b7bca84a81aceda045aaef1961">make_grid</a></div><div class="ttdeci">void make_grid(Triangulation&lt; 2 &gt; &amp;triangulation)</div><div class="ttdef"><b>Definition:</b> <a href="step-2_8cc_source.html#l00038">step-2.cc:38</a></div></div>
<div class="ttc" id="alac_2precondition_8h_html"><div class="ttname"><a href="lac_2precondition_8h.html">precondition.h</a></div></div>
<div class="ttc" id="aadvection__0_8txt_html_a79a3cbbb7583dd309bf1b14dc20895b6"><div class="ttname"><a href="advection__0_8txt.html#a79a3cbbb7583dd309bf1b14dc20895b6">cell_matrix</a></div><div class="ttdeci">**its DG formulations All advection operators depend on an advection velocity denoted by[1.x.0] in the formulas below It is denoted as&lt; tt &gt; velocity&lt;/tt &gt; in the parameter lists The functions cell_matrix() and both upwind_value_matrix() are taking the equation in weak form</div></div>
<div class="ttc" id="astructDataOutBase_1_1VtkFlags_html"><div class="ttname"><a href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2data__out__base_8h_source.html#l01065">data_out_base.h:1065</a></div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00039">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="aclassArrayView_html_a2339bfed866b07b8d100f017616e2f2a"><div class="ttname"><a href="classArrayView.html#a2339bfed866b07b8d100f017616e2f2a">ArrayView::make_array_view</a></div><div class="ttdeci">ArrayView&lt; typename std::remove_reference&lt; typename std::iterator_traits&lt; Iterator &gt;::reference &gt;::type, MemorySpaceType &gt; make_array_view(const Iterator begin, const Iterator end)</div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00715">array_view.h:715</a></div></div>
<div class="ttc" id="abase_2quadrature__lib_8h_html"><div class="ttname"><a href="base_2quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a96ecfde131843f52ee49d0e0c1180134"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div><div class="ttdeci">computing derivatives of these terms is impractical in most applications in impossible to get right Higher derivatives are even more impossible to do without computer aid Automatic or symbolic differentiation is a way out of and gets compile time</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00012">automatic_and_symbolic_differentiation_0.txt:12</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassQTrapezoid_html"><div class="ttname"><a href="classQTrapezoid.html">QTrapezoid</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00126">quadrature_lib.h:126</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a7b3d3f295bb56d6cd6856bdc6cbe8a01"><div class="ttname"><a href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">AffineConstraints::distribute</a></div><div class="ttdeci">void distribute(VectorType &amp;vec) const</div></div>
<div class="ttc" id="aclassQMidpoint_html"><div class="ttname"><a href="classQMidpoint.html">QMidpoint</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00093">quadrature_lib.h:93</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_addd15bc409c61d6f795f0132c574335b"><div class="ttname"><a href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">AffineConstraints::clear</a></div><div class="ttdeci">void clear()</div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00124">fe_update_flags.h:124</a></div></div>
<div class="ttc" id="aclassParticles_1_1DataOut_html"><div class="ttname"><a href="classParticles_1_1DataOut.html">Particles::DataOut</a></div><div class="ttdef"><b>Definition:</b> <a href="particles_2data__out_8h_source.html#l00044">data_out.h:44</a></div></div>
<div class="ttc" id="afe__nedelec__sz__0_8txt_html_ac056393c4af09ec698a8a647d050abbc"><div class="ttname"><a href="fe__nedelec__sz__0_8txt.html#ac056393c4af09ec698a8a647d050abbc">E</a></div><div class="ttdeci">the total polynomial degree may be higher If the element is linear and has degrees of freedom only on the edges If faces and volume For example the version of FE_NedelecSZ has degrees of freedom for where order is the order of FE_NedelecSZ **This element is vector valued so this function will throw an exception **Not implemented **This element is vector valued so this function will throw an exception **Not implemented **This element is vector valued so this function will throw an exception **Not implemented **The mapping kind to be used to map shape functions from the reference cell to the mesh cell **Compute information about the shape functions on the cell denoted by the first argument Note that this function must recompute the cell dependent degrees of and so is not thread safe at this time **Compute information about the shape functions on the cell and face denoted by the first two arguments Note that this function must recompute the cell dependent degrees of and so is not thread safe at this time **Not implemented **Derived Internal data which is used to store cell independent data Note that due to the nature of this a number of useful pre computed quantities are stored for the computation of cell dependent shape functions The main quantities which are stored are associated with edge and face parameterizations These equal to one at the[2.x.5] th vertex and zero at all other vertices *[2.x.6][2.x.7][2.x.8] *linear functional associated with the[2.x.9] th vertex[2.x.10][2.x.11] The definitions of these as well as the edge and face parameterizations and edge and face extension can be found on page of Zaglmayr s thesis The details of the definition of the globally defined edge and face orientations can be found on page **Storage for shape functions on the reference element We only pre compute cell based as the edge and face based DoFs depend on the cell Due to the cell dependent this variable is declared mutable **Storage for shape function gradients on the reference element We only pre compute cell based as the edge and face based DoFs depend on the cell Due to the cell dependent this variable is declared mutable **Storage for all possible edge parameterization between vertices These are required in the computation of edge and face based which are cell dependent The edge parameterization of an E</div><div class="ttdef"><b>Definition:</b> <a href="fe__nedelec__sz__0_8txt_source.html#l00043">fe_nedelec_sz_0.txt:43</a></div></div>
<div class="ttc" id="amatrix__free_2fe__point__evaluation_8h_html"><div class="ttname"><a href="matrix__free_2fe__point__evaluation_8h.html">fe_point_evaluation.h</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_ae32ad430917839b4e435a4d04c5d975a"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#ae32ad430917839b4e435a4d04c5d975a">are</a></div><div class="ttdeci">******to automatic and symbolic differentiation *Below we provide a very brief introduction as to what automatic and symbolic differentiation are</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00010">automatic_and_symbolic_differentiation_0.txt:10</a></div></div>
<div class="ttc" id="alac_2full__matrix_8h_html"><div class="ttname"><a href="lac_2full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="alac_2solver__cg_8h_html"><div class="ttname"><a href="lac_2solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="afe__q__0_8txt_html_a1a8eaafa20c4d8c9ab128b62a984738c"><div class="ttname"><a href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a></div><div class="ttdeci">*Implementation of a scalar Lagrange finite element[2.x.0] that yields the finite element space of piecewise polynomials of degree[2.x.1] in each coordinate direction This class is realized using tensor product polynomials based on D Lagrange polynomials with Gauss or given support points *The standard constructor of this class takes the degree[2.x.2] of this finite element it can take a quadrature formula[2.x.3] defining the support points of the Lagrange interpolation in one coordinate direction *For more information about the&lt; tt &gt; spacedim&lt;/tt &gt; template parameter check the documentation of FiniteElement or the one of Triangulation **The constructor creates a TensorProductPolynomials object that includes the tensor product of[2.x.4] polynomials of degree[2.x.5] This[2.x.6] object provides all values and derivatives of the shape functions In case a quadrature rule is the constructor creates a TensorProductPolynomials object that includes the tensor product of[2.x.7] polynomials with the support points from *[2.x.8] Furthermore the constructor fills the[2.x.9] the[2.x.10] equidistant support points at i where one polynomial is one and all the others are zero For higher polynomial degrees</div><div class="ttdef"><b>Definition:</b> <a href="fe__q__0_8txt_source.html#l00009">fe_q_0.txt:9</a></div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="aparticles_2particle__handler_8h_html"><div class="ttname"><a href="particles_2particle__handler_8h.html">particle_handler.h</a></div></div>
<div class="ttc" id="aclassParticles_1_1ParticleHandler_html"><div class="ttname"><a href="classParticles_1_1ParticleHandler.html">Particles::ParticleHandler&lt; dim &gt;</a></div></div>
<div class="ttc" id="astep-69_8cc_html_a66a64d07b4db87c87b639bdcf7b18c82"><div class="ttname"><a href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; local_dof_indices</div><div class="ttdef"><b>Definition:</b> <a href="step-69_8cc_source.html#l00534">step-69.cc:534</a></div></div>
<div class="ttc" id="alac_2vector_8h_html"><div class="ttname"><a href="lac_2vector_8h.html">vector.h</a></div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point&lt; dim &gt;</a></div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_ad3b9cdeadeb3bcdb52af5db70c041a6e"><div class="ttname"><a href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for can be different if such as FE_DGP **static The number of degrees of freedom of all components determined from the given template argument fe_degree Note that the actual number of degrees of freedom dofs_per_cell can be different if such as FE_DGP **static The number of degrees of freedom of all components determined from the given template argument fe_degree Note that the actual number of degrees of freedom dofs_per_cell can be different if such as FE_DGP **Constructor Takes all data stored in MatrixFree If applied to problems with more than one finite element or more than one quadrature formula selected during construction of[2.x.343] the appropriate component can be selected by the optional arguments[2.x.344] matrix_free Data object that contains all data[2.x.345] dof_no If matrix_free was set up with multiple DoFHandler this parameter selects to which DoFHandler AffineConstraints pair the given evaluator should be attached to[2.x.346] quad_no If matrix_free was set up with multiple Quadrature this parameter selects the appropriate number of the quadrature formula[2.x.347] first_selected_component If the dof_handler selected by dof_no uses an FESystem consisting of more than one this parameter allows for selecting the component where the current evaluation routine should start Note that one evaluator does not support combining different shape functions in different components In other the same base element of a FESystem needs to be set for the components between[2.x.348] and[2.x.349][2.x.350] active_fe_index If matrix_free was set up with DoFHandler objects with[2.x.351] this parameter selects to which DoFHandler AffineConstraints pair the given evaluator should be attached to[2.x.352] active_quad_index If matrix_free was set up with[2.x.353] this parameter selects the appropriate number of the quadrature formula **Constructor Takes all data stored in MatrixFree for a given cell which allows to automatically identify the active_fe_index and active_quad_index in case of a p adaptive strategy The rest of the arguments are the same as in the constructor above **Constructor that comes with reduced functionality and works similar as FEValues The arguments are similar to the ones passed to the constructor of with the notable difference that FEEvaluation expects a one dimensional quadrature instead of a[2.x.354] dimensional one The finite element can be both scalar or vector but this method always only selects a scalar base element at a the optional argument[2.x.356] allows to specify the index of the base element to be used for evaluation Note that the internal data structures always assume that the base element is non primitive are not supported currently As known from a call to the reinit method with a[2.x.357] is necessary to make the geometry and degrees of freedom of the current class known::If the iterator includes DoFHandler the initialization allows to also read from or write to vectors in the standard way for[2.x.359] types for one cell at a time this approach is much slower than the path with MatrixFree with MPI since index translation has to be done As only one cell at a time is this method does not vectorize over several but only possibly within the element if the evaluate integrate routines are combined inside user an object of type i the underlying mapping and quadrature points do only need to be evaluated once Make sure to not pass an optional object around when you intend to use the FEEvaluation object in parallel to the given one because otherwise the intended sharing may create race conditions **Copy constructor If FEEvaluationBase was constructed from a fe</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00555">fe_evaluation_0.txt:555</a></div></div>
<div class="ttc" id="abase_2discrete__time_8h_html"><div class="ttname"><a href="base_2discrete__time_8h.html">discrete_time.h</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_a807c3049bfe81743fc0f237dfc2fbdea"><div class="ttname"><a href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">FEValuesBase::n_quadrature_points</a></div><div class="ttdeci">const unsigned int n_quadrature_points</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l02405">fe_values.h:2405</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_ab123e5da03736be4977c76fbcb6a2e37"><div class="ttname"><a href="classFEValuesBase.html#ab123e5da03736be4977c76fbcb6a2e37">FEValuesBase::quadrature_point</a></div><div class="ttdeci">const Point&lt; spacedim &gt; &amp; quadrature_point(const unsigned int q) const</div></div>
<div class="ttc" id="atable__handler__0_8txt_html_a61e9964f9093088848525ca172895749"><div class="ttname"><a href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a></div><div class="ttdeci">the ConvergenceTable class does something like this *To support both the TableHandler class has a property called[1.x.4] By auto fill mode is but it can be enabled by calling set_auto_fill_mode(). If auto-fill mode is enabled we use the following algorithm call it *[2.x.18] ***If[2.x.19] then we add[2.x.20] copies of the object[2.x.21] to this column is the data type of the given[2.x.23] is a numeric then[2.x.24] is[2.x.25] is the empty string *[2.x.26] ***Add the given value to this column *Padding the column with default elements makes sure that after the addition the column has as many entries as the longest other column In other if we have skipped previous invocations of then the padding will enter default values into this column *The algorithm as described will fail if you try to skip adding values for a key if adding an element for this key is the first thing you want to do for a given iteration or time step</div><div class="ttdef"><b>Definition:</b> <a href="table__handler__0_8txt_source.html#l00070">table_handler_0.txt:70</a></div></div>
<div class="ttc" id="aclassQuadrature_html_af9f7d82770fa8126e19113f3e3db755b"><div class="ttname"><a href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">Quadrature::size</a></div><div class="ttdeci">unsigned int size() const</div></div>
<div class="ttc" id="aclassPreconditionSSOR_html"><div class="ttname"><a href="classPreconditionSSOR.html">PreconditionSSOR</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2precondition_8h_source.html#l00699">precondition.h:699</a></div></div>
<div class="ttc" id="asynchronous__iterator__0_8txt_html_a3e447fe5e17c249965365f92a0755913"><div class="ttname"><a href="synchronous__iterator__0_8txt.html#a3e447fe5e17c249965365f92a0755913">range</a></div><div class="ttdeci">*A class that represents a set of iterators each of which are incremented by one at the same time This is typically used in calls like[2.x.0] where we have synchronous iterators marching through the containers[2.x.1] If an object of this type represents the end of a range</div><div class="ttdef"><b>Definition:</b> <a href="synchronous__iterator__0_8txt_source.html#l00002">synchronous_iterator_0.txt:2</a></div></div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_adad35057b6e70ae37d4abe7878683d90"><div class="ttname"><a href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per the child indices of the child cells adjacent to face</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="aclassDiscreteTime_html"><div class="ttname"><a href="classDiscreteTime.html">DiscreteTime</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2discrete__time_8h_source.html#l00228">discrete_time.h:228</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ad83f9d9d8b603ed71c3483de199bc7a7"><div class="ttname"><a href="coding__conventions__0_8txt.html#ad83f9d9d8b603ed71c3483de199bc7a7">in</a></div><div class="ttdeci">their purpose is merely to keepdeal II as uniform as possible Uniformity reduces the number of bugs weproduce because we for always assume that input arguments comebefore output arguments of a function call They also simplify reading codebecause some things become clear already by looking at the style a piece ofcode is without having to look up the exact definition of something **deal II uses[2.x.2] to normalize indentation Astyle file is provided at ***Before a you should run **on each of your files This will make sure indentation is conforming to thestyle guidelines outlined in this page *This is cumbersome and more you can just run **in whatever directory you set up the library to be compiled in</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00013">coding_conventions_0.txt:13</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">VectorTools::EvaluationFlags::min</a></div><div class="ttdeci">@ min</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00062">vector_tools_evaluate.h:62</a></div></div>
<div class="ttc" id="aclassFE__Poly_html_a9205cb50b9901b40adc7220dd92ded5c"><div class="ttname"><a href="classFE__Poly.html#a9205cb50b9901b40adc7220dd92ded5c">FE_Poly::shape_value</a></div><div class="ttdeci">virtual double shape_value(const unsigned int i, const Point&lt; dim &gt; &amp;p) const override</div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ac639e1db0b03fc797eca55e266afa976"><div class="ttname"><a href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per cell</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="adata__out__base__0_8txt_html_ab82e308c7116a3c0e36ead8285942aad"><div class="ttname"><a href="data__out__base__0_8txt.html#ab82e308c7116a3c0e36ead8285942aad">vertices</a></div><div class="ttdeci">several of the example programs show how to do this **All functions take a parameter which is a structure of type&lt; tt &gt; where&lt; tt &gt; X&lt;/tt &gt; is the name of the output format To find out what flags are presently read the documentation of the different structures *Note that usually the output formats used for scientific visualization programs have no or very few like Postscript or Povray need to be given a lot more since there the output file has to contain all details of the light etc **An abstraction layer has been introduced to facilitate coding backends for additional visualization tools It is applicable for data formats separating the information into a field of vertices</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base__0_8txt_source.html#l00029">data_out_base_0.txt:29</a></div></div>
<div class="ttc" id="aclassSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__control_8h_source.html#l00052">solver_control.h:52</a></div></div>
<div class="ttc" id="aclassFEFaceValues_html"><div class="ttname"><a href="classFEFaceValues.html">FEFaceValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="astructSubCellData_html"><div class="ttname"><a href="structSubCellData.html">SubCellData</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria__description_8h_source.html#l00200">tria_description.h:200</a></div></div>
<div class="ttc" id="agroup__CPP11_html_gaace8c98aca00e7e48a619bb5e08084aa"><div class="ttname"><a href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">DoFHandler::active_cell_iterators</a></div><div class="ttdeci">IteratorRange&lt; active_cell_iterator &gt; active_cell_iterators() const</div></div>
<div class="ttc" id="anamespaceEuler__DG_html_a143bc64b6fa6ced9f11c148a2af3ff09"><div class="ttname"><a href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Euler_DG::Number</a></div><div class="ttdeci">double Number</div><div class="ttdef"><b>Definition:</b> <a href="step-67_8cc_source.html#l00064">step-67.cc:64</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_ac00ea19562c135512a6ff275a3cf0d8f"><div class="ttname"><a href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has this class generates all dim dimensional polynomials of the where the sum and[1.x.8] is less than or equal *[1.x.9] The i e for each dim dimensional polynomial in the polynomial space it gives the indices j</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00004">polynomial_space_0.txt:4</a></div></div>
<div class="ttc" id="afe_2mapping__q_8h_html"><div class="ttname"><a href="fe_2mapping__q_8h.html">mapping_q.h</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">VectorTools::EvaluationFlags::max</a></div><div class="ttdeci">@ max</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00056">vector_tools_evaluate.h:56</a></div></div>
<div class="ttc" id="anamespacetypes_html_aae4818f49b3de414cae76e53778796af"><div class="ttname"><a href="namespacetypes.html#aae4818f49b3de414cae76e53778796af">types::particle_index</a></div><div class="ttdeci">unsigned int particle_index</div><div class="ttdef"><b>Definition:</b> <a href="particles_2property__pool_8h_source.html#l00066">property_pool.h:66</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a2ea3312e08a7e3658bf73660b48f0aa4"><div class="ttname"><a href="coding__conventions__0_8txt.html#a2ea3312e08a7e3658bf73660b48f0aa4">be</a></div><div class="ttdeci">****The majority of classes and functions in deal II are templated This brings aquestion of how and where such objects are if at all Throughoutdeal II we adopt the following the dimensioncan only be</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00048">coding_conventions_0.txt:48</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_a33b522422da89e5c080e7405ad49d7c7"><div class="ttname"><a href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">FiniteElementData::n_dofs_per_cell</a></div><div class="ttdeci">unsigned int n_dofs_per_cell() const</div></div>
<div class="ttc" id="anamespaceStep19_1_1Constants_html_a6e5f68e7ed83f2fd0da71651defb9455"><div class="ttname"><a href="namespaceStep19_1_1Constants.html#a6e5f68e7ed83f2fd0da71651defb9455">Step19::Constants::electron_charge</a></div><div class="ttdeci">constexpr double electron_charge</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00072">step-19.cc:72</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut&lt; dim &gt;</a></div></div>
<div class="ttc" id="aparticle__handler__0_8txt_html_a8a14acfef214304cd74d5000acdc8fc2"><div class="ttname"><a href="particle__handler__0_8txt.html#a8a14acfef214304cd74d5000acdc8fc2">particles</a></div><div class="ttdeci">*This class manages the storage and handling of particles It provides the data structures necessary to store particles efficiently accessor functions to iterate over particles and find particles and algorithms to distribute particles in parallel domains Note that the class is designed in a similar way as the triangulation class In particular we call particles in the domain of the local process local particles and particles that belong to neighbor processes and live in the ghost cells around the locally owned domain ghost particles This class is used in *[2.x.0] **A type that can be used to iterate over all particles in the domain **A type that represents a range of particles **Default constructor **Constructor that initializes the particle handler with a given triangulation and mapping Since particles are stored in respect to their surrounding cells this information is necessary to correctly organize the particle collection This constructor is equivalent to calling the default constructor and the initialize function **Destructor **Initialize the particle handler This function does not clear the internal data it just sets the triangulation and the mapping to be used **Copy the state of particle handler[2.x.2] into the current object This will copy all particles and properties and leave this object as an identical copy of[2.x.3] Existing particles in this object are deleted Be aware that this does not copy functions that are connected to the signals of[2.x.4] nor does it connect the current object s member functions to triangulation which must be done by the caller if that is if the[2.x.5] had connected functions This function is expensive as it has to duplicate all data in[2.x.6] and insert it into this which may be a significant amount of data it can be useful to save the state of a particle collection at a certain point in time and reset this state later under certain for example if a timestep has to be undone and repeated **Clear all particle related data **Only clear particle but keep cache information about number of particles This is useful during reorganization of particle data between processes **Update all internally cached numbers Note that all functions that modify internal data structures and act on multiple particles will call this function while functions that act on single particles will not call this it is not an efficient function to use if the number of particles is large That is because to find the particles that are located in one cell costs[2.x.9] where[2.x.10] is the number of overall particles Since you will likely do this for every and assuming that the number of particles and the number of cells are roughly you end up with an[2.x.11] algorithm A better approach is to use the fact that particles are arranged in the order of the active cells they are in In other if you iterate over all particles</div><div class="ttdef"><b>Definition:</b> <a href="particle__handler__0_8txt_source.html#l00042">particle_handler_0.txt:42</a></div></div>
<div class="ttc" id="aparticle__0_8txt_html_a770ac0edb21c7955207df05e1fa5e0c5"><div class="ttname"><a href="particle__0_8txt.html#a770ac0edb21c7955207df05e1fa5e0c5">particle</a></div><div class="ttdeci">namespace that contains all classes that are related to the particle implementation in particular the fundamental Particle class ***Internal alias of cell level index pair **A class that represents a particle in a domain that is meshed by a triangulation of some kind The data this class stores is the position of the particle in the overall space the position of the particle in the reference coordinate system of the cell it is currently in an ID number that is unique among all particles and a variable number of properties The properties attached to each object of this class are stored by a PropertyPool object These properties are stored as an array of double variables that can be accessed via an ArrayView object For example if one wanted to equip each particle with a temperature and chemical composition property that is advected along with the particle(and may change from time step to time step based on some differential equation, for example)</div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="anamespaceStep19_1_1Constants_html_a3d90f7bbfab7142b2f501d67f4da023f"><div class="ttname"><a href="namespaceStep19_1_1Constants.html#a3d90f7bbfab7142b2f501d67f4da023f">Step19::Constants::electron_mass</a></div><div class="ttdeci">constexpr double electron_mass</div><div class="ttdef"><b>Definition:</b> <a href="step-19_8cc_source.html#l00071">step-19.cc:71</a></div></div>
<div class="ttc" id="aclassParticles_1_1ParticleHandler_html_a958a15b3aa325db82b4876cdb9feb527"><div class="ttname"><a href="classParticles_1_1ParticleHandler.html#a958a15b3aa325db82b4876cdb9feb527">Particles::ParticleHandler::begin</a></div><div class="ttdeci">particle_iterator begin() const</div><div class="ttdef"><b>Definition:</b> <a href="particles_2particle__handler_8h_source.html#l01027">particle_handler.h:1027</a></div></div>
<div class="ttc" id="aclassDataPostprocessor_html_a07ebcf764cf911c6d78f21c32ea1d2d0"><div class="ttname"><a href="classDataPostprocessor.html#a07ebcf764cf911c6d78f21c32ea1d2d0">DataPostprocessor::evaluate_scalar_field</a></div><div class="ttdeci">virtual void evaluate_scalar_field(const DataPostprocessorInputs::Scalar&lt; dim &gt; &amp;input_data, std::vector&lt; Vector&lt; double &gt;&gt; &amp;computed_quantities) const</div><div class="ttdef"><b>Definition:</b> <a href="data__postprocessor_8cc_source.html#l00026">data_postprocessor.cc:26</a></div></div>
<div class="ttc" id="alac_2sparse__matrix_8h_html"><div class="ttname"><a href="lac_2sparse__matrix_8h.html">sparse_matrix.h</a></div></div>
<div class="ttc" id="aclassDataOutInterface_html_ac7280a24690b117454acfb0fa058299c"><div class="ttname"><a href="classDataOutInterface.html#ac7280a24690b117454acfb0fa058299c">DataOutInterface::set_flags</a></div><div class="ttdeci">void set_flags(const FlagType &amp;flags)</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l08210">data_out_base.cc:8210</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a1611aa37f754086388ca76bcd421cce5"><div class="ttname"><a href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">AffineConstraints::close</a></div><div class="ttdeci">void close()</div></div>
<div class="ttc" id="afe_2fe__values__0_8txt_html_a15ff2e0c168966d6ae13c4faabcec165"><div class="ttname"><a href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a></div><div class="ttdeci">we have to work a bit harder to compute this information **Default constructor Creates an invalid object **Constructor for an object that represents a single scalar component of a FEValuesBase for the shape function and quadrature point selected by the arguments[2.x.27] shape_function Number of the shape function to be evaluated Note that this number runs from zero to dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__0_8txt_source.html#l00073">fe_values_0.txt:73</a></div></div>
<div class="ttc" id="aparsed__convergence__table__0_8txt_html_a8a90f5ba57a42a3fd4c067e00f8b8aea"><div class="ttname"><a href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a></div><div class="ttdeci">****This class simplifies the construction of convergence tables reading the options for the generation of the table from a parameter file It provides a series of methods that can be used to compute the error given a reference exact solution or the difference between two numerical solutions or any other custom computation of the error given via[2.x.1] objects *An example usage of this class is given by ****The above code constructs a ParsedConvergenceTable that works for scalar and will produce an error table with and Linfty_norm norms of the error *Whenever a call to the methods the instance of this class inspects its parameters computes all norms specified by the parameter given at construction time possibly modified via a parameter file computes all extra column entries specified using the method and writes one row of the convergence table *Once you have finished with the a call to and to the the same code can be used to estimate the errors of mixed or multi physics e and one component for the pressure field p</div><div class="ttdef"><b>Definition:</b> <a href="parsed__convergence__table__0_8txt_source.html#l00020">parsed_convergence_table_0.txt:20</a></div></div>
<div class="ttc" id="aparticles_2data__out_8h_html"><div class="ttname"><a href="particles_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="abase_2array__view_8h_html_a2339bfed866b07b8d100f017616e2f2a"><div class="ttname"><a href="base_2array__view_8h.html#a2339bfed866b07b8d100f017616e2f2a">make_array_view</a></div><div class="ttdeci">ArrayView&lt; typename std::remove_reference&lt; typename std::iterator_traits&lt; Iterator &gt;::reference &gt;::type, MemorySpaceType &gt; make_array_view(const Iterator begin, const Iterator end)</div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00715">array_view.h:715</a></div></div>
<div class="ttc" id="aclassDoFHandler_html_aa5b8d3c4b9deb0774dde5c2851e07e1e"><div class="ttname"><a href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">DoFHandler::n_dofs</a></div><div class="ttdeci">types::global_dof_index n_dofs() const</div></div>
<div class="ttc" id="afunction__0_8txt_html_a4f780342f2d5d632f82cf7fd90158a66"><div class="ttname"><a href="function__0_8txt.html#a4f780342f2d5d632f82cf7fd90158a66">size</a></div><div class="ttdeci">it defaults to i e the first component **Return all components of a vector valued function at a given point&lt; tt &gt; values&lt;/tt &gt; shall have the right size i e **Set&lt; tt &gt; values&lt;/tt &gt; to the point values of the specified component of the function at the&lt; tt &gt; points&lt;/tt &gt; It is assumed that&lt; tt &gt; values&lt;/tt &gt; already has the right size</div><div class="ttdef"><b>Definition:</b> <a href="function__0_8txt_source.html#l00052">function_0.txt:52</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a02f5aa616d7b0799c538fe77d6c6c795"><div class="ttname"><a href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a></div><div class="ttdeci">i e</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00028">coding_conventions_0.txt:28</a></div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
