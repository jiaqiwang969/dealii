<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_22.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-22 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-22 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_6.html">step-6</a>, <a class="el" href="step_21.html">step-21</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Weakform">Weak form</a>
        <li><a href="#Boundaryconditions">Boundary conditions</a>
        <li><a href="#Discretization">Discretization</a>
        <li><a href="#Linearsolverandpreconditioningissues">Linear solver and preconditioning issues</a>
      <ul>
        <li><a href="#IsthishowoneshouldsolvetheStokesequations"> Is this how one should solve the Stokes equations? </a>
        <li><a href="#Anoteonthestructureofthelinearsystem"> A note on the structure of the linear system </a>
      </ul>
        <li><a href="#Thetestcase">The testcase</a>
        <li><a href="#Implementation">Implementation</a>
      <ul>
        <li><a href="#UsingimhomogeneousconstraintsforimplementingDirichletboundaryconditions">Using imhomogeneous constraints for implementing Dirichlet boundary conditions</a>
        <li><a href="#UsingAffineConstraintsforincreasingperformance">Using AffineConstraints for increasing performance</a>
        <li><a href="#Performanceoptimizations">Performance optimizations</a>
    </ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#Definingtheinnerpreconditionertype">Defining the inner preconditioner type</a>
        <li><a href="#ThecodeStokesProblemcodeclasstemplate">The <code>StokesProblem</code> class template</a>
        <li><a href="#Boundaryvaluesandrighthandside">Boundary values and right hand side</a>
        <li><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a>
      <ul>
        <li><a href="#ThecodeInverseMatrixcodeclasstemplate">The <code>InverseMatrix</code> class template</a>
        <li><a href="#ThecodeSchurComplementcodeclasstemplate">The <code>SchurComplement</code> class template</a>
      </ul>
        <li><a href="#StokesProblemclassimplementation">StokesProblem class implementation</a>
      <ul>
        <li><a href="#StokesProblemStokesProblem">StokesProblem::StokesProblem</a>
        <li><a href="#StokesProblemsetup_dofs">StokesProblem::setup_dofs</a>
        <li><a href="#StokesProblemassemble_system">StokesProblem::assemble_system</a>
        <li><a href="#StokesProblemsolve">StokesProblem::solve</a>
        <li><a href="#StokesProblemoutput_results">StokesProblem::output_results</a>
        <li><a href="#StokesProblemrefine_mesh">StokesProblem::refine_mesh</a>
        <li><a href="#StokesProblemrun">StokesProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Outputoftheprogramandgraphicalvisualization">Output of the program and graphical visualization</a>
      <ul>
        <li><a href="#2Dcalculations">2D calculations</a>
        <li><a href="#3Dcalculations">3D calculations</a>
      </ul>
        <li><a href="#Sparsitypattern">Sparsity pattern</a>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
      <ul>
        <li><a href="#Improvedlinearsolverin3D">Improved linear solver in 3D</a>
      <ul>
        <li><a href="#BetterILUdecompositionbysmartreordering">Better ILU decomposition by smart reordering</a>
        <li><a href="#BetterpreconditionerfortheinnerCGsolver">Better preconditioner for the inner CG solver</a>
        <li><a href="#BlockSchurcomplementpreconditioner">Block Schur complement preconditioner</a>
        <li><a href="#Combiningtheblockpreconditionerandmultigrid">Combining the block preconditioner and multigrid</a>
        <li><a href="#Noblockmatricesandvectors">No block matrices and vectors</a>
      </ul>
        <li><a href="#Moreinterestingtestcases">More interesting testcases</a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
</p>
<p><em>This program was contributed by Martin Kronbichler and Wolfgang Bangerth. <br  />
 This material is based upon work partly supported by the National Science Foundation under Award No. EAR-0426271 and The California Institute of Technology. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation or of The California Institute of Technology. </em></p>
<p><a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>This program deals with the Stokes system of equations which reads as follows in non-dimensionalized form: </p><p class="formulaDsp">
\begin{eqnarray*} -2\; \textrm{div}\; \varepsilon(\textbf{u}) + \nabla p &amp;=&amp; \textbf{f}, \\ -\textrm{div}\; \textbf{u} &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> where \(\textbf u\) denotes the velocity of a fluid, \(p\) is its pressure, \(\textbf f\) are external forces, and \(\varepsilon(\textbf{u})= \nabla^s{\textbf{u}}= \frac 12 \left[ (\nabla \textbf{u}) + (\nabla \textbf{u})^T\right]\) is the rank-2 tensor of symmetrized gradients; a component-wise definition of it is \(\varepsilon(\textbf{u})_{ij}=\frac 12\left(\frac{\partial u_i}{\partial x_j} + \frac{\partial u_j}{\partial x_i}\right)\).</p>
<p>The Stokes equations describe the steady-state motion of a slow-moving, viscous fluid such as honey, rocks in the earth mantle, or other cases where inertia does not play a significant role. If a fluid is moving fast enough that inertia forces are significant compared to viscous friction, the Stokes equations are no longer valid; taking into account inertia effects then leads to the nonlinear Navier-Stokes equations. However, in this tutorial program, we will focus on the simpler Stokes system.</p>
<p>Note that when deriving the more general compressible Navier-Stokes equations, the diffusion is modeled as the divergence of the stress tensor </p><p class="formulaDsp">
\begin{eqnarray*} \tau = - \mu (2\varepsilon(\textbf{u}) - \frac{2}{3}\nabla \cdot \textbf{u} I), \end{eqnarray*}
</p>
<p> where \(\mu\) is the viscosity of the fluid. With the assumption of \(\mu=1\) (assume constant viscosity and non-dimensionalize the equation by dividing out \(\mu\)) and assuming incompressibility ( \(\textrm{div}\; \textbf{u}=0\)), we arrive at the formulation from above: </p><p class="formulaDsp">
\begin{eqnarray*} \textrm{div}\; \tau = -2\textrm{div}\;\varepsilon(\textbf{u}). \end{eqnarray*}
</p>
<p> A different formulation uses the Laplace operator ( \(-\triangle \textbf{u}\)) instead of the symmetrized gradient. A big difference here is that the different components of the velocity do not couple. If you assume additional regularity of the solution \(\textbf{u}\) (second partial derivatives exist and are continuous), the formulations are equivalent: </p><p class="formulaDsp">
\begin{eqnarray*} \textrm{div}\; \tau = -2\textrm{div}\;\varepsilon(\textbf{u}) = -\triangle \textbf{u} + \nabla \cdot (\nabla\textbf{u})^T = -\triangle \textbf{u}. \end{eqnarray*}
</p>
<p> This is because the \(i\)th entry of \(\nabla \cdot (\nabla\textbf{u})^T\) is given by: </p><p class="formulaDsp">
\begin{eqnarray*} [\nabla \cdot (\nabla\textbf{u})^T]_i = \sum_j \frac{\partial}{\partial x_j} [(\nabla\textbf{u})^T]_{i,j} = \sum_j \frac{\partial}{\partial x_j} [(\nabla\textbf{u})]_{j,i} = \sum_j \frac{\partial}{\partial x_j} \frac{\partial}{\partial x_i} \textbf{u}_j = \sum_j \frac{\partial}{\partial x_i} \frac{\partial}{\partial x_j} \textbf{u}_j = \frac{\partial}{\partial x_i} \textrm{div}\; \textbf{u} = 0. \end{eqnarray*}
</p>
<p> If you can not assume the above mentioned regularity, or if your viscosity is not a constant, the equivalence no longer holds. Therefore, we decided to stick with the more physically accurate symmetric tensor formulation in this tutorial.</p>
<p>To be well-posed, we will have to add boundary conditions to the equations. What boundary conditions are readily possible here will become clear once we discuss the weak form of the equations.</p>
<p>The equations covered here fall into the class of vector-valued problems. A toplevel overview of this topic can be found in the <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> module.</p>
<p><a class="anchor" id="Weakform"></a></p><h3>Weak form</h3>
<p>The weak form of the equations is obtained by writing it in vector form as </p><p class="formulaDsp">
\begin{eqnarray*} \begin{pmatrix} {-2\; \textrm{div}\; \varepsilon(\textbf{u}) + \nabla p} \\ {-\textrm{div}\; \textbf{u}} \end{pmatrix} = \begin{pmatrix} {\textbf{f}} \\ 0 \end{pmatrix}, \end{eqnarray*}
</p>
<p> forming the dot product from the left with a vector-valued test function \(\phi = \begin{pmatrix}\textbf{v} \\ q\end{pmatrix}\) and integrating over the domain \(\Omega\), yielding the following set of equations: </p><p class="formulaDsp">
\begin{eqnarray*} (\mathrm v, -2\; \textrm{div}\; \varepsilon(\textbf{u}) + \nabla p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega, \end{eqnarray*}
</p>
<p> which has to hold for all test functions \(\phi = \begin{pmatrix}\textbf{v} \\ q\end{pmatrix}\).</p>
<p>A generally good rule of thumb is that if one <em>can</em> reduce how many derivatives are taken on any variable in the formulation, then one <em>should</em> in fact do that using integration by parts. (This is motivated by the theory of <a href="https://en.wikipedia.org/wiki/Partial_differential_equation">partial differential equations</a>, and in particular the difference between strong and <a href="https://en.wikipedia.org/wiki/Weak_solution">weak solutions</a>.) We have already done that for the Laplace equation, where we have integrated the second derivative by parts to obtain the weak formulation that has only one derivative on both test and trial function.</p>
<p>In the current context, we integrate by parts the second term: </p><p class="formulaDsp">
\begin{eqnarray*} (\textbf{v}, -2\; \textrm{div}\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} + (\textbf{n}\cdot\textbf{v}, p)_{\partial\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega. \end{eqnarray*}
</p>
<p> Likewise, we integrate by parts the first term to obtain </p><p class="formulaDsp">
\begin{eqnarray*} (\nabla \textbf{v}, 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textbf{n} \otimes \textbf{v}, 2\; \varepsilon(\textbf{u}))_{\partial\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} + (\textbf{n}\cdot\textbf{v}, p)_{\partial\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega, \end{eqnarray*}
</p>
<p> where the scalar product between two tensor-valued quantities is here defined as </p><p class="formulaDsp">
\begin{eqnarray*} (\nabla \textbf{v}, 2\; \varepsilon(\textbf{u}))_{\Omega} = 2 \int_\Omega \sum_{i,j=1}^d \frac{\partial v_j}{\partial x_i} \varepsilon(\textbf{u})_{ij} \ dx. \end{eqnarray*}
</p>
<p> Using this, we have now reduced the requirements on our variables to first derivatives for \(\mathbf u,\mathbf v\) and no derivatives at all for \(p,q\).</p>
<p>Because the scalar product between a general tensor like \(\nabla\textbf{v}\) and a symmetric tensor like \(\varepsilon(\textbf{u})\) equals the scalar product between the symmetrized forms of the two, we can also write the bilinear form above as follows: </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textbf{n} \otimes \textbf{v}, 2\; \varepsilon(\textbf{u}))_{\partial\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} + (\textbf{n}\cdot\textbf{v}, p)_{\partial\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega, \end{eqnarray*}
</p>
<p> We will deal with the boundary terms in the next section, but it is already clear from the domain terms </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} \end{eqnarray*}
</p>
<p> of the bilinear form that the Stokes equations yield a symmetric bilinear form, and consequently a symmetric (if indefinite) system matrix.</p>
<p><a class="anchor" id="Boundaryconditions"></a></p><h3>Boundary conditions</h3>
<dl class="section note"><dt>Note</dt><dd>The material presented here is also discussed in <a href="http://www.math.colostate.edu/~bangerth/videos.676.21.5.html">video lecture 21.5</a>. (All video lectures are also available <a href="http://www.math.colostate.edu/~bangerth/videos.html">here</a>.) (See also <a href="http://www.math.colostate.edu/~bangerth/videos.676.21.55.html">video lecture 21.55</a>, <a href="http://www.math.colostate.edu/~bangerth/videos.676.21.6.html">video lecture 21.6</a>, <a href="http://www.math.colostate.edu/~bangerth/videos.676.21.65.html">video lecture 21.65</a>.)</dd></dl>
<p>The weak form just derived immediately presents us with different possibilities for imposing boundary conditions: </p><ol>
<li>
<p class="startli">Dirichlet velocity boundary conditions: On a part \(\Gamma_D\subset\partial\Omega\) we may impose Dirichlet conditions on the velocity \(\textbf u\):</p>
<p class="formulaDsp">
\begin{eqnarray*} \textbf u = \textbf g_D \qquad\qquad \textrm{on}\ \Gamma_D. \end{eqnarray*}
</p>
<p> Because test functions \(\textbf{v}\) come from the tangent space of the solution variable, we have that \(\textbf{v}=0\) on \(\Gamma_D\) and consequently that </p><p class="formulaDsp">
\begin{eqnarray*} -(\textbf{n} \otimes \mathrm v, 2\; \varepsilon(\textbf{u}))_{\Gamma_D} + (\textbf{n}\cdot\textbf{v}, p)_{\Gamma_D} = 0. \end{eqnarray*}
</p>
<p> In other words, as usual, strongly imposed boundary values do not appear in the weak form.</p>
<p class="interli">It is noteworthy that if we impose Dirichlet boundary values on the entire boundary, then the pressure is only determined up to a constant. An algorithmic realization of that would use similar tools as have been seen in <a class="el" href="step_11.html">step-11</a>.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Neumann-type or natural boundary conditions: On the rest of the boundary \(\Gamma_N=\partial\Omega\backslash\Gamma_D\), let us re-write the boundary terms as follows: </p><p class="formulaDsp">
\begin{eqnarray*} -(\textbf{n} \otimes \mathrm v, 2\; \varepsilon(\textbf{u}))_{\Gamma_N} + (\textbf{n}\cdot\textbf{v}, p)_{\Gamma_N} &amp;=&amp; \sum_{i,j=1}^d -(n_i v_j, 2\; \varepsilon(\textbf{u})_{ij})_{\Gamma_N} + \sum_{i=1}^d (n_i v_i, p)_{\Gamma_N} \\ &amp;=&amp; \sum_{i,j=1}^d -(n_i v_j, 2\; \varepsilon(\textbf{u})_{ij})_{\Gamma_N} + \sum_{i,j=1}^d (n_i v_j, p \delta_{ij})_{\Gamma_N} \\ &amp;=&amp; \sum_{i,j=1}^d (n_i v_j,p \delta_{ij} - 2\; \varepsilon(\textbf{u})_{ij})_{\Gamma_N} \\ &amp;=&amp; (\textbf{n} \otimes \textbf{v}, p \textbf{I} - 2\; \varepsilon(\textbf{u}))_{\Gamma_N}. \\ &amp;=&amp; (\textbf{v}, \textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})])_{\Gamma_N}. \end{eqnarray*}
</p>
<p> In other words, on the Neumann part of the boundary we can prescribe values for the total stress: </p><p class="formulaDsp">
\begin{eqnarray*} \textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})] = \textbf g_N \qquad\qquad \textrm{on}\ \Gamma_N. \end{eqnarray*}
</p>
<p> If the boundary is subdivided into Dirichlet and Neumann parts \(\Gamma_D,\Gamma_N\), this then leads to the following weak form: </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega - (\textbf{v}, \textbf g_N)_{\Gamma_N}. \end{eqnarray*}
</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Robin-type boundary conditions: Robin boundary conditions are a mixture of Dirichlet and Neumann boundary conditions. They would read </p><p class="formulaDsp">
\begin{eqnarray*} \textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})] = \textbf S \textbf u \qquad\qquad \textrm{on}\ \Gamma_R, \end{eqnarray*}
</p>
<p> with a rank-2 tensor (matrix) \(\textbf S\). The associated weak form is </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} + (\textbf S \textbf u, \textbf{v})_{\Gamma_R} = (\textbf{v}, \textbf{f})_\Omega. \end{eqnarray*}
</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Partial boundary conditions: It is possible to combine Dirichlet and Neumann boundary conditions by only enforcing each of them for certain components of the velocity. For example, one way to impose artificial boundary conditions is to require that the flow is perpendicular to the boundary, i.e. the tangential component \(\textbf u_{\textbf t}=(\textbf 1-\textbf n\otimes\textbf n)\textbf u\) be zero, thereby constraining <code>dim</code>-1 components of the velocity. The remaining component can be constrained by requiring that the normal component of the normal stress be zero, yielding the following set of boundary conditions: </p><p class="formulaDsp">
\begin{eqnarray*} \textbf u_{\textbf t} &amp;=&amp; 0, \\ \textbf n \cdot \left(\textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})] \right) &amp;=&amp; 0. \end{eqnarray*}
</p>
<p class="endli">An alternative to this is when one wants the flow to be <em>parallel</em> rather than perpendicular to the boundary (in deal.II, the <a class="el" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a> function can do this for you). This is frequently the case for problems with a free boundary (e.g. at the surface of a river or lake if vertical forces of the flow are not large enough to actually deform the surface), or if no significant friction is exerted by the boundary on the fluid (e.g. at the interface between earth mantle and earth core where two fluids meet that are stratified by different densities but that both have small enough viscosities to not introduce much tangential stress on each other). In formulas, this means that </p><p class="formulaDsp">
\begin{eqnarray*} \textbf{n}\cdot\textbf u &amp;=&amp; 0, \\ (\textbf 1-\textbf n\otimes\textbf n) \left(\textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})] \right) &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> the first condition (which needs to be imposed strongly) fixing a single component of the velocity, with the second (which would be enforced in the weak form) fixing the remaining two components. </p>
</li>
</ol>
<p>Despite this wealth of possibilities, we will only use Dirichlet and (homogeneous) Neumann boundary conditions in this tutorial program.</p>
<p><a class="anchor" id="Discretization"></a></p><h3>Discretization</h3>
<p>As developed above, the weak form of the equations with Dirichlet and Neumann boundary conditions on \(\Gamma_D\) and \(\Gamma_N\) reads like this: find \(\textbf u\in \textbf V_g = \{\varphi \in H^1(\Omega)^d: \varphi_{\Gamma_D}=\textbf g_D\}, p\in Q=L^2(\Omega)\) so that </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega - (\textbf{v}, \textbf g_N)_{\Gamma_N} \end{eqnarray*}
</p>
<p> for all test functions \(\textbf{v}\in \textbf V_0 = \{\varphi \in H^1(\Omega)^d: \varphi_{\Gamma_D}=0\},q\in Q\).</p>
<p>These equations represent a symmetric <a href="https://en.wikipedia.org/wiki/Ladyzhenskaya%E2%80%93Babu%C5%A1ka%E2%80%93Brezzi_condition">saddle point problem</a>. It is well known that then a solution only exists if the function spaces in which we search for a solution have to satisfy certain conditions, typically referred to as the Babuska-Brezzi or Ladyzhenskaya-Babuska-Brezzi (LBB) conditions. The continuous function spaces above satisfy these. However, when we discretize the equations by replacing the continuous variables and test functions by finite element functions in finite dimensional spaces \(\textbf V_{g,h}\subset \textbf V_g, Q_h\subset Q\), we have to make sure that \(\textbf V_h,Q_h\) also satisfy the LBB conditions. This is similar to what we had to do in <a class="el" href="step_20.html">step-20</a>.</p>
<p>For the Stokes equations, there are a number of possible choices to ensure that the finite element spaces are compatible with the LBB condition. A simple and accurate choice that we will use here is \(\textbf u_h\in Q_{p+1}^d, p_h\in Q_p\), i.e. use elements one order higher for the velocities than for the pressures.</p>
<p>This then leads to the following discrete problem: find \(\textbf u_h,p_h\) so that </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}_h), 2\; \varepsilon(\textbf u_h))_{\Omega} - (\textrm{div}\; \textbf{v}_h, p_h)_{\Omega} - (q_h,\textrm{div}\; \textbf{u}_h)_{\Omega} = (\textbf{v}_h, \textbf{f})_\Omega - (\textbf{v}_h, \textbf g_N)_{\Gamma_N} \end{eqnarray*}
</p>
<p> for all test functions \(\textbf{v}_h, q_h\). Assembling the linear system associated with this problem follows the same lines used in <a class="el" href="step_20.html">step-20</a>, <a class="el" href="step_21.html">step-21</a>, and explained in detail in the <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> module.</p>
<p><a class="anchor" id="Linearsolverandpreconditioningissues"></a></p><h3>Linear solver and preconditioning issues</h3>
<p>The weak form of the discrete equations naturally leads to the following linear system for the nodal values of the velocity and pressure fields: </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{c} U \\ P \end{array}\right) = \left(\begin{array}{c} F \\ G \end{array}\right), \end{eqnarray*}
</p>
<p> Like in <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a>, we will solve this system of equations by forming the Schur complement, i.e. we will first find the solution \(P\) of </p><p class="formulaDsp">
\begin{eqnarray*} BA^{-1}B^T P &amp;=&amp; BA^{-1} F - G, \\ \end{eqnarray*}
</p>
<p> and then </p><p class="formulaDsp">
\begin{eqnarray*} AU &amp;=&amp; F - B^TP. \end{eqnarray*}
</p>
<p> The way we do this is pretty much exactly like we did in these previous tutorial programs, i.e. we use the same classes <code>SchurComplement</code> and <code>InverseMatrix</code> again. There are two significant differences, however:</p>
<ol>
<li>
<p class="startli">First, in the mixed Laplace equation we had to deal with the question of how to precondition the Schur complement \(B^TM^{-1}B\), which was spectrally equivalent to the Laplace operator on the pressure space (because \(B\) represents the gradient operator, \(B^T\) its adjoint \(-\textrm{div}\), and \(M\) the identity (up to the material parameter \(K^{-1}\)), so \(B^TM^{-1}B\) is something like \(-\textrm{div} \mathbf 1 \nabla = -\Delta\)). Consequently, the matrix is badly conditioned for small mesh sizes and we had to come up with an elaborate preconditioning scheme for the Schur complement.</p>
<p class="endli"></p>
</li>
<li>
Second, every time we multiplied with \(B^TM^{-1}B\) we had to solve with the mass matrix \(M\). This wasn't particularly difficult, however, since the mass matrix is always well conditioned and so simple to invert using CG and a little bit of preconditioning. </li>
</ol>
<p>In other words, preconditioning the inner solver for \(M\) was simple whereas preconditioning the outer solver for \(B^TM^{-1}B\) was complicated.</p>
<p>Here, the situation is pretty much exactly the opposite. The difference stems from the fact that the matrix at the heart of the Schur complement does not stem from the identity operator but from a variant of the Laplace operator, \(-\textrm{div} \nabla^s\) (where \(\nabla^s\) is the symmetric gradient) acting on a vector field. In the investigation of this issue we largely follow the paper D. Silvester and A. Wathen: "Fast iterative solution of stabilised Stokes systems part II. Using
general block preconditioners." (SIAM J. Numer. Anal., 31 (1994), pp. 1352-1367), which is available online <a href="http://siamdl.aip.org/getabs/servlet/GetabsServlet?prog=normal&amp;id=SJNAAM000031000005001352000001&amp;idtype=cvips&amp;gifs=Yes" target="_top">here</a>. Principally, the difference in the matrix at the heart of the Schur complement has two consequences:</p>
<ol>
<li>
<p class="startli">First, it makes the outer preconditioner simple: the Schur complement corresponds to the operator \(-\textrm{div} (-\textrm{div} \nabla^s)^{-1} \nabla\) on the pressure space; forgetting about the fact that we deal with symmetric gradients instead of the regular one, the Schur complement is something like \(-\textrm{div} (-\textrm{div} \nabla)^{-1} \nabla = -\textrm{div} (-\Delta)^{-1} \nabla\), which, even if not mathematically entirely concise, is spectrally equivalent to the identity operator (a heuristic argument would be to commute the operators into \(-\textrm{div}(-\Delta)^{-1} \nabla = -\textrm{div}\nabla(-\Delta)^{-1} = -\Delta(-\Delta)^{-1} = \mathbf 1\)). It turns out that it isn't easy to solve this Schur complement in a straightforward way with the CG method: using no preconditioner, the condition number of the Schur complement matrix depends on the size ratios of the largest to the smallest cells, and one still needs on the order of 50-100 CG iterations. However, there is a simple cure: precondition with the mass matrix on the pressure space and we get down to a number between 5-15 CG iterations, pretty much independently of the structure of the mesh (take a look at the <a href="#Results">results section</a> of this program to see that indeed the number of CG iterations does not change as we refine the mesh).</p>
<p class="interli">So all we need in addition to what we already have is the mass matrix on the pressure variables and we will store it in a separate object.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">While the outer preconditioner has become simpler compared to the mixed Laplace case discussed in <a class="el" href="step_20.html">step-20</a>, the issue of the inner solver has become more complicated. In the mixed Laplace discretization, the Schur complement has the form \(B^TM^{-1}B\). Thus, every time we multiplied with the Schur complement, we had to solve a linear system \(M_uz=y\); this isn't too complicated there, however, since the mass matrix \(M_u\) on the pressure space is well-conditioned.</p>
<p class="interli">On the other hand, for the Stokes equation we consider here, the Schur complement is \(BA^{-1}B^T\) where the matrix \(A\) is related to the Laplace operator (it is, in fact, the matrix corresponding to the bilinear form \((\nabla^s \varphi_i, \nabla^s\varphi_j)\)). Thus, solving with \(A\) is a lot more complicated: the matrix is badly conditioned and we know that we need many iterations unless we have a very good preconditioner. What is worse, we have to solve with \(A\) every time we multiply with the Schur complement, which is 5-15 times using the preconditioner described above.</p>
<p class="interli">Because we have to solve with \(A\) several times, it pays off to spend a bit more time once to create a good preconditioner for this matrix. So here's what we're going to do: if in 2d, we use the ultimate preconditioner, namely a direct sparse LU decomposition of the matrix. This is implemented using the <a class="el" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> class that uses the UMFPACK direct solver to compute the decomposition. To use it, you will have to build deal.II with UMFPACK support (which is the default); see the <a href="../../readme.html#optional-software">ReadMe file</a> for instructions. With this, the inner solver converges in one iteration.</p>
<p class="interli">In 2d, we can do this sort of thing because even reasonably large problems rarely have more than a few 100,000 unknowns with relatively few nonzero entries per row. Furthermore, the bandwidth of matrices in 2d is \({\cal O}(\sqrt{N})\) and therefore moderate. For such matrices, sparse factors can be computed in a matter of a few seconds. (As a point of reference, computing the sparse factors of a matrix of size \(N\) and bandwidth \(B\) takes \({\cal O}(NB^2)\) operations. In 2d, this is \({\cal O}(N^2)\); though this is a higher complexity than, for example, assembling the linear system which takes \({\cal O}(N)\), the constant for computing the decomposition is so small that it doesn't become the dominating factor in the entire program until we get to very large numbers of unknowns in the high 100,000s or more.)</p>
<p class="interli">The situation changes in 3d, because there we quickly have many more unknowns and the bandwidth of matrices (which determines the number of nonzero entries in sparse LU factors) is \({\cal O}(N^{2/3})\), and there are many more entries per row as well. This makes using a sparse direct solver such as UMFPACK inefficient: only for problem sizes of a few 10,000 to maybe 100,000 unknowns can a sparse decomposition be computed using reasonable time and memory resources.</p>
<p class="endli">What we do in that case is to use an incomplete LU decomposition (ILU) as a preconditioner, rather than actually computing complete LU factors. As it so happens, deal.II has a class that does this: <a class="el" href="classSparseILU.html">SparseILU</a>. Computing the ILU takes a time that only depends on the number of nonzero entries in the sparse matrix (or that we are willing to fill in the LU factors, if these should be more than the ones in the matrix), but is independent of the bandwidth of the matrix. It is therefore an operation that can efficiently also be computed in 3d. On the other hand, an incomplete LU decomposition, by definition, does not represent an exact inverse of the matrix \(A\). Consequently, preconditioning with the ILU will still require more than one iteration, unlike preconditioning with the sparse direct solver. The inner solver will therefore take more time when multiplying with the Schur complement: an unavoidable trade-off. </p>
</li>
</ol>
<p>In the program below, we will make use of the fact that the <a class="el" href="classSparseILU.html">SparseILU</a> and <a class="el" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> classes have a very similar interface and can be used interchangeably. All that we need is a switch class that, depending on the dimension, provides a type that is either of the two classes mentioned above. This is how we do that: </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner&lt;2&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner&lt;3&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p>From here on, we can refer to the type <code>typename InnerPreconditioner&lt;dim&gt;::type</code> and automatically get the correct preconditioner class. Because of the similarity of the interfaces of the two classes, we will be able to use them interchangeably using the same syntax in all places.</p>
<p><a class="anchor" id="IsthishowoneshouldsolvetheStokesequations"></a></p><h4>Is this how one should solve the Stokes equations? </h4>
<p>The discussions above showed <em>one</em> way in which the linear system that results from the Stokes equations can be solved, and because the tutorial programs are teaching tools that makes sense. But is this the way this system of equations <em>should</em> be solved?</p>
<p>The answer to this is no. The primary bottleneck with the approach, already identified above, is that we have to repeatedly solve linear systems with \(A\) inside the Schur complement, and because we don't have a good preconditioner for the Schur complement, these solves just have to happen too often. A better approach is to use a block decomposition, which is based on an observation of Silvester and Wathen <b>[SW94]</b> and explained in much greater detail in <b>[elman2005]</b> . An implementation of this alternative approach is discussed below, in the section on a <a href="#block-schur">block Schur complementation preconditioner</a> in the results section of this program.</p>
<p><a class="anchor" id="Anoteonthestructureofthelinearsystem"></a></p><h4>A note on the structure of the linear system </h4>
<p>Above, we have claimed that the linear system has the form </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{cc} U \\ P \end{array}\right) = \left(\begin{array}{cc} F \\ G \end{array}\right), \end{eqnarray*}
</p>
<p> i.e., in particular that there is a zero block at the bottom right of the matrix. This then allowed us to write the Schur complement as \(S=B A^{-1} B^T\). But this is not quite correct.</p>
<p>Think of what would happen if there are constraints on some pressure variables (see the <a class="el" href="group__constraints.html">Constraints on degrees of freedom</a> documentation module), for example because we use adaptively refined meshes and continuous pressure finite elements so that there are hanging nodes. Another cause for such constraints are Dirichlet boundary conditions on the pressure. Then the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class, upon copying the local contributions to the matrix into the global linear system will zero out rows and columns corresponding to constrained degrees of freedom and put a positive entry on the diagonal. (You can think of this entry as being one for simplicity, though in reality it is a value of the same order of magnitude as the other matrix entries.) In other words, the bottom right block is really not empty at all: It has a few entries on the diagonal, one for each constrained pressure degree of freedom, and a correct description of the linear system we have to solve is that it has the form </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; D_c \end{array}\right) \left(\begin{array}{cc} U \\ P \end{array}\right) = \left(\begin{array}{cc} F \\ G \end{array}\right), \end{eqnarray*}
</p>
<p> where \(D_c\) is the zero matrix with the exception of the positive diagonal entries for the constrained degrees of freedom. The correct Schur complement would then in fact be the matrix \(S = B A^{-1} B^T - D_c \) instead of the one stated above.</p>
<p>Thinking about this makes us, first, realize that the resulting Schur complement is now indefinite because \(B A^{-1} B^T\) is symmetric and positive definite whereas \(D_c\) is a positive semidefinite, and subtracting the latter from the former may no longer be positive definite. This is annoying because we could no longer employ the Conjugate Gradient method on this true Schur complement. That said, we could fix the issue in <a class="el" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global()</a> by simply putting <em>negative</em> values onto the diagonal for the constrained pressure variables &ndash; because we really only put something nonzero to ensure that the resulting matrix is not singular; we really didn't care whether that entry is positive or negative. So if the entries on the diagonal of \(D_c\) were negative, then \(S\) would again be a symmetric and positive definite matrix.</p>
<p>But, secondly, the code below doesn't actually do any of that: It happily solves the linear system with the wrong Schur complement \(S = B A^{-1} B^T\) that just ignores the issue altogether. Why does this even work? To understand why this is so, recall that when writing local contributions into the global matrix, <a class="el" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global()</a> zeros out the rows and columns that correspond to constrained degrees of freedom. This means that \(B\) has some zero rows, and \(B^T\) zero columns. As a consequence, if one were to multiply out what the entries of \(S\) are, one would realize that it has zero rows and columns for all constrained pressure degrees of freedom, including a zero on the diagonal. The nonzero entries of \(D_c\) would fit into exactly those zero diagonal locations, and ensure that \(S\) is invertible. Not doing so, strictly speaking, means that \(S\) remains singular: It is symmetric and positive definite on the subset of non-constrained pressure degrees of freedom, and simply the zero matrix on the constrained pressures. Why does the Conjugate Gradient method work for this matrix? Because <a class="el" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global()</a> also makes sure that the right hand side entries that correspond to these zero rows of the matrix are <em>also</em> zero, i.e., the right hand side is compatible.</p>
<p>What this means is that whatever the values of the solution vector for these constrained pressure degrees of freedom, these rows will always have a zero residual and, if one were to consider what the CG algorithm does internally, just never produce any updates to the solution vector. In other words, the CG algorithm just <em>ignores</em> these rows, despite the fact that the matrix is singular. This only works because these degrees of freedom are entirely decoupled from the rest of the linear system (because the entire row and corresponding column are zero). At the end of the solution process, the constrained pressure values in the solution vector therefore remain exactly as they were when we started the call to the solver; they are finally overwritten with their correct values when we call <a class="el" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">AffineConstraints::distribute()</a> after the CG solver is done.</p>
<p>The upshot of this discussion is that the assumption that the bottom right block of the big matrix is zero is a bit simplified, but that just going with it does not actually lead to any practical problems worth addressing.</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>The domain, right hand side and boundary conditions we implement below relate to a problem in geophysics: there, one wants to compute the flow field of magma in the earth's interior under a mid-ocean rift. Rifts are places where two continental plates are very slowly drifting apart (a few centimeters per year at most), leaving a crack in the earth crust that is filled with magma from below. Without trying to be entirely realistic, we model this situation by solving the following set of equations and boundary conditions on the domain \(\Omega=[-2,2]\times[0,1]\times[-1,0]\): </p><p class="formulaDsp">
\begin{eqnarray*} -2\; \textrm{div}\; \varepsilon(\textbf{u}) + \nabla p &amp;=&amp; 0, \\ -\textrm{div}\; \textbf{u} &amp;=&amp; 0, \\ \mathbf u &amp;=&amp; \left(\begin{array}{c} -1 \\ 0 \\0 \end{array}\right) \qquad\qquad \textrm{at}\ z=0, x&lt;0, \\ \mathbf u &amp;=&amp; \left(\begin{array}{c} +1 \\ 0 \\0 \end{array}\right) \qquad\qquad \textrm{at}\ z=0, x&gt;0, \\ \mathbf u &amp;=&amp; \left(\begin{array}{c} 0 \\ 0 \\0 \end{array}\right) \qquad\qquad \textrm{at}\ z=0, x=0, \end{eqnarray*}
</p>
<p> and using natural boundary conditions \(\textbf{n}\cdot [p \textbf{I} - 2 \varepsilon(\textbf{u})] = 0\) everywhere else. In other words, at the left part of the top surface we prescribe that the fluid moves with the continental plate to the left at speed \(-1\), that it moves to the right on the right part of the top surface, and impose natural flow conditions everywhere else. If we are in 2d, the description is essentially the same, with the exception that we omit the second component of all vectors stated above.</p>
<p>As will become apparent in the <a href="#Results">results section</a>, the flow field will pull material from below and move it to the left and right ends of the domain, as expected. The discontinuity of velocity boundary conditions will produce a singularity in the pressure at the center of the top surface that sucks material all the way to the top surface to fill the gap left by the outward motion of material at this location.</p>
<p><a class="anchor" id="Implementation"></a></p><h3>Implementation</h3>
<p><a class="anchor" id="UsingimhomogeneousconstraintsforimplementingDirichletboundaryconditions"></a></p><h4>Using imhomogeneous constraints for implementing Dirichlet boundary conditions</h4>
<p>In all the previous tutorial programs, we used the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object merely for handling hanging node constraints (with exception of <a class="el" href="step_11.html">step-11</a>). However, the class can also be used to implement Dirichlet boundary conditions, as we will show in this program, by fixing some node values \(x_i = b_i\). Note that these are inhomogeneous constraints, and we have to pay some special attention to that. The way we are going to implement this is to first read in the boundary values into the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object by using the call</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a> (dof_handler,</div>
<div class="line">                                          1,</div>
<div class="line">                                          <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                          <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
</div><!-- fragment --><p>very similar to how we were making the list of boundary nodes before (note that we set Dirichlet conditions only on boundaries with boundary flag 1). The actual application of the boundary values is then handled by the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object directly, without any additional interference.</p>
<p>We could then proceed as before, namely by filling the matrix, and then calling a condense function on the constraints object of the form </p><div class="fragment"><div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a5a1bc1bb2d705b582889ebaa24bcae5c">condense</a> (system_matrix, system_rhs);</div>
</div><!-- fragment --><p>Note that we call this on the system matrix and system right hand side simultaneously, since resolving inhomogeneous constraints requires knowledge about both the matrix entries and the right hand side. For efficiency reasons, though, we choose another strategy: all the constraints collected in the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object can be resolved on the fly while writing local data into the global matrix, by using the call </p><div class="fragment"><div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a> (local_matrix, local_rhs,</div>
<div class="line">                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                        system_matrix, system_rhs);</div>
</div><!-- fragment --><p>This technique is further discussed in the <a class="el" href="step_27.html">step-27</a> tutorial program. All we need to know here is that this functions does three things at once: it writes the local data into the global matrix and right hand side, it distributes the hanging node constraints and additionally implements (inhomogeneous) Dirichlet boundary conditions. That's nice, isn't it?</p>
<p>We can conclude that the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class provides an alternative to using <a class="el" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a> for implementing Dirichlet boundary conditions.</p>
<p><a class="anchor" id="constraint-matrix"></a> <a class="anchor" id="UsingAffineConstraintsforincreasingperformance"></a></p><h4>Using <a class="el" href="classAffineConstraints.html">AffineConstraints</a> for increasing performance</h4>
<p>Frequently, a sparse matrix contains a substantial amount of elements that actually are zero when we are about to start a linear solve. Such elements are introduced when we eliminate constraints or implement Dirichlet conditions, where we usually delete all entries in constrained rows and columns, i.e., we set them to zero. The fraction of elements that are present in the sparsity pattern, but do not really contain any information, can be up to one fourth of the total number of elements in the matrix for the 3D application considered in this tutorial program. Remember that matrix-vector products or preconditioners operate on all the elements of a sparse matrix (even those that are zero), which is an inefficiency we will avoid here.</p>
<p>An advantage of directly resolving constrained degrees of freedom is that we can avoid having most of the entries that are going to be zero in our sparse matrix &mdash; we do not need constrained entries during matrix construction (as opposed to the traditional algorithms, which first fill the matrix, and only resolve constraints afterwards). This will save both memory and time when forming matrix-vector products. The way we are going to do that is to pass the information about constraints to the function that generates the sparsity pattern, and then set a <code>false</code> argument specifying that we do not intend to use constrained entries: </p><div class="fragment"><div class="line"><a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a> (dof_handler, <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>,</div>
<div class="line">                                 <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
</div><!-- fragment --><p> This functions obviates, by the way, also the call to the <code>condense()</code> function on the sparsity pattern.</p>
<p><a class="anchor" id="Performanceoptimizations"></a></p><h4>Performance optimizations</h4>
<p>The program developed below has seen a lot of TLC. We have run it over and over under profiling tools (mainly <a href="http://www.valgrind.org/">valgrind</a>'s cachegrind and callgrind tools, as well as the KDE <a href="http://kcachegrind.sourceforge.net/">KCachegrind</a> program for visualization) to see where the bottlenecks are. This has paid off: through this effort, the program has become about four times as fast when considering the runtime of the refinement cycles zero through three, reducing the overall number of CPU instructions executed from 869,574,060,348 to 199,853,005,625. For higher refinement levels, the gain is probably even larger since some algorithms that are not \({\cal O}(N)\) have been eliminated.</p>
<p>Essentially, there are currently two algorithms in the program that do not scale linearly with the number of degrees of freedom: renumbering of degrees of freedom (which is \({\cal O}(N \log N)\), and the linear solver (which is \({\cal O}(N^{4/3})\)). As for the first, while reordering degrees of freedom may not scale linearly, it is an indispensable part of the overall algorithm as it greatly improves the quality of the sparse ILU, easily making up for the time spent on computing the renumbering; graphs and timings to demonstrate this are shown in the documentation of the <a class="el" href="namespaceDoFRenumbering.html">DoFRenumbering</a> namespace, also underlining the choice of the Cuthill-McKee reordering algorithm chosen below.</p>
<p>As for the linear solver: as mentioned above, our implementation here uses a Schur complement formulation. This is not necessarily the very best choice but demonstrates various important techniques available in deal.II. The question of which solver is best is again discussed in the <a href="#improved-solver">section on improved solvers in the results part</a> of this program, along with code showing alternative solvers and a comparison of their results.</p>
<p>Apart from this, many other algorithms have been tested and improved during the creation of this program. For example, in building the sparsity pattern, we originally used a (now no longer existing) BlockCompressedSparsityPattern object that added one element at a time; however, its data structures were poorly adapted for the large numbers of nonzero entries per row created by our discretization in 3d, leading to a quadratic behavior. Replacing the internal algorithms in deal.II to set many elements at a time, and using a BlockCompressedSimpleSparsityPattern (which has, as of early 2015, been in turn replaced by <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a>) as a better adapted data structure, removed this bottleneck at the price of a slightly higher memory consumption. Likewise, the implementation of the decomposition step in the <a class="el" href="classSparseILU.html">SparseILU</a> class was very inefficient and has been replaced by one that is about 10 times faster. Even the vmult function of the <a class="el" href="classSparseILU.html">SparseILU</a> has been improved to save about twenty percent of time. Small improvements were applied here and there. Moreover, the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object has been used to eliminate a lot of entries in the sparse matrix that are eventually going to be zero, see <a href="#constraint-matrix">the section on using advanced features of the AffineConstraints class</a>.</p>
<p>A profile of how many CPU instructions are spent at the various different places in the program during refinement cycles zero through three in 3d is shown here:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-22.profile-3.png" alt="" class="inline"/></p>
<p>As can be seen, at this refinement level approximately three quarters of the instruction count is spent on the actual solver (the <a class="el" href="classSparseILU.html#aac1b5e5c92a75211b0c7778437408fa0">SparseILU::vmult</a> calls on the left, the <a class="el" href="classSparseMatrix.html#a7706b5f721efc5ea1966f5a5cdaad0e6">SparseMatrix::vmult</a> call in the middle for the Schur complement solve, and another box representing the multiplications with <a class="el" href="classSparseILU.html">SparseILU</a> and <a class="el" href="classSparseMatrix.html">SparseMatrix</a> in the solve for <em>U</em>). About one fifth of the instruction count is spent on matrix assembly and sparse ILU computation (box in the lower right corner) and the rest on other things. Since floating point operations such as in the <a class="el" href="classSparseILU.html#aac1b5e5c92a75211b0c7778437408fa0">SparseILU::vmult</a> calls typically take much longer than many of the logical operations and table lookups in matrix assembly, the fraction of the run time taken up by matrix assembly is actually significantly less than the fraction of instructions, as will become apparent in the comparison we make in the results section.</p>
<p>For higher refinement levels, the boxes representing the solver as well as the blue box at the top right stemming from reordering algorithm are going to grow at the expense of the other parts of the program, since they don't scale linearly. The fact that at this moderate refinement level (3168 cells and 93176 degrees of freedom) the linear solver already makes up about three quarters of the instructions is a good sign that most of the algorithms used in this program are well-tuned and that major improvements in speeding up the program are most likely not to come from hand-optimizing individual aspects but by changing solver algorithms. We will address this point in the discussion of results below as well.</p>
<p>As a final point, and as a point of reference, the following picture also shows how the profile looked at an early stage of optimizing this program:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-22.profile-3.original.png" alt="" class="inline"/></p>
<p>As mentioned above, the runtime of this version was about four times as long as for the first profile, with the <a class="el" href="classSparseILU.html">SparseILU</a> decomposition taking up about 30% of the instruction count, and operations an early, inefficient version of <a class="el" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> about 10%. Both these bottlenecks have since been completely removed.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>As usual, we start by including some well-known files:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparse__matrix_8h.html">deal.II/lac/block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
</div><!-- fragment --><p>Then we need to include the header file for the sparse direct solver UMFPACK:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
</div><!-- fragment --><p>This includes the library for the incomplete LU factorization that will be used as a preconditioner in 3D:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__ilu_8h.html">deal.II/lac/sparse_ilu.h</a>&gt;</span></div>
</div><!-- fragment --><p>This is C++:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
</div><!-- fragment --><p>As in all programs, the namespace dealii is included:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep22.html">Step22</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Definingtheinnerpreconditionertype"></a> </p><h3>Defining the inner preconditioner type</h3>
<p>As explained in the introduction, we are going to use different preconditioners for two and three space dimensions, respectively. We distinguish between them by the use of the spatial dimension as a template parameter. See <a class="el" href="step_4.html">step-4</a> for details on templates. We are not going to create any preconditioner object here, all we do is to create class that holds a local alias determining the preconditioner class so we can write our program in a dimension-independent way.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner;</div>
</div><!-- fragment --><p>In 2D, we are going to use a sparse direct solver as preconditioner:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner&lt;2&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p>And the ILU preconditioning in 3D, called by <a class="el" href="classSparseILU.html">SparseILU</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner&lt;3&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeStokesProblemcodeclasstemplate"></a> </p><h3>The <code>StokesProblem</code> class template</h3>
<p>This is an adaptation of <a class="el" href="step_20.html">step-20</a>, so the main class and the data types are nearly the same as used there. The only difference is that we have an additional member <code>preconditioner_matrix</code>, that is used for preconditioning the Schur complement, and a corresponding sparsity pattern <code>preconditioner_sparsity_pattern</code>. In addition, instead of relying on <a class="el" href="classLinearOperator.html">LinearOperator</a>, we implement our own InverseMatrix class.</p>
<p>In this example we also use adaptive grid refinement, which is handled in analogy to <a class="el" href="step_6.html">step-6</a>. According to the discussion in the introduction, we are also going to use the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object for implementing Dirichlet boundary conditions. Hence, we change the name <code>hanging_node_constraints</code> into <code>constraints</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>StokesProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span> refine_mesh();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line">  <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      preconditioner_sparsity_pattern;</div>
<div class="line">  <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> system_rhs;</div>
</div><!-- fragment --><p>This one is new: We shall use a so-called shared pointer structure to access the preconditioner. Shared pointers are essentially just a convenient form of pointers. Several shared pointers can point to the same object (just like regular pointers), but when the last shared pointer object to point to a preconditioner object is deleted (for example if a shared pointer object goes out of scope, if the class of which it is a member is destroyed, or if the pointer is assigned a different preconditioner object) then the preconditioner object pointed to is also destroyed. This ensures that we don't have to manually track in how many places a preconditioner object is still referenced, it can never create a memory leak, and can never produce a dangling pointer to an already destroyed object:</p>
<div class="fragment"><div class="line">  <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">std::shared_ptr&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt; A_preconditioner;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="Boundaryvaluesandrighthandside"></a> </p><h3>Boundary values and right hand side</h3>
<p>As in <a class="el" href="step_20.html">step-20</a> and most other example programs, the next task is to define the data for the PDE: For the Stokes problem, we are going to use natural boundary values on parts of the boundary (i.e. homogeneous Neumann-type) for which we won't have to do anything special (the homogeneity implies that the corresponding terms in the weak form are simply zero), and boundary conditions on the velocity (Dirichlet-type) on the rest of the boundary, as described in the introduction.</p>
<p>In order to enforce the Dirichlet boundary values on the velocity, we will use the <a class="el" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a> function as usual which requires us to write a function object with as many components as the finite element has. In other words, we have to define the function on the \((u,p)\)-space, but we are going to filter out the pressure component when interpolating the boundary values.</p>
<p>The following function object is a representation of the boundary values described in the introduction:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span><a class="code" href="classBoundaryValues.html">BoundaryValues</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <a class="code" href="classBoundaryValues.html">BoundaryValues</a>()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">value</a>) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, this-&gt;n_components));</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0)</div>
<div class="line">    <span class="keywordflow">return</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &lt; 0 ? -1 : (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &gt; 0 ? 1 : 0));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">BoundaryValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                       <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a>(p, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>We implement similar functions for the right hand side which for the current example is simply zero:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span><a class="code" href="classRightHandSide.html">RightHandSide</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <a class="code" href="classRightHandSide.html">RightHandSide</a>()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">value</a>) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">RightHandSide&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide&lt;dim&gt;::value</a>(p, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Linearsolversandpreconditioners"></a> </p><h3>Linear solvers and preconditioners</h3>
<p>The linear solvers and preconditioners are discussed extensively in the introduction. Here, we create the respective objects that will be used.</p>
<p><a class="anchor" id="ThecodeInverseMatrixcodeclasstemplate"></a> </p><h4>The <code>InverseMatrix</code> class template</h4>
<p>The <code>InverseMatrix</code> class represents the data structure for an inverse matrix. Unlike <a class="el" href="step_20.html">step-20</a>, we implement this with a class instead of the helper function inverse_linear_operator() we will apply this class to different kinds of matrices that will require different preconditioners (in <a class="el" href="step_20.html">step-20</a> we only used a non-identity preconditioner for the mass matrix). The types of matrix and preconditioner are passed to this class via template parameters, and matrix and preconditioner objects of these types will then be passed to the constructor when an <code>InverseMatrix</code> object is created. The member function <code>vmult</code> is obtained by solving a linear system:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a>         <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const PreconditionerType&gt;</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">  <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">  <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">  : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">  , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(&amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p>This is the implementation of the <code>vmult</code> function.</p>
<p>In this class we use a rather large tolerance for the solver control. The reason for this is that the function is used very frequently, and hence, any additional effort to make the residual in the CG solve smaller makes the solution more expensive. Note that we do not only use this class as a preconditioner for the Schur complement, but also when forming the inverse of the Laplace matrix &ndash; which is hence directly responsible for the accuracy of the solution itself, so we can't choose a too large tolerance, either.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(src.<a class="code" href="group__Vectors.html#ga81dcfa5c77bdd426603386c0844149ae">size</a>(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * src.<a class="code" href="classVector.html#a8ee1b8309a7a9ecf109c8a7116733ef8">l2_norm</a>());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">  cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, *<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeSchurComplementcodeclasstemplate"></a> </p><h4>The <code>SchurComplement</code> class template</h4>
<p>This class implements the Schur complement discussed in the introduction. It is in analogy to <a class="el" href="step_20.html">step-20</a>. Though, we now call it with a template parameter <code>PreconditionerType</code> in order to access that when specifying the respective type of the inverse matrix class. As a consequence of the definition above, the declaration <code>InverseMatrix</code> now contains the second template parameter for a preconditioner class as above, which affects the <code><a class="el" href="classSmartPointer.html">SmartPointer</a></code> object <code>m_inverse</code> as well.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keyword">class </span>SchurComplement : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SchurComplement(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> &amp;system_matrix,</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>, PreconditionerType&gt; &amp;A_inverse);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const BlockSparseMatrix&lt;double&gt;</a>&gt; system_matrix;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;SparseMatrix&lt;double&gt;, PreconditionerType&gt;&gt;</div>
<div class="line">    A_inverse;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">mutable</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp1, tmp2;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">SchurComplement&lt;PreconditionerType&gt;::SchurComplement(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> &amp;system_matrix,</div>
<div class="line">  <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>, PreconditionerType&gt; &amp;A_inverse)</div>
<div class="line">  : system_matrix(&amp;system_matrix)</div>
<div class="line">  , A_inverse(&amp;A_inverse)</div>
<div class="line">  , tmp1(system_matrix.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(0, 0).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">  , tmp2(system_matrix.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(0, 0).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">SchurComplement&lt;PreconditionerType&gt;::vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                                           <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  system_matrix-&gt;block(0, 1).<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(tmp1, src);</div>
<div class="line">  A_inverse-&gt;vmult(tmp2, tmp1);</div>
<div class="line">  system_matrix-&gt;block(1, 0).vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, tmp2);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemclassimplementation"></a> </p><h3>StokesProblem class implementation</h3>
<p><a class="anchor" id="StokesProblemStokesProblem"></a> </p><h4>StokesProblem::StokesProblem</h4>
<p>The constructor of this class looks very similar to the one of <a class="el" href="step_20.html">step-20</a>. The constructor initializes the variables for the polynomial degree, triangulation, finite element system and the dof handler. The underlying polynomial functions are of order <code>degree+1</code> for the vector-valued velocity components and of order <code>degree</code> for the pressure. This gives the LBB-stable element pair \(Q_{degree+1}^d\times Q_{degree}\), often referred to as the Taylor-Hood element.</p>
<p>Note that we initialize the triangulation with a MeshSmoothing argument, which ensures that the refinement of cells is done in a way that the approximation of the PDE solution remains well-behaved (problems arise if grids are too unstructured), see the documentation of <code><a class="el" href="classTriangulation.html#a0633dd17e535a59162b79f338c6ff5ae">Triangulation::MeshSmoothing</a></code> for details.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">StokesProblem&lt;dim&gt;::StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  : <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  , <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">  , <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>), 1)</div>
<div class="line">  , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemsetup_dofs"></a> </p><h4>StokesProblem::setup_dofs</h4>
<p>Given a mesh, this function associates the degrees of freedom with it and creates the corresponding matrices and vectors. At the beginning it also releases the pointer to the preconditioner object (if the shared pointer pointed at anything at all at this point) since it will definitely not be needed any more after this point and will have to be re-computed after assembling the matrix, and unties the sparse matrices from their sparsity pattern objects.</p>
<p>We then proceed with distributing degrees of freedom and renumbering them: In order to make the ILU preconditioner (in 3D) work efficiently, it is important to enumerate the degrees of freedom in such a way that it reduces the bandwidth of the matrix, or maybe more importantly: in such a way that the ILU is as close as possible to a real LU decomposition. On the other hand, we need to preserve the block structure of velocity and pressure already seen in <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a>. This is done in two steps: First, all dofs are renumbered to improve the ILU and then we renumber once again by components. Since <code><a class="el" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a></code> does not touch the renumbering within the individual blocks, the basic renumbering from the first step remains. As for how the renumber degrees of freedom to improve the ILU: deal.II has a number of algorithms that attempt to find orderings to improve ILUs, or reduce the bandwidth of matrices, or optimize some other aspect. The <a class="el" href="namespaceDoFRenumbering.html">DoFRenumbering</a> namespace shows a comparison of the results we obtain with several of these algorithms based on the testcase discussed here in this tutorial program. Here, we will use the traditional Cuthill-McKee algorithm already used in some of the previous tutorial programs. In the <a href="#improved-ilu">section on improved ILU</a> we're going to discuss this issue in more detail.</p>
<p>There is one more change compared to previous tutorial programs: There is no reason in sorting the <code>dim</code> velocity components individually. In fact, rather than first enumerating all \(x\)-velocities, then all \(y\)-velocities, etc, we would like to keep all velocities at the same location together and only separate between velocities (all components) and pressures. By default, this is not what the <a class="el" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a> function does: it treats each vector component separately; what we have to do is group several components into "blocks" and pass this block structure to that function. Consequently, we allocate a vector <code>block_component</code> with as many elements as there are components and describe all velocity components to correspond to block 0, while the pressure component will form block 1:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  A_preconditioner.reset();</div>
<div class="line">  system_matrix.clear();</div>
<div class="line">  preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  dof_handler.distribute_dofs(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;unsigned int&gt; block_component(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">  block_component[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div>
</div><!-- fragment --><p>Now comes the implementation of Dirichlet boundary conditions, which should be evident after the discussion in the introduction. All that changed is that the function already appears in the setup functions, whereas we were used to see it in some assembly routine. Further down below where we set up the mesh, we will associate the top boundary where we impose Dirichlet boundary conditions with boundary indicator</p><ol type="1">
<li>We will have to pass this boundary indicator as second argument to the function below interpolating boundary values. There is one more thing, though. The function describing the Dirichlet conditions was defined for all components, both velocity and pressure. However, the Dirichlet conditions are to be set for the velocity only. To this end, we use a <a class="el" href="classComponentMask.html">ComponentMask</a> that only selects the velocity components. The component mask is obtained from the finite element by specifying the particular components we want. Since we use adaptively refined grids, the affine constraints object needs to be first filled with hanging node constraints generated from the DoF handler. Note the order of the two functions &mdash; we first compute the hanging node constraints, and then insert the boundary values into the constraints object. This makes sure that we respect H<sup>1</sup> conformity on boundaries with hanging nodes (in three space dimensions), where the hanging node needs to dominate the Dirichlet boundary values.</li>
</ol>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           1,</div>
<div class="line">                                           <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                           <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
</div><!-- fragment --><p>In analogy to <a class="el" href="step_20.html">step-20</a>, we count the dofs in the individual components. We could do this in the same way as there, but we want to operate on the block structure we used already for the renumbering: The function <code><a class="el" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a></code> does the same as <code><a class="el" href="namespaceDoFTools.html#a956ac5c6aab03ec1c04f1ad955301db9">DoFTools::count_dofs_per_fe_component</a></code>, but now grouped as velocity and pressure block via <code>block_component</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">          &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>The next task is to allocate a sparsity pattern for the system matrix we will create and one for the preconditioner matrix. We could do this in the same way as in <a class="el" href="step_20.html">step-20</a>, i.e. directly build an object of type <a class="el" href="classSparsityPattern.html">SparsityPattern</a> through <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>. However, there is a major reason not to do so: In 3D, the function DoFTools::max_couplings_between_dofs yields a conservative but rather large number for the coupling between the individual dofs, so that the memory initially provided for the creation of the sparsity pattern of the matrix is far too much &ndash; so much actually that the initial sparsity pattern won't even fit into the physical memory of most systems already for moderately-sized 3D problems, see also the discussion in <a class="el" href="step_18.html">step-18</a>. Instead, we first build temporary objects that use a different data structure that doesn't require allocating more memory than necessary but isn't suitable for use as a basis of <a class="el" href="classSparseMatrix.html">SparseMatrix</a> or <a class="el" href="classBlockSparseMatrix.html">BlockSparseMatrix</a> objects; in a second step we then copy these objects into objects of type <a class="el" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>. This is entirely analogous to what we already did in <a class="el" href="step_11.html">step-11</a> and <a class="el" href="step_18.html">step-18</a>. In particular, we make use of the fact that we will never write into the \((1,1)\) block of the system matrix and that this is the only block to be filled for the preconditioner matrix.</p>
<p>All this is done inside new scopes, which means that the memory of <code>dsp</code> will be released once the information has been copied to <code>sparsity_pattern</code>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">  dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">  dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">  dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">  dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">  dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">    dof_handler, coupling, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> preconditioner_dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">  preconditioner_dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">  preconditioner_dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">  preconditioner_dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">  preconditioner_dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">  preconditioner_dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">        preconditioner_coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        preconditioner_coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                  preconditioner_coupling,</div>
<div class="line">                                  preconditioner_dsp,</div>
<div class="line">                                  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                  <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  preconditioner_sparsity_pattern.copy_from(preconditioner_dsp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Finally, the system matrix, the preconsitioner matrix, the solution and the right hand side vector are created from the block structure similar to the approach in <a class="el" href="step_20.html">step-20</a>:</p>
<div class="fragment"><div class="line">  system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line">  preconditioner_matrix.reinit(preconditioner_sparsity_pattern);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(2);</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0).reinit(n_u);</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).reinit(n_p);</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  system_rhs.reinit(2);</div>
<div class="line">  system_rhs.block(0).reinit(n_u);</div>
<div class="line">  system_rhs.block(1).reinit(n_p);</div>
<div class="line">  system_rhs.collect_sizes();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemassemble_system"></a> </p><h4>StokesProblem::assemble_system</h4>
<p>The assembly process follows the discussion in <a class="el" href="step_20.html">step-20</a> and in the introduction. We use the well-known abbreviations for the data structures that hold the local matrices, right hand side, and global numbering of the degrees of freedom for the present cell.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div>
<div class="line">{</div>
<div class="line">  system_matrix         = 0;</div>
<div class="line">  system_rhs            = 0;</div>
<div class="line">  preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 2);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_preconditioner_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>,</div>
<div class="line">                                                 <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classRightHandSide.html">RightHandSide&lt;dim&gt;</a>    <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>;</div>
<div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
</div><!-- fragment --><p>Next, we need two objects that work as extractors for the <a class="el" href="classFEValues.html">FEValues</a> object. Their use is explained in detail in the report on <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> :</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
</div><!-- fragment --><p>As an extension over <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a>, we include a few optimizations that make assembly much faster for this particular problem. The improvements are based on the observation that we do a few calculations too many times when we do as in <a class="el" href="step_20.html">step-20</a>: The symmetric gradient actually has <code>dofs_per_cell</code> different values per quadrature point, but we extract it <code>dofs_per_cell*dofs_per_cell</code> times from the <a class="el" href="classFEValues.html">FEValues</a> object - for both the loop over <code>i</code> and the inner loop over <code>j</code>. In 3d, that means evaluating it \(89^2=7921\) instead of \(89\) times, a not insignificant difference.</p>
<p>So what we're going to do here is to avoid such repeated calculations by getting a vector of rank-2 tensors (and similarly for the divergence and the basis function value on pressure) at the quadrature point prior to starting the loop over the dofs on the cell. First, we create the respective objects that will hold these values. Then, we start the loop over all cells and the loop over the quadrature points, where we first extract these values. There is one more optimization we implement here: the local matrix (as well as the global one) is going to be symmetric, since all the operations involved are symmetric with respect to \(i\) and \(j\). This is implemented by simply running the inner loop not to <code>dofs_per_cell</code>, but only up to <code>i</code>, the index of the outer loop.</p>
<div class="fragment"><div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; symgrad_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;                  div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;                  phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">  {</div>
<div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    local_matrix                = 0;</div>
<div class="line">    local_preconditioner_matrix = 0;</div>
<div class="line">    local_rhs                   = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>.vector_value_list(fe_values.get_quadrature_points(),</div>
<div class="line">                                      rhs_values);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">          {</div>
<div class="line">            symgrad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">              fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          }</div>
</div><!-- fragment --><p>Now finally for the bilinear forms of both the system matrix and the matrix we use for the preconditioner. Recall that the formulas for these two are </p><p class="formulaDsp">
\begin{align*} A_{ij} &amp;= a(\varphi_i,\varphi_j) \\ &amp;= \underbrace{2(\varepsilon(\varphi_{i,\textbf{u}}), \varepsilon(\varphi_{j,\textbf{u}}))_{\Omega}} _{(1)} \; \underbrace{- (\textrm{div}\; \varphi_{i,\textbf{u}}, \varphi_{j,p})_{\Omega}} _{(2)} \; \underbrace{- (\varphi_{i,p}, \textrm{div}\; \varphi_{j,\textbf{u}})_{\Omega}} _{(3)} \end{align*}
</p>
<p> and </p><p class="formulaDsp">
\begin{align*} M_{ij} &amp;= \underbrace{(\varphi_{i,p}, \varphi_{j,p})_{\Omega}} _{(4)}, \end{align*}
</p>
<p> respectively, where \(\varphi_{i,\textbf{u}}\) and \(\varphi_{i,p}\) are the velocity and pressure components of the \(i\)th shape function. The various terms above are then easily recognized in the following implementation:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt;= <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">      {</div>
<div class="line">        local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">          (2 * (symgrad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * symgrad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) <span class="comment">// (1)</span></div>
<div class="line">           - div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]                 <span class="comment">// (2)</span></div>
<div class="line">           - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])                <span class="comment">// (3)</span></div>
<div class="line">            fe_values.JxW(q);                        <span class="comment">// * dx</span></div>
<div class="line"> </div>
<div class="line">        local_preconditioner_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">          (phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) <span class="comment">// (4)</span></div>
<div class="line">            fe_values.JxW(q);   <span class="comment">// * dx</span></div>
<div class="line">      }</div>
</div><!-- fragment --><p>Note that in the implementation of (1) above, <code>operator*</code> is overloaded for symmetric tensors, yielding the scalar product between the two tensors.</p>
<p>For the right-hand side we use the fact that the shape functions are only non-zero in one component (because our elements are primitive). Instead of multiplying the tensor representing the dim+1 values of shape function i with the whole right-hand side vector, we only look at the only non-zero component. The function <a class="el" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">FiniteElement::system_to_component_index</a> will return which component this shape function lives in (0=x velocity, 1=y velocity, 2=pressure in 2d), which we use to pick out the correct component of the right-hand side vector to multiply with.</p>
<div class="fragment"><div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div>
<div class="line">        <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first;</div>
<div class="line">      local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q)   <span class="comment">// (phi_u_i(x_q)</span></div>
<div class="line">                         rhs_values[q](component_i)) <span class="comment">// * f(x_q))</span></div>
<div class="line">                        fe_values.JxW(q);            <span class="comment">// * dx</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Before we can write the local data into the global matrix (and simultaneously use the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object to apply Dirichlet boundary conditions and eliminate hanging node constraints, as we discussed in the introduction), we have to be careful about one thing, though. We have only built half of the local matrices because of symmetry, but we're going to save the full matrices in order to use the standard functions for solving. This is done by flipping the indices in case we are pointing into the empty part of the local matrices.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> + 1; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">      {</div>
<div class="line">        local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = local_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">        local_preconditioner_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) =</div>
<div class="line">          local_preconditioner_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(local_matrix,</div>
<div class="line">                                         local_rhs,</div>
<div class="line">                                         <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                         system_matrix,</div>
<div class="line">                                         system_rhs);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(local_preconditioner_matrix,</div>
<div class="line">                                         <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                         preconditioner_matrix);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Before we're going to solve this linear system, we generate a preconditioner for the velocity-velocity matrix, i.e., <code>block(0,0)</code> in the system matrix. As mentioned above, this depends on the spatial dimension. Since the two classes described by the <code>InnerPreconditioner::type</code> alias have the same interface, we do not have to do anything different whether we want to use a sparse direct solver or an ILU:</p>
<div class="fragment"><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Computing preconditioner...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">  A_preconditioner =</div>
<div class="line">    <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">std::make_shared&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt;();</div>
<div class="line">  A_preconditioner-&gt;initialize(</div>
<div class="line">    system_matrix.block(0, 0),</div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="relaxation__block__0_8txt.html#a2076fd56276055e74e230fad6edac013">InnerPreconditioner&lt;dim&gt;::type::AdditionalData</a>());</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemsolve"></a> </p><h4>StokesProblem::solve</h4>
<p>After the discussion in the introduction and the definition of the respective classes above, the implementation of the <code>solve</code> function is rather straight-forward and done in a similar way as in <a class="el" href="step_20.html">step-20</a>. To start with, we need an object of the <code>InverseMatrix</code> class that represents the inverse of the matrix A. As described in the introduction, the inverse is generated with the help of an inner preconditioner of type <code>InnerPreconditioner::type</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">StokesProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> InverseMatrix&lt;SparseMatrix&lt;double&gt;,</div>
<div class="line">                      <span class="keyword">typename</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">InnerPreconditioner&lt;dim&gt;::type</a>&gt;</div>
<div class="line">                 A_inverse(system_matrix.block(0, 0), *A_preconditioner);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0).size());</div>
</div><!-- fragment --><p>This is as in <a class="el" href="step_20.html">step-20</a>. We generate the right hand side \(B A^{-1} F - G\) for the Schur complement and an object that represents the respective linear operation \(B A^{-1} B^T\), now with a template parameter indicating the preconditioner - in accordance with the definition of the class.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> schur_rhs(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).size());</div>
<div class="line">  A_inverse.vmult(tmp, system_rhs.block(0));</div>
<div class="line">  system_matrix.block(1, 0).vmult(schur_rhs, tmp);</div>
<div class="line">  schur_rhs -= system_rhs.block(1);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">SchurComplement&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt; <a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>(</div>
<div class="line">    system_matrix, A_inverse);</div>
</div><!-- fragment --><p>The usual control structures for the solver call are created...</p>
<div class="fragment"><div class="line"><a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).size(),</div>
<div class="line">                             1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * schur_rhs.l2_norm());</div>
<div class="line"><a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
</div><!-- fragment --><p>Now to the preconditioner to the Schur complement. As explained in the introduction, the preconditioning is done by a mass matrix in the pressure variable.</p>
<p>Actually, the solver needs to have the preconditioner in the form \(P^{-1}\), so we need to create an inverse operation. Once again, we use an object of the class <code>InverseMatrix</code>, which implements the <code>vmult</code> operation that is needed by the solver. In this case, we have to invert the pressure mass matrix. As it already turned out in earlier tutorial programs, the inversion of a mass matrix is a rather cheap and straight-forward operation (compared to, e.g., a Laplace matrix). The CG method with ILU preconditioning converges in 5-10 steps, independently on the mesh size. This is precisely what we do here: We choose another ILU preconditioner and take it along to the InverseMatrix object via the corresponding template parameter. A CG solver is then called within the vmult operation of the inverse matrix.</p>
<p>An alternative that is cheaper to build, but needs more iterations afterwards, would be to choose a SSOR preconditioner with factor 1.2. It needs about twice the number of iterations, but the costs for its generation are almost negligible.</p>
<div class="fragment"><div class="line"><a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line"><a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(preconditioner_matrix.block(1, 1),</div>
<div class="line">                          <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;::AdditionalData</a>());</div>
<div class="line"> </div>
<div class="line">InverseMatrix&lt;SparseMatrix&lt;double&gt;, <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>&gt; m_inverse(</div>
<div class="line">  preconditioner_matrix.block(1, 1), <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
</div><!-- fragment --><p>With the Schur complement and an efficient preconditioner at hand, we can solve the respective equation for the pressure (i.e. block 0 in the solution vector) in the usual way:</p>
<div class="fragment"><div class="line">cg.solve(<a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1), schur_rhs, m_inverse);</div>
</div><!-- fragment --><p>After this first solution step, the hanging node constraints have to be distributed to the solution in order to achieve a consistent pressure field.</p>
<div class="fragment"><div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; outer CG Schur complement iterations for pressure&quot;</span></div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p>As in <a class="el" href="step_20.html">step-20</a>, we finally need to solve for the velocity equation where we plug in the solution to the pressure equation. This involves only objects we already know - so we simply multiply \(p\) by \(B^T\), subtract the right hand side and multiply by the inverse of \(A\). At the end, we need to distribute the constraints from hanging nodes in order to obtain a consistent flow field:</p>
<div class="fragment"><div class="line">  {</div>
<div class="line">    system_matrix.block(0, 1).vmult(tmp, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1));</div>
<div class="line">    tmp *= -1;</div>
<div class="line">    tmp += system_rhs.block(0);</div>
<div class="line"> </div>
<div class="line">    A_inverse.vmult(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0), tmp);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemoutput_results"></a> </p><h4>StokesProblem::output_results</h4>
<p>The next function generates graphical output. In this example, we are going to use the VTK file format. We attach names to the individual variables in the problem: <code>velocity</code> to the <code>dim</code> components of velocity and <code>pressure</code> to the pressure.</p>
<p>Not all visualization programs have the ability to group individual vector components into a vector to provide vector plots; in particular, this holds for some VTK-based visualization programs. In this case, the logical grouping of components into vectors should already be described in the file containing the data. In other words, what we need to do is provide our output writers with a way to know which of the components of the finite element logically form a vector (with \(d\) components in \(d\) space dimensions) rather than letting them assume that we simply have a bunch of scalar fields. This is achieved using the members of the <code><a class="el" href="namespaceDataComponentInterpretation.html">DataComponentInterpretation</a></code> namespace: as with the filename, we create a vector in which the first <code>dim</code> components refer to the velocities and are given the tag <a class="el" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>; we finally push one tag <a class="el" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a> to describe the grouping of the pressure variable.</p>
<p>The rest of the function is then the same as in <a class="el" href="step_20.html">step-20</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;std::string&gt; solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    data_component_interpretation(</div>
<div class="line">      <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">                           solution_names,</div>
<div class="line">                           <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                           data_component_interpretation);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(</div>
<div class="line">    <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(refinement_cycle, 2) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemrefine_mesh"></a> </p><h4>StokesProblem::refine_mesh</h4>
<p>This is the last interesting function of the <code>StokesProblem</code> class. As indicated by its name, it takes the solution to the problem and refines the mesh where this is needed. The procedure is the same as in the respective step in <a class="el" href="step_6.html">step-6</a>, with the exception that we base the refinement only on the change in pressure, i.e., we call the Kelly error estimator with a mask object of type <a class="el" href="classComponentMask.html">ComponentMask</a> that selects the single scalar component for the pressure that we are interested in (we get such a mask from the finite element class by specifying the component we want). Additionally, we do not coarsen the grid again:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_mesh()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">    dof_handler,</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1),</div>
<div class="line">    <a class="code" href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">std::map</a>&lt;<a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">    estimated_error_per_cell,</div>
<div class="line">    <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>));</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                  estimated_error_per_cell,</div>
<div class="line">                                                  0.3,</div>
<div class="line">                                                  0.0);</div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemrun"></a> </p><h4>StokesProblem::run</h4>
<p>The last step in the Stokes class is, as usual, the function that generates the initial grid and calls the other functions in the respective order.</p>
<p>We start off with a rectangle of size \(4 \times 1\) (in 2d) or \(4 \times 1 \times 1\) (in 3d), placed in \(R^2/R^3\) as \((-2,2)\times(-1,0)\) or \((-2,2)\times(0,1)\times(-1,0)\), respectively. It is natural to start with equal mesh size in each direction, so we subdivide the initial rectangle four times in the first coordinate direction. To limit the scope of the variables involved in the creation of the mesh to the range where we actually need them, we put the entire block between a pair of braces:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">StokesProblem&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;unsigned int&gt; <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, 1);</div>
<div class="line">    <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>[0] = 4;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> bottom_left = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?                </div>
<div class="line">                                      <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2, -1) :    <span class="comment">// 2d case</span></div>
<div class="line">                                      <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(-2, 0, -1)); <span class="comment">// 3d case</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> top_right = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?              </div>
<div class="line">                                    <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(2, 0) :    <span class="comment">// 2d case</span></div>
<div class="line">                                    <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(2, 1, 0)); <span class="comment">// 3d case</span></div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                              <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>,</div>
<div class="line">                                              bottom_left,</div>
<div class="line">                                              top_right);</div>
<div class="line">  }</div>
</div><!-- fragment --><p>A boundary indicator of 1 is set to all boundaries that are subject to Dirichlet boundary conditions, i.e. to faces that are located at 0 in the last coordinate direction. See the example description above for details.</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1] == 0)</div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_all_boundary_ids(1);</div>
</div><!-- fragment --><p>We then apply an initial refinement before solving for the first time. In 3D, there are going to be more degrees of freedom, so we refine less there:</p>
<div class="fragment"><div class="line"><a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(4 - <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
</div><!-- fragment --><p>As first seen in <a class="el" href="step_6.html">step-6</a>, we cycle over the different refinement levels and refine (except for the first cycle), setup the degrees of freedom and matrices, assemble, solve and create output:</p>
<div class="fragment"><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 6;</div>
<div class="line">         ++refinement_cycle)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div>
<div class="line">          refine_mesh();</div>
<div class="line"> </div>
<div class="line">        setup_dofs();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        output_results(refinement_cycle);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step22</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>The main function is the same as in <a class="el" href="step_20.html">step-20</a>. We pass the element degree as a parameter and choose the space dimension at the well-known template slot.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep22.html">Step22</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;2&gt;</a> flow_problem(1);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="Outputoftheprogramandgraphicalvisualization"></a></p><h3>Output of the program and graphical visualization</h3>
<p><a class="anchor" id="2Dcalculations"></a></p><h4>2D calculations</h4>
<p>Running the program with the space dimension set to 2 in the <code>main</code> function yields the following output (in "release mode", See also <a href="http://www.math.colostate.edu/~bangerth/videos.676.18.html">video lecture 18</a>.): </p><div class="fragment"><div class="line"><a class="code" href="work__stream__0_8txt.html#a2252e3964ca906e132dfb7ffa15c79b8">examples</a>/<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>-22&gt; make <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 0</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 64</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 679 (594+85)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 1</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 160</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1683 (1482+201)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 2</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 376</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 3813 (3370+443)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 3</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 880</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 8723 (7722+1001)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 4</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 2008</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 19383 (17186+2197)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 5</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 4288</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 40855 (36250+4605)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
</div><!-- fragment --><p>The entire computation above takes about 2 seconds on a reasonably quick (for 2015 standards) machine.</p>
<p>What we see immediately from this is that the number of (outer) iterations does not increase as we refine the mesh. This confirms the statement in the introduction that preconditioning the Schur complement with the mass matrix indeed yields a matrix spectrally equivalent to the identity matrix (i.e. with eigenvalues bounded above and below independently of the mesh size or the relative sizes of cells). In other words, the mass matrix and the Schur complement are spectrally equivalent.</p>
<p>In the images below, we show the grids for the first six refinement steps in the program. Observe how the grid is refined in regions where the solution rapidly changes: On the upper boundary, we have Dirichlet boundary conditions that are -1 in the left half of the line and 1 in the right one, so there is an abrupt change at \(x=0\). Likewise, there are changes from Dirichlet to Neumann data in the two upper corners, so there is need for refinement there as well:</p>
<table width="60%" align="center">
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-0.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-1.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-2.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-3.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-4.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-5.png" alt="" class="inline"/>   </td></tr>
</table>
<p>Finally, following is a plot of the flow field. It shows fluid transported along with the moving upper boundary and being replaced by material coming from below:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-22.2d.solution.png" alt="" class="inline"/></p>
<p>This plot uses the capability of VTK-based visualization programs (in this case of VisIt) to show vector data; this is the result of us declaring the velocity components of the finite element in use to be a set of vector components, rather than independent scalar components in the <code>StokesProblem&lt;dim&gt;::output_results</code> function of this tutorial program.</p>
<p><a class="anchor" id="3Dcalculations"></a></p><h4>3D calculations</h4>
<p>In 3d, the screen output of the program looks like this:</p>
<div class="fragment"><div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 0</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 32</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1356 (1275+81)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  13 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 1</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 144</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 5088 (4827+261)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  14 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 2</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 704</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 22406 (21351+1055)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  14 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 3</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 3168</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 93176 (89043+4133)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  15 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 4</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 11456</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 327808 (313659+14149)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  15 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 5</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 45056</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1254464 (1201371+53093)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  14 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
</div><!-- fragment --><p>Again, we see that the number of outer iterations does not increase as we refine the mesh. Nevertheless, the compute time increases significantly: for each of the iterations above separately, it takes about 0.14 seconds, 0.63 seconds, 4.8 seconds, 35 seconds, 2 minutes and 33 seconds, and 13 minutes and 12 seconds. This overall superlinear (in the number of unknowns) increase in runtime is due to the fact that our inner solver is not \({\cal O}(N)\): a simple experiment shows that as we keep refining the mesh, the average number of ILU-preconditioned CG iterations to invert the velocity-velocity block \(A\) increases.</p>
<p>We will address the question of how possibly to improve our solver <a href="#improved-solver">below</a>.</p>
<p>As for the graphical output, the grids generated during the solution look as follow:</p>
<table width="60%" align="center">
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-0.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-1.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-2.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-3.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-4.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-5.png" alt="" class="inline"/>   </td></tr>
</table>
<p>Again, they show essentially the location of singularities introduced by boundary conditions. The vector field computed makes for an interesting graph:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-22.3d.solution.png" alt="" class="inline"/></p>
<p>The isocontours shown here as well are those of the pressure variable, showing the singularity at the point of discontinuous velocity boundary conditions.</p>
<p><a class="anchor" id="Sparsitypattern"></a></p><h3>Sparsity pattern</h3>
<p>As explained during the generation of the sparsity pattern, it is important to have the numbering of degrees of freedom in mind when using preconditioners like incomplete LU decompositions. This is most conveniently visualized using the distribution of nonzero elements in the stiffness matrix.</p>
<p>If we don't do anything special to renumber degrees of freedom (i.e., without using <a class="el" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>, but with using <a class="el" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a> to ensure that degrees of freedom are appropriately sorted into their corresponding blocks of the matrix and vector), then we get the following image after the first adaptive refinement in two dimensions:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-22.2d.sparsity-nor.png" alt="" class="inline"/></p>
<p>In order to generate such a graph, you have to insert a piece of code like the following to the end of the setup step. </p><div class="fragment"><div class="line">{</div>
<div class="line">  std::ofstream <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a> (<span class="stringliteral">&quot;sparsity_pattern.gpl&quot;</span>);</div>
<div class="line">  <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.print_gnuplot(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>It is clearly visible that the nonzero entries are spread over almost the whole matrix. This makes preconditioning by ILU inefficient: ILU generates a Gaussian elimination (LU decomposition) without fill-in elements, which means that more tentative fill-ins left out will result in a worse approximation of the complete decomposition.</p>
<p>In this program, we have thus chosen a more advanced renumbering of components. The renumbering with <a class="el" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a> and grouping the components into velocity and pressure yields the following output:</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-22.2d.sparsity-ren.png" alt="" class="inline"/></p>
<p>It is apparent that the situation has improved a lot. Most of the elements are now concentrated around the diagonal in the (0,0) block in the matrix. Similar effects are also visible for the other blocks. In this case, the ILU decomposition will be much closer to the full LU decomposition, which improves the quality of the preconditioner. (It may be interesting to note that the sparse direct solver UMFPACK does some internal renumbering of the equations before actually generating a sparse LU decomposition; that procedure leads to a very similar pattern to the one we got from the Cuthill-McKee algorithm.)</p>
<p>Finally, we want to have a closer look at a sparsity pattern in 3D. We show only the (0,0) block of the matrix, again after one adaptive refinement. Apart from the fact that the matrix size has increased, it is also visible that there are many more entries in the matrix. Moreover, even for the optimized renumbering, there will be a considerable amount of tentative fill-in elements. This illustrates why UMFPACK is not a good choice in 3D - a full decomposition needs many new entries that eventually won't fit into the physical memory (RAM):</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-22.3d.sparsity_uu-ren.png" alt="" class="inline"/></p>
<p><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p><a class="anchor" id="improved-solver"></a> <a class="anchor" id="Improvedlinearsolverin3D"></a></p><h4>Improved linear solver in 3D</h4>
<p>We have seen in the section of computational results that the number of outer iterations does not depend on the mesh size, which is optimal in a sense of scalability. This does, however, not apply to the solver as a whole, as mentioned above: We did not look at the number of inner iterations when generating the inverse of the matrix \(A\) and the mass matrix \(M_p\). Of course, this is unproblematic in the 2D case where we precondition \(A\) with a direct solver and the <code>vmult</code> operation of the inverse matrix structure will converge in one single CG step, but this changes in 3D where we only use an ILU preconditioner. There, the number of required preconditioned CG steps to invert \(A\) increases as the mesh is refined, and each <code>vmult</code> operation involves on average approximately 14, 23, 36, 59, 75 and 101 inner CG iterations in the refinement steps shown above. (On the other hand, the number of iterations for applying the inverse pressure mass matrix is always around five, both in two and three dimensions.) To summarize, most work is spent on solving linear systems with the same matrix \(A\) over and over again. What makes this look even worse is the fact that we actually invert a matrix that is about 95 percent the size of the total system matrix and stands for 85 percent of the non-zero entries in the sparsity pattern. Hence, the natural question is whether it is reasonable to solve a linear system with matrix \(A\) for about 15 times when calculating the solution to the block system.</p>
<p>The answer is, of course, that we can do that in a few other (most of the time better) ways. Nevertheless, it has to be remarked that an indefinite system as the one at hand puts indeed much higher demands on the linear algebra than standard elliptic problems as we have seen in the early tutorial programs. The improvements are still rather unsatisfactory, if one compares with an elliptic problem of similar size. Either way, we will introduce below a number of improvements to the linear solver, a discussion that we will re-consider again with additional options in the <a class="el" href="step_31.html">step-31</a> program.</p>
<p><a class="anchor" id="improved-ilu"></a> <a class="anchor" id="BetterILUdecompositionbysmartreordering"></a></p><h5>Better ILU decomposition by smart reordering</h5>
<p>A first attempt to improve the speed of the linear solution process is to choose a dof reordering that makes the ILU being closer to a full LU decomposition, as already mentioned in the in-code comments. The <a class="el" href="namespaceDoFRenumbering.html">DoFRenumbering</a> namespace compares several choices for the renumbering of dofs for the Stokes equations. The best result regarding the computing time was found for the King ordering, which is accessed through the call <a class="el" href="namespaceDoFRenumbering_1_1boost.html#a76fd1dc3212aeeca4294c358248e46d5">DoFRenumbering::boost::king_ordering</a>. With that program, the inner solver needs considerably less operations, e.g. about 62 inner CG iterations for the inversion of \(A\) at cycle 4 compared to about 75 iterations with the standard Cuthill-McKee-algorithm. Also, the computing time at cycle 4 decreased from about 17 to 11 minutes for the <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code> call. However, the King ordering (and the orderings provided by the <a class="el" href="namespaceDoFRenumbering_1_1boost.html">DoFRenumbering::boost</a> namespace in general) has a serious drawback - it uses much more memory than the in-build deal versions, since it acts on abstract graphs rather than the geometry provided by the triangulation. In the present case, the renumbering takes about 5 times as much memory, which yields an infeasible algorithm for the last cycle in 3D with 1.2 million unknowns.</p>
<p><a class="anchor" id="BetterpreconditionerfortheinnerCGsolver"></a></p><h5>Better preconditioner for the inner CG solver</h5>
<p>Another idea to improve the situation even more would be to choose a preconditioner that makes CG for the (0,0) matrix \(A\) converge in a mesh-independent number of iterations, say 10 to 30. We have seen such a candidate in <a class="el" href="step_16.html">step-16</a>: multigrid.</p>
<p><a class="anchor" id="BlockSchurcomplementpreconditioner"></a></p><h5>Block Schur complement preconditioner</h5>
<p><a class="anchor" id="block-schur"></a> Even with a good preconditioner for \(A\), we still need to solve of the same linear system repeatedly (with different right hand sides, though) in order to make the Schur complement solve converge. The approach we are going to discuss here is how inner iteration and outer iteration can be combined. If we persist in calculating the Schur complement, there is no other possibility.</p>
<p>The alternative is to attack the block system at once and use an approximate Schur complement as efficient preconditioner. The idea is as follows: If we find a block preconditioner \(P\) such that the matrix </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1}\left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \end{eqnarray*}
</p>
<p> is simple, then an iterative solver with that preconditioner will converge in a few iterations. Using the Schur complement \(S = B A^{-1} B^T\), one finds that </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1} = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ S^{-1} B A^{-1} &amp; -S^{-1} \end{array}\right) \end{eqnarray*}
</p>
<p> would appear to be a good choice since </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1}\left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ S^{-1} B A^{-1} &amp; -S^{-1} \end{array}\right)\cdot \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) = \left(\begin{array}{cc} I &amp; A^{-1} B^T \\ 0 &amp; I \end{array}\right). \end{eqnarray*}
</p>
<p> This is the approach taken by the paper by Silvester and Wathen referenced to in the introduction (with the exception that Silvester and Wathen use right preconditioning). In this case, a Krylov-based iterative method would converge in one step only if exact inverses of \(A\) and \(S\) were applied, since all the eigenvalues are one (and the number of iterations in such a method is bounded by the number of distinct eigenvalues). Below, we will discuss the choice of an adequate solver for this problem. First, we are going to have a closer look at the implementation of the preconditioner.</p>
<p>Since \(P\) is aimed to be a preconditioner only, we shall use approximations to the inverse of the Schur complement \(S\) and the matrix \(A\). Hence, the Schur complement will be approximated by the pressure mass matrix \(M_p\), and we use a preconditioner to \(A\) (without an InverseMatrix class around it) for approximating \(A^{-1}\).</p>
<p>Here comes the class that implements the block Schur complement preconditioner. The <code>vmult</code> operation for block vectors according to the derivation above can be specified by three successive operations: </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerMp&gt;</div>
<div class="line"><span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    BlockSchurPreconditioner (<span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a>         &amp;S,</div>
<div class="line">          <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>,PreconditionerMp&gt;  &amp;Mpinv,</div>
<div class="line">          <span class="keyword">const</span> PreconditionerA &amp;Apreconditioner);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a> (<a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a>       &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">              <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const BlockSparseMatrix&lt;double&gt;</a> &gt; system_matrix;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const InverseMatrix&lt;SparseMatrix&lt;double&gt;</a>,</div>
<div class="line">                       PreconditionerMp &gt; &gt; m_inverse;</div>
<div class="line">    <span class="keyword">const</span> PreconditionerA &amp;a_preconditioner;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">mutable</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp;</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerMp&gt;</div>
<div class="line">BlockSchurPreconditioner&lt;PreconditionerA, PreconditionerMp&gt;::BlockSchurPreconditioner(</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a>                            &amp;S,</div>
<div class="line">          <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>,PreconditionerMp&gt; &amp;Mpinv,</div>
<div class="line">          <span class="keyword">const</span> PreconditionerA &amp;Apreconditioner</div>
<div class="line">          )</div>
<div class="line">                :</div>
<div class="line">                system_matrix           (&amp;S),</div>
<div class="line">                m_inverse               (&amp;Mpinv),</div>
<div class="line">                a_preconditioner        (Apreconditioner),</div>
<div class="line">                tmp                     (S.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1,1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Now the interesting function, the multiplication of</span></div>
<div class="line">        <span class="comment">// the preconditioner with a BlockVector.</span></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerMp&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerA, PreconditionerMp&gt;::vmult</a> (</div>
<div class="line">                                     <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a>       &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                                     <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">        <span class="comment">// Form u_new = A^{-1} u</span></div>
<div class="line">  a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a> (<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">        <span class="comment">// Form tmp = - B u_new + p</span></div>
<div class="line">        <span class="comment">// (&lt;code&gt;SparseMatrix::residual&lt;/code&gt;</span></div>
<div class="line">        <span class="comment">// does precisely this)</span></div>
<div class="line">  system_matrix-&gt;block(1,0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">        <span class="comment">// Change sign in tmp</span></div>
<div class="line">  tmp *= -1;</div>
<div class="line">        <span class="comment">// Multiply by approximate Schur complement</span></div>
<div class="line">        <span class="comment">// (i.e. a pressure mass matrix)</span></div>
<div class="line">  m_inverse-&gt;vmult (<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Since we act on the whole block system now, we have to live with one disadvantage: we need to perform the solver iterations on the full block system instead of the smaller pressure space.</p>
<p>Now we turn to the question which solver we should use for the block system. The first observation is that the resulting preconditioned matrix cannot be solved with CG since it is neither positive definite nor symmetric.</p>
<p>The deal.II libraries implement several solvers that are appropriate for the problem at hand. One choice is the solver <a class="el" href="classSolverBicgstab.html">BiCGStab</a>, which was used for the solution of the unsymmetric advection problem in <a class="el" href="step_9.html">step-9</a>. The second option, the one we are going to choose, is <a class="el" href="classSolverGMRES.html">GMRES</a> (generalized minimum residual). Both methods have their pros and cons - there are problems where one of the two candidates clearly outperforms the other, and vice versa. <a href="http://en.wikipedia.org/wiki/GMRES#Comparison_with_other_solvers">Wikipedia</a>'s article on the GMRES method gives a comparative presentation. A more comprehensive and well-founded comparison can be read e.g. in the book by J.W. Demmel (Applied Numerical Linear Algebra, SIAM, 1997, section 6.6.6).</p>
<p>For our specific problem with the ILU preconditioner for \(A\), we certainly need to perform hundreds of iterations on the block system for large problem sizes (we won't beat CG!). Actually, this disfavors GMRES: During the GMRES iterations, a basis of Krylov vectors is successively built up and some operations are performed on these vectors. The more vectors are in this basis, the more operations and memory will be needed. The number of operations scales as \({\cal O}(n + k^2)\) and memory as \({\cal O}(kn)\), where \(k\) is the number of vectors in the Krylov basis and \(n\) the size of the (block) matrix. To not let these demands grow excessively, deal.II limits the size \(k\) of the basis to 30 vectors by default. Then, the basis is rebuilt. This implementation of the GMRES method is called GMRES(k), with default \(k=30\). What we have gained by this restriction, namely a bound on operations and memory requirements, will be compensated by the fact that we use an incomplete basis - this will increase the number of required iterations.</p>
<p>BiCGStab, on the other hand, won't get slower when many iterations are needed (one iteration uses only results from one preceding step and not all the steps as GMRES). Besides the fact the BiCGStab is more expensive per step since two matrix-vector products are needed (compared to one for CG or GMRES), there is one main reason which makes BiCGStab not appropriate for this problem: The preconditioner applies the inverse of the pressure mass matrix by using the InverseMatrix class. Since the application of the inverse matrix to a vector is done only in approximative way (an exact inverse is too expensive), this will also affect the solver. In the case of BiCGStab, the Krylov vectors will not be orthogonal due to that perturbation. While this is uncritical for a small number of steps (up to about 50), it ruins the performance of the solver when these perturbations have grown to a significant magnitude in the coarse of iterations.</p>
<p>We did some experiments with BiCGStab and found it to be faster than GMRES up to refinement cycle 3 (in 3D), but it became very slow for cycles 4 and 5 (even slower than the original Schur complement), so the solver is useless in this situation. Choosing a sharper tolerance for the inverse matrix class (<code>1e-10*src.<a class="el" href="namespaceAdaptationStrategies_1_1Refinement.html#a069487de103023e142d174c1bb6712fa">l2_norm()</a></code> instead of <code>1e-6*src.<a class="el" href="namespaceAdaptationStrategies_1_1Refinement.html#a069487de103023e142d174c1bb6712fa">l2_norm()</a></code>) made BiCGStab perform well also for cycle 4, but did not change the failure on the very large problems.</p>
<p>GMRES is of course also effected by the approximate inverses, but it is not as sensitive to orthogonality and retains a relatively good performance also for large sizes, see the results below.</p>
<p>With this said, we turn to the realization of the solver call with GMRES with \(k=100\) temporary vectors:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> &amp;pressure_mass_matrix</div>
<div class="line">  = preconditioner_matrix.block(1,1);</div>
<div class="line"><a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> pmass_preconditioner;</div>
<div class="line">pmass_preconditioner.<a class="code" href="classSparseILU.html#a1f706d230cbc96643a666d07e32353ae">initialize</a> (pressure_mass_matrix,</div>
<div class="line">  <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;::AdditionalData</a>());</div>
<div class="line"> </div>
<div class="line">InverseMatrix&lt;SparseMatrix&lt;double&gt;,<a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> &gt;</div>
<div class="line">  m_inverse (pressure_mass_matrix, pmass_preconditioner);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">BlockSchurPreconditioner&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>,</div>
<div class="line">                         <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> &gt;</div>
<div class="line">  <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a> (system_matrix, m_inverse, *A_preconditioner);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classSolverControl.html">SolverControl</a> solver_control (system_matrix.m(),</div>
<div class="line">                              1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6*system_rhs.l2_norm());</div>
<div class="line"><a class="code" href="classGrowingVectorMemory.html">GrowingVectorMemory&lt;BlockVector&lt;double&gt;</a> &gt; vector_memory;</div>
<div class="line"><a class="code" href="classSolverGMRES.html">SolverGMRES&lt;BlockVector&lt;double&gt;</a> &gt;<a class="code" href="relaxation__block__0_8txt.html#a2076fd56276055e74e230fad6edac013">::AdditionalData</a> gmres_data;</div>
<div class="line">gmres_data.max_n_tmp_vectors = 100;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classSolverGMRES.html">SolverGMRES&lt;BlockVector&lt;double&gt;</a> &gt; gmres(solver_control, vector_memory,</div>
<div class="line">                                        gmres_data);</div>
<div class="line"> </div>
<div class="line">gmres.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs,</div>
<div class="line">            <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a> (<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">          &lt;&lt; solver_control.last_step()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; block GMRES iterations&quot;</span>;</div>
</div><!-- fragment --><p>Obviously, one needs to add the include file <a class="el" href="classSolverGMRES.html">&lt;lac/solver_gmres.h&gt;</a> in order to make this run. We call the solver with a <a class="el" href="classBlockVector.html">BlockVector</a> template in order to enable GMRES to operate on block vectors and matrices. Note also that we need to set the (1,1) block in the system matrix to zero (we saved the pressure mass matrix there which is not part of the problem) after we copied the information to another matrix.</p>
<p>Using the <a class="el" href="classTimer.html">Timer</a> class, we collect some statistics that compare the runtime of the block solver with the one from the problem implementation above. Besides the solution with the two options we also check if the solutions of the two variants are close to each other (i.e. this solver gives indeed the same solution as we had before) and calculate the infinity norm of the vector difference.</p>
<p>Let's first see the results in 2D: </p><div class="fragment"><div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 0</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 64</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 679 (594+85) [0.00162792 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.00108981 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.0025959 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.00479603s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 12 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.00441718 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 5.38258e-07</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 1</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 160</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1683 (1482+201) [0.00345707 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.00237417 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.00605702 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.0123992s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 12 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.011909 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 1.74658e-05</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 2</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 376</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 3813 (3370+443) [0.00729299 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.00529909 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.0167508 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.031672s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 12 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.029232 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 7.81569e-06</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 3</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 880</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 8723 (7722+1001) [0.017709 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.0126002 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.0435679 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.0971651s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 12 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.0992041 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 1.87249e-05</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 4</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 2008</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 19383 (17186+2197) [0.039988 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.028281 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.118314 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.252133s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 13 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.269125 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 6.38657e-05</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 5</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 4288</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 40855 (36250+4605) [0.0880702 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.0603511 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.278339 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.53846s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 13 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.578667 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 0.000173363</div>
</div><!-- fragment --><p>We see that there is no huge difference in the solution time between the block Schur complement preconditioner solver and the Schur complement itself. The reason is simple: we used a direct solve as preconditioner for \(A\) - so we cannot expect any gain by avoiding the inner iterations. We see that the number of iterations has slightly increased for GMRES, but all in all the two choices are fairly similar.</p>
<p>The picture of course changes in 3D:</p>
<div class="fragment"><div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 0</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 32</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1356 (1275+81) [0.00845218 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.019372 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.00712395 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 13 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.0320101s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 22 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.0048759 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 2.15942e-05</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 1</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 144</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 5088 (4827+261) [0.0346942 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.0857739 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.0465031 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 14 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.349258s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 35 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.048759 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 1.77657e-05</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 2</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 704</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 22406 (21351+1055) [0.175669 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.437447 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.286435 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 14 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [3.65519s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 63 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.497787 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 5.08078e-05</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 3</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 3168</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 93176 (89043+4133) [0.790985 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [1.97598 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [1.4325 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 15 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [29.9666s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 128 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [5.02645 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 0.000119671</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 4</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 11456</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 327808 (313659+14149) [3.44995 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [7.54772 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [5.46306 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 15 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [139.987s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 255 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [38.0946 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 0.00020793</div>
<div class="line"> </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 5</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 45056</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1254464 (1201371+53093) [19.6795 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [28.6586 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [22.401 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 14 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [796.767s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 524 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [355.597 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 0.000501219</div>
</div><!-- fragment --><p>Here, the block preconditioned solver is clearly superior to the Schur complement, but the advantage gets less for more mesh points. This is because GMRES(k) scales worse with the problem size than CG, as we discussed above. Nonetheless, the improvement by a factor of 3-6 for moderate problem sizes is quite impressive.</p>
<p><a class="anchor" id="Combiningtheblockpreconditionerandmultigrid"></a></p><h5>Combining the block preconditioner and multigrid</h5>
<p>An ultimate linear solver for this problem could be imagined as a combination of an optimal preconditioner for \(A\) (e.g. multigrid) and the block preconditioner described above, which is the approach taken in the <a class="el" href="step_31.html">step-31</a> and <a class="el" href="step_32.html">step-32</a> tutorial programs (where we use an algebraic multigrid method) and <a class="el" href="step_56.html">step-56</a> (where we use a geometric multigrid method).</p>
<p><a class="anchor" id="Noblockmatricesandvectors"></a></p><h5>No block matrices and vectors</h5>
<p>Another possibility that can be taken into account is to not set up a block system, but rather solve the system of velocity and pressure all at once. The options are direct solve with UMFPACK (2D) or GMRES with ILU preconditioning (3D). It should be straightforward to try that.</p>
<p><a class="anchor" id="Moreinterestingtestcases"></a></p><h4>More interesting testcases</h4>
<p>The program can of course also serve as a basis to compute the flow in more interesting cases. The original motivation to write this program was for it to be a starting point for some geophysical flow problems, such as the movement of magma under places where continental plates drift apart (for example mid-ocean ridges). Of course, in such places, the geometry is more complicated than the examples shown above, but it is not hard to accommodate for that.</p>
<p>For example, by using the following modification of the boundary values function </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span></div>
<div class="line"><a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a> (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>  &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (component &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>,</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a> (<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, this-&gt;n_components));</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> x_offset = <a class="code" href="function__lib__0_8txt.html#a47a8bdf43853e7a30a2a344567b78cde">std::atan</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[1]*4)/3;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0)</div>
<div class="line">    <span class="keywordflow">return</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &lt; x_offset ? -1 : (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &gt; x_offset ? 1 : 0));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> and the following way to generate the mesh as the domain \([-2,2]\times[-2,2]\times[-1,0]\) </p><div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a> (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, 1);</div>
<div class="line"><a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>[0] = 4;</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;2)</div>
<div class="line">  <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>[1] = 4;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> bottom_left = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?</div>
<div class="line">                                <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2,-1) :</div>
<div class="line">                                <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(-2,-2,-1));</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> top_right   = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?</div>
<div class="line">                                <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(2,0) :</div>
<div class="line">                                <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(2,2,0));</div>
<div class="line"> </div>
<div class="line"><a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                           <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>,</div>
<div class="line">                                           bottom_left,</div>
<div class="line">                                           top_right);</div>
</div><!-- fragment --><p> then we get images where the fault line is curved: </p><table width="60%" align="center">
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d-extension.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d-grid-extension.png" alt="" class="inline"/>   </td></tr>
</table>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2008 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Wolfgang Bangerth, Texas A&amp;M University, 2008</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparse__matrix_8h.html">deal.II/lac/block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__ilu_8h.html">deal.II/lac/sparse_ilu.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep22.html">Step22</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">struct </span>InnerPreconditioner;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;&gt;</div>
<div class="line">  <span class="keyword">struct </span>InnerPreconditioner&lt;2&gt;</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;&gt;</div>
<div class="line">  <span class="keyword">struct </span>InnerPreconditioner&lt;3&gt;</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>);</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span> refine_mesh();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line">    <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      preconditioner_sparsity_pattern;</div>
<div class="line">    <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">std::shared_ptr&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt; A_preconditioner;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classBoundaryValues.html">BoundaryValues</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classBoundaryValues.html">BoundaryValues</a>()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="classStep22_1_1BoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, this-&gt;n_components));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0)</div>
<div class="line">      <span class="keywordflow">return</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &lt; 0 ? -1 : (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &gt; 0 ? 1 : 0));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1BoundaryValues.html#a2f153a49969a599502c29c4ea80bd034">BoundaryValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                         <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="classStep22_1_1BoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a>(p, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classRightHandSide.html">RightHandSide</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classRightHandSide.html">RightHandSide</a>()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="classStep22_1_1RightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1RightHandSide.html#a6deb4e3cb5cc0913313f6a02d8d818b1">RightHandSide&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                        <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="classStep22_1_1RightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide&lt;dim&gt;::value</a>(p, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                  <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a>         <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const PreconditionerType&gt;</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <a class="code" href="classStep22_1_1InverseMatrix.html#a8ee0d2b7905ba0648efb2d506e0200fb">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix</a>(</div>
<div class="line">    <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">    <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">    : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">    , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(&amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(src.<a class="code" href="group__Vectors.html#ga81dcfa5c77bdd426603386c0844149ae">size</a>(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * src.<a class="code" href="classVector.html#a8ee1b8309a7a9ecf109c8a7116733ef8">l2_norm</a>());</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">    cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, *<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keyword">class </span>SchurComplement : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SchurComplement(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> &amp;system_matrix,</div>
<div class="line">      <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>, PreconditionerType&gt; &amp;A_inverse);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const BlockSparseMatrix&lt;double&gt;</a>&gt; system_matrix;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;</div>
<div class="line">      <span class="keyword">const</span> InverseMatrix&lt;SparseMatrix&lt;double&gt;, PreconditionerType&gt;&gt;</div>
<div class="line">      A_inverse;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">mutable</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp1, tmp2;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  SchurComplement&lt;PreconditionerType&gt;::SchurComplement(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> &amp;system_matrix,</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>, PreconditionerType&gt; &amp;A_inverse)</div>
<div class="line">    : system_matrix(&amp;system_matrix)</div>
<div class="line">    , A_inverse(&amp;A_inverse)</div>
<div class="line">    , tmp1(system_matrix.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(0, 0).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">    , tmp2(system_matrix.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(0, 0).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">SchurComplement&lt;PreconditionerType&gt;::vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                                             <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    system_matrix-&gt;block(0, 1).<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(tmp1, src);</div>
<div class="line">    A_inverse-&gt;vmult(tmp2, tmp1);</div>
<div class="line">    system_matrix-&gt;block(1, 0).vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, tmp2);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::StokesProblem</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    : <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    , <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">    , <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>), 1)</div>
<div class="line">    , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::setup_dofs</a>()</div>
<div class="line">  {</div>
<div class="line">    A_preconditioner.reset();</div>
<div class="line">    system_matrix.clear();</div>
<div class="line">    preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    dof_handler.distribute_dofs(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;unsigned int&gt; block_component(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">    block_component[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                               1,</div>
<div class="line">                                               <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                               <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                               <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">      dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">      dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">      dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        dof_handler, coupling, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> preconditioner_dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      preconditioner_dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">      preconditioner_dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">      preconditioner_dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">      preconditioner_dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      preconditioner_dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">            preconditioner_coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            preconditioner_coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                      preconditioner_coupling,</div>
<div class="line">                                      preconditioner_dsp,</div>
<div class="line">                                      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                      <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      preconditioner_sparsity_pattern.copy_from(preconditioner_dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line">    preconditioner_matrix.reinit(preconditioner_sparsity_pattern);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(2);</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0).reinit(n_u);</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).reinit(n_p);</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    system_rhs.reinit(2);</div>
<div class="line">    system_rhs.block(0).reinit(n_u);</div>
<div class="line">    system_rhs.block(1).reinit(n_p);</div>
<div class="line">    system_rhs.collect_sizes();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::assemble_system</a>()</div>
<div class="line">  {</div>
<div class="line">    system_matrix         = 0;</div>
<div class="line">    system_rhs            = 0;</div>
<div class="line">    preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_preconditioner_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>,</div>
<div class="line">                                                   <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classRightHandSide.html">RightHandSide&lt;dim&gt;</a>    <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>;</div>
<div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; symgrad_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        local_matrix                = 0;</div>
<div class="line">        local_preconditioner_matrix = 0;</div>
<div class="line">        local_rhs                   = 0;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>.vector_value_list(fe_values.get_quadrature_points(),</div>
<div class="line">                                          rhs_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                symgrad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                  fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt;= <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                  {</div>
<div class="line">                    local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      (2 * (symgrad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * symgrad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) <span class="comment">// (1)</span></div>
<div class="line">                       - div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]                 <span class="comment">// (2)</span></div>
<div class="line">                       - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])                <span class="comment">// (3)</span></div>
<div class="line">                      * fe_values.JxW(q);                        <span class="comment">// * dx</span></div>
<div class="line"> </div>
<div class="line">                    local_preconditioner_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      (phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) <span class="comment">// (4)</span></div>
<div class="line">                      * fe_values.JxW(q);   <span class="comment">// * dx</span></div>
<div class="line">                  }</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div>
<div class="line">                  <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first;</div>
<div class="line">                local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q)   <span class="comment">// (phi_u_i(x_q)</span></div>
<div class="line">                                 * rhs_values[q](component_i)) <span class="comment">// * f(x_q))</span></div>
<div class="line">                                * fe_values.JxW(q);            <span class="comment">// * dx</span></div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> + 1; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">            {</div>
<div class="line">              local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = local_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">              local_preconditioner_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) =</div>
<div class="line">                local_preconditioner_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(local_matrix,</div>
<div class="line">                                               local_rhs,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               system_matrix,</div>
<div class="line">                                               system_rhs);</div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(local_preconditioner_matrix,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               preconditioner_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Computing preconditioner...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    A_preconditioner =</div>
<div class="line">      <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">std::make_shared&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt;();</div>
<div class="line">    A_preconditioner-&gt;initialize(</div>
<div class="line">      system_matrix.block(0, 0),</div>
<div class="line">      <span class="keyword">typename</span> <a class="code" href="relaxation__block__0_8txt.html#a2076fd56276055e74e230fad6edac013">InnerPreconditioner&lt;dim&gt;::type::AdditionalData</a>());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">StokesProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;SparseMatrix&lt;double&gt;,</div>
<div class="line">                        <span class="keyword">typename</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">InnerPreconditioner&lt;dim&gt;::type</a>&gt;</div>
<div class="line">                   A_inverse(system_matrix.block(0, 0), *A_preconditioner);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0).size());</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> schur_rhs(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).size());</div>
<div class="line">      A_inverse.vmult(tmp, system_rhs.block(0));</div>
<div class="line">      system_matrix.block(1, 0).vmult(schur_rhs, tmp);</div>
<div class="line">      schur_rhs -= system_rhs.block(1);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">SchurComplement&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt; <a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>(</div>
<div class="line">        system_matrix, A_inverse);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).size(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * schur_rhs.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">      <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(preconditioner_matrix.block(1, 1),</div>
<div class="line">                                <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;::AdditionalData</a>());</div>
<div class="line"> </div>
<div class="line">      InverseMatrix&lt;SparseMatrix&lt;double&gt;, <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>&gt; m_inverse(</div>
<div class="line">        preconditioner_matrix.block(1, 1), <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">      cg.solve(<a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1), schur_rhs, m_inverse);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot; outer CG Schur complement iterations for pressure&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      system_matrix.block(0, 1).vmult(tmp, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1));</div>
<div class="line">      tmp *= -1;</div>
<div class="line">      tmp += system_rhs.block(0);</div>
<div class="line"> </div>
<div class="line">      A_inverse.vmult(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0), tmp);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::output_results</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::vector&lt;std::string&gt; solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      data_component_interpretation(</div>
<div class="line">        <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">                             solution_names,</div>
<div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                             data_component_interpretation);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(</div>
<div class="line">      <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(refinement_cycle, 2) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::refine_mesh</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">      dof_handler,</div>
<div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1),</div>
<div class="line">      <a class="code" href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">std::map</a>&lt;<a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">      <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">      estimated_error_per_cell,</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                    estimated_error_per_cell,</div>
<div class="line">                                                    0.3,</div>
<div class="line">                                                    0.0);</div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">StokesProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    {</div>
<div class="line">      std::vector&lt;unsigned int&gt; <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, 1);</div>
<div class="line">      <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>[0] = 4;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> bottom_left = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?                </div>
<div class="line">                                        <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2, -1) :    <span class="comment">// 2d case</span></div>
<div class="line">                                        <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(-2, 0, -1)); <span class="comment">// 3d case</span></div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> top_right = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?              </div>
<div class="line">                                      <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(2, 0) :    <span class="comment">// 2d case</span></div>
<div class="line">                                      <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(2, 1, 0)); <span class="comment">// 3d case</span></div>
<div class="line"> </div>
<div class="line">      <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>,</div>
<div class="line">                                                bottom_left,</div>
<div class="line">                                                top_right);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1] == 0)</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_all_boundary_ids(1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(4 - <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 6;</div>
<div class="line">         ++refinement_cycle)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div>
<div class="line">          refine_mesh();</div>
<div class="line"> </div>
<div class="line">        setup_dofs();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        output_results(refinement_cycle);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step22</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep22.html">Step22</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;2&gt;</a> flow_problem(1);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><br  />
 This tutorial depends on <a class="el" href="step_6.html">step-6</a> , <a class="el" href="step_21.html">step-21</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Weakform">Weak form</a><a href="#Weakform">Weak form</a>
        <li><a href="#Boundaryconditions">Boundary conditions</a><a href="#Boundaryconditions">Boundary conditions</a>
        <li><a href="#Discretization">Discretization</a><a href="#Discretization">Discretization</a>
        <li><a href="#Linearsolverandpreconditioningissues">Linear solver and preconditioning issues</a><a href="#Linearsolverandpreconditioningissues">Linear solver and preconditioning issues</a>
      <ul>
        <li><a href="#IsthishowoneshouldsolvetheStokesequations"> Is this how one should solve the Stokes equations? </a><a href="#IsthishowoneshouldsolvetheStokesequations"> Is this how one should solve the Stokes equations? </a>
        <li><a href="#Anoteonthestructureofthelinearsystem"> A note on the structure of the linear system </a><a href="#Anoteonthestructureofthelinearsystem"> A note on the structure of the linear system </a>
      </ul>
        <li><a href="#Thetestcase">The testcase</a><a href="#Thetestcase">The testcase</a>
        <li><a href="#Implementation">Implementation</a><a href="#Implementation">Implementation</a>
      <ul>
        <li><a href="#UsingimhomogeneousconstraintsforimplementingDirichletboundaryconditions">Using imhomogeneous constraints for implementing Dirichlet boundary conditions</a><a href="#UsingimhomogeneousconstraintsforimplementingDirichletboundaryconditions">Using imhomogeneous constraints for implementing Dirichlet boundary conditions</a>
        <li><a href="#UsingAffineConstraintsforincreasingperformance">Using AffineConstraints for increasing performance</a><a href="#UsingAffineConstraintsforincreasingperformance">Using AffineConstraints for increasing performance</a>
        <li><a href="#Performanceoptimizations">Performance optimizations</a><a href="#Performanceoptimizations">Performance optimizations</a>
    </ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#Definingtheinnerpreconditionertype">Defining the inner preconditioner type</a><a href="#Definingtheinnerpreconditionertype">Defining the inner preconditioner type</a>
        <li><a href="#ThecodeStokesProblemcodeclasstemplate">The <code>StokesProblem</code> class template</a><a href="#ThecodeStokesProblemcodeclasstemplate">The <code>StokesProblem</code> class template</a>
        <li><a href="#Boundaryvaluesandrighthandside">Boundary values and right hand side</a><a href="#Boundaryvaluesandrighthandside">Boundary values and right hand side</a>
        <li><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a>
      <ul>
        <li><a href="#ThecodeInverseMatrixcodeclasstemplate">The <code>InverseMatrix</code> class template</a><a href="#ThecodeInverseMatrixcodeclasstemplate">The <code>InverseMatrix</code> class template</a>
        <li><a href="#ThecodeSchurComplementcodeclasstemplate">The <code>SchurComplement</code> class template</a><a href="#ThecodeSchurComplementcodeclasstemplate">The <code>SchurComplement</code> class template</a>
      </ul>
        <li><a href="#StokesProblemclassimplementation">StokesProblem class implementation</a><a href="#StokesProblemclassimplementation">StokesProblem class implementation</a>
      <ul>
        <li><a href="#StokesProblemStokesProblem">StokesProblem::StokesProblem</a><a href="#StokesProblemStokesProblem">StokesProblem::StokesProblem</a>
        <li><a href="#StokesProblemsetup_dofs">StokesProblem::setup_dofs</a><a href="#StokesProblemsetup_dofs">StokesProblem::setup_dofs</a>
        <li><a href="#StokesProblemassemble_system">StokesProblem::assemble_system</a><a href="#StokesProblemassemble_system">StokesProblem::assemble_system</a>
        <li><a href="#StokesProblemsolve">StokesProblem::solve</a><a href="#StokesProblemsolve">StokesProblem::solve</a>
        <li><a href="#StokesProblemoutput_results">StokesProblem::output_results</a><a href="#StokesProblemoutput_results">StokesProblem::output_results</a>
        <li><a href="#StokesProblemrefine_mesh">StokesProblem::refine_mesh</a><a href="#StokesProblemrefine_mesh">StokesProblem::refine_mesh</a>
        <li><a href="#StokesProblemrun">StokesProblem::run</a><a href="#StokesProblemrun">StokesProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Outputoftheprogramandgraphicalvisualization">Output of the program and graphical visualization</a><a href="#Outputoftheprogramandgraphicalvisualization">Output of the program and graphical visualization</a>
      <ul>
        <li><a href="#2Dcalculations">2D calculations</a><a href="#2Dcalculations">2D calculations</a>
        <li><a href="#3Dcalculations">3D calculations</a><a href="#3Dcalculations">3D calculations</a>
      </ul>
        <li><a href="#Sparsitypattern">Sparsity pattern</a><a href="#Sparsitypattern">Sparsity pattern</a>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
      <ul>
        <li><a href="#Improvedlinearsolverin3D">Improved linear solver in 3D</a><a href="#Improvedlinearsolverin3D">Improved linear solver in 3D</a>
      <ul>
        <li><a href="#BetterILUdecompositionbysmartreordering">Better ILU decomposition by smart reordering</a><a href="#BetterILUdecompositionbysmartreordering">Better ILU decomposition by smart reordering</a>
        <li><a href="#BetterpreconditionerfortheinnerCGsolver">Better preconditioner for the inner CG solver</a><a href="#BetterpreconditionerfortheinnerCGsolver">Better preconditioner for the inner CG solver</a>
        <li><a href="#BlockSchurcomplementpreconditioner">Block Schur complement preconditioner</a><a href="#BlockSchurcomplementpreconditioner">Block Schur complement preconditioner</a>
        <li><a href="#Combiningtheblockpreconditionerandmultigrid">Combining the block preconditioner and multigrid</a><a href="#Combiningtheblockpreconditionerandmultigrid">Combining the block preconditioner and multigrid</a>
        <li><a href="#Noblockmatricesandvectors">No block matrices and vectors</a><a href="#Noblockmatricesandvectors">No block matrices and vectors</a>
      </ul>
        <li><a href="#Moreinterestingtestcases">More interesting testcases</a><a href="#Moreinterestingtestcases">More interesting testcases</a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
 <br  />
 <em>This program was contributed by Martin Kronbichler and Wolfgang Bangerth. <br  />
 This material is based upon work partly supported by the National Science Foundation under Award No. EAR-0426271 and The California Institute of Technology. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation or of The California Institute of Technology. </em></p>
<p><a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>This program deals with the Stokes system of equations which reads asfollows in non-dimensionalized form: </p><p class="formulaDsp">
\begin{eqnarray*} -2\; \textrm{div}\; \varepsilon(\textbf{u}) + \nabla p &amp;=&amp; \textbf{f}, \\ -\textrm{div}\; \textbf{u} &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> where \(\textbf u\) denotes the velocity of a fluid, \(p\) is itspressure, \(\textbf f\) are external forces, and \(\varepsilon(\textbf{u})= \nabla^s{\textbf{u}}= \frac 12 \left[ (\nabla \textbf{u}) + (\nabla \textbf{u})^T\right]\) is therank-2 tensor of symmetrized gradients; a component-wise definitionof it is \(\varepsilon(\textbf{u})_{ij}=\frac 12\left(\frac{\partial u_i}{\partial x_j} + \frac{\partial u_j}{\partial x_i}\right)\) . The Stokes equations describe the steady-state motion of aslow-moving, viscous fluid such as honey, rocks in the earth mantle,or other cases where inertia does not play a significant role. If afluid is moving fast enough that inertia forces are significantcompared to viscous friction, the Stokes equations are no longervalid; taking into account inertia effects then leads to thenonlinear Navier-Stokes equations. However, in this tutorial program,we will focus on the simpler Stokes system. Note that when deriving the more general compressible Navier-Stokes equations,the diffusion is modeled as the divergence of the stress tensor </p><p class="formulaDsp">
\begin{eqnarray*} \tau = - \mu (2\varepsilon(\textbf{u}) - \frac{2}{3}\nabla \cdot \textbf{u} I), \end{eqnarray*}
</p>
<p> where \(\mu\) is the viscosity of the fluid. With the assumption of \(\mu=1\) (assume constant viscosity and non-dimensionalize the equation by dividing out \(\mu\) ) and assuming incompressibility ( \(\textrm{div}\; \textbf{u}=0\) ), wearrive at the formulation from above: </p><p class="formulaDsp">
\begin{eqnarray*} \textrm{div}\; \tau = -2\textrm{div}\;\varepsilon(\textbf{u}). \end{eqnarray*}
</p>
<p> A different formulation uses the Laplace operator ( \(-\triangle \textbf{u}\) )instead of the symmetrized gradient. A big difference here is that thedifferent components of the velocity do not couple. If you assume additionalregularity of the solution \(\textbf{u}\) (second partial derivatives exist andare continuous), the formulations are equivalent: </p><p class="formulaDsp">
\begin{eqnarray*} \textrm{div}\; \tau = -2\textrm{div}\;\varepsilon(\textbf{u}) = -\triangle \textbf{u} + \nabla \cdot (\nabla\textbf{u})^T = -\triangle \textbf{u}. \end{eqnarray*}
</p>
<p> This is because the \(i\) th entry of \(\nabla \cdot (\nabla\textbf{u})^T\) is given by: </p><p class="formulaDsp">
\begin{eqnarray*} [\nabla \cdot (\nabla\textbf{u})^T]_i = \sum_j \frac{\partial}{\partial x_j} [(\nabla\textbf{u})^T]_{i,j} = \sum_j \frac{\partial}{\partial x_j} [(\nabla\textbf{u})]_{j,i} = \sum_j \frac{\partial}{\partial x_j} \frac{\partial}{\partial x_i} \textbf{u}_j = \sum_j \frac{\partial}{\partial x_i} \frac{\partial}{\partial x_j} \textbf{u}_j = \frac{\partial}{\partial x_i} \textrm{div}\; \textbf{u} = 0. \end{eqnarray*}
</p>
<p> If you can not assume the above mentioned regularity, or if your viscosity isnot a constant, the equivalence no longer holds. Therefore, we decided tostick with the more physically accurate symmetric tensor formulation in thistutorial.</p>
<p>To be well-posed, we will have to add boundary conditions to theequations. What boundary conditions are readily possible here willbecome clear once we discuss the weak form of the equations. The equations covered here fall into the class of vector-valued problems. Atoplevel overview of this topic can be found in the <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> module.</p>
<p><a class="anchor" id="Weakform"></a></p><h3>Weak form</h3>
<p>The weak form of the equations is obtained by writing it in vectorform as </p><p class="formulaDsp">
\begin{eqnarray*} \begin{pmatrix} {-2\; \textrm{div}\; \varepsilon(\textbf{u}) + \nabla p} \\ {-\textrm{div}\; \textbf{u}} \end{pmatrix} = \begin{pmatrix} {\textbf{f}} \\ 0 \end{pmatrix}, \end{eqnarray*}
</p>
<p> forming the dot product from the left with a vector-valued testfunction \(\phi = \begin{pmatrix}\textbf{v} \\ q\end{pmatrix}\) and integratingover the domain \(\Omega\) , yielding the following set of equations: </p><p class="formulaDsp">
\begin{eqnarray*} (\mathrm v, -2\; \textrm{div}\; \varepsilon(\textbf{u}) + \nabla p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega, \end{eqnarray*}
</p>
<p> which has to hold for all test functions \(\phi = \begin{pmatrix}\textbf{v} \\ q\end{pmatrix}\) . A generally good rule of thumb is that if one <em>can</em> reduce howmany derivatives are taken on any variable in the formulation, thenone <em>should</em> in fact do that using integration by parts. (This ismotivated by the theory of <a href="https://en.wikipedia.org/wiki/Partial_differential_equation">partial differential equations</a>, and in particular the difference betweenstrong and <a href="https://en.wikipedia.org/wiki/Weak_solution">weak solutions</a>.) We have already done that for the Laplace equation,where we have integrated the second derivative by parts to obtain theweak formulation that has only one derivative on both test and trialfunction. In the current context, we integrate by parts the second term: </p><p class="formulaDsp">
\begin{eqnarray*} (\textbf{v}, -2\; \textrm{div}\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} + (\textbf{n}\cdot\textbf{v}, p)_{\partial\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega. \end{eqnarray*}
</p>
<p> Likewise, we integrate by parts the first term to obtain </p><p class="formulaDsp">
\begin{eqnarray*} (\nabla \textbf{v}, 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textbf{n} \otimes \textbf{v}, 2\; \varepsilon(\textbf{u}))_{\partial\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} + (\textbf{n}\cdot\textbf{v}, p)_{\partial\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega, \end{eqnarray*}
</p>
<p> where the scalar product between two tensor-valued quantities is heredefined as </p><p class="formulaDsp">
\begin{eqnarray*} (\nabla \textbf{v}, 2\; \varepsilon(\textbf{u}))_{\Omega} = 2 \int_\Omega \sum_{i,j=1}^d \frac{\partial v_j}{\partial x_i} \varepsilon(\textbf{u})_{ij} \ dx. \end{eqnarray*}
</p>
<p> Using this, we have now reduced the requirements on our variables tofirst derivatives for \(\mathbf u,\mathbf v\) and no derivatives at allfor \(p,q\) . Because the scalar product between a general tensor like \(\nabla\textbf{v}\) and a symmetric tensor like \(\varepsilon(\textbf{u})\) equals the scalar product between thesymmetrized forms of the two, we can also write the bilinear formabove as follows: </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textbf{n} \otimes \textbf{v}, 2\; \varepsilon(\textbf{u}))_{\partial\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} + (\textbf{n}\cdot\textbf{v}, p)_{\partial\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega, \end{eqnarray*}
</p>
<p> We will deal with the boundary terms in the next section, but it is alreadyclear from the domain terms </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} \end{eqnarray*}
</p>
<p> of the bilinear form that the Stokes equations yield a symmetric bilinearform, and consequently a symmetric (if indefinite) system matrix.</p>
<p><a class="anchor" id="Boundaryconditions"></a></p><h3>Boundary conditions</h3>
<dl class="section note"><dt>Note</dt><dd>The material presented here is also discussed in <a href="http://www.math.colostate.edu/~bangerth/videos.676.21.5.html">video lecture 21.5</a>. (All video lectures are also available <a href="http://www.math.colostate.edu/~bangerth/videos.html">here</a>.) ( See also <a href="http://www.math.colostate.edu/~bangerth/videos.676.21.55.html">video lecture 21.55</a>, <a href="http://www.math.colostate.edu/~bangerth/videos.676.21.6.html">video lecture 21.6</a>, <a href="http://www.math.colostate.edu/~bangerth/videos.676.21.65.html">video lecture 21.65</a>.) <br  />
 The weak form just derived immediately presents us with differentpossibilities for imposing boundary conditions: <ol>
<li>
Dirichlet velocity boundary conditions: On a part \(\Gamma_D\subset\partial\Omega\) we may impose Dirichlet conditions on the velocity \(\textbf u\) : <p class="formulaDsp">
\begin{eqnarray*} \textbf u = \textbf g_D \qquad\qquad \textrm{on}\ \Gamma_D. \end{eqnarray*}
</p>
 Because test functions \(\textbf{v}\) come from the tangent space of the solution variable, we have that \(\textbf{v}=0\) on \(\Gamma_D\) and consequently that <p class="formulaDsp">
\begin{eqnarray*} -(\textbf{n} \otimes \mathrm v, 2\; \varepsilon(\textbf{u}))_{\Gamma_D} + (\textbf{n}\cdot\textbf{v}, p)_{\Gamma_D} = 0. \end{eqnarray*}
</p>
 In other words, as usual, strongly imposed boundary values do not appear in the weak form. It is noteworthy that if we impose Dirichlet boundary values on the entire boundary, then the pressure is only determined up to a constant. An algorithmic realization of that would use similar tools as have been seen in <a class="el" href="step_11.html">step-11</a> . </li>
<li>
<p class="startli">Neumann-type or natural boundary conditions: On the rest of the boundary \(\Gamma_N=\partial\Omega\backslash\Gamma_D\) , let us re-write the boundary terms as follows: </p><p class="formulaDsp">
\begin{eqnarray*} -(\textbf{n} \otimes \mathrm v, 2\; \varepsilon(\textbf{u}))_{\Gamma_N} + (\textbf{n}\cdot\textbf{v}, p)_{\Gamma_N} &amp;=&amp; \sum_{i,j=1}^d -(n_i v_j, 2\; \varepsilon(\textbf{u})_{ij})_{\Gamma_N} + \sum_{i=1}^d (n_i v_i, p)_{\Gamma_N} \\ &amp;=&amp; \sum_{i,j=1}^d -(n_i v_j, 2\; \varepsilon(\textbf{u})_{ij})_{\Gamma_N} + \sum_{i,j=1}^d (n_i v_j, p \delta_{ij})_{\Gamma_N} \\ &amp;=&amp; \sum_{i,j=1}^d (n_i v_j,p \delta_{ij} - 2\; \varepsilon(\textbf{u})_{ij})_{\Gamma_N} \\ &amp;=&amp; (\textbf{n} \otimes \textbf{v}, p \textbf{I} - 2\; \varepsilon(\textbf{u}))_{\Gamma_N}. \\ &amp;=&amp; (\textbf{v}, \textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})])_{\Gamma_N}. \end{eqnarray*}
</p>
<p> In other words, on the Neumann part of the boundary we can prescribe values for the total stress: </p><p class="formulaDsp">
\begin{eqnarray*} \textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})] = \textbf g_N \qquad\qquad \textrm{on}\ \Gamma_N. \end{eqnarray*}
</p>
<p> If the boundary is subdivided into Dirichlet and Neumann parts \(\Gamma_D,\Gamma_N\) , this then leads to the following weak form: </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega - (\textbf{v}, \textbf g_N)_{\Gamma_N}. \end{eqnarray*}
</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Robin-type boundary conditions: Robin boundary conditions are a mixture of Dirichlet and Neumann boundary conditions. They would read </p><p class="formulaDsp">
\begin{eqnarray*} \textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})] = \textbf S \textbf u \qquad\qquad \textrm{on}\ \Gamma_R, \end{eqnarray*}
</p>
<p> with a rank-2 tensor (matrix) \(\textbf S\) . The associated weak form is </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} + (\textbf S \textbf u, \textbf{v})_{\Gamma_R} = (\textbf{v}, \textbf{f})_\Omega. \end{eqnarray*}
</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Partial boundary conditions: It is possible to combine Dirichlet and Neumann boundary conditions by only enforcing each of them for certain components of the velocity. For example, one way to impose artificial boundary conditions is to require that the flow is perpendicular to the boundary, i.e. the tangential component \(\textbf u_{\textbf t}=(\textbf 1-\textbf n\otimes\textbf n)\textbf u\) be zero, thereby constraining <code>dim</code> -1 components of the velocity. The remaining component can be constrained by requiring that the normal component of the normal stress be zero, yielding the following set of boundary conditions: </p><p class="formulaDsp">
\begin{eqnarray*} \textbf u_{\textbf t} &amp;=&amp; 0, \\ \textbf n \cdot \left(\textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})] \right) &amp;=&amp; 0. \end{eqnarray*}
</p>
<p class="endli">An alternative to this is when one wants the flow to be <em>parallel</em> rather than perpendicular to the boundary (in deal.II, the <a class="el" href="group__constraints.html#ga0d16c332aaa652e8905a6f48208e4500">VectorTools::compute_no_normal_flux_constraints</a> function can do this for you). This is frequently the case for problems with a free boundary (e.g. at the surface of a river or lake if vertical forces of the flow are not large enough to actually deform the surface), or if no significant friction is exerted by the boundary on the fluid (e.g. at the interface between earth mantle and earth core where two fluids meet that are stratified by different densities but that both have small enough viscosities to not introduce much tangential stress on each other). In formulas, this means that </p><p class="formulaDsp">
\begin{eqnarray*} \textbf{n}\cdot\textbf u &amp;=&amp; 0, \\ (\textbf 1-\textbf n\otimes\textbf n) \left(\textbf{n}\cdot [p \textbf{I} - 2\; \varepsilon(\textbf{u})] \right) &amp;=&amp; 0, \end{eqnarray*}
</p>
<p> the first condition (which needs to be imposed strongly) fixing a single component of the velocity, with the second (which would be enforced in the weak form) fixing the remaining two components. </p>
</li>
</ol>
<br  />
 Despite this wealth of possibilities, we will only use Dirichlet and(homogeneous) Neumann boundary conditions in this tutorial program.</dd></dl>
<p><a class="anchor" id="Discretization"></a></p><h3>Discretization</h3>
<p>As developed above, the weak form of the equations with Dirichlet and Neumannboundary conditions on \(\Gamma_D\) and \(\Gamma_N\) reads like this: find \(\textbf u\in \textbf V_g = \{\varphi \in H^1(\Omega)^d: \varphi_{\Gamma_D}=\textbf g_D\}, p\in Q=L^2(\Omega)\) so that </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}), 2\; \varepsilon(\textbf{u}))_{\Omega} - (\textrm{div}\; \textbf{v}, p)_{\Omega} - (q,\textrm{div}\; \textbf{u})_{\Omega} = (\textbf{v}, \textbf{f})_\Omega - (\textbf{v}, \textbf g_N)_{\Gamma_N} \end{eqnarray*}
</p>
<p> for all test functions \(\textbf{v}\in \textbf V_0 = \{\varphi \in H^1(\Omega)^d: \varphi_{\Gamma_D}=0\},q\in Q\) . These equations represent a symmetric <a href="https://en.wikipedia.org/wiki/Ladyzhenskaya%E2%80%93Babu%C5%A1ka%E2%80%93Brezzi_condition">saddle point problem</a>. It is well knownthat then a solution only exists if the function spaces in which we search fora solution have to satisfy certain conditions, typically referred to as theBabuska-Brezzi or Ladyzhenskaya-Babuska-Brezzi (LBB) conditions. The continuousfunction spaces above satisfy these. However, when we discretize the equations byreplacing the continuous variables and test functions by finite elementfunctions in finite dimensional spaces \(\textbf V_{g,h}\subset \textbf V_g, Q_h\subset Q\) , we have to make sure that \(\textbf V_h,Q_h\) also satisfy the LBBconditions. This is similar to what we had to do in <a class="el" href="step_20.html">step-20</a> . For the Stokes equations, there are a number of possible choices to ensurethat the finite element spaces are compatible with the LBB condition. A simpleand accurate choice that we will use here is \(\textbf u_h\in Q_{p+1}^d, p_h\in Q_p\) , i.e. use elements one order higher for the velocities than for thepressures. This then leads to the following discrete problem: find \(\textbf u_h,p_h\) sothat </p><p class="formulaDsp">
\begin{eqnarray*} (\varepsilon(\textbf{v}_h), 2\; \varepsilon(\textbf u_h))_{\Omega} - (\textrm{div}\; \textbf{v}_h, p_h)_{\Omega} - (q_h,\textrm{div}\; \textbf{u}_h)_{\Omega} = (\textbf{v}_h, \textbf{f})_\Omega - (\textbf{v}_h, \textbf g_N)_{\Gamma_N} \end{eqnarray*}
</p>
<p> for all test functions \(\textbf{v}_h, q_h\) . Assembling the linear systemassociated with this problem follows the same lines used in <a class="el" href="step_20.html">@ref step_20 </a>step-20"  ", <a class="el" href="step_21.html">step-21</a> , and explained in detail in the <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> module.</p>
<p><a class="anchor" id="Linearsolverandpreconditioningissues"></a></p><h3>Linear solver and preconditioning issues</h3>
<p>The weak form of the discrete equations naturally leads to the followinglinear system for the nodal values of the velocity and pressure fields: </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{c} U \\ P \end{array}\right) = \left(\begin{array}{c} F \\ G \end{array}\right), \end{eqnarray*}
</p>
<p> Like in <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a> , we will solve thissystem of equations by forming the Schur complement, i.e. we will first findthe solution \(P\) of </p><p class="formulaDsp">
\begin{eqnarray*} BA^{-1}B^T P &amp;=&amp; BA^{-1} F - G, \\ \end{eqnarray*}
</p>
<p> and then </p><p class="formulaDsp">
\begin{eqnarray*} AU &amp;=&amp; F - B^TP. \end{eqnarray*}
</p>
<p> The way we do this is pretty much exactly like we did in these previoustutorial programs, i.e. we use the same classes <code>SchurComplement</code> and <code>InverseMatrix</code> again. There are two significant differences,however: </p><ol>
<li>
First, in the mixed Laplace equation we had to deal with the question of howto precondition the Schur complement \(B^TM^{-1}B\) , which was spectrallyequivalent to the Laplace operator on the pressure space (because \(B\) represents the gradient operator, \(B^T\) its adjoint \(-\textrm{div}\) , and \(M\) the identity (up to the material parameter \(K^{-1}\) ), so \(B^TM^{-1}B\) issomething like \(-\textrm{div} \mathbf 1 \nabla = -\Delta\) ). Consequently, thematrix is badly conditioned for small mesh sizes and we had to come up with anelaborate preconditioning scheme for the Schur complement. </li>
<li>
Second, every time we multiplied with \(B^TM^{-1}B\) we had to solve with themass matrix \(M\) . This wasn't particularly difficult, however, since the massmatrix is always well conditioned and so simple to invert using CG and alittle bit of preconditioning. </li>
</ol>
<p>In other words, preconditioning the inner solver for \(M\) was simple whereaspreconditioning the outer solver for \(B^TM^{-1}B\) was complicated. Here, the situation is pretty much exactly the opposite. The difference stemsfrom the fact that the matrix at the heart of the Schur complement does notstem from the identity operator but from a variant of the Laplace operator, \(-\textrm{div} \nabla^s\) (where \(\nabla^s\) is the symmetric gradient)acting on a vector field. In the investigation of this issuewe largely follow the paper D. Silvester and A. Wathen:"Fast iterative solution of stabilised Stokes systems part II. Usinggeneral block preconditioners." (SIAM J. Numer. Anal., 31 (1994),pp. 1352-1367), which is available online <a href="http://siamdl.aip.org/getabs/servlet/GetabsServlet?prog=normal&amp;id=SJNAAM000031000005001352000001&amp;idtype=cvips&amp;gifs=Yes" target="_top">here</a>.Principally, the difference in the matrix at the heart of the Schurcomplement has two consequences: </p><ol>
<li>
<p class="startli">First, it makes the outer preconditioner simple: the Schur complementcorresponds to the operator \(-\textrm{div} (-\textrm{div} \nabla^s)^{-1} \nabla\) on the pressure space; forgetting about the fact that we deal withsymmetric gradients instead of the regular one, the Schur complement issomething like \(-\textrm{div} (-\textrm{div} \nabla)^{-1} \nabla = -\textrm{div} (-\Delta)^{-1} \nabla\) , which, even if not mathematicallyentirely concise, is spectrally equivalent to the identity operator (aheuristic argument would be to commute the operators into \(-\textrm{div}(-\Delta)^{-1} \nabla = -\textrm{div}\nabla(-\Delta)^{-1} = -\Delta(-\Delta)^{-1} = \mathbf 1\) ). It turns out that it isn't easy to solvethis Schur complement in a straightforward way with the CG method:using no preconditioner, the condition number of the Schur complement matrixdepends on the size ratios of the largest to the smallest cells, and one stillneeds on the order of 50-100 CG iterations. However, there is a simple cure:precondition with the mass matrix on the pressure space and we get down to anumber between 5-15 CG iterations, pretty much independently of the structureof the mesh (take a look at the <a href="#Results">results section</a> of thisprogram to see that indeed the number of CG iterations does not change as werefine the mesh). So all we need in addition to what we already have is the mass matrix on thepressure variables and we will store it in a separate object.</p>
<pre class="fragment">&lt;li&gt;  While the outer preconditioner has become simpler compared to themixed Laplace case discussed in   @ref step_20 "step-20"  , the issue ofthe inner solver has become more complicated. In the mixed Laplacediscretization, the Schur complement has the form   @f$B^TM^{-1}B@f$  . Thus,every time we multiplied with the Schur complement, we had to solve alinear system   @f$M_uz=y@f$  ; this isn't too complicated there, however,since the mass matrix   @f$M_u@f$   on the pressure space is well-conditioned.
</pre><p class="endli">On the other hand, for the Stokes equation we consider here, the Schurcomplement is \(BA^{-1}B^T\) where the matrix \(A\) is related to theLaplace operator (it is, in fact, the matrix corresponding to thebilinear form \((\nabla^s \varphi_i, \nabla^s\varphi_j)\) ). Thus,solving with \(A\) is a lot more complicated: the matrix is badlyconditioned and we know that we need many iterations unless we have avery good preconditioner. What is worse, we have to solve with \(A\) every time we multiply with the Schur complement, which is 5-15 timesusing the preconditioner described above. Because we have to solve with \(A\) several times, it pays off to spenda bit more time once to create a good preconditioner for thismatrix. So here's what we're going to do: if in 2d, we use theultimate preconditioner, namely a direct sparse LU decomposition ofthe matrix. This is implemented using the <a class="el" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> classthat uses the UMFPACK direct solver to compute the decomposition. Touse it, you will have to build deal.II with UMFPACK support (which is thedefault); see the <a href="../../readme.html#optional-software">ReadMe file</a>for instructions. With this, the inner solver converges in one iteration. In 2d, we can do this sort of thing because even reasonably large problemsrarely have more than a few 100,000 unknowns with relatively few nonzeroentries per row. Furthermore, the bandwidth of matrices in 2d is \({\cal O}(\sqrt{N})\) and therefore moderate. For such matrices, sparse factors can becomputed in a matter of a few seconds. (As a point of reference, computing thesparse factors of a matrix of size \(N\) and bandwidth \(B\) takes \({\cal O}(NB^2)\) operations. In 2d, this is \({\cal O}(N^2)\) ; though this is a highercomplexity than, for example, assembling the linear system which takes \({\cal O}(N)\) , the constant for computing the decomposition is so small that itdoesn't become the dominating factor in the entire program until we get tovery large numbers of unknowns in the high 100,000s or more.) The situation changes in 3d, because there we quickly have many moreunknowns and the bandwidth of matrices (which determines the number ofnonzero entries in sparse LU factors) is \({\cal O}(N^{2/3})\) , and thereare many more entries per row as well. This makes using a sparsedirect solver such as UMFPACK inefficient: only for problem sizes of afew 10,000 to maybe 100,000 unknowns can a sparse decomposition becomputed using reasonable time and memory resources. What we do in that case is to use an incomplete LU decomposition (ILU) as apreconditioner, rather than actually computing complete LU factors. As it sohappens, deal.II has a class that does this: <a class="el" href="classSparseILU.html">SparseILU</a>. Computing the ILUtakes a time that only depends on the number of nonzero entries in the sparsematrix (or that we are willing to fill in the LU factors, if these should bemore than the ones in the matrix), but is independent of the bandwidth of thematrix. It is therefore an operation that can efficiently also be computed in3d. On the other hand, an incomplete LU decomposition, by definition, does notrepresent an exact inverse of the matrix \(A\) . Consequently, preconditioningwith the ILU will still require more than one iteration, unlikepreconditioning with the sparse direct solver. The inner solver will thereforetake more time when multiplying with the Schur complement: an unavoidabletrade-off. </p>
</li>
</ol>
<p><br  />
 In the program below, we will make use of the fact that the <a class="el" href="classSparseILU.html">SparseILU</a> andSparseDirectUMFPACK classes have a very similar interface and can be usedinterchangeably. All that we need is a switch class that, depending on thedimension, provides a type that is either of the two classes mentionedabove. This is how we do that: </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner;</div>
<div class="line">  </div>
<div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner&lt;2&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a>;</div>
<div class="line">};</div>
<div class="line">  </div>
<div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner&lt;3&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p>From here on, we can refer to the type <code>typename InnerPreconditioner&lt;dim&gt;::type</code> and automatically get the correctpreconditioner class. Because of the similarity of the interfaces of the twoclasses, we will be able to use them interchangeably using the same syntax inall places.</p>
<p><a class="anchor" id="IsthishowoneshouldsolvetheStokesequations"></a></p><h4>Is this how one should solve the Stokes equations? </h4>
<p>The discussions above showedone* way in which the linear system thatresults from the Stokes equations can be solved, and because thetutorial programs are teaching tools that makes sense. But is this theway this system of equationsshould* be solved? The answer to this is no. The primary bottleneck with the approach,already identified above, is that we have to repeatedly solve linearsystems with \(A\) inside the Schur complement, and because we don'thave a good preconditioner for the Schur complement, these solves justhave to happen too often. A better approach is to use a blockdecomposition, which is based on an observation of Silvester andWathen <b>[SW94]</b> and explained in much greater detail in <b>[elman2005]</b> . An implementation of this alternative approach isdiscussed below, in the section on a <a href="#block-schur">block Schur complementation preconditioner</a> in the results section of this program.</p>
<p><a class="anchor" id="Anoteonthestructureofthelinearsystem"></a></p><h4>A note on the structure of the linear system </h4>
<p>Above, we have claimed that the linear system has the form </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \left(\begin{array}{cc} U \\ P \end{array}\right) = \left(\begin{array}{cc} F \\ G \end{array}\right), \end{eqnarray*}
</p>
<p> i.e., in particular that there is a zero block at the bottom right of thematrix. This then allowed us to write the Schur complement as \(S=B A^{-1} B^T\) . But this is not quite correct. Think of what would happen if there are constraints on somepressure variables (see the <a class="el" href="group__constraints.html">Constraints on degrees of freedom</a> documentationmodule), for example because we use adaptivelyrefined meshes and continuous pressure finite elements so that thereare hanging nodes. Another cause for such constraints are Dirichletboundary conditions on the pressure. Then the AffineConstraintsclass, upon copying the local contributions to the matrix into theglobal linear system will zero out rows and columns correspondingto constrained degrees of freedom and put a positive entry onthe diagonal. (You can think of this entry as being one forsimplicity, though in reality it is a value of the same orderof magnitude as the other matrix entries.) In other words,the bottom right block is really not empty at all: It hasa few entries on the diagonal, one for each constrainedpressure degree of freedom, and a correct descriptionof the linear system we have to solve is that it has theform </p><p class="formulaDsp">
\begin{eqnarray*} \left(\begin{array}{cc} A &amp; B^T \\ B &amp; D_c \end{array}\right) \left(\begin{array}{cc} U \\ P \end{array}\right) = \left(\begin{array}{cc} F \\ G \end{array}\right), \end{eqnarray*}
</p>
<p> where \(D_c\) is the zero matrix with the exception of thepositive diagonal entries for the constrained degrees offreedom. The correct Schur complement would then in factbe the matrix \(S = B A^{-1} B^T - D_c \) instead of the onestated above. Thinking about this makes us, first, realize that theresulting Schur complement is now indefinite because \(B A^{-1} B^T\) is symmetric and positive definite whereas \(D_c\) is a positive semidefinite, and subtracting the latterfrom the former may no longer be positive definite. Thisis annoying because we could no longer employ the ConjugateGradient method on this true Schur complement. That said, we couldfix the issue in <a class="el" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global()</a> bysimply puttingnegative* values onto the diagonal for the constrainedpressure variables</p>
<ul>
<li>because we really only put something nonzeroto ensure that the resulting matrix is not singular; we really didn'tcare whether that entry is positive or negative. So if the entrieson the diagonal of \(D_c\) were negative, then \(S\) would again be asymmetric and positive definite matrix. But, secondly, the code below doesn't actually do any of that: Ithappily solves the linear system with the wrong Schur complement \(S = B A^{-1} B^T\) that just ignores the issue altogether. Whydoes this even work? To understand why this is so, recall thatwhen writing local contributions into the global matrix, <a class="el" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global()</a> zeros out therows and columns that correspond to constrained degrees of freedom.This means that \(B\) has some zero rows, and \(B^T\) zero columns.As a consequence, if one were to multiply out what the entriesof \(S\) are, one would realize that it has zero rows and columnsfor all constrained pressure degrees of freedom, including azero on the diagonal. The nonzero entries of \(D_c\) would fitinto exactly those zero diagonal locations, and ensure that \(S\) is invertible. Not doing so, strictly speaking, means that \(S\) remains singular: It is symmetric and positive definite on thesubset of non-constrained pressure degrees of freedom, andsimply the zero matrix on the constrained pressures. Whydoes the Conjugate Gradient method work for this matrix?Because <a class="el" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global()</a> also makes sure that the right hand side entries thatcorrespond to these zero rows of the matrix arealso* zero, i.e., the right hand side is compatible. What this means is that whatever the values of the solutionvector for these constrained pressure degrees of freedom,these rows will always have a zero residual and, if onewere to consider what the CG algorithm does internally, justnever produce any updates to the solution vector. In otherwords, the CG algorithm justignores* these rows, despite thefact that the matrix is singular. This only works because thesedegrees of freedom are entirely decoupled from the rest of thelinear system (because the entire row and corresponding columnare zero). At the end of the solution process, the constrainedpressure values in the solution vector therefore remain exactlyas they were when we started the call to the solver; they arefinally overwritten with their correct values when we call <a class="el" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">AffineConstraints::distribute()</a> after the CG solver is done. The upshot of this discussion is that the assumption that thebottom right block of the big matrix is zero is a bitsimplified, but that just going with it does not actually leadto any practical problems worth addressing.</li>
</ul>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>The domain, right hand side and boundary conditions we implement below relateto a problem in geophysics: there, one wants to compute the flow field ofmagma in the earth's interior under a mid-ocean rift. Rifts are places wheretwo continental plates are very slowly drifting apart (a few centimeters peryear at most), leaving a crack in the earth crust that is filled with magmafrom below. Without trying to be entirely realistic, we model this situationby solving the following set of equations and boundary conditions on thedomain \(\Omega=[-2,2]\times[0,1]\times[-1,0]\) : </p><p class="formulaDsp">
\begin{eqnarray*} -2\; \textrm{div}\; \varepsilon(\textbf{u}) + \nabla p &amp;=&amp; 0, \\ -\textrm{div}\; \textbf{u} &amp;=&amp; 0, \\ \mathbf u &amp;=&amp; \left(\begin{array}{c} -1 \\ 0 \\0 \end{array}\right) \qquad\qquad \textrm{at}\ z=0, x&lt;0, \\ \mathbf u &amp;=&amp; \left(\begin{array}{c} +1 \\ 0 \\0 \end{array}\right) \qquad\qquad \textrm{at}\ z=0, x&gt;0, \\ \mathbf u &amp;=&amp; \left(\begin{array}{c} 0 \\ 0 \\0 \end{array}\right) \qquad\qquad \textrm{at}\ z=0, x=0, \end{eqnarray*}
</p>
<p> and using natural boundary conditions \(\textbf{n}\cdot [p \textbf{I} - 2 \varepsilon(\textbf{u})] = 0\) everywhere else. In other words, at theleft part of the top surface we prescribe that the fluid moves with thecontinental plate to the left at speed \(-1\) , that it moves to the right on theright part of the top surface, and impose natural flow conditions everywhereelse. If we are in 2d, the description is essentially the same, with theexception that we omit the second component of all vectors stated above. As will become apparent in the <a href="#Results">results section</a>, theflow field will pull material from below and move it to the left and rightends of the domain, as expected. The discontinuity of velocity boundaryconditions will produce a singularity in the pressure at the center of the topsurface that sucks material all the way to the top surface to fill the gapleft by the outward motion of material at this location.</p>
<p><a class="anchor" id="Implementation"></a></p><h3>Implementation</h3>
<p><a class="anchor" id="UsingimhomogeneousconstraintsforimplementingDirichletboundaryconditions"></a></p><h4>Using imhomogeneous constraints for implementing Dirichlet boundary conditions</h4>
<p>In all the previous tutorial programs, we used the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object merelyfor handling hanging node constraints (with exception of <a class="el" href="step_11.html">step-11</a> ). However,the class can also be used to implement Dirichlet boundary conditions, as wewill show in this program, by fixing some node values \(x_i = b_i\) . Note thatthese are inhomogeneous constraints, and we have to pay some specialattention to that. The way we are going to implement this is to first readin the boundary values into the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object by using the call </p><div class="fragment"><div class="line"><a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a> (dof_handler,</div>
<div class="line">                                          1,</div>
<div class="line">                                          <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                          <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
</div><!-- fragment --><p>very similar to how we were making the list of boundary nodesbefore (note that we set Dirichlet conditions only on boundaries withboundary flag 1). The actual application of the boundary values is thenhandled by the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object directly, without any additionalinterference. We could then proceed as before, namely by filling the matrix, and thencalling a condense function on the constraints object of the form </p><div class="fragment"><div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a5a1bc1bb2d705b582889ebaa24bcae5c">condense</a> (system_matrix, system_rhs);</div>
</div><!-- fragment --><p>Note that we call this on the system matrix and system right hand sidesimultaneously, since resolving inhomogeneous constraints requires knowledgeabout both the matrix entries and the right hand side. For efficiencyreasons, though, we choose another strategy: all the constraints collectedin the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object can be resolved on the fly while writing local datainto the global matrix, by using the call </p><div class="fragment"><div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a> (local_matrix, local_rhs,</div>
<div class="line">                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                        system_matrix, system_rhs);</div>
</div><!-- fragment --><p>This technique is further discussed in the <a class="el" href="step_27.html">step-27</a> tutorialprogram. All we need to know here is that this functions does three thingsat once: it writes the local data into the global matrix and right handside, it distributes the hanging node constraints and additionallyimplements (inhomogeneous) Dirichlet boundary conditions. That's nice, isn'tit? We can conclude that the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class provides an alternative to using <a class="el" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a> for implementing Dirichlet boundaryconditions.</p>
<p><a class="anchor" id="constraint-matrix"></a> <a class="anchor" id="UsingAffineConstraintsforincreasingperformance"></a><a class="anchor" id="UsingAffineConstraintsforincreasingperformance"></a></p><h4>Using <a class="el" href="classAffineConstraints.html">AffineConstraints</a> for increasing performance</h4>
<h4>Using <a class="el" href="classAffineConstraints.html">AffineConstraints</a> for increasing performance</h4>
<p>Frequently, a sparse matrix contains a substantial amount of elements thatactually are zero when we are about to start a linear solve. Such elements areintroduced when we eliminate constraints or implement Dirichlet conditions,where we usually delete all entries in constrained rows and columns, i.e., weset them to zero. The fraction of elements that are present in the sparsitypattern, but do not really contain any information, can be up to one fourthof the total number of elements in the matrix for the 3D applicationconsidered in this tutorial program. Remember that matrix-vector products orpreconditioners operate on all the elements of a sparse matrix (even thosethat are zero), which is an inefficiency we will avoid here. An advantage of directly resolving constrained degrees of freedom is that wecan avoid having most of the entries that are going to be zero in our sparsematrix &mdash; we do not need constrained entries during matrix construction(as opposed to the traditional algorithms, which first fill the matrix, andonly resolve constraints afterwards). This will save both memory and timewhen forming matrix-vector products. The way we are going to do that is topass the information about constraints to the function that generates thesparsity pattern, and then set a <code>false</code> argument specifying that wedo not intend to use constrained entries: </p><div class="fragment"><div class="line"><a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a> (dof_handler, <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>,</div>
<div class="line">                                 <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
</div><!-- fragment --><p> This functions obviates, by the way, also the call to the<code>condense()</code> function on the sparsity pattern.</p>
<p><a class="anchor" id="Performanceoptimizations"></a></p><h4>Performance optimizations</h4>
<p>The program developed below has seen a lot of TLC. We have run it over andover under profiling tools (mainly <a href="http://www.valgrind.org/">valgrind</a>'s cachegrind and callgrindtools, as well as the KDE <a href="http://kcachegrind.sourceforge.net/">KCachegrind</a> program forvisualization) to see where the bottlenecks are. This has paid off: throughthis effort, the program has become about four times as fast whenconsidering the runtime of the refinement cycles zero through three,reducing the overall number of CPU instructions executed from869,574,060,348 to 199,853,005,625. For higher refinement levels, the gainis probably even larger since some algorithms that are not \({\cal O}(N)\) have been eliminated. Essentially, there are currently two algorithms in the program that do notscale linearly with the number of degrees of freedom: renumbering of degreesof freedom (which is \({\cal O}(N \log N)\) , and the linear solver (which is \({\cal O}(N^{4/3})\) ). As for the first, while reordering degrees of freedommay not scale linearly, it is an indispensable part of the overall algorithmas it greatly improves the quality of the sparse ILU, easily making up forthe time spent on computing the renumbering; graphs and timings todemonstrate this are shown in the documentation of the DoFRenumberingnamespace, also underlining the choice of the Cuthill-McKee reorderingalgorithm chosen below. As for the linear solver: as mentioned above, our implementation here uses aSchur complement formulation. This is not necessarily the very best choicebut demonstrates various important techniques available in deal.II. Thequestion of which solver is best is again discussed in the <a href="#improved-solver">section on improved solvers in the results part</a>of this program, along with code showing alternative solvers and acomparison of their results. Apart from this, many other algorithms have been tested and improved duringthe creation of this program. For example, in building the sparsity pattern,we originally used a (now no longer existing) BlockCompressedSparsityPatternobject that added one element at a time; however, its data structures were poorlyadapted for the large numbers of nonzero entries per row created by ourdiscretization in 3d, leading to a quadratic behavior. Replacing the internalalgorithms in deal.II to set many elements at a time, and using aBlockCompressedSimpleSparsityPattern (which has, as of early 2015, been in turnreplaced by <a class="el" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a>) as a better adapted data structure,removed this bottleneck at the price of a slightly higher memoryconsumption. Likewise, the implementation of the decomposition step in theSparseILU class was very inefficient and has been replaced by one that isabout 10 times faster. Even the vmult function of the <a class="el" href="classSparseILU.html">SparseILU</a> has beenimproved to save about twenty percent of time. Small improvements wereapplied here and there. Moreover, the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object has been usedto eliminate a lot of entries in the sparse matrix that are eventually goingto be zero, see <a href="#constraint-matrix">the section on using advanced features of the AffineConstraints class</a>. A profile of how many CPU instructions are spent at the variousdifferent places in the program during refinement cycleszero through three in 3d is shown here: <img src="https://www.dealii.org/images/steps/developer/step-22.profile-3.png" alt="" class="inline"/> <br  />
 As can be seen, at this refinement level approximately three quarters of theinstruction count is spent on the actual solver (the <a class="el" href="classSparseILU.html#aac1b5e5c92a75211b0c7778437408fa0">SparseILU::vmult</a> callson the left, the <a class="el" href="classSparseMatrix.html#a7706b5f721efc5ea1966f5a5cdaad0e6">SparseMatrix::vmult</a> call in the middle for the Schurcomplement solve, and another box representing the multiplications withSparseILU and <a class="el" href="classSparseMatrix.html">SparseMatrix</a> in the solve for <em>U</em>). About one fifth ofthe instruction count is spent on matrix assembly and sparse ILU computation(box in the lower right corner) and the rest on other things. Since floatingpoint operations such as in the <a class="el" href="classSparseILU.html#aac1b5e5c92a75211b0c7778437408fa0">SparseILU::vmult</a> calls typically take muchlonger than many of the logical operations and table lookups in matrixassembly, the fraction of the run time taken up by matrix assembly isactually significantly less than the fraction of instructions, as willbecome apparent in the comparison we make in the results section. For higher refinement levels, the boxes representing the solver as well asthe blue box at the top right stemming from reordering algorithm are goingto grow at the expense of the other parts of the program, since they don'tscale linearly. The fact that at this moderate refinement level (3168 cellsand 93176 degrees of freedom) the linear solver already makes up about threequarters of the instructions is a good sign that most of the algorithms usedin this program are well-tuned and that major improvements in speeding upthe program are most likely not to come from hand-optimizing individualaspects but by changing solver algorithms. We will address this point in thediscussion of results below as well. As a final point, and as a point of reference, the following picture alsoshows how the profile looked at an early stage of optimizing this program: <img src="https://www.dealii.org/images/steps/developer/step-22.profile-3.original.png" alt="" class="inline"/> <br  />
 As mentioned above, the runtime of this version was about four times as long asfor the first profile, with the <a class="el" href="classSparseILU.html">SparseILU</a> decomposition taking up about 30% ofthe instruction count, and operations an early, inefficient version ofDynamicSparsityPattern about 10%. Both these bottlenecks have since beencompletely removed.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>As usual, we start by including some well-known files:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparse__matrix_8h.html">deal.II/lac/block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
</div><!-- fragment --><p>Then we need to include the header file for the sparse direct solver UMFPACK:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
</div><!-- fragment --><p>This includes the library for the incomplete LU factorization that will be used as a preconditioner in 3D:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__ilu_8h.html">deal.II/lac/sparse_ilu.h</a>&gt;</span></div>
</div><!-- fragment --><p>This is C++:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
</div><!-- fragment --><p>As in all programs, the namespace dealii is included:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep22.html">Step22</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Definingtheinnerpreconditionertype"></a> </p><h3>Defining the inner preconditioner type</h3>
<p>As explained in the introduction, we are going to use different preconditioners for two and three space dimensions, respectively. We distinguish between them by the use of the spatial dimension as a template parameter. See <a class="el" href="step_4.html">step-4</a> for details on templates. We are not going to create any preconditioner object here, all we do is to create class that holds a local alias determining the preconditioner class so we can write our program in a dimension-independent way.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner;</div>
</div><!-- fragment --><p>In 2D, we are going to use a sparse direct solver as preconditioner:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner&lt;2&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p>And the ILU preconditioning in 3D, called by <a class="el" href="classSparseILU.html">SparseILU</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;&gt;</div>
<div class="line"><span class="keyword">struct </span>InnerPreconditioner&lt;3&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeStokesProblemcodeclasstemplate"></a> </p><h3>The <code>StokesProblem</code> class template</h3>
<p>This is an adaptation of <a class="el" href="step_20.html">step-20</a> , so the main class and the data types are nearly the same as used there. The only difference is that we have an additional member <code>preconditioner_matrix</code> , that is used for preconditioning the Schur complement, and a corresponding sparsity pattern <code>preconditioner_sparsity_pattern</code> . In addition, instead of relying on <a class="el" href="classLinearOperator.html">LinearOperator</a>, we implement our own InverseMatrix class. <br  />
 In this example we also use adaptive grid refinement, which is handled in analogy to <a class="el" href="step_6.html">step-6</a> . According to the discussion in the introduction, we are also going to use the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object for implementing Dirichlet boundary conditions. Hence, we change the name <code>hanging_node_constraints</code> into <code>constraints</code> .</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>StokesProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span> refine_mesh();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line">  <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      preconditioner_sparsity_pattern;</div>
<div class="line">  <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> system_rhs;</div>
</div><!-- fragment --><p>This one is new: We shall use a so-called shared pointer structure to access the preconditioner. Shared pointers are essentially just a convenient form of pointers. Several shared pointers can point to the same object (just like regular pointers), but when the last shared pointer object to point to a preconditioner object is deleted (for example if a shared pointer object goes out of scope, if the class of which it is a member is destroyed, or if the pointer is assigned a different preconditioner object) then the preconditioner object pointed to is also destroyed. This ensures that we don't have to manually track in how many places a preconditioner object is still referenced, it can never create a memory leak, and can never produce a dangling pointer to an already destroyed object:</p>
<div class="fragment"><div class="line">  <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">std::shared_ptr&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt; A_preconditioner;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="Boundaryvaluesandrighthandside"></a> </p><h3>Boundary values and right hand side</h3>
<p>As in <a class="el" href="step_20.html">step-20</a> and most other example programs, the next task is to define the data for the PDE: For the Stokes problem, we are going to use natural boundary values on parts of the boundary (i.e. homogeneous Neumann-type) for which we won't have to do anything special (the homogeneity implies that the corresponding terms in the weak form are simply zero), and boundary conditions on the velocity (Dirichlet-type) on the rest of the boundary, as described in the introduction. <br  />
 In order to enforce the Dirichlet boundary values on the velocity, we will use the <a class="el" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a> function as usual which requires us to write a function object with as many components as the finite element has. In other words, we have to define the function on the \((u,p)\) -space, but we are going to filter out the pressure component when interpolating the boundary values.</p>
<p>The following function object is a representation of the boundary values described in the introduction:</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keyword">class </span><a class="code" href="classBoundaryValues.html">BoundaryValues</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">   {</div>
<div class="line">   <span class="keyword">public</span>:</div>
<div class="line">     <a class="code" href="classBoundaryValues.html">BoundaryValues</a>()</div>
<div class="line">       : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1)</div>
<div class="line">     {}</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                               <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">value</a>) <span class="keyword">const override</span>;</div>
<div class="line">   };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">double</span> <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>,</div>
<div class="line">            <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, this-&gt;n_components));</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0)</div>
<div class="line">       <span class="keywordflow">return</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &lt; 0 ?</div>
<div class="line">  </div>
<div class="line">-1 : (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &gt; 0 ? 1 : 0));</div>
<div class="line">     <span class="keywordflow">return</span> 0;</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">BoundaryValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                          <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">       <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a>(p, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">   }</div>
</div><!-- fragment --><p>We implement similar functions for the right hand side which for the current example is simply zero:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span><a class="code" href="classRightHandSide.html">RightHandSide</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <a class="code" href="classRightHandSide.html">RightHandSide</a>()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">value</a>) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;  <span class="comment">/*p*/</span> ,</div>
<div class="line">                                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <span class="comment">/*component*/</span> )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">RightHandSide&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide&lt;dim&gt;::value</a>(p, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Linearsolversandpreconditioners"></a> </p><h3>Linear solvers and preconditioners</h3>
<p>The linear solvers and preconditioners are discussed extensively in the introduction. Here, we create the respective objects that will be used.</p>
<pre class="fragment">&lt;a name="ThecodeInverseMatrixcodeclasstemplate"&gt;&lt;/a&gt;  &lt;h4&gt;The &lt;code&gt;InverseMatrix&lt;/code&gt; class template&lt;/h4&gt; The   &lt;code&gt;InverseMatrix&lt;/code&gt;   class represents the data structure for an inverse matrix. Unlike   step-20  , we implement this with a class instead of the helper function inverse_linear_operator() we will apply this class to different kinds of matrices that will require different preconditioners (in   step-20   we only used a non-identity preconditioner for the mass matrix). The types of matrix and preconditioner are passed to this class via template parameters, and matrix and preconditioner objects of these types will then be passed to the constructor when an   &lt;code&gt;InverseMatrix&lt;/code&gt;   object is created. The member function   &lt;code&gt;vmult&lt;/code&gt;   is obtained by solving a linear system:
</pre><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a>         <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const PreconditionerType&gt;</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">  <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">  <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">  : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">  , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(&amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p>This is the implementation of the <code>vmult</code> function.</p>
<p>In this class we use a rather large tolerance for the solver control. The reason for this is that the function is used very frequently, and hence, any additional effort to make the residual in the CG solve smaller makes the solution more expensive. Note that we do not only use this class as a preconditioner for the Schur complement, but also when forming the inverse of the Laplace matrix &ndash; which is hence directly responsible for the accuracy of the solution itself, so we can't choose a too large tolerance, either.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(src.<a class="code" href="group__Vectors.html#ga81dcfa5c77bdd426603386c0844149ae">size</a>(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 src.<a class="code" href="classVector.html#a8ee1b8309a7a9ecf109c8a7116733ef8">l2_norm</a>());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">  cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src,<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeSchurComplementcodeclasstemplate"></a> </p><h4>The <code>SchurComplement</code> class template</h4>
<p>This class implements the Schur complement discussed in the introduction. It is in analogy to <a class="el" href="step_20.html">step-20</a> . Though, we now call it with a template parameter <code>PreconditionerType</code> in order to access that when specifying the respective type of the inverse matrix class. As a consequence of the definition above, the declaration <code>InverseMatrix</code> now contains the second template parameter for a preconditioner class as above, which affects the <code><a class="el" href="classSmartPointer.html">SmartPointer</a></code> object <code>m_inverse</code> as well.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keyword">class </span>SchurComplement : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SchurComplement(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> &amp;system_matrix,</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>, PreconditionerType&gt; &amp;A_inverse);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const BlockSparseMatrix&lt;double&gt;</a>&gt; system_matrix;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;SparseMatrix&lt;double&gt;, PreconditionerType&gt;&gt;</div>
<div class="line">    A_inverse;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">mutable</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp1, tmp2;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">SchurComplement&lt;PreconditionerType&gt;::SchurComplement(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> &amp;system_matrix,</div>
<div class="line">  <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>, PreconditionerType&gt; &amp;A_inverse)</div>
<div class="line">  : system_matrix(&amp;system_matrix)</div>
<div class="line">  , A_inverse(&amp;A_inverse)</div>
<div class="line">  , tmp1(system_matrix.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(0, 0).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">  , tmp2(system_matrix.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(0, 0).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line"><a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">SchurComplement&lt;PreconditionerType&gt;::vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                                           <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  system_matrix-&gt;block(0, 1).<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(tmp1, src);</div>
<div class="line">  A_inverse-&gt;vmult(tmp2, tmp1);</div>
<div class="line">  system_matrix-&gt;block(1, 0).vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, tmp2);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemclassimplementation"></a> </p><h3>StokesProblem class implementation</h3>
<pre class="fragment">&lt;a name="StokesProblemStokesProblem"&gt;&lt;/a&gt;  &lt;h4&gt;StokesProblem::StokesProblem&lt;/h4&gt;
</pre><p>The constructor of this class looks very similar to the one of <a class="el" href="step_20.html">step-20</a> . The constructor initializes the variables for the polynomial degree, triangulation, finite element system and the dof handler. The underlying polynomial functions are of order <code>degree+1</code> for the vector-valued velocity components and of order <code>degree</code> for the pressure. This gives the LBB-stable element pair \(Q_{degree+1}^d\times Q_{degree}\) , often referred to as the Taylor-Hood element. <br  />
 Note that we initialize the triangulation with a MeshSmoothing argument, which ensures that the refinement of cells is done in a way that the approximation of the PDE solution remains well-behaved (problems arise if grids are too unstructured), see the documentation of <code><a class="el" href="classTriangulation.html#a0633dd17e535a59162b79f338c6ff5ae">Triangulation::MeshSmoothing</a></code> for details.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">StokesProblem&lt;dim&gt;::StokesProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  : <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  , <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">  , <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>), 1)</div>
<div class="line">  , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemsetup_dofs"></a> </p><h4>StokesProblem::setup_dofs</h4>
<p>Given a mesh, this function associates the degrees of freedom with it and creates the corresponding matrices and vectors. At the beginning it also releases the pointer to the preconditioner object (if the shared pointer pointed at anything at all at this point) since it will definitely not be needed any more after this point and will have to be re-computed after assembling the matrix, and unties the sparse matrices from their sparsity pattern objects. <br  />
 We then proceed with distributing degrees of freedom and renumbering them: In order to make the ILU preconditioner (in 3D) work efficiently, it is important to enumerate the degrees of freedom in such a way that it reduces the bandwidth of the matrix, or maybe more importantly: in such a way that the ILU is as close as possible to a real LU decomposition. On the other hand, we need to preserve the block structure of velocity and pressure already seen in <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a> . This is done in two steps: First, all dofs are renumbered to improve the ILU and then we renumber once again by components. Since <code><a class="el" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a></code> does not touch the renumbering within the individual blocks, the basic renumbering from the first step remains. As for how the renumber degrees of freedom to improve the ILU: deal.II has a number of algorithms that attempt to find orderings to improve ILUs, or reduce the bandwidth of matrices, or optimize some other aspect. The <a class="el" href="namespaceDoFRenumbering.html">DoFRenumbering</a> namespace shows a comparison of the results we obtain with several of these algorithms based on the testcase discussed here in this tutorial program. Here, we will use the traditional Cuthill-McKee algorithm already used in some of the previous tutorial programs. In the <a href="#improved-ilu">section on improved ILU</a> we're going to discuss this issue in more detail.</p>
<p>There is one more change compared to previous tutorial programs: There is no reason in sorting the <code>dim</code> velocity components individually. In fact, rather than first enumerating all \(x\) -velocities, then all \(y\) -velocities, etc, we would like to keep all velocities at the same location together and only separate between velocities (all components) and pressures. By default, this is not what the <a class="el" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a> function does: it treats each vector component separately; what we have to do is group several components into "blocks" and pass this block structure to that function. Consequently, we allocate a vector <code>block_component</code> with as many elements as there are components and describe all velocity components to correspond to block 0, while the pressure component will form block 1:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  A_preconditioner.reset();</div>
<div class="line">  system_matrix.clear();</div>
<div class="line">  preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">  dof_handler.distribute_dofs(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;unsigned int&gt; block_component(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">  block_component[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">  <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div>
</div><!-- fragment --><p>Now comes the implementation of Dirichlet boundary conditions, which should be evident after the discussion in the introduction. All that changed is that the function already appears in the setup functions, whereas we were used to see it in some assembly routine. Further down below where we set up the mesh, we will associate the top boundary where we impose Dirichlet boundary conditions with boundary indicator 1. We will have to pass this boundary indicator as second argument to the function below interpolating boundary values. There is one more thing, though. The function describing the Dirichlet conditions was defined for all components, both velocity and pressure. However, the Dirichlet conditions are to be set for the velocity only. To this end, we use a <a class="el" href="classComponentMask.html">ComponentMask</a> that only selects the velocity components. The component mask is obtained from the finite element by specifying the particular components we want. Since we use adaptively refined grids, the affine constraints object needs to be first filled with hanging node constraints generated from the DoF handler. Note the order of the two functions &mdash; we first compute the hanging node constraints, and then insert the boundary values into the constraints object. This makes sure that we respect H<sup>1</sup> conformity on boundaries with hanging nodes (in three space dimensions), where the hanging node needs to dominate the Dirichlet boundary values.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           1,</div>
<div class="line">                                           <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                           <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                           <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
</div><!-- fragment --><p>In analogy to <a class="el" href="step_20.html">step-20</a> , we count the dofs in the individual components. We could do this in the same way as there, but we want to operate on the block structure we used already for the renumbering: The function <code><a class="el" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a></code> does the same as <code><a class="el" href="namespaceDoFTools.html#a956ac5c6aab03ec1c04f1ad955301db9">DoFTools::count_dofs_per_fe_component</a></code> , but now grouped as velocity and pressure block via <code>block_component</code> .</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">          &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>The next task is to allocate a sparsity pattern for the system matrix we will create and one for the preconditioner matrix. We could do this in the same way as in <a class="el" href="step_20.html">step-20</a> , i.e. directly build an object of type <a class="el" href="classSparsityPattern.html">SparsityPattern</a> through <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>. However, there is a major reason not to do so: In 3D, the function DoFTools::max_couplings_between_dofs yields a conservative but rather large number for the coupling between the individual dofs, so that the memory initially provided for the creation of the sparsity pattern of the matrix is far too much</p>
<ul>
<li>so much actually that the initial sparsity pattern won't even fit into the physical memory of most systems already for moderately-sized 3D problems, see also the discussion in <a class="el" href="step_18.html">step-18</a> . Instead, we first build temporary objects that use a different data structure that doesn't require allocating more memory than necessary but isn't suitable for use as a basis of <a class="el" href="classSparseMatrix.html">SparseMatrix</a> or <a class="el" href="classBlockSparseMatrix.html">BlockSparseMatrix</a> objects; in a second step we then copy these objects into objects of type <a class="el" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>. This is entirely analogous to what we already did in <a class="el" href="step_11.html">step-11</a> and <a class="el" href="step_18.html">step-18</a> . In particular, we make use of the fact that we will never write into the \((1,1)\) block of the system matrix and that this is the only block to be filled for the preconditioner matrix. <br  />
 All this is done inside new scopes, which means that the memory of <code>dsp</code> will be released once the information has been copied to <code>sparsity_pattern</code> .</li>
</ul>
<div class="fragment"><div class="line">{</div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">  dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">  dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">  dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">  dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">  dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">    dof_handler, coupling, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> preconditioner_dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">  preconditioner_dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">  preconditioner_dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">  preconditioner_dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">  preconditioner_dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">  preconditioner_dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">        preconditioner_coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        preconditioner_coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                  preconditioner_coupling,</div>
<div class="line">                                  preconditioner_dsp,</div>
<div class="line">                                  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                  <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  preconditioner_sparsity_pattern.copy_from(preconditioner_dsp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Finally, the system matrix, the preconsitioner matrix, the solution and the right hand side vector are created from the block structure similar to the approach in <a class="el" href="step_20.html">step-20</a> :</p>
<div class="fragment"><div class="line">  system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line">  preconditioner_matrix.reinit(preconditioner_sparsity_pattern);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(2);</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0).reinit(n_u);</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).reinit(n_p);</div>
<div class="line">  <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  system_rhs.reinit(2);</div>
<div class="line">  system_rhs.block(0).reinit(n_u);</div>
<div class="line">  system_rhs.block(1).reinit(n_p);</div>
<div class="line">  system_rhs.collect_sizes();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemassemble_system"></a> </p><h4>StokesProblem::assemble_system</h4>
<p>The assembly process follows the discussion in <a class="el" href="step_20.html">step-20</a> and in the introduction. We use the well-known abbreviations for the data structures that hold the local matrices, right hand side, and global numbering of the degrees of freedom for the present cell.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::assemble_system()</div>
<div class="line">{</div>
<div class="line">  system_matrix         = 0;</div>
<div class="line">  system_rhs            = 0;</div>
<div class="line">  preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 2);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_preconditioner_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>,</div>
<div class="line">                                                 <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classRightHandSide.html">RightHandSide&lt;dim&gt;</a>    <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>;</div>
<div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
</div><!-- fragment --><p>Next, we need two objects that work as extractors for the <a class="el" href="classFEValues.html">FEValues</a> object. Their use is explained in detail in the report on <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> :</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
</div><!-- fragment --><p>As an extension over <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a> , we include a few optimizations that make assembly much faster for this particular problem. The improvements are based on the observation that we do a few calculations too many times when we do as in <a class="el" href="step_20.html">step-20</a> : The symmetric gradient actually has <code>dofs_per_cell</code> different values per quadrature point, but we extract it <code>dofs_per_cell*dofs_per_cell</code> times from the <a class="el" href="classFEValues.html">FEValues</a> object</p>
<ul>
<li>for both the loop over <code>i</code> and the inner loop over <code>j</code> . In 3d, that means evaluating it \(89^2=7921\) instead of \(89\) times, a not insignificant difference. <br  />
 So what we're going to do here is to avoid such repeated calculations by getting a vector of rank-2 tensors (and similarly for the divergence and the basis function value on pressure) at the quadrature point prior to starting the loop over the dofs on the cell. First, we create the respective objects that will hold these values. Then, we start the loop over all cells and the loop over the quadrature points, where we first extract these values. There is one more optimization we implement here: the local matrix (as well as the global one) is going to be symmetric, since all the operations involved are symmetric with respect to \(i\) and \(j\) . This is implemented by simply running the inner loop not to <code>dofs_per_cell</code>, but only up to <code>i</code> , the index of the outer loop.</li>
</ul>
<div class="fragment"><div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; symgrad_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;                  div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;                  phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">  {</div>
<div class="line">    fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">    local_matrix                = 0;</div>
<div class="line">    local_preconditioner_matrix = 0;</div>
<div class="line">    local_rhs                   = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>.vector_value_list(fe_values.get_quadrature_points(),</div>
<div class="line">                                      rhs_values);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">          {</div>
<div class="line">            symgrad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">              fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">          }</div>
</div><!-- fragment --><p>Now finally for the bilinear forms of both the system matrix and the matrix we use for the preconditioner. Recall that the formulas for these two are</p>
<p class="formulaDsp">
\begin{align*} A_{ij} &amp;= a(\varphi_i,\varphi_j) \\ &amp;= \underbrace{2(\varepsilon(\varphi_{i,\textbf{u}}), \varepsilon(\varphi_{j,\textbf{u}}))_{\Omega}} _{(1)} \; \underbrace{- (\textrm{div}\; \varphi_{i,\textbf{u}}, \varphi_{j,p})_{\Omega}} _{(2)} \; \underbrace{- (\varphi_{i,p}, \textrm{div}\; \varphi_{j,\textbf{u}})_{\Omega}} _{(3)} \end{align*}
</p>
<p> and</p>
<p class="formulaDsp">
\begin{align*} M_{ij} &amp;= \underbrace{(\varphi_{i,p}, \varphi_{j,p})_{\Omega}} _{(4)}, \end{align*}
</p>
<p> respectively, where \(\varphi_{i,\textbf{u}}\) and \(\varphi_{i,p}\) are the velocity and pressure components of the \(i\) th shape function. The various terms above are then easily recognized in the following implementation:</p>
<div class="fragment"><div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">               {</div>
<div class="line">                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt;= <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                   {</div>
<div class="line">                     local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                       (2 (symgrad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] symgrad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) <span class="comment">// (1)</span></div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">- div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]                 <span class="comment">// (2)</span></div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">- phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])                <span class="comment">// (3)</span></div>
<div class="line">                       fe_values.JxW(q);                        <span class="comment">// dx</span></div>
<div class="line">  </div>
<div class="line">                     local_preconditioner_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                       (phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) <span class="comment">// (4)</span></div>
<div class="line">                       fe_values.JxW(q);   <span class="comment">// dx</span></div>
<div class="line">                   }</div>
</div><!-- fragment --><p>Note that in the implementation of (1) above, <code>operator*</code> is overloaded for symmetric tensors, yielding the scalar product between the two tensors. <br  />
 For the right-hand side we use the fact that the shape functions are only non-zero in one component (because our elements are primitive). Instead of multiplying the tensor representing the dim+1 values of shape function i with the whole right-hand side vector, we only look at the only non-zero component. The function <a class="el" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">FiniteElement::system_to_component_index</a> will return which component this shape function lives in (0=x velocity, 1=y velocity, 2=pressure in 2d), which we use to pick out the correct component of the right-hand side vector to multiply with.</p>
<div class="fragment"><div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div>
<div class="line">        <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first;</div>
<div class="line">      local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q)   <span class="comment">// (phi_u_i(x_q)</span></div>
<div class="line">                       rhs_values[q](component_i)) <span class="comment">// f(x_q))</span></div>
<div class="line">                      fe_values.JxW(q);            <span class="comment">// dx</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Before we can write the local data into the global matrix (and simultaneously use the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object to apply Dirichlet boundary conditions and eliminate hanging node constraints, as we discussed in the introduction), we have to be careful about one thing, though. We have only built half of the local matrices because of symmetry, but we're going to save the full matrices in order to use the standard functions for solving. This is done by flipping the indices in case we are pointing into the empty part of the local matrices.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> + 1; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">      {</div>
<div class="line">        local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = local_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">        local_preconditioner_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) =</div>
<div class="line">          local_preconditioner_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(local_matrix,</div>
<div class="line">                                         local_rhs,</div>
<div class="line">                                         <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                         system_matrix,</div>
<div class="line">                                         system_rhs);</div>
<div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(local_preconditioner_matrix,</div>
<div class="line">                                         <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                         preconditioner_matrix);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Before we're going to solve this linear system, we generate a preconditioner for the velocity-velocity matrix, i.e., <code>block(0,0)</code> in the system matrix. As mentioned above, this depends on the spatial dimension. Since the two classes described by the <code>InnerPreconditioner::type</code> alias have the same interface, we do not have to do anything different whether we want to use a sparse direct solver or an ILU:</p>
<div class="fragment"><div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Computing preconditioner...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">  A_preconditioner =</div>
<div class="line">    <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">std::make_shared&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt;();</div>
<div class="line">  A_preconditioner-&gt;initialize(</div>
<div class="line">    system_matrix.block(0, 0),</div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="relaxation__block__0_8txt.html#a2076fd56276055e74e230fad6edac013">InnerPreconditioner&lt;dim&gt;::type::AdditionalData</a>());</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemsolve"></a> </p><h4>StokesProblem::solve</h4>
<p>After the discussion in the introduction and the definition of the respective classes above, the implementation of the <code>solve</code> function is rather straight-forward and done in a similar way as in <a class="el" href="step_20.html">step-20</a> . To start with, we need an object of the <code>InverseMatrix</code> class that represents the inverse of the matrix A. As described in the introduction, the inverse is generated with the help of an inner preconditioner of type <code>InnerPreconditioner::type</code> .</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">StokesProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> InverseMatrix&lt;SparseMatrix&lt;double&gt;,</div>
<div class="line">                      <span class="keyword">typename</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">InnerPreconditioner&lt;dim&gt;::type</a>&gt;</div>
<div class="line">                 A_inverse(system_matrix.block(0, 0),A_preconditioner);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0).size());</div>
</div><!-- fragment --><p>This is as in <a class="el" href="step_20.html">step-20</a> . We generate the right hand side \(B A^{-1} F - G\) for the Schur complement and an object that represents the respective linear operation \(B A^{-1} B^T\) , now with a template parameter indicating the preconditioner</p>
<ul>
<li>in accordance with the definition of the class.</li>
</ul>
<div class="fragment"><div class="line">     {</div>
<div class="line">       <a class="code" href="classVector.html">Vector&lt;double&gt;</a> schur_rhs(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).size());</div>
<div class="line">       A_inverse.vmult(tmp, system_rhs.block(0));</div>
<div class="line">       system_matrix.block(1, 0).vmult(schur_rhs, tmp);</div>
<div class="line">       schur_rhs</div>
<div class="line">  </div>
<div class="line">-= system_rhs.block(1);</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">SchurComplement&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt; <a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>(</div>
<div class="line">         system_matrix, A_inverse);</div>
</div><!-- fragment --><p>The usual control structures for the solver call are created...</p>
<div class="fragment"><div class="line"><a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).size(),</div>
<div class="line">                             1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 schur_rhs.l2_norm());</div>
<div class="line"><a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
</div><!-- fragment --><p>Now to the preconditioner to the Schur complement. As explained in the introduction, the preconditioning is done by a mass matrix in the pressure variable. <br  />
 Actually, the solver needs to have the preconditioner in the form \(P^{-1}\) , so we need to create an inverse operation. Once again, we use an object of the class <code>InverseMatrix</code> , which implements the <code>vmult</code> operation that is needed by the solver. In this case, we have to invert the pressure mass matrix. As it already turned out in earlier tutorial programs, the inversion of a mass matrix is a rather cheap and straight-forward operation (compared to, e.g., a Laplace matrix). The CG method with ILU preconditioning converges in 5-10 steps, independently on the mesh size. This is precisely what we do here: We choose another ILU preconditioner and take it along to the InverseMatrix object via the corresponding template parameter. A CG solver is then called within the vmult operation of the inverse matrix. <br  />
 An alternative that is cheaper to build, but needs more iterations afterwards, would be to choose a SSOR preconditioner with factor 1.2. It needs about twice the number of iterations, but the costs for its generation are almost negligible.</p>
<div class="fragment"><div class="line"><a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line"><a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(preconditioner_matrix.block(1, 1),</div>
<div class="line">                          <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;::AdditionalData</a>());</div>
<div class="line"> </div>
<div class="line">InverseMatrix&lt;SparseMatrix&lt;double&gt;, <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>&gt; m_inverse(</div>
<div class="line">  preconditioner_matrix.block(1, 1), <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
</div><!-- fragment --><p>With the Schur complement and an efficient preconditioner at hand, we can solve the respective equation for the pressure (i.e. block 0 in the solution vector) in the usual way:</p>
<div class="fragment"><div class="line">cg.solve(<a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1), schur_rhs, m_inverse);</div>
</div><!-- fragment --><p>After this first solution step, the hanging node constraints have to be distributed to the solution in order to achieve a consistent pressure field.</p>
<div class="fragment"><div class="line">  <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; outer CG Schur complement iterations for pressure&quot;</span></div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">}</div>
</div><!-- fragment --><p>As in <a class="el" href="step_20.html">step-20</a> , we finally need to solve for the velocity equation where we plug in the solution to the pressure equation. This involves only objects we already know</p>
<ul>
<li>so we simply multiply \(p\) by \(B^T\) , subtract the right hand side and multiply by the inverse of \(A\) . At the end, we need to distribute the constraints from hanging nodes in order to obtain a consistent flow field:</li>
</ul>
<div class="fragment"><div class="line">     {</div>
<div class="line">       system_matrix.block(0, 1).vmult(tmp, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1));</div>
<div class="line">       tmp=</div>
<div class="line">  </div>
<div class="line">-1;</div>
<div class="line">       tmp += system_rhs.block(0);</div>
<div class="line">  </div>
<div class="line">       A_inverse.vmult(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0), tmp);</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">     }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemoutput_results"></a> </p><h4>StokesProblem::output_results</h4>
<p>The next function generates graphical output. In this example, we are going to use the VTK file format. We attach names to the individual variables in the problem: <code>velocity</code> to the <code>dim</code> components of velocity and <code>pressure</code> to the pressure. <br  />
 Not all visualization programs have the ability to group individual vector components into a vector to provide vector plots; in particular, this holds for some VTK-based visualization programs. In this case, the logical grouping of components into vectors should already be described in the file containing the data. In other words, what we need to do is provide our output writers with a way to know which of the components of the finite element logically form a vector (with \(d\) components in \(d\) space dimensions) rather than letting them assume that we simply have a bunch of scalar fields. This is achieved using the members of the <code><a class="el" href="namespaceDataComponentInterpretation.html">DataComponentInterpretation</a></code> namespace: as with the filename, we create a vector in which the first <code>dim</code> components refer to the velocities and are given the tag <a class="el" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>; we finally push one tag <a class="el" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a> to describe the grouping of the pressure variable.</p>
<p>The rest of the function is then the same as in <a class="el" href="step_20.html">step-20</a> .</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">StokesProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;std::string&gt; solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    data_component_interpretation(</div>
<div class="line">      <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">                           solution_names,</div>
<div class="line">                           <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                           data_component_interpretation);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(</div>
<div class="line">    <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(refinement_cycle, 2) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemrefine_mesh"></a> </p><h4>StokesProblem::refine_mesh</h4>
<p>This is the last interesting function of the <code>StokesProblem</code> class. As indicated by its name, it takes the solution to the problem and refines the mesh where this is needed. The procedure is the same as in the respective step in <a class="el" href="step_6.html">step-6</a> , with the exception that we base the refinement only on the change in pressure, i.e., we call the Kelly error estimator with a mask object of type <a class="el" href="classComponentMask.html">ComponentMask</a> that selects the single scalar component for the pressure that we are interested in (we get such a mask from the finite element class by specifying the component we want). Additionally, we do not coarsen the grid again:</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> StokesProblem&lt;dim&gt;::refine_mesh()</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">     <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">       dof_handler,</div>
<div class="line">       <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1),</div>
<div class="line">       <a class="code" href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">std::map</a>&lt;<a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a>&gt;(),</div>
<div class="line">       <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">       estimated_error_per_cell,</div>
<div class="line">       <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>));</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                     estimated_error_per_cell,</div>
<div class="line">                                                     0.3,</div>
<div class="line">                                                     0.0);</div>
<div class="line">     <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="StokesProblemrun"></a> </p><h4>StokesProblem::run</h4>
<p>The last step in the Stokes class is, as usual, the function that generates the initial grid and calls the other functions in the respective order. <br  />
 We start off with a rectangle of size \(4 \times 1\) (in 2d) or \(4 \times 1 \times 1\) (in 3d), placed in \(R^2/R^3\) as \((-2,2)\times(-1,0)\) or \((-2,2)\times(0,1)\times(-1,0)\) , respectively. It is natural to start with equal mesh size in each direction, so we subdivide the initial rectangle four times in the first coordinate direction. To limit the scope of the variables involved in the creation of the mesh to the range where we actually need them, we put the entire block between a pair of braces:</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">StokesProblem&lt;dim&gt;::run</a>()</div>
<div class="line">   {</div>
<div class="line">     {</div>
<div class="line">       std::vector&lt;unsigned int&gt; <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, 1);</div>
<div class="line">       <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>[0] = 4;</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> bottom_left = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?                </div>
<div class="line">                                         <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2,</div>
<div class="line">  </div>
<div class="line">-1) :    <span class="comment">// 2d case</span></div>
<div class="line">                                         <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(-2, 0,</div>
<div class="line">  </div>
<div class="line">-1)); <span class="comment">// 3d case</span></div>
<div class="line">  </div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> top_right = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?              </div>
<div class="line">                                       <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(2, 0) :    <span class="comment">// 2d case</span></div>
<div class="line">                                       <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(2, 1, 0)); <span class="comment">// 3d case</span></div>
<div class="line">  </div>
<div class="line">       <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                 <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>,</div>
<div class="line">                                                 bottom_left,</div>
<div class="line">                                                 top_right);</div>
<div class="line">     }</div>
</div><!-- fragment --><p>A boundary indicator of 1 is set to all boundaries that are subject to Dirichlet boundary conditions, i.e. to faces that are located at 0 in the last coordinate direction. See the example description above for details.</p>
<div class="fragment"><div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">         <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1] == 0)</div>
<div class="line">           <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_all_boundary_ids(1);</div>
</div><!-- fragment --><p>We then apply an initial refinement before solving for the first time. In 3D, there are going to be more degrees of freedom, so we refine less there:</p>
<div class="fragment"><div class="line">     <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(4</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
</div><!-- fragment --><p>As first seen in <a class="el" href="step_6.html">step-6</a> , we cycle over the different refinement levels and refine (except for the first cycle), setup the degrees of freedom and matrices, assemble, solve and create output:</p>
<div class="fragment"><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 6;</div>
<div class="line">         ++refinement_cycle)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div>
<div class="line">          refine_mesh();</div>
<div class="line"> </div>
<div class="line">        setup_dofs();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        output_results(refinement_cycle);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step22</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>The main function is the same as in <a class="el" href="step_20.html">step-20</a> . We pass the element degree as a parameter and choose the space dimension at the well-known template slot.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep22.html">Step22</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;2&gt;</a> flow_problem(1);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="Outputoftheprogramandgraphicalvisualization"></a></p><h3>Output of the program and graphical visualization</h3>
<p><a class="anchor" id="2Dcalculations"></a></p><h4>2D calculations</h4>
<p>Running the program with the space dimension set to 2 in the <code>main</code> function yields the following output (in "release mode", See also <a href="http://www.math.colostate.edu/~bangerth/videos.676.18.html">video lecture 18</a>.): <br  />
 </p><div class="fragment"><div class="line"><a class="code" href="work__stream__0_8txt.html#a2252e3964ca906e132dfb7ffa15c79b8">examples</a>/<a class="code" href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a>-22&gt; make <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 0</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 64</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 679 (594+85)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 1</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 160</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1683 (1482+201)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 2</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 376</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 3813 (3370+443)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 3</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 880</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 8723 (7722+1001)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 4</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 2008</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 19383 (17186+2197)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 5</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 4288</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 40855 (36250+4605)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  11 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div>
</div><!-- fragment --><p>The entire computation above takes about 2 seconds on a reasonablyquick (for 2015 standards) machine. What we see immediately from this is that the number of (outer)iterations does not increase as we refine the mesh. This confirms thestatement in the introduction that preconditioning the Schurcomplement with the mass matrix indeed yields a matrix spectrallyequivalent to the identity matrix (i.e. with eigenvalues bounded aboveand below independently of the mesh size or the relative sizes ofcells). In other words, the mass matrix and the Schur complement arespectrally equivalent. In the images below, we show the grids for the first six refinementsteps in the program. Observe how the grid is refined in regionswhere the solution rapidly changes: On the upper boundary, we haveDirichlet boundary conditions that are</p>
<ul>
<li>in the left half of the lineand 1 in the right one, so there is an abrupt change at \(x=0\) . Likewise,there are changes from Dirichlet to Neumann data in the two uppercorners, so there is need for refinement there as well: <table width="60%" align="center">
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-0.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-1.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-2.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-3.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-4.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.2d.mesh-5.png" alt="" class="inline"/>   </td></tr>
</table>
<br  />
 Finally, following is a plot of the flow field. It shows fluidtransported along with the moving upper boundary and being replaced bymaterial coming from below: <img src="https://www.dealii.org/images/steps/developer/step-22.2d.solution.png" alt="" class="inline"/> <br  />
 This plot uses the capability of VTK-based visualization programs (inthis case of VisIt) to show vector data; this is the result of usdeclaring the velocity components of the finite element in use to be aset of vector components, rather than independent scalar components inthe <code>StokesProblem&lt;dim&gt;::output_results</code> function of thistutorial program.</li>
</ul>
<p><a class="anchor" id="3Dcalculations"></a></p><h4>3D calculations</h4>
<p>In 3d, the screen output of the program looks like this: </p><div class="fragment"><div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 0</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 32</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1356 (1275+81)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  13 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 1</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 144</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 5088 (4827+261)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  14 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 2</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 704</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 22406 (21351+1055)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  14 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 3</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 3168</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 93176 (89043+4133)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  15 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 4</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 11456</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 327808 (313659+14149)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  15 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 5</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 45056</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1254464 (1201371+53093)</div>
<div class="line">   Assembling...</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>...</div>
<div class="line">   Solving...  14 outer CG Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a> <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>.</div>
</div><!-- fragment --><p>Again, we see that the number of outer iterations does not increase aswe refine the mesh. Nevertheless, the compute time increasessignificantly: for each of the iterations above separately, it takes about0.14 seconds, 0.63 seconds, 4.8 seconds, 35 seconds, 2 minutes and 33 seconds,and 13 minutes and 12 seconds. This overall superlinear (in the number ofunknowns) increase in runtime is due to the fact that our inner solver is not \({\cal O}(N)\) : a simple experiment shows that as we keep refining the mesh, theaverage number of ILU-preconditioned CG iterations to invert thevelocity-velocity block \(A\) increases. We will address the question of how possibly to improve our solver <a href="#improved-solver">below</a>. As for the graphical output, the grids generated during the solutionlook as follow: </p><table width="60%" align="center">
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-0.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-1.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-2.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-3.png" alt="" class="inline"/>   </td></tr>
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-4.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d.mesh-5.png" alt="" class="inline"/>   </td></tr>
</table>
<p><br  />
 Again, they show essentially the location of singularities introducedby boundary conditions. The vector field computed makes for aninteresting graph: <img src="https://www.dealii.org/images/steps/developer/step-22.3d.solution.png" alt="" class="inline"/> <br  />
 The isocontours shown here as well are those of the pressurevariable, showing the singularity at the point of discontinuousvelocity boundary conditions.</p>
<p><a class="anchor" id="Sparsitypattern"></a></p><h3>Sparsity pattern</h3>
<p>As explained during the generation of the sparsity pattern, it isimportant to have the numbering of degrees of freedom in mind whenusing preconditioners like incomplete LU decompositions. This is mostconveniently visualized using the distribution of nonzero elements inthe stiffness matrix. If we don't do anything special to renumber degrees of freedom (i.e.,without using <a class="el" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>, but with using <a class="el" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a> to ensure that degrees of freedom areappropriately sorted into their corresponding blocks of the matrix andvector), then we get the following image after the first adaptiverefinement in two dimensions: <img src="https://www.dealii.org/images/steps/developer/step-22.2d.sparsity-nor.png" alt="" class="inline"/> <br  />
 In order to generate such a graph, you have to insert a piece ofcode like the following to the end of the setup step. </p><div class="fragment"><div class="line">{</div>
<div class="line">  std::ofstream <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a> (<span class="stringliteral">&quot;sparsity_pattern.gpl&quot;</span>);</div>
<div class="line">  <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.print_gnuplot(<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>It is clearly visible that the nonzero entries are spread over almost thewhole matrix. This makes preconditioning by ILU inefficient: ILU generates aGaussian elimination (LU decomposition) without fill-in elements, which meansthat more tentative fill-ins left out will result in a worse approximation ofthe complete decomposition. In this program, we have thus chosen a more advanced renumbering ofcomponents. The renumbering with <a class="el" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a> and groupingthe components into velocity and pressure yields the following output: <img src="https://www.dealii.org/images/steps/developer/step-22.2d.sparsity-ren.png" alt="" class="inline"/> <br  />
 It is apparent that the situation has improved a lot. Most of the elements arenow concentrated around the diagonal in the (0,0) block in the matrix. Similareffects are also visible for the other blocks. In this case, the ILUdecomposition will be much closer to the full LU decomposition, which improvesthe quality of the preconditioner. (It may be interesting to note that thesparse direct solver UMFPACK does some internal renumbering of the equationsbefore actually generating a sparse LU decomposition; that procedure leads toa very similar pattern to the one we got from the Cuthill-McKee algorithm.) Finally, we want to have a closerlook at a sparsity pattern in 3D. We show only the (0,0) block of thematrix, again after one adaptive refinement. Apart from the fact that the matrixsize has increased, it is also visible that there are many more entriesin the matrix. Moreover, even for the optimized renumbering, there will be aconsiderable amount of tentative fill-in elements. This illustrates why UMFPACKis not a good choice in 3D</p>
<ul>
<li>a full decomposition needs many new entries that eventually won't fit into the physical memory (RAM): <img src="https://www.dealii.org/images/steps/developer/step-22.3d.sparsity_uu-ren.png" alt="" class="inline"/> <br  />
</li>
</ul>
<p><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p><a class="anchor" id="improved-solver"></a> <a class="anchor" id="Improvedlinearsolverin3D"></a><a class="anchor" id="Improvedlinearsolverin3D"></a></p><h4>Improved linear solver in 3D</h4>
<h4>Improved linear solver in 3D</h4>
<p>We have seen in the section of computational results that the number of outeriterations does not depend on the mesh size, which is optimal in a sense ofscalability. This does, however, not apply to the solver as a whole, asmentioned above:We did not look at the number of inner iterations when generating the inverse ofthe matrix \(A\) and the mass matrix \(M_p\) . Of course, this is unproblematic inthe 2D case where we precondition \(A\) with a direct solver and the <code>vmult</code> operation of the inverse matrix structure will converge inone single CG step, but this changes in 3D where we only use an ILUpreconditioner. There, the number of required preconditioned CG steps toinvert \(A\) increases as the mesh is refined, and each <code>vmult</code> operation involves on average approximately 14, 23, 36, 59, 75 and 101 innerCG iterations in the refinement steps shown above. (On the other hand,the number of iterations for applying the inverse pressure mass matrix isalways around five, both in two and three dimensions.) To summarize, most workis spent on solving linear systems with the same matrix \(A\) over and over again.What makes this look even worse is the fact that weactually invert a matrix that is about 95 percent the size of the total systemmatrix and stands for 85 percent of the non-zero entries in the sparsitypattern. Hence, the natural question is whether it is reasonable to solve alinear system with matrix \(A\) for about 15 times when calculating the solutionto the block system. The answer is, of course, that we can do that in a few other (most of the timebetter) ways.Nevertheless, it has to be remarked that an indefinite system as the oneat hand puts indeed much higherdemands on the linear algebra than standard elliptic problems as we have seenin the early tutorial programs. The improvements are still ratherunsatisfactory, if one compares with an elliptic problem of similarsize. Either way, we will introduce below a number of improvements to thelinear solver, a discussion that we will re-consider again with additionaloptions in the <a class="el" href="step_31.html">step-31</a> program. <a class="anchor" id="improved-ilu"></a> <a class="anchor" id="BetterILUdecompositionbysmartreordering"></a><a class="anchor" id="BetterILUdecompositionbysmartreordering"></a></p><h5>Better ILU decomposition by smart reordering</h5>
<h5>Better ILU decomposition by smart reordering</h5>
<p>A first attempt to improve the speed of the linear solution process is to choosea dof reordering that makes the ILU being closer to a full LU decomposition, asalready mentioned in the in-code comments. The <a class="el" href="namespaceDoFRenumbering.html">DoFRenumbering</a> namespace comparesseveral choices for the renumbering of dofs for the Stokes equations. The bestresult regarding the computing time was found for the King ordering, which isaccessed through the call <a class="el" href="namespaceDoFRenumbering_1_1boost.html#a76fd1dc3212aeeca4294c358248e46d5">DoFRenumbering::boost::king_ordering</a>. With thatprogram, the inner solver needs considerably less operations, e.g. about 62inner CG iterations for the inversion of \(A\) at cycle 4 compared to about 75iterations with the standard Cuthill-McKee-algorithm. Also, the computing timeat cycle 4 decreased from about 17 to 11 minutes for the <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code> call. However, the King ordering (and the orderings provided by the <a class="el" href="namespaceDoFRenumbering_1_1boost.html">DoFRenumbering::boost</a> namespace in general) has a serious drawback</p>
<ul>
<li>it usesmuch more memory than the in-build deal versions, since it acts on abstractgraphs rather than the geometry provided by the triangulation. In the presentcase, the renumbering takes about 5 times as much memory, which yields aninfeasible algorithm for the last cycle in 3D with 1.2 millionunknowns. <a class="anchor" id="BetterpreconditionerfortheinnerCGsolver"></a><h5>Better preconditioner for the inner CG solver</h5>
</li>
</ul>
<p>Another idea to improve the situation even more would be to choose apreconditioner that makes CG for the (0,0) matrix \(A\) converge in amesh-independent number of iterations, say 10 to 30. We have seen such acandidate in <a class="el" href="step_16.html">step-16</a> : multigrid. <a class="anchor" id="BlockSchurcomplementpreconditioner"></a></p><h5>Block Schur complement preconditioner</h5>
<p><a class="anchor" id="block-schur"></a>Even with a good preconditioner for \(A\) , we stillneed to solve of the same linear system repeatedly (with differentright hand sides, though) in order to make the Schur complement solveconverge. The approach we are going to discuss here is how inner iterationand outer iteration can be combined. If we persist in calculating the Schurcomplement, there is no other possibility. The alternative is to attack the block system at once and use an approximateSchur complement as efficient preconditioner. The idea is asfollows: If we find a block preconditioner \(P\) such that the matrix </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1}\left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) \end{eqnarray*}
</p>
<p> is simple, then an iterative solver with that preconditioner will converge in afew iterations. Using the Schur complement \(S = B A^{-1} B^T\) , one finds that </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1} = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ S^{-1} B A^{-1} &amp; -S^{-1} \end{array}\right) \end{eqnarray*}
</p>
<p> would appear to be a good choice since </p><p class="formulaDsp">
\begin{eqnarray*} P^{-1}\left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) = \left(\begin{array}{cc} A^{-1} &amp; 0 \\ S^{-1} B A^{-1} &amp; -S^{-1} \end{array}\right)\cdot \left(\begin{array}{cc} A &amp; B^T \\ B &amp; 0 \end{array}\right) = \left(\begin{array}{cc} I &amp; A^{-1} B^T \\ 0 &amp; I \end{array}\right). \end{eqnarray*}
</p>
<p> This is the approach taken by the paper by Silvester and Wathen referencedto in the introduction (with the exception that Silvester and Wathen useright preconditioning). In this case, a Krylov-based iterative method wouldconverge in one step only if exact inverses of \(A\) and \(S\) were applied,since all the eigenvalues are one (and the number of iterations in such amethod is bounded by the number of distinct eigenvalues). Below, we willdiscuss the choice of an adequate solver for this problem. First, we aregoing to have a closer look at the implementation of the preconditioner. Since \(P\) is aimed to be a preconditioner only, we shall use approximations tothe inverse of the Schur complement \(S\) and the matrix \(A\) . Hence, the Schurcomplement will be approximated by the pressure mass matrix \(M_p\) , and we usea preconditioner to \(A\) (without an InverseMatrix class around it) forapproximating \(A^{-1}\) . Here comes the class that implements the block Schurcomplement preconditioner. The <code>vmult</code> operation for block vectorsaccording to the derivation above can be specified by three successiveoperations: </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerMp&gt;</div>
<div class="line"><span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    BlockSchurPreconditioner (<span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a>         &amp;S,</div>
<div class="line">          <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>,PreconditionerMp&gt;  &amp;Mpinv,</div>
<div class="line">          <span class="keyword">const</span> PreconditionerA &amp;Apreconditioner);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a> (<a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a>       &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">              <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const BlockSparseMatrix&lt;double&gt;</a> &gt; system_matrix;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const InverseMatrix&lt;SparseMatrix&lt;double&gt;</a>,</div>
<div class="line">                       PreconditionerMp &gt; &gt; m_inverse;</div>
<div class="line">    <span class="keyword">const</span> PreconditionerA &amp;a_preconditioner;</div>
<div class="line">  </div>
<div class="line">    <span class="keyword">mutable</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp;</div>
<div class="line">  </div>
<div class="line">};</div>
<div class="line">  </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerMp&gt;</div>
<div class="line">BlockSchurPreconditioner&lt;PreconditionerA, PreconditionerMp&gt;::BlockSchurPreconditioner(</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a>                            &amp;S,</div>
<div class="line">          <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>,PreconditionerMp&gt; &amp;Mpinv,</div>
<div class="line">          <span class="keyword">const</span> PreconditionerA &amp;Apreconditioner</div>
<div class="line">          )</div>
<div class="line">                :</div>
<div class="line">                system_matrix           (&amp;S),</div>
<div class="line">                m_inverse               (&amp;Mpinv),</div>
<div class="line">                a_preconditioner        (Apreconditioner),</div>
<div class="line">                tmp                     (S.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1,1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">{}</div>
<div class="line">  </div>
<div class="line">        <span class="comment">// Now the interesting function, the multiplication of</span></div>
<div class="line">        <span class="comment">// the preconditioner with a BlockVector.</span></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerA, <span class="keyword">class</span> PreconditionerMp&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerA, PreconditionerMp&gt;::vmult</a> (</div>
<div class="line">                                     <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a>       &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                                     <span class="keyword">const</span> <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">        <span class="comment">// Form u_new = A^{-1} u</span></div>
<div class="line">  a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a> (<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">        <span class="comment">// Form tmp =</span></div>
<div class="line">  </div>
<div class="line">- B u_new + <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a></div>
<div class="line">        <span class="comment">// (&lt;code&gt;SparseMatrix::residual&lt;/code&gt;</span></div>
<div class="line">        <span class="comment">// does precisely this)</span></div>
<div class="line">  system_matrix-&gt;block(1,0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">        <span class="comment">// Change sign in tmp</span></div>
<div class="line">  tmp=</div>
<div class="line">  </div>
<div class="line">-1;</div>
<div class="line">        <span class="comment">// Multiply by approximate Schur complement</span></div>
<div class="line">        <span class="comment">// (i.e. a pressure mass matrix)</span></div>
<div class="line">  m_inverse-&gt;vmult (<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Since we act on the whole block system now, we have to live with onedisadvantage: we need to perform the solver iterations onthe full block system instead of the smaller pressure space. Now we turn to the question which solver we should use for the blocksystem. The first observation is that the resulting preconditioned matrix cannotbe solved with CG since it is neither positive definite nor symmetric. The deal.II libraries implement several solvers that are appropriate for theproblem at hand. One choice is the solver <a class="el" href="classSolverBicgstab.html">BiCGStab</a>, whichwas used for the solution of the unsymmetric advection problem in <a class="el" href="step_9.html">step-9</a> . Thesecond option, the one we are going to choose, is <a class="el" href="classSolverGMRES.html">GMRES</a>(generalized minimum residual). Both methods have their pros and cons</p>
<ul>
<li>thereare problems where one of the two candidates clearly outperforms the other, andvice versa.<a href="http://en.wikipedia.org/wiki/GMRES#Comparison_with_other_solvers">Wikipedia</a>'sarticle on the GMRES method gives a comparative presentation.A more comprehensive and well-founded comparison can be read e.g. in the book byJ.W. Demmel (Applied Numerical Linear Algebra, SIAM, 1997, section 6.6.6). For our specific problem with the ILU preconditioner for \(A\) , we certainly needto perform hundreds of iterations on the block system for large problem sizes(we won't beat CG!). Actually, this disfavors GMRES: During the GMRESiterations, a basis of Krylov vectors is successively built up and someoperations are performed on these vectors. The more vectors are in this basis,the more operations and memory will be needed. The number of operations scalesas \({\cal O}(n + k^2)\) and memory as \({\cal O}(kn)\) , where \(k\) is the number ofvectors in the Krylov basis and \(n\) the size of the (block) matrix.To not let these demands grow excessively, deal.II limits the size \(k\) of thebasis to 30 vectors by default.Then, the basis is rebuilt. This implementation of the GMRES method is calledGMRES(k), with default \(k=30\) . What we have gained by this restriction,namely a bound on operations and memory requirements, will be compensated bythe fact that we use an incomplete basis</li>
<li>this will increase the number ofrequired iterations. BiCGStab, on the other hand, won't get slower when many iterations are needed(one iteration uses only results from one preceding step andnot all the steps as GMRES). Besides the fact the BiCGStab is more expensive perstep since two matrix-vector products are needed (compared to one forCG or GMRES), there is one main reason which makes BiCGStab not appropriate forthis problem: The preconditioner applies the inverse of the pressuremass matrix by using the InverseMatrix class. Since the application of theinverse matrix to a vector is done only in approximative way (an exact inverseis too expensive), this will also affect the solver. In the case of BiCGStab,the Krylov vectors will not be orthogonal due to that perturbation. Whilethis is uncritical for a small number of steps (up to about 50), it ruins theperformance of the solver when these perturbations have grown to a significantmagnitude in the coarse of iterations. We did some experiments with BiCGStab and found it tobe faster than GMRES up to refinement cycle 3 (in 3D), but it became very slowfor cycles 4 and 5 (even slower than the original Schur complement), so thesolver is useless in this situation. Choosing a sharper tolerance for theinverse matrix class ( <code>1e-10*src.<a class="el" href="namespaceAdaptationStrategies_1_1Refinement.html#a069487de103023e142d174c1bb6712fa">l2_norm()</a></code> instead of <code>1e-6*src.<a class="el" href="namespaceAdaptationStrategies_1_1Refinement.html#a069487de103023e142d174c1bb6712fa">l2_norm()</a></code> ) made BiCGStab perform well also for cycle 4,but did not change the failure on the very large problems. GMRES is of course also effected by the approximate inverses, but it is not assensitive to orthogonality and retains a relatively good performance also forlarge sizes, see the results below. With this said, we turn to the realization of the solver call with GMRES with \(k=100\) temporary vectors: <div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> &amp;pressure_mass_matrix</div>
<div class="line">  = preconditioner_matrix.block(1,1);</div>
<div class="line"><a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> pmass_preconditioner;</div>
<div class="line">pmass_preconditioner.<a class="code" href="classSparseILU.html#a1f706d230cbc96643a666d07e32353ae">initialize</a> (pressure_mass_matrix,</div>
<div class="line">  <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;::AdditionalData</a>());</div>
<div class="line"> </div>
<div class="line">InverseMatrix&lt;SparseMatrix&lt;double&gt;,<a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> &gt;</div>
<div class="line">  m_inverse (pressure_mass_matrix, pmass_preconditioner);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">BlockSchurPreconditioner&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>,</div>
<div class="line">                         <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> &gt;</div>
<div class="line">  <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a> (system_matrix, m_inverse,A_preconditioner);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classSolverControl.html">SolverControl</a> solver_control (system_matrix.m(),</div>
<div class="line">                              1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6*system_rhs.l2_norm());</div>
<div class="line"><a class="code" href="classGrowingVectorMemory.html">GrowingVectorMemory&lt;BlockVector&lt;double&gt;</a> &gt; vector_memory;</div>
<div class="line"><a class="code" href="classSolverGMRES.html">SolverGMRES&lt;BlockVector&lt;double&gt;</a> &gt;<a class="code" href="relaxation__block__0_8txt.html#a2076fd56276055e74e230fad6edac013">::AdditionalData</a> gmres_data;</div>
<div class="line">gmres_data.max_n_tmp_vectors = 100;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classSolverGMRES.html">SolverGMRES&lt;BlockVector&lt;double&gt;</a> &gt; gmres(solver_control, vector_memory,</div>
<div class="line">                                        gmres_data);</div>
<div class="line"> </div>
<div class="line">gmres.solve(system_matrix, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>, system_rhs,</div>
<div class="line">            <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a> (<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">          &lt;&lt; solver_control.last_step()</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; block GMRES iterations&quot;</span>;</div>
</div><!-- fragment --></li>
</ul>
<p>Obviously, one needs to add the include file <a class="el" href="classSolverGMRES.html">&lt;lac/solver_gmres.h&gt;</a> in order to make this run.We call the solver with a <a class="el" href="classBlockVector.html">BlockVector</a> template in order to enableGMRES to operate on block vectors and matrices.Note also that we need to set the (1,1) block in the systemmatrix to zero (we saved the pressure mass matrix there which is not part of theproblem) after we copied the information to another matrix. Using the <a class="el" href="classTimer.html">Timer</a> class, we collect some statistics that compare the runtimeof the block solver with the one from the problem implementation above.Besides the solution with the two options we also check if the solutionsof the two variants are close to each other (i.e. this solver gives indeed thesame solution as we had before) and calculate the infinitynorm of the vector difference. Let's first see the results in 2D: </p><div class="fragment"><div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 0</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 64</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 679 (594+85) [0.00162792 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.00108981 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.0025959 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.00479603s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 12 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.00441718 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 5.38258e-07</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 1</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 160</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1683 (1482+201) [0.00345707 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.00237417 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.00605702 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.0123992s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 12 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.011909 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 1.74658e-05</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 2</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 376</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 3813 (3370+443) [0.00729299 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.00529909 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.0167508 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.031672s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 12 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.029232 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 7.81569e-06</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 3</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 880</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 8723 (7722+1001) [0.017709 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.0126002 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.0435679 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.0971651s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 12 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.0992041 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 1.87249e-05</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 4</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 2008</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 19383 (17186+2197) [0.039988 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.028281 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.118314 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.252133s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 13 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.269125 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 6.38657e-05</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 5</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 4288</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 40855 (36250+4605) [0.0880702 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.0603511 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.278339 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 11 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.53846s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 13 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.578667 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 0.000173363</div>
</div><!-- fragment --><p>We see that there is no huge difference in the solution time between theblock Schur complement preconditioner solver and the Schur complementitself. The reason is simple: we used a direct solve as preconditioner for \(A\) <br  />
</p>
<ul>
<li>so we cannot expect any gain by avoiding the inner iterations. We seethat the number of iterations has slightly increased for GMRES, but all inall the two choices are fairly similar. The picture of course changes in 3D: <div class="fragment"><div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 0</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 32</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1356 (1275+81) [0.00845218 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.019372 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.00712395 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 13 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.0320101s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 22 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.0048759 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 2.15942e-05</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 1</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 144</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 5088 (4827+261) [0.0346942 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.0857739 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.0465031 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 14 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [0.349258s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 35 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.048759 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 1.77657e-05</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 2</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 704</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 22406 (21351+1055) [0.175669 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [0.437447 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [0.286435 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 14 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [3.65519s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 63 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [0.497787 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 5.08078e-05</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 3</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 3168</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 93176 (89043+4133) [0.790985 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [1.97598 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [1.4325 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 15 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [29.9666s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 128 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [5.02645 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 0.000119671</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 4</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 11456</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 327808 (313659+14149) [3.44995 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [7.54772 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [5.46306 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 15 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [139.987s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 255 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [38.0946 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 0.00020793</div>
<div class="line">  </div>
<div class="line">Refinement <a class="code" href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a> 5</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a> <a class="code" href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a>: 45056</div>
<div class="line">   <a class="code" href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Number</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a> <a class="code" href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a> <a class="code" href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a>: 1254464 (1201371+53093) [19.6795 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Assembling...  [28.6586 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Computing <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>... [22.401 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   Solving...</div>
<div class="line">      Schur <a class="code" href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a>: 14 outer CG <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> <span class="keywordflow">for</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>  [796.767s ]</div>
<div class="line">      <a class="code" href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a> Schur <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>: 524 GMRES <a class="code" href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a> [355.597 <a class="code" href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a>]</div>
<div class="line">   l_infinity <a class="code" href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a> between <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a> <a class="code" href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a>: 0.000501219</div>
</div><!-- fragment --></li>
</ul>
<p>Here, the block preconditioned solver is clearly superior to the Schurcomplement, but the advantage gets less for more mesh points. This isbecause GMRES(k) scales worse with the problem size than CG, as we discussedabove. Nonetheless, the improvement by a factor of 3-6 for moderate problemsizes is quite impressive.</p>
<p><a class="anchor" id="Combiningtheblockpreconditionerandmultigrid"></a></p><h5>Combining the block preconditioner and multigrid</h5>
<p>An ultimate linear solver for this problem could be imagined as acombination of an optimalpreconditioner for \(A\) (e.g. multigrid) and the block preconditionerdescribed above, which is the approach taken in the <a class="el" href="step_31.html">step-31</a> and <a class="el" href="step_32.html">step-32</a> tutorial programs (where we use an algebraic multigridmethod) and <a class="el" href="step_56.html">step-56</a> (where we use a geometric multigrid method).</p>
<p><a class="anchor" id="Noblockmatricesandvectors"></a></p><h5>No block matrices and vectors</h5>
<p>Another possibility that can be taken into account is to not set up a blocksystem, but rather solve the system of velocity and pressure all at once. Theoptions are direct solve with UMFPACK (2D) or GMRES with ILUpreconditioning (3D). It should be straightforward to try that.</p>
<p><a class="anchor" id="Moreinterestingtestcases"></a></p><h4>More interesting testcases</h4>
<p>The program can of course also serve as a basis to compute the flow in moreinteresting cases. The original motivation to write this program was for it tobe a starting point for some geophysical flow problems, such as themovement of magma under places where continental plates drift apart (forexample mid-ocean ridges). Of course, in such places, the geometry is morecomplicated than the examples shown above, but it is not hard to accommodatefor that. For example, by using the following modification of the boundary valuesfunction </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span></div>
<div class="line"><a class="code" href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a> (<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>  &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (component &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>,</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a> (<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, this-&gt;n_components));</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> x_offset = <a class="code" href="function__lib__0_8txt.html#a47a8bdf43853e7a30a2a344567b78cde">std::atan</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[1]*4)/3;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0)</div>
<div class="line">    <span class="keywordflow">return</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &lt; x_offset ?</div>
<div class="line">  </div>
<div class="line">-1 : (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &gt; x_offset ? 1 : 0));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> and the following way to generate the mesh as the domain \([-2,2]\times[-2,2]\times[-1,0]\) <br  />
 </p><div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a> (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, 1);</div>
<div class="line"><a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>[0] = 4;</div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;2)</div>
<div class="line">  <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>[1] = 4;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> bottom_left = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?</div>
<div class="line">                                <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2,-1) :</div>
<div class="line">                                <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(-2,-2,-1));</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> top_right   = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?</div>
<div class="line">                                <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(2,0) :</div>
<div class="line">                                <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(2,2,0));</div>
<div class="line"> </div>
<div class="line"><a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a> (<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                           <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>,</div>
<div class="line">                                           bottom_left,</div>
<div class="line">                                           top_right);</div>
</div><!-- fragment --><p> then we get images where the fault line is curved: </p><table width="60%" align="center">
<tr>
<td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d-extension.png" alt="" class="inline"/>  </td><td align="center"><img src="https://www.dealii.org/images/steps/developer/step-22.3d-grid-extension.png" alt="" class="inline"/>   </td></tr>
</table>
<p><br  />
</p>
<p><a class="anchor" id="PlainProg"></a></p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2008 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Wolfgang Bangerth, Texas A&amp;M University, 2008</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparse__matrix_8h.html">deal.II/lac/block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2sparse__ilu_8h.html">deal.II/lac/sparse_ilu.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep22.html">Step22</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">struct </span>InnerPreconditioner;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;&gt;</div>
<div class="line">  <span class="keyword">struct </span>InnerPreconditioner&lt;2&gt;</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;&gt;</div>
<div class="line">  <span class="keyword">struct </span>InnerPreconditioner&lt;3&gt;</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">using</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a> = <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>);</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span> refine_mesh();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>;</div>
<div class="line">    <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockSparsityPattern.html">BlockSparsityPattern</a>      preconditioner_sparsity_pattern;</div>
<div class="line">    <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>;</div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">std::shared_ptr&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt; A_preconditioner;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classBoundaryValues.html">BoundaryValues</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classBoundaryValues.html">BoundaryValues</a>()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="classStep22_1_1BoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a>, 0, this-&gt;n_components));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> == 0)</div>
<div class="line">      <span class="keywordflow">return</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &lt; 0 ? -1 : (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] &gt; 0 ? 1 : 0));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1BoundaryValues.html#a2f153a49969a599502c29c4ea80bd034">BoundaryValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                         <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="classStep22_1_1BoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues&lt;dim&gt;::value</a>(p, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classRightHandSide.html">RightHandSide</a> : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classRightHandSide.html">RightHandSide</a>()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="classStep22_1_1RightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1RightHandSide.html#a6deb4e3cb5cc0913313f6a02d8d818b1">RightHandSide&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                        <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>) = <a class="code" href="classStep22_1_1RightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide&lt;dim&gt;::value</a>(p, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                  <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a>         <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const PreconditionerType&gt;</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <a class="code" href="classStep22_1_1InverseMatrix.html#a8ee0d2b7905ba0648efb2d506e0200fb">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix</a>(</div>
<div class="line">    <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">    <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">    : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">    , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(&amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(src.<a class="code" href="group__Vectors.html#ga81dcfa5c77bdd426603386c0844149ae">size</a>(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * src.<a class="code" href="classVector.html#a8ee1b8309a7a9ecf109c8a7116733ef8">l2_norm</a>());</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">    cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, *<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keyword">class </span>SchurComplement : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SchurComplement(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> &amp;system_matrix,</div>
<div class="line">      <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>, PreconditionerType&gt; &amp;A_inverse);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const BlockSparseMatrix&lt;double&gt;</a>&gt; system_matrix;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;</div>
<div class="line">      <span class="keyword">const</span> InverseMatrix&lt;SparseMatrix&lt;double&gt;, PreconditionerType&gt;&gt;</div>
<div class="line">      A_inverse;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">mutable</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp1, tmp2;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  SchurComplement&lt;PreconditionerType&gt;::SchurComplement(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classBlockSparseMatrix.html">BlockSparseMatrix&lt;double&gt;</a> &amp;system_matrix,</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a>, PreconditionerType&gt; &amp;A_inverse)</div>
<div class="line">    : system_matrix(&amp;system_matrix)</div>
<div class="line">    , A_inverse(&amp;A_inverse)</div>
<div class="line">    , tmp1(system_matrix.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(0, 0).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">    , tmp2(system_matrix.<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(0, 0).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>())</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">SchurComplement&lt;PreconditionerType&gt;::vmult</a>(<a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                                             <span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    system_matrix-&gt;block(0, 1).<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(tmp1, src);</div>
<div class="line">    A_inverse-&gt;vmult(tmp2, tmp1);</div>
<div class="line">    system_matrix-&gt;block(1, 0).vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, tmp2);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::StokesProblem</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    : <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    , <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">    , <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>), 1)</div>
<div class="line">    , dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::setup_dofs</a>()</div>
<div class="line">  {</div>
<div class="line">    A_preconditioner.reset();</div>
<div class="line">    system_matrix.clear();</div>
<div class="line">    preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    dof_handler.distribute_dofs(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;unsigned int&gt; block_component(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">    block_component[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(dof_handler, block_component);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>);</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                               1,</div>
<div class="line">                                               <a class="code" href="classBoundaryValues.html">BoundaryValues&lt;dim&gt;</a>(),</div>
<div class="line">                                               <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                               <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(dof_handler, block_component);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = dofs_per_block[0];</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_p = dofs_per_block[1];</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">      dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">      dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">      dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        dof_handler, coupling, dsp, <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>.copy_from(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> preconditioner_dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      preconditioner_dsp.block(0, 0).reinit(n_u, n_u);</div>
<div class="line">      preconditioner_dsp.block(1, 0).reinit(n_p, n_u);</div>
<div class="line">      preconditioner_dsp.block(0, 1).reinit(n_u, n_p);</div>
<div class="line">      preconditioner_dsp.block(1, 1).reinit(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      preconditioner_dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> preconditioner_coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">            preconditioner_coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            preconditioner_coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                      preconditioner_coupling,</div>
<div class="line">                                      preconditioner_dsp,</div>
<div class="line">                                      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>,</div>
<div class="line">                                      <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      preconditioner_sparsity_pattern.copy_from(preconditioner_dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(<a class="code" href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a>);</div>
<div class="line">    preconditioner_matrix.reinit(preconditioner_sparsity_pattern);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.reinit(2);</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0).reinit(n_u);</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).reinit(n_p);</div>
<div class="line">    <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    system_rhs.reinit(2);</div>
<div class="line">    system_rhs.block(0).reinit(n_u);</div>
<div class="line">    system_rhs.block(1).reinit(n_p);</div>
<div class="line">    system_rhs.collect_sizes();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::assemble_system</a>()</div>
<div class="line">  {</div>
<div class="line">    system_matrix         = 0;</div>
<div class="line">    system_rhs            = 0;</div>
<div class="line">    preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(<a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_preconditioner_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>,</div>
<div class="line">                                                   <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classRightHandSide.html">RightHandSide&lt;dim&gt;</a>    <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>;</div>
<div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; symgrad_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;                  phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        local_matrix                = 0;</div>
<div class="line">        local_preconditioner_matrix = 0;</div>
<div class="line">        local_rhs                   = 0;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">right_hand_side</a>.vector_value_list(fe_values.get_quadrature_points(),</div>
<div class="line">                                          rhs_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                symgrad_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] =</div>
<div class="line">                  fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].symmetric_gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt;= <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                  {</div>
<div class="line">                    local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      (2 * (symgrad_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * symgrad_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) <span class="comment">// (1)</span></div>
<div class="line">                       - div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]                 <span class="comment">// (2)</span></div>
<div class="line">                       - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])                <span class="comment">// (3)</span></div>
<div class="line">                      * fe_values.JxW(q);                        <span class="comment">// * dx</span></div>
<div class="line"> </div>
<div class="line">                    local_preconditioner_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      (phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) <span class="comment">// (4)</span></div>
<div class="line">                      * fe_values.JxW(q);   <span class="comment">// * dx</span></div>
<div class="line">                  }</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component_i =</div>
<div class="line">                  <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">system_to_component_index</a>(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first;</div>
<div class="line">                local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) += (fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q)   <span class="comment">// (phi_u_i(x_q)</span></div>
<div class="line">                                 * rhs_values[q](component_i)) <span class="comment">// * f(x_q))</span></div>
<div class="line">                                * fe_values.JxW(q);            <span class="comment">// * dx</span></div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> + 1; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">            {</div>
<div class="line">              local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = local_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">              local_preconditioner_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) =</div>
<div class="line">                local_preconditioner_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(local_matrix,</div>
<div class="line">                                               local_rhs,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               system_matrix,</div>
<div class="line">                                               system_rhs);</div>
<div class="line">        <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(local_preconditioner_matrix,</div>
<div class="line">                                               <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                               preconditioner_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Computing preconditioner...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div>
<div class="line"> </div>
<div class="line">    A_preconditioner =</div>
<div class="line">      <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">std::make_shared&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt;();</div>
<div class="line">    A_preconditioner-&gt;initialize(</div>
<div class="line">      system_matrix.block(0, 0),</div>
<div class="line">      <span class="keyword">typename</span> <a class="code" href="relaxation__block__0_8txt.html#a2076fd56276055e74e230fad6edac013">InnerPreconditioner&lt;dim&gt;::type::AdditionalData</a>());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">StokesProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> InverseMatrix&lt;SparseMatrix&lt;double&gt;,</div>
<div class="line">                        <span class="keyword">typename</span> <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">InnerPreconditioner&lt;dim&gt;::type</a>&gt;</div>
<div class="line">                   A_inverse(system_matrix.block(0, 0), *A_preconditioner);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0).size());</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classVector.html">Vector&lt;double&gt;</a> schur_rhs(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).size());</div>
<div class="line">      A_inverse.vmult(tmp, system_rhs.block(0));</div>
<div class="line">      system_matrix.block(1, 0).vmult(schur_rhs, tmp);</div>
<div class="line">      schur_rhs -= system_rhs.block(1);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">SchurComplement&lt;typename InnerPreconditioner&lt;dim&gt;::type</a>&gt; <a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>(</div>
<div class="line">        system_matrix, A_inverse);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1).size(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-6 * schur_rhs.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">      <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(preconditioner_matrix.block(1, 1),</div>
<div class="line">                                <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;::AdditionalData</a>());</div>
<div class="line"> </div>
<div class="line">      InverseMatrix&lt;SparseMatrix&lt;double&gt;, <a class="code" href="classSparseILU.html">SparseILU&lt;double&gt;</a>&gt; m_inverse(</div>
<div class="line">        preconditioner_matrix.block(1, 1), <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">      cg.solve(<a class="code" href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">schur_complement</a>, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1), schur_rhs, m_inverse);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot; outer CG Schur complement iterations for pressure&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      system_matrix.block(0, 1).vmult(tmp, <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(1));</div>
<div class="line">      tmp *= -1;</div>
<div class="line">      tmp += system_rhs.block(0);</div>
<div class="line"> </div>
<div class="line">      A_inverse.vmult(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>.block(0), tmp);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a>.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::output_results</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::vector&lt;std::string&gt; solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      data_component_interpretation(</div>
<div class="line">        <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(<a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">                             solution_names,</div>
<div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                             data_component_interpretation);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(</div>
<div class="line">      <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(refinement_cycle, 2) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">write_vtk</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;dim&gt;::refine_mesh</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">      dof_handler,</div>
<div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1),</div>
<div class="line">      <a class="code" href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">std::map</a>&lt;<a class="code" href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">      <a class="code" href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a>,</div>
<div class="line">      estimated_error_per_cell,</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a>.<a class="code" href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">component_mask</a>(<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                    estimated_error_per_cell,</div>
<div class="line">                                                    0.3,</div>
<div class="line">                                                    0.0);</div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">StokesProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    {</div>
<div class="line">      std::vector&lt;unsigned int&gt; <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, 1);</div>
<div class="line">      <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>[0] = 4;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> bottom_left = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?                </div>
<div class="line">                                        <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(-2, -1) :    <span class="comment">// 2d case</span></div>
<div class="line">                                        <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(-2, 0, -1)); <span class="comment">// 3d case</span></div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> top_right = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ?              </div>
<div class="line">                                      <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(2, 0) :    <span class="comment">// 2d case</span></div>
<div class="line">                                      <a class="code" href="classPoint.html">Point</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(2, 1, 0)); <span class="comment">// 3d case</span></div>
<div class="line"> </div>
<div class="line">      <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>,</div>
<div class="line">                                                <a class="code" href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a>,</div>
<div class="line">                                                bottom_left,</div>
<div class="line">                                                top_right);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;center()[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1] == 0)</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;set_all_boundary_ids(1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(4 - <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 6;</div>
<div class="line">         ++refinement_cycle)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div>
<div class="line">          refine_mesh();</div>
<div class="line"> </div>
<div class="line">        setup_dofs();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl &lt;&lt; std::flush;</div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::flush;</div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        output_results(refinement_cycle);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step22</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep22.html">Step22</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classStep22_1_1StokesProblem.html">StokesProblem&lt;2&gt;</a> flow_problem(1);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="aclassSparseILU_html_a1f706d230cbc96643a666d07e32353ae"><div class="ttname"><a href="classSparseILU.html#a1f706d230cbc96643a666d07e32353ae">SparseILU::initialize</a></div><div class="ttdeci">void initialize(const SparseMatrix&lt; somenumber &gt; &amp;matrix, const AdditionalData &amp;parameters=AdditionalData())</div></div>
<div class="ttc" id="asparse__vanka__0_8txt_html_a63f572a3b5d8c173a82cee16f5858977"><div class="ttname"><a href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a></div><div class="ttdeci">this elimination is done by the modification of the right hand and in the end these degrees of freedom do not occur in the matrix and solution vector any more at all *This system is solved and the values are updated into the destination vector the matrices are built up such that the degree of freedom associated with the Lagrange multiplier is the first one usually the upper left entry in the matrix is zero It is not clear to so it must persist longer than the Vanka object The same is true for the matrix The matrix[2.x.11] which is passed here may or may not be the same matrix for which this object shall act as preconditioner In it is conceivable that the preconditioner is build up for one matrix but is used for subsequent steps in a nonlinear process as where the matrix changes in each step slightly **Destructor Delete all allocated matrices **Parameters for SparseVanka **Constructor For the parameters see below **Constructor For the parameters see below[2.x.12] The use of this constructor is deprecated **the second and third parameters are ignored **Indices of those degrees of freedom that we shall work on **If the default constructor is used then this function needs to be called before an object of this class is used as preconditioner For more detail about possible parameters see the class documentation and the documentation of the[2.x.13] class After this function is called the preconditioner is ready to be only values for allowed indices are written to[2.x.27] dst</div><div class="ttdef"><b>Definition:</b> <a href="sparse__vanka__0_8txt_source.html#l00060">sparse_vanka_0.txt:60</a></div></div>
<div class="ttc" id="aclassStep22_1_1BoundaryValues_html_a45af33d412a06517009ba6f342340256"><div class="ttname"><a href="classStep22_1_1BoundaryValues.html#a45af33d412a06517009ba6f342340256">Step22::BoundaryValues::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-22_8cc_source.html#l00135">step-22.cc:135</a></div></div>
<div class="ttc" id="apolynomial__0_8txt_html_af1258c87f1d73d29bd17331843ac1d25"><div class="ttname"><a href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a></div><div class="ttdeci">namespace in which classes relating to the description of d polynomial spaces are declared ***Base class for all D polynomials A polynomial is represented in this class by its coefficients which are set through the constructor or by derived classes There are two paths for evaluation of polynomials One is based on the coefficients which are evaluated through the Horner scheme which is a robust general purpose scheme An alternative and more stable evaluation of high degree polynomials with roots in the unit interval is provided by a product in terms of the roots This form is available for special polynomials such as Lagrange polynomials or Legendre polynomials and used with the respective constructor To obtain this more stable evaluation form the constructor with the roots in form of a Lagrange polynomial must be used In case a manipulation is done that changes the roots the representation is switched to the coefficient form This class is a typical example of a possible template argument for the TensorProductPolynomials class **Constructor The coefficients of the polynomial are passed as and denote the i e the first element of the array denotes the constant the second the linear and so on The degree of the polynomial represented by this object is thus the number of elements in the&lt; tt &gt; coefficient&lt;/tt &gt; array minus one **Constructor creating a zero polynomial of degree *[2.x.3] *Constructor for a Lagrange polynomial and its point of evaluation The idea is to where j is the evaluation point specified as argument and the support points contain all the evaluation is based on products of the whereas the Horner scheme is used for polynomials in the coefficient form **Return the values and the derivatives of the Polynomial at point&lt; tt &gt; x&lt;/tt &gt;&lt; tt &gt; i</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__0_8txt_source.html#l00024">polynomial_0.txt:24</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_a6455f6a054e8ade1e447d62afc769235"><div class="ttname"><a href="distributed__0_8txt.html#a6455f6a054e8ade1e447d62afc769235">vectors</a></div><div class="ttdeci">********clusters ***deal II can use multiple machines connected via MPI to parallelize in addition to the parallelization within a shared memory machine discussed in the[2.x.4] module There are essentially two ways to utilize multiple but only a share of the global sparsity and solution vector is stored on each machine ****The mesh and DoF handler are also i e each processor stores only a share of the cells and degrees of freedom No processor has knowledge of the entire or and in fact problems solved in this mode are usually so and handling distributed vectors</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00026">distributed_0.txt:26</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a79cbe2f02f8dfb85026c71d783dbb703"><div class="ttname"><a href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out__dof__data_8h_source.html#l01096">data_out_dof_data.h:1096</a></div></div>
<div class="ttc" id="aclassFEValues_html_a21f914e63d588e2652a9514620653d77"><div class="ttname"><a href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell)</div></div>
<div class="ttc" id="adofs_2dof__handler__0_8txt_html_aae1f8d9ad7eda22eb5458605a6db742d"><div class="ttname"><a href="dofs_2dof__handler__0_8txt.html#aae1f8d9ad7eda22eb5458605a6db742d">iterations</a></div><div class="ttdeci">this information can therefore be used upon construction of the SparsityPattern object The returned number is not really the maximum number but an estimate based on the finite element and the maximum number of cells meeting at a vertex The number holds for the constrained matrix as well The determination of the number of couplings can be done by simple picture drawing An example can be found in the implementation of this function *This function is most often used to determine the maximal row length for sparsity patterns while the estimates returned by this function are rather accurate in they are often significantly too high leading the SparsityPattern class to allocate much too much memory in some cases Unless someone comes around to improving the present function for d there is not very much one can do about these cases The typical way to work around this problem is to use an intermediate compressed sparsity pattern that only allocates memory on demand Refer to the[2.x.89] and[2.x.90] example programs on how to do this The problem is also discussed in the documentation of the module on *[2.x.91] *Return the number of degrees of freedom located on the boundary another dof on the boundary can couple with The number is the same as for all cells on this level are further then this function returns[2.x.98] so that loops of the kind **have zero iterations</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler__0_8txt_source.html#l00175">dof_handler_0.txt:175</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00077">fe_update_flags.h:77</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_afec1b694405cadb2d251275096ad3563"><div class="ttname"><a href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a></div><div class="ttdeci">if we even only hold bytes per line in this sparsity we ll need GB for this object even if every single line is empty Of only million lines will be non for which we need MB plus whatever is necessary to store the actual column indices of nonzero entries Let s say we have a moderately complex problem with entries per for each of which we store the column index worth then we ll need bytes for each of the million lines that correspond to the degrees of freedom we for a total of GB And we ll need bytes for each of the million lines that we don t for a total of GB It is clear that this ratio doesn t become any better if we go to even higher numbers of processors *The solution to this problem is to really only use any memory at all for those parts of the linear system that we or need for some other reason For all other we must know that they but we can not set up any part of our data structure To this there exists a class called IndexSet that denotes a set of indices which we care for and for which we may have to allocate memory The data structures for sparsity patterns constraint matrices matrices and vector can be initialized with these IndexSet objects to really only care for those rows or entries that correspond to indices in the index set and not care about all others These objects will then ask how many indices exist in the set allocate memory for each one of and when you want to access data for global degree of freedom[2.x.28] you will be redirected to the result of calling[2.x.29] with index[2.x.30] instead Accessing data for elements[2.x.31] for which[2.x.32] is false will yield an error *The remaining question is how to identify the set of indices that correspond to degrees of freedom we need to worry about on each processor To this you can use the[2.x.33] function to get at all the indices a processor owns Note that this is a subset of the degrees of freedom that are defined on the locally owned one sometimes needs the set of all degrees of freedom on the locally owned subdomain as well as the adjacent ghost cells This information is provided by the[2.x.35] function ***A typical parallel application is dealing with two different kinds of parallel but there are of course different vector types that can each represent both ghosted vectors are typically used for data output</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00059">distributed_0.txt:59</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__cg_8h_source.html#l00088">solver_cg.h:88</a></div></div>
<div class="ttc" id="aclassStep22_1_1InverseMatrix_html_a8ee0d2b7905ba0648efb2d506e0200fb"><div class="ttname"><a href="classStep22_1_1InverseMatrix.html#a8ee0d2b7905ba0648efb2d506e0200fb">Step22::InverseMatrix::InverseMatrix</a></div><div class="ttdeci">InverseMatrix(const MatrixType &amp;m, const PreconditionerType &amp;preconditioner)</div><div class="ttdef"><b>Definition:</b> <a href="step-22_8cc_source.html#l00208">step-22.cc:208</a></div></div>
<div class="ttc" id="apetsc__precondition__0_8txt_html_a41ebb2d49faa97a3d9eab4b4f13c2742"><div class="ttname"><a href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a></div><div class="ttdeci">*Base class for preconditioner classes using the PETSc functionality The classes in this hierarchy don t do a whole lot except for providing a function that sets the preconditioner and certain parameters on the preconditioning context of the solver These classes are basically here only to allow a similar interface as already used for the deal II solver and preconditioner classes Note that derived classes only provide interfaces to the relevant functionality of PETSc PETSc does not implement all preconditioners for all matrix types In particular some preconditioners are not going to work for parallel jobs such as for example the ILU preconditioner ***Constructor **Destructor **Destroys the preconditioner</div><div class="ttdef"><b>Definition:</b> <a href="petsc__precondition__0_8txt_source.html#l00002">petsc_precondition_0.txt:2</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a8fba07b9a84b89e6be225f5f95c3e355"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div><div class="ttdeci">the program is just and one can not intelligently work around that *It is sometimes useful to change the behavior of the[2.x.6] macro from aborting a program to throwing exceptions On the other exceptions are not allowed to propagate out of destructors of classes For this there is a variant of the called[2.x.7] that can be used in destructors These use cases are discussed further down below on this page **Dynamic such as whether an output file can be written to *These are things that shouldn t be checked because it is not guaranteed that a program for which the condition is satisfied in a debug mode run</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00022">exceptions_0.txt:22</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__q_8h_source.html#l00587">fe_q.h:587</a></div></div>
<div class="ttc" id="anamespaceUtilities_html_a6195c5f009ea8c7c536c6ffdf108c32f"><div class="ttname"><a href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></div><div class="ttdeci">std::string int_to_string(const unsigned int value, const unsigned int digits=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00473">utilities.cc:473</a></div></div>
<div class="ttc" id="agrid_2grid__tools_8h_html"><div class="ttname"><a href="grid_2grid__tools_8h.html">grid_tools.h</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2namespace__dealii_8h_source.html#l00026">namespace_dealii.h:26</a></div></div>
<div class="ttc" id="amatrix__free_2dof__info__0_8txt_html_afc846d40941f6f9934e92e469096f30f"><div class="ttname"><a href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a></div><div class="ttdeci">We set the granularity to **that is a number sufficiently large to minimize loop peel overhead within the this function always returns index If an index is not found in hp it returns *[2.x.2] *Populate the vector[2.x.3] with locally owned degrees of freedom stored on the cell block[2.x.4] If[2.x.5] is then the returned vector will contain indices required to resolve constraints The image below illustrates the output of this function for cell blocks zero and one with zero Dirichlet boundary conditions at the bottom of the domain Note that due to the presence of the DoFs returned by this function for the case i indices that are located on another get a temporary number by this and will later be assigned the correct index after all the ghost indices have been collected by the call to *[2.x.12] *This method assigns the correct indices to ghost indices from the temporary numbering employed by the[2.x.13] function The numbers are localized with respect to the MPI and ghosts start at the end of the locally owned range This we get direct access to all vector entries **This method reorders the way cells are gone through based on a given renumbering of the cells It also takes[2.x.14] cells together and interprets them as one cell as is needed for vectorization **Finds possible compression for the cell indices that we can apply for increased efficiency Run at the end of reorder_cells **Finds possible compression for the face indices that we can apply for increased efficiency Run at the end of reorder_cells **This function computes the connectivity of the currently stored indices in terms of connections between the individual cells and fills the structure into a sparsity pattern **In case face integrals are find out whether certain loops over the unknowns only access a subset of all the ghost dofs we keep in the main partitioner **Given[2.x.15] containing the index of cells of macro the index ordering can be improved for typical DG elements by interleaving the degrees of freedom from batches of which avoids the data transposition in[2.x.16] these more advanced features are not so there is only limited value of this function **Fills the array that defines how to zero selected ranges in the result vector within the cell filling the two member variables[2.x.17] vector_zero_range_list_index and[2.x.18] The intent of this pattern is to zero the vector entries in close temporal proximity to the first access and thus keeping the vector entries in cache **Return the memory consumption in bytes of this class **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **Prints a representation of the indices in the class to the given output stream **Enum for various storage variants of the indices This storage format is used to implement more efficient indexing schemes in case the underlying data structures allow for and to inform the access functions in[2.x.19] on which array to get the data from One example of more efficient storage is the enum value[2.x.20] which means that one can get the indices to all degrees of freedom of a cell by reading only the first index for each whereas all subsequent indices are merely an offset from the first index **This value indicates that no index compression was found and the only valid storage is to access all indices present on the possibly including constraints For a cell face of this index the data access in FEEvaluationBase is directed to the array[2.x.21] dof_indices with the index row_starts[cell_index *n_vectorization *n_components] first **This value indicates that the indices are interleaved for access with vectorized gather and scatter operation This storage variant is possible in case there are no constraints on the cell and the indices in the batch of cells are not pointing to the same global index in different slots of a vectorized the data access in FEEvaluationBase is directed to the array dof_indices_interleaved with the index row_starts[cell_index *n_vectorization *n_components] first **This value indicates that the indices within a cell are all and one can get the index to the cell by reading that single value for each of the cells in the cell batch For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **This value indicates that the indices with a cell are contiguous and interleaved for i the first DoF index on a cell to the four or eight cells in the vectorization batch come than the second DoF and so on the interleaving between cells implies that only the batches for vectorization can be accessed whereas there is a strided access for getting only some of the entries The two additional categories interleaved_contiguous_strided and interleaved_contiguous_mixed_strides are a consequence of this storage type The former is for faces where at least one of the two adjacent sides will break with the interleaved storage We then have to make a strided access as described in the next category The last category interleaved_contiguous_mixed_strides appears in the ghost see the more detailed description of that category below this is something that cannot be avoided in general once we interleave the indices between cells For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **Similar to interleaved_contiguous but for the case when the interleaved indices are only contiguous within the degrees of but not also over the components of a vectorized array This happens typically on faces with DG where the cells have interleaved_contiguous storage but the faces numbering is not the same as the cell s numbering For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **Similar to interleaved_contiguous_separate but for the case when the interleaved indices are not n_vectorization apart This happens typically within the ghost layer of DG where the remote owner has applied an interleaved storage and the current processor only sees some of the cells For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization * n_components</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2dof__info__0_8txt_source.html#l00070">dof_info_0.txt:70</a></div></div>
<div class="ttc" id="aclassFiniteElement_html_a4409f54175f279ac24cc982cfcfcbd2f"><div class="ttname"><a href="classFiniteElement.html#a4409f54175f279ac24cc982cfcfcbd2f">FiniteElement::component_mask</a></div><div class="ttdeci">ComponentMask component_mask(const FEValuesExtractors::Scalar &amp;scalar) const</div><div class="ttdef"><b>Definition:</b> <a href="fe_8cc_source.html#l00396">fe.cc:396</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00070">fe_update_flags.h:70</a></div></div>
<div class="ttc" id="aiterators__0_8txt_html_a6cf0880ba2af3a1be4aacdbbd4b90f9c"><div class="ttname"><a href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a></div><div class="ttdeci">where BaseIterator usually is one of thestandard iterators discussed above *The FilteredIterator gets an additional Predicate in its constructor and willskip all objects where this Predicate evaluates to&lt; tt &gt; false&lt;/tt &gt; Acollection of predicates already implemented can be found in the namespaceIteratorFilters ***IteratorsLoops Iterating over objects *All iterators of the same kind and iterating over thesame kind of geometrical objects traverse the mesh in the sameorder Take this code all iterators will always point to the same mesh even though&lt; tt &gt; DoFHandler&lt;/tt &gt; and&lt; tt &gt; Triangulation&lt;/tt &gt; are very different and even if the DoFHandlers are handling different finite the difference is only in the Accessor As mentioned the order in which iterators traverse the forest ofobjects is actually well but application programs should notassume any such but rather consider this an implementation detailof the library *Corresponding to above the order in which iterators traverse activeobjects is the same for all iterators in the following the difference to the previous example being that here we only consider active but theyare really rather dumb Their magic only lies in the fact that they point tosome useful in this case the Accessor For they point to anactual object that stores some data On the other the deal II when do not return a reference to an actual but returnan object that knows how to get at the data that represents cells In thisobject doesn t store itself where the vertices of a cell are or what its neighborsare it knows how to tease this sort of information from out of thearrays and tables and lists that the Triangulation class sets up to describe amesh *Accessing data that characterizes a cell is always done through the i e the expression[2.x.10] grants access to[1.x.6] attributes of this Accessor Examples of properties you can query from aniterator are ***Since dereferencing iterators yields accessor these calls are tomember etc These in turn figure out the relevant datafrom the various data structures that store this data How this is actuallydone and what data structures are used is not really of concern to authors ofapplications in deal II In by hiding the actual data structureswe are able to store data in an efficient not necessarily in a way thatmakes it easily accessible or understandable to application writers ***IteratorsTypedefs Kinds of accessors *Depending on what sort of data you want to there are different kindsof accessor and hexes that make up a triangulation</div><div class="ttdef"><b>Definition:</b> <a href="iterators__0_8txt_source.html#l00063">iterators_0.txt:63</a></div></div>
<div class="ttc" id="aclassBlockVector_html"><div class="ttname"><a href="classBlockVector.html">BlockVector&lt; double &gt;</a></div></div>
<div class="ttc" id="astep-1_8cc_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition:</b> <a href="step-1_8cc_source.html#l00086">step-1.cc:86</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation&lt; dim &gt;</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="afe_2fe__q_8h_html"><div class="ttname"><a href="fe_2fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="alogstream__0_8txt_html_add684e6ff311806f483d928c97341d99"><div class="ttname"><a href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a></div><div class="ttdeci">&lt;/tt &gt; or with one of the special member functions is buffered in a thread storage[2.x.15] An[2.x.16] or[2.x.17] will trigger a writeout to the console invoking a as well as a call to ******A subclass allowing for the safe generation and removal of prefixes Somewhere at the beginning of a block</div><div class="ttdef"><b>Definition:</b> <a href="logstream__0_8txt_source.html#l00015">logstream_0.txt:15</a></div></div>
<div class="ttc" id="anamespaceGridRefinement_html_a48e5395381ed87155942a61a1edd134d"><div class="ttname"><a href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a></div><div class="ttdeci">void refine_and_coarsen_fixed_number(Triangulation&lt; dim, spacedim &gt; &amp;triangulation, const Vector&lt; Number &gt; &amp;criteria, const double top_fraction_of_cells, const double bottom_fraction_of_cells, const unsigned int max_n_cells=std::numeric_limits&lt; unsigned int &gt;::max())</div><div class="ttdef"><b>Definition:</b> <a href="grid_2grid__refinement_8cc_source.html#l00322">grid_refinement.cc:322</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2utilities_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2utilities_8h.html">utilities.h</a></div></div>
<div class="ttc" id="anumerics_2error__estimator_8h_html"><div class="ttname"><a href="numerics_2error__estimator_8h.html">error_estimator.h</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Scalar_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00095">fe_values_extractors.h:95</a></div></div>
<div class="ttc" id="afunction__lib__0_8txt_html_a47a8bdf43853e7a30a2a344567b78cde"><div class="ttname"><a href="function__lib__0_8txt.html#a47a8bdf43853e7a30a2a344567b78cde">atan</a></div><div class="ttdeci">*Namespace implementing some concrete classes derived from the Function class that describe actual functions This is rather a collection of classes that we have needed for our own programs once and thought might be useful to others as well at some point ******The distance to the origin squared This function returns the square norm of the radius vector of a point Together with the its derivatives and Laplacian are defined ***The function&lt; tt &gt; xy&lt;/tt &gt; in not implemented in This function serves as an example for a vanishing Laplacian ***Laplacian of the function at one point **Laplacian of the function at multiple points **d quadratic pillow on the unit hypercube This is a function for testing the implementation It has zero Dirichlet boundary values on the domain[2.x.3] In the it is the product of[2.x.4] over all space dimensions Providing a non zero argument to the the whole function can be offset by a constant Together with the its derivatives and Laplacian are defined ***Constructor Provide a constant that will be added to each function value **The value at a single point **Values at multiple points **Gradient at a single point **Gradients at multiple points **Laplacian at a single point **Laplacian at multiple points **Cosine shaped pillow function This is another function with zero boundary values on[2.x.6] In the interior it is the product of *[2.x.7] **Constructor which allows to optionally generate a vector valued cosine function with the same value in each component **Second derivatives at a single point **Second derivatives at multiple points **Gradient of the cosine shaped pillow function This is a vector valued function with[2.x.9] the gradient of CosineFunction On the it has tangential boundary conditions zero it can be used to test implementations of Maxwell operators without bothering about boundary terms creating a function with[2.x.11] components **Product of exponential functions in each coordinate direction ***The value at a single point **Values at multiple points **Gradient at a single point **Gradients at multiple points **Laplacian at a single point **Laplacian at multiple points **A function that solves the Laplace at the location of the re entrant corner of this non convex domain The function is given in polar coordinates by[2.x.13] with a singularity at the origin and should be used with[2.x.14] is defined as theclockwise *angle against the positive[2.x.16] axis This function is often used to illustrate that the solutions of the Laplace equation[1.x.0] can be singular even if the boundary values are but its gradient is of the form[2.x.20] in the vicinity of the origin and consequently diverges as one approaches the origin ***Gradient of the harmonic singularity on the L shaped domain in The gradient of which is a vector valued function with vanishing curl and divergence ***Default constructor setting the dimension to **Singularity on the slit domain in and ***Singularity on the slit domain with one Neumann boundary in ***A jump in x direction transported into some direction If the advection is parallel to the y the function is&lt; tt &gt; atan(sx)&lt;/tt &gt;</div></div>
<div class="ttc" id="alinear__operator__0_8txt_html_a64f52ea7f8959e614f32da4664cdbe50"><div class="ttname"><a href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a></div><div class="ttdeci">*A class to store the abstract concept of a linear set up and handle intermediate storage locations by hand *As an example consider the and[2.x.8] one can sparse matrices with a or larger ***In order to use Trilinos or PETSc sparse matrices and preconditioners in conjunction with the LinearOperator it is necessary to extend the functionality of the LinearOperator class by means of an additional Payload *For for may represent a composite operation The[2.x.14] therefore provides an interface extension to the LinearOperator so that it can be passed to the solver and used by the solver as if it were a Trilinos it is again necessary to provide an interface that produces the result of this composite operation that is compatible with Trilinos the resulting this function also ensures that the underlying Payload matches that of the input *[2.x.105] *****LinearOperator *Return a nulled variant of the LinearOperator[2.x.108] i e with optimized[2.x.109][2.x.110] etc functions and with[2.x.111] set to true ******LinearOperator *Return a LinearOperator that acts as a mean value filter The vmult() functions of this matrix subtract the mean values of the vector. *The function takes an[2.x.114] object[2.x.115] as an argument to initialize the[2.x.116] and[2.x.117] objects of the LinearOperator object. ***[2.x.118] **[0.x.35] *[2.x.119] LinearOperator *Return a LinearOperator that acts as a mean value filter. The vmult() functions of this matrix subtract the mean values of the vector. *The function takes a LinearOperator[2.x.120] and uses its range initializer to create an mean value filter operator.The function also ensures that the underlying Payload matches that of the input[2.x.121] ***[2.x.122] **[0.x.36] *A helper class that is responsible for the initialization of a vector to be directly usable as the destination parameter</div></div>
<div class="ttc" id="aclassSparseMatrix_html"><div class="ttname"><a href="classSparseMatrix.html">SparseMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_aafea668ad0c451ac7a0fae0f558c36d7"><div class="ttname"><a href="distributed__0_8txt.html#aafea668ad0c451ac7a0fae0f558c36d7">cells</a></div><div class="ttdeci">in the area occupied by these artificial cells</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00037">distributed_0.txt:37</a></div></div>
<div class="ttc" id="aclassBlockVectorBase_html_ae05a0e26814f032473ed2ef66da018bd"><div class="ttname"><a href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">BlockVectorBase::block</a></div><div class="ttdeci">BlockType &amp; block(const unsigned int i)</div></div>
<div class="ttc" id="amapping__info__0_8txt_html_aaed09e22b1fee38bd2273caeedfb0e90"><div class="ttname"><a href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a></div><div class="ttdeci">*An enum to identify various types of cells and faces The most general type is what we typically compute in the FEValues context but for many geometries we can save significant storage ***The cell or face is Cartesian **The cell or face can be described with an affine mapping **The face is i the normal factor on a face is the same on all quadrature points This type is not assigned for cells **There is no special information available for compressing the representation of the object under consideration **Definition of a structure that stores all cached data related to the evaluated geometry from the mapping In order to support hp adaptivity and compressed storage length can be different for different rows it allows to jump at the data of individual rows similar to compressed row storage in sparse matrices We have two different start indices for fields with different sizes The first category of offsets are the indices for Jacobians of the transformation from unit to real second JxW and normal vectors We keep separate arrays for all these data structures because a user code might access only some of them In such a one array will be gone through in a contiguous order with access to all which makes it easy for the processor to prefetch data Having all data in a single array would require some strides in the access which is much more complicated for the processor to called which contains the quadrature weights and permutations of how to go through quadrature points in case of face data The latter comes in a vector for the support of hp with several data fields for the individual quadrature formulas ***Constructor Does nothing **Set up the lengths in the various members of this struct **Set up the lengths in the various members of this struct **Returns the memory consumption in bytes **Number of quadrature points applied on the given cell or face **Original one dimensional quadrature formula applied on the given cell or face **Quadrature formula applied on the given cell or face **Quadrature weights separated by dimension for use in specific situations **A cached vector of quadrature weights in the given number the evaluation of basis functions is not in the correct order if a face is not in the standard orientation to a given element This data structure is used to re order the data evaluated on quadrature points to represent the correct order **A class describing the layout of the sections in the[2.x.2] field and also includes some data that depends on the number of quadrature points in the hp context such as the inner quadrature formula and re indexing for faces that are not in the standard orientation **Collection of quadrature formulae applied on the given face *Only filled for since faces might be quadrilateral or triangle shaped **Stores the index offset into the arrays[2.x.4][2.x.5][2.x.6] and the second derivatives Note that affine cells have shorter fields of where the others have lengths equal to the number of quadrature points of the given cell **The storage of the Jacobian i the inverse and transposed Jacobians of the transformation from the unit to the real cell Indexed by[2.x.9] Contains two fields for access from both sides for interior but the default only the upper diagonal and diagonal part are needed The first index runs through the starting with the diagonal and then continuing row i and so on The second index is the spatial coordinate Indexed by[2.x.12] Contains two fields for access from both sides for interior but the default including a compression scheme for Cartesian cells where we do not need to store the full data on all points Indexed by *[2.x.16] *Clears all data fields except the descriptor vector **Returns the quadrature index for a given number of quadrature points If not in hp mode or if the index is not this function always returns index this function does not check whether the given degree is actually present **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **Returns the memory consumption in bytes **The class that stores all geometry dependent data related with cell interiors for use in the matrix free class ***Compute the information in the given cells and faces The cells are specified by the level and the index within the a mapping and several quadrature formulas are given **Update the information in the given cells and faces that is the result of a change in the given mapping keeping the quadrature formulas and other unknowns unchanged This call is only valid if[2.x.20] has been called before **Return the type of a given cell as detected during initialization **Clear all data fields in this class **Return the memory consumption of this class in bytes **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **The given update flags for computing the geometry on the cells **The given update flags for computing the geometry on the boundary faces **The given update flags for computing the geometry on the interior faces **The given update flags for computing the geometry on the faces for cell centric loops **Stores whether a cell is has constant transform data() or is whether it represents an affine whether it is a flat face where the normal vector is the same throughout the or is following the[2.x.21] variable for the cell types **The pointer to the underlying[2.x.22] object **The pointer to the first entry of mapping_collection **Reference cell type related to each quadrature and active quadrature index **Internal function to compute the geometry for the case the mapping is a MappingQ and a single quadrature formula per i it uses a polynomial description of the cell especially when several different quadrature formulas are and consumes less memory[2.x.23] tria The triangulation to be used for setup[2.x.24] cells The actual cells of the triangulation to be worked given as a tuple of the level and index within the level as used in the main initialization of the class ::x faces The description of the connectivity from faces to cells as filled in the MatrixFree class **Computes the information in the given called within initialize **Computes the information in the given called within initialize **Computes the information in the given called within initialize **Helper function to determine which update flags must be set in the internal functions to initialize all data as requested by the user **A helper class to extract either cell or face data from mapping info for use in FEEvaluationBase **A class that is used to compare floating point c</div><div class="ttdef"><b>Definition:</b> <a href="mapping__info__0_8txt_source.html#l00116">mapping_info_0.txt:116</a></div></div>
<div class="ttc" id="aclassBlockDynamicSparsityPattern_html"><div class="ttname"><a href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparsity__pattern_8h_source.html#l00549">block_sparsity_pattern.h:549</a></div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a93f65b0385560a34ec1d3c5ec5a882b8"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">Physics::Elasticity::Kinematics::d</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; d(const Tensor&lt; 2, dim, Number &gt; &amp;F, const Tensor&lt; 2, dim, Number &gt; &amp;dF_dt)</div></div>
<div class="ttc" id="agroup__Vectors_html_ga81dcfa5c77bdd426603386c0844149ae"><div class="ttname"><a href="group__Vectors.html#ga81dcfa5c77bdd426603386c0844149ae">Vector::size</a></div><div class="ttdeci">size_type size() const</div></div>
<div class="ttc" id="alac_2affine__constraints_8h_html"><div class="ttname"><a href="lac_2affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_ac2b339f054fd752a401e197097db8cfe"><div class="ttname"><a href="distributed__0_8txt.html#ac2b339f054fd752a401e197097db8cfe">solution</a></div><div class="ttdeci">********clusters ***deal II can use multiple machines connected via MPI to parallelize in addition to the parallelization within a shared memory machine discussed in the[2.x.4] module There are essentially two ways to utilize multiple but only a share of the global sparsity and solution vector is stored on each machine ****The mesh and DoF handler are also i e each processor stores only a share of the cells and degrees of freedom No processor has knowledge of the entire or solution</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00025">distributed_0.txt:25</a></div></div>
<div class="ttc" id="aparameter__handler__0_8txt_html_ad919e2b915d8e8226aef004c2d8399a8"><div class="ttname"><a href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">exception</a></div><div class="ttdeci">since default values may change in the process of program you cannot know the values of parameters not specified in the input file ****It is often convenient to have something happen as soon as a parameter value is read This could be a check that it is valid that a file that is listed in the parameter file exists **or to initiate something else in such as setting a variable outside the this action could also be initiated once all parameters are read via but it is sometimes[1.x.19] to do it right away *This is facilitated by the and can then do whatever they want with it **e save it somewhere outside the ParameterHandler in C one doesn t usually pass around the address of a but an action can be a function like object(taking a string as argument) that results from calling such as a[1.x.20] that has the form **[1.x.21] *and that is attached to a specific parameter. *A typical example of such an action would be as follows the content of the file equals the default value of the parameter the contents of files are never changed after declaration of a parameter a directory in this file system may not have a file called[2.x.20] in it In that the directory represents a subsection as declared and the directory s name will correspond to the name of the subsection It will then have no files in it at but it may have further directories in the code above will lead to a hierarchical representation of data that looks like this(the content of files is indicated at the right in a different font) this is only used when creating output for exceptions If non empty[2.x.35] is the ParameterHandler object will stop parsing lines after encountering[2.x.36] This is handy when adding extra data that shall be parsed manually If[2.x.37] the parameter handler will skip undefined sections and entries This is useful for partially parsing a parameter for example to obtain only the spatial dimension of the problem By default all entries and subsections are expected to be declared The function sets the value of all parameters it encounters in the input file to the provided value Parameters not explicitly listed in the input file are left at the value they previously which will be the default value provided to and for each parameter all associated actions that may previously have been set by or if an associated action throws an exception</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler__0_8txt_source.html#l00241">parameter_handler_0.txt:241</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a6ed7c846331069f406b8c9933c37fda4"><div class="ttname"><a href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandler&lt; dim, spacedim &gt; &amp;)</div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00266">dof_handler.h:266</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a></div><div class="ttdeci">@ none</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00216">dof_tools.h:216</a></div></div>
<div class="ttc" id="agrid__generator__0_8txt_html_a9b4242d26e55620fe01906af39994d64"><div class="ttname"><a href="grid__generator__0_8txt.html#a9b4242d26e55620fe01906af39994d64">subdivisions</a></div><div class="ttdeci">see also[2.x.49] the glossary entry on colorization in[2.x.50] colorization does not set[2.x.51] boundary_ids but only because each boundary edge is shared between two faces and it is not clear how the boundary id of an edge should be set in that case if[2.x.52] is[2.x.53] material ids are assigned to the cells according to the octant their center is a cell with center assuming that the center of the hyper rectangle lies at the origin No manifold id is set for the cells If[2.x.54]&lt;[2.x.55] this will create a[2.x.56] dimensional object in the first[2.x.57] coordinate directions embedded into the[2.x.58] dimensional space with the remaining entries set to zero. For example, a&lt; tt &gt; Triangulation[2.x.59] will be a rectangle in the xy plane with defined by the two opposing corners[2.x.60] and[2.x.61][2.x.62] The triangulation passed as argument needs to be empty when calling this function **Create a coordinate parallel brick from the two diagonally opposite corner points[2.x.63] and[2.x.64] The number of cells in coordinate direction[2.x.65] is given by the integer&lt; tt &gt; repetitions[i]&lt;/tt &gt; To get cells with an aspect ratio different from that of the use different numbers of subdivisions</div><div class="ttdef"><b>Definition:</b> <a href="grid__generator__0_8txt_source.html#l00024">grid_generator_0.txt:24</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a></div><div class="ttdeci">@ component_is_part_of_vector</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00062">data_component_interpretation.h:62</a></div></div>
<div class="ttc" id="aclassTable_html"><div class="ttname"><a href="classTable.html">Table</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00033">array_view.h:33</a></div></div>
<div class="ttc" id="anamespaceDoFRenumbering_html_a68651164485490b86d901d9ae1fbfc3b"><div class="ttname"><a href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a></div><div class="ttdeci">void Cuthill_McKee(DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const bool reversed_numbering=false, const bool use_constraints=false, const std::vector&lt; types::global_dof_index &gt; &amp;starting_indices=std::vector&lt; types::global_dof_index &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering_8cc_source.html#l00366">dof_renumbering.cc:366</a></div></div>
<div class="ttc" id="agroup__LAOperators_html_ga76acca911f21089cd3bb385d20ccc995"><div class="ttname"><a href="group__LAOperators.html#ga76acca911f21089cd3bb385d20ccc995">LinearOperator::schur_complement</a></div><div class="ttdeci">LinearOperator&lt; Range_2, Domain_2, Payload &gt; schur_complement(const LinearOperator&lt; Domain_1, Range_1, Payload &gt; &amp;A_inv, const LinearOperator&lt; Range_1, Domain_2, Payload &gt; &amp;B, const LinearOperator&lt; Range_2, Domain_1, Payload &gt; &amp;C, const LinearOperator&lt; Range_2, Domain_2, Payload &gt; &amp;D)</div><div class="ttdef"><b>Definition:</b> <a href="lac_2schur__complement_8h_source.html#l00244">schur_complement.h:244</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00116">fe_update_flags.h:116</a></div></div>
<div class="ttc" id="aclassGrowingVectorMemory_html"><div class="ttname"><a href="classGrowingVectorMemory.html">GrowingVectorMemory</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2lac_2vector__memory_8h_source.html#l00304">vector_memory.h:304</a></div></div>
<div class="ttc" id="aclassSubscriptor_html"><div class="ttname"><a href="classSubscriptor.html">Subscriptor</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2subscriptor_8h_source.html#l00060">subscriptor.h:60</a></div></div>
<div class="ttc" id="apolynomials__abf__0_8txt_html_a7a716deb19e461cf8ba2a26e01c6a908"><div class="ttname"><a href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a></div><div class="ttdeci">*This class implements the[1.x.0] vector valued Arnold Boffi Falk polynomials as described in the article by Arnold Boffi SIAM J Numer Anal pp **The ABF polynomials are constructed such that the divergence is in the tensor product polynomial space[1.x.1] the polynomial order of each component must be two orders higher in the corresponding yielding the polynomial spaces[1.x.2] and[1.x.3] in resp ******Constructor Creates all basis functions for Raviart Thomas polynomials of given degree[2.x.1] k</div><div class="ttdef"><b>Definition:</b> <a href="polynomials__abf__0_8txt_source.html#l00013">polynomials_abf_0.txt:13</a></div></div>
<div class="ttc" id="aclassSparseILU_html"><div class="ttname"><a href="classSparseILU.html">SparseILU&lt; double &gt;</a></div></div>
<div class="ttc" id="anumerics_2vector__tools_8h_html"><div class="ttname"><a href="numerics_2vector__tools_8h.html">vector_tools.h</a></div></div>
<div class="ttc" id="abase_2function_8h_html"><div class="ttname"><a href="base_2function_8h.html">function.h</a></div></div>
<div class="ttc" id="amultithreading__0_8txt_html_a33468e75b7ea6d2e64b7e88c6ff1217a"><div class="ttname"><a href="multithreading__0_8txt.html#a33468e75b7ea6d2e64b7e88c6ff1217a">of</a></div><div class="ttdeci">namespace are implemented the way they are More information on their implementation can be found in the[2.x.72] WorkStream paper To see the WorkStream class used in practice on tasks like the ones outlined above take a look at or[2.x.78] tutorial programs *To begin given the brief description the way the[2.x.79] function could then be written is like this(note that this is not quite the correct syntax, as will be described below) we recycle these objects after they have been used by[2.x.101] and feed them back into another instance of[2.x.102]</div><div class="ttdef"><b>Definition:</b> <a href="multithreading__0_8txt_source.html#l00171">multithreading_0.txt:171</a></div></div>
<div class="ttc" id="aclassVector_html_a8ee1b8309a7a9ecf109c8a7116733ef8"><div class="ttname"><a href="classVector.html#a8ee1b8309a7a9ecf109c8a7116733ef8">Vector::l2_norm</a></div><div class="ttdeci">real_type l2_norm() const</div></div>
<div class="ttc" id="anamespacetypes_html_aaf4eb6ec214fa642dfd956f11a9cd2d7"><div class="ttname"><a href="namespacetypes.html#aaf4eb6ec214fa642dfd956f11a9cd2d7">types::boundary_id</a></div><div class="ttdeci">unsigned int boundary_id</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00117">types.h:117</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a373fbdacd8c486e675b8d2bff8943192"><div class="ttname"><a href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global</a></div><div class="ttdeci">void distribute_local_to_global(const InVector &amp;local_vector, const std::vector&lt; size_type &gt; &amp;local_dof_indices, OutVector &amp;global_vector) const</div><div class="ttdef"><b>Definition:</b> <a href="lac_2affine__constraints_8h_source.html#l02250">affine_constraints.h:2250</a></div></div>
<div class="ttc" id="abase_2logstream_8h_html"><div class="ttname"><a href="base_2logstream_8h.html">logstream.h</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a></div><div class="ttdeci">@ always</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00221">dof_tools.h:221</a></div></div>
<div class="ttc" id="aconstraints__0_8txt_html_a5abc878123b65e2a7a16e57bba0e282e"><div class="ttname"><a href="constraints__0_8txt.html#a5abc878123b65e2a7a16e57bba0e282e">constraints</a></div><div class="ttdeci">******This module deals with constraints on degrees of freedom The central class to deal with constraints is the AffineConstraints class *Constraints typically come from several for one usually enforces them by requiring that degrees of freedom on the boundary have particular for example[2.x.3] if the boundary condition[2.x.4] requires that the finite element solution[2.x.5] at the location of degree of freedom has the value Such constraints are generated by those versions of the[2.x.6] function that take a AffineConstraints for example no normal as happens in flow problems and is handled by the[2.x.11] function or prescribed tangential as happens in electromagnetic problems and is handled by the[2.x.13] function For the former imagine for example that we are at at vertex where the normal vector has the form[2.x.14] and that and[2.x.17] components of the flow field at this vertex are associated with degrees of and Then the no normal flux condition means that we need to have the condition[2.x.18] The prescribed tangential component leads to similar constraints though there is often something on the right hand side ****If you have hanging node constraints</div><div class="ttdef"><b>Definition:</b> <a href="constraints__0_8txt_source.html#l00020">constraints_0.txt:20</a></div></div>
<div class="ttc" id="aclassKellyErrorEstimator_html_aa0917e696d4f8ddb983223a68c512357"><div class="ttname"><a href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a></div><div class="ttdeci">static void estimate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim - 1 &gt; &amp;quadrature, const std::map&lt; types::boundary_id, const Function&lt; spacedim, typename InputVector::value_type &gt; * &gt; &amp;neumann_bc, const InputVector &amp;solution, Vector&lt; float &gt; &amp;error, const ComponentMask &amp;component_mask=ComponentMask(), const Function&lt; spacedim &gt; *coefficients=nullptr, const unsigned int n_threads=numbers::invalid_unsigned_int, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id, const types::material_id material_id=numbers::invalid_material_id, const Strategy strategy=cell_diameter_over_24)</div></div>
<div class="ttc" id="anumerics_2matrix__tools_8h_html"><div class="ttname"><a href="numerics_2matrix__tools_8h.html">matrix_tools.h</a></div></div>
<div class="ttc" id="aclassDataOutInterface_html_acad99726038e4fca7f605fdffb3317e4"><div class="ttname"><a href="classDataOutInterface.html#acad99726038e4fca7f605fdffb3317e4">DataOutInterface::write_vtk</a></div><div class="ttdeci">void write_vtk(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07221">data_out_base.cc:7221</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Vector_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00140">fe_values_extractors.h:140</a></div></div>
<div class="ttc" id="amapping__fe__0_8txt_html_a0af9c36aca1d2fa34a8615b4521ad4de"><div class="ttname"><a href="mapping__fe__0_8txt.html#a0af9c36aca1d2fa34a8615b4521ad4de">map</a></div><div class="ttdeci">where is the first fundamental form of the map</div><div class="ttdef"><b>Definition:</b> <a href="mapping__fe__0_8txt_source.html#l00084">mapping_fe_0.txt:84</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga0d685aad996180f9851183ae3e29019a"><div class="ttname"><a href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">StandardExceptions::ExcIndexRange</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcIndexRange(int arg1, int arg2, int arg3)</div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
<div class="ttc" id="amg__transfer__0_8txt_html_a6b401cd9c6154fc787311f58ab910002"><div class="ttname"><a href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div><div class="ttdeci">MGTransferBase is defined in mg_base h ***Implementation of transfer between the global vectors and the multigrid levels for use in the derived class MGTransferPrebuilt and other classes ***Reset the object to the state it had right after the default constructor **Transfer from a vector on the global grid to vectors defined on each of the levels separately for the active degrees of freedom In for a globally refined mesh only the finest level in[2.x.0] is filled as a plain copy of[2.x.1] All the other level objects are left untouched **Transfer from multi level vector to normal vector Copies data from active portions of an MGVector into the respective positions of a&lt; tt &gt; Vector&lt; number &gt;&lt;/tt &gt; In order to keep the result constrained degrees of freedom are set to zero **Add a multi level vector to a normal vector Works as the previous but probably not for continuous elements **If this object operates on BlockVector we need to describe how the individual vector components are mapped to the blocks of a vector For for a Stokes we have dim vector components for velocity and pressure</div><div class="ttdef"><b>Definition:</b> <a href="mg__transfer__0_8txt_source.html#l00017">mg_transfer_0.txt:17</a></div></div>
<div class="ttc" id="avector__tools__point__value__0_8txt_html_ac7a5c2ceb5c739d5b51cc7e0eee8100a"><div class="ttname"><a href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a></div><div class="ttdeci">*Assembling of right hand sides **Create a right hand side vector for a point source at point[2.x.1] In other it creates a vector[2.x.2] so that[2.x.3] where[2.x.4] are the shape functions described by[2.x.5] and[2.x.6] is the point at which the delta function is located Prior content of the given[2.x.7] vector is deleted This function is for the case of a scalar finite element This function is typically used in one of these two with different values for right hand sides or and then evaluate the solution at the same point every time You could do this by calling[2.x.8] after each solve</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__point__value__0_8txt_source.html#l00015">vector_tools_point_value_0.txt:15</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a></div><div class="ttdeci">@ component_is_scalar</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00055">data_component_interpretation.h:55</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_a796721b56b3a90e4e3973c7caae4c3d8"><div class="ttname"><a href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; count_dofs_per_fe_block(const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::vector&lt; unsigned int &gt; &amp;target_block=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01943">dof_tools.cc:1943</a></div></div>
<div class="ttc" id="avector__valued__0_8txt_html_a6028f0069f2b7666bdc24eaad7d716b2"><div class="ttname"><a href="vector__valued__0_8txt.html#a6028f0069f2b7666bdc24eaad7d716b2">difference</a></div><div class="ttdeci">this is actually not a significant difference</div><div class="ttdef"><b>Definition:</b> <a href="vector__valued__0_8txt_source.html#l00018">vector_valued_0.txt:18</a></div></div>
<div class="ttc" id="alac_2sparse__ilu_8h_html"><div class="ttname"><a href="lac_2sparse__ilu_8h.html">sparse_ilu.h</a></div></div>
<div class="ttc" id="aclassFiniteElement_html_a86644fe67824373cd51e9ff7fca94f8c"><div class="ttname"><a href="classFiniteElement.html#a86644fe67824373cd51e9ff7fca94f8c">FiniteElement::system_to_component_index</a></div><div class="ttdeci">std::pair&lt; unsigned int, unsigned int &gt; system_to_component_index(const unsigned int index) const</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2fe_2fe_8h_source.html#l03180">fe.h:3180</a></div></div>
<div class="ttc" id="aclassSolverGMRES_html"><div class="ttname"><a href="classSolverGMRES.html">SolverGMRES</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__gmres_8h_source.html#l00168">solver_gmres.h:168</a></div></div>
<div class="ttc" id="aclassBoundaryValues_html_a45af33d412a06517009ba6f342340256"><div class="ttname"><a href="classBoundaryValues.html#a45af33d412a06517009ba6f342340256">BoundaryValues::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-4_8cc_source.html#l00106">step-4.cc:106</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_ac76417d7404b75cf53c732f456e6e971"><div class="ttname"><a href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a></div><div class="ttdeci">void subdivided_hyper_rectangle(Triangulation&lt; dim, spacedim &gt; &amp;tria, const std::vector&lt; unsigned int &gt; &amp;repetitions, const Point&lt; dim &gt; &amp;p1, const Point&lt; dim &gt; &amp;p2, const bool colorize=false)</div></div>
<div class="ttc" id="aclassBoundaryValues_html"><div class="ttname"><a href="classBoundaryValues.html">BoundaryValues</a></div><div class="ttdef"><b>Definition:</b> <a href="step-4_8cc_source.html#l00086">step-4.cc:86</a></div></div>
<div class="ttc" id="anamespaceStep8_html_a8cfe56efd5e932e7421d357e26eab267"><div class="ttname"><a href="namespaceStep8.html#a8cfe56efd5e932e7421d357e26eab267">Step8::right_hand_side</a></div><div class="ttdeci">void right_hand_side(const std::vector&lt; Point&lt; dim &gt;&gt; &amp;points, std::vector&lt; Tensor&lt; 1, dim &gt;&gt; &amp;values)</div><div class="ttdef"><b>Definition:</b> <a href="step-8_8cc_source.html#l00090">step-8.cc:90</a></div></div>
<div class="ttc" id="aclassDataOut_html_a087f63e22f0614bca326dbdca288c646"><div class="ttname"><a href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01071">data_out.cc:1071</a></div></div>
<div class="ttc" id="ablock__indices__0_8txt_html_a387c467104a32f5b4363dfeb99fb50d9"><div class="ttname"><a href="block__indices__0_8txt.html#a387c467104a32f5b4363dfeb99fb50d9">Block</a></div><div class="ttdeci">*BlockIndices represents a range of it provides the ability to translate between global indices and the indices[1.x.0] a block This class is used for example in the BlockVector BlockSparsityPattern and BlockMatrixBase classes *The information that can be obtained from this class falls into two groups First it is possible to query the global size of the index and the number of blocks and their this class manages the conversion of global indices to the local indices within this block and the other way around This is required for example when you address a global element in a block vector and want to know within which block this is and which index within this block it corresponds to It is also useful if a matrix is composed of several blocks where you have to translate global row and column indices to local ones *** Block(linear algebra)&quot; * * [0.x.1]* Declare the type for container size. * [0.x.2]* Default const ructor. Initialize for zero blocks. * [0.x.3]* Constructor. Initialize the number of entries in each block [2.x.4] as &lt;tt&gt;block_sizes[i]&lt;/tt&gt;. The number of blocks will be the size of [2.x.5] block_sizes. * [0.x.4]* Move const ructor. Initialize a new object by stealing the internal data of another BlockIndices object. * [0.x.5]* Copy const ructor. * [0.x.6]* Specialized const ructor for a structure with blocks of equal size. * [0.x.7]* Reinitialize the number of blocks and assign each block the same number of elements. * [0.x.8]* Reinitialize the number of indices within each block from the given argument. The number of blocks will be adjusted to the size of &lt;tt&gt;block_sizes&lt;/tt&gt; and the size of block [2.x.6] is set to &lt;tt&gt;block_sizes[i]&lt;/tt&gt;. * [0.x.9]* Add another block of given size to the end of the block structure. * [0.x.10]* [2.x.7] Size information * [0.x.11]* Number of blocks in index field. * [0.x.12]* Return the total number of indices accumulated over all blocks</div></div>
<div class="ttc" id="anamespaceDoFRenumbering_html_a52c1941406d1ce2937e29a46edf111f4"><div class="ttname"><a href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a></div><div class="ttdeci">void component_wise(DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const std::vector&lt; unsigned int &gt; &amp;target_component=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering_8cc_source.html#l00681">dof_renumbering.cc:681</a></div></div>
<div class="ttc" id="ageometry__info__0_8txt_html_a30a552b07accf65da90f851e25d14d1c"><div class="ttname"><a href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div><div class="ttdeci">3, where it offers following possibilities:a face(quad) being refined in x- or y-direction(in the face-intern coordinate system) separately,([2.x.79] or([2.x.80] which corresponds to([2.x.81]). Additionally, it offers the possibilities a face can have through repeated anisotropic refinement steps performed on one of the two neighboring cells. It might be possible for example, that a face(quad) is refined with[2.x.82] and afterwards the left child is again refined with[2.x.83], so that there are three active subfaces. Note, however, that only refinement cases are allowed such that each line on a face between two hexes has not more than one hanging node. Furthermore, it is not allowed that two neighboring hexes are refined such that one of the hexes refines the common face with[2.x.84] and the other hex refines that face with[2.x.85] . In fact,[2.x.86] takes care of this situation and ensures that each face of a refined cell is completely contained in a single face of neighboring cells. The following drawings explain the SubfacePossibilities and give the corresponding subface numbers:*[1.x.4] **[2.x.87] *[0.x.68] *Possible cases of faces being subdivided into subface. See documentation to the SubfacePossibilities&lt; 3 &gt; for more details on the subface possibilities. *[0.x.69] *A class that provides all possible cases a face(in the current space dimension[2.x.88] might be subdivided into subfaces. *[2.x.89] *[0.x.70] *Constructor. Take and store a value indicating a particular subface possibility in the list of possible situations specified in the base class. *[0.x.71] *Return the numeric value stored by this class. While the presence of this operator might seem dangerous, it is useful in cases where one would like to have code like&lt; code &gt;switch(subface_case)... case[2.x.90] ...&lt;/code &gt;, which can be written as&lt; code &gt;switch[2.x.91] Another application is to use an object of the current type as an index into an array dim</div><div class="ttdef"><b>Definition:</b> <a href="geometry__info__0_8txt_source.html#l00202">geometry_info_0.txt:202</a></div></div>
<div class="ttc" id="anamespaceStep22_html"><div class="ttname"><a href="namespaceStep22.html">Step22</a></div><div class="ttdef"><b>Definition:</b> <a href="step-22_8cc_source.html#l00060">step-22.cc:60</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a69730bc7f91dd1be17fd083a66514e73"><div class="ttname"><a href="coding__conventions__0_8txt.html#a69730bc7f91dd1be17fd083a66514e73">freedom</a></div><div class="ttdeci">their purpose is merely to keepdeal II as uniform as possible Uniformity reduces the number of bugs weproduce because we for always assume that input arguments comebefore output arguments of a function call They also simplify reading codebecause some things become clear already by looking at the style a piece ofcode is without having to look up the exact definition of something **deal II uses[2.x.2] to normalize indentation Astyle file is provided at ***Before a you should run **on each of your files This will make sure indentation is conforming to thestyle guidelines outlined in this page *This is cumbersome and more you can just run **in whatever directory you set up the library to be compiled to indent allsource files that have been changed recently If you want to make sure thatthe indenting is correct for all your you might want to set up apre commit hook One way to do is to copy[2.x.4] to[2.x.5] and make sure it isexecutable *If the system you are working on has more than one version of[2.x.6] degrees of freedom</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00018">coding_conventions_0.txt:18</a></div></div>
<div class="ttc" id="atrilinos__sparse__matrix__0_8txt_html_ab4e34663c28496ee1b07f40fd5d00fa1"><div class="ttname"><a href="trilinos__sparse__matrix__0_8txt.html#ab4e34663c28496ee1b07f40fd5d00fa1">sparsity_pattern</a></div><div class="ttdeci">all column elements of a row are stored on the same processor in any case The vector&lt; tt &gt; n_entries_per_row&lt;/tt &gt; specifies the number of entries in each row of the newly generated matrix **This function is initializes the Trilinos Epetra matrix according to the specified sparsity_pattern</div><div class="ttdef"><b>Definition:</b> <a href="trilinos__sparse__matrix__0_8txt_source.html#l00162">trilinos_sparse_matrix_0.txt:162</a></div></div>
<div class="ttc" id="aclassStep22_1_1BoundaryValues_html_a2f153a49969a599502c29c4ea80bd034"><div class="ttname"><a href="classStep22_1_1BoundaryValues.html#a2f153a49969a599502c29c4ea80bd034">Step22::BoundaryValues::vector_value</a></div><div class="ttdeci">virtual void vector_value(const Point&lt; dim &gt; &amp;p, Vector&lt; double &gt; &amp;value) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-22_8cc_source.html#l00148">step-22.cc:148</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ab2562d41bb26f362043f9719a8cd9b87"><div class="ttname"><a href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></div><div class="ttdeci">void interpolate_boundary_values(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::map&lt; types::boundary_id, const Function&lt; spacedim, number &gt; * &gt; &amp;function_map, std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a98c83a8c964d1c88f6f2493b1c2ae26f"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a98c83a8c964d1c88f6f2493b1c2ae26f">out</a></div><div class="ttdeci">and where the chemical species react with each other based on reaction coefficients that also depend nonlinearly and in complicated ways on the chemical and pressure In many the exact formulas for all of these coefficients can take several lines to write out</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00012">automatic_and_symbolic_differentiation_0.txt:12</a></div></div>
<div class="ttc" id="adofs_2dof__tools_8h_html"><div class="ttname"><a href="dofs_2dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="agrid_2grid__refinement_8h_html"><div class="ttname"><a href="grid_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a5a1bc1bb2d705b582889ebaa24bcae5c"><div class="ttname"><a href="classAffineConstraints.html#a5a1bc1bb2d705b582889ebaa24bcae5c">AffineConstraints::condense</a></div><div class="ttdeci">void condense(SparsityPattern &amp;sparsity) const</div></div>
<div class="ttc" id="afe_2fe__system_8h_html"><div class="ttname"><a href="fe_2fe__system_8h.html">fe_system.h</a></div></div>
<div class="ttc" id="alac_2precondition_8h_html"><div class="ttname"><a href="lac_2precondition_8h.html">precondition.h</a></div></div>
<div class="ttc" id="avector__valued__0_8txt_html_add141cdc4d28d06d71948acb7f0c7150"><div class="ttname"><a href="vector__valued__0_8txt.html#add141cdc4d28d06d71948acb7f0c7150">s</a></div><div class="ttdeci">each of these vectors has[2.x.174] elements containing the values of the[2.x.175] velocities and the one pressure at a quadrature point *We can use these values to then construct other things like residuals the construct is a bit awkward we have a[2.x.176] s</div><div class="ttdef"><b>Definition:</b> <a href="vector__valued__0_8txt_source.html#l00155">vector_valued_0.txt:155</a></div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00039">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="arelaxation__block__0_8txt_html_a2076fd56276055e74e230fad6edac013"><div class="ttname"><a href="relaxation__block__0_8txt.html#a2076fd56276055e74e230fad6edac013">AdditionalData</a></div><div class="ttdeci">*Base class for the implementation of overlapping multiplicative Schwarz relaxation methods and smoothers *This class uses the infrastructure provided by PreconditionBlockBase It adds functions to initialize with a block list and to do the relaxation step The actual relaxation method with the interface expected by SolverRelaxation and MGSmootherRelaxation is in the derived classes *This class allows for more general relaxation methods than PreconditionBlock since the index sets may be arbitrary and overlapping while there only contiguous disjoint sets of equal size are allowed As a drawback this class cannot be used as a preconditioner since its implementation relies on a straight forward implementation of the Gauss Seidel process *Parallel computations require you to specify an initialized ghost vector in *[2.x.0] *****Define number type of matrix **Value type for inverse matrices **Declare type for container size **Parameters for block relaxation methods In addition to typical control parameters like **Constructor **The mapping from indices to blocks Each row of this pattern enumerates the indices constituting a diagonal block to be inverted **Relaxation parameter **Invert diagonal during initialization diagonal blocks are inverted on the whenever they are used While inverting blocks in advance requires more it usually saves a lot of computation See **Assume all diagonal blocks are equal to save memory If this flag is then only the first diagonal block of the matrix is inverted and stored It is then used for all other blocks note Avoid setting this true if your blocks are not in particular if their sizes differ **Choose the inversion method for the blocks **If **If **The order in which blocks should be traversed This vector can initiate several modes of then the relaxation method will be executed from first to last block[2.x.6][2.x.7] If the length is then the inner vector must have the same size as the number of blocks The relaxation method is applied in the order given in this vector[2.x.8][2.x.9] If the outer vector has length greater then the relaxation method is applied several each time in the order given by the inner vector of the corresponding index This mode can for instance be used for ADI methods and similar direction sweeps *[2.x.10][2.x.11] *Temporary ghost vector that is used in the relaxation method when performing parallel MPI computations The user is required to have this point to an initialized vector that contains all indices that appear in the[2.x.12] sa ghost values this the set of locally active level DoFs Unused when VectorType is a serial vector type like Vector&lt; double &gt; **Return the memory allocated in this object **Initialize matrix and additional information In a second the inverses of the diagonal blocks may be computed Note that AdditionalData</div><div class="ttdef"><b>Definition:</b> <a href="relaxation__block__0_8txt_source.html#l00043">relaxation_block_0.txt:43</a></div></div>
<div class="ttc" id="aclassRightHandSide_html"><div class="ttname"><a href="classRightHandSide.html">RightHandSide</a></div><div class="ttdef"><b>Definition:</b> <a href="step-4_8cc_source.html#l00076">step-4.cc:76</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_a03a2f48682e29e39f7bccc11a7d1c4d1"><div class="ttname"><a href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has degree[1.x.4]</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00003">polynomial_space_0.txt:3</a></div></div>
<div class="ttc" id="abase_2quadrature__lib_8h_html"><div class="ttname"><a href="base_2quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="anamespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">EvaluationFlags::values</a></div><div class="ttdeci">@ values</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2evaluation__flags_8h_source.html#l00055">evaluation_flags.h:55</a></div></div>
<div class="ttc" id="aclassSmartPointer_html"><div class="ttname"><a href="classSmartPointer.html">SmartPointer</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2smartpointer_8h_source.html#l00067">smartpointer.h:67</a></div></div>
<div class="ttc" id="alac_2block__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2block__sparse__matrix_8h.html">block_sparse_matrix.h</a></div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_a8f384576a64c89a6fa8352847523e340"><div class="ttname"><a href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for n_q_points</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00537">fe_evaluation_0.txt:537</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a7b3d3f295bb56d6cd6856bdc6cbe8a01"><div class="ttname"><a href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">AffineConstraints::distribute</a></div><div class="ttdeci">void distribute(VectorType &amp;vec) const</div></div>
<div class="ttc" id="adofs_2dof__renumbering_8h_html"><div class="ttname"><a href="dofs_2dof__renumbering_8h.html">dof_renumbering.h</a></div></div>
<div class="ttc" id="aclassBlockSparsityPattern_html"><div class="ttname"><a href="classBlockSparsityPattern.html">BlockSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparsity__pattern_8h_source.html#l00425">block_sparsity_pattern.h:425</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_addd15bc409c61d6f795f0132c574335b"><div class="ttname"><a href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">AffineConstraints::clear</a></div><div class="ttdeci">void clear()</div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00124">fe_update_flags.h:124</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01581">exceptions.h:1581</a></div></div>
<div class="ttc" id="alac_2block__vector_8h_html"><div class="ttname"><a href="lac_2block__vector_8h.html">block_vector.h</a></div></div>
<div class="ttc" id="ablock__sparse__matrix__ez__0_8txt_html_af734f4df74ac4822dd99a6cca7203600"><div class="ttname"><a href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a></div><div class="ttdeci">Matrix1 *[2.x.1] **A block matrix consisting of blocks of type SparseMatrixEZ *Like the other Block this matrix can be used like a when it comes to access to entries there are functions for the multiplication with BlockVector and access to the individual blocks the block s must be empty **Copy this operation is only allowed if the actual value to be assigned is zero This in order to be able to relay global indices into the matrix to indices into the subobjects Youmust *call this function each time after you have changed the size of the sub objects **Access the block with the given coordinates **Access the block with the given coordinates Version for constant objects **Return the number of blocks in a column **Return the number of blocks in a row **Return whether the object is empty It is empty if no memory is which is the same as that both dimensions are zero This function is just the concatenation of the respective call to all sub matrices **Return number of rows of this which equals the dimension of the which equals the dimension of the domain space It is the sum of the number of columns over the sub matrix blocks of this matrix Recall that the matrix is of size m() times n(). *[0.x.18] *Set the element&lt; tt &gt;(i</div></div>
<div class="ttc" id="alac_2full__matrix_8h_html"><div class="ttname"><a href="lac_2full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="alac_2solver__cg_8h_html"><div class="ttname"><a href="lac_2solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="afe__q__0_8txt_html_a1a8eaafa20c4d8c9ab128b62a984738c"><div class="ttname"><a href="fe__q__0_8txt.html#a1a8eaafa20c4d8c9ab128b62a984738c">degrees</a></div><div class="ttdeci">*Implementation of a scalar Lagrange finite element[2.x.0] that yields the finite element space of piecewise polynomials of degree[2.x.1] in each coordinate direction This class is realized using tensor product polynomials based on D Lagrange polynomials with Gauss or given support points *The standard constructor of this class takes the degree[2.x.2] of this finite element it can take a quadrature formula[2.x.3] defining the support points of the Lagrange interpolation in one coordinate direction *For more information about the&lt; tt &gt; spacedim&lt;/tt &gt; template parameter check the documentation of FiniteElement or the one of Triangulation **The constructor creates a TensorProductPolynomials object that includes the tensor product of[2.x.4] polynomials of degree[2.x.5] This[2.x.6] object provides all values and derivatives of the shape functions In case a quadrature rule is the constructor creates a TensorProductPolynomials object that includes the tensor product of[2.x.7] polynomials with the support points from *[2.x.8] Furthermore the constructor fills the[2.x.9] the[2.x.10] equidistant support points at i where one polynomial is one and all the others are zero For higher polynomial degrees</div><div class="ttdef"><b>Definition:</b> <a href="fe__q__0_8txt_source.html#l00009">fe_q_0.txt:9</a></div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="alac_2sparse__direct_8h_html"><div class="ttname"><a href="lac_2sparse__direct_8h.html">sparse_direct.h</a></div></div>
<div class="ttc" id="astep-69_8cc_html_a66a64d07b4db87c87b639bdcf7b18c82"><div class="ttname"><a href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; local_dof_indices</div><div class="ttdef"><b>Definition:</b> <a href="step-69_8cc_source.html#l00534">step-69.cc:534</a></div></div>
<div class="ttc" id="aclassFunction_html_ae316ebc05d21989d573024f8a23c49cb"><div class="ttname"><a href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">Function&lt; dim &gt;::vector_value</a></div><div class="ttdeci">virtual void vector_value(const Point&lt; dim &gt; &amp;p, Vector&lt; double &gt; &amp;values) const</div></div>
<div class="ttc" id="aclassStep22_1_1RightHandSide_html_a07b87d7025c7c5feca044c5c7d4296ef"><div class="ttname"><a href="classStep22_1_1RightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">Step22::RightHandSide::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-22_8cc_source.html#l00174">step-22.cc:174</a></div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point&lt; dim &gt;</a></div></div>
<div class="ttc" id="achunk__sparse__matrix__0_8txt_html_a59317914f0b63e3c2c7c6bd150b8ba3e"><div class="ttname"><a href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a></div><div class="ttdeci">0&lt;/tt &gt;, which sets all elements of the matrix to zero, but keep the sparsity pattern previously used. *[0.x.66] *Reinitialize the sparse matrix with the given sparsity pattern. The latter tells the matrix how many nonzero elements there need to be reserved. Regarding memory allocation, the same applies as said above. You have to make sure that the lifetime of the sparsity structure is at least as long as that of this matrix or as long as reinit(const ChunkSparsityPattern &amp;) is not called with a new sparsity structure. The elements of the matrix are set to zero by this function. *[0.x.67] *Release all memory and return to a state just like after having called the default constructor. It also forgets the sparsity pattern it was previously tied to. *[0.x.68] *[2.x.18] Information on the matrix *[0.x.69] *Return whether the object is empty. It is empty if either both dimensions are zero or no ChunkSparsityPattern is associated. *[0.x.70] *Return the dimension of the codomain(or range) space. Note that the matrix is of dimension[2.x.19] . *[0.x.71] *Return the dimension of the domain space. Note that the matrix is of dimension[2.x.20] . *[0.x.72] *Return the number of nonzero elements of this matrix. Actually, it returns the number of entries in the sparsity pattern matrix</div><div class="ttdef"><b>Definition:</b> <a href="chunk__sparse__matrix__0_8txt_source.html#l00156">chunk_sparse_matrix_0.txt:156</a></div></div>
<div class="ttc" id="aclassStep22_1_1StokesProblem_html"><div class="ttname"><a href="classStep22_1_1StokesProblem.html">Step22::StokesProblem</a></div><div class="ttdef"><b>Definition:</b> <a href="step-22_8cc_source.html#l00083">step-22.cc:83</a></div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_ad3b9cdeadeb3bcdb52af5db70c041a6e"><div class="ttname"><a href="fe__evaluation__0_8txt.html#ad3b9cdeadeb3bcdb52af5db70c041a6e">fe</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for can be different if such as FE_DGP **static The number of degrees of freedom of all components determined from the given template argument fe_degree Note that the actual number of degrees of freedom dofs_per_cell can be different if such as FE_DGP **static The number of degrees of freedom of all components determined from the given template argument fe_degree Note that the actual number of degrees of freedom dofs_per_cell can be different if such as FE_DGP **Constructor Takes all data stored in MatrixFree If applied to problems with more than one finite element or more than one quadrature formula selected during construction of[2.x.343] the appropriate component can be selected by the optional arguments[2.x.344] matrix_free Data object that contains all data[2.x.345] dof_no If matrix_free was set up with multiple DoFHandler this parameter selects to which DoFHandler AffineConstraints pair the given evaluator should be attached to[2.x.346] quad_no If matrix_free was set up with multiple Quadrature this parameter selects the appropriate number of the quadrature formula[2.x.347] first_selected_component If the dof_handler selected by dof_no uses an FESystem consisting of more than one this parameter allows for selecting the component where the current evaluation routine should start Note that one evaluator does not support combining different shape functions in different components In other the same base element of a FESystem needs to be set for the components between[2.x.348] and[2.x.349][2.x.350] active_fe_index If matrix_free was set up with DoFHandler objects with[2.x.351] this parameter selects to which DoFHandler AffineConstraints pair the given evaluator should be attached to[2.x.352] active_quad_index If matrix_free was set up with[2.x.353] this parameter selects the appropriate number of the quadrature formula **Constructor Takes all data stored in MatrixFree for a given cell which allows to automatically identify the active_fe_index and active_quad_index in case of a p adaptive strategy The rest of the arguments are the same as in the constructor above **Constructor that comes with reduced functionality and works similar as FEValues The arguments are similar to the ones passed to the constructor of with the notable difference that FEEvaluation expects a one dimensional quadrature instead of a[2.x.354] dimensional one The finite element can be both scalar or vector but this method always only selects a scalar base element at a the optional argument[2.x.356] allows to specify the index of the base element to be used for evaluation Note that the internal data structures always assume that the base element is non primitive are not supported currently As known from a call to the reinit method with a[2.x.357] is necessary to make the geometry and degrees of freedom of the current class known::If the iterator includes DoFHandler the initialization allows to also read from or write to vectors in the standard way for[2.x.359] types for one cell at a time this approach is much slower than the path with MatrixFree with MPI since index translation has to be done As only one cell at a time is this method does not vectorize over several but only possibly within the element if the evaluate integrate routines are combined inside user an object of type i the underlying mapping and quadrature points do only need to be evaluated once Make sure to not pass an optional object around when you intend to use the FEEvaluation object in parallel to the given one because otherwise the intended sharing may create race conditions **Copy constructor If FEEvaluationBase was constructed from a fe</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00555">fe_evaluation_0.txt:555</a></div></div>
<div class="ttc" id="atable__handler__0_8txt_html_a61e9964f9093088848525ca172895749"><div class="ttname"><a href="table__handler__0_8txt.html#a61e9964f9093088848525ca172895749">step</a></div><div class="ttdeci">the ConvergenceTable class does something like this *To support both the TableHandler class has a property called[1.x.4] By auto fill mode is but it can be enabled by calling set_auto_fill_mode(). If auto-fill mode is enabled we use the following algorithm call it *[2.x.18] ***If[2.x.19] then we add[2.x.20] copies of the object[2.x.21] to this column is the data type of the given[2.x.23] is a numeric then[2.x.24] is[2.x.25] is the empty string *[2.x.26] ***Add the given value to this column *Padding the column with default elements makes sure that after the addition the column has as many entries as the longest other column In other if we have skipped previous invocations of then the padding will enter default values into this column *The algorithm as described will fail if you try to skip adding values for a key if adding an element for this key is the first thing you want to do for a given iteration or time step</div><div class="ttdef"><b>Definition:</b> <a href="table__handler__0_8txt_source.html#l00070">table_handler_0.txt:70</a></div></div>
<div class="ttc" id="aclassSparseDirectUMFPACK_html"><div class="ttname"><a href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2sparse__direct_8h_source.html#l00089">sparse_direct.h:89</a></div></div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aauto__derivative__function__0_8txt_html_a870ed0ddfded063c8c8570352ef8c122"><div class="ttname"><a href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a></div><div class="ttdeci">*This class automatically computes the gradient of a function by employing numerical difference quotients This only if the user function does not provide the gradient function himself *The following example of an user defined function overloads and implements only the where the latter function employs numerical difference quotients *****If the user overloads and implements also the gradient of the users gradient function is called that the usage of the also applies to the see e g vector_value()</div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_adad35057b6e70ae37d4abe7878683d90"><div class="ttname"><a href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per the child indices of the child cells adjacent to face</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="awork__stream__0_8txt_html_a2252e3964ca906e132dfb7ffa15c79b8"><div class="ttname"><a href="work__stream__0_8txt.html#a2252e3964ca906e132dfb7ffa15c79b8">examples</a></div><div class="ttdeci">a prototypical example is assembling cell contributions to a system matrix or right hand side In many such examples</div><div class="ttdef"><b>Definition:</b> <a href="work__stream__0_8txt_source.html#l00003">work_stream_0.txt:3</a></div></div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2function_8h_source.html#l00140">function.h:140</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ac639e1db0b03fc797eca55e266afa976"><div class="ttname"><a href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per cell</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="aclassSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__control_8h_source.html#l00052">solver_control.h:52</a></div></div>
<div class="ttc" id="anamespaceEuler__DG_html_a143bc64b6fa6ced9f11c148a2af3ff09"><div class="ttname"><a href="namespaceEuler__DG.html#a143bc64b6fa6ced9f11c148a2af3ff09">Euler_DG::Number</a></div><div class="ttdeci">double Number</div><div class="ttdef"><b>Definition:</b> <a href="step-67_8cc_source.html#l00064">step-67.cc:64</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_ac00ea19562c135512a6ff275a3cf0d8f"><div class="ttname"><a href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has this class generates all dim dimensional polynomials of the where the sum and[1.x.8] is less than or equal *[1.x.9] The i e for each dim dimensional polynomial in the polynomial space it gives the indices j</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00004">polynomial_space_0.txt:4</a></div></div>
<div class="ttc" id="amg__0_8txt_html_a1dadc108ee1520717957789de4b76416"><div class="ttname"><a href="mg__0_8txt.html#a1dadc108ee1520717957789de4b76416">cycle</a></div><div class="ttdeci">****Classes that have to do with multigrid algorithms *The main class with implementation of the multigrid scheme is Multigrid with its function[2.x.1] It uses the abstract following classes in order to perform the multigrid cycle</div><div class="ttdef"><b>Definition:</b> <a href="mg__0_8txt_source.html#l00007">mg_0.txt:7</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_a33b522422da89e5c080e7405ad49d7c7"><div class="ttname"><a href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">FiniteElementData::n_dofs_per_cell</a></div><div class="ttdeci">unsigned int n_dofs_per_cell() const</div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut&lt; dim &gt;</a></div></div>
<div class="ttc" id="afunctions__0_8txt_html_af9f808a82e8c618e2e7a19dd08a9eae3"><div class="ttname"><a href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a></div><div class="ttdeci">****Functions are used in various places in deal for example to describe boundary coefficients in forcing or exact solutions Since closed form expressions for equations are often hard to pass along as function deal II uses the Function base class to describe these objects Essentially the interface of this base class requires derived classes to implement the ability to return the value of a function at one or a list of particular locations and function objects can then be used by algorithms like[2.x.1][2.x.2] and other functions *Some functions are needed again and and are therefore already provided in deal II This includes a function with a constant value</div><div class="ttdef"><b>Definition:</b> <a href="functions__0_8txt_source.html#l00007">functions_0.txt:7</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="avector__valued__0_8txt_html_aaee87206b92ccb284e9c77fa5d847637"><div class="ttname"><a href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a></div><div class="ttdeci">each of these vectors has[2.x.174] elements containing the values of the[2.x.175] velocities and the one pressure at a quadrature point *We can use these values to then construct other things like residuals the construct is a bit awkward we have a[2.x.176] which always looks strange It is also inefficient because it implies dynamic memory allocation for the outer vector as well as for all the inner vectors maybe we are only interested in the velocities</div><div class="ttdef"><b>Definition:</b> <a href="vector__valued__0_8txt_source.html#l00155">vector_valued_0.txt:155</a></div></div>
<div class="ttc" id="aclassLinearOperator_html_a030d8712cd4dbd814efbadca59c19bb3"><div class="ttname"><a href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">LinearOperator::vmult</a></div><div class="ttdeci">std::function&lt; void(Range &amp;v, const Domain &amp;u)&gt; vmult</div><div class="ttdef"><b>Definition:</b> <a href="lac_2linear__operator_8h_source.html#l00289">linear_operator.h:289</a></div></div>
<div class="ttc" id="aclassRightHandSide_html_a07b87d7025c7c5feca044c5c7d4296ef"><div class="ttname"><a href="classRightHandSide.html#a07b87d7025c7c5feca044c5c7d4296ef">RightHandSide::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-4_8cc_source.html#l00094">step-4.cc:94</a></div></div>
<div class="ttc" id="aclassAffineConstraints_html_a1611aa37f754086388ca76bcd421cce5"><div class="ttname"><a href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">AffineConstraints::close</a></div><div class="ttdeci">void close()</div></div>
<div class="ttc" id="aclassFESystem_html"><div class="ttname"><a href="classFESystem.html">FESystem&lt; dim &gt;</a></div></div>
<div class="ttc" id="adof__renumbering__0_8txt_html_a595cba3233f6837478469eb028a49c19"><div class="ttname"><a href="dof__renumbering__0_8txt.html#a595cba3233f6837478469eb028a49c19">complement</a></div><div class="ttdeci">because we solve several linear systems with the same matrix in the Schur complement</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering__0_8txt_source.html#l00053">dof_renumbering_0.txt:53</a></div></div>
<div class="ttc" id="afe_2fe__values__0_8txt_html_a15ff2e0c168966d6ae13c4faabcec165"><div class="ttname"><a href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a></div><div class="ttdeci">we have to work a bit harder to compute this information **Default constructor Creates an invalid object **Constructor for an object that represents a single scalar component of a FEValuesBase for the shape function and quadrature point selected by the arguments[2.x.27] shape_function Number of the shape function to be evaluated Note that this number runs from zero to dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__0_8txt_source.html#l00073">fe_values_0.txt:73</a></div></div>
<div class="ttc" id="adof__tools__0_8txt_html_aa623f15672a6db0f3f730a81a5b432b4"><div class="ttname"><a href="dof__tools__0_8txt.html#aa623f15672a6db0f3f730a81a5b432b4">active</a></div><div class="ttdeci">previous contents are not deleted **This function generates a matrix such that when a vector of data with as many elements as there are degrees of freedom of this component on the coarse grid is multiplied to this we obtain a vector with as many elements as there are global degrees of freedom on the fine grid All the elements of the other vector components of the finite element fields on the fine grid are not touched Triangulation of the fine grid can be distributed When called in each process has to have a copy of the coarse grid In this function returns transfer representation for a set of locally owned cells The output of this function is a compressed format that can be used to construct corresponding sparse transfer matrix ****Periodic boundary conditions *[2.x.121] *Insert this functions constrains all DoFs associated with the boundary described by[2.x.125] to the respective DoFs of the boundary described by[2.x.126] More the global DoF see below if[2.x.134] and[2.x.135] are not active this function loops recursively over the children of[2.x.136] and[2.x.137] If only one of the two faces is active</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__0_8txt_source.html#l00095">dof_tools_0.txt:95</a></div></div>
<div class="ttc" id="aparsed__convergence__table__0_8txt_html_a8a90f5ba57a42a3fd4c067e00f8b8aea"><div class="ttname"><a href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a></div><div class="ttdeci">****This class simplifies the construction of convergence tables reading the options for the generation of the table from a parameter file It provides a series of methods that can be used to compute the error given a reference exact solution or the difference between two numerical solutions or any other custom computation of the error given via[2.x.1] objects *An example usage of this class is given by ****The above code constructs a ParsedConvergenceTable that works for scalar and will produce an error table with and Linfty_norm norms of the error *Whenever a call to the methods the instance of this class inspects its parameters computes all norms specified by the parameter given at construction time possibly modified via a parameter file computes all extra column entries specified using the method and writes one row of the convergence table *Once you have finished with the a call to and to the the same code can be used to estimate the errors of mixed or multi physics e and one component for the pressure field p</div><div class="ttdef"><b>Definition:</b> <a href="parsed__convergence__table__0_8txt_source.html#l00020">parsed_convergence_table_0.txt:20</a></div></div>
<div class="ttc" id="agrid_2grid__generator_8h_html"><div class="ttname"><a href="grid_2grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="aany__data__0_8txt_html_a19ab1003fb0826e8e4d596df81fd7f84"><div class="ttname"><a href="any__data__0_8txt.html#a19ab1003fb0826e8e4d596df81fd7f84">type</a></div><div class="ttdeci">*Store any amount of any type of data accessible by an identifier string try to convert it to&lt; tt &gt; type&lt;/tt &gt; and return it This function throws an exception if either the name does not exist or if the conversion fails If such an exception is not desired use try to convert it to&lt; tt &gt; type&lt;/tt &gt; and return it This function throws an exception if either the name does not exist or if the conversion fails If such an exception is not desired use this function equals it forces read only access to the data In it throws an exception if the object is not found or cannot be converted to type If such an exception is not desired use the logic of access becomes fairly complicated the standard read function may depending on whether it was const a pointer or a regular pointer This function fixes the logic and ascertains that the object does not become by accident **Perform the same action as but do not throw an exception if the pointer does not exist Return a null pointer instead ***This function tries to find the name in the list and return a pointer to the associated object If either the name is not found or the object cannot be converted to the return type</div><div class="ttdef"><b>Definition:</b> <a href="any__data__0_8txt_source.html#l00022">any_data_0.txt:22</a></div></div>
<div class="ttc" id="aclassStep22_1_1RightHandSide_html_a6deb4e3cb5cc0913313f6a02d8d818b1"><div class="ttname"><a href="classStep22_1_1RightHandSide.html#a6deb4e3cb5cc0913313f6a02d8d818b1">Step22::RightHandSide::vector_value</a></div><div class="ttdeci">virtual void vector_value(const Point&lt; dim &gt; &amp;p, Vector&lt; double &gt; &amp;value) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-22_8cc_source.html#l00182">step-22.cc:182</a></div></div>
<div class="ttc" id="atable__0_8txt_html_aa889bb34debce4db8c9ace2f875bdf0d"><div class="ttname"><a href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a></div><div class="ttdeci">tables that store three or more dimensional then there is nothing you can do about the size of these if your program is parallelized via then a typical first implementation would create a table object on every process and fill it on every MPI process by reading the data from a file This is inefficient from two the data stored on every process is the and while every process needs to be able to read from a it is not necessary that every process stores its own either by re creating a copy of the table in the other processes memory space if by creating copies in shared memory once for all processes located on each of the machines used by the MPI job ******Integer type used to count the number of elements in this container **Default constructor Set all dimensions to zero **Constructor Initialize the array with the given dimensions in each index component **Constructor Initialize the array with the given dimensions in each index component</div><div class="ttdef"><b>Definition:</b> <a href="table__0_8txt_source.html#l00083">table_0.txt:83</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a02f5aa616d7b0799c538fe77d6c6c795"><div class="ttname"><a href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a></div><div class="ttdeci">i e</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00028">coding_conventions_0.txt:28</a></div></div>
<div class="ttc" id="aclassBlockSparseMatrix_html"><div class="ttname"><a href="classBlockSparseMatrix.html">BlockSparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparse__matrix_8h_source.html#l00050">block_sparse_matrix.h:50</a></div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
