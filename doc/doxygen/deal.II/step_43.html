<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_43.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-43 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="10.0.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 10.0.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-43 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_31.html">step-31</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Advectiondominatedtwophaseflowmathematicalmodel">Advection-dominated two-phase flow mathematical model.</a>
        <li><a href="#Adaptiveoperatorsplittingandtimestepping">Adaptive operator splitting and time stepping.</a>
        <li><a href="#Timediscretization">Time discretization.</a>
        <li><a href="#Weakformspacediscretizationforthepressurevelocitypart">Weak form, space discretization for the pressure-velocity part.</a>
        <li><a href="#Stabilizationweakformandspacediscretizationforthesaturationtransportequation">Stabilization, weak form and space discretization for the saturation transport equation.</a>
        <li><a href="#Adaptivemeshrefinement">Adaptive mesh refinement.</a>
        <li><a href="#Linearsystemanditspreconditioning">Linear system and its preconditioning.</a>
        <li><a href="#Thetestcases">The test cases.</a>
        <li><a href="#Listofreferences">List of references</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a>
        <li><a href="#Boundaryandinitialvalueclasses">Boundary and initial value classes</a>
        <li><a href="#Permeabilitymodels">Permeability models</a>
        <li><a href="#Physicalquantities">Physical quantities</a>
        <li><a href="#Helperclassesforsolversandpreconditioners">Helper classes for solvers and preconditioners</a>
        <li><a href="#TheTwoPhaseFlowProblemclass">The TwoPhaseFlowProblem class</a>
        <li><a href="#TwoPhaseFlowProblemdimTwoPhaseFlowProblem">TwoPhaseFlowProblem<dim>::TwoPhaseFlowProblem</a>
        <li><a href="#TwoPhaseFlowProblemdimsetup_dofs">TwoPhaseFlowProblem<dim>::setup_dofs</a>
        <li><a href="#Assemblingmatricesandpreconditioners">Assembling matrices and preconditioners</a>
      <ul>
        <li><a href="#TwoPhaseFlowProblemdimassemble_darcy_preconditioner">TwoPhaseFlowProblem<dim>::assemble_darcy_preconditioner</a>
        <li><a href="#TwoPhaseFlowProblemdimbuild_darcy_preconditioner">TwoPhaseFlowProblem<dim>::build_darcy_preconditioner</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_darcy_system">TwoPhaseFlowProblem<dim>::assemble_darcy_system</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_system">TwoPhaseFlowProblem<dim>::assemble_saturation_system</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_matrix">TwoPhaseFlowProblem<dim>::assemble_saturation_matrix</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs_cell_term">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs_cell_term</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs_boundary_term">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs_boundary_term</a>
      </ul>
        <li><a href="#TwoPhaseFlowProblemdimsolve">TwoPhaseFlowProblem<dim>::solve</a>
        <li><a href="#TwoPhaseFlowProblemdimrefine_mesh">TwoPhaseFlowProblem<dim>::refine_mesh</a>
        <li><a href="#TwoPhaseFlowProblemdimoutput_results">TwoPhaseFlowProblem<dim>::output_results</a>
        <li><a href="#Toolfunctions">Tool functions</a>
      <ul>
        <li><a href="#TwoPhaseFlowProblemdimdetermine_whether_to_solve_for_pressure_and_velocity">TwoPhaseFlowProblem<dim>::determine_whether_to_solve_for_pressure_and_velocity</a>
        <li><a href="#TwoPhaseFlowProblemdimproject_back_saturation">TwoPhaseFlowProblem<dim>::project_back_saturation</a>
        <li><a href="#TwoPhaseFlowProblemdimget_max_u_F_prime">TwoPhaseFlowProblem<dim>::get_max_u_F_prime</a>
        <li><a href="#TwoPhaseFlowProblemdimget_extrapolated_saturation_range">TwoPhaseFlowProblem<dim>::get_extrapolated_saturation_range</a>
        <li><a href="#TwoPhaseFlowProblemdimcompute_viscosity">TwoPhaseFlowProblem<dim>::compute_viscosity</a>
      </ul>
        <li><a href="#TwoPhaseFlowProblemdimrun">TwoPhaseFlowProblem<dim>::run</a>
        <li><a href="#Thecodemaincodefunction">The <code>main()</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
</p>
<p><em> This program was contributed by Chih-Che Chueh (University of Victoria) and Wolfgang Bangerth. Results from this program are used and discussed in the following publications (in particular in the second one):</p><ul>
<li>Chih-Che Chueh, Marc Secanell, Wolfgang Bangerth, Ned Djilali. Multi-level adaptive simulation of transient two-phase flow in heterogeneous porous media. Computers &amp; Fluids, 39:1585-1596, 2010</li>
<li>Chih-Che Chueh, Ned Djilali, Wolfgang Bangerth. An h-adaptive operator splitting method for two-phase flow in 3D heterogeneous porous media. SIAM Journal on Scientific Computing, 35:B149-B175, 2013.</li>
</ul>
<p></em></p>
<p><em>The implementation discussed here uses and extends parts of the <a class="el" href="step_21.html">step-21</a> and <a class="el" href="step_31.html">step-31</a> tutorial programs.</em></p>
<p><em>The work of the Chih-Che Chueh was funded through the Canada Research Chairs Program and the MITACS Network of Centres of Excellence. Parts of the work by Wolfgang Bangerth were funded through Award No. KUS-C1-016-04, made by the King Abdullah University of Science and Technology, and through an Alfred P. Sloan Research Fellowship. This material is also in parts based upon work supported by the National Science Foundation under Award No. EAR-0426271 and The California Institute of Technology; and in a continuation by the National Science Foundation under Award No. EAR-0949446 and The University of California &ndash; Davis. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation, The California Institute of Technology, or of The University of California &ndash; Davis. </em></p>
<p><a class="anchor" id="Introduction"></a><a class="anchor" id="Intro"></a> </p><h1>Introduction</h1>
<p>The simulation of multiphase flow in porous media is a ubiquitous problem, and we have previously addressed it already in some form in <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a>. However, as was easy to see there, it faces two major difficulties: numerical accuracy and efficiency. The first is easy to see in the stationary solver <a class="el" href="step_20.html">step-20</a>: using lowest order Raviart-Thomas elements can not be expected to yield highly accurate solutions. We need more accurate methods. The second reason is apparent from the time dependent <a class="el" href="step_21.html">step-21</a>: that program is excruciatingly slow, and there is no hope to get highly accurate solutions in 3d within reasonable time frames.</p>
<p>In this program, in order to overcome these two problems, there are five areas which we are trying to improve for a high performance simulator:</p>
<ul>
<li>
Higher order spatial discretizations </li>
<li>
Adaptive mesh refinement </li>
<li>
Adaptive time stepping </li>
<li>
Operator splitting </li>
<li>
Efficient solver and preconditioning </li>
</ul>
<p>Much inspiration for this program comes from <a class="el" href="step_31.html">step-31</a> but several of the techniques discussed here are original.</p>
<p><a class="anchor" id="Advectiondominatedtwophaseflowmathematicalmodel"></a></p><h3>Advection-dominated two-phase flow mathematical model.</h3>
<p>We consider the flow of a two-phase immiscible, incompressible fluid. Capillary and gravity effects are neglected, and viscous effects are assumed dominant. The governing equations for such a flow that are identical to those used in <a class="el" href="step_21.html">step-21</a> and are </p><p class="formulaDsp">
\begin{align*} \mathbf{u}_t &amp;= - \mathbf{K} \lambda_t \left(S\right) \nabla p, \\ \nabla \cdot \mathbf{u}_t &amp;= q, \\ \epsilon \frac{\partial S}{\partial t} + \nabla \cdot \left( \mathbf{u}_t F\left( S \right) \right)&amp;=0, \end{align*}
</p>
<p> where \(S\) is the saturation (volume fraction between zero and one) of the second (wetting) phase, \(p\) is the pressure, \(\mathbf{K}\) is the permeability tensor, \(\lambda_t\) is the total mobility, \(\epsilon\) is the porosity, \(F\) is the fractional flow of the wetting phase, \(q\) is the source term and \(\mathbf{u}_t\) is the total velocity. The total mobility, fractional flow of the wetting phase and total velocity are respectively given by </p><p class="formulaDsp">
\begin{align*} \lambda_t(S)&amp;= \lambda_w + \lambda_{nw} = \frac{k_{rw}(S)}{\mu_w} + \frac{k_{rnw}(S)}{\mu_{nw}}, \\ F(S) &amp;= \frac{\lambda_w}{\lambda_t} = \frac{\lambda_w}{\lambda_w + \lambda_{nw}} = \frac{k_{rw}(S)/\mu_w}{k_{rw}(S)/\mu_w + k_{rnw}(S)/\mu_{nw}}, \\ \mathbf{u}_t &amp;= \mathbf{u}_w + \mathbf{u}_{nw} = -\lambda_t(S)\mathbf{K} \cdot \nabla p, \end{align*}
</p>
<p> where subscripts \(w, nw\) represent the wetting and non-wetting phases, respectively.</p>
<p>For convenience, the porosity \(\epsilon\) in the saturation equation, which can be considered a scaling factor for the time variable, is set to one. Following a commonly used prescription for the dependence of the relative permeabilities \(k_{rw}\) and \(k_{rnw}\) on saturation, we use </p><p class="formulaDsp">
\begin{align*} k_{rw} &amp;= S^2, \qquad&amp;\qquad k_{rnw} &amp;= \left( 1-S \right)^2. \end{align*}
</p>
<p>The porous media equations above are augmented by initial conditions for the saturation and boundary conditions for the pressure. Since saturation and the gradient of the pressure uniquely determine the velocity, no boundary conditions are necessary for the velocity. Since the flow equations do not contain time derivatives, initial conditions for the velocity and pressure variables are not required. The flow field separates the boundary into inflow or outflow parts. Specifically, </p><p class="formulaDsp">
\[ \mathbf{\Gamma}_{in}(t) = \left\{\mathbf{x} \in \partial \Omega:\mathbf{n} \cdot \mathbf{u}_t&lt;0\right\}, \]
</p>
<p> and we arrive at a complete model by also imposing boundary values for the saturation variable on the inflow boundary \(\mathbf{\Gamma}_{in}\).</p>
<p><a class="anchor" id="Adaptiveoperatorsplittingandtimestepping"></a></p><h3>Adaptive operator splitting and time stepping.</h3>
<p>As seen in <a class="el" href="step_21.html">step-21</a>, solving the flow equations for velocity and pressure are the parts of the program that take far longer than the (explicit) updating step for the saturation variable once we know the flow variables. On the other hand, the pressure and velocity depend only weakly on saturation, so one may think about only solving for pressure and velocity every few time steps while updating the saturation in every step. If we can find a criterion for when the flow variables need to be updated, we call this splitting an "adaptive
operator splitting" scheme.</p>
<p>Here, we use the following a posteriori criterion to decide when to re-compute pressure and velocity variables (detailed derivations and descriptions can be found in [Chueh, Djilali and Bangerth 2011]): </p><p class="formulaDsp">
\begin{align*} \theta(n,n_p) = \max_{\kappa\in{\mathbb T}} \left( \left\| \frac 1{\lambda_t\left(S^{(n-1)}\right)} - \frac 1{\lambda_t\left(S^{(n_p)}\right)} \right\|_{L^\infty(\kappa)} \left\|\|\mathbf{K}^{-1}\|_1\right\|_{L^\infty(\kappa)} \right). \end{align*}
</p>
<p> where superscripts in parentheses denote the number of the saturation time step at which any quantity is defined and \(n_p&lt;n\) represents the last step where we actually computed the pressure and velocity. If \(\theta(n,n_p)\) exceeds a certain threshold we re-compute the flow variables; otherwise, we skip this computation in time step \(n\) and only move the saturation variable one time step forward.</p>
<p>In short, the algorithm allows us to perform a number of saturation time steps of length \(\Delta t_c^{(n)}=t^{(n)}_c-t^{(n-1)}_c\) until the criterion above tells us to re-compute velocity and pressure variables, leading to a macro time step of length </p><p class="formulaDsp">
\[ \Delta t_p^{(n)} = \sum_{i=n_p+1}^{n} \Delta t_c^{(i)}. \]
</p>
<p> We choose the length of (micro) steps subject to the Courant-Friedrichs-Lewy (CFL) restriction according to the criterion </p><p class="formulaDsp">
\[ \Delta t_c = \frac{\textrm{min}_{K}h_{K}}{7 \|\mathbf{u}_t\|_{L^{\infty}\left(\Omega\right)}}, \]
</p>
<p> which we have confirmed to be stable for the choice of finite element and time stepping scheme for the saturation equation discussed below ( \(h_K\) denotes the diameter of cell \(K\)). The result is a scheme where neither micro nor macro time steps are of uniform length, and both are chosen adaptively.</p>
<p><a class="anchor" id="Timediscretization"></a></p><h3>Time discretization.</h3>
<p>Using this time discretization, we obtain the following set of equations for each time step from the IMPES approach (see <a class="el" href="step_21.html">step-21</a>): </p><p class="formulaDsp">
\begin{align*} \mathbf{u}^{(n)}_t + \lambda_t\left(S^{(n-1)}\right) \mathbf{K} \nabla p^{(n)} =0, \\ \nabla \cdot \mathbf{u}^{(n)}_t = q, \\ \epsilon \left( \frac{S^{(n-1)}-S^{(n)}}{\Delta t^{(n)}_c} \right) + \mathbf{u}^{(n)}_t \cdot \nabla F\left(S^{(n-1)}\right) + F\left(S^{(n-1)}\right) \nabla \cdot \mathbf{u}^{(n)}_t =0. \end{align*}
</p>
<p>Using the fact that \(\nabla \cdot \mathbf{u}_t = q\), the time discrete saturation equation becomes </p><p class="formulaDsp">
\begin{align*} &amp;\epsilon \left( \frac{S^{(n)}-S^{(n-1)}}{\Delta t^{(n)}_c} \right) + \mathbf{u}^{(n)}_t \cdot \nabla F\left(S^{(n-1)}\right) + F\left(S^{(n-1)}\right)q=0. \end{align*}
</p>
<p><a class="anchor" id="Weakformspacediscretizationforthepressurevelocitypart"></a></p><h3>Weak form, space discretization for the pressure-velocity part.</h3>
<p>By multiplying the equations defining the total velocity \(\mathbf u_t^{(n)}\) and the equation that expresses its divergence in terms of source terms, with test functions \(\mathbf{v}\) and \(w\) respectively and then integrating terms by parts as necessary, the weak form of the problem reads: Find \(\mathbf u, p\) so that for all test functions \(\mathbf{v}, w\) there holds </p><p class="formulaDsp">
\begin{gather*} \left( \left( \mathbf{K} \lambda_t\left(S^{(n-1)}\right) \right)^{-1} \mathbf{u}^{(n)}_t, \mathbf{v}\right)_{\Omega} - \left(p^{(n)}, \nabla \cdot \mathbf{v}\right)_{\Omega} = -\left(p^{(n)}, \mathbf{n} \cdot \mathbf{v} \right)_{\partial \Omega}, \\ - \left( \nabla \cdot \mathbf{u}^{(n)}_t,w\right)_{\Omega} = - \big(q,w\big)_{\Omega}. \end{gather*}
</p>
<p> Here, \(\mathbf{n}\) represents the unit outward normal vector to \(\partial \Omega\) and the pressure \(p^{(n)}\) can be prescribed weakly on the open part of the boundary \(\partial \Omega\) whereas on those parts where a velocity is prescribed (for example impermeable boundaries with \(\mathbf n \cdot \mathbf u=0\) the term disappears altogether because \(\mathbf n \cdot \mathbf v=0\).</p>
<p>We use continuous finite elements to discretize the velocity and pressure equations. Specifically, we use mixed finite elements to ensure high order approximation for both vector (e.g. a fluid velocity) and scalar variables (e.g. pressure) simultaneously. For saddle point problems, it is well established that the so-called Babuska-Brezzi or Ladyzhenskaya-Babuska-Brezzi (LBB) conditions [Brezzi 1991, Chen 2005] need to be satisfied to ensure stability of the pressure-velocity system. These stability conditions are satisfied in the present work by using elements for velocity that are one order higher than for the pressure, i.e. \(u_h \in Q^d_{p+1}\) and \(p_h \in Q_p\), where \(p=1\), \(d\) is the space dimension, and \(Q_s\) denotes the space of tensor product Lagrange polynomials of degree \(s\) in each variable.</p>
<p><a class="anchor" id="Stabilizationweakformandspacediscretizationforthesaturationtransportequation"></a></p><h3>Stabilization, weak form and space discretization for the saturation transport equation.</h3>
<p>The chosen \(Q_1\) elements for the saturation equation do not lead to a stable discretization without upwinding or other kinds of stabilization, and spurious oscillations will appear in the numerical solution. Adding an artificial diffusion term is one approach to eliminating these oscillations [Chen 2005]. On the other hand, adding too much diffusion smears sharp fronts in the solution and suffers from grid-orientation difficulties [Chen 2005]. To avoid these effects, we use the artificial diffusion term proposed by [Guermond and Pasquetti 2008] and validated in [Chueh, Djilali, Bangerth 2011] and [Kronbichler, Heister and Bangerth, 2011], as well as in <a class="el" href="step_31.html">step-31</a>.</p>
<p>This method modifies the (discrete) weak form of the saturation equation to read </p><p class="formulaDsp">
\begin{align*} \left(\epsilon \frac{\partial S_h}{\partial t},\sigma_h\right) - \left(\mathbf{u}_t F\left( S_h \right), \nabla \sigma_h\right) + \left(\mathbf n \cdot \mathbf{u}_t \hat F\left( S_h \right), \sigma_h\right)_{\partial\Omega} + (\nu(S_h) \nabla S_h, \nabla \sigma_h) &amp;=0 \qquad \forall \sigma_h, \end{align*}
</p>
<p> where \(\nu\) is the artificial diffusion parameter and \(\hat F\) is an appropriately chosen numerical flux on the boundary of the domain (we choose the obvious full upwind flux for this).</p>
<p>Following [Guermond and Pasquetti 2008] (and as detailed in [Chueh, Djilali and Bangerth 2011]), we use the parameter as a piecewise constant function set on each cell \(K\) with the diameter \(h_{K}\) as </p><p class="formulaDsp">
\[ \nu(S_h)|_{K} = \beta \| \mathbf{u}_t \max\{F&#39;(S_h),1\} \|_{L^{\infty}(K)} \textrm{min} \left\{ h_{K},h^{\alpha}_{K} \frac{\|\textrm{Res}(S_h)\|_{L^{\infty}(K)}}{c(\mathbf{u}_t,S)} \right\} \]
</p>
<p> where \(\alpha\) is a stabilization exponent and \(\beta\) is a dimensionless user-defined stabilization constant. Following [Guermond and Pasquetti 2008] as well as the implementation in <a class="el" href="step_31.html">step-31</a>, the velocity and saturation global normalization constant, \(c(\mathbf{u}_t,S)\), and the residual \(\textrm{Res}(S)\) are respectively given by </p><p class="formulaDsp">
\[ c(\mathbf{u}_t,S) = c_R \|\mathbf{u}_t \max\{F&#39;(S),1\}\|_{L^{\infty}(\Omega)} \textrm{var}(S)^\alpha | \textrm{diam} (\Omega) |^{\alpha - 2} \]
</p>
<p> and </p><p class="formulaDsp">
\[ \textrm{Res}(S) = \left( \epsilon \frac{\partial S}{\partial t} + \mathbf{u}_t \cdot \nabla F(S) + F(S)q \right) \cdot S^{\alpha - 1} \]
</p>
<p> where \(c_R\) is a second dimensionless user-defined constant, \(\textrm{diam}(\Omega)\) is the diameter of the domain and \(\textrm{var}(S) = \textrm{max}_{\Omega} S - \textrm{min}_{\Omega} S\) is the range of the present saturation values in the entire computational domain \(\Omega\).</p>
<p>This stabilization scheme has a number of advantages over simpler schemes such as finite volume (or discontinuous Galerkin) methods or streamline upwind Petrov Galerkin (SUPG) discretizations. In particular, the artificial diffusion term acts primarily in the vicinity of discontinuities since the residual is small in areas where the saturation is smooth. It therefore provides for a higher degree of accuracy. On the other hand, it is nonlinear since \(\nu\) depends on the saturation \(S\). We avoid this difficulty by treating all nonlinear terms explicitly, which leads to the following fully discrete problem at time step \(n\): </p><p class="formulaDsp">
\begin{align*} &amp;\left( \epsilon S_h^{(n)},\sigma_h\right)_{\Omega} - \Delta t^{(n)}_c \Big(F\left(S_h^{(n-1)}\right)\mathbf{u}^{*}_t,\nabla\sigma_h\Big)_{\Omega} + \Delta t^{(n)}_c \Big(F\left(S_h^{(n-1)}\right)\left(\mathbf{n}\cdot\mathbf{u}^{*}_t\right),\sigma_h\Big)_{\partial\Omega} \nonumber \\ &amp; \quad = \left( \epsilon S_h^{(n-1)},\sigma_h\right)_{\Omega} - \Delta t^{(n)}_c \bigg(\nu\left(S_h^{(n-1)}\right)\nabla S_h^{(n-1)},\nabla\sigma_h\bigg)_{\Omega} \nonumber \\ &amp; \qquad + \Delta t^{(n)}_c \bigg(\mathbf{n}\cdot\nu\left(S_h^{(n-1)}\right)\nabla S^{(n-1)},\sigma_h\bigg)_{\partial\Omega} \end{align*}
</p>
<p> where \(\mathbf{u}_t^{*}\) is the velocity linearly extrapolated from \(\mathbf{u}^{(n_p)}_t\) and \(\mathbf{u}^{(n_{pp})}_t\) to the current time \(t^{(n)}\) if \(\theta&lt;\theta^*\) while \(\mathbf{u}_t^{*}\) is \(\mathbf{u}^{(n_p)}_t\) if \(\theta&gt;\theta^*\). Consequently, the equation is linear in \(S_h^{(n)}\) and all that is required is to solve with a mass matrix on the saturation space.</p>
<p>Since the Dirichlet boundary conditions for saturation are only imposed on the inflow boundaries, the third term on the left hand side of the equation above needs to be split further into two parts: </p><p class="formulaDsp">
\begin{align*} &amp;\Delta t^{(n)}_c \Big(F\left(S_h^{(n-1)}\right)\left(\mathbf{n}\cdot\mathbf{u}^{(n)}_t\right),\sigma_h\Big)_{\partial\Omega} \nonumber \\ &amp;\qquad= \Delta t^{(n)}_c \Big(F\left(S^{(n-1)}_{(+)}\right)\left(\mathbf{n}\cdot\mathbf{u}^{(n)}_{t(+)}\right),\sigma_h\Big)_{\partial\Omega_{(+)}} + \Delta t^{(n)}_c \Big(F\left(S^{(n-1)}_{(-)}\right)\left(\mathbf{n}\cdot\mathbf{u}^{(n)}_{t(-)}\right),\sigma_h\Big)_{\partial\Omega_{(-)}} \end{align*}
</p>
<p> where \(\partial\Omega_{(-)} = \left\{\mathbf{x} \in \partial\Omega : \mathbf{n} \cdot \mathbf{u}_t&lt;0\right\}\) and \(\partial\Omega_{(+)} = \left\{\mathbf{x} \in \partial\Omega : \mathbf{n} \cdot \mathbf{u}_t&gt;0\right\}\) represent inflow and outflow boundaries, respectively. We choose values using an upwind formulation, i.e. \(S^{(n-1)}_{(+)}\) and \(\mathbf{u}^{(n)}_{t(+)}\) correspond to the values taken from the present cell, while the values of \(S^{(n-1)}_{(-)}\) and \(\mathbf{u}^{(n)}_{t(-)}\) are those taken from the neighboring boundary \(\partial\Omega_{(-)}\).</p>
<p><a class="anchor" id="Adaptivemeshrefinement"></a></p><h3>Adaptive mesh refinement.</h3>
<p>Choosing meshes adaptively to resolve sharp saturation fronts is an essential ingredient to achieve efficiency in our algorithm. Here, we use the same shock-type refinement approach used in [Chueh, Djilali and Bangerth 2011] to select those cells that should be refined or coarsened. The refinement indicator for each cell \(K\) of the triangulation is computed by </p><p class="formulaDsp">
\[ \eta_{K} = |\nabla S_h(\mathbf x_K)| \]
</p>
<p> where \(\nabla S_h(\mathbf x_K)\) is the gradient of the discrete saturation variable evaluated at the center \(\mathbf x_K\) of cell \(K\). This approach is analogous to ones frequently used in compressible flow problems, where density gradients are used to indicate refinement. That said, as we will discuss at the end of the <a href="#Results">results section</a>, this turns out to not be a very useful criterion since it leads to refinement basically everywhere. We only show it here for illustrative purposes.</p>
<p><a class="anchor" id="Linearsystemanditspreconditioning"></a></p><h3>Linear system and its preconditioning.</h3>
<p>Following the discretization of the governing equations discussed above, we obtain a linear system of equations in time step \((n)\) of the following form: </p><p class="formulaDsp">
\[ \left( \begin{array}{ccc} \mathbf{M}^{\mathbf{u}} &amp; \mathbf{B}^{T} &amp; \mathbf{0} \\ \mathbf{B} &amp; \mathbf{0} &amp; \mathbf{0} \\ \mathbf{H} &amp; \mathbf{0} &amp; \mathbf{M}^{S} \end{array} \right) \left( \begin{array}{c} \mathbf{U}^{(n)} \\ \mathbf{P}^{(n)} \\ \mathbf{S}^{(n)} \end{array} \right) = \left( \begin{array}{c} 0 \\ \mathbf{F}_{2} \\ \mathbf{F}_{3} \end{array} \right) \]
</p>
<p> where the individual matrices and vectors are defined as follows using shape functions \(\mathbf{v}_i\) for velocity, and \(\phi_i\) for both pressure and saturation: </p><p class="formulaDsp">
\begin{align*} \mathbf{M}^{\mathbf{u}}_{ij} &amp;= \left( \left( \mathbf{K} \lambda_t\left(S^{(n-1)}\right) \right)^{-1} \mathbf{v}_{i},\mathbf{v}_{j}\right)_{\Omega}, &amp; \mathbf{M}^{S}_{ij} &amp;= \left(\epsilon \phi_i,\phi_j\right)_{\Omega} \\ \mathbf{B}_{ij} &amp;= - \left( \nabla \cdot \mathbf{v}_{j},\phi_{i}\right)_{\Omega}, &amp; \mathbf{H}_{ij} &amp;= - \Delta t^{(n)}_c \Big( F\left(S^{(n-1)}\right) \mathbf{v}_i,\nabla\phi_j\Big)_{\Omega} \\ \left(\mathbf{F}_{2}\right)_i &amp;= - \big(F\left(S^{(n-1)}\right)q,\phi_i\big)_{\Omega}, \end{align*}
</p>
<p> and \(\mathbf{F}_{3}\) as given in the definition of the stabilized transport equation.</p>
<p>The linear system above is of block triangular form if we consider the top left \(2\times 2\) panel of matrices as one block. We can therefore first solve for the velocity and pressure (unless we decide to use \(\mathbf U^{(n_p)}\) in place of the velocity) followed by a solve for the saturation variable. The first of these steps requires us to solve </p><p class="formulaDsp">
\[ \left( \begin{array}{cc} \mathbf{M}^{\mathbf{u}} &amp; \mathbf{B}^{T} \\ \mathbf{B} &amp; \mathbf{0} \end{array} \right) \left( \begin{array}{c} \mathbf{U}^{(n)} \\ \mathbf{P}^{(n)} \end{array} \right) = \left( \begin{array}{c} 0 \\ \mathbf{F}_{2} \end{array} \right) \]
</p>
<p> We apply the Generalized Minimal Residual (GMRES) method [Saad and Schultz 1986] to this linear system. The ideal preconditioner for the velocity-pressure system is </p><p class="formulaDsp">
\begin{align*} \mathbf{P} = \left( \begin{array}{cc} \mathbf{M}^{\mathbf{u}} &amp; \mathbf{0} \\ \mathbf{B} &amp; -\mathbf{S} \end{array} \right), &amp; \qquad \mathbf{P}^{-1} = \left( \begin{array}{cc} \left(\mathbf{M}^{\mathbf{u}}\right)^{-1} &amp; \mathbf{0} \\ \mathbf{S}^{-1} \mathbf{B} \left(\mathbf{M}^{\mathbf{u}}\right)^{-1} &amp; -\mathbf{S}^{-1} \end{array} \right) \end{align*}
</p>
<p> where \(\mathbf{S}=\mathbf{B}\left(\mathbf{M}^{\mathbf{u}}\right)^{-1}\mathbf{B}^T\) is the Schur complement [Zhang 2005] of the system. This preconditioner is optimal since </p><p class="formulaDsp">
\begin{align*} \mathbf{P}^{-1} \left( \begin{array}{cc} \mathbf{M}^{\mathbf{u}} &amp; \mathbf{B}^{T} \\ \mathbf{B} &amp; \mathbf{0} \end{array} \right) = \left( \begin{array}{cc} \mathbf{I} &amp; \left(\mathbf{M}^{\mathbf{u}}\right)^{-1} \mathbf{B}^{T} \\ \mathbf{0} &amp; \mathbf{I} \end{array} \right), \end{align*}
</p>
<p> for which it can be shown that GMRES converges in two iterations.</p>
<p>However, we cannot of course expect to use exact inverses of the velocity mass matrix and the Schur complement. We therefore follow the approach by [Silvester and Wathen 1994] originally proposed for the Stokes system. Adapting it to the current set of equations yield the preconditioner </p><p class="formulaDsp">
\begin{align*} \mathbf{\tilde{P}}^{-1} = \left( \begin{array}{cc} \widetilde{\left(\mathbf{{M}}^{\mathbf{u}}\right)^{-1}} &amp; \mathbf{0} \\ \widetilde{\mathbf{{S}}^{-1}} \mathbf{B} \widetilde{\left(\mathbf{{M}}^{\mathbf{u}}\right)^{-1}} &amp; -\widetilde{\mathbf{{S}}^{-1}} \end{array} \right) \end{align*}
</p>
<p> where a tilde indicates an approximation of the exact inverse matrix. In particular, since \(\left(\mathbf{{M}}^{\mathbf{u}}\right)^{-1}=\left( \left( \mathbf{K} \lambda_t \right)^{-1} \mathbf{v}_{i},\mathbf{v}_{j}\right)_{\Omega}\) is a sparse symmetric and positive definite matrix, we choose for \(\widetilde{\left(\mathbf{{M}}^{\mathbf{u}}\right)^{-1}}\) a single application of a sparse incomplete Cholesky decomposition of this matrix [Golub and Van Loan 1996]. We note that the Schur complement that corresponds to the porous media flow operator in non-mixed form, \(-\nabla \cdot [\mathbf K \lambda_t(S)]\nabla\) and \(\mathbf{\tilde {S}} = \left( \left( \mathbf{K} \lambda_t \right) \nabla \phi_{i},\nabla \phi_{j}\right)_{\Omega}\) should be a good approximation of the actual Schur complement matrix \(\mathbf S\). Since both of these matrices are again symmetric and positive definite, we use an incomplete Cholesky decomposition of \(\mathbf{\tilde S}\) for \(\widetilde {\mathbf{{S}}^{-1}}\). It is important to note that \(\mathbf{\tilde S}\) needs to be built with Dirichlet boundary conditions to ensure its invertibility.</p>
<p>Once the velocity \(\mathbf{U}^{(n)} \equiv \mathbf{u}^*_t\) is available, we can assemble \(\mathbf{H}\) and \(\mathbf{F}_{3}\) and solve for the saturations using </p><p class="formulaDsp">
\begin{align*} \mathbf{M}^{S} \mathbf{S}^{(n)} = \mathbf{F}_{3} - \mathbf{H} \mathbf{U}^{(n)}. \end{align*}
</p>
<p> where the mass matrix \(\mathbf{M}^{S}\) is solved by the conjugate gradient method, using an incomplete Cholesky decomposition as preconditioner once more.</p>
<p><a class="anchor" id="Thetestcases"></a></p><h3>The test cases.</h3>
<dl class="section note"><dt>Note</dt><dd>The implementation discussed here uses and extends parts of the <a class="el" href="step_21.html">step-21</a>, <a class="el" href="step_31.html">step-31</a> and <a class="el" href="step_33.html">step-33</a> tutorial programs of this library. In particular, if you want to understand how it works, please consult <a class="el" href="step_21.html">step-21</a> for a discussion of the mathematical problem, and <a class="el" href="step_31.html">step-31</a> from which most of the implementation is derived. We will not discuss aspects of the implementation that have already been discussed in <a class="el" href="step_31.html">step-31</a>.</dd></dl>
<p>We show numerical results for some two-phase flow equations augmented by appropriate initial and boundary conditions in conjunction with two different choices of the permeability model. In the problems considered, there is no internal source term ( \(q=0\)). As mentioned above, quantitative numerical results are presented in [Chueh, Djilali and Bangerth 2011].</p>
<p>For simplicity, we choose \(\Omega=[0,1]^d,d=2,3\), though all methods (as well as our implementation) should work equally well on general unstructured meshes.</p>
<p>Initial conditions are only required for the saturation variable, and we choose \(S(\mathbf{x},0)=0.2\), i.e. the porous medium is initially filled by a mixture of the non-wetting (80%) and wetting (20%) phases. This differs from the initial condition in <a class="el" href="step_21.html">step-21</a> where we had taken \(S(\mathbf{x},0)=0\), but for complicated mathematical reasons that are mentioned there in a longish remark, the current method using an entropy-based artificial diffusion term does not converge to the viscosity solution with this initial condition without additional modifications to the method. We therefore choose this modified version for the current program.</p>
<p>Furthermore, we prescribe a linear pressure on the boundaries: </p><p class="formulaDsp">
\[ p(\mathbf{x},t) = 1 - x \qquad \textrm{on} \quad \partial \Omega \times [0,T]. \]
</p>
<p> Pressure and saturation uniquely determine a velocity, and the velocity determines whether a boundary segment is an inflow or outflow boundary. On the inflow part of the boundary, \(\mathbf{\Gamma}_{in}(t)\), we impose </p><p class="formulaDsp">
\begin{align*} S(\mathbf{x},t) = 1 \qquad &amp; \textrm{on} \quad \mathbf{\Gamma}_{in}(t) \cap \left\{x = 0\right\}, \\ S(\mathbf{x},t) = 0 \qquad &amp; \textrm{on} \quad \mathbf{\Gamma}_{in}(t) \backslash \left\{x = 0\right\}. \end{align*}
</p>
<p> In other words, the domain is flooded by the wetting phase from the left. No boundary conditions for the saturation are required for the outflow parts of the boundary.</p>
<p>All the numerical and physical parameters used for the 2D/3D cases are listed in the following table:</p>
<table align="center" class="tutorial" width="50%">
<tr>
<th>Parameter </th><th>Symbol </th><th>Value </th><th>units </th></tr>
<tr>
<td>Porosity </td><td>\(\epsilon\) </td><td>1.0 </td><td>- </td></tr>
<tr>
<td>Viscosity (wetting) </td><td>\(\mu_w\) </td><td>0.2 </td><td>\(kg \cdot m^{-1} \cdot sec^{-1}\) </td></tr>
<tr>
<td>Viscosity (nonwetting) </td><td>\(\mu_{nw}\) </td><td>1.0 </td><td>\(kg \cdot m^{-1} \cdot sec^{-1}\) </td></tr>
<tr>
<td>Stabilization exponent </td><td>\(\alpha\) </td><td>1.0 </td><td>- </td></tr>
<tr>
<td>Stabilization constant </td><td>\(\beta\) </td><td>2D: 0.3; 3D: 0.27 </td><td>- </td></tr>
<tr>
<td>Normalization constant </td><td>\(c_R\) </td><td>1.0 </td><td>- </td></tr>
<tr>
<td>Number of high-permeability regions </td><td>\(N\) </td><td>50; 200 </td><td>- </td></tr>
<tr>
<td>Operator splitting threshold </td><td>\(\theta^\ast\) </td><td>5.0 </td><td>-  </td></tr>
</table>
<p><a class="anchor" id="Listofreferences"></a></p><h3>List of references</h3>
<ol>
<li>
<p class="startli">CC Chueh, N Djilali and W Bangerth. <br  />
 An h-adaptive operator splitting method for two-phase flow in 3D heterogeneous porous media. <br  />
 SIAM Journal on Scientific Computing, vol. 35 (2013), pp. B149-B175</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">M. Kronbichler, T. Heister, and W. Bangerth <br  />
 High Accuracy Mantle Convection Simulation through Modern Numerical Methods. <br  />
 Geophysics Journal International, vol. 191 (2012), pp. 12-29</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">F Brezzi and M Fortin. <br  />
 <em>Mixed and Hybrid Finite Element Methods</em>. <br  />
 Springer-Verlag, 1991.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Z Chen. <br  />
 <em>Finite Element Methods and Their Applications</em>. <br  />
 Springer, 2005.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">JL Guermond and R Pasquetti. <br  />
 Entropy-based nonlinear viscosity for Fourier approximations of conservation laws. <br  />
 <em>Comptes Rendus Mathematique</em>, 346(13-14):801-806, 2008.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">CC Chueh, M Secanell, W Bangerth, and N Djilali. <br  />
 Multi-level adaptive simulation of transient two-phase flow in heterogeneous porous media. <br  />
 <em>Computers and Fluids</em>, 39:1585-1596, 2010.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Y Saad and MH Schultz. <br  />
 Gmres: A generalized minimal residual algorithm for solving nonsymmetric linear systems. <br  />
 <em>SIAM Journal on Scientific and Statistical Computing</em>, 7(3):856-869, 1986.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">F Zhang. <br  />
 <em>The Schur Complement and its Applications</em>. <br  />
 Springer, 2005.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">D Silvester and A Wathen. <br  />
 Fast iterative solution of stabilised Stokes systems part ii: Using general block preconditioners. <br  />
 <em>SIAM Journal on Numerical Analysis</em>, 31(5):1352-1367, 1994.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GH Golub and CF van Loan. <br  />
 <em>Matrix Computations</em>. <br  />
 3rd Edition, Johns Hopkins, 1996.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">SE Buckley and MC Leverett. <br  />
 Mechanism of fluid displacements in sands. <br  />
 <em>AIME Trans.</em>, 146:107-116, 1942.</p>
<p class="endli"></p>
</li>
</ol>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The first step, as always, is to include the functionality of a number of deal.II and C++ header files.</p>
<p>The list includes some header files that provide vector, matrix, and preconditioner classes that implement interfaces to the respective Trilinos classes; some more information on these may be found in <a class="el" href="step_31.html">step-31</a>.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2tensor__function_8h.html">deal.II/base/tensor_function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
</div><!-- fragment --><p>At the end of this top-matter, we open a namespace for the current project into which all the following material will go, and then import all deal.II names into this namespace:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep43.html">Step43</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Boundaryandinitialvalueclasses"></a> </p><h3>Boundary and initial value classes</h3>
<p>The following part is taken directly from <a class="el" href="step_21.html">step-21</a> so there is no need to repeat the descriptions found there.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>PressureBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  PressureBoundaryValues()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span></div>
<div class="line"><a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">PressureBoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> 1 - <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>SaturationBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SaturationBoundaryValues()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span></div>
<div class="line"><a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">SaturationBoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] == 0)</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>SaturationInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SaturationInitialValues()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span></div>
<div class="line"><a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">SaturationInitialValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> 0.2;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">SaturationInitialValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                                <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">    <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">SaturationInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Permeabilitymodels"></a> </p><h3>Permeability models</h3>
<p>In this tutorial, we still use the two permeability models previously used in <a class="el" href="step_21.html">step-21</a> so we again refrain from commenting in detail about them.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>SingleCurvingCrack</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>KInverse : <span class="keyword">public</span> <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    KInverse()</div>
<div class="line">      : <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;()</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span></div>
<div class="line">    <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">               <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">KInverse&lt;dim&gt;::value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                                 <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size() == <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size(),</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga6060b2304b8600f5efa0d31eeda0207d">ExcDimensionMismatch</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(), <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size()));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].clear();</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> distance_to_flowline =</div>
<div class="line">          <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][1] - 0.5 - 0.1 * <a class="code" href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">std::sin</a>(10 * <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][0]));</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> permeability =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(std::exp(-(distance_to_flowline * distance_to_flowline) /</div>
<div class="line">                            (0.1 * 0.1)),</div>
<div class="line">                   0.01);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = 1. / permeability;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace SingleCurvingCrack</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>RandomMedium</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>KInverse : <span class="keyword">public</span> <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    KInverse()</div>
<div class="line">      : <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;()</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span></div>
<div class="line">    <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">               <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">static</span> std::vector&lt;Point&lt;dim&gt;&gt; centers;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::vector&lt;Point&lt;dim&gt;&gt; KInverse&lt;dim&gt;::centers = []() {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a> =</div>
<div class="line">      (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 40 : (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3 ? 100 : <span class="keywordflow">throw</span> <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()));</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Point&lt;dim&gt;&gt; centers_list(<a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        centers_list[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(<a class="code" href="base_2utilities__0_8txt.html#abdaf96304944a8787ae4488ed5461fac">rand</a>()) / RAND_MAX;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> centers_list;</div>
<div class="line">  }();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">KInverse&lt;dim&gt;::value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                                 <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(), <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size());</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].clear();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span> permeability = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; centers.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          permeability +=</div>
<div class="line">            std::exp(-(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>] - centers[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]).norm_square() / (0.05 * 0.05));</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> normalized_permeability =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(permeability, 0.01), 4.);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = 1. / normalized_permeability;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace RandomMedium</span></div>
</div><!-- fragment --><p><a class="anchor" id="Physicalquantities"></a> </p><h3>Physical quantities</h3>
<p>The implementations of all the physical quantities such as total mobility \(\lambda_t\) and fractional flow of water \(F\) are taken from <a class="el" href="step_21.html">step-21</a> so again we don't have do any comment about them. Compared to <a class="el" href="step_21.html">step-21</a> we have added checks that the saturation passed to these functions is in fact within the physically valid range. Furthermore, given that the wetting phase moves at speed \(\mathbf u F&#39;(S)\) it is clear that \(F&#39;(S)\) must be greater or equal to zero, so we assert that as well to make sure that our calculations to get at the formula for the derivative made sense.</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> 1.0 / (1.0 / viscosity * S * S + (1 - S) * (1 - S));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((S &gt;= 0) &amp;&amp; (S &lt;= 1),</div>
<div class="line">         <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Saturation is outside its physically valid range.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> S * S / (S * S + viscosity * (1 - S) * (1 - S));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((S &gt;= 0) &amp;&amp; (S &lt;= 1),</div>
<div class="line">         <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Saturation is outside its physically valid range.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> temp = (S * S + viscosity * (1 - S) * (1 - S));</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> numerator =</div>
<div class="line">    2.0 * S * temp - S * S * (2.0 * S - 2.0 * viscosity * (1 - S));</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> denominator = <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(temp, 2.0);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> F_prime = numerator / denominator;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(F_prime &gt;= 0, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> F_prime;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Helperclassesforsolversandpreconditioners"></a> </p><h3>Helper classes for solvers and preconditioners</h3>
<p>In this first part we define a number of classes that we need in the construction of linear solvers and preconditioners. This part is essentially the same as that used in <a class="el" href="step_31.html">step-31</a>. The only difference is that the original variable name stokes_matrix is replaced by another name darcy_matrix to match our problem.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                  <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(VectorType &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">    <span class="keyword">const</span> PreconditionerType &amp;           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">    <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">    <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">    : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">    , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">    VectorType &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">    <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-7 * src.l2_norm());</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">try</span></div>
<div class="line">      {</div>
<div class="line">        cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>.what()));</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">  <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    BlockSchurPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">      <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                          PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">      <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">               <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">      darcy_matrix;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                           PreconditionerTypeMp&gt;&gt;</div>
<div class="line">                               m_inverse;</div>
<div class="line">    <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">  BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div>
<div class="line">    BlockSchurPreconditioner(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">      <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                          PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">      <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner)</div>
<div class="line">    : darcy_matrix(&amp;S)</div>
<div class="line">    , m_inverse(&amp;Mpinv)</div>
<div class="line">    , a_preconditioner(Apreconditioner)</div>
<div class="line">    , tmp(<a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(darcy_matrix-&gt;<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1, 1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>()))</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult</a>(</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">    darcy_matrix-&gt;block(1, 0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">    tmp *= -1;</div>
<div class="line">    m_inverse-&gt;vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace LinearSolvers</span></div>
</div><!-- fragment --><p><a class="anchor" id="TheTwoPhaseFlowProblemclass"></a> </p><h3>The TwoPhaseFlowProblem class</h3>
<p>The definition of the class that defines the top-level logic of solving the time-dependent advection-dominated two-phase flow problem (or Buckley-Leverett problem [Buckley 1942]) is mainly based on tutorial programs <a class="el" href="step_21.html">step-21</a> and <a class="el" href="step_33.html">step-33</a>, and in particular on <a class="el" href="step_31.html">step-31</a> where we have used basically the same general structure as done here. As in <a class="el" href="step_31.html">step-31</a>, the key routines to look for in the implementation below are the <code><a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a></code> and <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code> functions.</p>
<p>The main difference to <a class="el" href="step_31.html">step-31</a> is that, since adaptive operator splitting is considered, we need a couple more member variables to hold the last two computed Darcy (velocity/pressure) solutions in addition to the current one (which is either computed directly, or extrapolated from the previous two), and we need to remember the last two times we computed the Darcy solution. We also need a helper function that figures out whether we do indeed need to recompute the Darcy solution.</p>
<p>Unlike <a class="el" href="step_31.html">step-31</a>, this step uses one more <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object called darcy_preconditioner_constraints. This constraint object is used only for assembling the matrix for the Darcy preconditioner and includes hanging node constraints as well as Dirichlet boundary value constraints for the pressure variable. We need this because we are building a Laplace matrix for the pressure as an approximation of the Schur complement) which is only positive definite if boundary conditions are applied.</p>
<p>The collection of member functions and variables thus declared in this class is then rather similar to those in <a class="el" href="step_31.html">step-31</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>TwoPhaseFlowProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  TwoPhaseFlowProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_darcy_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span> build_darcy_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_darcy_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_matrix();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_rhs();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_rhs_cell_term(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       saturation_fe_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       darcy_fe_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_max_u_F_prime,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_S_variation,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_rhs_boundary_term(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   saturation_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   darcy_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span> refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line">  <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
</div><!-- fragment --><p>We follow with a number of helper functions that are used in a variety of places throughout the program:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span>                    get_max_u_F_prime() <span class="keyword">const</span>;</div>
<div class="line">std::pair&lt;double, double&gt; get_extrapolated_saturation_range() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">bool</span>   determine_whether_to_solve_for_pressure_and_velocity() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">void</span>   project_back_saturation();</div>
<div class="line"><span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_saturation,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_saturation,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_saturation_grads,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_saturation_grads,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;present_darcy_values,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_max_u_F_prime,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_S_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div>
</div><!-- fragment --><p>This all is followed by the member variables, most of which are similar to the ones in <a class="el" href="step_31.html">step-31</a>, with the exception of the ones that pertain to the macro time stepping for the velocity/pressure system:</p>
<div class="fragment"><div class="line"><a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line"><span class="keywordtype">double</span>             global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        darcy_degree;</div>
<div class="line"><a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             darcy_fe;</div>
<div class="line"><a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           darcy_dof_handler;</div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> darcy_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> darcy_preconditioner_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> darcy_matrix;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> darcy_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> darcy_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> darcy_rhs;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> last_computed_darcy_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> second_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        saturation_degree;</div>
<div class="line"><a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 saturation_fe;</div>
<div class="line"><a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           saturation_dof_handler;</div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> saturation_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> saturation_matrix;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> saturation_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_saturation_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_saturation_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> saturation_rhs;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div>
<div class="line">  saturation_matching_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> saturation_refinement_threshold;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span>       <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> end_time;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> current_macro_time_step;</div>
<div class="line"><span class="keywordtype">double</span> old_macro_time_step;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span>       time_step;</div>
<div class="line"><span class="keywordtype">double</span>       old_time_step;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> viscosity;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> porosity;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> AOS_threshold;</div>
<div class="line"> </div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt; Amg_preconditioner;</div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt; Mp_preconditioner;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> rebuild_saturation_matrix;</div>
</div><!-- fragment --><p>At the very end we declare a variable that denotes the material model. Compared to <a class="el" href="step_21.html">step-21</a>, we do this here as a member variable since we will want to use it in a variety of places and so having a central place where such a variable is declared will make it simpler to replace one class by another (e.g. replace RandomMedium::KInverse by SingleCurvingCrack::KInverse).</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> RandomMedium::KInverse&lt;dim&gt; k_inverse;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimTwoPhaseFlowProblem"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::TwoPhaseFlowProblem</h3>
<p>The constructor of this class is an extension of the constructors in <a class="el" href="step_21.html">step-21</a> and <a class="el" href="step_31.html">step-31</a>. We need to add the various variables that concern the saturation. As discussed in the introduction, we are going to use \(Q_2 \times Q_1\) (Taylor-Hood) elements again for the Darcy system, an element combination that fulfills the Ladyzhenskaya-Babuska-Brezzi (LBB) conditions [Brezzi and Fortin 1991, Chen 2005], and \(Q_1\) elements for the saturation. However, by using variables that store the polynomial degree of the Darcy and temperature finite elements, it is easy to consistently modify the degree of the elements as well as all quadrature formulas used on them downstream. Moreover, we initialize the time stepping variables related to operator splitting as well as the option for matrix assembly and preconditioning:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">TwoPhaseFlowProblem&lt;dim&gt;::TwoPhaseFlowProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">  , global_Omega_diameter(std::numeric_limits&lt;<a class="code" href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a>&gt;::quiet_NaN())</div>
<div class="line">  , <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  , darcy_degree(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  , darcy_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(darcy_degree + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(darcy_degree), 1)</div>
<div class="line">  , darcy_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  saturation_degree(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1)</div>
<div class="line">  , saturation_fe(saturation_degree)</div>
<div class="line">  , saturation_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  saturation_refinement_threshold(0.5)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>(0)</div>
<div class="line">  , end_time(10)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  current_macro_time_step(0)</div>
<div class="line">  , old_macro_time_step(0)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  time_step(0)</div>
<div class="line">  , old_time_step(0)</div>
<div class="line">  , timestep_number(0)</div>
<div class="line">  , viscosity(0.2)</div>
<div class="line">  , porosity(1.0)</div>
<div class="line">  , AOS_threshold(3.0)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  rebuild_saturation_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimsetup_dofs"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::setup_dofs</h3>
<p>This is the function that sets up the <a class="el" href="classDoFHandler.html">DoFHandler</a> objects we have here (one for the Darcy part and one for the saturation part) as well as set to the right sizes the various objects required for the linear algebra in this program. Its basic operations are similar to what <a class="el" href="step_31.html">step-31</a> did.</p>
<p>The body of the function first enumerates all degrees of freedom for the Darcy and saturation systems. For the Darcy part, degrees of freedom are then sorted to ensure that velocities precede pressure DoFs so that we can partition the Darcy matrix into a \(2 \times 2\) matrix.</p>
<p>Then, we need to incorporate hanging node constraints and Dirichlet boundary value constraints into darcy_preconditioner_constraints. The boundary condition constraints are only set on the pressure component since the Schur complement preconditioner that corresponds to the porous media flow operator in non-mixed form, \(-\nabla \cdot [\mathbf K \lambda_t(S)]\nabla\), acts only on the pressure variable. Therefore, we use a component_mask that filters out the velocity component, so that the condensation is performed on pressure degrees of freedom only.</p>
<p>After having done so, we count the number of degrees of freedom in the various blocks. This information is then used to create the sparsity pattern for the Darcy and saturation system matrices as well as the preconditioner matrix from which we build the Darcy preconditioner. As in <a class="el" href="step_31.html">step-31</a>, we choose to create the pattern using the blocked version of <a class="el" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a>. So, for this, we follow the same way as <a class="el" href="step_31.html">step-31</a> did and we don't have to repeat descriptions again for the rest of the member function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  std::vector&lt;unsigned int&gt; darcy_block_component(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">  darcy_block_component[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">  {</div>
<div class="line">    darcy_dof_handler.distribute_dofs(darcy_fe);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>(darcy_dof_handler);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(darcy_dof_handler, darcy_block_component);</div>
<div class="line"> </div>
<div class="line">    darcy_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                            darcy_constraints);</div>
<div class="line">    darcy_constraints.close();</div>
<div class="line">  }</div>
<div class="line">  {</div>
<div class="line">    saturation_dof_handler.distribute_dofs(saturation_fe);</div>
<div class="line"> </div>
<div class="line">    saturation_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(saturation_dof_handler,</div>
<div class="line">                                            saturation_constraints);</div>
<div class="line">    saturation_constraints.close();</div>
<div class="line">  }</div>
<div class="line">  {</div>
<div class="line">    darcy_preconditioner_constraints.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                            darcy_preconditioner_constraints);</div>
<div class="line">    <a class="code" href="group__constraints.html#ga06c0301bc74dd4c67a3d1db1000647f3">DoFTools::make_zero_boundary_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                             darcy_preconditioner_constraints,</div>
<div class="line">                                             darcy_fe.component_mask(</div>
<div class="line">                                               <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>));</div>
<div class="line"> </div>
<div class="line">    darcy_preconditioner_constraints.close();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; darcy_dofs_per_block =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(darcy_dof_handler,</div>
<div class="line">                                      darcy_block_component);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = darcy_dofs_per_block[0],</div>
<div class="line">                     n_p = darcy_dofs_per_block[1],</div>
<div class="line">                     n_s = saturation_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_s &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div>
<div class="line">            &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_s &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    darcy_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">    dsp.block(0, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_u);</div>
<div class="line">    dsp.block(0, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_p);</div>
<div class="line">    dsp.block(1, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_u);</div>
<div class="line">    dsp.block(1, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">    dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">      darcy_dof_handler, coupling, dsp, darcy_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    darcy_matrix.reinit(dsp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    Amg_preconditioner.reset();</div>
<div class="line">    Mp_preconditioner.reset();</div>
<div class="line">    darcy_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">    dsp.block(0, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_u);</div>
<div class="line">    dsp.block(0, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_p);</div>
<div class="line">    dsp.block(1, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_u);</div>
<div class="line">    dsp.block(1, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">    dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">      darcy_dof_handler, coupling, dsp, darcy_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    darcy_preconditioner_matrix.reinit(dsp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    saturation_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_s, n_s);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(saturation_dof_handler,</div>
<div class="line">                                    dsp,</div>
<div class="line">                                    saturation_constraints,</div>
<div class="line">                                    <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    saturation_matrix.reinit(dsp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;IndexSet&gt; darcy_partitioning(2);</div>
<div class="line">  darcy_partitioning[0] = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_u);</div>
<div class="line">  darcy_partitioning[1] = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_p);</div>
<div class="line">  darcy_solution.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  last_computed_darcy_solution.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  last_computed_darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  second_last_computed_darcy_solution.reinit(darcy_partitioning,</div>
<div class="line">                                             MPI_COMM_WORLD);</div>
<div class="line">  second_last_computed_darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  darcy_rhs.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  darcy_rhs.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> saturation_partitioning = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_s);</div>
<div class="line">  saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_old_saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  saturation_matching_last_computed_darcy_solution.reinit(</div>
<div class="line">    saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  saturation_rhs.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Assemblingmatricesandpreconditioners"></a> </p><h3>Assembling matrices and preconditioners</h3>
<p>The next few functions are devoted to setting up the various system and preconditioner matrices and right hand sides that we have to deal with in this program.</p>
<p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_darcy_preconditioner"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_preconditioner</h4>
<p>This function assembles the matrix we use for preconditioning the Darcy system. What we need are a vector mass matrix weighted by \(\left(\mathbf{K} \lambda_t\right)^{-1}\) on the velocity components and a mass matrix weighted by \(\left(\mathbf{K} \lambda_t\right)\) on the pressure component. We start by generating a quadrature object of appropriate order, the <a class="el" href="classFEValues.html">FEValues</a> object that can give values and gradients at the quadrature points (together with quadrature weights). Next we create data structures for the cell matrix and the relation between local and global DoFs. The vectors phi_u and grad_phi_p are going to hold the values of the basis functions in order to faster build up the local matrices, as was already done in <a class="el" href="step_22.html">step-22</a>. Before we start the loop over all active cells, we have to specify which components are pressure and which are velocity.</p>
<p>The creation of the local matrix is rather simple. There are only a term weighted by \(\left(\mathbf{K} \lambda_t\right)^{-1}\) (on the velocity) and a Laplace matrix weighted by \(\left(\mathbf{K} \lambda_t\right)\) to be generated, so the creation of the local matrix is done in essentially two lines. Since the material model functions at the top of this file only provide the inverses of the permeability and mobility, we have to compute \(\mathbf K\) and \(\lambda_t\) by hand from the given values, once per quadrature point.</p>
<p>Once the local matrix is ready (loop over rows and columns in the local matrix on each quadrature point), we get the local DoF indices and write the local information into the global matrix. We do this by directly applying the constraints (i.e. darcy_preconditioner_constraints) that takes care of hanging node and zero Dirichlet boundary condition constraints. By doing so, we don't have to do that afterwards, and we later don't have to use <a class="el" href="classAffineConstraints.html#a5a1bc1bb2d705b582889ebaa24bcae5c">AffineConstraints::condense</a> and <a class="el" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>, both functions that would need to modify matrix and vector entries and so are difficult to write for the Trilinos classes where we don't immediately have access to individual memory locations.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_preconditioner()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding darcy preconditioner...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  darcy_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(darcy_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     darcy_fe_values(darcy_fe,</div>
<div class="line">                                quadrature_formula,</div>
<div class="line">                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     saturation_fe_values(saturation_fe,</div>
<div class="line">                                     quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = darcy_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">  <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">    {</div>
<div class="line">      darcy_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      saturation_fe_values.reinit(saturation_cell);</div>
<div class="line"> </div>
<div class="line">      local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">      saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                               old_saturation_values);</div>
<div class="line"> </div>
<div class="line">      k_inverse.value_list(darcy_fe_values.get_quadrature_points(),</div>
<div class="line">                           k_inverse_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> old_s = old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> inverse_mobility = <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_s, viscosity);</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> mobility         = 1.0 / inverse_mobility;</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> permeability = <a class="code" href="classSymmetricTensor.html#a33cd1a6c91c24a5ca34dfbc43c338d1c">invert</a>(k_inverse_values[q]);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              grad_phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = darcy_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              {</div>
<div class="line">                local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (k_inverse_values[q] * inverse_mobility * phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">                     phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] +</div>
<div class="line">                   permeability * mobility * grad_phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grad_phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                  darcy_fe_values.JxW(q);</div>
<div class="line">              }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">      darcy_preconditioner_constraints.distribute_local_to_global(</div>
<div class="line">        local_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, darcy_preconditioner_matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimbuild_darcy_preconditioner"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::build_darcy_preconditioner</h4>
<p>After calling the above functions to assemble the preconditioner matrix, this function generates the inner preconditioners that are going to be used for the Schur complement block preconditioner. The preconditioners need to be regenerated at every saturation time step since they depend on the saturation \(S\) that varies with time.</p>
<p>In here, we set up the preconditioner for the velocity-velocity matrix \(\mathbf{M}^{\mathbf{u}}\) and the Schur complement \(\mathbf{S}\). As explained in the introduction, we are going to use an IC preconditioner based on the vector matrix \(\mathbf{M}^{\mathbf{u}}\) and another based on the scalar Laplace matrix \(\tilde{\mathbf{S}}^p\) (which is spectrally close to the Schur complement of the Darcy matrix). Usually, the <a class="el" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> class can be seen as a good black-box preconditioner which does not need any special knowledge of the matrix structure and/or the operator that's behind it.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::build_darcy_preconditioner()</div>
<div class="line">{</div>
<div class="line">  assemble_darcy_preconditioner();</div>
<div class="line"> </div>
<div class="line">  Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">  Amg_preconditioner-&gt;initialize(darcy_preconditioner_matrix.block(0, 0));</div>
<div class="line"> </div>
<div class="line">  Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">  Mp_preconditioner-&gt;initialize(darcy_preconditioner_matrix.block(1, 1));</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_darcy_system"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_system</h4>
<p>This is the function that assembles the linear system for the Darcy system.</p>
<p>Regarding the technical details of implementation, the procedures are similar to those in <a class="el" href="step_22.html">step-22</a> and <a class="el" href="step_31.html">step-31</a>. We reset matrix and vector, create a quadrature formula on the cells, and then create the respective <a class="el" href="classFEValues.html">FEValues</a> object.</p>
<p>There is one thing that needs to be commented: since we have a separate finite element and <a class="el" href="classDoFHandler.html">DoFHandler</a> for the saturation, we need to generate a second <a class="el" href="classFEValues.html">FEValues</a> object for the proper evaluation of the saturation solution. This isn't too complicated to realize here: just use the saturation structures and set an update flag for the basis function values which we need for evaluation of the saturation solution. The only important part to remember here is that the same quadrature formula is used for both <a class="el" href="classFEValues.html">FEValues</a> objects to ensure that we get matching information when we loop over the quadrature points of the two objects.</p>
<p>The declarations proceed with some shortcuts for array sizes, the creation of the local matrix, right hand side as well as the vector for the indices of the local dofs compared to the global system.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_system()</div>
<div class="line">{</div>
<div class="line">  darcy_matrix = 0;</div>
<div class="line">  darcy_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(darcy_degree + 2);</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(darcy_degree + 2);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe,</div>
<div class="line">                                quadrature_formula,</div>
<div class="line">                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                     quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> darcy_fe_face_values(darcy_fe,</div>
<div class="line">                                         face_quadrature_formula,</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                           <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                           <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                           <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = darcy_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>      = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points = face_quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a> pressure_right_hand_side;</div>
<div class="line">  <span class="keyword">const</span> PressureBoundaryValues&lt;dim&gt;  pressure_boundary_values;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt;         pressure_rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt;         boundary_values(n_face_q_points);</div>
<div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
</div><!-- fragment --><p>Next we need a vector that will contain the values of the saturation solution at the previous time level at the quadrature points to assemble the saturation dependent coefficients in the Darcy equations.</p>
<p>The set of vectors we create next hold the evaluations of the basis functions as well as their gradients that will be used for creating the matrices. Putting these into their own arrays rather than asking the <a class="el" href="classFEValues.html">FEValues</a> object for this information each time it is needed is an optimization to accelerate the assembly process, see <a class="el" href="step_22.html">step-22</a> for details.</p>
<p>The last two declarations are used to extract the individual blocks (velocity, pressure, saturation) from the total FE system.</p>
<div class="fragment"><div class="line">std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;         div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;         phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
</div><!-- fragment --><p>Now start the loop over all cells in the problem. We are working on two different DoFHandlers for this assembly routine, so we must have two different cell iterators for the two objects in use. This might seem a bit peculiar, but since both the Darcy system and the saturation system use the same grid we can assume that the two iterators run in sync over the cells of the two <a class="el" href="classDoFHandler.html">DoFHandler</a> objects.</p>
<p>The first statements within the loop are again all very familiar, doing the update of the finite element data as specified by the update flags, zeroing out the local arrays and getting the values of the old solution at the quadrature points. At this point we also have to get the values of the saturation function of the previous time step at the quadrature points. To this end, we can use the FEValues::get_function_values (previously already used in <a class="el" href="step_9.html">step-9</a>, <a class="el" href="step_14.html">step-14</a> and <a class="el" href="step_15.html">step-15</a>), a function that takes a solution vector and returns a list of function values at the quadrature points of the present cell. In fact, it returns the complete vector-valued solution at each quadrature point, i.e. not only the saturation but also the velocities and pressure.</p>
<p>Then we are ready to loop over the quadrature points on the cell to do the integration. The formula for this follows in a straightforward way from what has been discussed in the introduction.</p>
<p>Once this is done, we start the loop over the rows and columns of the local matrix and feed the matrix with the relevant products.</p>
<p>The last step in the loop over all cells is to enter the local contributions into the global matrix and vector structures to the positions specified in local_dof_indices. Again, we let the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class do the insertion of the cell matrix elements to the global matrix, which already condenses the hanging node constraints.</p>
<div class="fragment"><div class="line">  <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">  <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">    {</div>
<div class="line">      darcy_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      saturation_fe_values.reinit(saturation_cell);</div>
<div class="line"> </div>
<div class="line">      local_matrix = 0;</div>
<div class="line">      local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">      saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                               old_saturation_values);</div>
<div class="line"> </div>
<div class="line">      pressure_right_hand_side.<a class="code" href="classFunctions_1_1ConstantFunction.html#a6a3224d6e805fa73629130e021a7285b">value_list</a>(</div>
<div class="line">        darcy_fe_values.get_quadrature_points(), pressure_rhs_values);</div>
<div class="line">      k_inverse.value_list(darcy_fe_values.get_quadrature_points(),</div>
<div class="line">                           k_inverse_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = darcy_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> old_s = old_saturation_values[q];</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt;= <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                {</div>
<div class="line">                  local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * k_inverse_values[q] *</div>
<div class="line">                       <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_s, viscosity) * phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] -</div>
<div class="line">                     div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                    darcy_fe_values.JxW(q);</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line">              local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                (-phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * pressure_rhs_values[q]) * darcy_fe_values.JxW(q);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">          {</div>
<div class="line">            darcy_fe_face_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line"> </div>
<div class="line">            pressure_boundary_values.value_list(</div>
<div class="line">              darcy_fe_face_values.get_quadrature_points(), boundary_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_q_points; ++q)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> phi_i_u =</div>
<div class="line">                    darcy_fe_face_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line"> </div>
<div class="line">                  local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                    -(phi_i_u * darcy_fe_face_values.normal_vector(q) *</div>
<div class="line">                      boundary_values[q] * darcy_fe_face_values.JxW(q));</div>
<div class="line">                }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> + 1; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">          local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = local_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      darcy_constraints.distribute_local_to_global(</div>
<div class="line">        local_matrix, local_rhs, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, darcy_matrix, darcy_rhs);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_system"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_system</h4>
<p>This function is to assemble the linear system for the saturation transport equation. It calls, if necessary, two other member functions: assemble_saturation_matrix() and assemble_saturation_rhs(). The former function then assembles the saturation matrix that only needs to be changed occasionally. On the other hand, the latter function that assembles the right hand side must be called at every saturation time step.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_system()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_saturation_matrix == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      saturation_matrix = 0;</div>
<div class="line">      assemble_saturation_matrix();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  saturation_rhs = 0;</div>
<div class="line">  assemble_saturation_rhs();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_matrix"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_matrix</h4>
<p>This function is easily understood since it only forms a simple mass matrix for the left hand side of the saturation linear system by basis functions phi_i_s and phi_j_s only. Finally, as usual, we enter the local contribution into the global matrix by specifying the position in local_dof_indices. This is done by letting the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class do the insertion of the cell matrix elements to the global matrix, which already condenses the hanging node constraints.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_matrix()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(saturation_degree + 2);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                     quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      saturation_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      local_matrix = 0;</div>
<div class="line">      local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> phi_i_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> phi_j_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q);</div>
<div class="line">                local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  porosity * phi_i_s * phi_j_s * saturation_fe_values.JxW(q);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      saturation_constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                        saturation_matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_rhs"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs</h4>
<p>This function is to assemble the right hand side of the saturation transport equation. Before going about it, we have to create two <a class="el" href="classFEValues.html">FEValues</a> objects for the Darcy and saturation systems respectively and, in addition, two <a class="el" href="classFEFaceValues.html">FEFaceValues</a> objects for the two systems because we have a boundary integral term in the weak form of saturation equation. For the <a class="el" href="classFEFaceValues.html">FEFaceValues</a> object of the saturation system, we also require normal vectors, which we request using the update_normal_vectors flag.</p>
<p>Next, before looping over all the cells, we have to compute some parameters (e.g. global_u_infty, global_S_variation, and global_Omega_diameter) that the artificial viscosity \(\nu\) needs. This is largely the same as was done in <a class="el" href="step_31.html">step-31</a>, so you may see there for more information.</p>
<p>The real works starts with the loop over all the saturation and Darcy cells to put the local contributions into the global vector. In this loop, in order to simplify the implementation, we split some of the work into two helper functions: assemble_saturation_rhs_cell_term and assemble_saturation_rhs_boundary_term. We note that we insert cell or boundary contributions into the global vector in the two functions rather than in this present function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(saturation_degree + 2);</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(saturation_degree + 2);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                     quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> saturation_fe_face_values(saturation_fe,</div>
<div class="line">                                              face_quadrature_formula,</div>
<div class="line">                                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> darcy_fe_face_values(darcy_fe,</div>
<div class="line">                                         face_quadrature_formula,</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> saturation_fe_face_values_neighbor(</div>
<div class="line">    saturation_fe, face_quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">    saturation_dof_handler.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_u_F_prime = get_max_u_F_prime();</div>
<div class="line">  <span class="keyword">const</span> std::pair&lt;double, double&gt; global_S_range =</div>
<div class="line">    get_extrapolated_saturation_range();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_S_variation =</div>
<div class="line">    global_S_range.second - global_S_range.first;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>       = saturation_dof_handler.begin_active();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> endc       = saturation_dof_handler.end();</div>
<div class="line">  <span class="keyword">auto</span>       darcy_cell = darcy_dof_handler.begin_active();</div>
<div class="line">  <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++darcy_cell)</div>
<div class="line">    {</div>
<div class="line">      saturation_fe_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      darcy_fe_values.reinit(darcy_cell);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      assemble_saturation_rhs_cell_term(saturation_fe_values,</div>
<div class="line">                                        darcy_fe_values,</div>
<div class="line">                                        global_max_u_F_prime,</div>
<div class="line">                                        global_S_variation,</div>
<div class="line">                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">          {</div>
<div class="line">            darcy_fe_face_values.reinit(darcy_cell, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">            saturation_fe_face_values.reinit(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">            assemble_saturation_rhs_boundary_term(saturation_fe_face_values,</div>
<div class="line">                                                  darcy_fe_face_values,</div>
<div class="line">                                                  <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">          }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_rhs_cell_term"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_cell_term</h4>
<p>This function takes care of integrating the cell terms of the right hand side of the saturation equation, and then assembling it into the global right hand side vector. Given the discussion in the introduction, the form of these contributions is clear. The only tricky part is getting the artificial viscosity and all that is necessary to compute it. The first half of the function is devoted to this task.</p>
<p>The last part of the function is copying the local contributions into the global vector with position specified in local_dof_indices.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_cell_term(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       saturation_fe_values,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       darcy_fe_values,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_max_u_F_prime,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_S_variation,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe_values.dofs_per_cell;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = saturation_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt;         old_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt;         old_old_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_grad_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_grad_saturation_solution_values(</div>
<div class="line">    <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; present_darcy_solution_values(</div>
<div class="line">    <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line"> </div>
<div class="line">  saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                           old_saturation_solution_values);</div>
<div class="line">  saturation_fe_values.get_function_values(</div>
<div class="line">    old_old_saturation_solution, old_old_saturation_solution_values);</div>
<div class="line">  saturation_fe_values.get_function_gradients(</div>
<div class="line">    old_saturation_solution, old_grad_saturation_solution_values);</div>
<div class="line">  saturation_fe_values.get_function_gradients(</div>
<div class="line">    old_old_saturation_solution, old_old_grad_saturation_solution_values);</div>
<div class="line">  darcy_fe_values.get_function_values(darcy_solution,</div>
<div class="line">                                      present_darcy_solution_values);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">    compute_viscosity(old_saturation_solution_values,</div>
<div class="line">                      old_old_saturation_solution_values,</div>
<div class="line">                      old_grad_saturation_solution_values,</div>
<div class="line">                      old_old_grad_saturation_solution_values,</div>
<div class="line">                      present_darcy_solution_values,</div>
<div class="line">                      global_max_u_F_prime,</div>
<div class="line">                      global_S_variation,</div>
<div class="line">                      saturation_fe_values.get_cell()-&gt;diameter());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span>   old_s = old_saturation_solution_values[q];</div>
<div class="line">        <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> present_u;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          present_u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_solution_values[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span>         phi_i_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> grad_phi_i_s =</div>
<div class="line">          saturation_fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line"> </div>
<div class="line">        local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">          (time_step * <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>(old_s, viscosity) * present_u *</div>
<div class="line">             grad_phi_i_s -</div>
<div class="line">           time_step * nu * old_grad_saturation_solution_values[q] *</div>
<div class="line">             grad_phi_i_s +</div>
<div class="line">           porosity * old_s * phi_i_s) *</div>
<div class="line">          saturation_fe_values.JxW(q);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">  saturation_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                    <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                    saturation_rhs);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_rhs_boundary_term"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_boundary_term</h4>
<p>The next function is responsible for the boundary integral terms in the right hand side form of the saturation equation. For these, we have to compute the upwinding flux on the global boundary faces, i.e. we impose Dirichlet boundary conditions weakly only on inflow parts of the global boundary. As before, this has been described in <a class="el" href="step_21.html">step-21</a> so we refrain from giving more descriptions about that.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_boundary_term(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   saturation_fe_face_values,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   darcy_fe_face_values,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe_face_values.dofs_per_cell;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points =</div>
<div class="line">    saturation_fe_face_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; old_saturation_solution_values_face(n_face_q_points);</div>
<div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; present_darcy_solution_values_face(</div>
<div class="line">    n_face_q_points, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">  std::vector&lt;double&gt; neighbor_saturation(n_face_q_points);</div>
<div class="line"> </div>
<div class="line">  saturation_fe_face_values.get_function_values(</div>
<div class="line">    old_saturation_solution, old_saturation_solution_values_face);</div>
<div class="line">  darcy_fe_face_values.get_function_values(</div>
<div class="line">    darcy_solution, present_darcy_solution_values_face);</div>
<div class="line"> </div>
<div class="line">  SaturationBoundaryValues&lt;dim&gt; saturation_boundary_values;</div>
<div class="line">  saturation_boundary_values.value_list(</div>
<div class="line">    saturation_fe_face_values.get_quadrature_points(), neighbor_saturation);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_q_points; ++q)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> present_u_face;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        present_u_face[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_solution_values_face[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> normal_flux =</div>
<div class="line">        present_u_face * saturation_fe_face_values.normal_vector(q);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">bool</span> is_outflow_q_point = (normal_flux &gt;= 0);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) -=</div>
<div class="line">          time_step * normal_flux *</div>
<div class="line">          <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>((is_outflow_q_point == <span class="keyword">true</span> ?</div>
<div class="line">                             old_saturation_solution_values_face[q] :</div>
<div class="line">                             neighbor_saturation[q]),</div>
<div class="line">                          viscosity) *</div>
<div class="line">          saturation_fe_face_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q) *</div>
<div class="line">          saturation_fe_face_values.JxW(q);</div>
<div class="line">    }</div>
<div class="line">  saturation_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                    <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                    saturation_rhs);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimsolve"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::solve</h3>
<p>This function implements the operator splitting algorithm, i.e. in each time step it either re-computes the solution of the Darcy system or extrapolates velocity/pressure from previous time steps, then determines the size of the time step, and then updates the saturation variable. The implementation largely follows similar code in <a class="el" href="step_31.html">step-31</a>. It is, next to the <a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a> function, the central one in this program.</p>
<p>At the beginning of the function, we ask whether to solve the pressure-velocity part by evaluating the a posteriori criterion (see the following function). If necessary, we will solve the pressure-velocity part using the GMRES solver with the Schur complement block preconditioner as is described in the introduction.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">TwoPhaseFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> solve_for_pressure_and_velocity =</div>
<div class="line">    determine_whether_to_solve_for_pressure_and_velocity();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (solve_for_pressure_and_velocity == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving Darcy (pressure-velocity) system...&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      assemble_darcy_system();</div>
<div class="line">      build_darcy_preconditioner();</div>
<div class="line"> </div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                           <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">          mp_inverse(darcy_preconditioner_matrix.block(1, 1),</div>
<div class="line">                     *Mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">          <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a2a3c696b5297cb04d9a7137121aba8b7">TrilinosWrappers::PreconditionIC</a>,</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">          <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(darcy_matrix, mp_inverse, *Amg_preconditioner);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(darcy_matrix.m(),</div>
<div class="line">                                     1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-16 * darcy_rhs.l2_norm());</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverGMRES.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> gmres(</div>
<div class="line">          solver_control,</div>
<div class="line">          <a class="code" href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">            100));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; darcy_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (darcy_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">            darcy_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line">        gmres.solve(darcy_matrix, darcy_solution, darcy_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">        darcy_constraints.distribute(darcy_solution);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;        ...&quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot; GMRES iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      {</div>
<div class="line">        second_last_computed_darcy_solution = last_computed_darcy_solution;</div>
<div class="line">        last_computed_darcy_solution        = darcy_solution;</div>
<div class="line"> </div>
<div class="line">        saturation_matching_last_computed_darcy_solution =</div>
<div class="line">          saturation_solution;</div>
<div class="line">      }</div>
<div class="line">    }</div>
</div><!-- fragment --><p>On the other hand, if we have decided that we don't want to compute the solution of the Darcy system for the current time step, then we need to simply extrapolate the previous two Darcy solutions to the same time as we would have computed the velocity/pressure at. We do a simple linear extrapolation, i.e. given the current length \(dt\) of the macro time step from the time when we last computed the Darcy solution to now (given by <code>current_macro_time_step</code>), and \(DT\) the length of the last macro time step (given by <code>old_macro_time_step</code>), then we get \(u^\ast = u_p + dt \frac{u_p-u_{pp}}{DT} = (1+dt/DT)u_p - dt/DT u_{pp}\), where \(u_p\) and \(u_{pp}\) are the last two computed Darcy solutions. We can implement this formula using just two lines of code.</p>
<p>Note that the algorithm here only works if we have at least two previously computed Darcy solutions from which we can extrapolate to the current time, and this is ensured by requiring re-computation of the Darcy solution for the first 2 time steps.</p>
<div class="fragment"><div class="line"><span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    darcy_solution = last_computed_darcy_solution;</div>
<div class="line">    darcy_solution.sadd(1 + current_macro_time_step / old_macro_time_step,</div>
<div class="line">                        -current_macro_time_step / old_macro_time_step,</div>
<div class="line">                        second_last_computed_darcy_solution);</div>
<div class="line">  }</div>
</div><!-- fragment --><p>With the so computed velocity vector, compute the optimal time step based on the CFL criterion discussed in the introduction...</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  old_time_step = time_step;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> max_u_F_prime = get_max_u_F_prime();</div>
<div class="line">  <span class="keywordflow">if</span> (max_u_F_prime &gt; 0)</div>
<div class="line">    time_step = porosity * <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) /</div>
<div class="line">                saturation_degree / max_u_F_prime / 50;</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    time_step = end_time - <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>...and then also update the length of the macro time steps we use while we're dealing with time step sizes. In particular, this involves: (i) If we have just recomputed the Darcy solution, then the length of the previous macro time step is now fixed and the length of the current macro time step is, up to now, simply the length of the current (micro) time step. (ii) If we have not recomputed the Darcy solution, then the length of the current macro time step has just grown by <code>time_step</code>.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (solve_for_pressure_and_velocity == <span class="keyword">true</span>)</div>
<div class="line">  {</div>
<div class="line">    old_macro_time_step     = current_macro_time_step;</div>
<div class="line">    current_macro_time_step = time_step;</div>
<div class="line">  }</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">  current_macro_time_step += time_step;</div>
</div><!-- fragment --><p>The last step in this function is to recompute the saturation solution based on the velocity field we've just obtained. This naturally happens in every time step, and we don't skip any of these computations. At the end of computing the saturation, we project back into the allowed interval \([0,1]\) to make sure our solution remains physical.</p>
<div class="fragment"><div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving saturation transport equation...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    assemble_saturation_system();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(saturation_matrix.m(),</div>
<div class="line">                                 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-16 * saturation_rhs.l2_norm());</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">    <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(saturation_matrix);</div>
<div class="line"> </div>
<div class="line">    cg.solve(saturation_matrix,</div>
<div class="line">             saturation_solution,</div>
<div class="line">             saturation_rhs,</div>
<div class="line">             <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">    saturation_constraints.distribute(saturation_solution);</div>
<div class="line">    project_back_saturation();</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;        ...&quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimrefine_mesh"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::refine_mesh</h3>
<p>The next function does the refinement and coarsening of the mesh. It does its work in three blocks: (i) Compute refinement indicators by looking at the gradient of a solution vector extrapolated linearly from the previous two using the respective sizes of the time step (or taking the only solution we have if this is the first time step). (ii) Flagging those cells for refinement and coarsening where the gradient is larger or smaller than a certain threshold, preserving minimal and maximal levels of mesh refinement. (iii) Transferring the solution from the old to the new mesh. None of this is particularly difficult.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> refinement_indicators(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQMidpoint.html">QMidpoint&lt;dim&gt;</a>        quadrature_formula;</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(saturation_fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_saturation(1);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> extrapolated_saturation_solution(</div>
<div class="line">      saturation_solution);</div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">      extrapolated_saturation_solution.sadd((1. + time_step / old_time_step),</div>
<div class="line">                                            time_step / old_time_step,</div>
<div class="line">                                            old_saturation_solution);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_no = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values.get_function_gradients(extrapolated_saturation_solution,</div>
<div class="line">                                         grad_saturation);</div>
<div class="line"> </div>
<div class="line">        refinement_indicators(cell_no) = grad_saturation[0].norm();</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_no = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_coarsen_flag();</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level()) &lt; max_grid_level) &amp;&amp;</div>
<div class="line">            (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(refinement_indicators(cell_no)) &gt;</div>
<div class="line">             saturation_refinement_threshold))</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;set_refine_flag();</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level()) &gt;</div>
<div class="line">                  min_grid_level) &amp;&amp;</div>
<div class="line">                 (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(refinement_indicators(cell_no)) &lt;</div>
<div class="line">                  0.5 * saturation_refinement_threshold))</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;set_coarsen_flag();</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_saturation(3);</div>
<div class="line">    x_saturation[0] = saturation_solution;</div>
<div class="line">    x_saturation[1] = old_saturation_solution;</div>
<div class="line">    x_saturation[2] = saturation_matching_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; x_darcy(2);</div>
<div class="line">    x_darcy[0] = last_computed_darcy_solution;</div>
<div class="line">    x_darcy[1] = second_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> saturation_soltrans(</div>
<div class="line">      saturation_dof_handler);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> darcy_soltrans(</div>
<div class="line">      darcy_dof_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">    saturation_soltrans.prepare_for_coarsening_and_refinement(x_saturation);</div>
<div class="line"> </div>
<div class="line">    darcy_soltrans.prepare_for_coarsening_and_refinement(x_darcy);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp_saturation(3);</div>
<div class="line">    tmp_saturation[0].reinit(saturation_solution);</div>
<div class="line">    tmp_saturation[1].reinit(saturation_solution);</div>
<div class="line">    tmp_saturation[2].reinit(saturation_solution);</div>
<div class="line">    saturation_soltrans.interpolate(x_saturation, tmp_saturation);</div>
<div class="line"> </div>
<div class="line">    saturation_solution                              = tmp_saturation[0];</div>
<div class="line">    old_saturation_solution                          = tmp_saturation[1];</div>
<div class="line">    saturation_matching_last_computed_darcy_solution = tmp_saturation[2];</div>
<div class="line"> </div>
<div class="line">    saturation_constraints.distribute(saturation_solution);</div>
<div class="line">    saturation_constraints.distribute(old_saturation_solution);</div>
<div class="line">    saturation_constraints.distribute(</div>
<div class="line">      saturation_matching_last_computed_darcy_solution);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; tmp_darcy(2);</div>
<div class="line">    tmp_darcy[0].reinit(darcy_solution);</div>
<div class="line">    tmp_darcy[1].reinit(darcy_solution);</div>
<div class="line">    darcy_soltrans.interpolate(x_darcy, tmp_darcy);</div>
<div class="line"> </div>
<div class="line">    last_computed_darcy_solution        = tmp_darcy[0];</div>
<div class="line">    second_last_computed_darcy_solution = tmp_darcy[1];</div>
<div class="line"> </div>
<div class="line">    darcy_constraints.distribute(last_computed_darcy_solution);</div>
<div class="line">    darcy_constraints.distribute(second_last_computed_darcy_solution);</div>
<div class="line"> </div>
<div class="line">    rebuild_saturation_matrix = <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimoutput_results"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::output_results</h3>
<p>This function generates graphical output. It is in essence a copy of the implementation in <a class="el" href="step_31.html">step-31</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> joint_fe(darcy_fe, 1, saturation_fe, 1);</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>     joint_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">  joint_dof_handler.distribute_dofs(joint_fe);</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_dof_handler.n_dofs() ==</div>
<div class="line">           darcy_dof_handler.n_dofs() + saturation_dof_handler.n_dofs(),</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> joint_solution(joint_dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_joint_dof_indices(</div>
<div class="line">      joint_fe.n_dofs_per_cell());</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_darcy_dof_indices(</div>
<div class="line">      darcy_fe.n_dofs_per_cell());</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_saturation_dof_indices(</div>
<div class="line">      saturation_fe.n_dofs_per_cell());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       joint_cell      = joint_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> joint_endc      = joint_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       darcy_cell      = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; joint_cell != joint_endc;</div>
<div class="line">         ++joint_cell, ++darcy_cell, ++saturation_cell)</div>
<div class="line">      {</div>
<div class="line">        joint_cell-&gt;get_dof_indices(local_joint_dof_indices);</div>
<div class="line">        darcy_cell-&gt;get_dof_indices(local_darcy_dof_indices);</div>
<div class="line">        saturation_cell-&gt;get_dof_indices(local_saturation_dof_indices);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; joint_fe.n_dofs_per_cell(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 0)</div>
<div class="line">            {</div>
<div class="line">              <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                       local_darcy_dof_indices.size(),</div>
<div class="line">                     <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">              joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) = darcy_solution(</div>
<div class="line">                local_darcy_dof_indices[joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                                          .second]);</div>
<div class="line">            }</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">              <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 1,</div>
<div class="line">                     <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">              <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                       local_darcy_dof_indices.size(),</div>
<div class="line">                     <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">              joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) =</div>
<div class="line">                saturation_solution(</div>
<div class="line">                  local_saturation_dof_indices</div>
<div class="line">                    [joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second]);</div>
<div class="line">            }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">  std::vector&lt;std::string&gt; joint_solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  joint_solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line">  joint_solution_names.emplace_back(<span class="stringliteral">&quot;saturation&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    data_component_interpretation(</div>
<div class="line">      <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(joint_dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(joint_solution,</div>
<div class="line">                           joint_solution_names,</div>
<div class="line">                           <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                           data_component_interpretation);</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  std::string filename =</div>
<div class="line">    <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 5) + <span class="stringliteral">&quot;.vtu&quot;</span>;</div>
<div class="line">  std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(filename);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Toolfunctions"></a> </p><h3>Tool functions</h3>
<p><a class="anchor" id="TwoPhaseFlowProblemdimdetermine_whether_to_solve_for_pressure_and_velocity"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::determine_whether_to_solve_for_pressure_and_velocity</h4>
<p>This function implements the a posteriori criterion for adaptive operator splitting. The function is relatively straightforward given the way we have implemented other functions above and given the formula for the criterion derived in the paper.</p>
<p>If one decides that one wants the original IMPES method in which the Darcy equation is solved in every time step, then this can be achieved by setting the threshold value <code>AOS_threshold</code> (with a default of \(5.0\)) to zero, thereby forcing the function to always return true.</p>
<p>Finally, note that the function returns true unconditionally for the first two time steps to ensure that we have always solved the Darcy system at least twice when skipping its solution, thereby allowing us to extrapolate the velocity from the last two solutions in <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">bool</span> TwoPhaseFlowProblem&lt;</div>
<div class="line">  <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::determine_whether_to_solve_for_pressure_and_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">if</span> (timestep_number &lt;= 2)</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(saturation_degree + 2);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(saturation_fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; old_saturation_after_solving_pressure(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; present_saturation(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_global_aop_indicator = 0.0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> max_local_mobility_reciprocal_difference = 0.0;</div>
<div class="line">      <span class="keywordtype">double</span> max_local_permeability_inverse_l1_norm   = 0.0;</div>
<div class="line"> </div>
<div class="line">      fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      fe_values.get_function_values(</div>
<div class="line">        saturation_matching_last_computed_darcy_solution,</div>
<div class="line">        old_saturation_after_solving_pressure);</div>
<div class="line">      fe_values.get_function_values(saturation_solution, present_saturation);</div>
<div class="line"> </div>
<div class="line">      k_inverse.value_list(fe_values.get_quadrature_points(),</div>
<div class="line">                           k_inverse_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> mobility_reciprocal_difference = <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(</div>
<div class="line">            <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(present_saturation[q], viscosity) -</div>
<div class="line">            <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_saturation_after_solving_pressure[q],</div>
<div class="line">                             viscosity));</div>
<div class="line"> </div>
<div class="line">          max_local_mobility_reciprocal_difference =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_mobility_reciprocal_difference,</div>
<div class="line">                     mobility_reciprocal_difference);</div>
<div class="line"> </div>
<div class="line">          max_local_permeability_inverse_l1_norm =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_permeability_inverse_l1_norm,</div>
<div class="line">                     <a class="code" href="classTensor.html#a93ba01d979880b278cd4b573dd9c653b">l1_norm</a>(k_inverse_values[q]));</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      max_global_aop_indicator =</div>
<div class="line">        <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_global_aop_indicator,</div>
<div class="line">                 (max_local_mobility_reciprocal_difference *</div>
<div class="line">                  max_local_permeability_inverse_l1_norm));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (max_global_aop_indicator &gt; AOS_threshold);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimproject_back_saturation"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::project_back_saturation</h4>
<p>The next function simply makes sure that the saturation values always remain within the physically reasonable range of \([0,1]\). While the continuous equations guarantee that this is so, the discrete equations don't. However, if we allow the discrete solution to escape this range we get into trouble because terms like \(F(S)\) and \(F&#39;(S)\) will produce unreasonable results (e.g. \(F&#39;(S)&lt;0\) for \(S&lt;0\), which would imply that the wetting fluid phase flows <em>against</em> the direction of the bulk fluid velocity)). Consequently, at the end of each time step, we simply project the saturation field back into the physically reasonable region.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::project_back_saturation()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; saturation_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    <span class="keywordflow">if</span> (saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) &lt; 0.2)</div>
<div class="line">      saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0.2;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) &gt; 1)</div>
<div class="line">      saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimget_max_u_F_prime"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::get_max_u_F_prime</h4>
<p>Another simpler helper function: Compute the maximum of the total velocity times the derivative of the fraction flow function, i.e., compute \(\|\mathbf{u} F&#39;(S)\|_{L_\infty(\Omega)}\). This term is used in both the computation of the time step as well as in normalizing the entropy-residual term in the artificial viscosity.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> TwoPhaseFlowProblem&lt;dim&gt;::get_max_u_F_prime()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(darcy_degree + 2);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                     quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; darcy_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>,</div>
<div class="line">                                                    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">  std::vector&lt;double&gt;         saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_velocity_times_dF_dS = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">  <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line">  <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">    {</div>
<div class="line">      darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">      darcy_fe_values.get_function_values(darcy_solution,</div>
<div class="line">                                          darcy_solution_values);</div>
<div class="line">      saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                               saturation_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = darcy_solution_values[q](<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> dF_dS =</div>
<div class="line">            <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(saturation_values[q], viscosity);</div>
<div class="line"> </div>
<div class="line">          max_velocity_times_dF_dS =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_velocity_times_dF_dS, <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>.norm() * dF_dS);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> max_velocity_times_dF_dS;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimget_extrapolated_saturation_range"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::get_extrapolated_saturation_range</h4>
<p>For computing the stabilization term, we need to know the range of the saturation variable. Unlike in <a class="el" href="step_31.html">step-31</a>, this range is trivially bounded by the interval \([0,1]\) but we can do a bit better by looping over a collection of quadrature points and seeing what the values are there. If we can, i.e., if there are at least two timesteps around, we can even take the values extrapolated to the next time step.</p>
<p>As before, the function is taken with minimal modifications from <a class="el" href="step_31.html">step-31</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">std::pair&lt;double, double&gt;</div>
<div class="line">TwoPhaseFlowProblem&lt;dim&gt;::get_extrapolated_saturation_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(saturation_degree + 2);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(saturation_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  std::vector&lt;double&gt; old_old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">             max_saturation = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">        {</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                        old_saturation_values);</div>
<div class="line">          fe_values.get_function_values(old_old_saturation_solution,</div>
<div class="line">                                        old_old_saturation_values);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> saturation =</div>
<div class="line">                (1. + time_step / old_time_step) * old_saturation_values[q] -</div>
<div class="line">                time_step / old_time_step * old_old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">              min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_saturation, saturation);</div>
<div class="line">              max_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_saturation, saturation);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> std::make_pair(min_saturation, max_saturation);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keywordtype">double</span> min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">             max_saturation = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">        {</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                        old_saturation_values);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> saturation = old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">              min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_saturation, saturation);</div>
<div class="line">              max_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_saturation, saturation);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> std::make_pair(min_saturation, max_saturation);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimcompute_viscosity"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::compute_viscosity</h4>
<p>The final tool function is used to compute the artificial viscosity on a given cell. This isn't particularly complicated if you have the formula for it in front of you, and looking at the implementation in <a class="el" href="step_31.html">step-31</a>. The major difference to that tutorial program is that the velocity here is not simply \(\mathbf u\) but \(\mathbf u F&#39;(S)\) and some of the formulas need to be adjusted accordingly.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> TwoPhaseFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_saturation,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_saturation,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_saturation_grads,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_saturation_grads,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;present_darcy_values,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_max_u_F_prime,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_S_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = .4 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 1;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (global_max_u_F_prime == 0)</div>
<div class="line">    <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 * cell_diameter;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_saturation.size();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_residual             = 0;</div>
<div class="line">  <span class="keywordtype">double</span> max_velocity_times_dF_dS = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> use_dF_dS = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_values[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> dS_dt = porosity *</div>
<div class="line">                           (old_saturation[q] - old_old_saturation[q]) /</div>
<div class="line">                           old_time_step;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> dF_dS = <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(</div>
<div class="line">        (old_saturation[q] + old_old_saturation[q]) / 2.0, viscosity);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_S =</div>
<div class="line">        u * dF_dS * (old_saturation_grads[q] + old_old_saturation_grads[q]) /</div>
<div class="line">        2.0;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> =</div>
<div class="line">        <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dS_dt + u_grad_S) *</div>
<div class="line">                 std::pow((old_saturation[q] + old_old_saturation[q]) / 2,</div>
<div class="line">                          <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 1.));</div>
<div class="line"> </div>
<div class="line">      max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">      max_velocity_times_dF_dS =</div>
<div class="line">        <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u * u) * (use_dF_dS ? <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(dF_dS, 1.) : 1),</div>
<div class="line">                 max_velocity_times_dF_dS);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = 1.0;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R * porosity *</div>
<div class="line">                                (global_max_u_F_prime)*global_S_variation /</div>
<div class="line">                                std::pow(global_Omega_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 2.);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (<a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a> *</div>
<div class="line">          (max_velocity_times_dF_dS)*<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(cell_diameter,</div>
<div class="line">                                              std::pow(cell_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) *</div>
<div class="line">                                                max_residual /</div>
<div class="line">                                                global_scaling));</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimrun"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::run</h3>
<p>This function is, besides <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code>, the primary function of this program as it controls the time iteration as well as when the solution is written into output files and when to do mesh refinement.</p>
<p>With the exception of the startup code that loops back to the beginning of the function through the <code>goto start_time_iteration</code> label, everything should be relatively straightforward. In any case, it mimics the corresponding function in <a class="el" href="step_31.html">step-31</a>.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">TwoPhaseFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 5 : 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 3 : 2);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, 0, 1);</div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(initial_refinement);</div>
<div class="line">    global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">  start_time_iteration:</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(saturation_dof_handler,</div>
<div class="line">                         saturation_constraints,</div>
<div class="line">                         <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(saturation_degree + 2),</div>
<div class="line">                         SaturationInitialValues&lt;dim&gt;(),</div>
<div class="line">                         old_saturation_solution);</div>
<div class="line"> </div>
<div class="line">    time_step = old_time_step = 0;</div>
<div class="line">    current_macro_time_step = old_macro_time_step = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;, dt=&quot;</span> &lt;&lt; time_step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % 200 == 0)</div>
<div class="line">          output_results();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % 25 == 0)</div>
<div class="line">          refine_mesh(initial_refinement,</div>
<div class="line">                      initial_refinement + n_pre_refinement_steps);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; n_pre_refinement_steps))</div>
<div class="line">          {</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">        ++timestep_number;</div>
<div class="line"> </div>
<div class="line">        old_old_saturation_solution = old_saturation_solution;</div>
<div class="line">        old_saturation_solution     = saturation_solution;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &lt;= end_time);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step43</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> function</h3>
<p>The main function looks almost the same as in all other programs. The need to initialize the MPI subsystem for a program that uses Trilinos &ndash; even for programs that do not actually run in parallel &ndash; is explained in <a class="el" href="step_31.html">step-31</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep43.html">Step43</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
</div><!-- fragment --><p>This program can only be run in serial. Otherwise, throw an exception.</p>
<div class="fragment"><div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-43&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      TwoPhaseFlowProblem&lt;2&gt; two_phase_flow_problem(1);</div>
<div class="line">      two_phase_flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>The output of this program is not really much different from that of <a class="el" href="step_21.html">step-21</a>: it solves the same problem, after all. Of more importance are quantitative metrics such as the accuracy of the solution as well as the time needed to compute it. These are documented in detail in the two publications listed at the top of this page and we won't repeat them here.</p>
<p>That said, no tutorial program is complete without a couple of good pictures, so here is some output of a run in 3d:</p>
<table align="center" class="tutorial" cellspacing="3" cellpadding="3">
<tr>
<td align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-43.3d.velocity.png" alt="" class="inline"/> </p>
<p class="intertd">Velocity vectors of flow through the porous medium with random permeability model. Streaming paths of high permeability and resulting high velocity are clearly visible. </p>
<p class="endtd"></p>
</td><td align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-43.3d.streamlines.png" alt="" class="inline"/> </p>
<p class="intertd">Streamlines colored by the saturation along the streamline path. Blue streamlines indicate low saturations, i.e., the flow along these streamlines must be slow or else more fluid would have been transported along them. On the other hand, green paths indicate high velocities since the fluid front has already reached further into the domain. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-43.3d.saturation.png" alt="" class="inline"/> </p>
<p class="intertd">Streamlines with a volume rendering of the saturation, showing how far the fluid front has advanced at this time. </p>
<p class="endtd"></p>
</td><td align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-43.3d.mesh.png" alt="" class="inline"/> </p>
<p class="intertd">Surface of the mesh showing the adaptive refinement along the front. </p>
<p class="endtd"></p>
</td></tr>
</table>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p>The primary objection one may have to this program is that it is still too slow: 3d computations on reasonably fine meshes are simply too expensive to be done routinely and with reasonably quick turn-around. This is similar to the situation we were in when we wrote <a class="el" href="step_31.html">step-31</a>, from which this program has taken much inspiration. The solution is similar as it was there as well: We need to parallelize the program in a way similar to how we derived <a class="el" href="step_32.html">step-32</a> out of <a class="el" href="step_31.html">step-31</a>. In fact, all of the techniques used in <a class="el" href="step_32.html">step-32</a> would be transferable to this program as well, making the program run on dozens or hundreds of processors immediately.</p>
<p>A different direction is to make the program more relevant to many other porous media applications. Specifically, one avenue is to go to the primary user of porous media flow simulators, namely the oil industry. There, applications in this area are dominated by multiphase flow (i.e., more than the two phases we have here), and the reactions they may have with each other (or any other way phases may exchange mass, such as through dissolution in and bubbling out of gas from the oil phase). Furthermore, the presence of gas often leads to compressibility effects of the fluid. Jointly, these effects are typically formulated in the widely-used "black oil model". True reactions between multiple phases also play a role in oil reservoir modeling when considering controlled burns of oil in the reservoir to raise pressure and temperature. These are much more complex problems, though, and left for future projects.</p>
<p>Finally, from a mathematical perspective, we have derived the criterion for re-computing the velocity/pressure solution at a given time step under the assumption that we want to compare the solution we would get at the current time step with that computed the last time we actually solved this system. However, in the program, whenever we did not re-compute the solution, we didn't just use the previously computed solution but instead extrapolated from the previous two times we solved the system. Consequently, the criterion was pessimistically stated: what we should really compare is the solution we would get at the current time step with the extrapolated one. Re-stating the theorem in this regard is left as an exercise.</p>
<p>There are also other ways to extend the mathematical foundation of this program; for example, one may say that it isn't the velocity we care about, but in fact the saturation. Thus, one may ask whether the criterion we use here to decide whether \(\mathbf u\) needs to be recomputed is appropriate; one may, for example, suggest that it is also important to decide whether (and by how much) a wrong velocity field in fact affects the solution of the saturation equation. This would then naturally lead to a sensitivity analysis.</p>
<p>From an algorithmic viewpoint, we have here used a criterion for refinement that is often used in engineering, namely by looking at the gradient of the solution. However, if you inspect the solution, you will find that it quickly leads to refinement almost everywhere, even in regions where it is clearly not necessary: frequently used therefore does not need to imply that it is a useful criterion to begin with. On the other hand, replacing this criterion by a different and better one should not be very difficult. For example, the <a class="el" href="classKellyErrorEstimator.html">KellyErrorEstimator</a> class used in many other programs should certainly be applicable to the current problem as well.</p>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2010 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Chih-Che Chueh, University of Victoria, 2010</span></div>
<div class="line"><span class="comment"> *          Wolfgang Bangerth, Texas A&amp;M University, 2010</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2tensor__function_8h.html">deal.II/base/tensor_function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep43.html">Step43</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>PressureBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    PressureBoundaryValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span></div>
<div class="line">  <a class="code" href="classStep43_1_1PressureBoundaryValues.html#ada3b35b91f535c5145f28dd5c0a59e1a">PressureBoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> 1 - <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>SaturationBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SaturationBoundaryValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span></div>
<div class="line">  <a class="code" href="classStep43_1_1SaturationBoundaryValues.html#a62e536e852f9b21701278273bb88f683">SaturationBoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] == 0)</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>SaturationInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SaturationInitialValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span></div>
<div class="line">  <a class="code" href="classStep43_1_1SaturationInitialValues.html#ac8b238d242b0856ec23f7b63ff7c014e">SaturationInitialValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> 0.2;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep43_1_1SaturationInitialValues.html#a523c8f9b3196dc1351e85af03e8ba1ad">SaturationInitialValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                                  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(c) = <a class="code" href="classStep43_1_1SaturationInitialValues.html#ac8b238d242b0856ec23f7b63ff7c014e">SaturationInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>SingleCurvingCrack</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>KInverse : <span class="keyword">public</span> <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      KInverse()</div>
<div class="line">        : <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;()</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span></div>
<div class="line">      <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                 <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>) <span class="keyword">const override</span>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">KInverse&lt;dim&gt;::value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                                   <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size() == <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size(),</div>
<div class="line">             <a class="code" href="group__Exceptions.html#ga6060b2304b8600f5efa0d31eeda0207d">ExcDimensionMismatch</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(), <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size()));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].clear();</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> distance_to_flowline =</div>
<div class="line">            <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][1] - 0.5 - 0.1 * <a class="code" href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">std::sin</a>(10 * <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][0]));</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> permeability =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(std::exp(-(distance_to_flowline * distance_to_flowline) /</div>
<div class="line">                              (0.1 * 0.1)),</div>
<div class="line">                     0.01);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = 1. / permeability;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  } <span class="comment">// namespace SingleCurvingCrack</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>RandomMedium</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>KInverse : <span class="keyword">public</span> <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      KInverse()</div>
<div class="line">        : <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;()</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span></div>
<div class="line">      <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                 <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">static</span> std::vector&lt;Point&lt;dim&gt;&gt; centers;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    std::vector&lt;Point&lt;dim&gt;&gt; KInverse&lt;dim&gt;::centers = []() {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a> =</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 40 : (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3 ? 100 : <span class="keywordflow">throw</span> <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()));</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;Point&lt;dim&gt;&gt; centers_list(<a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a>);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          centers_list[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(<a class="code" href="base_2utilities__0_8txt.html#abdaf96304944a8787ae4488ed5461fac">rand</a>()) / RAND_MAX;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> centers_list;</div>
<div class="line">    }();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">KInverse&lt;dim&gt;::value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                                   <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(), <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].clear();</div>
<div class="line"> </div>
<div class="line">          <span class="keywordtype">double</span> permeability = 0;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; centers.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            permeability +=</div>
<div class="line">              std::exp(-(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>] - centers[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]).norm_square() / (0.05 * 0.05));</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> normalized_permeability =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(permeability, 0.01), 4.);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = 1. / normalized_permeability;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  } <span class="comment">// namespace RandomMedium</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="namespaceStep43.html#abfa39791422beb7a56fabd07a254ca56">mobility_inverse</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span> 1.0 / (1.0 / viscosity * S * S + (1 - S) * (1 - S));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="namespaceStep43.html#aa9d1d2a552ddb355d5871cbafc33c050">fractional_flow</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((S &gt;= 0) &amp;&amp; (S &lt;= 1),</div>
<div class="line">           <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Saturation is outside its physically valid range.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> S * S / (S * S + viscosity * (1 - S) * (1 - S));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((S &gt;= 0) &amp;&amp; (S &lt;= 1),</div>
<div class="line">           <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Saturation is outside its physically valid range.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> temp = (S * S + viscosity * (1 - S) * (1 - S));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> numerator =</div>
<div class="line">      2.0 * S * temp - S * S * (2.0 * S - 2.0 * viscosity * (1 - S));</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> denominator = <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(temp, 2.0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> F_prime = numerator / denominator;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(F_prime &gt;= 0, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> F_prime;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                    <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(VectorType &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerType &amp;           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">      <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">      <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">      : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">      , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">      VectorType &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">      <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-7 * src.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">try</span></div>
<div class="line">        {</div>
<div class="line">          cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>.what()));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      BlockSchurPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">        <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                            PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">        <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                 <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">        darcy_matrix;</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                             PreconditionerTypeMp&gt;&gt;</div>
<div class="line">                                 m_inverse;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div>
<div class="line">      BlockSchurPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">        <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                            PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">        <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner)</div>
<div class="line">      : darcy_matrix(&amp;S)</div>
<div class="line">      , m_inverse(&amp;Mpinv)</div>
<div class="line">      , a_preconditioner(Apreconditioner)</div>
<div class="line">      , tmp(<a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(darcy_matrix-&gt;<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1, 1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>()))</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keywordtype">void</span></div>
<div class="line">    <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult</a>(</div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">      darcy_matrix-&gt;block(1, 0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">      tmp *= -1;</div>
<div class="line">      m_inverse-&gt;vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">    }</div>
<div class="line">  } <span class="comment">// namespace LinearSolvers</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>);</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_darcy_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span> build_darcy_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_darcy_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_matrix();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_rhs();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_rhs_cell_term(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       saturation_fe_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       darcy_fe_values,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_max_u_F_prime,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_S_variation,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_rhs_boundary_term(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   saturation_fe_face_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   darcy_fe_face_values,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span> refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line">    <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>                    get_max_u_F_prime() <span class="keyword">const</span>;</div>
<div class="line">    std::pair&lt;double, double&gt; get_extrapolated_saturation_range() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">bool</span>   determine_whether_to_solve_for_pressure_and_velocity() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span>   project_back_saturation();</div>
<div class="line">    <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_saturation,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_saturation,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_saturation_grads,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_saturation_grads,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;present_darcy_values,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_max_u_F_prime,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_S_variation,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <span class="keywordtype">double</span>             global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        darcy_degree;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             darcy_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           darcy_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> darcy_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> darcy_preconditioner_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> darcy_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> darcy_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> darcy_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> darcy_rhs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> last_computed_darcy_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> second_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        saturation_degree;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 saturation_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           saturation_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> saturation_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> saturation_matrix;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> saturation_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_saturation_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_saturation_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> saturation_rhs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div>
<div class="line">      saturation_matching_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> saturation_refinement_threshold;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>       <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> end_time;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> current_macro_time_step;</div>
<div class="line">    <span class="keywordtype">double</span> old_macro_time_step;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>       time_step;</div>
<div class="line">    <span class="keywordtype">double</span>       old_time_step;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> porosity;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> AOS_threshold;</div>
<div class="line"> </div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt; Amg_preconditioner;</div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt; Mp_preconditioner;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_saturation_matrix;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> RandomMedium::KInverse&lt;dim&gt; k_inverse;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::TwoPhaseFlowProblem</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">    , global_Omega_diameter(std::numeric_limits&lt;<a class="code" href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a>&gt;::quiet_NaN())</div>
<div class="line">    , <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    , darcy_degree(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    , darcy_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(darcy_degree + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(darcy_degree), 1)</div>
<div class="line">    , darcy_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    saturation_degree(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1)</div>
<div class="line">    , saturation_fe(saturation_degree)</div>
<div class="line">    , saturation_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    saturation_refinement_threshold(0.5)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>(0)</div>
<div class="line">    , end_time(10)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    current_macro_time_step(0)</div>
<div class="line">    , old_macro_time_step(0)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    time_step(0)</div>
<div class="line">    , old_time_step(0)</div>
<div class="line">    , timestep_number(0)</div>
<div class="line">    , viscosity(0.2)</div>
<div class="line">    , porosity(1.0)</div>
<div class="line">    , AOS_threshold(3.0)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    rebuild_saturation_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::setup_dofs</a>()</div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;unsigned int&gt; darcy_block_component(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">    darcy_block_component[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">    {</div>
<div class="line">      darcy_dof_handler.distribute_dofs(darcy_fe);</div>
<div class="line">      <a class="code" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>(darcy_dof_handler);</div>
<div class="line">      <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(darcy_dof_handler, darcy_block_component);</div>
<div class="line"> </div>
<div class="line">      darcy_constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                              darcy_constraints);</div>
<div class="line">      darcy_constraints.close();</div>
<div class="line">    }</div>
<div class="line">    {</div>
<div class="line">      saturation_dof_handler.distribute_dofs(saturation_fe);</div>
<div class="line"> </div>
<div class="line">      saturation_constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(saturation_dof_handler,</div>
<div class="line">                                              saturation_constraints);</div>
<div class="line">      saturation_constraints.close();</div>
<div class="line">    }</div>
<div class="line">    {</div>
<div class="line">      darcy_preconditioner_constraints.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                              darcy_preconditioner_constraints);</div>
<div class="line">      <a class="code" href="group__constraints.html#ga06c0301bc74dd4c67a3d1db1000647f3">DoFTools::make_zero_boundary_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                               darcy_preconditioner_constraints,</div>
<div class="line">                                               darcy_fe.component_mask(</div>
<div class="line">                                                 <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>));</div>
<div class="line"> </div>
<div class="line">      darcy_preconditioner_constraints.close();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; darcy_dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(darcy_dof_handler,</div>
<div class="line">                                        darcy_block_component);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = darcy_dofs_per_block[0],</div>
<div class="line">                       n_p = darcy_dofs_per_block[1],</div>
<div class="line">                       n_s = saturation_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_s &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div>
<div class="line">              &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_s &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      darcy_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_u);</div>
<div class="line">      dsp.block(0, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_p);</div>
<div class="line">      dsp.block(1, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_u);</div>
<div class="line">      dsp.block(1, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        darcy_dof_handler, coupling, dsp, darcy_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      darcy_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      Amg_preconditioner.reset();</div>
<div class="line">      Mp_preconditioner.reset();</div>
<div class="line">      darcy_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_u);</div>
<div class="line">      dsp.block(0, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_p);</div>
<div class="line">      dsp.block(1, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_u);</div>
<div class="line">      dsp.block(1, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        darcy_dof_handler, coupling, dsp, darcy_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      darcy_preconditioner_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      saturation_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_s, n_s);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(saturation_dof_handler,</div>
<div class="line">                                      dsp,</div>
<div class="line">                                      saturation_constraints,</div>
<div class="line">                                      <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      saturation_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;IndexSet&gt; darcy_partitioning(2);</div>
<div class="line">    darcy_partitioning[0] = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_u);</div>
<div class="line">    darcy_partitioning[1] = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_p);</div>
<div class="line">    darcy_solution.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    last_computed_darcy_solution.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    last_computed_darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    second_last_computed_darcy_solution.reinit(darcy_partitioning,</div>
<div class="line">                                               MPI_COMM_WORLD);</div>
<div class="line">    second_last_computed_darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    darcy_rhs.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    darcy_rhs.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> saturation_partitioning = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_s);</div>
<div class="line">    saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_old_saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    saturation_matching_last_computed_darcy_solution.reinit(</div>
<div class="line">      saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    saturation_rhs.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_preconditioner</a>()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding darcy preconditioner...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    darcy_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(darcy_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     darcy_fe_values(darcy_fe,</div>
<div class="line">                                  quadrature_formula,</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = darcy_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">      {</div>
<div class="line">        darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">        local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">        saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                                 old_saturation_values);</div>
<div class="line"> </div>
<div class="line">        k_inverse.value_list(darcy_fe_values.get_quadrature_points(),</div>
<div class="line">                             k_inverse_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> old_s = old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> inverse_mobility = <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_s, viscosity);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> mobility         = 1.0 / inverse_mobility;</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> permeability = <a class="code" href="base_2symmetric__tensor_8h.html#a3656e2f6095f612536b06139a6a2ca39">invert</a>(k_inverse_values[q]);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                grad_phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = darcy_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                {</div>
<div class="line">                  local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (k_inverse_values[q] * inverse_mobility * phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">                       phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] +</div>
<div class="line">                     permeability * mobility * grad_phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grad_phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                    darcy_fe_values.JxW(q);</div>
<div class="line">                }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        darcy_preconditioner_constraints.distribute_local_to_global(</div>
<div class="line">          local_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, darcy_preconditioner_matrix);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::build_darcy_preconditioner</a>()</div>
<div class="line">  {</div>
<div class="line">    assemble_darcy_preconditioner();</div>
<div class="line"> </div>
<div class="line">    Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">    Amg_preconditioner-&gt;initialize(darcy_preconditioner_matrix.block(0, 0));</div>
<div class="line"> </div>
<div class="line">    Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">    Mp_preconditioner-&gt;initialize(darcy_preconditioner_matrix.block(1, 1));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_system</a>()</div>
<div class="line">  {</div>
<div class="line">    darcy_matrix = 0;</div>
<div class="line">    darcy_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(darcy_degree + 2);</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(darcy_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe,</div>
<div class="line">                                  quadrature_formula,</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> darcy_fe_face_values(darcy_fe,</div>
<div class="line">                                           face_quadrature_formula,</div>
<div class="line">                                           <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = darcy_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>      = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points = face_quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a> pressure_right_hand_side;</div>
<div class="line">    <span class="keyword">const</span> PressureBoundaryValues&lt;dim&gt;  pressure_boundary_values;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         pressure_rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         boundary_values(n_face_q_points);</div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;         div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;         phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">      {</div>
<div class="line">        darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">        local_matrix = 0;</div>
<div class="line">        local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                                 old_saturation_values);</div>
<div class="line"> </div>
<div class="line">        pressure_right_hand_side.<a class="code" href="classFunctions_1_1ConstantFunction.html#a6a3224d6e805fa73629130e021a7285b">value_list</a>(</div>
<div class="line">          darcy_fe_values.get_quadrature_points(), pressure_rhs_values);</div>
<div class="line">        k_inverse.value_list(darcy_fe_values.get_quadrature_points(),</div>
<div class="line">                             k_inverse_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = darcy_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> old_s = old_saturation_values[q];</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt;= <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                  {</div>
<div class="line">                    local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      (phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * k_inverse_values[q] *</div>
<div class="line">                         <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_s, viscosity) * phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] -</div>
<div class="line">                       div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                      darcy_fe_values.JxW(q);</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  (-phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * pressure_rhs_values[q]) * darcy_fe_values.JxW(q);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">            {</div>
<div class="line">              darcy_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line"> </div>
<div class="line">              pressure_boundary_values.value_list(</div>
<div class="line">                darcy_fe_face_values.get_quadrature_points(), boundary_values);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_q_points; ++q)</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> phi_i_u =</div>
<div class="line">                      darcy_fe_face_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line"> </div>
<div class="line">                    local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                      -(phi_i_u * darcy_fe_face_values.normal_vector(q) *</div>
<div class="line">                        boundary_values[q] * darcy_fe_face_values.JxW(q));</div>
<div class="line">                  }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> + 1; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">            local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = local_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        darcy_constraints.distribute_local_to_global(</div>
<div class="line">          local_matrix, local_rhs, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, darcy_matrix, darcy_rhs);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_system</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_saturation_matrix == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        saturation_matrix = 0;</div>
<div class="line">        assemble_saturation_matrix();</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    saturation_rhs = 0;</div>
<div class="line">    assemble_saturation_rhs();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_matrix</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(saturation_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        local_matrix = 0;</div>
<div class="line">        local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> phi_i_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <span class="keywordtype">double</span> phi_j_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q);</div>
<div class="line">                  local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    porosity * phi_i_s * phi_j_s * saturation_fe_values.JxW(q);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        saturation_constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                                          <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                          saturation_matrix);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(saturation_degree + 2);</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(saturation_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> saturation_fe_face_values(saturation_fe,</div>
<div class="line">                                                face_quadrature_formula,</div>
<div class="line">                                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> darcy_fe_face_values(darcy_fe,</div>
<div class="line">                                           face_quadrature_formula,</div>
<div class="line">                                           <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> saturation_fe_face_values_neighbor(</div>
<div class="line">      saturation_fe, face_quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">      saturation_dof_handler.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_u_F_prime = get_max_u_F_prime();</div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;double, double&gt; global_S_range =</div>
<div class="line">      get_extrapolated_saturation_range();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> global_S_variation =</div>
<div class="line">      global_S_range.second - global_S_range.first;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>       = saturation_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc       = saturation_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       darcy_cell = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++darcy_cell)</div>
<div class="line">      {</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(darcy_cell);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        assemble_saturation_rhs_cell_term(saturation_fe_values,</div>
<div class="line">                                          darcy_fe_values,</div>
<div class="line">                                          global_max_u_F_prime,</div>
<div class="line">                                          global_S_variation,</div>
<div class="line">                                          <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">            {</div>
<div class="line">              darcy_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(darcy_cell, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">              saturation_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">              assemble_saturation_rhs_boundary_term(saturation_fe_face_values,</div>
<div class="line">                                                    darcy_fe_face_values,</div>
<div class="line">                                                    <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">            }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_cell_term</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       saturation_fe_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       darcy_fe_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_max_u_F_prime,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_S_variation,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe_values.dofs_per_cell;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = saturation_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         old_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_old_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_grad_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_grad_saturation_solution_values(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; present_darcy_solution_values(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line"> </div>
<div class="line">    saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                             old_saturation_solution_values);</div>
<div class="line">    saturation_fe_values.get_function_values(</div>
<div class="line">      old_old_saturation_solution, old_old_saturation_solution_values);</div>
<div class="line">    saturation_fe_values.get_function_gradients(</div>
<div class="line">      old_saturation_solution, old_grad_saturation_solution_values);</div>
<div class="line">    saturation_fe_values.get_function_gradients(</div>
<div class="line">      old_old_saturation_solution, old_old_grad_saturation_solution_values);</div>
<div class="line">    darcy_fe_values.get_function_values(darcy_solution,</div>
<div class="line">                                        present_darcy_solution_values);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">      compute_viscosity(old_saturation_solution_values,</div>
<div class="line">                        old_old_saturation_solution_values,</div>
<div class="line">                        old_grad_saturation_solution_values,</div>
<div class="line">                        old_old_grad_saturation_solution_values,</div>
<div class="line">                        present_darcy_solution_values,</div>
<div class="line">                        global_max_u_F_prime,</div>
<div class="line">                        global_S_variation,</div>
<div class="line">                        saturation_fe_values.get_cell()-&gt;diameter());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span>   old_s = old_saturation_solution_values[q];</div>
<div class="line">          <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> present_u;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            present_u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_solution_values[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span>         phi_i_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> grad_phi_i_s =</div>
<div class="line">            saturation_fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line"> </div>
<div class="line">          local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">            (time_step * <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>(old_s, viscosity) * present_u *</div>
<div class="line">               grad_phi_i_s -</div>
<div class="line">             time_step * nu * old_grad_saturation_solution_values[q] *</div>
<div class="line">               grad_phi_i_s +</div>
<div class="line">             porosity * old_s * phi_i_s) *</div>
<div class="line">            saturation_fe_values.JxW(q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    saturation_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                      <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                      saturation_rhs);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_boundary_term</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   saturation_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   darcy_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe_face_values.dofs_per_cell;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points =</div>
<div class="line">      saturation_fe_face_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_saturation_solution_values_face(n_face_q_points);</div>
<div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; present_darcy_solution_values_face(</div>
<div class="line">      n_face_q_points, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">    std::vector&lt;double&gt; neighbor_saturation(n_face_q_points);</div>
<div class="line"> </div>
<div class="line">    saturation_fe_face_values.get_function_values(</div>
<div class="line">      old_saturation_solution, old_saturation_solution_values_face);</div>
<div class="line">    darcy_fe_face_values.get_function_values(</div>
<div class="line">      darcy_solution, present_darcy_solution_values_face);</div>
<div class="line"> </div>
<div class="line">    SaturationBoundaryValues&lt;dim&gt; saturation_boundary_values;</div>
<div class="line">    saturation_boundary_values.value_list(</div>
<div class="line">      saturation_fe_face_values.get_quadrature_points(), neighbor_saturation);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_q_points; ++q)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> present_u_face;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          present_u_face[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_solution_values_face[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> normal_flux =</div>
<div class="line">          present_u_face * saturation_fe_face_values.normal_vector(q);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> is_outflow_q_point = (normal_flux &gt;= 0);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) -=</div>
<div class="line">            time_step * normal_flux *</div>
<div class="line">            <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>((is_outflow_q_point == <span class="keyword">true</span> ?</div>
<div class="line">                               old_saturation_solution_values_face[q] :</div>
<div class="line">                               neighbor_saturation[q]),</div>
<div class="line">                            viscosity) *</div>
<div class="line">            saturation_fe_face_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q) *</div>
<div class="line">            saturation_fe_face_values.JxW(q);</div>
<div class="line">      }</div>
<div class="line">    saturation_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                      <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                      saturation_rhs);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">TwoPhaseFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> solve_for_pressure_and_velocity =</div>
<div class="line">      determine_whether_to_solve_for_pressure_and_velocity();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (solve_for_pressure_and_velocity == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving Darcy (pressure-velocity) system...&quot;</span></div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_darcy_system();</div>
<div class="line">        build_darcy_preconditioner();</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                             <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">            mp_inverse(darcy_preconditioner_matrix.block(1, 1),</div>
<div class="line">                       *Mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">            <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a2a3c696b5297cb04d9a7137121aba8b7">TrilinosWrappers::PreconditionIC</a>,</div>
<div class="line">            <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">            <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(darcy_matrix, mp_inverse, *Amg_preconditioner);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(darcy_matrix.m(),</div>
<div class="line">                                       1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-16 * darcy_rhs.l2_norm());</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classSolverGMRES.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> gmres(</div>
<div class="line">            solver_control,</div>
<div class="line">            <a class="code" href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">              100));</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; darcy_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">if</span> (darcy_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">              darcy_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line">          gmres.solve(darcy_matrix, darcy_solution, darcy_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">          darcy_constraints.distribute(darcy_solution);</div>
<div class="line"> </div>
<div class="line">          std::cout &lt;&lt; <span class="stringliteral">&quot;        ...&quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                    &lt;&lt; <span class="stringliteral">&quot; GMRES iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">          second_last_computed_darcy_solution = last_computed_darcy_solution;</div>
<div class="line">          last_computed_darcy_solution        = darcy_solution;</div>
<div class="line"> </div>
<div class="line">          saturation_matching_last_computed_darcy_solution =</div>
<div class="line">            saturation_solution;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        darcy_solution = last_computed_darcy_solution;</div>
<div class="line">        darcy_solution.sadd(1 + current_macro_time_step / old_macro_time_step,</div>
<div class="line">                            -current_macro_time_step / old_macro_time_step,</div>
<div class="line">                            second_last_computed_darcy_solution);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      old_time_step = time_step;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> max_u_F_prime = get_max_u_F_prime();</div>
<div class="line">      <span class="keywordflow">if</span> (max_u_F_prime &gt; 0)</div>
<div class="line">        time_step = porosity * <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) /</div>
<div class="line">                    saturation_degree / max_u_F_prime / 50;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        time_step = end_time - <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (solve_for_pressure_and_velocity == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        old_macro_time_step     = current_macro_time_step;</div>
<div class="line">        current_macro_time_step = time_step;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      current_macro_time_step += time_step;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving saturation transport equation...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      assemble_saturation_system();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(saturation_matrix.m(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-16 * saturation_rhs.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">      <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(saturation_matrix);</div>
<div class="line"> </div>
<div class="line">      cg.solve(saturation_matrix,</div>
<div class="line">               saturation_solution,</div>
<div class="line">               saturation_rhs,</div>
<div class="line">               <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">      saturation_constraints.distribute(saturation_solution);</div>
<div class="line">      project_back_saturation();</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;        ...&quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::refine_mesh</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> refinement_indicators(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQMidpoint.html">QMidpoint&lt;dim&gt;</a>        quadrature_formula;</div>
<div class="line">      <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(saturation_fe,</div>
<div class="line">                              quadrature_formula,</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line">      std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_saturation(1);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> extrapolated_saturation_solution(</div>
<div class="line">        saturation_solution);</div>
<div class="line">      <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">        extrapolated_saturation_solution.sadd((1. + time_step / old_time_step),</div>
<div class="line">                                              time_step / old_time_step,</div>
<div class="line">                                              old_saturation_solution);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_no = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values.get_function_gradients(extrapolated_saturation_solution,</div>
<div class="line">                                           grad_saturation);</div>
<div class="line"> </div>
<div class="line">          refinement_indicators(cell_no) = grad_saturation[0].norm();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_no = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_coarsen_flag();</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> ((<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level()) &lt; max_grid_level) &amp;&amp;</div>
<div class="line">              (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(refinement_indicators(cell_no)) &gt;</div>
<div class="line">               saturation_refinement_threshold))</div>
<div class="line">            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;set_refine_flag();</div>
<div class="line">          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level()) &gt;</div>
<div class="line">                    min_grid_level) &amp;&amp;</div>
<div class="line">                   (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(refinement_indicators(cell_no)) &lt;</div>
<div class="line">                    0.5 * saturation_refinement_threshold))</div>
<div class="line">            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;set_coarsen_flag();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_saturation(3);</div>
<div class="line">      x_saturation[0] = saturation_solution;</div>
<div class="line">      x_saturation[1] = old_saturation_solution;</div>
<div class="line">      x_saturation[2] = saturation_matching_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; x_darcy(2);</div>
<div class="line">      x_darcy[0] = last_computed_darcy_solution;</div>
<div class="line">      x_darcy[1] = second_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> saturation_soltrans(</div>
<div class="line">        saturation_dof_handler);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> darcy_soltrans(</div>
<div class="line">        darcy_dof_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">      saturation_soltrans.prepare_for_coarsening_and_refinement(x_saturation);</div>
<div class="line"> </div>
<div class="line">      darcy_soltrans.prepare_for_coarsening_and_refinement(x_darcy);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">      setup_dofs();</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp_saturation(3);</div>
<div class="line">      tmp_saturation[0].reinit(saturation_solution);</div>
<div class="line">      tmp_saturation[1].reinit(saturation_solution);</div>
<div class="line">      tmp_saturation[2].reinit(saturation_solution);</div>
<div class="line">      saturation_soltrans.interpolate(x_saturation, tmp_saturation);</div>
<div class="line"> </div>
<div class="line">      saturation_solution                              = tmp_saturation[0];</div>
<div class="line">      old_saturation_solution                          = tmp_saturation[1];</div>
<div class="line">      saturation_matching_last_computed_darcy_solution = tmp_saturation[2];</div>
<div class="line"> </div>
<div class="line">      saturation_constraints.distribute(saturation_solution);</div>
<div class="line">      saturation_constraints.distribute(old_saturation_solution);</div>
<div class="line">      saturation_constraints.distribute(</div>
<div class="line">        saturation_matching_last_computed_darcy_solution);</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; tmp_darcy(2);</div>
<div class="line">      tmp_darcy[0].reinit(darcy_solution);</div>
<div class="line">      tmp_darcy[1].reinit(darcy_solution);</div>
<div class="line">      darcy_soltrans.interpolate(x_darcy, tmp_darcy);</div>
<div class="line"> </div>
<div class="line">      last_computed_darcy_solution        = tmp_darcy[0];</div>
<div class="line">      second_last_computed_darcy_solution = tmp_darcy[1];</div>
<div class="line"> </div>
<div class="line">      darcy_constraints.distribute(last_computed_darcy_solution);</div>
<div class="line">      darcy_constraints.distribute(second_last_computed_darcy_solution);</div>
<div class="line"> </div>
<div class="line">      rebuild_saturation_matrix = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::output_results</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> joint_fe(darcy_fe, 1, saturation_fe, 1);</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>     joint_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">    joint_dof_handler.distribute_dofs(joint_fe);</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_dof_handler.n_dofs() ==</div>
<div class="line">             darcy_dof_handler.n_dofs() + saturation_dof_handler.n_dofs(),</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> joint_solution(joint_dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_joint_dof_indices(</div>
<div class="line">        joint_fe.n_dofs_per_cell());</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_darcy_dof_indices(</div>
<div class="line">        darcy_fe.n_dofs_per_cell());</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_saturation_dof_indices(</div>
<div class="line">        saturation_fe.n_dofs_per_cell());</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">auto</span>       joint_cell      = joint_dof_handler.begin_active();</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> joint_endc      = joint_dof_handler.end();</div>
<div class="line">      <span class="keyword">auto</span>       darcy_cell      = darcy_dof_handler.begin_active();</div>
<div class="line">      <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (; joint_cell != joint_endc;</div>
<div class="line">           ++joint_cell, ++darcy_cell, ++saturation_cell)</div>
<div class="line">        {</div>
<div class="line">          joint_cell-&gt;get_dof_indices(local_joint_dof_indices);</div>
<div class="line">          darcy_cell-&gt;get_dof_indices(local_darcy_dof_indices);</div>
<div class="line">          saturation_cell-&gt;get_dof_indices(local_saturation_dof_indices);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; joint_fe.n_dofs_per_cell(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">if</span> (joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 0)</div>
<div class="line">              {</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                         local_darcy_dof_indices.size(),</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) = darcy_solution(</div>
<div class="line">                  local_darcy_dof_indices[joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                                            .second]);</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              {</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 1,</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                         local_darcy_dof_indices.size(),</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) =</div>
<div class="line">                  saturation_solution(</div>
<div class="line">                    local_saturation_dof_indices</div>
<div class="line">                      [joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second]);</div>
<div class="line">              }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    std::vector&lt;std::string&gt; joint_solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">    joint_solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line">    joint_solution_names.emplace_back(<span class="stringliteral">&quot;saturation&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      data_component_interpretation(</div>
<div class="line">        <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(joint_dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(joint_solution,</div>
<div class="line">                             joint_solution_names,</div>
<div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                             data_component_interpretation);</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::string filename =</div>
<div class="line">      <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 5) + <span class="stringliteral">&quot;.vtu&quot;</span>;</div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(filename);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">bool</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem</a>&lt;</div>
<div class="line">    <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::determine_whether_to_solve_for_pressure_and_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number &lt;= 2)</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(saturation_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(saturation_fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_saturation_after_solving_pressure(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; present_saturation(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_global_aop_indicator = 0.0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> max_local_mobility_reciprocal_difference = 0.0;</div>
<div class="line">        <span class="keywordtype">double</span> max_local_permeability_inverse_l1_norm   = 0.0;</div>
<div class="line"> </div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values.get_function_values(</div>
<div class="line">          saturation_matching_last_computed_darcy_solution,</div>
<div class="line">          old_saturation_after_solving_pressure);</div>
<div class="line">        fe_values.get_function_values(saturation_solution, present_saturation);</div>
<div class="line"> </div>
<div class="line">        k_inverse.value_list(fe_values.get_quadrature_points(),</div>
<div class="line">                             k_inverse_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> mobility_reciprocal_difference = <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(</div>
<div class="line">              <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(present_saturation[q], viscosity) -</div>
<div class="line">              <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_saturation_after_solving_pressure[q],</div>
<div class="line">                               viscosity));</div>
<div class="line"> </div>
<div class="line">            max_local_mobility_reciprocal_difference =</div>
<div class="line">              <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_mobility_reciprocal_difference,</div>
<div class="line">                       mobility_reciprocal_difference);</div>
<div class="line"> </div>
<div class="line">            max_local_permeability_inverse_l1_norm =</div>
<div class="line">              <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_permeability_inverse_l1_norm,</div>
<div class="line">                       <a class="code" href="base_2tensor_8h.html#a93ba01d979880b278cd4b573dd9c653b">l1_norm</a>(k_inverse_values[q]));</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        max_global_aop_indicator =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_global_aop_indicator,</div>
<div class="line">                   (max_local_mobility_reciprocal_difference *</div>
<div class="line">                    max_local_permeability_inverse_l1_norm));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (max_global_aop_indicator &gt; AOS_threshold);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::project_back_saturation</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; saturation_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) &lt; 0.2)</div>
<div class="line">        saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0.2;</div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) &gt; 1)</div>
<div class="line">        saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 1;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::get_max_u_F_prime</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(darcy_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; darcy_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>,</div>
<div class="line">                                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">    std::vector&lt;double&gt;         saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_velocity_times_dF_dS = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">      {</div>
<div class="line">        darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">        darcy_fe_values.get_function_values(darcy_solution,</div>
<div class="line">                                            darcy_solution_values);</div>
<div class="line">        saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                                 saturation_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = darcy_solution_values[q](<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> dF_dS =</div>
<div class="line">              <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(saturation_values[q], viscosity);</div>
<div class="line"> </div>
<div class="line">            max_velocity_times_dF_dS =</div>
<div class="line">              <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_velocity_times_dF_dS, <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>.norm() * dF_dS);</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> max_velocity_times_dF_dS;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::pair&lt;double, double&gt;</div>
<div class="line">  <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::get_extrapolated_saturation_range</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(saturation_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(saturation_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">               max_saturation = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                          old_saturation_values);</div>
<div class="line">            fe_values.get_function_values(old_old_saturation_solution,</div>
<div class="line">                                          old_old_saturation_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> saturation =</div>
<div class="line">                  (1. + time_step / old_time_step) * old_saturation_values[q] -</div>
<div class="line">                  time_step / old_time_step * old_old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">                min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_saturation, saturation);</div>
<div class="line">                max_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_saturation, saturation);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> std::make_pair(min_saturation, max_saturation);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">               max_saturation = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                          old_saturation_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> saturation = old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">                min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_saturation, saturation);</div>
<div class="line">                max_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_saturation, saturation);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> std::make_pair(min_saturation, max_saturation);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::compute_viscosity</a>(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_saturation,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_saturation,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_saturation_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_saturation_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;present_darcy_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_max_u_F_prime,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_S_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = .4 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (global_max_u_F_prime == 0)</div>
<div class="line">      <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 * cell_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_saturation.size();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_residual             = 0;</div>
<div class="line">    <span class="keywordtype">double</span> max_velocity_times_dF_dS = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> use_dF_dS = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_values[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dS_dt = porosity *</div>
<div class="line">                             (old_saturation[q] - old_old_saturation[q]) /</div>
<div class="line">                             old_time_step;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dF_dS = <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(</div>
<div class="line">          (old_saturation[q] + old_old_saturation[q]) / 2.0, viscosity);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_S =</div>
<div class="line">          u * dF_dS * (old_saturation_grads[q] + old_old_saturation_grads[q]) /</div>
<div class="line">          2.0;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> =</div>
<div class="line">          <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dS_dt + u_grad_S) *</div>
<div class="line">                   std::pow((old_saturation[q] + old_old_saturation[q]) / 2,</div>
<div class="line">                            <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 1.));</div>
<div class="line"> </div>
<div class="line">        max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">        max_velocity_times_dF_dS =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u * u) * (use_dF_dS ? <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(dF_dS, 1.) : 1),</div>
<div class="line">                   max_velocity_times_dF_dS);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = 1.0;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R * porosity *</div>
<div class="line">                                  (global_max_u_F_prime)*global_S_variation /</div>
<div class="line">                                  std::pow(global_Omega_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 2.);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (<a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a> *</div>
<div class="line">            (max_velocity_times_dF_dS)*<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(cell_diameter,</div>
<div class="line">                                                std::pow(cell_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) *</div>
<div class="line">                                                  max_residual /</div>
<div class="line">                                                  global_scaling));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">TwoPhaseFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 5 : 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 3 : 2);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, 0, 1);</div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(initial_refinement);</div>
<div class="line">    global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">  start_time_iteration:</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(saturation_dof_handler,</div>
<div class="line">                         saturation_constraints,</div>
<div class="line">                         <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(saturation_degree + 2),</div>
<div class="line">                         SaturationInitialValues&lt;dim&gt;(),</div>
<div class="line">                         old_saturation_solution);</div>
<div class="line"> </div>
<div class="line">    time_step = old_time_step = 0;</div>
<div class="line">    current_macro_time_step = old_macro_time_step = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;, dt=&quot;</span> &lt;&lt; time_step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % 200 == 0)</div>
<div class="line">          output_results();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % 25 == 0)</div>
<div class="line">          refine_mesh(initial_refinement,</div>
<div class="line">                      initial_refinement + n_pre_refinement_steps);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; n_pre_refinement_steps))</div>
<div class="line">          {</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">        ++timestep_number;</div>
<div class="line"> </div>
<div class="line">        old_old_saturation_solution = old_saturation_solution;</div>
<div class="line">        old_saturation_solution     = saturation_solution;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &lt;= end_time);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step43</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep43.html">Step43</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-43&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;2&gt;</a> two_phase_flow_problem(1);</div>
<div class="line">      two_phase_flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><br  />
 This tutorial depends on <a class="el" href="step_31.html">step-31</a> .  
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Advectiondominatedtwophaseflowmathematicalmodel">Advection-dominated two-phase flow mathematical model.</a><a href="#Advectiondominatedtwophaseflowmathematicalmodel">Advection-dominated two-phase flow mathematical model.</a>
        <li><a href="#Adaptiveoperatorsplittingandtimestepping">Adaptive operator splitting and time stepping.</a><a href="#Adaptiveoperatorsplittingandtimestepping">Adaptive operator splitting and time stepping.</a>
        <li><a href="#Timediscretization">Time discretization.</a><a href="#Timediscretization">Time discretization.</a>
        <li><a href="#Weakformspacediscretizationforthepressurevelocitypart">Weak form, space discretization for the pressure-velocity part.</a><a href="#Weakformspacediscretizationforthepressurevelocitypart">Weak form, space discretization for the pressure-velocity part.</a>
        <li><a href="#Stabilizationweakformandspacediscretizationforthesaturationtransportequation">Stabilization, weak form and space discretization for the saturation transport equation.</a><a href="#Stabilizationweakformandspacediscretizationforthesaturationtransportequation">Stabilization, weak form and space discretization for the saturation transport equation.</a>
        <li><a href="#Adaptivemeshrefinement">Adaptive mesh refinement.</a><a href="#Adaptivemeshrefinement">Adaptive mesh refinement.</a>
        <li><a href="#Linearsystemanditspreconditioning">Linear system and its preconditioning.</a><a href="#Linearsystemanditspreconditioning">Linear system and its preconditioning.</a>
        <li><a href="#Thetestcases">The test cases.</a><a href="#Thetestcases">The test cases.</a>
        <li><a href="#Listofreferences">List of references</a><a href="#Listofreferences">List of references</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#Boundaryandinitialvalueclasses">Boundary and initial value classes</a><a href="#Boundaryandinitialvalueclasses">Boundary and initial value classes</a>
        <li><a href="#Permeabilitymodels">Permeability models</a><a href="#Permeabilitymodels">Permeability models</a>
        <li><a href="#Physicalquantities">Physical quantities</a><a href="#Physicalquantities">Physical quantities</a>
        <li><a href="#Helperclassesforsolversandpreconditioners">Helper classes for solvers and preconditioners</a><a href="#Helperclassesforsolversandpreconditioners">Helper classes for solvers and preconditioners</a>
        <li><a href="#TheTwoPhaseFlowProblemclass">The TwoPhaseFlowProblem class</a><a href="#TheTwoPhaseFlowProblemclass">The TwoPhaseFlowProblem class</a>
        <li><a href="#TwoPhaseFlowProblemdimTwoPhaseFlowProblem">TwoPhaseFlowProblem<dim>::TwoPhaseFlowProblem</a><a href="#TwoPhaseFlowProblemdimTwoPhaseFlowProblem">TwoPhaseFlowProblem<dim>::TwoPhaseFlowProblem</a>
        <li><a href="#TwoPhaseFlowProblemdimsetup_dofs">TwoPhaseFlowProblem<dim>::setup_dofs</a><a href="#TwoPhaseFlowProblemdimsetup_dofs">TwoPhaseFlowProblem<dim>::setup_dofs</a>
        <li><a href="#Assemblingmatricesandpreconditioners">Assembling matrices and preconditioners</a><a href="#Assemblingmatricesandpreconditioners">Assembling matrices and preconditioners</a>
      <ul>
        <li><a href="#TwoPhaseFlowProblemdimassemble_darcy_preconditioner">TwoPhaseFlowProblem<dim>::assemble_darcy_preconditioner</a><a href="#TwoPhaseFlowProblemdimassemble_darcy_preconditioner">TwoPhaseFlowProblem<dim>::assemble_darcy_preconditioner</a>
        <li><a href="#TwoPhaseFlowProblemdimbuild_darcy_preconditioner">TwoPhaseFlowProblem<dim>::build_darcy_preconditioner</a><a href="#TwoPhaseFlowProblemdimbuild_darcy_preconditioner">TwoPhaseFlowProblem<dim>::build_darcy_preconditioner</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_darcy_system">TwoPhaseFlowProblem<dim>::assemble_darcy_system</a><a href="#TwoPhaseFlowProblemdimassemble_darcy_system">TwoPhaseFlowProblem<dim>::assemble_darcy_system</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_system">TwoPhaseFlowProblem<dim>::assemble_saturation_system</a><a href="#TwoPhaseFlowProblemdimassemble_saturation_system">TwoPhaseFlowProblem<dim>::assemble_saturation_system</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_matrix">TwoPhaseFlowProblem<dim>::assemble_saturation_matrix</a><a href="#TwoPhaseFlowProblemdimassemble_saturation_matrix">TwoPhaseFlowProblem<dim>::assemble_saturation_matrix</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs</a><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs_cell_term">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs_cell_term</a><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs_cell_term">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs_cell_term</a>
        <li><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs_boundary_term">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs_boundary_term</a><a href="#TwoPhaseFlowProblemdimassemble_saturation_rhs_boundary_term">TwoPhaseFlowProblem<dim>::assemble_saturation_rhs_boundary_term</a>
      </ul>
        <li><a href="#TwoPhaseFlowProblemdimsolve">TwoPhaseFlowProblem<dim>::solve</a><a href="#TwoPhaseFlowProblemdimsolve">TwoPhaseFlowProblem<dim>::solve</a>
        <li><a href="#TwoPhaseFlowProblemdimrefine_mesh">TwoPhaseFlowProblem<dim>::refine_mesh</a><a href="#TwoPhaseFlowProblemdimrefine_mesh">TwoPhaseFlowProblem<dim>::refine_mesh</a>
        <li><a href="#TwoPhaseFlowProblemdimoutput_results">TwoPhaseFlowProblem<dim>::output_results</a><a href="#TwoPhaseFlowProblemdimoutput_results">TwoPhaseFlowProblem<dim>::output_results</a>
        <li><a href="#Toolfunctions">Tool functions</a><a href="#Toolfunctions">Tool functions</a>
      <ul>
        <li><a href="#TwoPhaseFlowProblemdimdetermine_whether_to_solve_for_pressure_and_velocity">TwoPhaseFlowProblem<dim>::determine_whether_to_solve_for_pressure_and_velocity</a><a href="#TwoPhaseFlowProblemdimdetermine_whether_to_solve_for_pressure_and_velocity">TwoPhaseFlowProblem<dim>::determine_whether_to_solve_for_pressure_and_velocity</a>
        <li><a href="#TwoPhaseFlowProblemdimproject_back_saturation">TwoPhaseFlowProblem<dim>::project_back_saturation</a><a href="#TwoPhaseFlowProblemdimproject_back_saturation">TwoPhaseFlowProblem<dim>::project_back_saturation</a>
        <li><a href="#TwoPhaseFlowProblemdimget_max_u_F_prime">TwoPhaseFlowProblem<dim>::get_max_u_F_prime</a><a href="#TwoPhaseFlowProblemdimget_max_u_F_prime">TwoPhaseFlowProblem<dim>::get_max_u_F_prime</a>
        <li><a href="#TwoPhaseFlowProblemdimget_extrapolated_saturation_range">TwoPhaseFlowProblem<dim>::get_extrapolated_saturation_range</a><a href="#TwoPhaseFlowProblemdimget_extrapolated_saturation_range">TwoPhaseFlowProblem<dim>::get_extrapolated_saturation_range</a>
        <li><a href="#TwoPhaseFlowProblemdimcompute_viscosity">TwoPhaseFlowProblem<dim>::compute_viscosity</a><a href="#TwoPhaseFlowProblemdimcompute_viscosity">TwoPhaseFlowProblem<dim>::compute_viscosity</a>
      </ul>
        <li><a href="#TwoPhaseFlowProblemdimrun">TwoPhaseFlowProblem<dim>::run</a><a href="#TwoPhaseFlowProblemdimrun">TwoPhaseFlowProblem<dim>::run</a>
        <li><a href="#Thecodemaincodefunction">The <code>main()</code> function</a><a href="#Thecodemaincodefunction">The <code>main()</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <br  />
 <br  />
 <em> This program was contributed by Chih-Che Chueh (University of Victoria) and Wolfgang Bangerth. Results from this program are used and discussed in the following publications (in particular in the second one):</em></p>
<p><em></p><ul>
<li>Chih-Che Chueh, Marc Secanell, Wolfgang Bangerth, Ned Djilali. Multi-level adaptive simulation of transient two-phase flow in heterogeneous porous media. Computers &amp; Fluids, 39:1585-1596, 2010</li>
<li>Chih-Che Chueh, Ned Djilali, Wolfgang Bangerth. An h-adaptive operator splitting method for two-phase flow in 3D heterogeneous porous media. SIAM Journal on Scientific Computing, 35:B149-B175, 2013.</li>
</ul>
<p></em></p>
<p><em>The implementation discussed here uses and extends parts of the <a class="el" href="step_21.html">step-21</a> and <a class="el" href="step_31.html">step-31</a> tutorial programs.</em></p>
<p><em>The work of the Chih-Che Chueh was funded through the Canada Research Chairs Program and the MITACS Network of Centres of Excellence. Parts of the work by Wolfgang Bangerth were funded through Award No. KUS-C1-016-04, made by the King Abdullah University of Science and Technology, and through an Alfred P. Sloan Research Fellowship. This material is also in parts based upon work supported by the National Science Foundation under Award No. EAR-0426271 and The California Institute of Technology; and in a continuation by the National Science Foundation under Award No. EAR-0949446 and The University of California &ndash; Davis. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation, The California Institute of Technology, or of The University of California &ndash; Davis. </em></p>
<p><a class="anchor" id="Introduction"></a><a class="anchor" id="Intro"></a> </p><h1>Introduction</h1>
<p>The simulation of multiphase flow in porous media is a ubiquitous problem, andwe have previously addressed it already in some form in <a class="el" href="step_20.html">step-20</a> and <a class="el" href="step_21.html">step-21</a> . However, as was easy to see there, it faces two major difficulties:numerical accuracy and efficiency. The first is easy to see in the stationarysolver <a class="el" href="step_20.html">step-20</a> : using lowest order Raviart-Thomas elements can not be expectedto yield highly accurate solutions. We need more accurate methods. The secondreason is apparent from the time dependent <a class="el" href="step_21.html">step-21</a> : that program isexcruciatingly slow, and there is no hope to get highly accurate solutions in3d within reasonable time frames. In thisprogram, in order to overcome these two problems, there are five areas whichwe are trying to improve for a high performance simulator: </p><ul>
<li>
Higher order spatial discretizations </li>
<li>
Adaptive mesh refinement </li>
<li>
Adaptive time stepping </li>
<li>
Operator splitting </li>
<li>
Efficient solver and preconditioning </li>
</ul>
<p><br  />
 Much inspiration for this program comes from <a class="el" href="step_31.html">step-31</a> but several of thetechniques discussed here are original.</p>
<p><a class="anchor" id="Advectiondominatedtwophaseflowmathematicalmodel"></a></p><h3>Advection-dominated two-phase flow mathematical model.</h3>
<p>We consider the flow of a two-phase immiscible, incompressiblefluid. Capillary and gravity effects are neglected, and viscouseffects are assumed dominant. The governing equations for such aflow that are identical to those used in <a class="el" href="step_21.html">step-21</a> and are </p><p class="formulaDsp">
\begin{align*} \mathbf{u}_t &amp;= - \mathbf{K} \lambda_t \left(S\right) \nabla p, \\ \nabla \cdot \mathbf{u}_t &amp;= q, \\ \epsilon \frac{\partial S}{\partial t} + \nabla \cdot \left( \mathbf{u}_t F\left( S \right) \right)&amp;=0, \end{align*}
</p>
<p> where \(S\) is the saturation (volume fraction between zero and one) of the second (wetting) phase, \(p\) is the pressure, \(\mathbf{K}\) is the permeability tensor, \(\lambda_t\) is the total mobility, \(\epsilon\) is the porosity, \(F\) is the fractional flow of the wetting phase, \(q\) is the source term and \(\mathbf{u}_t\) is the total velocity. The total mobility, fractional flow of the wetting phase and total velocity are respectively given by </p><p class="formulaDsp">
\begin{align*} \lambda_t(S)&amp;= \lambda_w + \lambda_{nw} = \frac{k_{rw}(S)}{\mu_w} + \frac{k_{rnw}(S)}{\mu_{nw}}, \\ F(S) &amp;= \frac{\lambda_w}{\lambda_t} = \frac{\lambda_w}{\lambda_w + \lambda_{nw}} = \frac{k_{rw}(S)/\mu_w}{k_{rw}(S)/\mu_w + k_{rnw}(S)/\mu_{nw}}, \\ \mathbf{u}_t &amp;= \mathbf{u}_w + \mathbf{u}_{nw} = -\lambda_t(S)\mathbf{K} \cdot \nabla p, \end{align*}
</p>
<p> where subscripts \(w, nw\) represent the wetting and non-wetting phases,respectively. For convenience, theporosity \(\epsilon\) in the saturation equation, which can be considered ascaling factor for the time variable, is set toone. Following a commonly used prescription for the dependence of the relativepermeabilities \(k_{rw}\) and \(k_{rnw}\) on saturation, we use </p><p class="formulaDsp">
\begin{align*} k_{rw} &amp;= S^2, \qquad&amp;\qquad k_{rnw} &amp;= \left( 1-S \right)^2. \end{align*}
</p>
<p>The porous media equations above areaugmented by initial conditions for the saturation and boundary conditions forthe pressure. Since saturation and the gradient of the pressure uniquelydetermine the velocity, no boundary conditions are necessary for the velocity.Since the flow equations do not contain time derivatives, initial conditions for the velocity and pressurevariables are not required. The flow field separates the boundary into inflow or outflowparts. Specifically, </p><p class="formulaDsp">
\[ \mathbf{\Gamma}_{in}(t) = \left\{\mathbf{x} \in \partial \Omega:\mathbf{n} \cdot \mathbf{u}_t&lt;0\right\}, \]
</p>
<p>@_fakenland we arrive at a complete model by also imposing boundary values for thesaturation variable on the inflow boundary \(\mathbf{\Gamma}_{in}\) .</p>
<p><a class="anchor" id="Adaptiveoperatorsplittingandtimestepping"></a></p><h3>Adaptive operator splitting and time stepping.</h3>
<p>As seen in <a class="el" href="step_21.html">step-21</a> , solving the flow equations for velocity and pressure arethe parts of the program that take far longer than the (explicit) updatingstep for the saturation variable once we know the flow variables. On the otherhand, the pressure and velocity depend only weakly on saturation, so one maythink about only solving for pressure and velocity every few time steps whileupdating the saturation in every step. If we can find a criterion for when theflow variables need to be updated, we call this splitting an "adaptiveoperator splitting" scheme. Here, we use the following a posteriori criterion to decide when to re-computepressure and velocity variables(detailed derivations and descriptions can be found in [Chueh, Djilaliand Bangerth 2011]): </p><p class="formulaDsp">
\begin{align*} \theta(n,n_p) = \max_{\kappa\in{\mathbb T}} \left( \left\| \frac 1{\lambda_t\left(S^{(n-1)}\right)} - \frac 1{\lambda_t\left(S^{(n_p)}\right)} \right\|_{L^\infty(\kappa)} \left\|\|\mathbf{K}^{-1}\|_1\right\|_{L^\infty(\kappa)} \right). \end{align*}
</p>
<p> where superscripts in parentheses denote the number of the saturation timestep at which any quantity is defined and \(n_p&lt;n\) represents the last stepwhere we actually computed the pressure and velocity. If \(\theta(n,n_p)\) exceeds a certain threshold we re-compute the flow variables; otherwise, weskip this computation in time step \(n\) and only move the saturation variableone time step forward. In short, the algorithm allows us to perform a number ofsaturation time steps of length \(\Delta t_c^{(n)}=t^{(n)}_c-t^{(n-1)}_c\) untilthe criterion above tells us to re-compute velocity and pressurevariables, leading to a macro time step of length </p><p class="formulaDsp">
\[ \Delta t_p^{(n)} = \sum_{i=n_p+1}^{n} \Delta t_c^{(i)}. \]
</p>
<p>@_fakenlWe choose the length of (micro) steps subject to the Courant-Friedrichs-Lewy(CFL) restriction according to the criterion </p><p class="formulaDsp">
\[ \Delta t_c = \frac{\textrm{min}_{K}h_{K}}{7 \|\mathbf{u}_t\|_{L^{\infty}\left(\Omega\right)}}, \]
</p>
<p>@_fakenlwhich we have confirmed to be stable for the choice of finite element and timestepping scheme for the saturation equation discussed below ( \(h_K\) denotes thediameter of cell \(K\) ).The result is a scheme where neither micro nor macro timesteps are of uniform length, and both are chosen adaptively. <a class="anchor" id="Timediscretization"></a></p><h3>Time discretization.</h3>
<p>Using this time discretization, we obtain the following set of equations foreach time step from the IMPES approach (see <a class="el" href="step_21.html">step-21</a> ): </p><p class="formulaDsp">
\begin{align*} \mathbf{u}^{(n)}_t + \lambda_t\left(S^{(n-1)}\right) \mathbf{K} \nabla p^{(n)} =0, \\ \nabla \cdot \mathbf{u}^{(n)}_t = q, \\ \epsilon \left( \frac{S^{(n-1)}-S^{(n)}}{\Delta t^{(n)}_c} \right) + \mathbf{u}^{(n)}_t \cdot \nabla F\left(S^{(n-1)}\right) + F\left(S^{(n-1)}\right) \nabla \cdot \mathbf{u}^{(n)}_t =0. \end{align*}
</p>
<p>Using the fact that \(\nabla \cdot \mathbf{u}_t = q\) , the time discretesaturation equation becomes </p><p class="formulaDsp">
\begin{align*} &amp;\epsilon \left( \frac{S^{(n)}-S^{(n-1)}}{\Delta t^{(n)}_c} \right) + \mathbf{u}^{(n)}_t \cdot \nabla F\left(S^{(n-1)}\right) + F\left(S^{(n-1)}\right)q=0. \end{align*}
</p>
<p><a class="anchor" id="Weakformspacediscretizationforthepressurevelocitypart"></a></p><h3>Weak form, space discretization for the pressure-velocity part.</h3>
<p>By multiplying the equations defining the total velocity \(\mathbf u_t^{(n)}\) andthe equation that expresses its divergence in terms of source terms, with testfunctions \(\mathbf{v}\) and \(w\) respectively and then integrating terms by parts as necessary, the weak formof the problem reads: Find \(\mathbf u, p\) so that for all test functions \(\mathbf{v}, w\) there holds </p><p class="formulaDsp">
\begin{gather*} \left( \left( \mathbf{K} \lambda_t\left(S^{(n-1)}\right) \right)^{-1} \mathbf{u}^{(n)}_t, \mathbf{v}\right)_{\Omega} - \left(p^{(n)}, \nabla \cdot \mathbf{v}\right)_{\Omega} = -\left(p^{(n)}, \mathbf{n} \cdot \mathbf{v} \right)_{\partial \Omega}, \\ - \left( \nabla \cdot \mathbf{u}^{(n)}_t,w\right)_{\Omega} = - \big(q,w\big)_{\Omega}. \end{gather*}
</p>
<p> Here, \(\mathbf{n}\) represents the unit outward normal vector to \(\partial \Omega\) and the pressure \(p^{(n)}\) can be prescribed weakly on the open partof the boundary \(\partial \Omega\) whereas on those parts where a velocity isprescribed (for example impermeable boundaries with \(\mathbf n \cdot \mathbf u=0\) the term disappears altogether because \(\mathbf n \cdot \mathbf v=0\) . We use continuous finite elements to discretize the velocity and pressureequations. Specifically, we use mixed finite elements to ensure high order approximationfor both vector (e.g. a fluid velocity) and scalar variables (e.g. pressure)simultaneously. For saddle point problems, it is well established thatthe so-called Babuska-Brezzi or Ladyzhenskaya-Babuska-Brezzi (LBB) conditions[Brezzi 1991, Chen 2005] need to be satisfied to ensure stability ofthe pressure-velocity system. These stability conditions are satisfied in thepresent work by using elements for velocity that are one order higher than forthe pressure, i.e. \(u_h \in Q^d_{p+1}\) and \(p_h \in Q_p\) , where \(p=1\) , \(d\) isthe space dimension, and \(Q_s\) denotes the space of tensor product Lagrangepolynomials of degree \(s\) in each variable. <a class="anchor" id="Stabilizationweakformandspacediscretizationforthesaturationtransportequation"></a></p><h3>Stabilization, weak form and space discretization for the saturation transport equation.</h3>
<p>The chosen \(Q_1\) elements for the saturation equation do not lead to a stablediscretization without upwinding or other kinds of stabilization, and spuriousoscillations will appear in the numerical solution. Adding an artificialdiffusion term is one approach to eliminating these oscillations[Chen 2005]. On the other hand, adding too much diffusion smears sharpfronts in the solution and suffers from grid-orientation difficulties[Chen 2005]. To avoid these effects, we use the artificial diffusionterm proposed by [Guermond and Pasquetti 2008] andvalidated in [Chueh, Djilali, Bangerth 2011] and[Kronbichler, Heister and Bangerth, 2011], as well as in <a class="el" href="step_31.html">step-31</a> . This method modifies the (discrete) weak form of the saturation equationto read </p><p class="formulaDsp">
\begin{align*} \left(\epsilon \frac{\partial S_h}{\partial t},\sigma_h\right) - \left(\mathbf{u}_t F\left( S_h \right), \nabla \sigma_h\right) + \left(\mathbf n \cdot \mathbf{u}_t \hat F\left( S_h \right), \sigma_h\right)_{\partial\Omega} + (\nu(S_h) \nabla S_h, \nabla \sigma_h) &amp;=0 \qquad \forall \sigma_h, \end{align*}
</p>
<p> where \(\nu\) is the artificial diffusion parameter and \(\hat F\) is anappropriately chosen numerical flux on the boundary of the domain (we choosethe obvious full upwind flux for this). Following [Guermond and Pasquetti 2008] (and as detailed in[Chueh, Djilali and Bangerth 2011]), we usethe parameter as a piecewiseconstant function set on each cell \(K\) with the diameter \(h_{K}\) as </p><p class="formulaDsp">
\[ \nu(S_h)|_{K} = \beta \| \mathbf{u}_t \max\{F&#39;(S_h),1\} \|_{L^{\infty}(K)} \textrm{min} \left\{ h_{K},h^{\alpha}_{K} \frac{\|\textrm{Res}(S_h)\|_{L^{\infty}(K)}}{c(\mathbf{u}_t,S)} \right\} \]
</p>
<p>@_fakenlwhere \(\alpha\) is a stabilization exponent and \(\beta\) is a dimensionlessuser-defined stabilization constant. Following [Guermond and Pasquetti 2008]as well as the implementation in <a class="el" href="step_31.html">step-31</a> , the velocity and saturation globalnormalization constant, \(c(\mathbf{u}_t,S)\) , and the residual \(\textrm{Res}(S)\) are respectively given by </p><p class="formulaDsp">
\[ c(\mathbf{u}_t,S) = c_R \|\mathbf{u}_t \max\{F&#39;(S),1\}\|_{L^{\infty}(\Omega)} \textrm{var}(S)^\alpha | \textrm{diam} (\Omega) |^{\alpha - 2} \]
</p>
<p>@_fakenland </p><p class="formulaDsp">
\[ \textrm{Res}(S) = \left( \epsilon \frac{\partial S}{\partial t} + \mathbf{u}_t \cdot \nabla F(S) + F(S)q \right) \cdot S^{\alpha - 1} \]
</p>
<p>@_fakenlwhere \(c_R\) is a second dimensionless user-defined constant, \(\textrm{diam}(\Omega)\) is the diameter of the domain and \(\textrm{var}(S) = \textrm{max}_{\Omega} S - \textrm{min}_{\Omega} S\) is the range of the presentsaturation values in the entire computational domain \(\Omega\) . This stabilization scheme has a number of advantages over simpler schemes suchas finite volume (or discontinuous Galerkin) methods or streamline upwindPetrov Galerkin (SUPG) discretizations. In particular, the artificialdiffusion term acts primarily in the vicinity of discontinuitiessince the residual is small in areas where the saturation is smooth. Ittherefore provides for a higher degree of accuracy. On the other hand, it isnonlinear since \(\nu\) depends on the saturation \(S\) . We avoid this difficultyby treating all nonlinear terms explicitly, which leads to the followingfully discrete problem at time step \(n\) : </p><p class="formulaDsp">
\begin{align*} &amp;\left( \epsilon S_h^{(n)},\sigma_h\right)_{\Omega} - \Delta t^{(n)}_c \Big(F\left(S_h^{(n-1)}\right)\mathbf{u}^{*}_t,\nabla\sigma_h\Big)_{\Omega} + \Delta t^{(n)}_c \Big(F\left(S_h^{(n-1)}\right)\left(\mathbf{n}\cdot\mathbf{u}^{*}_t\right),\sigma_h\Big)_{\partial\Omega} \nonumber \\ &amp; \quad = \left( \epsilon S_h^{(n-1)},\sigma_h\right)_{\Omega} - \Delta t^{(n)}_c \bigg(\nu\left(S_h^{(n-1)}\right)\nabla S_h^{(n-1)},\nabla\sigma_h\bigg)_{\Omega} \nonumber \\ &amp; \qquad + \Delta t^{(n)}_c \bigg(\mathbf{n}\cdot\nu\left(S_h^{(n-1)}\right)\nabla S^{(n-1)},\sigma_h\bigg)_{\partial\Omega} \end{align*}
</p>
<p> where \(\mathbf{u}_t^{*}\) is the velocity linearly extrapolated from \(\mathbf{u}^{(n_p)}_t\) and \(\mathbf{u}^{(n_{pp})}_t\) to the current time \(t^{(n)}\) if \(\theta&lt;\theta^*\) while \(\mathbf{u}_t^{*}\) is \(\mathbf{u}^{(n_p)}_t\) if \(\theta&gt;\theta^*\) .Consequently, the equation is linear in \(S_h^{(n)}\) and all that is requiredis to solve with a mass matrix on the saturation space. Since the Dirichlet boundary conditions for saturation are only imposed on theinflow boundaries, the third term on the left hand side of the equation aboveneeds to be split further into two parts: </p><p class="formulaDsp">
\begin{align*} &amp;\Delta t^{(n)}_c \Big(F\left(S_h^{(n-1)}\right)\left(\mathbf{n}\cdot\mathbf{u}^{(n)}_t\right),\sigma_h\Big)_{\partial\Omega} \nonumber \\ &amp;\qquad= \Delta t^{(n)}_c \Big(F\left(S^{(n-1)}_{(+)}\right)\left(\mathbf{n}\cdot\mathbf{u}^{(n)}_{t(+)}\right),\sigma_h\Big)_{\partial\Omega_{(+)}} + \Delta t^{(n)}_c \Big(F\left(S^{(n-1)}_{(-)}\right)\left(\mathbf{n}\cdot\mathbf{u}^{(n)}_{t(-)}\right),\sigma_h\Big)_{\partial\Omega_{(-)}} \end{align*}
</p>
<p> where \(\partial\Omega_{(-)} = \left\{\mathbf{x} \in \partial\Omega : \mathbf{n} \cdot \mathbf{u}_t&lt;0\right\}\) and \(\partial\Omega_{(+)} = \left\{\mathbf{x} \in \partial\Omega : \mathbf{n} \cdot \mathbf{u}_t&gt;0\right\}\) represent inflow and outflow boundaries,respectively. We choose values using anupwind formulation, i.e. \(S^{(n-1)}_{(+)}\) and \(\mathbf{u}^{(n)}_{t(+)}\) correspond to the values taken from the present cell, while the values of \(S^{(n-1)}_{(-)}\) and \(\mathbf{u}^{(n)}_{t(-)}\) are those taken from theneighboring boundary \(\partial\Omega_{(-)}\) .</p>
<p><a class="anchor" id="Adaptivemeshrefinement"></a></p><h3>Adaptive mesh refinement.</h3>
<p>Choosing meshes adaptively to resolve sharpsaturation fronts is an essential ingredient to achieve efficiency in ouralgorithm. Here, we use the same shock-type refinement approach used in[Chueh, Djilali and Bangerth 2011] to select those cells that should be refined orcoarsened. The refinement indicator for each cell \(K\) of the triangulation iscomputed by </p><p class="formulaDsp">
\[ \eta_{K} = |\nabla S_h(\mathbf x_K)| \]
</p>
<p>@_fakenlwhere \(\nabla S_h(\mathbf x_K)\) is the gradient of the discrete saturationvariable evaluated at the center \(\mathbf x_K\) of cell \(K\) . This approach isanalogous to ones frequently used in compressible flow problems, where densitygradients are used to indicate refinement. That said, as we willdiscuss at the end of the <a href="#Results">results section</a>, this turnsout to not be a very useful criterion since it leads to refinement basicallyeverywhere. We only show it here for illustrative purposes.</p>
<p><a class="anchor" id="Linearsystemanditspreconditioning"></a></p><h3>Linear system and its preconditioning.</h3>
<p>Following the discretization of the governing equationsdiscussed above, weobtain a linear system of equations in time step \((n)\) of the following form: </p><p class="formulaDsp">
\[ \left( \begin{array}{ccc} \mathbf{M}^{\mathbf{u}} &amp; \mathbf{B}^{T} &amp; \mathbf{0} \\ \mathbf{B} &amp; \mathbf{0} &amp; \mathbf{0} \\ \mathbf{H} &amp; \mathbf{0} &amp; \mathbf{M}^{S} \end{array} \right) \left( \begin{array}{c} \mathbf{U}^{(n)} \\ \mathbf{P}^{(n)} \\ \mathbf{S}^{(n)} \end{array} \right) = \left( \begin{array}{c} 0 \\ \mathbf{F}_{2} \\ \mathbf{F}_{3} \end{array} \right) \]
</p>
<p>@_fakenlwhere the individual matrices and vectors are defined as follows using shape functions \(\mathbf{v}_i\) for velocity, and \(\phi_i\) for both pressure and saturation: </p><p class="formulaDsp">
\begin{align*} \mathbf{M}^{\mathbf{u}}_{ij} &amp;= \left( \left( \mathbf{K} \lambda_t\left(S^{(n-1)}\right) \right)^{-1} \mathbf{v}_{i},\mathbf{v}_{j}\right)_{\Omega}, &amp; \mathbf{M}^{S}_{ij} &amp;= \left(\epsilon \phi_i,\phi_j\right)_{\Omega} \\ \mathbf{B}_{ij} &amp;= - \left( \nabla \cdot \mathbf{v}_{j},\phi_{i}\right)_{\Omega}, &amp; \mathbf{H}_{ij} &amp;= - \Delta t^{(n)}_c \Big( F\left(S^{(n-1)}\right) \mathbf{v}_i,\nabla\phi_j\Big)_{\Omega} \\ \left(\mathbf{F}_{2}\right)_i &amp;= - \big(F\left(S^{(n-1)}\right)q,\phi_i\big)_{\Omega}, \end{align*}
</p>
<p> and \(\mathbf{F}_{3}\) as given in the definition of the stabilized transportequation. The linear system above is of block triangular form if we consider the topleft \(2\times 2\) panel of matrices as one block. We can therefore first solvefor the velocity and pressure (unless we decide to use \(\mathbf U^{(n_p)}\) inplace of the velocity)followed by a solve for the saturation variable. The first of these stepsrequires us to solve </p><p class="formulaDsp">
\[ \left( \begin{array}{cc} \mathbf{M}^{\mathbf{u}} &amp; \mathbf{B}^{T} \\ \mathbf{B} &amp; \mathbf{0} \end{array} \right) \left( \begin{array}{c} \mathbf{U}^{(n)} \\ \mathbf{P}^{(n)} \end{array} \right) = \left( \begin{array}{c} 0 \\ \mathbf{F}_{2} \end{array} \right) \]
</p>
<p>@_fakenlWe apply the Generalized Minimal Residual (GMRES) method [Saad and Schultz1986] to this linear system. The ideal preconditioner for thevelocity-pressure system is </p><p class="formulaDsp">
\begin{align*} \mathbf{P} = \left( \begin{array}{cc} \mathbf{M}^{\mathbf{u}} &amp; \mathbf{0} \\ \mathbf{B} &amp; -\mathbf{S} \end{array} \right), &amp; \qquad \mathbf{P}^{-1} = \left( \begin{array}{cc} \left(\mathbf{M}^{\mathbf{u}}\right)^{-1} &amp; \mathbf{0} \\ \mathbf{S}^{-1} \mathbf{B} \left(\mathbf{M}^{\mathbf{u}}\right)^{-1} &amp; -\mathbf{S}^{-1} \end{array} \right) \end{align*}
</p>
<p> where \(\mathbf{S}=\mathbf{B}\left(\mathbf{M}^{\mathbf{u}}\right)^{-1}\mathbf{B}^T\) isthe Schur complement [Zhang 2005] of the system. This preconditioner isoptimal since </p><p class="formulaDsp">
\begin{align*} \mathbf{P}^{-1} \left( \begin{array}{cc} \mathbf{M}^{\mathbf{u}} &amp; \mathbf{B}^{T} \\ \mathbf{B} &amp; \mathbf{0} \end{array} \right) = \left( \begin{array}{cc} \mathbf{I} &amp; \left(\mathbf{M}^{\mathbf{u}}\right)^{-1} \mathbf{B}^{T} \\ \mathbf{0} &amp; \mathbf{I} \end{array} \right), \end{align*}
</p>
<p> for which it can be shown that GMRES converges in two iterations. However, we cannot of course expect to use exact inverses of thevelocity mass matrix and the Schur complement. We therefore follow theapproach by [Silvester and Wathen 1994] originally proposed forthe Stokes system. Adapting it to the current set of equations yield thepreconditioner </p><p class="formulaDsp">
\begin{align*} \mathbf{\tilde{P}}^{-1} = \left( \begin{array}{cc} \widetilde{\left(\mathbf{{M}}^{\mathbf{u}}\right)^{-1}} &amp; \mathbf{0} \\ \widetilde{\mathbf{{S}}^{-1}} \mathbf{B} \widetilde{\left(\mathbf{{M}}^{\mathbf{u}}\right)^{-1}} &amp; -\widetilde{\mathbf{{S}}^{-1}} \end{array} \right) \end{align*}
</p>
<p> where a tilde indicates an approximation of the exact inverse matrix. Inparticular, since \(\left(\mathbf{{M}}^{\mathbf{u}}\right)^{-1}=\left( \left( \mathbf{K} \lambda_t \right)^{-1} \mathbf{v}_{i},\mathbf{v}_{j}\right)_{\Omega}\) is a sparse symmetric and positive definite matrix, we choose for \(\widetilde{\left(\mathbf{{M}}^{\mathbf{u}}\right)^{-1}}\) a single application ofa sparse incomplete Cholesky decomposition of this matrix[Golub and Van Loan 1996].We note that the Schur complement that corresponds to the porousmedia flow operator in non-mixed form, \(-\nabla \cdot [\mathbf K \lambda_t(S)]\nabla\) and \(\mathbf{\tilde {S}} = \left( \left( \mathbf{K} \lambda_t \right) \nabla \phi_{i},\nabla \phi_{j}\right)_{\Omega}\) should be a good approximation of the actual Schur complement matrix \(\mathbf S\) . Since both of these matrices are again symmetric and positive definite, weuse an incomplete Cholesky decomposition of \(\mathbf{\tilde S}\) for \(\widetilde {\mathbf{{S}}^{-1}}\) . It is important to note that \(\mathbf{\tilde S}\) needsto be built with Dirichlet boundary conditions to ensure its invertibility. Once the velocity \(\mathbf{U}^{(n)} \equiv \mathbf{u}^*_t\) is available, wecan assemble \(\mathbf{H}\) and \(\mathbf{F}_{3}\) and solve for the saturations using </p><p class="formulaDsp">
\begin{align*} \mathbf{M}^{S} \mathbf{S}^{(n)} = \mathbf{F}_{3} - \mathbf{H} \mathbf{U}^{(n)}. \end{align*}
</p>
<p> where the mass matrix \(\mathbf{M}^{S}\) is solved by the conjugate gradientmethod, using an incomplete Cholesky decomposition as preconditioner oncemore. <a class="anchor" id="Thetestcases"></a></p><h3>The test cases.</h3>
<pre class="fragment">@note  The implementation discussed here uses and extendsparts of the   @ref step_21 "step-21"  ,   @ref step_31 "step-31"   and   @ref step_33 "step-33"   tutorial programs of thislibrary. In particular, if you want to understand how it works, pleaseconsult   @ref step_21 "step-21"   for a discussion of the mathematical problem, and  @ref step_31 "step-31"   from which most of the implementation is derived. We will notdiscuss aspects of the implementation that have already been discussedin   @ref step_31 "step-31"  .
</pre><p> We show numerical results for some two-phase flow equations augmented byappropriate initial and boundary conditions in conjunction with two differentchoices of the permeability model. In the problems considered, there is nointernal source term ( \(q=0\) ). As mentioned above, quantitative numericalresults are presented in [Chueh, Djilali and Bangerth 2011]. For simplicity, we choose \(\Omega=[0,1]^d,d=2,3\) , though all methods (as wellas our implementation) should work equally well on general unstructured meshes. Initial conditions are only required for the saturation variable, and wechoose \(S(\mathbf{x},0)=0.2\) , i.e. the porous medium is initially filled by amixture of the non-wetting (80%) and wetting (20%) phases. This differs fromthe initial condition in <a class="el" href="step_21.html">step-21</a> where we had taken \(S(\mathbf{x},0)=0\) , butfor complicated mathematical reasons that are mentioned there in a longishremark, the current method using an entropy-based artificial diffusion termdoes not converge to the viscosity solution with this initial conditionwithout additional modifications to the method. We therefore choose thismodified version for the current program. Furthermore, we prescribe a linear pressure onthe boundaries: </p><p class="formulaDsp">
\[ p(\mathbf{x},t) = 1 - x \qquad \textrm{on} \quad \partial \Omega \times [0,T]. \]
</p>
<p>@_fakenlPressure and saturation uniquelydetermine a velocity, and the velocity determines whether a boundary segmentis an inflow or outflow boundary. On the inflow part of the boundary, \(\mathbf{\Gamma}_{in}(t)\) , we impose </p><p class="formulaDsp">
\begin{align*} S(\mathbf{x},t) = 1 \qquad &amp; \textrm{on} \quad \mathbf{\Gamma}_{in}(t) \cap \left\{x = 0\right\}, \\ S(\mathbf{x},t) = 0 \qquad &amp; \textrm{on} \quad \mathbf{\Gamma}_{in}(t) \backslash \left\{x = 0\right\}. \end{align*}
</p>
<p> In other words, the domain is flooded by the wetting phase from the left.No boundary conditions for the saturation are required for the outflow partsof the boundary. All the numerical and physical parameters used for the 2D/3Dcases are listed in the following table: </p><table align="center" class="tutorial" width="50%">
<tr>
<th>Parameter </th><th>Symbol </th><th>Value </th><th>units </th></tr>
<tr>
<td>Porosity </td><td>\(\epsilon\) </td><td>1.0 </td><td>- </td></tr>
<tr>
<td>Viscosity (wetting) </td><td>\(\mu_w\) </td><td>0.2 </td><td>\(kg \cdot m^{-1} \cdot sec^{-1}\) </td></tr>
<tr>
<td>Viscosity (nonwetting) </td><td>\(\mu_{nw}\) </td><td>1.0 </td><td>\(kg \cdot m^{-1} \cdot sec^{-1}\) </td></tr>
<tr>
<td>Stabilization exponent </td><td>\(\alpha\) </td><td>1.0 </td><td>- </td></tr>
<tr>
<td>Stabilization constant </td><td>\(\beta\) </td><td>2D: 0.3; 3D: 0.27 </td><td>- </td></tr>
<tr>
<td>Normalization constant </td><td>\(c_R\) </td><td>1.0 </td><td>- </td></tr>
<tr>
<td>Number of high-permeability regions </td><td>\(N\) </td><td>50; 200 </td><td>- </td></tr>
<tr>
<td>Operator splitting threshold </td><td>\(\theta^\ast\) </td><td>5.0 </td><td>-  </td></tr>
</table>
<p><br  />
</p>
<p><a class="anchor" id="Listofreferences"></a></p><h3>List of references</h3>
<pre class="fragment">&lt;ol&gt;    &lt;li&gt;  CC Chueh, N Djilali and W Bangerth.  &lt;br&gt;   An h-adaptive operator splitting method for two-phase flow in 3D  heterogeneous porous media.  &lt;br&gt;   SIAM Journal on Scientific Computing, vol. 35 (2013), pp. B149-B175
&lt;li&gt;  M. Kronbichler, T. Heister, and W. Bangerth  &lt;br&gt;   High Accuracy Mantle Convection Simulation through Modern NumericalMethods.  &lt;br&gt;   Geophysics Journal International, vol. 191 (2012), pp. 12-29
&lt;li&gt;  F Brezzi and M Fortin.  &lt;br&gt;   &lt;i&gt;Mixed and Hybrid Finite Element Methods&lt;/i&gt;.  &lt;br&gt;   Springer-Verlag, 1991.
&lt;li&gt;  Z Chen.  &lt;br&gt;   &lt;i&gt;Finite Element Methods and Their Applications&lt;/i&gt;.  &lt;br&gt;   Springer, 2005.
&lt;li&gt;  JL Guermond and R Pasquetti.  &lt;br&gt;   Entropy-based nonlinear viscosity for Fourier approximations of  conservation laws.  &lt;br&gt;   &lt;i&gt;Comptes Rendus Mathematique&lt;/i&gt;, 346(13-14):801-806, 2008.
&lt;li&gt;  CC Chueh, M Secanell, W Bangerth, and N Djilali.  &lt;br&gt;   Multi-level adaptive simulation of transient two-phase flow in  heterogeneous porous media.  &lt;br&gt;   &lt;i&gt;Computers and Fluids&lt;/i&gt;, 39:1585-1596, 2010.
&lt;li&gt;  Y Saad and MH Schultz.  &lt;br&gt;   Gmres: A generalized minimal residual algorithm for solving  nonsymmetric linear systems.  &lt;br&gt;   &lt;i&gt;SIAM Journal on Scientific and Statistical Computing&lt;/i&gt;,  7(3):856-869, 1986.
&lt;li&gt;  F Zhang.  &lt;br&gt;   &lt;i&gt;The Schur Complement and its Applications&lt;/i&gt;.  &lt;br&gt;   Springer, 2005.
&lt;li&gt;  D Silvester and A Wathen.  &lt;br&gt;   Fast iterative solution of stabilised Stokes systems part ii: Using  general block preconditioners.  &lt;br&gt;   &lt;i&gt;SIAM Journal on Numerical Analysis&lt;/i&gt;, 31(5):1352-1367, 1994.
&lt;li&gt;  GH Golub and CF van Loan.  &lt;br&gt;   &lt;i&gt;Matrix Computations&lt;/i&gt;.  &lt;br&gt;   3rd Edition, Johns Hopkins, 1996.
&lt;li&gt;  SE Buckley and MC Leverett.  &lt;br&gt;   Mechanism of fluid displacements in sands.  &lt;br&gt;   &lt;i&gt;AIME Trans.&lt;/i&gt;, 146:107-116, 1942.
&lt;/ol&gt;  
</pre><p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>The first step, as always, is to include the functionality of a number of deal.II and C++ header files.</p>
<p>The list includes some header files that provide vector, matrix, and preconditioner classes that implement interfaces to the respective Trilinos classes; some more information on these may be found in <a class="el" href="step_31.html">step-31</a> .</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2tensor__function_8h.html">deal.II/base/tensor_function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
</div><!-- fragment --><p>At the end of this top-matter, we open a namespace for the current project into which all the following material will go, and then import all deal.II names into this namespace:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep43.html">Step43</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
</div><!-- fragment --><p><a class="anchor" id="Boundaryandinitialvalueclasses"></a> </p><h3>Boundary and initial value classes</h3>
<p>The following part is taken directly from <a class="el" href="step_21.html">step-21</a> so there is no need to repeat the descriptions found there.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keyword">class </span>PressureBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">   {</div>
<div class="line">   <span class="keyword">public</span>:</div>
<div class="line">     PressureBoundaryValues()</div>
<div class="line">       : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">     {}</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">   };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">double</span></div>
<div class="line">   <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">PressureBoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <span class="comment">/*component*/</span> )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keywordflow">return</span> 1</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0];</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keyword">class </span>SaturationBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">   {</div>
<div class="line">   <span class="keyword">public</span>:</div>
<div class="line">     SaturationBoundaryValues()</div>
<div class="line">       : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">     {}</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">   };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">double</span></div>
<div class="line">   <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">SaturationBoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <span class="comment">/*component*/</span> )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] == 0)</div>
<div class="line">       <span class="keywordflow">return</span> 1;</div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       <span class="keywordflow">return</span> 0;</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keyword">class </span>SaturationInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">   {</div>
<div class="line">   <span class="keyword">public</span>:</div>
<div class="line">     SaturationInitialValues()</div>
<div class="line">       : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">     {}</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                               <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>) <span class="keyword">const override</span>;</div>
<div class="line">   };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">double</span></div>
<div class="line">   <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">SaturationInitialValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;  <span class="comment">/*p*/</span> ,</div>
<div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <span class="comment">/*component*/</span> )<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keywordflow">return</span> 0.2;</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">SaturationInitialValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                                   <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">       <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(c) = <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">SaturationInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="Permeabilitymodels"></a> </p><h3>Permeability models</h3>
<p>In this tutorial, we still use the two permeability models previously used in <a class="el" href="step_21.html">step-21</a> so we again refrain from commenting in detail about them.</p>
<div class="fragment"><div class="line">   <span class="keyword">namespace </span>SingleCurvingCrack</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     <span class="keyword">class </span>KInverse : <span class="keyword">public</span> <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, dim&gt;</div>
<div class="line">     {</div>
<div class="line">     <span class="keyword">public</span>:</div>
<div class="line">       KInverse()</div>
<div class="line">         : <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;()</div>
<div class="line">       {}</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">virtual</span> <span class="keywordtype">void</span></div>
<div class="line">       <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                  <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>) <span class="keyword">const override</span>;</div>
<div class="line">     };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">KInverse&lt;dim&gt;::value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                                    <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size() == <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size(),</div>
<div class="line">              <a class="code" href="group__Exceptions.html#ga6060b2304b8600f5efa0d31eeda0207d">ExcDimensionMismatch</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(), <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size()));</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">         {</div>
<div class="line">           <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].clear();</div>
<div class="line">  </div>
<div class="line">           <span class="keyword">const</span> <span class="keywordtype">double</span> distance_to_flowline =</div>
<div class="line">             <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][1]</div>
<div class="line">  </div>
<div class="line">- 0.5</div>
<div class="line">  </div>
<div class="line">- 0.1 <a class="code" href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">std::sin</a>(10 <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][0]));</div>
<div class="line">  </div>
<div class="line">           <span class="keyword">const</span> <span class="keywordtype">double</span> permeability =</div>
<div class="line">             <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(std::exp(-(distance_to_flowline distance_to_flowline) /</div>
<div class="line">                               (0.1 0.1)),</div>
<div class="line">                      0.01);</div>
<div class="line">  </div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">             <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = 1. / permeability;</div>
<div class="line">         }</div>
<div class="line">     }</div>
<div class="line">   } <span class="comment">// namespace SingleCurvingCrack</span></div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keyword">namespace </span>RandomMedium</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     <span class="keyword">class </span>KInverse : <span class="keyword">public</span> <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, dim&gt;</div>
<div class="line">     {</div>
<div class="line">     <span class="keyword">public</span>:</div>
<div class="line">       KInverse()</div>
<div class="line">         : <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;()</div>
<div class="line">       {}</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">virtual</span> <span class="keywordtype">void</span></div>
<div class="line">       <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                  <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>) <span class="keyword">const override</span>;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">private</span>:</div>
<div class="line">       <span class="keyword">static</span> std::vector&lt;Point&lt;dim&gt;&gt; centers;</div>
<div class="line">     };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     std::vector&lt;Point&lt;dim&gt;&gt; KInverse&lt;dim&gt;::centers = []() {</div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a> =</div>
<div class="line">         (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 40 : (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3 ? 100 : <span class="keywordflow">throw</span> <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()));</div>
<div class="line">  </div>
<div class="line">       std::vector&lt;Point&lt;dim&gt;&gt; centers_list(<a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a>);</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">           centers_list[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(<a class="code" href="base_2utilities__0_8txt.html#abdaf96304944a8787ae4488ed5461fac">rand</a>()) / RAND_MAX;</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">return</span> centers_list;</div>
<div class="line">     }();</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">     <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">KInverse&lt;dim&gt;::value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                                    <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(), <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size());</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">         {</div>
<div class="line">           <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].clear();</div>
<div class="line">  </div>
<div class="line">           <span class="keywordtype">double</span> permeability = 0;</div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; centers.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">             permeability +=</div>
<div class="line">               std::exp(-(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>]</div>
<div class="line">  </div>
<div class="line">- centers[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]).norm_square() / (0.05 0.05));</div>
<div class="line">  </div>
<div class="line">           <span class="keyword">const</span> <span class="keywordtype">double</span> normalized_permeability =</div>
<div class="line">             <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(permeability, 0.01), 4.);</div>
<div class="line">  </div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">             <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = 1. / normalized_permeability;</div>
<div class="line">         }</div>
<div class="line">     }</div>
<div class="line">   } <span class="comment">// namespace RandomMedium</span></div>
</div><!-- fragment --><p><a class="anchor" id="Physicalquantities"></a> </p><h3>Physical quantities</h3>
<p>The implementations of all the physical quantities such as total mobility \(\lambda_t\) and fractional flow of water \(F\) are taken from <a class="el" href="step_21.html">step-21</a> so again we don't have do any comment about them. Compared to <a class="el" href="step_21.html">step-21</a> we have added checks that the saturation passed to these functions is in fact within the physically valid range. Furthermore, given that the wetting phase moves at speed \(\mathbf u F&#39;(S)\) it is clear that \(F&#39;(S)\) must be greater or equal to zero, so we assert that as well to make sure that our calculations to get at the formula for the derivative made sense.</p>
<div class="fragment"><div class="line">   <span class="keywordtype">double</span> <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">   {</div>
<div class="line">     <span class="keywordflow">return</span> 1.0 / (1.0 / viscosity S S + (1</div>
<div class="line">  </div>
<div class="line">- S) (1</div>
<div class="line">  </div>
<div class="line">- S));</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keywordtype">double</span> <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((S &gt;= 0) &amp;&amp; (S &lt;= 1),</div>
<div class="line">            <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Saturation is outside its physically valid range.&quot;</span>));</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">return</span> S S / (S S + viscosity (1</div>
<div class="line">  </div>
<div class="line">- S) (1</div>
<div class="line">  </div>
<div class="line">- S));</div>
<div class="line">   }</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">   <span class="keywordtype">double</span> <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((S &gt;= 0) &amp;&amp; (S &lt;= 1),</div>
<div class="line">            <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Saturation is outside its physically valid range.&quot;</span>));</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> temp = (S S + viscosity (1</div>
<div class="line">  </div>
<div class="line">- S) (1</div>
<div class="line">  </div>
<div class="line">- S));</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> numerator =</div>
<div class="line">       2.0 S temp</div>
<div class="line">  </div>
<div class="line">- S S (2.0 S</div>
<div class="line">  </div>
<div class="line">- 2.0 viscosity (1</div>
<div class="line">  </div>
<div class="line">- S));</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> denominator = <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(temp, 2.0);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> F_prime = numerator / denominator;</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(F_prime &gt;= 0, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">return</span> F_prime;</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="Helperclassesforsolversandpreconditioners"></a> </p><h3>Helper classes for solvers and preconditioners</h3>
<p>In this first part we define a number of classes that we need in the construction of linear solvers and preconditioners. This part is essentially the same as that used in <a class="el" href="step_31.html">step-31</a> . The only difference is that the original variable name stokes_matrix is replaced by another name darcy_matrix to match our problem.</p>
<div class="fragment"><div class="line">   <span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">     <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">     {</div>
<div class="line">     <span class="keyword">public</span>:</div>
<div class="line">       InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                     <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">       <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">       <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(VectorType &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">private</span>:</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">       <span class="keyword">const</span> PreconditionerType &amp;           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">     };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">     InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">       <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">       <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">       : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">       , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">     {}</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">     <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">       VectorType &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">       <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-7 src.l2_norm());</div>
<div class="line">       <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div>
<div class="line">  </div>
<div class="line">       <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line">  </div>
<div class="line">       <span class="keywordflow">try</span></div>
<div class="line">         {</div>
<div class="line">           cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">         }</div>
<div class="line">       <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>)</div>
<div class="line">         {</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>.what()));</div>
<div class="line">         }</div>
<div class="line">     }</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">     <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">     {</div>
<div class="line">     <span class="keyword">public</span>:</div>
<div class="line">       BlockSchurPreconditioner(</div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">         <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                             PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">         <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div>
<div class="line">  </div>
<div class="line">       <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                  <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">private</span>:</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">         darcy_matrix;</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                              PreconditionerTypeMp&gt;&gt;</div>
<div class="line">                                  m_inverse;</div>
<div class="line">       <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div>
<div class="line">     };</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">     BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div>
<div class="line">       BlockSchurPreconditioner(</div>
<div class="line">         <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">         <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                             PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">         <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner)</div>
<div class="line">       : darcy_matrix(&amp;S)</div>
<div class="line">       , m_inverse(&amp;Mpinv)</div>
<div class="line">       , a_preconditioner(Apreconditioner)</div>
<div class="line">       , tmp(<a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(darcy_matrix-&gt;<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1, 1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>()))</div>
<div class="line">     {}</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">     <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">     <span class="keywordtype">void</span></div>
<div class="line">     <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult</a>(</div>
<div class="line">       <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">       <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">     </span>{</div>
<div class="line">       a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">       darcy_matrix-&gt;block(1, 0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">       tmp=</div>
<div class="line">  </div>
<div class="line">-1;</div>
<div class="line">       m_inverse-&gt;vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">     }</div>
<div class="line">   } <span class="comment">// namespace LinearSolvers</span></div>
</div><!-- fragment --><p><a class="anchor" id="TheTwoPhaseFlowProblemclass"></a> </p><h3>The TwoPhaseFlowProblem class</h3>
<p>The definition of the class that defines the top-level logic of solving the time-dependent advection-dominated two-phase flow problem (or Buckley-Leverett problem [Buckley 1942]) is mainly based on tutorial programs <a class="el" href="step_21.html">step-21</a> and <a class="el" href="step_33.html">step-33</a> , and in particular on <a class="el" href="step_31.html">step-31</a> where we have used basically the same general structure as done here. As in <a class="el" href="step_31.html">step-31</a> , the key routines to look for in the implementation below are the <code><a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a></code> and <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code> functions. <br  />
 The main difference to <a class="el" href="step_31.html">step-31</a> is that, since adaptive operator splitting is considered, we need a couple more member variables to hold the last two computed Darcy (velocity/pressure) solutions in addition to the current one (which is either computed directly, or extrapolated from the previous two), and we need to remember the last two times we computed the Darcy solution. We also need a helper function that figures out whether we do indeed need to recompute the Darcy solution. <br  />
 Unlike <a class="el" href="step_31.html">step-31</a> , this step uses one more <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object called darcy_preconditioner_constraints. This constraint object is used only for assembling the matrix for the Darcy preconditioner and includes hanging node constraints as well as Dirichlet boundary value constraints for the pressure variable. We need this because we are building a Laplace matrix for the pressure as an approximation of the Schur complement) which is only positive definite if boundary conditions are applied. <br  />
 The collection of member functions and variables thus declared in this class is then rather similar to those in <a class="el" href="step_31.html">step-31</a> :</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>TwoPhaseFlowProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  TwoPhaseFlowProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_darcy_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span> build_darcy_preconditioner();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_darcy_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_matrix();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_rhs();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_rhs_cell_term(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       saturation_fe_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       darcy_fe_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_max_u_F_prime,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_S_variation,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  <span class="keywordtype">void</span> assemble_saturation_rhs_boundary_term(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   saturation_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   darcy_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">  <span class="keywordtype">void</span> refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line">  <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
</div><!-- fragment --><p>We follow with a number of helper functions that are used in a variety of places throughout the program:</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span>                    get_max_u_F_prime() <span class="keyword">const</span>;</div>
<div class="line">std::pair&lt;double, double&gt; get_extrapolated_saturation_range() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">bool</span>   determine_whether_to_solve_for_pressure_and_velocity() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">void</span>   project_back_saturation();</div>
<div class="line"><span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_saturation,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_saturation,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_saturation_grads,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_saturation_grads,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;present_darcy_values,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_max_u_F_prime,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_S_variation,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div>
</div><!-- fragment --><p>This all is followed by the member variables, most of which are similar to the ones in <a class="el" href="step_31.html">step-31</a> , with the exception of the ones that pertain to the macro time stepping for the velocity/pressure system:</p>
<div class="fragment"><div class="line"><a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line"><span class="keywordtype">double</span>             global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        darcy_degree;</div>
<div class="line"><a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             darcy_fe;</div>
<div class="line"><a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           darcy_dof_handler;</div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> darcy_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> darcy_preconditioner_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> darcy_matrix;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> darcy_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> darcy_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> darcy_rhs;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> last_computed_darcy_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> second_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        saturation_degree;</div>
<div class="line"><a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 saturation_fe;</div>
<div class="line"><a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           saturation_dof_handler;</div>
<div class="line"><a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> saturation_constraints;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> saturation_matrix;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> saturation_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_saturation_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_saturation_solution;</div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> saturation_rhs;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div>
<div class="line">  saturation_matching_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> saturation_refinement_threshold;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span>       <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> end_time;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> current_macro_time_step;</div>
<div class="line"><span class="keywordtype">double</span> old_macro_time_step;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span>       time_step;</div>
<div class="line"><span class="keywordtype">double</span>       old_time_step;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> viscosity;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> porosity;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> AOS_threshold;</div>
<div class="line"> </div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt; Amg_preconditioner;</div>
<div class="line">std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt; Mp_preconditioner;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> rebuild_saturation_matrix;</div>
</div><!-- fragment --><p>At the very end we declare a variable that denotes the material model. Compared to <a class="el" href="step_21.html">step-21</a> , we do this here as a member variable since we will want to use it in a variety of places and so having a central place where such a variable is declared will make it simpler to replace one class by another (e.g. replace RandomMedium::KInverse by SingleCurvingCrack::KInverse). <br  />
</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> RandomMedium::KInverse&lt;dim&gt; k_inverse;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimTwoPhaseFlowProblem"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::TwoPhaseFlowProblem</h3>
<p>The constructor of this class is an extension of the constructors in <a class="el" href="step_21.html">step-21</a> and <a class="el" href="step_31.html">step-31</a> . We need to add the various variables that concern the saturation. As discussed in the introduction, we are going to use \(Q_2 \times Q_1\) (Taylor-Hood) elements again for the Darcy system, an element combination that fulfills the Ladyzhenskaya-Babuska-Brezzi (LBB) conditions [Brezzi and Fortin 1991, Chen 2005], and \(Q_1\) elements for the saturation. However, by using variables that store the polynomial degree of the Darcy and temperature finite elements, it is easy to consistently modify the degree of the elements as well as all quadrature formulas used on them downstream. Moreover, we initialize the time stepping variables related to operator splitting as well as the option for matrix assembly and preconditioning:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">TwoPhaseFlowProblem&lt;dim&gt;::TwoPhaseFlowProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">  , global_Omega_diameter(std::numeric_limits&lt;<a class="code" href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a>&gt;::quiet_NaN())</div>
<div class="line">  , <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  , darcy_degree(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">  , darcy_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(darcy_degree + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(darcy_degree), 1)</div>
<div class="line">  , darcy_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  saturation_degree(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1)</div>
<div class="line">  , saturation_fe(saturation_degree)</div>
<div class="line">  , saturation_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  saturation_refinement_threshold(0.5)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>(0)</div>
<div class="line">  , end_time(10)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  current_macro_time_step(0)</div>
<div class="line">  , old_macro_time_step(0)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  time_step(0)</div>
<div class="line">  , old_time_step(0)</div>
<div class="line">  , timestep_number(0)</div>
<div class="line">  , viscosity(0.2)</div>
<div class="line">  , porosity(1.0)</div>
<div class="line">  , AOS_threshold(3.0)</div>
<div class="line">  ,</div>
<div class="line"> </div>
<div class="line">  rebuild_saturation_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimsetup_dofs"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::setup_dofs</h3>
<p>This is the function that sets up the <a class="el" href="classDoFHandler.html">DoFHandler</a> objects we have here (one for the Darcy part and one for the saturation part) as well as set to the right sizes the various objects required for the linear algebra in this program. Its basic operations are similar to what <a class="el" href="step_31.html">step-31</a> did. <br  />
 The body of the function first enumerates all degrees of freedom for the Darcy and saturation systems. For the Darcy part, degrees of freedom are then sorted to ensure that velocities precede pressure DoFs so that we can partition the Darcy matrix into a \(2 \times 2\) matrix. <br  />
 Then, we need to incorporate hanging node constraints and Dirichlet boundary value constraints into darcy_preconditioner_constraints. The boundary condition constraints are only set on the pressure component since the Schur complement preconditioner that corresponds to the porous media flow operator in non-mixed form, \(-\nabla \cdot [\mathbf K \lambda_t(S)]\nabla\) , acts only on the pressure variable. Therefore, we use a component_mask that filters out the velocity component, so that the condensation is performed on pressure degrees of freedom only. After having done so, we count the number of degrees of freedom in the various blocks. This information is then used to create the sparsity pattern for the Darcy and saturation system matrices as well as the preconditioner matrix from which we build the Darcy preconditioner. As in <a class="el" href="step_31.html">step-31</a> , we choose to create the pattern using the blocked version of <a class="el" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a>. So, for this, we follow the same way as <a class="el" href="step_31.html">step-31</a> did and we don't have to repeat descriptions again for the rest of the member function.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  std::vector&lt;unsigned int&gt; darcy_block_component(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">  darcy_block_component[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">  {</div>
<div class="line">    darcy_dof_handler.distribute_dofs(darcy_fe);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>(darcy_dof_handler);</div>
<div class="line">    <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(darcy_dof_handler, darcy_block_component);</div>
<div class="line"> </div>
<div class="line">    darcy_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                            darcy_constraints);</div>
<div class="line">    darcy_constraints.close();</div>
<div class="line">  }</div>
<div class="line">  {</div>
<div class="line">    saturation_dof_handler.distribute_dofs(saturation_fe);</div>
<div class="line"> </div>
<div class="line">    saturation_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(saturation_dof_handler,</div>
<div class="line">                                            saturation_constraints);</div>
<div class="line">    saturation_constraints.close();</div>
<div class="line">  }</div>
<div class="line">  {</div>
<div class="line">    darcy_preconditioner_constraints.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                            darcy_preconditioner_constraints);</div>
<div class="line">    <a class="code" href="group__constraints.html#ga06c0301bc74dd4c67a3d1db1000647f3">DoFTools::make_zero_boundary_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                             darcy_preconditioner_constraints,</div>
<div class="line">                                             darcy_fe.component_mask(</div>
<div class="line">                                               <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>));</div>
<div class="line"> </div>
<div class="line">    darcy_preconditioner_constraints.close();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; darcy_dofs_per_block =</div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(darcy_dof_handler,</div>
<div class="line">                                      darcy_block_component);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = darcy_dofs_per_block[0],</div>
<div class="line">                     n_p = darcy_dofs_per_block[1],</div>
<div class="line">                     n_s = saturation_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_s &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div>
<div class="line">            &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_s &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    darcy_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">    dsp.block(0, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_u);</div>
<div class="line">    dsp.block(0, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_p);</div>
<div class="line">    dsp.block(1, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_u);</div>
<div class="line">    dsp.block(1, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">    dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">      darcy_dof_handler, coupling, dsp, darcy_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    darcy_matrix.reinit(dsp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    Amg_preconditioner.reset();</div>
<div class="line">    Mp_preconditioner.reset();</div>
<div class="line">    darcy_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">    dsp.block(0, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_u);</div>
<div class="line">    dsp.block(0, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_p);</div>
<div class="line">    dsp.block(1, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_u);</div>
<div class="line">    dsp.block(1, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">    dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">      darcy_dof_handler, coupling, dsp, darcy_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">    darcy_preconditioner_matrix.reinit(dsp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    saturation_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_s, n_s);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(saturation_dof_handler,</div>
<div class="line">                                    dsp,</div>
<div class="line">                                    saturation_constraints,</div>
<div class="line">                                    <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    saturation_matrix.reinit(dsp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;IndexSet&gt; darcy_partitioning(2);</div>
<div class="line">  darcy_partitioning[0] = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_u);</div>
<div class="line">  darcy_partitioning[1] = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_p);</div>
<div class="line">  darcy_solution.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  last_computed_darcy_solution.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  last_computed_darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  second_last_computed_darcy_solution.reinit(darcy_partitioning,</div>
<div class="line">                                             MPI_COMM_WORLD);</div>
<div class="line">  second_last_computed_darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  darcy_rhs.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  darcy_rhs.collect_sizes();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> saturation_partitioning = <a class="code" href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_s);</div>
<div class="line">  saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  old_old_saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  saturation_matching_last_computed_darcy_solution.reinit(</div>
<div class="line">    saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">  saturation_rhs.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Assemblingmatricesandpreconditioners"></a> </p><h3>Assembling matrices and preconditioners</h3>
<p>The next few functions are devoted to setting up the various system and preconditioner matrices and right hand sides that we have to deal with in this program.</p>
<pre class="fragment">&lt;a name="TwoPhaseFlowProblemdimassemble_darcy_preconditioner"&gt;&lt;/a&gt;  &lt;h4&gt;TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_preconditioner&lt;/h4&gt;
</pre><p>This function assembles the matrix we use for preconditioning the Darcy system. What we need are a vector mass matrix weighted by \(\left(\mathbf{K} \lambda_t\right)^{-1}\) on the velocity components and a mass matrix weighted by \(\left(\mathbf{K} \lambda_t\right)\) on the pressure component. We start by generating a quadrature object of appropriate order, the <a class="el" href="classFEValues.html">FEValues</a> object that can give values and gradients at the quadrature points (together with quadrature weights). Next we create data structures for the cell matrix and the relation between local and global DoFs. The vectors phi_u and grad_phi_p are going to hold the values of the basis functions in order to faster build up the local matrices, as was already done in <a class="el" href="step_22.html">step-22</a> . Before we start the loop over all active cells, we have to specify which components are pressure and which are velocity. <br  />
 The creation of the local matrix is rather simple. There are only a term weighted by \(\left(\mathbf{K} \lambda_t\right)^{-1}\) (on the velocity) and a Laplace matrix weighted by \(\left(\mathbf{K} \lambda_t\right)\) to be generated, so the creation of the local matrix is done in essentially two lines. Since the material model functions at the top of this file only provide the inverses of the permeability and mobility, we have to compute \(\mathbf K\) and \(\lambda_t\) by hand from the given values, once per quadrature point. <br  />
 Once the local matrix is ready (loop over rows and columns in the local matrix on each quadrature point), we get the local DoF indices and write the local information into the global matrix. We do this by directly applying the constraints (i.e. darcy_preconditioner_constraints) that takes care of hanging node and zero Dirichlet boundary condition constraints. By doing so, we don't have to do that afterwards, and we later don't have to use <a class="el" href="classAffineConstraints.html#a5a1bc1bb2d705b582889ebaa24bcae5c">AffineConstraints::condense</a> and <a class="el" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>, both functions that would need to modify matrix and vector entries and so are difficult to write for the Trilinos classes where we don't immediately have access to individual memory locations.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_preconditioner()</div>
<div class="line">{</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding darcy preconditioner...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  darcy_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(darcy_degree + 2);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     darcy_fe_values(darcy_fe,</div>
<div class="line">                                quadrature_formula,</div>
<div class="line">                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     saturation_fe_values(saturation_fe,</div>
<div class="line">                                     quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = darcy_fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">  <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">    {</div>
<div class="line">      darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">      local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">      saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                               old_saturation_values);</div>
<div class="line"> </div>
<div class="line">      k_inverse.value_list(darcy_fe_values.get_quadrature_points(),</div>
<div class="line">                           k_inverse_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> old_s = old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> inverse_mobility = <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_s, viscosity);</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> mobility         = 1.0 / inverse_mobility;</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> permeability = <a class="code" href="classSymmetricTensor.html#a33cd1a6c91c24a5ca34dfbc43c338d1c">invert</a>(k_inverse_values[q]);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">            {</div>
<div class="line">              phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              grad_phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = darcy_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              {</div>
<div class="line">                local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  (k_inverse_values[q] inverse_mobility phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]</div>
<div class="line">                     phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] +</div>
<div class="line">                   permeability mobility grad_phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] grad_phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])</div>
<div class="line">                  darcy_fe_values.JxW(q);</div>
<div class="line">              }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">      darcy_preconditioner_constraints.distribute_local_to_global(</div>
<div class="line">        local_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, darcy_preconditioner_matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimbuild_darcy_preconditioner"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::build_darcy_preconditioner</h4>
<p>After calling the above functions to assemble the preconditioner matrix, this function generates the inner preconditioners that are going to be used for the Schur complement block preconditioner. The preconditioners need to be regenerated at every saturation time step since they depend on the saturation \(S\) that varies with time. <br  />
 In here, we set up the preconditioner for the velocity-velocity matrix \(\mathbf{M}^{\mathbf{u}}\) and the Schur complement \(\mathbf{S}\) . As explained in the introduction, we are going to use an IC preconditioner based on the vector matrix \(\mathbf{M}^{\mathbf{u}}\) and another based on the scalar Laplace matrix \(\tilde{\mathbf{S}}^p\) (which is spectrally close to the Schur complement of the Darcy matrix). Usually, the <a class="el" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> class can be seen as a good black-box preconditioner which does not need any special knowledge of the matrix structure and/or the operator that's behind it.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::build_darcy_preconditioner()</div>
<div class="line">{</div>
<div class="line">  assemble_darcy_preconditioner();</div>
<div class="line"> </div>
<div class="line">  Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">  Amg_preconditioner-&gt;initialize(darcy_preconditioner_matrix.block(0, 0));</div>
<div class="line"> </div>
<div class="line">  Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">  Mp_preconditioner-&gt;initialize(darcy_preconditioner_matrix.block(1, 1));</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_darcy_system"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_system</h4>
<p>This is the function that assembles the linear system for the Darcy system. <br  />
 Regarding the technical details of implementation, the procedures are similar to those in <a class="el" href="step_22.html">step-22</a> and <a class="el" href="step_31.html">step-31</a> . We reset matrix and vector, create a quadrature formula on the cells, and then create the respective <a class="el" href="classFEValues.html">FEValues</a> object. <br  />
 There is one thing that needs to be commented: since we have a separate finite element and <a class="el" href="classDoFHandler.html">DoFHandler</a> for the saturation, we need to generate a second <a class="el" href="classFEValues.html">FEValues</a> object for the proper evaluation of the saturation solution. This isn't too complicated to realize here: just use the saturation structures and set an update flag for the basis function values which we need for evaluation of the saturation solution. The only important part to remember here is that the same quadrature formula is used for both <a class="el" href="classFEValues.html">FEValues</a> objects to ensure that we get matching information when we loop over the quadrature points of the two objects. <br  />
 The declarations proceed with some shortcuts for array sizes, the creation of the local matrix, right hand side as well as the vector for the indices of the local dofs compared to the global system.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_system()</div>
<div class="line">   {</div>
<div class="line">     darcy_matrix = 0;</div>
<div class="line">     darcy_rhs    = 0;</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(darcy_degree + 2);</div>
<div class="line">     <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt; face_quadrature_formula(darcy_degree + 2);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe,</div>
<div class="line">                                   quadrature_formula,</div>
<div class="line">                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                        quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> darcy_fe_face_values(darcy_fe,</div>
<div class="line">                                            face_quadrature_formula,</div>
<div class="line">                                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = darcy_fe.n_dofs_per_cell();</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>      = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points = face_quadrature_formula.size();</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">     <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a> pressure_right_hand_side;</div>
<div class="line">     <span class="keyword">const</span> PressureBoundaryValues&lt;dim&gt;  pressure_boundary_values;</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;double&gt;         pressure_rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt;         boundary_values(n_face_q_points);</div>
<div class="line">     std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
</div><!-- fragment --><p>Next we need a vector that will contain the values of the saturation solution at the previous time level at the quadrature points to assemble the saturation dependent coefficients in the Darcy equations. <br  />
 The set of vectors we create next hold the evaluations of the basis functions as well as their gradients that will be used for creating the matrices. Putting these into their own arrays rather than asking the <a class="el" href="classFEValues.html">FEValues</a> object for this information each time it is needed is an optimization to accelerate the assembly process, see <a class="el" href="step_22.html">step-22</a> for details. <br  />
 The last two declarations are used to extract the individual blocks (velocity, pressure, saturation) from the total FE system.</p>
<div class="fragment"><div class="line">std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;         div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">std::vector&lt;double&gt;         phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
</div><!-- fragment --><p>Now start the loop over all cells in the problem. We are working on two different DoFHandlers for this assembly routine, so we must have two different cell iterators for the two objects in use. This might seem a bit peculiar, but since both the Darcy system and the saturation system use the same grid we can assume that the two iterators run in sync over the cells of the two <a class="el" href="classDoFHandler.html">DoFHandler</a> objects. <br  />
 The first statements within the loop are again all very familiar, doing the update of the finite element data as specified by the update flags, zeroing out the local arrays and getting the values of the old solution at the quadrature points. At this point we also have to get the values of the saturation function of the previous time step at the quadrature points. To this end, we can use the FEValues::get_function_values (previously already used in <a class="el" href="step_9.html">step-9</a> , <a class="el" href="step_14.html">step-14</a> and <a class="el" href="step_15.html">step-15</a> ), a function that takes a solution vector and returns a list of function values at the quadrature points of the present cell. In fact, it returns the complete vector-valued solution at each quadrature point, i.e. not only the saturation but also the velocities and pressure. <br  />
 Then we are ready to loop over the quadrature points on the cell to do the integration. The formula for this follows in a straightforward way from what has been discussed in the introduction. <br  />
 Once this is done, we start the loop over the rows and columns of the local matrix and feed the matrix with the relevant products. <br  />
 The last step in the loop over all cells is to enter the local contributions into the global matrix and vector structures to the positions specified in local_dof_indices. Again, we let the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class do the insertion of the cell matrix elements to the global matrix, which already condenses the hanging node constraints.</p>
<div class="fragment"><div class="line">     <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">     <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">     <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">       {</div>
<div class="line">         darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">         saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line">  </div>
<div class="line">         local_matrix = 0;</div>
<div class="line">         local_rhs    = 0;</div>
<div class="line">  </div>
<div class="line">         saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                                  old_saturation_values);</div>
<div class="line">  </div>
<div class="line">         pressure_right_hand_side.<a class="code" href="classFunctions_1_1ConstantFunction.html#a6a3224d6e805fa73629130e021a7285b">value_list</a>(</div>
<div class="line">           darcy_fe_values.get_quadrature_points(), pressure_rhs_values);</div>
<div class="line">         k_inverse.value_list(darcy_fe_values.get_quadrature_points(),</div>
<div class="line">                              k_inverse_values);</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">           {</div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">               {</div>
<div class="line">                 phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                 div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                 phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = darcy_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">               }</div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">               {</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> old_s = old_saturation_values[q];</div>
<div class="line">                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt;= <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                   {</div>
<div class="line">                     local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                       (phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] k_inverse_values[q]</div>
<div class="line">                          <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_s, viscosity) phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                        div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]</div>
<div class="line">  </div>
<div class="line">- phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>])</div>
<div class="line">                       darcy_fe_values.JxW(q);</div>
<div class="line">                   }</div>
<div class="line">  </div>
<div class="line">                 local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                   (-phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] pressure_rhs_values[q]) darcy_fe_values.JxW(q);</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">           <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">             {</div>
<div class="line">               darcy_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">  </div>
<div class="line">               pressure_boundary_values.value_list(</div>
<div class="line">                 darcy_fe_face_values.get_quadrature_points(), boundary_values);</div>
<div class="line">  </div>
<div class="line">               <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_q_points; ++q)</div>
<div class="line">                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                   {</div>
<div class="line">                     <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> phi_i_u =</div>
<div class="line">                       darcy_fe_face_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">  </div>
<div class="line">                     local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-(phi_i_u darcy_fe_face_values.normal_vector(q)</div>
<div class="line">                         boundary_values[q] darcy_fe_face_values.JxW(q));</div>
<div class="line">                   }</div>
<div class="line">             }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> + 1; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">             local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = local_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line">  </div>
<div class="line">         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  </div>
<div class="line">         darcy_constraints.distribute_local_to_global(</div>
<div class="line">           local_matrix, local_rhs, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, darcy_matrix, darcy_rhs);</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_system"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_system</h4>
<p>This function is to assemble the linear system for the saturation transport equation. It calls, if necessary, two other member functions: assemble_saturation_matrix() and assemble_saturation_rhs(). The former function then assembles the saturation matrix that only needs to be changed occasionally. On the other hand, the latter function that assembles the right hand side must be called at every saturation time step.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_system()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (rebuild_saturation_matrix == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      saturation_matrix = 0;</div>
<div class="line">      assemble_saturation_matrix();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  saturation_rhs = 0;</div>
<div class="line">  assemble_saturation_rhs();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_matrix"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_matrix</h4>
<p>This function is easily understood since it only forms a simple mass matrix for the left hand side of the saturation linear system by basis functions phi_i_s and phi_j_s only. Finally, as usual, we enter the local contribution into the global matrix by specifying the position in local_dof_indices. This is done by letting the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class do the insertion of the cell matrix elements to the global matrix, which already condenses the hanging node constraints.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_matrix()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(saturation_degree + 2);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                     quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      local_matrix = 0;</div>
<div class="line">      local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> phi_i_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> phi_j_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q);</div>
<div class="line">                local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                  porosity phi_i_s phi_j_s saturation_fe_values.JxW(q);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">      <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">      saturation_constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                                        <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                        saturation_matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_rhs"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs</h4>
<p>This function is to assemble the right hand side of the saturation transport equation. Before going about it, we have to create two <a class="el" href="classFEValues.html">FEValues</a> objects for the Darcy and saturation systems respectively and, in addition, two <a class="el" href="classFEFaceValues.html">FEFaceValues</a> objects for the two systems because we have a boundary integral term in the weak form of saturation equation. For the <a class="el" href="classFEFaceValues.html">FEFaceValues</a> object of the saturation system, we also require normal vectors, which we request using the update_normal_vectors flag. <br  />
 Next, before looping over all the cells, we have to compute some parameters (e.g. global_u_infty, global_S_variation, and global_Omega_diameter) that the artificial viscosity \(\nu\) needs. This is largely the same as was done in <a class="el" href="step_31.html">step-31</a> , so you may see there for more information. <br  />
 The real works starts with the loop over all the saturation and Darcy cells to put the local contributions into the global vector. In this loop, in order to simplify the implementation, we split some of the work into two helper functions: assemble_saturation_rhs_cell_term and assemble_saturation_rhs_boundary_term. We note that we insert cell or boundary contributions into the global vector in the two functions rather than in this present function.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs()</div>
<div class="line">   {</div>
<div class="line">     <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(saturation_degree + 2);</div>
<div class="line">     <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div>
<div class="line">  </div>
<div class="line">- 1&gt; face_quadrature_formula(saturation_degree + 2);</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                        quadrature_formula,</div>
<div class="line">                                        <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                          <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">     <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> saturation_fe_face_values(saturation_fe,</div>
<div class="line">                                                 face_quadrature_formula,</div>
<div class="line">                                                 <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                                   <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">     <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> darcy_fe_face_values(darcy_fe,</div>
<div class="line">                                            face_quadrature_formula,</div>
<div class="line">                                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">     <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> saturation_fe_face_values_neighbor(</div>
<div class="line">       saturation_fe, face_quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">       saturation_dof_handler.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">     std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_u_F_prime = get_max_u_F_prime();</div>
<div class="line">     <span class="keyword">const</span> std::pair&lt;double, double&gt; global_S_range =</div>
<div class="line">       get_extrapolated_saturation_range();</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> global_S_variation =</div>
<div class="line">       global_S_range.second</div>
<div class="line">  </div>
<div class="line">- global_S_range.first;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>       = saturation_dof_handler.begin_active();</div>
<div class="line">     <span class="keyword">const</span> <span class="keyword">auto</span> endc       = saturation_dof_handler.end();</div>
<div class="line">     <span class="keyword">auto</span>       darcy_cell = darcy_dof_handler.begin_active();</div>
<div class="line">     <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++darcy_cell)</div>
<div class="line">       {</div>
<div class="line">         saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">         darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(darcy_cell);</div>
<div class="line">  </div>
<div class="line">         <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  </div>
<div class="line">         assemble_saturation_rhs_cell_term(saturation_fe_values,</div>
<div class="line">                                           darcy_fe_values,</div>
<div class="line">                                           global_max_u_F_prime,</div>
<div class="line">                                           global_S_variation,</div>
<div class="line">                                           <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">           <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">             {</div>
<div class="line">               darcy_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(darcy_cell, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">               saturation_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">               assemble_saturation_rhs_boundary_term(saturation_fe_face_values,</div>
<div class="line">                                                     darcy_fe_face_values,</div>
<div class="line">                                                     <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">             }</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_rhs_cell_term"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_cell_term</h4>
<p>This function takes care of integrating the cell terms of the right hand side of the saturation equation, and then assembling it into the global right hand side vector. Given the discussion in the introduction, the form of these contributions is clear. The only tricky part is getting the artificial viscosity and all that is necessary to compute it. The first half of the function is devoted to this task. <br  />
 The last part of the function is copying the local contributions into the global vector with position specified in local_dof_indices.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_cell_term(</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       saturation_fe_values,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       darcy_fe_values,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_max_u_F_prime,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_S_variation,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe_values.dofs_per_cell;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = saturation_fe_values.n_quadrature_points;</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;double&gt;         old_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt;         old_old_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_grad_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_grad_saturation_solution_values(</div>
<div class="line">       <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;Vector&lt;double&gt;&gt; present_darcy_solution_values(</div>
<div class="line">       <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">  </div>
<div class="line">     saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                              old_saturation_solution_values);</div>
<div class="line">     saturation_fe_values.get_function_values(</div>
<div class="line">       old_old_saturation_solution, old_old_saturation_solution_values);</div>
<div class="line">     saturation_fe_values.get_function_gradients(</div>
<div class="line">       old_saturation_solution, old_grad_saturation_solution_values);</div>
<div class="line">     saturation_fe_values.get_function_gradients(</div>
<div class="line">       old_old_saturation_solution, old_old_grad_saturation_solution_values);</div>
<div class="line">     darcy_fe_values.get_function_values(darcy_solution,</div>
<div class="line">                                         present_darcy_solution_values);</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">       compute_viscosity(old_saturation_solution_values,</div>
<div class="line">                         old_old_saturation_solution_values,</div>
<div class="line">                         old_grad_saturation_solution_values,</div>
<div class="line">                         old_old_grad_saturation_solution_values,</div>
<div class="line">                         present_darcy_solution_values,</div>
<div class="line">                         global_max_u_F_prime,</div>
<div class="line">                         global_S_variation,</div>
<div class="line">                         saturation_fe_values.get_cell()-&gt;diameter());</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">         {</div>
<div class="line">           <span class="keyword">const</span> <span class="keywordtype">double</span>   old_s = old_saturation_solution_values[q];</div>
<div class="line">           <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> present_u;</div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">             present_u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_solution_values[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line">  </div>
<div class="line">           <span class="keyword">const</span> <span class="keywordtype">double</span>         phi_i_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">           <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> grad_phi_i_s =</div>
<div class="line">             saturation_fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">  </div>
<div class="line">           local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">             (time_step <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>(old_s, viscosity) present_u</div>
<div class="line">                grad_phi_i_s</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">              time_step nu old_grad_saturation_solution_values[q]</div>
<div class="line">                grad_phi_i_s +</div>
<div class="line">              porosity old_s phi_i_s)</div>
<div class="line">             saturation_fe_values.JxW(q);</div>
<div class="line">         }</div>
<div class="line">  </div>
<div class="line">     saturation_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                       <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                       saturation_rhs);</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimassemble_saturation_rhs_boundary_term"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_boundary_term</h4>
<p>The next function is responsible for the boundary integral terms in the right hand side form of the saturation equation. For these, we have to compute the upwinding flux on the global boundary faces, i.e. we impose Dirichlet boundary conditions weakly only on inflow parts of the global boundary. As before, this has been described in <a class="el" href="step_21.html">step-21</a> so we refrain from giving more descriptions about that.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_boundary_term(</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   saturation_fe_face_values,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   darcy_fe_face_values,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">   {</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe_face_values.dofs_per_cell;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points =</div>
<div class="line">       saturation_fe_face_values.n_quadrature_points;</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;double&gt; old_saturation_solution_values_face(n_face_q_points);</div>
<div class="line">     std::vector&lt;Vector&lt;double&gt;&gt; present_darcy_solution_values_face(</div>
<div class="line">       n_face_q_points, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">     std::vector&lt;double&gt; neighbor_saturation(n_face_q_points);</div>
<div class="line">  </div>
<div class="line">     saturation_fe_face_values.get_function_values(</div>
<div class="line">       old_saturation_solution, old_saturation_solution_values_face);</div>
<div class="line">     darcy_fe_face_values.get_function_values(</div>
<div class="line">       darcy_solution, present_darcy_solution_values_face);</div>
<div class="line">  </div>
<div class="line">     SaturationBoundaryValues&lt;dim&gt; saturation_boundary_values;</div>
<div class="line">     saturation_boundary_values.value_list(</div>
<div class="line">       saturation_fe_face_values.get_quadrature_points(), neighbor_saturation);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_q_points; ++q)</div>
<div class="line">       {</div>
<div class="line">         <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> present_u_face;</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">           present_u_face[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_solution_values_face[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> normal_flux =</div>
<div class="line">           present_u_face saturation_fe_face_values.normal_vector(q);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">bool</span> is_outflow_q_point = (normal_flux &gt;= 0);</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">           local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">  </div>
<div class="line">-=</div>
<div class="line">             time_step normal_flux</div>
<div class="line">             <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>((is_outflow_q_point == <span class="keyword">true</span> ?</div>
<div class="line">                                old_saturation_solution_values_face[q] :</div>
<div class="line">                                neighbor_saturation[q]),</div>
<div class="line">                             viscosity)</div>
<div class="line">             saturation_fe_face_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q)</div>
<div class="line">             saturation_fe_face_values.JxW(q);</div>
<div class="line">       }</div>
<div class="line">     saturation_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                       <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                       saturation_rhs);</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimsolve"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::solve</h3>
<p>This function implements the operator splitting algorithm, i.e. in each time step it either re-computes the solution of the Darcy system or extrapolates velocity/pressure from previous time steps, then determines the size of the time step, and then updates the saturation variable. The implementation largely follows similar code in <a class="el" href="step_31.html">step-31</a> . It is, next to the <a class="el" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run()</a> function, the central one in this program. <br  />
 At the beginning of the function, we ask whether to solve the pressure-velocity part by evaluating the a posteriori criterion (see the following function). If necessary, we will solve the pressure-velocity part using the GMRES solver with the Schur complement block preconditioner as is described in the introduction.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">TwoPhaseFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> solve_for_pressure_and_velocity =</div>
<div class="line">    determine_whether_to_solve_for_pressure_and_velocity();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (solve_for_pressure_and_velocity == <span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving Darcy (pressure-velocity) system...&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      assemble_darcy_system();</div>
<div class="line">      build_darcy_preconditioner();</div>
<div class="line"> </div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                           <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">          mp_inverse(darcy_preconditioner_matrix.block(1, 1),</div>
<div class="line">                    Mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">          <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a2a3c696b5297cb04d9a7137121aba8b7">TrilinosWrappers::PreconditionIC</a>,</div>
<div class="line">          <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">          <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(darcy_matrix, mp_inverse,Amg_preconditioner);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(darcy_matrix.m(),</div>
<div class="line">                                     1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-16 darcy_rhs.l2_norm());</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classSolverGMRES.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> gmres(</div>
<div class="line">          solver_control,</div>
<div class="line">          <a class="code" href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">            100));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; darcy_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (darcy_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">            darcy_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line">        gmres.solve(darcy_matrix, darcy_solution, darcy_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">        darcy_constraints.distribute(darcy_solution);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;        ...&quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot; GMRES iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      {</div>
<div class="line">        second_last_computed_darcy_solution = last_computed_darcy_solution;</div>
<div class="line">        last_computed_darcy_solution        = darcy_solution;</div>
<div class="line"> </div>
<div class="line">        saturation_matching_last_computed_darcy_solution =</div>
<div class="line">          saturation_solution;</div>
<div class="line">      }</div>
<div class="line">    }</div>
</div><!-- fragment --><p>On the other hand, if we have decided that we don't want to compute the solution of the Darcy system for the current time step, then we need to simply extrapolate the previous two Darcy solutions to the same time as we would have computed the velocity/pressure at. We do a simple linear extrapolation, i.e. given the current length \(dt\) of the macro time step from the time when we last computed the Darcy solution to now (given by <code>current_macro_time_step</code> ), and \(DT\) the length of the last macro time step (given by <code>old_macro_time_step</code> ), then we get \(u^\ast = u_p + dt \frac{u_p-u_{pp}}{DT} = (1+dt/DT)u_p - dt/DT u_{pp}\) , where \(u_p\) and \(u_{pp}\) are the last two computed Darcy solutions. We can implement this formula using just two lines of code. Note that the algorithm here only works if we have at least two previously computed Darcy solutions from which we can extrapolate to the current time, and this is ensured by requiring re-computation of the Darcy solution for the first 2 time steps.</p>
<div class="fragment"><div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       {</div>
<div class="line">         darcy_solution = last_computed_darcy_solution;</div>
<div class="line">         darcy_solution.sadd(1 + current_macro_time_step / old_macro_time_step,</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">-current_macro_time_step / old_macro_time_step,</div>
<div class="line">                             second_last_computed_darcy_solution);</div>
<div class="line">       }</div>
</div><!-- fragment --><p>With the so computed velocity vector, compute the optimal time step based on the CFL criterion discussed in the introduction...</p>
<div class="fragment"><div class="line">     {</div>
<div class="line">       old_time_step = time_step;</div>
<div class="line">  </div>
<div class="line">       <span class="keyword">const</span> <span class="keywordtype">double</span> max_u_F_prime = get_max_u_F_prime();</div>
<div class="line">       <span class="keywordflow">if</span> (max_u_F_prime &gt; 0)</div>
<div class="line">         time_step = porosity <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) /</div>
<div class="line">                     saturation_degree / max_u_F_prime / 50;</div>
<div class="line">       <span class="keywordflow">else</span></div>
<div class="line">         time_step = end_time</div>
<div class="line">  </div>
<div class="line">- <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">     }</div>
</div><!-- fragment --><p>...and then also update the length of the macro time steps we use while we're dealing with time step sizes. In particular, this involves: (i) If we have just recomputed the Darcy solution, then the length of the previous macro time step is now fixed and the length of the current macro time step is, up to now, simply the length of the current (micro) time step. (ii) If we have not recomputed the Darcy solution, then the length of the current macro time step has just grown by <code>time_step</code> .</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (solve_for_pressure_and_velocity == <span class="keyword">true</span>)</div>
<div class="line">  {</div>
<div class="line">    old_macro_time_step     = current_macro_time_step;</div>
<div class="line">    current_macro_time_step = time_step;</div>
<div class="line">  }</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">  current_macro_time_step += time_step;</div>
</div><!-- fragment --><p>The last step in this function is to recompute the saturation solution based on the velocity field we've just obtained. This naturally happens in every time step, and we don't skip any of these computations. At the end of computing the saturation, we project back into the allowed interval \([0,1]\) to make sure our solution remains physical.</p>
<div class="fragment"><div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving saturation transport equation...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    assemble_saturation_system();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(saturation_matrix.m(),</div>
<div class="line">                                 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-16 saturation_rhs.l2_norm());</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">    <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(saturation_matrix);</div>
<div class="line"> </div>
<div class="line">    cg.solve(saturation_matrix,</div>
<div class="line">             saturation_solution,</div>
<div class="line">             saturation_rhs,</div>
<div class="line">             <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">    saturation_constraints.distribute(saturation_solution);</div>
<div class="line">    project_back_saturation();</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;        ...&quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimrefine_mesh"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::refine_mesh</h3>
<p>The next function does the refinement and coarsening of the mesh. It does its work in three blocks: (i) Compute refinement indicators by looking at the gradient of a solution vector extrapolated linearly from the previous two using the respective sizes of the time step (or taking the only solution we have if this is the first time step). (ii) Flagging those cells for refinement and coarsening where the gradient is larger or smaller than a certain threshold, preserving minimal and maximal levels of mesh refinement. (iii) Transferring the solution from the old to the new mesh. None of this is particularly difficult.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> refinement_indicators(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQMidpoint.html">QMidpoint&lt;dim&gt;</a>        quadrature_formula;</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(saturation_fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_saturation(1);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> extrapolated_saturation_solution(</div>
<div class="line">      saturation_solution);</div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">      extrapolated_saturation_solution.sadd((1. + time_step / old_time_step),</div>
<div class="line">                                            time_step / old_time_step,</div>
<div class="line">                                            old_saturation_solution);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_no = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values.get_function_gradients(extrapolated_saturation_solution,</div>
<div class="line">                                         grad_saturation);</div>
<div class="line"> </div>
<div class="line">        refinement_indicators(cell_no) = grad_saturation[0].norm();</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_no = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_coarsen_flag();</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level()) &lt; max_grid_level) &amp;&amp;</div>
<div class="line">            (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(refinement_indicators(cell_no)) &gt;</div>
<div class="line">             saturation_refinement_threshold))</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;set_refine_flag();</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level()) &gt;</div>
<div class="line">                  min_grid_level) &amp;&amp;</div>
<div class="line">                 (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(refinement_indicators(cell_no)) &lt;</div>
<div class="line">                  0.5 saturation_refinement_threshold))</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;set_coarsen_flag();</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_saturation(3);</div>
<div class="line">    x_saturation[0] = saturation_solution;</div>
<div class="line">    x_saturation[1] = old_saturation_solution;</div>
<div class="line">    x_saturation[2] = saturation_matching_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; x_darcy(2);</div>
<div class="line">    x_darcy[0] = last_computed_darcy_solution;</div>
<div class="line">    x_darcy[1] = second_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> saturation_soltrans(</div>
<div class="line">      saturation_dof_handler);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> darcy_soltrans(</div>
<div class="line">      darcy_dof_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">    saturation_soltrans.prepare_for_coarsening_and_refinement(x_saturation);</div>
<div class="line"> </div>
<div class="line">    darcy_soltrans.prepare_for_coarsening_and_refinement(x_darcy);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp_saturation(3);</div>
<div class="line">    tmp_saturation[0].reinit(saturation_solution);</div>
<div class="line">    tmp_saturation[1].reinit(saturation_solution);</div>
<div class="line">    tmp_saturation[2].reinit(saturation_solution);</div>
<div class="line">    saturation_soltrans.interpolate(x_saturation, tmp_saturation);</div>
<div class="line"> </div>
<div class="line">    saturation_solution                              = tmp_saturation[0];</div>
<div class="line">    old_saturation_solution                          = tmp_saturation[1];</div>
<div class="line">    saturation_matching_last_computed_darcy_solution = tmp_saturation[2];</div>
<div class="line"> </div>
<div class="line">    saturation_constraints.distribute(saturation_solution);</div>
<div class="line">    saturation_constraints.distribute(old_saturation_solution);</div>
<div class="line">    saturation_constraints.distribute(</div>
<div class="line">      saturation_matching_last_computed_darcy_solution);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; tmp_darcy(2);</div>
<div class="line">    tmp_darcy[0].reinit(darcy_solution);</div>
<div class="line">    tmp_darcy[1].reinit(darcy_solution);</div>
<div class="line">    darcy_soltrans.interpolate(x_darcy, tmp_darcy);</div>
<div class="line"> </div>
<div class="line">    last_computed_darcy_solution        = tmp_darcy[0];</div>
<div class="line">    second_last_computed_darcy_solution = tmp_darcy[1];</div>
<div class="line"> </div>
<div class="line">    darcy_constraints.distribute(last_computed_darcy_solution);</div>
<div class="line">    darcy_constraints.distribute(second_last_computed_darcy_solution);</div>
<div class="line"> </div>
<div class="line">    rebuild_saturation_matrix = <span class="keyword">true</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimoutput_results"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::output_results</h3>
<p>This function generates graphical output. It is in essence a copy of the implementation in <a class="el" href="step_31.html">step-31</a> .</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> joint_fe(darcy_fe, 1, saturation_fe, 1);</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>     joint_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">  joint_dof_handler.distribute_dofs(joint_fe);</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_dof_handler.n_dofs() ==</div>
<div class="line">           darcy_dof_handler.n_dofs() + saturation_dof_handler.n_dofs(),</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> joint_solution(joint_dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_joint_dof_indices(</div>
<div class="line">      joint_fe.n_dofs_per_cell());</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_darcy_dof_indices(</div>
<div class="line">      darcy_fe.n_dofs_per_cell());</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_saturation_dof_indices(</div>
<div class="line">      saturation_fe.n_dofs_per_cell());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       joint_cell      = joint_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> joint_endc      = joint_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       darcy_cell      = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; joint_cell != joint_endc;</div>
<div class="line">         ++joint_cell, ++darcy_cell, ++saturation_cell)</div>
<div class="line">      {</div>
<div class="line">        joint_cell-&gt;get_dof_indices(local_joint_dof_indices);</div>
<div class="line">        darcy_cell-&gt;get_dof_indices(local_darcy_dof_indices);</div>
<div class="line">        saturation_cell-&gt;get_dof_indices(local_saturation_dof_indices);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; joint_fe.n_dofs_per_cell(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 0)</div>
<div class="line">            {</div>
<div class="line">              <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                       local_darcy_dof_indices.size(),</div>
<div class="line">                     <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">              joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) = darcy_solution(</div>
<div class="line">                local_darcy_dof_indices[joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                                          .second]);</div>
<div class="line">            }</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">              <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 1,</div>
<div class="line">                     <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">              <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                       local_darcy_dof_indices.size(),</div>
<div class="line">                     <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">              joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) =</div>
<div class="line">                saturation_solution(</div>
<div class="line">                  local_saturation_dof_indices</div>
<div class="line">                    [joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second]);</div>
<div class="line">            }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">  std::vector&lt;std::string&gt; joint_solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  joint_solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line">  joint_solution_names.emplace_back(<span class="stringliteral">&quot;saturation&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    data_component_interpretation(</div>
<div class="line">      <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(joint_dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(joint_solution,</div>
<div class="line">                           joint_solution_names,</div>
<div class="line">                           <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                           data_component_interpretation);</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">  std::string filename =</div>
<div class="line">    <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 5) + <span class="stringliteral">&quot;.vtu&quot;</span>;</div>
<div class="line">  std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(filename);</div>
<div class="line">  data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Toolfunctions"></a> </p><h3>Tool functions</h3>
<pre class="fragment">&lt;a name="TwoPhaseFlowProblemdimdetermine_whether_to_solve_for_pressure_and_velocity"&gt;&lt;/a&gt;  &lt;h4&gt;TwoPhaseFlowProblem&lt;dim&gt;::determine_whether_to_solve_for_pressure_and_velocity&lt;/h4&gt;
</pre><p>This function implements the a posteriori criterion for adaptive operator splitting. The function is relatively straightforward given the way we have implemented other functions above and given the formula for the criterion derived in the paper. <br  />
 If one decides that one wants the original IMPES method in which the Darcy equation is solved in every time step, then this can be achieved by setting the threshold value <code>AOS_threshold</code> (with a default of \(5.0\) ) to zero, thereby forcing the function to always return true. <br  />
 Finally, note that the function returns true unconditionally for the first two time steps to ensure that we have always solved the Darcy system at least twice when skipping its solution, thereby allowing us to extrapolate the velocity from the last two solutions in <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code> .</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">bool</span> TwoPhaseFlowProblem&lt;</div>
<div class="line">     <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::determine_whether_to_solve_for_pressure_and_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keywordflow">if</span> (timestep_number &lt;= 2)</div>
<div class="line">       <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(saturation_degree + 2);</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(saturation_fe,</div>
<div class="line">                             quadrature_formula,</div>
<div class="line">                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;double&gt; old_saturation_after_solving_pressure(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; present_saturation(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  </div>
<div class="line">     std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordtype">double</span> max_global_aop_indicator = 0.0;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordtype">double</span> max_local_mobility_reciprocal_difference = 0.0;</div>
<div class="line">         <span class="keywordtype">double</span> max_local_permeability_inverse_l1_norm   = 0.0;</div>
<div class="line">  </div>
<div class="line">         fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">         fe_values.get_function_values(</div>
<div class="line">           saturation_matching_last_computed_darcy_solution,</div>
<div class="line">           old_saturation_after_solving_pressure);</div>
<div class="line">         fe_values.get_function_values(saturation_solution, present_saturation);</div>
<div class="line">  </div>
<div class="line">         k_inverse.value_list(fe_values.get_quadrature_points(),</div>
<div class="line">                              k_inverse_values);</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">           {</div>
<div class="line">             <span class="keyword">const</span> <span class="keywordtype">double</span> mobility_reciprocal_difference = <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(</div>
<div class="line">               <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(present_saturation[q], viscosity)</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">               <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_saturation_after_solving_pressure[q],</div>
<div class="line">                                viscosity));</div>
<div class="line">  </div>
<div class="line">             max_local_mobility_reciprocal_difference =</div>
<div class="line">               <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_mobility_reciprocal_difference,</div>
<div class="line">                        mobility_reciprocal_difference);</div>
<div class="line">  </div>
<div class="line">             max_local_permeability_inverse_l1_norm =</div>
<div class="line">               <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_permeability_inverse_l1_norm,</div>
<div class="line">                        <a class="code" href="classTensor.html#a93ba01d979880b278cd4b573dd9c653b">l1_norm</a>(k_inverse_values[q]));</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         max_global_aop_indicator =</div>
<div class="line">           <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_global_aop_indicator,</div>
<div class="line">                    (max_local_mobility_reciprocal_difference</div>
<div class="line">                     max_local_permeability_inverse_l1_norm));</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">return</span> (max_global_aop_indicator &gt; AOS_threshold);</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimproject_back_saturation"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::project_back_saturation</h4>
<p>The next function simply makes sure that the saturation values always remain within the physically reasonable range of \([0,1]\) . While the continuous equations guarantee that this is so, the discrete equations don't. However, if we allow the discrete solution to escape this range we get into trouble because terms like \(F(S)\) and \(F&#39;(S)\) will produce unreasonable results (e.g. \(F&#39;(S)&lt;0\) for \(S&lt;0\) , which would imply that the wetting fluid phase flows <em>against</em> the direction of the bulk fluid velocity)). Consequently, at the end of each time step, we simply project the saturation field back into the physically reasonable region.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> TwoPhaseFlowProblem&lt;dim&gt;::project_back_saturation()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; saturation_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">    <span class="keywordflow">if</span> (saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) &lt; 0.2)</div>
<div class="line">      saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0.2;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) &gt; 1)</div>
<div class="line">      saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimget_max_u_F_prime"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::get_max_u_F_prime</h4>
<p><br  />
 Another simpler helper function: Compute the maximum of the total velocity times the derivative of the fraction flow function, i.e., compute \(\|\mathbf{u} F&#39;(S)\|_{L_\infty(\Omega)}\) . This term is used in both the computation of the time step as well as in normalizing the entropy-residual term in the artificial viscosity.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> TwoPhaseFlowProblem&lt;dim&gt;::get_max_u_F_prime()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(darcy_degree + 2);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                     quadrature_formula,</div>
<div class="line">                                     <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">  std::vector&lt;Vector&lt;double&gt;&gt; darcy_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>,</div>
<div class="line">                                                    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">  std::vector&lt;double&gt;         saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> max_velocity_times_dF_dS = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">  <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line">  <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">    {</div>
<div class="line">      darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">      saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">      darcy_fe_values.get_function_values(darcy_solution,</div>
<div class="line">                                          darcy_solution_values);</div>
<div class="line">      saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                               saturation_values);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = darcy_solution_values[q](<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> dF_dS =</div>
<div class="line">            <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(saturation_values[q], viscosity);</div>
<div class="line"> </div>
<div class="line">          max_velocity_times_dF_dS =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_velocity_times_dF_dS, <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>.norm() dF_dS);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> max_velocity_times_dF_dS;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimget_extrapolated_saturation_range"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::get_extrapolated_saturation_range</h4>
<p><br  />
 For computing the stabilization term, we need to know the range of the saturation variable. Unlike in <a class="el" href="step_31.html">step-31</a> , this range is trivially bounded by the interval \([0,1]\) but we can do a bit better by looping over a collection of quadrature points and seeing what the values are there. If we can, i.e., if there are at least two timesteps around, we can even take the values extrapolated to the next time step. <br  />
 As before, the function is taken with minimal modifications from <a class="el" href="step_31.html">step-31</a> .</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   std::pair&lt;double, double&gt;</div>
<div class="line">   TwoPhaseFlowProblem&lt;dim&gt;::get_extrapolated_saturation_range()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(saturation_degree + 2);</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">  </div>
<div class="line">     <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(saturation_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">     std::vector&lt;double&gt; old_old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">       {</div>
<div class="line">         <span class="keywordtype">double</span> min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">                max_saturation =</div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">           {</div>
<div class="line">             fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">             fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                           old_saturation_values);</div>
<div class="line">             fe_values.get_function_values(old_old_saturation_solution,</div>
<div class="line">                                           old_old_saturation_values);</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">               {</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> saturation =</div>
<div class="line">                   (1. + time_step / old_time_step) old_saturation_values[q]</div>
<div class="line">  </div>
<div class="line">-</div>
<div class="line">                   time_step / old_time_step old_old_saturation_values[q];</div>
<div class="line">  </div>
<div class="line">                 min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_saturation, saturation);</div>
<div class="line">                 max_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_saturation, saturation);</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">return</span> std::make_pair(min_saturation, max_saturation);</div>
<div class="line">       }</div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">       {</div>
<div class="line">         <span class="keywordtype">double</span> min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">                max_saturation =</div>
<div class="line">  </div>
<div class="line">-<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">           {</div>
<div class="line">             fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">             fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                           old_saturation_values);</div>
<div class="line">  </div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">               {</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span> saturation = old_saturation_values[q];</div>
<div class="line">  </div>
<div class="line">                 min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_saturation, saturation);</div>
<div class="line">                 max_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_saturation, saturation);</div>
<div class="line">               }</div>
<div class="line">           }</div>
<div class="line">  </div>
<div class="line">         <span class="keywordflow">return</span> std::make_pair(min_saturation, max_saturation);</div>
<div class="line">       }</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimcompute_viscosity"></a> </p><h4>TwoPhaseFlowProblem&lt;dim&gt;::compute_viscosity</h4>
<p><br  />
 The final tool function is used to compute the artificial viscosity on a given cell. This isn't particularly complicated if you have the formula for it in front of you, and looking at the implementation in <a class="el" href="step_31.html">step-31</a> . The major difference to that tutorial program is that the velocity here is not simply \(\mathbf u\) but \(\mathbf u F&#39;(S)\) and some of the formulas need to be adjusted accordingly.</p>
<div class="fragment"><div class="line">   <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">   <span class="keywordtype">double</span> TwoPhaseFlowProblem&lt;dim&gt;::compute_viscosity(</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_saturation,</div>
<div class="line">     <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_saturation,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_saturation_grads,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_saturation_grads,</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;present_darcy_values,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_max_u_F_prime,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_S_variation,</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">   </span>{</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = .4 <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 1;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">if</span> (global_max_u_F_prime == 0)</div>
<div class="line">       <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 cell_diameter;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_saturation.size();</div>
<div class="line">  </div>
<div class="line">     <span class="keywordtype">double</span> max_residual             = 0;</div>
<div class="line">     <span class="keywordtype">double</span> max_velocity_times_dF_dS = 0;</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">bool</span> use_dF_dS = <span class="keyword">true</span>;</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">       {</div>
<div class="line">         <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u;</div>
<div class="line">         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">           u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_values[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> dS_dt = porosity</div>
<div class="line">                              (old_saturation[q]</div>
<div class="line">  </div>
<div class="line">- old_old_saturation[q]) /</div>
<div class="line">                              old_time_step;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> dF_dS = <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(</div>
<div class="line">           (old_saturation[q] + old_old_saturation[q]) / 2.0, viscosity);</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_S =</div>
<div class="line">           u dF_dS (old_saturation_grads[q] + old_old_saturation_grads[q]) /</div>
<div class="line">           2.0;</div>
<div class="line">  </div>
<div class="line">         <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> =</div>
<div class="line">           <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dS_dt + u_grad_S)</div>
<div class="line">                    std::pow((old_saturation[q] + old_old_saturation[q]) / 2,</div>
<div class="line">                             <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a></div>
<div class="line">  </div>
<div class="line">- 1.));</div>
<div class="line">  </div>
<div class="line">         max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">         max_velocity_times_dF_dS =</div>
<div class="line">           <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u u) (use_dF_dS ? <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(dF_dS, 1.) : 1),</div>
<div class="line">                    max_velocity_times_dF_dS);</div>
<div class="line">       }</div>
<div class="line">  </div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = 1.0;</div>
<div class="line">     <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R porosity</div>
<div class="line">                                   (global_max_u_F_prime)*global_S_variation /</div>
<div class="line">                                   <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(global_Omega_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a></div>
<div class="line">  </div>
<div class="line">- 2.);</div>
<div class="line">  </div>
<div class="line">     <span class="keywordflow">return</span> (<a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a></div>
<div class="line">             (max_velocity_times_dF_dS)*<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(cell_diameter,</div>
<div class="line">                                                 std::pow(cell_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>)</div>
<div class="line">                                                   max_residual /</div>
<div class="line">                                                   global_scaling));</div>
<div class="line">   }</div>
</div><!-- fragment --><p><a class="anchor" id="TwoPhaseFlowProblemdimrun"></a> </p><h3>TwoPhaseFlowProblem&lt;dim&gt;::run</h3>
<p>This function is, besides <code><a class="el" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve()</a></code> , the primary function of this program as it controls the time iteration as well as when the solution is written into output files and when to do mesh refinement. <br  />
 With the exception of the startup code that loops back to the beginning of the function through the <code>goto start_time_iteration</code> label, everything should be relatively straightforward. In any case, it mimics the corresponding function in <a class="el" href="step_31.html">step-31</a> .</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">TwoPhaseFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 5 : 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 3 : 2);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, 0, 1);</div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(initial_refinement);</div>
<div class="line">    global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">  start_time_iteration:</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(saturation_dof_handler,</div>
<div class="line">                         saturation_constraints,</div>
<div class="line">                         <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(saturation_degree + 2),</div>
<div class="line">                         SaturationInitialValues&lt;dim&gt;(),</div>
<div class="line">                         old_saturation_solution);</div>
<div class="line"> </div>
<div class="line">    time_step = old_time_step = 0;</div>
<div class="line">    current_macro_time_step = old_macro_time_step = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;, dt=&quot;</span> &lt;&lt; time_step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % 200 == 0)</div>
<div class="line">          output_results();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % 25 == 0)</div>
<div class="line">          refine_mesh(initial_refinement,</div>
<div class="line">                      initial_refinement + n_pre_refinement_steps);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; n_pre_refinement_steps))</div>
<div class="line">          {</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">        ++timestep_number;</div>
<div class="line"> </div>
<div class="line">        old_old_saturation_solution = old_saturation_solution;</div>
<div class="line">        old_saturation_solution     = saturation_solution;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &lt;= end_time);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step43</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code><a class="el" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></code> function</h3>
<p>The main function looks almost the same as in all other programs. The need to initialize the MPI subsystem for a program that uses Trilinos</p>
<ul>
<li>even for programs that do not actually run in parallel</li>
<li>is explained in <a class="el" href="step_31.html">step-31</a> .</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, charargv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep43.html">Step43</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
</div><!-- fragment --><p>This program can only be run in serial. Otherwise, throw an exception.</p>
<div class="fragment"><div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-43&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      TwoPhaseFlowProblem&lt;2&gt; two_phase_flow_problem(1);</div>
<div class="line">      two_phase_flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>The output of this program is not really much different from that of <a class="el" href="step_21.html">step-21</a> : it solves the same problem, after all. Of more importance arequantitative metrics such as the accuracy of the solution as well asthe time needed to compute it. These are documented in detail in thetwo publications listed at the top of this page and we won't repeatthem here. That said, no tutorial program is complete without a couple of goodpictures, so here is some output of a run in 3d: </p><table align="center" class="tutorial" cellspacing="3" cellpadding="3">
<tr>
<td align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-43.3d.velocity.png" alt="" class="inline"/> </p>
<p class="intertd">Velocity vectors of flow through the porous medium with random permeability model. Streaming paths of high permeability and resulting high velocity are clearly visible. </p>
<p class="endtd"></p>
</td><td align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-43.3d.streamlines.png" alt="" class="inline"/> </p>
<p class="intertd">Streamlines colored by the saturation along the streamline path. Blue streamlines indicate low saturations, i.e., the flow along these streamlines must be slow or else more fluid would have been transported along them. On the other hand, green paths indicate high velocities since the fluid front has already reached further into the domain. </p>
<p class="endtd"></p>
</td></tr>
<tr>
<td align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-43.3d.saturation.png" alt="" class="inline"/> </p>
<p class="intertd">Streamlines with a volume rendering of the saturation, showing how far the fluid front has advanced at this time. </p>
<p class="endtd"></p>
</td><td align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-43.3d.mesh.png" alt="" class="inline"/> </p>
<p class="intertd">Surface of the mesh showing the adaptive refinement along the front. </p>
<p class="endtd"></p>
</td></tr>
</table>
<p><br  />
</p>
<p><a class="anchor" id="extensions"></a><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p>The primary objection one may have to this program is that it is still tooslow: 3d computations on reasonably fine meshes are simply too expensive to bedone routinely and with reasonably quick turn-around. This is similar to thesituation we were in when we wrote <a class="el" href="step_31.html">step-31</a> , from which this program has takenmuch inspiration. The solution is similar as it was there as well: We need toparallelize the program in a way similar to how we derived <a class="el" href="step_32.html">step-32</a> out of <a class="el" href="step_31.html">step-31</a> . In fact, all of the techniques used in <a class="el" href="step_32.html">step-32</a> would be transferableto this program as well, making the program run on dozens or hundreds ofprocessors immediately. A different direction is to make the program more relevant to many otherporous media applications. Specifically, one avenue is to go to the primaryuser of porous media flow simulators, namely the oil industry. There,applications in this area are dominated by multiphase flow (i.e., more thanthe two phases we have here), and the reactions they may have with each other(or any other way phases may exchange mass, such as through dissolution in andbubbling out of gas from the oil phase). Furthermore, the presence of gasoften leads to compressibility effects of the fluid. Jointly, these effectsare typically formulated in the widely-used "black oil model". True reactionsbetween multiple phases also play a role in oil reservoir modeling whenconsidering controlled burns of oil in the reservoir to raise pressure andtemperature. These are much more complex problems, though, and left for futureprojects. Finally, from a mathematical perspective, we have derived thecriterion for re-computing the velocity/pressure solution at a giventime step under the assumption that we want to compare the solution wewould get at the current time step with that computed the last time weactually solved this system. However, in the program, whenever we didnot re-compute the solution, we didn't just use the previouslycomputed solution but instead extrapolated from the previous two timeswe solved the system. Consequently, the criterion was pessimisticallystated: what we should really compare is the solution we would get atthe current time step with the extrapolated one. Re-stating thetheorem in this regard is left as an exercise. There are also other ways to extend the mathematical foundation ofthis program; for example, one may say that it isn't the velocity wecare about, but in fact the saturation. Thus, one may ask whether thecriterion we use here to decide whether \(\mathbf u\) needs to berecomputed is appropriate; one may, for example, suggest that it isalso important to decide whether (and by how much) a wrong velocityfield in fact affects the solution of the saturation equation. Thiswould then naturally lead to a sensitivity analysis. From an algorithmic viewpoint, we have here used a criterion for refinementthat is often used in engineering, namely by looking at the gradient ofthe solution. However, if you inspect the solution, you will find thatit quickly leads to refinement almost everywhere, even in regions where itis clearly not necessary: frequently used therefore does not need to implythat it is a useful criterion to begin with. On the other hand, replacingthis criterion by a different and better one should not be very difficult.For example, the <a class="el" href="classKellyErrorEstimator.html">KellyErrorEstimator</a> class used in many other programsshould certainly be applicable to the current problem as well.</p>
<p><a class="anchor" id="PlainProg"></a></p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2010 - 2021 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Authors: Chih-Che Chueh, University of Victoria, 2010</span></div>
<div class="line"><span class="comment"> *          Wolfgang Bangerth, Texas A&amp;M University, 2010</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2tensor__function_8h.html">deal.II/base/tensor_function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="base_2index__set_8h.html">deal.II/base/index_set.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__gmres_8h.html">deal.II/lac/solver_gmres.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2block__sparsity__pattern_8h.html">deal.II/lac/block_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__renumbering_8h.html">deal.II/dofs/dof_renumbering.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__sparse__matrix_8h.html">deal.II/lac/trilinos_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__block__sparse__matrix_8h.html">deal.II/lac/trilinos_block_sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__vector_8h.html">deal.II/lac/trilinos_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__parallel__block__vector_8h.html">deal.II/lac/trilinos_parallel_block_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lac_2trilinos__precondition_8h.html">deal.II/lac/trilinos_precondition.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceStep43.html">Step43</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>PressureBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    PressureBoundaryValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span></div>
<div class="line">  <a class="code" href="classStep43_1_1PressureBoundaryValues.html#ada3b35b91f535c5145f28dd5c0a59e1a">PressureBoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> 1 - <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>SaturationBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SaturationBoundaryValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span></div>
<div class="line">  <a class="code" href="classStep43_1_1SaturationBoundaryValues.html#a62e536e852f9b21701278273bb88f683">SaturationBoundaryValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>[0] == 0)</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>SaturationInitialValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SaturationInitialValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(1)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a> = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span></div>
<div class="line">  <a class="code" href="classStep43_1_1SaturationInitialValues.html#ac8b238d242b0856ec23f7b63ff7c014e">SaturationInitialValues&lt;dim&gt;::value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> 0.2;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep43_1_1SaturationInitialValues.html#a523c8f9b3196dc1351e85af03e8ba1ad">SaturationInitialValues&lt;dim&gt;::vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>,</div>
<div class="line">                                                  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; this-&gt;<a class="code" href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a>; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>(c) = <a class="code" href="classStep43_1_1SaturationInitialValues.html#ac8b238d242b0856ec23f7b63ff7c014e">SaturationInitialValues&lt;dim&gt;::value</a>(<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>, <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>SingleCurvingCrack</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>KInverse : <span class="keyword">public</span> <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      KInverse()</div>
<div class="line">        : <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;()</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span></div>
<div class="line">      <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                 <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>) <span class="keyword">const override</span>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">KInverse&lt;dim&gt;::value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                                   <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size() == <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size(),</div>
<div class="line">             <a class="code" href="group__Exceptions.html#ga6060b2304b8600f5efa0d31eeda0207d">ExcDimensionMismatch</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(), <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size()));</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].clear();</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> distance_to_flowline =</div>
<div class="line">            <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][1] - 0.5 - 0.1 * <a class="code" href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">std::sin</a>(10 * <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][0]));</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> permeability =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(std::exp(-(distance_to_flowline * distance_to_flowline) /</div>
<div class="line">                              (0.1 * 0.1)),</div>
<div class="line">                     0.01);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = 1. / permeability;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  } <span class="comment">// namespace SingleCurvingCrack</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>RandomMedium</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keyword">class </span>KInverse : <span class="keyword">public</span> <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, dim&gt;</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      KInverse()</div>
<div class="line">        : <a class="code" href="classTensorFunction.html">TensorFunction</a>&lt;2, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;()</div>
<div class="line">      {}</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">virtual</span> <span class="keywordtype">void</span></div>
<div class="line">      <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                 <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">static</span> std::vector&lt;Point&lt;dim&gt;&gt; centers;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    std::vector&lt;Point&lt;dim&gt;&gt; KInverse&lt;dim&gt;::centers = []() {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a> =</div>
<div class="line">        (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 40 : (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 3 ? 100 : <span class="keywordflow">throw</span> <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>()));</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;Point&lt;dim&gt;&gt; centers_list(<a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a>);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">N</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          centers_list[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(<a class="code" href="base_2utilities__0_8txt.html#abdaf96304944a8787ae4488ed5461fac">rand</a>()) / RAND_MAX;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> centers_list;</div>
<div class="line">    }();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">KInverse&lt;dim&gt;::value_list</a>(<span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classPoint.html">Point&lt;dim&gt;</a>&gt; &amp;<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>,</div>
<div class="line">                                   <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a>&gt; &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(), <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>.size());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> = 0; <a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a> &lt; <a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>.size(); ++<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>].clear();</div>
<div class="line"> </div>
<div class="line">          <span class="keywordtype">double</span> permeability = 0;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; centers.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            permeability +=</div>
<div class="line">              std::exp(-(<a class="code" href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>] - centers[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]).norm_square() / (0.05 * 0.05));</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span> normalized_permeability =</div>
<div class="line">            <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(permeability, 0.01), 4.);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">values</a>[<a class="code" href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = 1. / normalized_permeability;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">  } <span class="comment">// namespace RandomMedium</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="namespaceStep43.html#abfa39791422beb7a56fabd07a254ca56">mobility_inverse</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span> 1.0 / (1.0 / viscosity * S * S + (1 - S) * (1 - S));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="namespaceStep43.html#aa9d1d2a552ddb355d5871cbafc33c050">fractional_flow</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((S &gt;= 0) &amp;&amp; (S &lt;= 1),</div>
<div class="line">           <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Saturation is outside its physically valid range.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> S * S / (S * S + viscosity * (1 - S) * (1 - S));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> S, <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>((S &gt;= 0) &amp;&amp; (S &lt;= 1),</div>
<div class="line">           <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<span class="stringliteral">&quot;Saturation is outside its physically valid range.&quot;</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> temp = (S * S + viscosity * (1 - S) * (1 - S));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> numerator =</div>
<div class="line">      2.0 * S * temp - S * S * (2.0 * S - 2.0 * viscosity * (1 - S));</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> denominator = <a class="code" href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a>(temp, 2.0);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> F_prime = numerator / denominator;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(F_prime &gt;= 0, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> F_prime;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">namespace </span>LinearSolvers</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    <span class="keyword">class </span>InverseMatrix : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      InverseMatrix(<span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">                    <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(VectorType &amp;<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, <span class="keyword">const</span> VectorType &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const MatrixType&gt;</a> <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerType &amp;           <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    InverseMatrix&lt;MatrixType, PreconditionerType&gt;::InverseMatrix(</div>
<div class="line">      <span class="keyword">const</span> MatrixType &amp;        <a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>,</div>
<div class="line">      <span class="keyword">const</span> PreconditionerType &amp;<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">      : <a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>(&amp;<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>)</div>
<div class="line">      , <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(<a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> MatrixType, <span class="keyword">class</span> PreconditionerType&gt;</div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> VectorType&gt;</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">InverseMatrix&lt;MatrixType, PreconditionerType&gt;::vmult</a>(</div>
<div class="line">      VectorType &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">      <span class="keyword">const</span> VectorType &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a>        solver_control(src.size(), 1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-7 * src.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;VectorType&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a> = 0;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">try</span></div>
<div class="line">        {</div>
<div class="line">          cg.solve(*<a class="code" href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a>, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>, src, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>.what()));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keyword">class </span>BlockSchurPreconditioner : <span class="keyword">public</span> <a class="code" href="classSubscriptor.html">Subscriptor</a></div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      BlockSchurPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">        <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                            PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">        <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">void</span> <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a>(<a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">                 <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">private</span>:</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer&lt;const TrilinosWrappers::BlockSparseMatrix&gt;</a></div>
<div class="line">        darcy_matrix;</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classSmartPointer.html">SmartPointer</a>&lt;<span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                             PreconditionerTypeMp&gt;&gt;</div>
<div class="line">                                 m_inverse;</div>
<div class="line">      <span class="keyword">const</span> PreconditionerTypeA &amp;a_preconditioner;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">mutable</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> tmp;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::</div>
<div class="line">      BlockSchurPreconditioner(</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> &amp;S,</div>
<div class="line">        <span class="keyword">const</span> InverseMatrix&lt;<a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                            PreconditionerTypeMp&gt; &amp;Mpinv,</div>
<div class="line">        <span class="keyword">const</span> PreconditionerTypeA &amp;                Apreconditioner)</div>
<div class="line">      : darcy_matrix(&amp;S)</div>
<div class="line">      , m_inverse(&amp;Mpinv)</div>
<div class="line">      , a_preconditioner(Apreconditioner)</div>
<div class="line">      , tmp(<a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(darcy_matrix-&gt;<a class="code" href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a>(1, 1).<a class="code" href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a>()))</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> PreconditionerTypeA, <span class="keyword">class</span> PreconditionerTypeMp&gt;</div>
<div class="line">    <span class="keywordtype">void</span></div>
<div class="line">    <a class="code" href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">BlockSchurPreconditioner&lt;PreconditionerTypeA, PreconditionerTypeMp&gt;::vmult</a>(</div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;      <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      a_preconditioner.<a class="code" href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">vmult</a>(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(0));</div>
<div class="line">      darcy_matrix-&gt;block(1, 0).residual(tmp, <a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(0), src.<a class="code" href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">block</a>(1));</div>
<div class="line">      tmp *= -1;</div>
<div class="line">      m_inverse-&gt;vmult(<a class="code" href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a>.block(1), tmp);</div>
<div class="line">    }</div>
<div class="line">  } <span class="comment">// namespace LinearSolvers</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span><a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem</a></div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>);</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_darcy_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span> build_darcy_preconditioner();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_darcy_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_matrix();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_rhs();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_rhs_cell_term(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       saturation_fe_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       darcy_fe_values,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_max_u_F_prime,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_S_variation,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">    <span class="keywordtype">void</span> assemble_saturation_rhs_boundary_term(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   saturation_fe_face_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   darcy_fe_face_values,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line">    <span class="keywordtype">void</span> refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line">    <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>                    get_max_u_F_prime() <span class="keyword">const</span>;</div>
<div class="line">    std::pair&lt;double, double&gt; get_extrapolated_saturation_range() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">bool</span>   determine_whether_to_solve_for_pressure_and_velocity() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span>   project_back_saturation();</div>
<div class="line">    <span class="keywordtype">double</span> compute_viscosity(</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_saturation,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_saturation,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_saturation_grads,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_saturation_grads,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;present_darcy_values,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_max_u_F_prime,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_S_variation,</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>;</div>
<div class="line">    <span class="keywordtype">double</span>             global_Omega_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        darcy_degree;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>             darcy_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           darcy_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> darcy_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> darcy_preconditioner_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> darcy_matrix;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a> darcy_preconditioner_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> darcy_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> darcy_rhs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> last_computed_darcy_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a> second_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        saturation_degree;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>                 saturation_fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           saturation_dof_handler;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> saturation_constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a> saturation_matrix;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> saturation_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_saturation_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> old_old_saturation_solution;</div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> saturation_rhs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div>
<div class="line">      saturation_matching_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> saturation_refinement_threshold;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>       <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> end_time;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> current_macro_time_step;</div>
<div class="line">    <span class="keywordtype">double</span> old_macro_time_step;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>       time_step;</div>
<div class="line">    <span class="keywordtype">double</span>       old_time_step;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> porosity;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> AOS_threshold;</div>
<div class="line"> </div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt; Amg_preconditioner;</div>
<div class="line">    std::shared_ptr&lt;TrilinosWrappers::PreconditionIC&gt; Mp_preconditioner;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> rebuild_saturation_matrix;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> RandomMedium::KInverse&lt;dim&gt; k_inverse;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::TwoPhaseFlowProblem</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    : <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::maximum_smoothing)</div>
<div class="line">    , global_Omega_diameter(std::numeric_limits&lt;<a class="code" href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a>&gt;::quiet_NaN())</div>
<div class="line">    , <a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    , darcy_degree(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a>)</div>
<div class="line">    , darcy_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(darcy_degree + 1), <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="classFE__Q.html">FE_Q</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;(darcy_degree), 1)</div>
<div class="line">    , darcy_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    saturation_degree(<a class="code" href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a> + 1)</div>
<div class="line">    , saturation_fe(saturation_degree)</div>
<div class="line">    , saturation_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    saturation_refinement_threshold(0.5)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>(0)</div>
<div class="line">    , end_time(10)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    current_macro_time_step(0)</div>
<div class="line">    , old_macro_time_step(0)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    time_step(0)</div>
<div class="line">    , old_time_step(0)</div>
<div class="line">    , timestep_number(0)</div>
<div class="line">    , viscosity(0.2)</div>
<div class="line">    , porosity(1.0)</div>
<div class="line">    , AOS_threshold(3.0)</div>
<div class="line">    ,</div>
<div class="line"> </div>
<div class="line">    rebuild_saturation_matrix(<a class="code" href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a>)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::setup_dofs</a>()</div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;unsigned int&gt; darcy_block_component(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, 0);</div>
<div class="line">    darcy_block_component[<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>] = 1;</div>
<div class="line">    {</div>
<div class="line">      darcy_dof_handler.distribute_dofs(darcy_fe);</div>
<div class="line">      <a class="code" href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a>(darcy_dof_handler);</div>
<div class="line">      <a class="code" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>(darcy_dof_handler, darcy_block_component);</div>
<div class="line"> </div>
<div class="line">      darcy_constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                              darcy_constraints);</div>
<div class="line">      darcy_constraints.close();</div>
<div class="line">    }</div>
<div class="line">    {</div>
<div class="line">      saturation_dof_handler.distribute_dofs(saturation_fe);</div>
<div class="line"> </div>
<div class="line">      saturation_constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(saturation_dof_handler,</div>
<div class="line">                                              saturation_constraints);</div>
<div class="line">      saturation_constraints.close();</div>
<div class="line">    }</div>
<div class="line">    {</div>
<div class="line">      darcy_preconditioner_constraints.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                              darcy_preconditioner_constraints);</div>
<div class="line">      <a class="code" href="group__constraints.html#ga06c0301bc74dd4c67a3d1db1000647f3">DoFTools::make_zero_boundary_constraints</a>(darcy_dof_handler,</div>
<div class="line">                                               darcy_preconditioner_constraints,</div>
<div class="line">                                               darcy_fe.component_mask(</div>
<div class="line">                                                 <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>));</div>
<div class="line"> </div>
<div class="line">      darcy_preconditioner_constraints.close();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; darcy_dofs_per_block =</div>
<div class="line">      <a class="code" href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a>(darcy_dof_handler,</div>
<div class="line">                                        darcy_block_component);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_u = darcy_dofs_per_block[0],</div>
<div class="line">                       n_p = darcy_dofs_per_block[1],</div>
<div class="line">                       n_s = saturation_dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; (on &quot;</span> &lt;&lt; <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_levels() &lt;&lt; <span class="stringliteral">&quot; levels)&quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; n_u + n_p + n_s &lt;&lt; <span class="stringliteral">&quot; (&quot;</span></div>
<div class="line">              &lt;&lt; n_u &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_p &lt;&lt; <span class="charliteral">&#39;+&#39;</span> &lt;&lt; n_s &lt;&lt; <span class="charliteral">&#39;)&#39;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      darcy_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_u);</div>
<div class="line">      dsp.block(0, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_p);</div>
<div class="line">      dsp.block(1, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_u);</div>
<div class="line">      dsp.block(1, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (!((<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> == <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>)))</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        darcy_dof_handler, coupling, dsp, darcy_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      darcy_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      Amg_preconditioner.reset();</div>
<div class="line">      Mp_preconditioner.reset();</div>
<div class="line">      darcy_preconditioner_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a> dsp(2, 2);</div>
<div class="line"> </div>
<div class="line">      dsp.block(0, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_u);</div>
<div class="line">      dsp.block(0, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_u, n_p);</div>
<div class="line">      dsp.block(1, 0).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_u);</div>
<div class="line">      dsp.block(1, 1).<a class="code" href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">reinit</a>(n_p, n_p);</div>
<div class="line"> </div>
<div class="line">      dsp.collect_sizes();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> coupling(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1, <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> = 0; <a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a> == <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a>;</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            coupling[<a class="code" href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a>][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(</div>
<div class="line">        darcy_dof_handler, coupling, dsp, darcy_constraints, <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">      darcy_preconditioner_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      saturation_matrix.clear();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_s, n_s);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(saturation_dof_handler,</div>
<div class="line">                                      dsp,</div>
<div class="line">                                      saturation_constraints,</div>
<div class="line">                                      <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      saturation_matrix.reinit(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;IndexSet&gt; darcy_partitioning(2);</div>
<div class="line">    darcy_partitioning[0] = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_u);</div>
<div class="line">    darcy_partitioning[1] = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_p);</div>
<div class="line">    darcy_solution.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    last_computed_darcy_solution.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    last_computed_darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    second_last_computed_darcy_solution.reinit(darcy_partitioning,</div>
<div class="line">                                               MPI_COMM_WORLD);</div>
<div class="line">    second_last_computed_darcy_solution.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    darcy_rhs.reinit(darcy_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    darcy_rhs.collect_sizes();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a> saturation_partitioning = <a class="code" href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a>(n_s);</div>
<div class="line">    saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">    old_old_saturation_solution.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    saturation_matching_last_computed_darcy_solution.reinit(</div>
<div class="line">      saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line"> </div>
<div class="line">    saturation_rhs.reinit(saturation_partitioning, MPI_COMM_WORLD);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_preconditioner</a>()</div>
<div class="line">  {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Rebuilding darcy preconditioner...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    darcy_preconditioner_matrix = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(darcy_degree + 2);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     darcy_fe_values(darcy_fe,</div>
<div class="line">                                  quadrature_formula,</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>     saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = darcy_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">      {</div>
<div class="line">        darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">        local_matrix = 0;</div>
<div class="line"> </div>
<div class="line">        saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                                 old_saturation_values);</div>
<div class="line"> </div>
<div class="line">        k_inverse.value_list(darcy_fe_values.get_quadrature_points(),</div>
<div class="line">                             k_inverse_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> old_s = old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> inverse_mobility = <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_s, viscosity);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> mobility         = 1.0 / inverse_mobility;</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;2, dim&gt;</a> permeability = <a class="code" href="base_2symmetric__tensor_8h.html#a3656e2f6095f612536b06139a6a2ca39">invert</a>(k_inverse_values[q]);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]      = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                grad_phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = darcy_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].gradient(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                {</div>
<div class="line">                  local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    (k_inverse_values[q] * inverse_mobility * phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] *</div>
<div class="line">                       phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] +</div>
<div class="line">                     permeability * mobility * grad_phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * grad_phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                    darcy_fe_values.JxW(q);</div>
<div class="line">                }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">        darcy_preconditioner_constraints.distribute_local_to_global(</div>
<div class="line">          local_matrix, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, darcy_preconditioner_matrix);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::build_darcy_preconditioner</a>()</div>
<div class="line">  {</div>
<div class="line">    assemble_darcy_preconditioner();</div>
<div class="line"> </div>
<div class="line">    Amg_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">    Amg_preconditioner-&gt;initialize(darcy_preconditioner_matrix.block(0, 0));</div>
<div class="line"> </div>
<div class="line">    Mp_preconditioner = std::make_shared&lt;TrilinosWrappers::PreconditionIC&gt;();</div>
<div class="line">    Mp_preconditioner-&gt;initialize(darcy_preconditioner_matrix.block(1, 1));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_darcy_system</a>()</div>
<div class="line">  {</div>
<div class="line">    darcy_matrix = 0;</div>
<div class="line">    darcy_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(darcy_degree + 2);</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(darcy_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe,</div>
<div class="line">                                  quadrature_formula,</div>
<div class="line">                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                    <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> darcy_fe_face_values(darcy_fe,</div>
<div class="line">                                           face_quadrature_formula,</div>
<div class="line">                                           <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                             <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = darcy_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>      = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points = face_quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a> pressure_right_hand_side;</div>
<div class="line">    <span class="keyword">const</span> PressureBoundaryValues&lt;dim&gt;  pressure_boundary_values;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         pressure_rhs_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         boundary_values(n_face_q_points);</div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;         div_phi_u(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    std::vector&lt;double&gt;         phi_p(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> <a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> <a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">      {</div>
<div class="line">        darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">        local_matrix = 0;</div>
<div class="line">        local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                                 old_saturation_values);</div>
<div class="line"> </div>
<div class="line">        pressure_right_hand_side.<a class="code" href="classFunctions_1_1ConstantFunction.html#a6a3224d6e805fa73629130e021a7285b">value_list</a>(</div>
<div class="line">          darcy_fe_values.get_quadrature_points(), pressure_rhs_values);</div>
<div class="line">        k_inverse.value_list(darcy_fe_values.get_quadrature_points(),</div>
<div class="line">                             k_inverse_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> = 0; <a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>)</div>
<div class="line">              {</div>
<div class="line">                phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                div_phi_u[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>] = darcy_fe_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].divergence(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">                phi_p[<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>]     = darcy_fe_values[<a class="code" href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a>].value(<a class="code" href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a>, q);</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> old_s = old_saturation_values[q];</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt;= <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                  {</div>
<div class="line">                    local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                      (phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * k_inverse_values[q] *</div>
<div class="line">                         <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_s, viscosity) * phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] -</div>
<div class="line">                       div_phi_u[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * phi_p[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>] - phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * div_phi_u[<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>]) *</div>
<div class="line">                      darcy_fe_values.JxW(q);</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                  (-phi_p[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] * pressure_rhs_values[q]) * darcy_fe_values.JxW(q);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">            {</div>
<div class="line">              darcy_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line"> </div>
<div class="line">              pressure_boundary_values.value_list(</div>
<div class="line">                darcy_fe_face_values.get_quadrature_points(), boundary_values);</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_q_points; ++q)</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> phi_i_u =</div>
<div class="line">                      darcy_fe_face_values[<a class="code" href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a>].value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line"> </div>
<div class="line">                    local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">                      -(phi_i_u * darcy_fe_face_values.normal_vector(q) *</div>
<div class="line">                        boundary_values[q] * darcy_fe_face_values.JxW(q));</div>
<div class="line">                  }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> + 1; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">            local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) = local_matrix(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        darcy_constraints.distribute_local_to_global(</div>
<div class="line">          local_matrix, local_rhs, <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>, darcy_matrix, darcy_rhs);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_system</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (rebuild_saturation_matrix == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        saturation_matrix = 0;</div>
<div class="line">        assemble_saturation_matrix();</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    saturation_rhs = 0;</div>
<div class="line">    assemble_saturation_rhs();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_matrix</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(saturation_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>, <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        local_matrix = 0;</div>
<div class="line">        local_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            {</div>
<div class="line">              <span class="keyword">const</span> <span class="keywordtype">double</span> phi_i_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> = 0; <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>)</div>
<div class="line">                {</div>
<div class="line">                  <span class="keyword">const</span> <span class="keywordtype">double</span> phi_j_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>, q);</div>
<div class="line">                  local_matrix(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, <a class="code" href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a>) +=</div>
<div class="line">                    porosity * phi_i_s * phi_j_s * saturation_fe_values.JxW(q);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        saturation_constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                                          <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                          saturation_matrix);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs</a>()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>     quadrature_formula(saturation_degree + 2);</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss</a>&lt;<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> - 1&gt; face_quadrature_formula(saturation_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                         <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> saturation_fe_face_values(saturation_fe,</div>
<div class="line">                                                face_quadrature_formula,</div>
<div class="line">                                                <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> |</div>
<div class="line">                                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                                  <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> darcy_fe_face_values(darcy_fe,</div>
<div class="line">                                           face_quadrature_formula,</div>
<div class="line">                                           <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> saturation_fe_face_values_neighbor(</div>
<div class="line">      saturation_fe, face_quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> =</div>
<div class="line">      saturation_dof_handler.<a class="code" href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">get_fe</a>().n_dofs_per_cell();</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                    global_max_u_F_prime = get_max_u_F_prime();</div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;double, double&gt; global_S_range =</div>
<div class="line">      get_extrapolated_saturation_range();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> global_S_variation =</div>
<div class="line">      global_S_range.second - global_S_range.first;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>       = saturation_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc       = saturation_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       darcy_cell = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++darcy_cell)</div>
<div class="line">      {</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(darcy_cell);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;get_dof_indices(<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        assemble_saturation_rhs_cell_term(saturation_fe_values,</div>
<div class="line">                                          darcy_fe_values,</div>
<div class="line">                                          global_max_u_F_prime,</div>
<div class="line">                                          global_S_variation,</div>
<div class="line">                                          <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a> : <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;face_iterators())</div>
<div class="line">          <span class="keywordflow">if</span> (<a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>-&gt;at_boundary())</div>
<div class="line">            {</div>
<div class="line">              darcy_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(darcy_cell, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">              saturation_fe_face_values.<a class="code" href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, <a class="code" href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a>);</div>
<div class="line">              assemble_saturation_rhs_boundary_term(saturation_fe_face_values,</div>
<div class="line">                                                    darcy_fe_face_values,</div>
<div class="line">                                                    <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>);</div>
<div class="line">            }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_cell_term</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       saturation_fe_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;                       darcy_fe_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_max_u_F_prime,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                                global_S_variation,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe_values.dofs_per_cell;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>    = saturation_fe_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt;         old_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt;         old_old_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_grad_saturation_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; old_old_grad_saturation_solution_values(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; present_darcy_solution_values(</div>
<div class="line">      <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line"> </div>
<div class="line">    saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                             old_saturation_solution_values);</div>
<div class="line">    saturation_fe_values.get_function_values(</div>
<div class="line">      old_old_saturation_solution, old_old_saturation_solution_values);</div>
<div class="line">    saturation_fe_values.get_function_gradients(</div>
<div class="line">      old_saturation_solution, old_grad_saturation_solution_values);</div>
<div class="line">    saturation_fe_values.get_function_gradients(</div>
<div class="line">      old_old_saturation_solution, old_old_grad_saturation_solution_values);</div>
<div class="line">    darcy_fe_values.get_function_values(darcy_solution,</div>
<div class="line">                                        present_darcy_solution_values);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> nu =</div>
<div class="line">      compute_viscosity(old_saturation_solution_values,</div>
<div class="line">                        old_old_saturation_solution_values,</div>
<div class="line">                        old_grad_saturation_solution_values,</div>
<div class="line">                        old_old_grad_saturation_solution_values,</div>
<div class="line">                        present_darcy_solution_values,</div>
<div class="line">                        global_max_u_F_prime,</div>
<div class="line">                        global_S_variation,</div>
<div class="line">                        saturation_fe_values.get_cell()-&gt;diameter());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span>   old_s = old_saturation_solution_values[q];</div>
<div class="line">          <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> present_u;</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">            present_u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_solution_values[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">double</span>         phi_i_s = saturation_fe_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> grad_phi_i_s =</div>
<div class="line">            saturation_fe_values.shape_grad(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q);</div>
<div class="line"> </div>
<div class="line">          local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) +=</div>
<div class="line">            (time_step * <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>(old_s, viscosity) * present_u *</div>
<div class="line">               grad_phi_i_s -</div>
<div class="line">             time_step * nu * old_grad_saturation_solution_values[q] *</div>
<div class="line">               grad_phi_i_s +</div>
<div class="line">             porosity * old_s * phi_i_s) *</div>
<div class="line">            saturation_fe_values.JxW(q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    saturation_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                      <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                      saturation_rhs);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::assemble_saturation_rhs_boundary_term</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   saturation_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a> &amp;                   darcy_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;types::global_dof_index&gt; &amp;<a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>)</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a> = saturation_fe_face_values.dofs_per_cell;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_q_points =</div>
<div class="line">      saturation_fe_face_values.n_quadrature_points;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> local_rhs(<a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_saturation_solution_values_face(n_face_q_points);</div>
<div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; present_darcy_solution_values_face(</div>
<div class="line">      n_face_q_points, <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">    std::vector&lt;double&gt; neighbor_saturation(n_face_q_points);</div>
<div class="line"> </div>
<div class="line">    saturation_fe_face_values.get_function_values(</div>
<div class="line">      old_saturation_solution, old_saturation_solution_values_face);</div>
<div class="line">    darcy_fe_face_values.get_function_values(</div>
<div class="line">      darcy_solution, present_darcy_solution_values_face);</div>
<div class="line"> </div>
<div class="line">    SaturationBoundaryValues&lt;dim&gt; saturation_boundary_values;</div>
<div class="line">    saturation_boundary_values.value_list(</div>
<div class="line">      saturation_fe_face_values.get_quadrature_points(), neighbor_saturation);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_q_points; ++q)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> present_u_face;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          present_u_face[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_solution_values_face[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> normal_flux =</div>
<div class="line">          present_u_face * saturation_fe_face_values.normal_vector(q);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> is_outflow_q_point = (normal_flux &gt;= 0);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">          local_rhs(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) -=</div>
<div class="line">            time_step * normal_flux *</div>
<div class="line">            <a class="code" href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">fractional_flow</a>((is_outflow_q_point == <span class="keyword">true</span> ?</div>
<div class="line">                               old_saturation_solution_values_face[q] :</div>
<div class="line">                               neighbor_saturation[q]),</div>
<div class="line">                            viscosity) *</div>
<div class="line">            saturation_fe_face_values.shape_value(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>, q) *</div>
<div class="line">            saturation_fe_face_values.JxW(q);</div>
<div class="line">      }</div>
<div class="line">    saturation_constraints.distribute_local_to_global(local_rhs,</div>
<div class="line">                                                      <a class="code" href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a>,</div>
<div class="line">                                                      saturation_rhs);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">TwoPhaseFlowProblem&lt;dim&gt;::solve</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> solve_for_pressure_and_velocity =</div>
<div class="line">      determine_whether_to_solve_for_pressure_and_velocity();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (solve_for_pressure_and_velocity == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving Darcy (pressure-velocity) system...&quot;</span></div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_darcy_system();</div>
<div class="line">        build_darcy_preconditioner();</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> LinearSolvers::InverseMatrix&lt;<a class="code" href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">TrilinosWrappers::SparseMatrix</a>,</div>
<div class="line">                                             <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">            mp_inverse(darcy_preconditioner_matrix.block(1, 1),</div>
<div class="line">                       *Mp_preconditioner);</div>
<div class="line"> </div>
<div class="line">          <span class="keyword">const</span> LinearSolvers::BlockSchurPreconditioner&lt;</div>
<div class="line">            <a class="code" href="namespaceLinearAlgebraPETSc_1_1MPI.html#a2a3c696b5297cb04d9a7137121aba8b7">TrilinosWrappers::PreconditionIC</a>,</div>
<div class="line">            <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a>&gt;</div>
<div class="line">            <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>(darcy_matrix, mp_inverse, *Amg_preconditioner);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(darcy_matrix.m(),</div>
<div class="line">                                       1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-16 * darcy_rhs.l2_norm());</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="classSolverGMRES.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;</a> gmres(</div>
<div class="line">            solver_control,</div>
<div class="line">            <a class="code" href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES&lt;TrilinosWrappers::MPI::BlockVector&gt;::AdditionalData</a>(</div>
<div class="line">              100));</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; darcy_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">if</span> (darcy_constraints.is_constrained(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>))</div>
<div class="line">              darcy_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0;</div>
<div class="line"> </div>
<div class="line">          gmres.solve(darcy_matrix, darcy_solution, darcy_rhs, <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">          darcy_constraints.distribute(darcy_solution);</div>
<div class="line"> </div>
<div class="line">          std::cout &lt;&lt; <span class="stringliteral">&quot;        ...&quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                    &lt;&lt; <span class="stringliteral">&quot; GMRES iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">          second_last_computed_darcy_solution = last_computed_darcy_solution;</div>
<div class="line">          last_computed_darcy_solution        = darcy_solution;</div>
<div class="line"> </div>
<div class="line">          saturation_matching_last_computed_darcy_solution =</div>
<div class="line">            saturation_solution;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        darcy_solution = last_computed_darcy_solution;</div>
<div class="line">        darcy_solution.sadd(1 + current_macro_time_step / old_macro_time_step,</div>
<div class="line">                            -current_macro_time_step / old_macro_time_step,</div>
<div class="line">                            second_last_computed_darcy_solution);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      old_time_step = time_step;</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> max_u_F_prime = get_max_u_F_prime();</div>
<div class="line">      <span class="keywordflow">if</span> (max_u_F_prime &gt; 0)</div>
<div class="line">        time_step = porosity * <a class="code" href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>) /</div>
<div class="line">                    saturation_degree / max_u_F_prime / 50;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        time_step = end_time - <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (solve_for_pressure_and_velocity == <span class="keyword">true</span>)</div>
<div class="line">      {</div>
<div class="line">        old_macro_time_step     = current_macro_time_step;</div>
<div class="line">        current_macro_time_step = time_step;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      current_macro_time_step += time_step;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving saturation transport equation...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      assemble_saturation_system();</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(saturation_matrix.m(),</div>
<div class="line">                                   1<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-16 * saturation_rhs.l2_norm());</div>
<div class="line">      <a class="code" href="classSolverCG.html">SolverCG&lt;TrilinosWrappers::MPI::Vector&gt;</a> cg(solver_control);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a> <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>;</div>
<div class="line">      <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>.initialize(saturation_matrix);</div>
<div class="line"> </div>
<div class="line">      cg.solve(saturation_matrix,</div>
<div class="line">               saturation_solution,</div>
<div class="line">               saturation_rhs,</div>
<div class="line">               <a class="code" href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a>);</div>
<div class="line"> </div>
<div class="line">      saturation_constraints.distribute(saturation_solution);</div>
<div class="line">      project_back_saturation();</div>
<div class="line"> </div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;        ...&quot;</span> &lt;&lt; solver_control.last_step()</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::refine_mesh</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> refinement_indicators(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.n_active_cells());</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classQMidpoint.html">QMidpoint&lt;dim&gt;</a>        quadrature_formula;</div>
<div class="line">      <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a>               fe_values(saturation_fe,</div>
<div class="line">                              quadrature_formula,</div>
<div class="line">                              <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line">      std::vector&lt;Tensor&lt;1, dim&gt;&gt; grad_saturation(1);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a> extrapolated_saturation_solution(</div>
<div class="line">        saturation_solution);</div>
<div class="line">      <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">        extrapolated_saturation_solution.sadd((1. + time_step / old_time_step),</div>
<div class="line">                                              time_step / old_time_step,</div>
<div class="line">                                              old_saturation_solution);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_no = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">          fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">          fe_values.get_function_gradients(extrapolated_saturation_solution,</div>
<div class="line">                                           grad_saturation);</div>
<div class="line"> </div>
<div class="line">          refinement_indicators(cell_no) = grad_saturation[0].norm();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell_no = <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;active_cell_index();</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_coarsen_flag();</div>
<div class="line">          <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;clear_refine_flag();</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> ((<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level()) &lt; max_grid_level) &amp;&amp;</div>
<div class="line">              (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(refinement_indicators(cell_no)) &gt;</div>
<div class="line">               saturation_refinement_threshold))</div>
<div class="line">            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;set_refine_flag();</div>
<div class="line">          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;level()) &gt;</div>
<div class="line">                    min_grid_level) &amp;&amp;</div>
<div class="line">                   (<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(refinement_indicators(cell_no)) &lt;</div>
<div class="line">                    0.5 * saturation_refinement_threshold))</div>
<div class="line">            <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>-&gt;set_coarsen_flag();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      std::vector&lt;TrilinosWrappers::MPI::Vector&gt; x_saturation(3);</div>
<div class="line">      x_saturation[0] = saturation_solution;</div>
<div class="line">      x_saturation[1] = old_saturation_solution;</div>
<div class="line">      x_saturation[2] = saturation_matching_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; x_darcy(2);</div>
<div class="line">      x_darcy[0] = last_computed_darcy_solution;</div>
<div class="line">      x_darcy[1] = second_last_computed_darcy_solution;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::Vector&gt;</a> saturation_soltrans(</div>
<div class="line">        saturation_dof_handler);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim, TrilinosWrappers::MPI::BlockVector&gt;</a> darcy_soltrans(</div>
<div class="line">        darcy_dof_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">      saturation_soltrans.prepare_for_coarsening_and_refinement(x_saturation);</div>
<div class="line"> </div>
<div class="line">      darcy_soltrans.prepare_for_coarsening_and_refinement(x_darcy);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">      setup_dofs();</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;TrilinosWrappers::MPI::Vector&gt; tmp_saturation(3);</div>
<div class="line">      tmp_saturation[0].reinit(saturation_solution);</div>
<div class="line">      tmp_saturation[1].reinit(saturation_solution);</div>
<div class="line">      tmp_saturation[2].reinit(saturation_solution);</div>
<div class="line">      saturation_soltrans.interpolate(x_saturation, tmp_saturation);</div>
<div class="line"> </div>
<div class="line">      saturation_solution                              = tmp_saturation[0];</div>
<div class="line">      old_saturation_solution                          = tmp_saturation[1];</div>
<div class="line">      saturation_matching_last_computed_darcy_solution = tmp_saturation[2];</div>
<div class="line"> </div>
<div class="line">      saturation_constraints.distribute(saturation_solution);</div>
<div class="line">      saturation_constraints.distribute(old_saturation_solution);</div>
<div class="line">      saturation_constraints.distribute(</div>
<div class="line">        saturation_matching_last_computed_darcy_solution);</div>
<div class="line"> </div>
<div class="line">      std::vector&lt;TrilinosWrappers::MPI::BlockVector&gt; tmp_darcy(2);</div>
<div class="line">      tmp_darcy[0].reinit(darcy_solution);</div>
<div class="line">      tmp_darcy[1].reinit(darcy_solution);</div>
<div class="line">      darcy_soltrans.interpolate(x_darcy, tmp_darcy);</div>
<div class="line"> </div>
<div class="line">      last_computed_darcy_solution        = tmp_darcy[0];</div>
<div class="line">      second_last_computed_darcy_solution = tmp_darcy[1];</div>
<div class="line"> </div>
<div class="line">      darcy_constraints.distribute(last_computed_darcy_solution);</div>
<div class="line">      darcy_constraints.distribute(second_last_computed_darcy_solution);</div>
<div class="line"> </div>
<div class="line">      rebuild_saturation_matrix = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::output_results</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> joint_fe(darcy_fe, 1, saturation_fe, 1);</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>     joint_dof_handler(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line">    joint_dof_handler.distribute_dofs(joint_fe);</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_dof_handler.n_dofs() ==</div>
<div class="line">             darcy_dof_handler.n_dofs() + saturation_dof_handler.n_dofs(),</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> joint_solution(joint_dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_joint_dof_indices(</div>
<div class="line">        joint_fe.n_dofs_per_cell());</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_darcy_dof_indices(</div>
<div class="line">        darcy_fe.n_dofs_per_cell());</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_saturation_dof_indices(</div>
<div class="line">        saturation_fe.n_dofs_per_cell());</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">auto</span>       joint_cell      = joint_dof_handler.begin_active();</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">auto</span> joint_endc      = joint_dof_handler.end();</div>
<div class="line">      <span class="keyword">auto</span>       darcy_cell      = darcy_dof_handler.begin_active();</div>
<div class="line">      <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (; joint_cell != joint_endc;</div>
<div class="line">           ++joint_cell, ++darcy_cell, ++saturation_cell)</div>
<div class="line">        {</div>
<div class="line">          joint_cell-&gt;get_dof_indices(local_joint_dof_indices);</div>
<div class="line">          darcy_cell-&gt;get_dof_indices(local_darcy_dof_indices);</div>
<div class="line">          saturation_cell-&gt;get_dof_indices(local_saturation_dof_indices);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; joint_fe.n_dofs_per_cell(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">            <span class="keywordflow">if</span> (joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 0)</div>
<div class="line">              {</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                         local_darcy_dof_indices.size(),</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) = darcy_solution(</div>
<div class="line">                  local_darcy_dof_indices[joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">                                            .second]);</div>
<div class="line">              }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">              {</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).first.first == 1,</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second &lt;</div>
<div class="line">                         local_darcy_dof_indices.size(),</div>
<div class="line">                       <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">                joint_solution(local_joint_dof_indices[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>]) =</div>
<div class="line">                  saturation_solution(</div>
<div class="line">                    local_saturation_dof_indices</div>
<div class="line">                      [joint_fe.system_to_base_index(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>).second]);</div>
<div class="line">              }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    std::vector&lt;std::string&gt; joint_solution_names(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">    joint_solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line">    joint_solution_names.emplace_back(<span class="stringliteral">&quot;saturation&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      data_component_interpretation(</div>
<div class="line">        <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">attach_dof_handler</a>(joint_dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">add_data_vector</a>(joint_solution,</div>
<div class="line">                             joint_solution_names,</div>
<div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                             data_component_interpretation);</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::string filename =</div>
<div class="line">      <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 5) + <span class="stringliteral">&quot;.vtu&quot;</span>;</div>
<div class="line">    std::ofstream <a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>(filename);</div>
<div class="line">    data_out.<a class="code" href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(<a class="code" href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">bool</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem</a>&lt;</div>
<div class="line">    <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>&gt;::determine_whether_to_solve_for_pressure_and_velocity()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number &lt;= 2)</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(saturation_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(saturation_fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; old_saturation_after_solving_pressure(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; present_saturation(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; k_inverse_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_global_aop_indicator = 0.0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> max_local_mobility_reciprocal_difference = 0.0;</div>
<div class="line">        <span class="keywordtype">double</span> max_local_permeability_inverse_l1_norm   = 0.0;</div>
<div class="line"> </div>
<div class="line">        fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        fe_values.get_function_values(</div>
<div class="line">          saturation_matching_last_computed_darcy_solution,</div>
<div class="line">          old_saturation_after_solving_pressure);</div>
<div class="line">        fe_values.get_function_values(saturation_solution, present_saturation);</div>
<div class="line"> </div>
<div class="line">        k_inverse.value_list(fe_values.get_quadrature_points(),</div>
<div class="line">                             k_inverse_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> mobility_reciprocal_difference = <a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(</div>
<div class="line">              <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(present_saturation[q], viscosity) -</div>
<div class="line">              <a class="code" href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">mobility_inverse</a>(old_saturation_after_solving_pressure[q],</div>
<div class="line">                               viscosity));</div>
<div class="line"> </div>
<div class="line">            max_local_mobility_reciprocal_difference =</div>
<div class="line">              <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_mobility_reciprocal_difference,</div>
<div class="line">                       mobility_reciprocal_difference);</div>
<div class="line"> </div>
<div class="line">            max_local_permeability_inverse_l1_norm =</div>
<div class="line">              <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_local_permeability_inverse_l1_norm,</div>
<div class="line">                       <a class="code" href="base_2tensor_8h.html#a93ba01d979880b278cd4b573dd9c653b">l1_norm</a>(k_inverse_values[q]));</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        max_global_aop_indicator =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_global_aop_indicator,</div>
<div class="line">                   (max_local_mobility_reciprocal_difference *</div>
<div class="line">                    max_local_permeability_inverse_l1_norm));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (max_global_aop_indicator &gt; AOS_threshold);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::project_back_saturation</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; saturation_solution.size(); ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">      <span class="keywordflow">if</span> (saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) &lt; 0.2)</div>
<div class="line">        saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 0.2;</div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) &gt; 1)</div>
<div class="line">        saturation_solution(<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>) = 1;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::get_max_u_F_prime</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(darcy_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> darcy_fe_values(darcy_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> saturation_fe_values(saturation_fe,</div>
<div class="line">                                       quadrature_formula,</div>
<div class="line">                                       <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Vector&lt;double&gt;&gt; darcy_solution_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>,</div>
<div class="line">                                                      <a class="code" href="classVector.html">Vector&lt;double&gt;</a>(<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> + 1));</div>
<div class="line">    std::vector&lt;double&gt;         saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_velocity_times_dF_dS = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">auto</span>       <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>            = darcy_dof_handler.begin_active();</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> endc            = darcy_dof_handler.end();</div>
<div class="line">    <span class="keyword">auto</span>       saturation_cell = saturation_dof_handler.begin_active();</div>
<div class="line">    <span class="keywordflow">for</span> (; <a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> != endc; ++<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>, ++saturation_cell)</div>
<div class="line">      {</div>
<div class="line">        darcy_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">        saturation_fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(saturation_cell);</div>
<div class="line"> </div>
<div class="line">        darcy_fe_values.get_function_values(darcy_solution,</div>
<div class="line">                                            darcy_solution_values);</div>
<div class="line">        saturation_fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                                 saturation_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">          {</div>
<div class="line">            <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> = 0; <a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>)</div>
<div class="line">              <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>[<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>] = darcy_solution_values[q](<a class="code" href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a>);</div>
<div class="line"> </div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> dF_dS =</div>
<div class="line">              <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(saturation_values[q], viscosity);</div>
<div class="line"> </div>
<div class="line">            max_velocity_times_dF_dS =</div>
<div class="line">              <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_velocity_times_dF_dS, <a class="code" href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a>.norm() * dF_dS);</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> max_velocity_times_dF_dS;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  std::pair&lt;double, double&gt;</div>
<div class="line">  <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::get_extrapolated_saturation_range</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(saturation_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = quadrature_formula.<a class="code" href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">size</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(saturation_fe, quadrature_formula, <a class="code" href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line">    std::vector&lt;double&gt; old_old_saturation_values(<a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (timestep_number != 0)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">               max_saturation = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                          old_saturation_values);</div>
<div class="line">            fe_values.get_function_values(old_old_saturation_solution,</div>
<div class="line">                                          old_old_saturation_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> saturation =</div>
<div class="line">                  (1. + time_step / old_time_step) * old_saturation_values[q] -</div>
<div class="line">                  time_step / old_time_step * old_old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">                min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_saturation, saturation);</div>
<div class="line">                max_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_saturation, saturation);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> std::make_pair(min_saturation, max_saturation);</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">        <span class="keywordtype">double</span> min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">               max_saturation = -<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::numeric_limits&lt;double&gt;::max</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a> : saturation_dof_handler.active_cell_iterators())</div>
<div class="line">          {</div>
<div class="line">            fe_values.<a class="code" href="classFEValues.html#a21f914e63d588e2652a9514620653d77">reinit</a>(<a class="code" href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a>);</div>
<div class="line">            fe_values.get_function_values(old_saturation_solution,</div>
<div class="line">                                          old_saturation_values);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">double</span> saturation = old_saturation_values[q];</div>
<div class="line"> </div>
<div class="line">                min_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(min_saturation, saturation);</div>
<div class="line">                max_saturation = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(max_saturation, saturation);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> std::make_pair(min_saturation, max_saturation);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;dim&gt;::compute_viscosity</a>(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_saturation,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;double&gt; &amp;        old_old_saturation,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_saturation_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;old_old_saturation_grads,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">std::vector</a>&lt;<a class="code" href="classVector.html">Vector&lt;double&gt;</a>&gt; &amp;present_darcy_values,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_max_u_F_prime,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       global_S_variation,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                       cell_diameter)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a>  = .4 * <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (global_max_u_F_prime == 0)</div>
<div class="line">      <span class="keywordflow">return</span> 5<a class="code" href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a>-3 * cell_diameter;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a> = old_saturation.size();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> max_residual             = 0;</div>
<div class="line">    <span class="keywordtype">double</span> max_velocity_times_dF_dS = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> use_dF_dS = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; <a class="code" href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> u;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a> &lt; <a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a>; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>)</div>
<div class="line">          u[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>] = present_darcy_values[q](<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">d</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dS_dt = porosity *</div>
<div class="line">                             (old_saturation[q] - old_old_saturation[q]) /</div>
<div class="line">                             old_time_step;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dF_dS = <a class="code" href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">fractional_flow_derivative</a>(</div>
<div class="line">          (old_saturation[q] + old_old_saturation[q]) / 2.0, viscosity);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> u_grad_S =</div>
<div class="line">          u * dF_dS * (old_saturation_grads[q] + old_old_saturation_grads[q]) /</div>
<div class="line">          2.0;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a> =</div>
<div class="line">          <a class="code" href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a>((dS_dt + u_grad_S) *</div>
<div class="line">                   std::pow((old_saturation[q] + old_old_saturation[q]) / 2,</div>
<div class="line">                            <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 1.));</div>
<div class="line"> </div>
<div class="line">        max_residual = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a>, max_residual);</div>
<div class="line">        max_velocity_times_dF_dS =</div>
<div class="line">          <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(<a class="code" href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">std::sqrt</a>(u * u) * (use_dF_dS ? <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">std::max</a>(dF_dS, 1.) : 1),</div>
<div class="line">                   max_velocity_times_dF_dS);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> c_R            = 1.0;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> global_scaling = c_R * porosity *</div>
<div class="line">                                  (global_max_u_F_prime)*global_S_variation /</div>
<div class="line">                                  std::pow(global_Omega_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a> - 2.);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> (<a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">beta</a> *</div>
<div class="line">            (max_velocity_times_dF_dS)*<a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">std::min</a>(cell_diameter,</div>
<div class="line">                                                std::pow(cell_diameter, <a class="code" href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">alpha</a>) *</div>
<div class="line">                                                  max_residual /</div>
<div class="line">                                                  global_scaling));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">TwoPhaseFlowProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_refinement     = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 5 : 2);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_pre_refinement_steps = (<a class="code" href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a> == 2 ? 3 : 2);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>, 0, 1);</div>
<div class="line">    <a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>.refine_global(initial_refinement);</div>
<div class="line">    global_Omega_diameter = <a class="code" href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a>(<a class="code" href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a>);</div>
<div class="line"> </div>
<div class="line">    setup_dofs();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">  start_time_iteration:</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a>(saturation_dof_handler,</div>
<div class="line">                         saturation_constraints,</div>
<div class="line">                         <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(saturation_degree + 2),</div>
<div class="line">                         SaturationInitialValues&lt;dim&gt;(),</div>
<div class="line">                         old_saturation_solution);</div>
<div class="line"> </div>
<div class="line">    time_step = old_time_step = 0;</div>
<div class="line">    current_macro_time_step = old_macro_time_step = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Timestep &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot;:  t=&quot;</span> &lt;&lt; <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;, dt=&quot;</span> &lt;&lt; time_step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a>();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % 200 == 0)</div>
<div class="line">          output_results();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % 25 == 0)</div>
<div class="line">          refine_mesh(initial_refinement,</div>
<div class="line">                      initial_refinement + n_pre_refinement_steps);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number == 0) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; n_pre_refinement_steps))</div>
<div class="line">          {</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> += time_step;</div>
<div class="line">        ++timestep_number;</div>
<div class="line"> </div>
<div class="line">        old_old_saturation_solution = old_saturation_solution;</div>
<div class="line">        old_saturation_solution     = saturation_solution;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">while</span> (<a class="code" href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a> &lt;= end_time);</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step43</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespaceStep43.html">Step43</a>;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">        argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a>(<a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) == 1,</div>
<div class="line">                  <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                    <span class="stringliteral">&quot;This program can only be run in serial, use ./step-43&quot;</span>));</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classStep21_1_1TwoPhaseFlowProblem.html">TwoPhaseFlowProblem&lt;2&gt;</a> two_phase_flow_problem(1);</div>
<div class="line">      two_phase_flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">std::exception</a> &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="asparse__vanka__0_8txt_html_a63f572a3b5d8c173a82cee16f5858977"><div class="ttname"><a href="sparse__vanka__0_8txt.html#a63f572a3b5d8c173a82cee16f5858977">dst</a></div><div class="ttdeci">this elimination is done by the modification of the right hand and in the end these degrees of freedom do not occur in the matrix and solution vector any more at all *This system is solved and the values are updated into the destination vector the matrices are built up such that the degree of freedom associated with the Lagrange multiplier is the first one usually the upper left entry in the matrix is zero It is not clear to so it must persist longer than the Vanka object The same is true for the matrix The matrix[2.x.11] which is passed here may or may not be the same matrix for which this object shall act as preconditioner In it is conceivable that the preconditioner is build up for one matrix but is used for subsequent steps in a nonlinear process as where the matrix changes in each step slightly **Destructor Delete all allocated matrices **Parameters for SparseVanka **Constructor For the parameters see below **Constructor For the parameters see below[2.x.12] The use of this constructor is deprecated **the second and third parameters are ignored **Indices of those degrees of freedom that we shall work on **If the default constructor is used then this function needs to be called before an object of this class is used as preconditioner For more detail about possible parameters see the class documentation and the documentation of the[2.x.13] class After this function is called the preconditioner is ready to be only values for allowed indices are written to[2.x.27] dst</div><div class="ttdef"><b>Definition:</b> <a href="sparse__vanka__0_8txt_source.html#l00060">sparse_vanka_0.txt:60</a></div></div>
<div class="ttc" id="apolynomial__0_8txt_html_af1258c87f1d73d29bd17331843ac1d25"><div class="ttname"><a href="polynomial__0_8txt.html#af1258c87f1d73d29bd17331843ac1d25">i</a></div><div class="ttdeci">namespace in which classes relating to the description of d polynomial spaces are declared ***Base class for all D polynomials A polynomial is represented in this class by its coefficients which are set through the constructor or by derived classes There are two paths for evaluation of polynomials One is based on the coefficients which are evaluated through the Horner scheme which is a robust general purpose scheme An alternative and more stable evaluation of high degree polynomials with roots in the unit interval is provided by a product in terms of the roots This form is available for special polynomials such as Lagrange polynomials or Legendre polynomials and used with the respective constructor To obtain this more stable evaluation form the constructor with the roots in form of a Lagrange polynomial must be used In case a manipulation is done that changes the roots the representation is switched to the coefficient form This class is a typical example of a possible template argument for the TensorProductPolynomials class **Constructor The coefficients of the polynomial are passed as and denote the i e the first element of the array denotes the constant the second the linear and so on The degree of the polynomial represented by this object is thus the number of elements in the&lt; tt &gt; coefficient&lt;/tt &gt; array minus one **Constructor creating a zero polynomial of degree *[2.x.3] *Constructor for a Lagrange polynomial and its point of evaluation The idea is to where j is the evaluation point specified as argument and the support points contain all the evaluation is based on products of the whereas the Horner scheme is used for polynomials in the coefficient form **Return the values and the derivatives of the Polynomial at point&lt; tt &gt; x&lt;/tt &gt;&lt; tt &gt; i</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__0_8txt_source.html#l00024">polynomial_0.txt:24</a></div></div>
<div class="ttc" id="alac_2solver__gmres_8h_html"><div class="ttname"><a href="lac_2solver__gmres_8h.html">solver_gmres.h</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a79cbe2f02f8dfb85026c71d783dbb703"><div class="ttname"><a href="classDataOut__DoFData.html#a79cbe2f02f8dfb85026c71d783dbb703">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out__dof__data_8h_source.html#l01096">data_out_dof_data.h:1096</a></div></div>
<div class="ttc" id="aclassIndexSet_html"><div class="ttname"><a href="classIndexSet.html">IndexSet</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l00068">index_set.h:68</a></div></div>
<div class="ttc" id="aclassFEValues_html_a21f914e63d588e2652a9514620653d77"><div class="ttname"><a href="classFEValues.html#a21f914e63d588e2652a9514620653d77">FEValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell)</div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1PreconditionIC_html"><div class="ttname"><a href="classTrilinosWrappers_1_1PreconditionIC.html">TrilinosWrappers::PreconditionIC</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__precondition_8h_source.html#l00922">trilinos_precondition.h:922</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00077">fe_update_flags.h:77</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1Vector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1Vector.html">TrilinosWrappers::MPI::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__vector_8h_source.html#l00280">trilinos_vector.h:280</a></div></div>
<div class="ttc" id="adistributed__0_8txt_html_afec1b694405cadb2d251275096ad3563"><div class="ttname"><a href="distributed__0_8txt.html#afec1b694405cadb2d251275096ad3563">output</a></div><div class="ttdeci">if we even only hold bytes per line in this sparsity we ll need GB for this object even if every single line is empty Of only million lines will be non for which we need MB plus whatever is necessary to store the actual column indices of nonzero entries Let s say we have a moderately complex problem with entries per for each of which we store the column index worth then we ll need bytes for each of the million lines that correspond to the degrees of freedom we for a total of GB And we ll need bytes for each of the million lines that we don t for a total of GB It is clear that this ratio doesn t become any better if we go to even higher numbers of processors *The solution to this problem is to really only use any memory at all for those parts of the linear system that we or need for some other reason For all other we must know that they but we can not set up any part of our data structure To this there exists a class called IndexSet that denotes a set of indices which we care for and for which we may have to allocate memory The data structures for sparsity patterns constraint matrices matrices and vector can be initialized with these IndexSet objects to really only care for those rows or entries that correspond to indices in the index set and not care about all others These objects will then ask how many indices exist in the set allocate memory for each one of and when you want to access data for global degree of freedom[2.x.28] you will be redirected to the result of calling[2.x.29] with index[2.x.30] instead Accessing data for elements[2.x.31] for which[2.x.32] is false will yield an error *The remaining question is how to identify the set of indices that correspond to degrees of freedom we need to worry about on each processor To this you can use the[2.x.33] function to get at all the indices a processor owns Note that this is a subset of the degrees of freedom that are defined on the locally owned one sometimes needs the set of all degrees of freedom on the locally owned subdomain as well as the adjacent ghost cells This information is provided by the[2.x.35] function ***A typical parallel application is dealing with two different kinds of parallel but there are of course different vector types that can each represent both ghosted vectors are typically used for data output</div><div class="ttdef"><b>Definition:</b> <a href="distributed__0_8txt_source.html#l00059">distributed_0.txt:59</a></div></div>
<div class="ttc" id="ahdf5__0_8txt_html_aae153b86de45d3354cd3edd5b992435e"><div class="ttname"><a href="hdf5__0_8txt.html#aae153b86de45d3354cd3edd5b992435e">double</a></div><div class="ttdeci">*Namespace containing deal II s HDF5 interface whereas writing and reading raw data in a dataset can be done independently or double</div><div class="ttdef"><b>Definition:</b> <a href="hdf5__0_8txt_source.html#l00045">hdf5_0.txt:45</a></div></div>
<div class="ttc" id="aevent__0_8txt_html_a60053d8ff825674cfcc1321aba229cd7"><div class="ttname"><a href="event__0_8txt.html#a60053d8ff825674cfcc1321aba229cd7">true</a></div><div class="ttdeci">*Objects of this kind are used to notify interior applications of changes provoked by an outer loop They are handed to the application through[2.x.0] and it is up to the actual application how to handle them Event is organized as an extensible binary enumerator Every class can add its own events using here is how to retrieve it knowing the name generating a clear Event **Clear all flags **Set all flags **Add the flags of the other event **Clear the flags of the other event **Test whether all the flags set in the other Event are also set in this one **Return&lt; tt &gt; true&lt;/tt &gt; if any event is set **List the flags to a stream **List all assigned events actions have to be taken by all means if this value is true</div><div class="ttdef"><b>Definition:</b> <a href="event__0_8txt_source.html#l00028">event_0.txt:28</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__cg_8h_source.html#l00088">solver_cg.h:88</a></div></div>
<div class="ttc" id="apetsc__precondition__0_8txt_html_a41ebb2d49faa97a3d9eab4b4f13c2742"><div class="ttname"><a href="petsc__precondition__0_8txt.html#a41ebb2d49faa97a3d9eab4b4f13c2742">preconditioner</a></div><div class="ttdeci">*Base class for preconditioner classes using the PETSc functionality The classes in this hierarchy don t do a whole lot except for providing a function that sets the preconditioner and certain parameters on the preconditioning context of the solver These classes are basically here only to allow a similar interface as already used for the deal II solver and preconditioner classes Note that derived classes only provide interfaces to the relevant functionality of PETSc PETSc does not implement all preconditioners for all matrix types In particular some preconditioners are not going to work for parallel jobs such as for example the ILU preconditioner ***Constructor **Destructor **Destroys the preconditioner</div><div class="ttdef"><b>Definition:</b> <a href="petsc__precondition__0_8txt_source.html#l00002">petsc_precondition_0.txt:2</a></div></div>
<div class="ttc" id="aA-headers_2exceptions__0_8txt_html_a8fba07b9a84b89e6be225f5f95c3e355"><div class="ttname"><a href="A-headers_2exceptions__0_8txt.html#a8fba07b9a84b89e6be225f5f95c3e355">run</a></div><div class="ttdeci">the program is just and one can not intelligently work around that *It is sometimes useful to change the behavior of the[2.x.6] macro from aborting a program to throwing exceptions On the other exceptions are not allowed to propagate out of destructors of classes For this there is a variant of the called[2.x.7] that can be used in destructors These use cases are discussed further down below on this page **Dynamic such as whether an output file can be written to *These are things that shouldn t be checked because it is not guaranteed that a program for which the condition is satisfied in a debug mode run</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2exceptions__0_8txt_source.html#l00022">exceptions_0.txt:22</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q&lt; dim &gt;</a></div></div>
<div class="ttc" id="abase_2tensor__function_8h_html"><div class="ttname"><a href="base_2tensor__function_8h.html">tensor_function.h</a></div></div>
<div class="ttc" id="anamespaceUtilities_html_a6195c5f009ea8c7c536c6ffdf108c32f"><div class="ttname"><a href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></div><div class="ttdeci">std::string int_to_string(const unsigned int value, const unsigned int digits=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00473">utilities.cc:473</a></div></div>
<div class="ttc" id="anamespaceStep21_html_a7fc300ce0d5fa995ebe2b67d39ea3b4d"><div class="ttname"><a href="namespaceStep21.html#a7fc300ce0d5fa995ebe2b67d39ea3b4d">Step21::fractional_flow</a></div><div class="ttdeci">double fractional_flow(const double S, const double viscosity)</div><div class="ttdef"><b>Definition:</b> <a href="step-21_8cc_source.html#l00289">step-21.cc:289</a></div></div>
<div class="ttc" id="agrid_2grid__tools_8h_html"><div class="ttname"><a href="grid_2grid__tools_8h.html">grid_tools.h</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="doc_2doxygen_2headers_2namespace__dealii_8h_source.html#l00026">namespace_dealii.h:26</a></div></div>
<div class="ttc" id="amatrix__free_2dof__info__0_8txt_html_afc846d40941f6f9934e92e469096f30f"><div class="ttname"><a href="matrix__free_2dof__info__0_8txt.html#afc846d40941f6f9934e92e469096f30f">n_components</a></div><div class="ttdeci">We set the granularity to **that is a number sufficiently large to minimize loop peel overhead within the this function always returns index If an index is not found in hp it returns *[2.x.2] *Populate the vector[2.x.3] with locally owned degrees of freedom stored on the cell block[2.x.4] If[2.x.5] is then the returned vector will contain indices required to resolve constraints The image below illustrates the output of this function for cell blocks zero and one with zero Dirichlet boundary conditions at the bottom of the domain Note that due to the presence of the DoFs returned by this function for the case i indices that are located on another get a temporary number by this and will later be assigned the correct index after all the ghost indices have been collected by the call to *[2.x.12] *This method assigns the correct indices to ghost indices from the temporary numbering employed by the[2.x.13] function The numbers are localized with respect to the MPI and ghosts start at the end of the locally owned range This we get direct access to all vector entries **This method reorders the way cells are gone through based on a given renumbering of the cells It also takes[2.x.14] cells together and interprets them as one cell as is needed for vectorization **Finds possible compression for the cell indices that we can apply for increased efficiency Run at the end of reorder_cells **Finds possible compression for the face indices that we can apply for increased efficiency Run at the end of reorder_cells **This function computes the connectivity of the currently stored indices in terms of connections between the individual cells and fills the structure into a sparsity pattern **In case face integrals are find out whether certain loops over the unknowns only access a subset of all the ghost dofs we keep in the main partitioner **Given[2.x.15] containing the index of cells of macro the index ordering can be improved for typical DG elements by interleaving the degrees of freedom from batches of which avoids the data transposition in[2.x.16] these more advanced features are not so there is only limited value of this function **Fills the array that defines how to zero selected ranges in the result vector within the cell filling the two member variables[2.x.17] vector_zero_range_list_index and[2.x.18] The intent of this pattern is to zero the vector entries in close temporal proximity to the first access and thus keeping the vector entries in cache **Return the memory consumption in bytes of this class **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **Prints a representation of the indices in the class to the given output stream **Enum for various storage variants of the indices This storage format is used to implement more efficient indexing schemes in case the underlying data structures allow for and to inform the access functions in[2.x.19] on which array to get the data from One example of more efficient storage is the enum value[2.x.20] which means that one can get the indices to all degrees of freedom of a cell by reading only the first index for each whereas all subsequent indices are merely an offset from the first index **This value indicates that no index compression was found and the only valid storage is to access all indices present on the possibly including constraints For a cell face of this index the data access in FEEvaluationBase is directed to the array[2.x.21] dof_indices with the index row_starts[cell_index *n_vectorization *n_components] first **This value indicates that the indices are interleaved for access with vectorized gather and scatter operation This storage variant is possible in case there are no constraints on the cell and the indices in the batch of cells are not pointing to the same global index in different slots of a vectorized the data access in FEEvaluationBase is directed to the array dof_indices_interleaved with the index row_starts[cell_index *n_vectorization *n_components] first **This value indicates that the indices within a cell are all and one can get the index to the cell by reading that single value for each of the cells in the cell batch For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **This value indicates that the indices with a cell are contiguous and interleaved for i the first DoF index on a cell to the four or eight cells in the vectorization batch come than the second DoF and so on the interleaving between cells implies that only the batches for vectorization can be accessed whereas there is a strided access for getting only some of the entries The two additional categories interleaved_contiguous_strided and interleaved_contiguous_mixed_strides are a consequence of this storage type The former is for faces where at least one of the two adjacent sides will break with the interleaved storage We then have to make a strided access as described in the next category The last category interleaved_contiguous_mixed_strides appears in the ghost see the more detailed description of that category below this is something that cannot be avoided in general once we interleave the indices between cells For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **Similar to interleaved_contiguous but for the case when the interleaved indices are only contiguous within the degrees of but not also over the components of a vectorized array This happens typically on faces with DG where the cells have interleaved_contiguous storage but the faces numbering is not the same as the cell s numbering For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization *n_components **Similar to interleaved_contiguous_separate but for the case when the interleaved indices are not n_vectorization apart This happens typically within the ghost layer of DG where the remote owner has applied an interleaved storage and the current processor only sees some of the cells For a cell face of this index the data access in FEEvaluationBase is directed to the array dof_indices_contiguous with the index cell_index *n_vectorization * n_components</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2dof__info__0_8txt_source.html#l00070">dof_info_0.txt:70</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1SparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1SparseMatrix.html">TrilinosWrappers::SparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__sparse__matrix_8h_source.html#l00505">trilinos_sparse_matrix.h:505</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00070">fe_update_flags.h:70</a></div></div>
<div class="ttc" id="aiterators__0_8txt_html_a6cf0880ba2af3a1be4aacdbbd4b90f9c"><div class="ttname"><a href="iterators__0_8txt.html#a6cf0880ba2af3a1be4aacdbbd4b90f9c">triangulation</a></div><div class="ttdeci">where BaseIterator usually is one of thestandard iterators discussed above *The FilteredIterator gets an additional Predicate in its constructor and willskip all objects where this Predicate evaluates to&lt; tt &gt; false&lt;/tt &gt; Acollection of predicates already implemented can be found in the namespaceIteratorFilters ***IteratorsLoops Iterating over objects *All iterators of the same kind and iterating over thesame kind of geometrical objects traverse the mesh in the sameorder Take this code all iterators will always point to the same mesh even though&lt; tt &gt; DoFHandler&lt;/tt &gt; and&lt; tt &gt; Triangulation&lt;/tt &gt; are very different and even if the DoFHandlers are handling different finite the difference is only in the Accessor As mentioned the order in which iterators traverse the forest ofobjects is actually well but application programs should notassume any such but rather consider this an implementation detailof the library *Corresponding to above the order in which iterators traverse activeobjects is the same for all iterators in the following the difference to the previous example being that here we only consider active but theyare really rather dumb Their magic only lies in the fact that they point tosome useful in this case the Accessor For they point to anactual object that stores some data On the other the deal II when do not return a reference to an actual but returnan object that knows how to get at the data that represents cells In thisobject doesn t store itself where the vertices of a cell are or what its neighborsare it knows how to tease this sort of information from out of thearrays and tables and lists that the Triangulation class sets up to describe amesh *Accessing data that characterizes a cell is always done through the i e the expression[2.x.10] grants access to[1.x.6] attributes of this Accessor Examples of properties you can query from aniterator are ***Since dereferencing iterators yields accessor these calls are tomember etc These in turn figure out the relevant datafrom the various data structures that store this data How this is actuallydone and what data structures are used is not really of concern to authors ofapplications in deal II In by hiding the actual data structureswe are able to store data in an efficient not necessarily in a way thatmakes it easily accessible or understandable to application writers ***IteratorsTypedefs Kinds of accessors *Depending on what sort of data you want to there are different kindsof accessor and hexes that make up a triangulation</div><div class="ttdef"><b>Definition:</b> <a href="iterators__0_8txt_source.html#l00063">iterators_0.txt:63</a></div></div>
<div class="ttc" id="astep-1_8cc_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="step-1_8cc.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Definition:</b> <a href="step-1_8cc_source.html#l00086">step-1.cc:86</a></div></div>
<div class="ttc" id="aclassDynamicSparsityPattern_html_aa32f9f3ebad084d001349cd3ddb4074e"><div class="ttname"><a href="classDynamicSparsityPattern.html#aa32f9f3ebad084d001349cd3ddb4074e">DynamicSparsityPattern::reinit</a></div><div class="ttdeci">void reinit(const size_type m, const size_type n, const IndexSet &amp;rowset=IndexSet())</div><div class="ttdef"><b>Definition:</b> <a href="dynamic__sparsity__pattern_8cc_source.html#l00301">dynamic_sparsity_pattern.cc:301</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga7b52b286796c23ef9ff178faf7a4b68f"><div class="ttname"><a href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">StandardExceptions::ExcNotImplemented</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcNotImplemented()</div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation&lt; dim &gt;</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="afe_2fe__q_8h_html"><div class="ttname"><a href="fe_2fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="alogstream__0_8txt_html_add684e6ff311806f483d928c97341d99"><div class="ttname"><a href="logstream__0_8txt.html#add684e6ff311806f483d928c97341d99">block</a></div><div class="ttdeci">&lt;/tt &gt; or with one of the special member functions is buffered in a thread storage[2.x.15] An[2.x.16] or[2.x.17] will trigger a writeout to the console invoking a as well as a call to ******A subclass allowing for the safe generation and removal of prefixes Somewhere at the beginning of a block</div><div class="ttdef"><b>Definition:</b> <a href="logstream__0_8txt_source.html#l00015">logstream_0.txt:15</a></div></div>
<div class="ttc" id="anewton__0_8txt_html_a21f536f84dd77674667ed5d2a30eb3ab"><div class="ttname"><a href="newton__0_8txt.html#a21f536f84dd77674667ed5d2a30eb3ab">residual</a></div><div class="ttdeci">*Operator class performing Newton s iteration with standard step size control and adaptive matrix generation This class performs a Newton iteration up to convergence determined by control If after an update the norm of the residual has become larger then step size control is activated and the update is subsequently divided by two until the residual actually becomes depending on the tends to be this method applies an adaptive reassembling strategy Only if the reduction factor for the residual is more than receiving the applications computing the residual and solving the linear respectively **Declare the parameters applicable to Newton s method **Read the parameters in the ParameterHandler **Initialize the pointer data_out for debugging **The actual Newton iteration The initial value is in&lt; tt &gt; which also contains the result after convergence Values in&lt; tt &gt; in&lt;/tt &gt; are not used by but will be handed down to the objects **Set the maximal residual reduction allowed without triggering assembling in the next step Return the previous value **Control object for the Newton iteration **The indicating that the matrix must be assembled anew upon start **A flag used to decide how many stepsize iteration should be made Default is the original value of Enter zero here to turn off stepsize control *Controlled by&lt; tt &gt; Stepsize iterations&lt;/tt &gt; in parameter file **Threshold for re assembling matrix If the quotient of two consecutive residuals is smaller than this the system matrix is not assembled in this step *This parameter should be adjusted to the residual gain of the inner solver The default values is resulting in reassembling in every Newton step **Print residual</div><div class="ttdef"><b>Definition:</b> <a href="newton__0_8txt_source.html#l00032">newton_0.txt:32</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga06c0301bc74dd4c67a3d1db1000647f3"><div class="ttname"><a href="group__constraints.html#ga06c0301bc74dd4c67a3d1db1000647f3">DoFTools::make_zero_boundary_constraints</a></div><div class="ttdeci">void make_zero_boundary_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const types::boundary_id boundary_id, AffineConstraints&lt; number &gt; &amp;zero_boundary_constraints, const ComponentMask &amp;component_mask=ComponentMask())</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l03450">dof_tools_constraints.cc:3450</a></div></div>
<div class="ttc" id="abase_2vectorization_8h_html_ae5c8b2cd70b2640bab8f1ee4ccb7f4cc"><div class="ttname"><a href="base_2vectorization_8h.html#ae5c8b2cd70b2640bab8f1ee4ccb7f4cc">std::pow</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; pow(const ::VectorizedArray&lt; Number, width &gt; &amp;x, const ::VectorizedArray&lt; Number, width &gt; &amp;p)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05727">vectorization.h:5727</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2utilities_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2utilities_8h.html">utilities.h</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Scalar_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00095">fe_values_extractors.h:95</a></div></div>
<div class="ttc" id="alinear__operator__0_8txt_html_a64f52ea7f8959e614f32da4664cdbe50"><div class="ttname"><a href="linear__operator__0_8txt.html#a64f52ea7f8959e614f32da4664cdbe50">vmult</a></div><div class="ttdeci">*A class to store the abstract concept of a linear set up and handle intermediate storage locations by hand *As an example consider the and[2.x.8] one can sparse matrices with a or larger ***In order to use Trilinos or PETSc sparse matrices and preconditioners in conjunction with the LinearOperator it is necessary to extend the functionality of the LinearOperator class by means of an additional Payload *For for may represent a composite operation The[2.x.14] therefore provides an interface extension to the LinearOperator so that it can be passed to the solver and used by the solver as if it were a Trilinos it is again necessary to provide an interface that produces the result of this composite operation that is compatible with Trilinos the resulting this function also ensures that the underlying Payload matches that of the input *[2.x.105] *****LinearOperator *Return a nulled variant of the LinearOperator[2.x.108] i e with optimized[2.x.109][2.x.110] etc functions and with[2.x.111] set to true ******LinearOperator *Return a LinearOperator that acts as a mean value filter The vmult() functions of this matrix subtract the mean values of the vector. *The function takes an[2.x.114] object[2.x.115] as an argument to initialize the[2.x.116] and[2.x.117] objects of the LinearOperator object. ***[2.x.118] **[0.x.35] *[2.x.119] LinearOperator *Return a LinearOperator that acts as a mean value filter. The vmult() functions of this matrix subtract the mean values of the vector. *The function takes a LinearOperator[2.x.120] and uses its range initializer to create an mean value filter operator.The function also ensures that the underlying Payload matches that of the input[2.x.121] ***[2.x.122] **[0.x.36] *A helper class that is responsible for the initialization of a vector to be directly usable as the destination parameter</div></div>
<div class="ttc" id="anamespaceStep43_html_a1a31a094df3596a34cdda908e3444671"><div class="ttname"><a href="namespaceStep43.html#a1a31a094df3596a34cdda908e3444671">Step43::fractional_flow_derivative</a></div><div class="ttdeci">double fractional_flow_derivative(const double S, const double viscosity)</div><div class="ttdef"><b>Definition:</b> <a href="step-43_8cc_source.html#l00270">step-43.cc:270</a></div></div>
<div class="ttc" id="abase_2symmetric__tensor_8h_html_a3656e2f6095f612536b06139a6a2ca39"><div class="ttname"><a href="base_2symmetric__tensor_8h.html#a3656e2f6095f612536b06139a6a2ca39">invert</a></div><div class="ttdeci">constexpr SymmetricTensor&lt; 2, dim, Number &gt; invert(const SymmetricTensor&lt; 2, dim, Number &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l03515">symmetric_tensor.h:3515</a></div></div>
<div class="ttc" id="aclassBlockVectorBase_html_ae05a0e26814f032473ed2ef66da018bd"><div class="ttname"><a href="classBlockVectorBase.html#ae05a0e26814f032473ed2ef66da018bd">BlockVectorBase::block</a></div><div class="ttdeci">BlockType &amp; block(const unsigned int i)</div></div>
<div class="ttc" id="aclassSymmetricTensor_html_a33cd1a6c91c24a5ca34dfbc43c338d1c"><div class="ttname"><a href="classSymmetricTensor.html#a33cd1a6c91c24a5ca34dfbc43c338d1c">SymmetricTensor::invert</a></div><div class="ttdeci">constexpr SymmetricTensor&lt; 2, dim, Number &gt; invert(const SymmetricTensor&lt; 2, dim, Number &gt; &amp;t)</div><div class="ttdef"><b>Definition:</b> <a href="base_2symmetric__tensor_8h_source.html#l03515">symmetric_tensor.h:3515</a></div></div>
<div class="ttc" id="amapping__info__0_8txt_html_aaed09e22b1fee38bd2273caeedfb0e90"><div class="ttname"><a href="mapping__info__0_8txt.html#aaed09e22b1fee38bd2273caeedfb0e90">c</a></div><div class="ttdeci">*An enum to identify various types of cells and faces The most general type is what we typically compute in the FEValues context but for many geometries we can save significant storage ***The cell or face is Cartesian **The cell or face can be described with an affine mapping **The face is i the normal factor on a face is the same on all quadrature points This type is not assigned for cells **There is no special information available for compressing the representation of the object under consideration **Definition of a structure that stores all cached data related to the evaluated geometry from the mapping In order to support hp adaptivity and compressed storage length can be different for different rows it allows to jump at the data of individual rows similar to compressed row storage in sparse matrices We have two different start indices for fields with different sizes The first category of offsets are the indices for Jacobians of the transformation from unit to real second JxW and normal vectors We keep separate arrays for all these data structures because a user code might access only some of them In such a one array will be gone through in a contiguous order with access to all which makes it easy for the processor to prefetch data Having all data in a single array would require some strides in the access which is much more complicated for the processor to called which contains the quadrature weights and permutations of how to go through quadrature points in case of face data The latter comes in a vector for the support of hp with several data fields for the individual quadrature formulas ***Constructor Does nothing **Set up the lengths in the various members of this struct **Set up the lengths in the various members of this struct **Returns the memory consumption in bytes **Number of quadrature points applied on the given cell or face **Original one dimensional quadrature formula applied on the given cell or face **Quadrature formula applied on the given cell or face **Quadrature weights separated by dimension for use in specific situations **A cached vector of quadrature weights in the given number the evaluation of basis functions is not in the correct order if a face is not in the standard orientation to a given element This data structure is used to re order the data evaluated on quadrature points to represent the correct order **A class describing the layout of the sections in the[2.x.2] field and also includes some data that depends on the number of quadrature points in the hp context such as the inner quadrature formula and re indexing for faces that are not in the standard orientation **Collection of quadrature formulae applied on the given face *Only filled for since faces might be quadrilateral or triangle shaped **Stores the index offset into the arrays[2.x.4][2.x.5][2.x.6] and the second derivatives Note that affine cells have shorter fields of where the others have lengths equal to the number of quadrature points of the given cell **The storage of the Jacobian i the inverse and transposed Jacobians of the transformation from the unit to the real cell Indexed by[2.x.9] Contains two fields for access from both sides for interior but the default only the upper diagonal and diagonal part are needed The first index runs through the starting with the diagonal and then continuing row i and so on The second index is the spatial coordinate Indexed by[2.x.12] Contains two fields for access from both sides for interior but the default including a compression scheme for Cartesian cells where we do not need to store the full data on all points Indexed by *[2.x.16] *Clears all data fields except the descriptor vector **Returns the quadrature index for a given number of quadrature points If not in hp mode or if the index is not this function always returns index this function does not check whether the given degree is actually present **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **Returns the memory consumption in bytes **The class that stores all geometry dependent data related with cell interiors for use in the matrix free class ***Compute the information in the given cells and faces The cells are specified by the level and the index within the a mapping and several quadrature formulas are given **Update the information in the given cells and faces that is the result of a change in the given mapping keeping the quadrature formulas and other unknowns unchanged This call is only valid if[2.x.20] has been called before **Return the type of a given cell as detected during initialization **Clear all data fields in this class **Return the memory consumption of this class in bytes **Prints a detailed summary of memory consumption in the different structures of this class to the given output stream **The given update flags for computing the geometry on the cells **The given update flags for computing the geometry on the boundary faces **The given update flags for computing the geometry on the interior faces **The given update flags for computing the geometry on the faces for cell centric loops **Stores whether a cell is has constant transform data() or is whether it represents an affine whether it is a flat face where the normal vector is the same throughout the or is following the[2.x.21] variable for the cell types **The pointer to the underlying[2.x.22] object **The pointer to the first entry of mapping_collection **Reference cell type related to each quadrature and active quadrature index **Internal function to compute the geometry for the case the mapping is a MappingQ and a single quadrature formula per i it uses a polynomial description of the cell especially when several different quadrature formulas are and consumes less memory[2.x.23] tria The triangulation to be used for setup[2.x.24] cells The actual cells of the triangulation to be worked given as a tuple of the level and index within the level as used in the main initialization of the class ::x faces The description of the connectivity from faces to cells as filled in the MatrixFree class **Computes the information in the given called within initialize **Computes the information in the given called within initialize **Computes the information in the given called within initialize **Helper function to determine which update flags must be set in the internal functions to initialize all data as requested by the user **A helper class to extract either cell or face data from mapping info for use in FEEvaluationBase **A class that is used to compare floating point c</div><div class="ttdef"><b>Definition:</b> <a href="mapping__info__0_8txt_source.html#l00116">mapping_info_0.txt:116</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1MPI_1_1BlockVector_html"><div class="ttname"><a href="classTrilinosWrappers_1_1MPI_1_1BlockVector.html">TrilinosWrappers::MPI::BlockVector</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__parallel__block__vector_8h_source.html#l00073">trilinos_parallel_block_vector.h:73</a></div></div>
<div class="ttc" id="anamespaceStep20_1_1PrescribedSolution_html_a2ec9d2a9c0f55b8fb13bd1c83c358e38"><div class="ttname"><a href="namespaceStep20_1_1PrescribedSolution.html#a2ec9d2a9c0f55b8fb13bd1c83c358e38">Step20::PrescribedSolution::beta</a></div><div class="ttdeci">constexpr double beta</div><div class="ttdef"><b>Definition:</b> <a href="step-20_8cc_source.html#l00088">step-20.cc:88</a></div></div>
<div class="ttc" id="alac_2block__sparsity__pattern_8h_html"><div class="ttname"><a href="lac_2block__sparsity__pattern_8h.html">block_sparsity_pattern.h</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ac6b404bf03cb2a742b290421cc2789fe"><div class="ttname"><a href="namespaceVectorTools.html#ac6b404bf03cb2a742b290421cc2789fe">VectorTools::project</a></div><div class="ttdeci">void project(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const AffineConstraints&lt; typename VectorType::value_type &gt; &amp;constraints, const Quadrature&lt; dim &gt; &amp;quadrature, const Function&lt; spacedim, typename VectorType::value_type &gt; &amp;function, VectorType &amp;vec, const bool enforce_zero_boundary=false, const Quadrature&lt; dim - 1 &gt; &amp;q_boundary=(dim &gt; 1 ? QGauss&lt; dim - 1 &gt;(2) :Quadrature&lt; dim - 1 &gt;(0)), const bool project_to_boundary_first=false)</div></div>
<div class="ttc" id="aclassBlockDynamicSparsityPattern_html"><div class="ttname"><a href="classBlockDynamicSparsityPattern.html">BlockDynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2block__sparsity__pattern_8h_source.html#l00549">block_sparsity_pattern.h:549</a></div></div>
<div class="ttc" id="aclassDataOutInterface_html_a93c780f93105e0daaa76c6c43694b4ae"><div class="ttname"><a href="classDataOutInterface.html#a93c780f93105e0daaa76c6c43694b4ae">DataOutInterface::write_vtu</a></div><div class="ttdeci">void write_vtu(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07232">data_out_base.cc:7232</a></div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a93f65b0385560a34ec1d3c5ec5a882b8"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a93f65b0385560a34ec1d3c5ec5a882b8">Physics::Elasticity::Kinematics::d</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; d(const Tensor&lt; 2, dim, Number &gt; &amp;F, const Tensor&lt; 2, dim, Number &gt; &amp;dF_dt)</div></div>
<div class="ttc" id="alac_2trilinos__block__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2trilinos__block__sparse__matrix_8h.html">trilinos_block_sparse_matrix.h</a></div></div>
<div class="ttc" id="aclassStep43_1_1SaturationBoundaryValues_html_a62e536e852f9b21701278273bb88f683"><div class="ttname"><a href="classStep43_1_1SaturationBoundaryValues.html#a62e536e852f9b21701278273bb88f683">Step43::SaturationBoundaryValues::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-43_8cc_source.html#l00107">step-43.cc:107</a></div></div>
<div class="ttc" id="alac_2affine__constraints_8h_html"><div class="ttname"><a href="lac_2affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="aparameter__handler__0_8txt_html_ad919e2b915d8e8226aef004c2d8399a8"><div class="ttname"><a href="parameter__handler__0_8txt.html#ad919e2b915d8e8226aef004c2d8399a8">exception</a></div><div class="ttdeci">since default values may change in the process of program you cannot know the values of parameters not specified in the input file ****It is often convenient to have something happen as soon as a parameter value is read This could be a check that it is valid that a file that is listed in the parameter file exists **or to initiate something else in such as setting a variable outside the this action could also be initiated once all parameters are read via but it is sometimes[1.x.19] to do it right away *This is facilitated by the and can then do whatever they want with it **e save it somewhere outside the ParameterHandler in C one doesn t usually pass around the address of a but an action can be a function like object(taking a string as argument) that results from calling such as a[1.x.20] that has the form **[1.x.21] *and that is attached to a specific parameter. *A typical example of such an action would be as follows the content of the file equals the default value of the parameter the contents of files are never changed after declaration of a parameter a directory in this file system may not have a file called[2.x.20] in it In that the directory represents a subsection as declared and the directory s name will correspond to the name of the subsection It will then have no files in it at but it may have further directories in the code above will lead to a hierarchical representation of data that looks like this(the content of files is indicated at the right in a different font) this is only used when creating output for exceptions If non empty[2.x.35] is the ParameterHandler object will stop parsing lines after encountering[2.x.36] This is handy when adding extra data that shall be parsed manually If[2.x.37] the parameter handler will skip undefined sections and entries This is useful for partially parsing a parameter for example to obtain only the spatial dimension of the problem By default all entries and subsections are expected to be declared The function sets the value of all parameters it encounters in the input file to the provided value Parameters not explicitly listed in the input file are left at the value they previously which will be the default value provided to and for each parameter all associated actions that may previously have been set by or if an associated action throws an exception</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler__0_8txt_source.html#l00241">parameter_handler_0.txt:241</a></div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_a6ed7c846331069f406b8c9933c37fda4"><div class="ttname"><a href="classDataOut__DoFData.html#a6ed7c846331069f406b8c9933c37fda4">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandler&lt; dim, spacedim &gt; &amp;)</div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00266">dof_handler.h:266</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ac686a2d27b6681259628e383e731c143">DoFTools::none</a></div><div class="ttdeci">@ none</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00216">dof_tools.h:216</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a9b7d9c85221484e1998f6869d98cba8b">DataComponentInterpretation::component_is_part_of_vector</a></div><div class="ttdeci">@ component_is_part_of_vector</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00062">data_component_interpretation.h:62</a></div></div>
<div class="ttc" id="asolver__cg__0_8txt_html_a557c71e94a2542d697ca3426b8843cd4"><div class="ttname"><a href="solver__cg__0_8txt.html#a557c71e94a2542d697ca3426b8843cd4">sqrt</a></div><div class="ttdeci">*This class implements the preconditioned Conjugate but is used in many other tutorial programs as well Like all other solver it can work on any kind of vector and matrix as long as they satisfy certain and defaults to *[2.x.2] **This version of CG is taken from D Braess s book Finite Elements It requires a symmetric the projected matrix[2.x.4] is tri diagonal Since the projection is the eigenvalues of[2.x.5] approximate those of the original preconditioned matrix[2.x.6] In after[2.x.7] where[2.x.8] is the dimension of the original the eigenvalues of both matrices are equal even for small numbers of iteration the condition number of[2.x.9] is a good estimate for the one of *[2.x.10] After[2.x.11] steps the matrix T_m can be written in terms of the coefficients[2.x.12] and[2.x.13] as the tri diagonal matrix with diagonal elements&lt; tt &gt;&lt; tt &gt; alpha_1 beta_0&lt; tt &gt;&lt; tt &gt; sqrt(beta_{m-2&lt;/tt &gt;)/alpha_</div><div class="ttdef"><b>Definition:</b> <a href="solver__cg__0_8txt_source.html#l00011">solver_cg_0.txt:11</a></div></div>
<div class="ttc" id="aclassTable_html"><div class="ttname"><a href="classTable.html">Table</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2array__view_8h_source.html#l00033">array_view.h:33</a></div></div>
<div class="ttc" id="anamespaceDoFRenumbering_html_a68651164485490b86d901d9ae1fbfc3b"><div class="ttname"><a href="namespaceDoFRenumbering.html#a68651164485490b86d901d9ae1fbfc3b">DoFRenumbering::Cuthill_McKee</a></div><div class="ttdeci">void Cuthill_McKee(DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const bool reversed_numbering=false, const bool use_constraints=false, const std::vector&lt; types::global_dof_index &gt; &amp;starting_indices=std::vector&lt; types::global_dof_index &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering_8cc_source.html#l00366">dof_renumbering.cc:366</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="anamespaceDifferentiation_1_1SD_html_a592560ee80355620422a86087f11b9df"><div class="ttname"><a href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">Differentiation::SD::fabs</a></div><div class="ttdeci">Expression fabs(const Expression &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="symengine__math_8cc_source.html#l00273">symengine_math.cc:273</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00116">fe_update_flags.h:116</a></div></div>
<div class="ttc" id="aclassSubscriptor_html"><div class="ttname"><a href="classSubscriptor.html">Subscriptor</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2subscriptor_8h_source.html#l00060">subscriptor.h:60</a></div></div>
<div class="ttc" id="apolynomials__abf__0_8txt_html_a7a716deb19e461cf8ba2a26e01c6a908"><div class="ttname"><a href="polynomials__abf__0_8txt.html#a7a716deb19e461cf8ba2a26e01c6a908">k</a></div><div class="ttdeci">*This class implements the[1.x.0] vector valued Arnold Boffi Falk polynomials as described in the article by Arnold Boffi SIAM J Numer Anal pp **The ABF polynomials are constructed such that the divergence is in the tensor product polynomial space[1.x.1] the polynomial order of each component must be two orders higher in the corresponding yielding the polynomial spaces[1.x.2] and[1.x.3] in resp ******Constructor Creates all basis functions for Raviart Thomas polynomials of given degree[2.x.1] k</div><div class="ttdef"><b>Definition:</b> <a href="polynomials__abf__0_8txt_source.html#l00013">polynomials_abf_0.txt:13</a></div></div>
<div class="ttc" id="anumerics_2vector__tools_8h_html"><div class="ttname"><a href="numerics_2vector__tools_8h.html">vector_tools.h</a></div></div>
<div class="ttc" id="abase_2function_8h_html"><div class="ttname"><a href="base_2function_8h.html">function.h</a></div></div>
<div class="ttc" id="anumerical__algorithms__0_8txt_html_a852a1e245dd2de4943eeb66beeaf65b1"><div class="ttname"><a href="numerical__algorithms__0_8txt.html#a852a1e245dd2de4943eeb66beeaf65b1">vector</a></div><div class="ttdeci">****This module groups a diverse set of classes that generally implement some sort of numerical algorithm on top all the basic and finite element classes in the library They are generally unconnected to each other *Some of the like KellyErrorEstimator and act on solutions already and compute derived quantities in the first two or help transferring a set of vectors from one mesh to another *The namespaces and VectorTools provide an assortment of such as creating a Laplace projecting or interpolating a function onto the present finite element etc The difference to the functions in the DoFTools and FETools functions is that they work on the DoFTools functions only act on a given DoFHandler object without reference to a data vector</div><div class="ttdef"><b>Definition:</b> <a href="numerical__algorithms__0_8txt_source.html#l00008">numerical_algorithms_0.txt:8</a></div></div>
<div class="ttc" id="abase_2index__set_8h_html"><div class="ttname"><a href="base_2index__set_8h.html">index_set.h</a></div></div>
<div class="ttc" id="anumerics_2solution__transfer_8h_html"><div class="ttname"><a href="numerics_2solution__transfer_8h.html">solution_transfer.h</a></div></div>
<div class="ttc" id="abase_2logstream_8h_html"><div class="ttname"><a href="base_2logstream_8h.html">logstream.h</a></div></div>
<div class="ttc" id="anamespaceStep43_html"><div class="ttname"><a href="namespaceStep43.html">Step43</a></div><div class="ttdef"><b>Definition:</b> <a href="step-43_8cc_source.html#l00063">step-43.cc:63</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160ae505ee2251dce5d665811501b2037af7">DoFTools::always</a></div><div class="ttdeci">@ always</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__tools_8h_source.html#l00221">dof_tools.h:221</a></div></div>
<div class="ttc" id="alac_2trilinos__precondition_8h_html"><div class="ttname"><a href="lac_2trilinos__precondition_8h.html">trilinos_precondition.h</a></div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Vector_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__extractors_8h_source.html#l00140">fe_values_extractors.h:140</a></div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
<div class="ttc" id="alac_2trilinos__vector_8h_html"><div class="ttname"><a href="lac_2trilinos__vector_8h.html">trilinos_vector.h</a></div></div>
<div class="ttc" id="amg__transfer__0_8txt_html_a6b401cd9c6154fc787311f58ab910002"><div class="ttname"><a href="mg__transfer__0_8txt.html#a6b401cd9c6154fc787311f58ab910002">pressure</a></div><div class="ttdeci">MGTransferBase is defined in mg_base h ***Implementation of transfer between the global vectors and the multigrid levels for use in the derived class MGTransferPrebuilt and other classes ***Reset the object to the state it had right after the default constructor **Transfer from a vector on the global grid to vectors defined on each of the levels separately for the active degrees of freedom In for a globally refined mesh only the finest level in[2.x.0] is filled as a plain copy of[2.x.1] All the other level objects are left untouched **Transfer from multi level vector to normal vector Copies data from active portions of an MGVector into the respective positions of a&lt; tt &gt; Vector&lt; number &gt;&lt;/tt &gt; In order to keep the result constrained degrees of freedom are set to zero **Add a multi level vector to a normal vector Works as the previous but probably not for continuous elements **If this object operates on BlockVector we need to describe how the individual vector components are mapped to the blocks of a vector For for a Stokes we have dim vector components for velocity and pressure</div><div class="ttdef"><b>Definition:</b> <a href="mg__transfer__0_8txt_source.html#l00017">mg_transfer_0.txt:17</a></div></div>
<div class="ttc" id="avector__tools__point__value__0_8txt_html_ac7a5c2ceb5c739d5b51cc7e0eee8100a"><div class="ttname"><a href="vector__tools__point__value__0_8txt.html#ac7a5c2ceb5c739d5b51cc7e0eee8100a">solve</a></div><div class="ttdeci">*Assembling of right hand sides **Create a right hand side vector for a point source at point[2.x.1] In other it creates a vector[2.x.2] so that[2.x.3] where[2.x.4] are the shape functions described by[2.x.5] and[2.x.6] is the point at which the delta function is located Prior content of the given[2.x.7] vector is deleted This function is for the case of a scalar finite element This function is typically used in one of these two with different values for right hand sides or and then evaluate the solution at the same point every time You could do this by calling[2.x.8] after each solve</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__point__value__0_8txt_source.html#l00015">vector_tools_point_value_0.txt:15</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gae9a45f517af1401c50811a11083f9114"><div class="ttname"><a href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">StandardExceptions::ExcMessage</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcMessage(std::string arg1)</div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa4924d31df0211f3fb9db3bbe1af0d1c">DataComponentInterpretation::component_is_scalar</a></div><div class="ttdeci">@ component_is_scalar</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__component__interpretation_8h_source.html#l00055">data_component_interpretation.h:55</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_a796721b56b3a90e4e3973c7caae4c3d8"><div class="ttname"><a href="namespaceDoFTools.html#a796721b56b3a90e4e3973c7caae4c3d8">DoFTools::count_dofs_per_fe_block</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; count_dofs_per_fe_block(const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::vector&lt; unsigned int &gt; &amp;target_block=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01943">dof_tools.cc:1943</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a></div><div class="ttdeci">@ update_normal_vectors</div><div class="ttdoc">Normal vectors.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00132">fe_update_flags.h:132</a></div></div>
<div class="ttc" id="aclassSolverGMRES_html"><div class="ttname"><a href="classSolverGMRES.html">SolverGMRES</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__gmres_8h_source.html#l00168">solver_gmres.h:168</a></div></div>
<div class="ttc" id="aclassTensor_html"><div class="ttname"><a href="classTensor.html">Tensor&lt; 2, dim &gt;</a></div></div>
<div class="ttc" id="aclassDataOut_html_a087f63e22f0614bca326dbdca288c646"><div class="ttname"><a href="classDataOut.html#a087f63e22f0614bca326dbdca288c646">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01071">data_out.cc:1071</a></div></div>
<div class="ttc" id="aclassSolutionTransfer_html"><div class="ttname"><a href="classSolutionTransfer.html">SolutionTransfer</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2solution__transfer_8h_source.html#l00277">solution_transfer.h:277</a></div></div>
<div class="ttc" id="abase_2index__set_8h_html_ad28b2e725afda38ffdef1bf61d5cadd4"><div class="ttname"><a href="base_2index__set_8h.html#ad28b2e725afda38ffdef1bf61d5cadd4">complete_index_set</a></div><div class="ttdeci">IndexSet complete_index_set(const IndexSet::size_type N)</div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l01094">index_set.h:1094</a></div></div>
<div class="ttc" id="anamespaceDoFRenumbering_html_a52c1941406d1ce2937e29a46edf111f4"><div class="ttname"><a href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a></div><div class="ttdeci">void component_wise(DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, const std::vector&lt; unsigned int &gt; &amp;target_component=std::vector&lt; unsigned int &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="dof__renumbering_8cc_source.html#l00681">dof_renumbering.cc:681</a></div></div>
<div class="ttc" id="ageometry__info__0_8txt_html_a30a552b07accf65da90f851e25d14d1c"><div class="ttname"><a href="geometry__info__0_8txt.html#a30a552b07accf65da90f851e25d14d1c">dim</a></div><div class="ttdeci">3, where it offers following possibilities:a face(quad) being refined in x- or y-direction(in the face-intern coordinate system) separately,([2.x.79] or([2.x.80] which corresponds to([2.x.81]). Additionally, it offers the possibilities a face can have through repeated anisotropic refinement steps performed on one of the two neighboring cells. It might be possible for example, that a face(quad) is refined with[2.x.82] and afterwards the left child is again refined with[2.x.83], so that there are three active subfaces. Note, however, that only refinement cases are allowed such that each line on a face between two hexes has not more than one hanging node. Furthermore, it is not allowed that two neighboring hexes are refined such that one of the hexes refines the common face with[2.x.84] and the other hex refines that face with[2.x.85] . In fact,[2.x.86] takes care of this situation and ensures that each face of a refined cell is completely contained in a single face of neighboring cells. The following drawings explain the SubfacePossibilities and give the corresponding subface numbers:*[1.x.4] **[2.x.87] *[0.x.68] *Possible cases of faces being subdivided into subface. See documentation to the SubfacePossibilities&lt; 3 &gt; for more details on the subface possibilities. *[0.x.69] *A class that provides all possible cases a face(in the current space dimension[2.x.88] might be subdivided into subfaces. *[2.x.89] *[0.x.70] *Constructor. Take and store a value indicating a particular subface possibility in the list of possible situations specified in the base class. *[0.x.71] *Return the numeric value stored by this class. While the presence of this operator might seem dangerous, it is useful in cases where one would like to have code like&lt; code &gt;switch(subface_case)... case[2.x.90] ...&lt;/code &gt;, which can be written as&lt; code &gt;switch[2.x.91] Another application is to use an object of the current type as an index into an array dim</div><div class="ttdef"><b>Definition:</b> <a href="geometry__info__0_8txt_source.html#l00202">geometry_info_0.txt:202</a></div></div>
<div class="ttc" id="amultithreading__0_8txt_html_a553c97770c66367cd8861ec511390650"><div class="ttname"><a href="multithreading__0_8txt.html#a553c97770c66367cd8861ec511390650">points</a></div><div class="ttdeci">for if the values of a function need to be evaluated at quadrature points</div><div class="ttdef"><b>Definition:</b> <a href="multithreading__0_8txt_source.html#l00182">multithreading_0.txt:182</a></div></div>
<div class="ttc" id="aclassDynamicSparsityPattern_html"><div class="ttname"><a href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2dynamic__sparsity__pattern_8h_source.html#l00340">dynamic_sparsity_pattern.h:340</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga9442b63275c9ef3fab29bc222831c49c"><div class="ttname"><a href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a></div><div class="ttdeci">#define AssertDimension(dim1, dim2)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01749">exceptions.h:1749</a></div></div>
<div class="ttc" id="astructSolverGMRES_1_1AdditionalData_html"><div class="ttname"><a href="structSolverGMRES_1_1AdditionalData.html">SolverGMRES::AdditionalData</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__gmres_8h_source.html#l00175">solver_gmres.h:175</a></div></div>
<div class="ttc" id="aA-headers_2fe__0_8txt_html_abbd000c1bb0a029706ba0d8934597f39"><div class="ttname"><a href="A-headers_2fe__0_8txt.html#abbd000c1bb0a029706ba0d8934597f39">velocity</a></div><div class="ttdeci">****All classes related to shape functions and to access to shape functions This concerns the actual values of finite elements For the numbering of degrees of freedom refer to the module on *[2.x.1] The classes and functions of this module fall into several sub groups that are discussed in their respective sub modules listed above In the FETools class provides functions that provide information on finite elements transformations between elements etc *In the grand scheme of the pieces of this module interact with a variety of other parts of the without actually implementing a concrete element For the FiniteElement base class declares the virtual functions a derived class has to implement if it wants to describe a finite element space Likewise the FiniteElementData holds variables that describe certain values characterizing a finite element such as the number of degrees of freedom per vertex line or face *On the other classes like FE_Poly and FE_PolyTensor are higher abstractions They describe finite elements that are built atop polynomial descriptions of the shape functions on the unit cell Classes derived from them then only have to provide a description of the particular polynomial from which a finite element is built For the FE_Q class that implements the usual Lagrange elements uses the FE_Poly base class to generate a finite element by providing it with a set of Lagrange interpolation polynomials corresponding to an equidistant subdivision of interpolation points the FESystem class is used for vector valued problems There one may want to couple a number of for Navier Stokes one may want to use three Q1 elements for the three components of the velocity</div><div class="ttdef"><b>Definition:</b> <a href="A-headers_2fe__0_8txt_source.html#l00021">fe_0.txt:21</a></div></div>
<div class="ttc" id="aclassFunction_html_acbfcab66b2fc63bfea59268f40772bb4"><div class="ttname"><a href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">Function::value</a></div><div class="ttdeci">virtual RangeNumberType value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const</div></div>
<div class="ttc" id="anamespaceStep20_1_1PrescribedSolution_html_a6142e18d25af27882714d1787af4ee59"><div class="ttname"><a href="namespaceStep20_1_1PrescribedSolution.html#a6142e18d25af27882714d1787af4ee59">Step20::PrescribedSolution::alpha</a></div><div class="ttdeci">constexpr double alpha</div><div class="ttdef"><b>Definition:</b> <a href="step-20_8cc_source.html#l00087">step-20.cc:87</a></div></div>
<div class="ttc" id="aauto__derivative__function__0_8txt_html_a53f941360577ad71fbd6bc110ec4f4de"><div class="ttname"><a href="auto__derivative__function__0_8txt.html#a53f941360577ad71fbd6bc110ec4f4de">value_list</a></div><div class="ttdeci">*This class automatically computes the gradient of a function by employing numerical difference quotients This only if the user function does not provide the gradient function himself *The following example of an user defined function overloads and implements only the where the latter function employs numerical difference quotients *****If the user overloads and implements also the gradient of the users gradient function is called that the usage of the also applies to the value_list() and gradient_list() functions as well as to the vector valued versions of these functions</div></div>
<div class="ttc" id="adofs_2dof__tools_8h_html"><div class="ttname"><a href="dofs_2dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="abase_2tensor_8h_html_a93ba01d979880b278cd4b573dd9c653b"><div class="ttname"><a href="base_2tensor_8h.html#a93ba01d979880b278cd4b573dd9c653b">l1_norm</a></div><div class="ttdeci">Number l1_norm(const Tensor&lt; 2, dim, Number &gt; &amp;t)</div><div class="ttdef"><b>Definition:</b> <a href="base_2tensor_8h_source.html#l02926">tensor.h:2926</a></div></div>
<div class="ttc" id="afe_2fe__system_8h_html"><div class="ttname"><a href="fe_2fe__system_8h.html">fe_system.h</a></div></div>
<div class="ttc" id="aclassTensorFunction_html"><div class="ttname"><a href="classTensorFunction.html">TensorFunction</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2tensor__function_8h_source.html#l00059">tensor_function.h:59</a></div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00039">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_a03a2f48682e29e39f7bccc11a7d1c4d1"><div class="ttname"><a href="polynomial__space__0_8txt.html#a03a2f48682e29e39f7bccc11a7d1c4d1">degree</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has degree[1.x.4]</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00003">polynomial_space_0.txt:3</a></div></div>
<div class="ttc" id="abase_2quadrature__lib_8h_html"><div class="ttname"><a href="base_2quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="aautomatic__and__symbolic__differentiation__0_8txt_html_a96ecfde131843f52ee49d0e0c1180134"><div class="ttname"><a href="automatic__and__symbolic__differentiation__0_8txt.html#a96ecfde131843f52ee49d0e0c1180134">time</a></div><div class="ttdeci">computing derivatives of these terms is impractical in most applications in impossible to get right Higher derivatives are even more impossible to do without computer aid Automatic or symbolic differentiation is a way out of and gets compile time</div><div class="ttdef"><b>Definition:</b> <a href="automatic__and__symbolic__differentiation__0_8txt_source.html#l00012">automatic_and_symbolic_differentiation_0.txt:12</a></div></div>
<div class="ttc" id="anamespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeade3f4c40082ead56c7aef5e90e43242f">EvaluationFlags::values</a></div><div class="ttdeci">@ values</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_2evaluation__flags_8h_source.html#l00055">evaluation_flags.h:55</a></div></div>
<div class="ttc" id="aclassSmartPointer_html"><div class="ttname"><a href="classSmartPointer.html">SmartPointer</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2smartpointer_8h_source.html#l00067">smartpointer.h:67</a></div></div>
<div class="ttc" id="afunction__time__0_8txt_html_aec9d63e7b1c02618470be701525a5211"><div class="ttname"><a href="function__time__0_8txt.html#aec9d63e7b1c02618470be701525a5211">sin</a></div><div class="ttdeci">*Support for time dependent functions The library was also designed for time dependent problems For this the function objects also contain a field which stores the as well as functions manipulating them Time independent problems should not access or even abuse them for other but since one normally does not create thousands of function the gain in generality weighs out the fact that we need not store the time value for not time dependent problems The second advantage is that the derived standard classes like&lt; tt &gt;&lt; tt &gt; ConstantFunction&lt;/tt &gt; etc also work for time dependent problems *Access to the time goes through the following so that derived classes can perform computations which need only be done once for every new time For if a time dependent function had a factor&lt; tt &gt; sin(t)&lt;/tt &gt;</div></div>
<div class="ttc" id="afe__evaluation__0_8txt_html_a8f384576a64c89a6fa8352847523e340"><div class="ttname"><a href="fe__evaluation__0_8txt.html#a8f384576a64c89a6fa8352847523e340">n_q_points</a></div><div class="ttdeci">FE_Q with hanging node constraints connects to more neighbors than a FE_DGQ for and cells which need data exchange are put in different positions inside the cell loop Of if the exact same and then the order is going to be the same because the algorithm is deterministic *dim Dimension in which this class is to be used *fe_degree Degree of the tensor product finite element with fe_degree degrees of freedom per coordinate direction Can be set to **if the degree is not known at compile but performance will usually be worse by a factor of *n_q_points_1d Number of points in the quadrature formula defaults to fe_degree *n_components Number of vector components when solving a system of PDEs If the same operation is applied to several components of a they can be applied simultaneously with one usually[2.x.339] or[2.x.340] Defaults to[2.x.341] double ******An alias to the base class **An underlying number type specified as template argument **The type of function e g VectorizedArrayType for e g Tensor&lt; 1, dim, VectorizedArrayType &gt; for n_q_points</div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation__0_8txt_source.html#l00537">fe_evaluation_0.txt:537</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga31978c026b8b6b5116df30b8e748f6b7"><div class="ttname"><a href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">StandardExceptions::ExcInternalError</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcInternalError()</div></div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="anamespaceGridTools_html_acd5ccc543d561cfb086b571d1f7818cb"><div class="ttname"><a href="namespaceGridTools.html#acd5ccc543d561cfb086b571d1f7818cb">GridTools::diameter</a></div><div class="ttdeci">double diameter(const Triangulation&lt; dim, spacedim &gt; &amp;tria)</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools_8cc_source.html#l00081">grid_tools.cc:81</a></div></div>
<div class="ttc" id="adofs_2dof__renumbering_8h_html"><div class="ttname"><a href="dofs_2dof__renumbering_8h.html">dof_renumbering.h</a></div></div>
<div class="ttc" id="aclassQMidpoint_html"><div class="ttname"><a href="classQMidpoint.html">QMidpoint</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2quadrature__lib_8h_source.html#l00093">quadrature_lib.h:93</a></div></div>
<div class="ttc" id="afe_2fe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe_2fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__update__flags_8h_source.html#l00124">fe_update_flags.h:124</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01581">exceptions.h:1581</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_ade22ffd9fb5b07842daa504929244aa7"><div class="ttname"><a href="classFEValuesBase.html#ade22ffd9fb5b07842daa504929244aa7">FEValuesBase::get_fe</a></div><div class="ttdeci">const FiniteElement&lt; dim, spacedim &gt; &amp; get_fe() const</div></div>
<div class="ttc" id="anamespaceGridTools_html_a47c293eff2ec7ce4b90ba08b35d1f2e2"><div class="ttname"><a href="namespaceGridTools.html#a47c293eff2ec7ce4b90ba08b35d1f2e2">GridTools::minimal_cell_diameter</a></div><div class="ttdeci">double minimal_cell_diameter(const Triangulation&lt; dim, spacedim &gt; &amp;triangulation, const Mapping&lt; dim, spacedim &gt; &amp;mapping=(ReferenceCells::get_hypercube&lt; dim &gt;() .template get_default_linear_mapping&lt; dim, spacedim &gt;()))</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools_8cc_source.html#l04309">grid_tools.cc:4309</a></div></div>
<div class="ttc" id="aclassStep43_1_1SaturationInitialValues_html_ac8b238d242b0856ec23f7b63ff7c014e"><div class="ttname"><a href="classStep43_1_1SaturationInitialValues.html#ac8b238d242b0856ec23f7b63ff7c014e">Step43::SaturationInitialValues::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-43_8cc_source.html#l00135">step-43.cc:135</a></div></div>
<div class="ttc" id="ablock__sparse__matrix__ez__0_8txt_html_af734f4df74ac4822dd99a6cca7203600"><div class="ttname"><a href="block__sparse__matrix__ez__0_8txt.html#af734f4df74ac4822dd99a6cca7203600">m</a></div><div class="ttdeci">Matrix1 *[2.x.1] **A block matrix consisting of blocks of type SparseMatrixEZ *Like the other Block this matrix can be used like a when it comes to access to entries there are functions for the multiplication with BlockVector and access to the individual blocks the block s must be empty **Copy this operation is only allowed if the actual value to be assigned is zero This in order to be able to relay global indices into the matrix to indices into the subobjects Youmust *call this function each time after you have changed the size of the sub objects **Access the block with the given coordinates **Access the block with the given coordinates Version for constant objects **Return the number of blocks in a column **Return the number of blocks in a row **Return whether the object is empty It is empty if no memory is which is the same as that both dimensions are zero This function is just the concatenation of the respective call to all sub matrices **Return number of rows of this which equals the dimension of the which equals the dimension of the domain space It is the sum of the number of columns over the sub matrix blocks of this matrix Recall that the matrix is of size m() times n(). *[0.x.18] *Set the element&lt; tt &gt;(i</div></div>
<div class="ttc" id="aclassStep43_1_1PressureBoundaryValues_html_ada3b35b91f535c5145f28dd5c0a59e1a"><div class="ttname"><a href="classStep43_1_1PressureBoundaryValues.html#ada3b35b91f535c5145f28dd5c0a59e1a">Step43::PressureBoundaryValues::value</a></div><div class="ttdeci">virtual double value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-43_8cc_source.html#l00084">step-43.cc:84</a></div></div>
<div class="ttc" id="alac_2full__matrix_8h_html"><div class="ttname"><a href="lac_2full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="alac_2solver__cg_8h_html"><div class="ttname"><a href="lac_2solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="anamespaceStep43_html_abfa39791422beb7a56fabd07a254ca56"><div class="ttname"><a href="namespaceStep43.html#abfa39791422beb7a56fabd07a254ca56">Step43::mobility_inverse</a></div><div class="ttdeci">double mobility_inverse(const double S, const double viscosity)</div><div class="ttdef"><b>Definition:</b> <a href="step-43_8cc_source.html#l00255">step-43.cc:255</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_acea0cbcd68e52ce8113d1134b87de403"><div class="ttname"><a href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a></div><div class="ttdeci">void hyper_cube(Triangulation&lt; dim, spacedim &gt; &amp;tria, const double left=0., const double right=1., const bool colorize=false)</div></div>
<div class="ttc" id="aclassStep21_1_1TwoPhaseFlowProblem_html"><div class="ttname"><a href="classStep21_1_1TwoPhaseFlowProblem.html">Step21::TwoPhaseFlowProblem</a></div><div class="ttdef"><b>Definition:</b> <a href="step-21_8cc_source.html#l00065">step-21.cc:65</a></div></div>
<div class="ttc" id="aclassFEFaceValues_html_a49db483b7252515ea578be6d57c5874b"><div class="ttname"><a href="classFEFaceValues.html#a49db483b7252515ea578be6d57c5874b">FEFaceValues::reinit</a></div><div class="ttdeci">void reinit(const TriaIterator&lt; DoFCellAccessor&lt; dim, spacedim, level_dof_access &gt;&gt; &amp;cell, const unsigned int face_no)</div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_ac26de0c059200523177bb1d92cc25d00"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a></div><div class="ttdeci">unsigned int n_mpi_processes(const MPI_Comm &amp;mpi_communicator)</div><div class="ttdef"><b>Definition:</b> <a href="mpi_8cc_source.html#l00117">mpi.cc:117</a></div></div>
<div class="ttc" id="aclassTrilinosWrappers_1_1BlockSparseMatrix_html"><div class="ttname"><a href="classTrilinosWrappers_1_1BlockSparseMatrix.html">TrilinosWrappers::BlockSparseMatrix</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2trilinos__block__sparse__matrix_8h_source.html#l00068">trilinos_block_sparse_matrix.h:68</a></div></div>
<div class="ttc" id="anamespaceLinearAlgebraPETSc_1_1MPI_html_a2a3c696b5297cb04d9a7137121aba8b7"><div class="ttname"><a href="namespaceLinearAlgebraPETSc_1_1MPI.html#a2a3c696b5297cb04d9a7137121aba8b7">LinearAlgebraPETSc::MPI::PreconditionIC</a></div><div class="ttdeci">PETScWrappers::PreconditionICC PreconditionIC</div><div class="ttdef"><b>Definition:</b> <a href="lac_2generic__linear__algebra_8h_source.html#l00157">generic_linear_algebra.h:157</a></div></div>
<div class="ttc" id="anamespacenumbers_html_a8ae36952c7e0cc778b47b5371b3aeff1"><div class="ttname"><a href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a></div><div class="ttdeci">static const unsigned int invalid_unsigned_int</div><div class="ttdef"><b>Definition:</b> <a href="base_2types_8h_source.html#l00179">types.h:179</a></div></div>
<div class="ttc" id="astep-69_8cc_html_a66a64d07b4db87c87b639bdcf7b18c82"><div class="ttname"><a href="step-69_8cc.html#a66a64d07b4db87c87b639bdcf7b18c82">local_dof_indices</a></div><div class="ttdeci">std::vector&lt; types::global_dof_index &gt; local_dof_indices</div><div class="ttdef"><b>Definition:</b> <a href="step-69_8cc_source.html#l00534">step-69.cc:534</a></div></div>
<div class="ttc" id="aclassFunction_html_ae316ebc05d21989d573024f8a23c49cb"><div class="ttname"><a href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">Function::vector_value</a></div><div class="ttdeci">virtual void vector_value(const Point&lt; dim &gt; &amp;p, Vector&lt; RangeNumberType &gt; &amp;values) const</div></div>
<div class="ttc" id="agroup__Exceptions_html_ga6060b2304b8600f5efa0d31eeda0207d"><div class="ttname"><a href="group__Exceptions.html#ga6060b2304b8600f5efa0d31eeda0207d">StandardExceptions::ExcDimensionMismatch</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcDimensionMismatch(std::size_t arg1, std::size_t arg2)</div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point&lt; dim &gt;</a></div></div>
<div class="ttc" id="achunk__sparse__matrix__0_8txt_html_a59317914f0b63e3c2c7c6bd150b8ba3e"><div class="ttname"><a href="chunk__sparse__matrix__0_8txt.html#a59317914f0b63e3c2c7c6bd150b8ba3e">matrix</a></div><div class="ttdeci">0&lt;/tt &gt;, which sets all elements of the matrix to zero, but keep the sparsity pattern previously used. *[0.x.66] *Reinitialize the sparse matrix with the given sparsity pattern. The latter tells the matrix how many nonzero elements there need to be reserved. Regarding memory allocation, the same applies as said above. You have to make sure that the lifetime of the sparsity structure is at least as long as that of this matrix or as long as reinit(const ChunkSparsityPattern &amp;) is not called with a new sparsity structure. The elements of the matrix are set to zero by this function. *[0.x.67] *Release all memory and return to a state just like after having called the default constructor. It also forgets the sparsity pattern it was previously tied to. *[0.x.68] *[2.x.18] Information on the matrix *[0.x.69] *Return whether the object is empty. It is empty if either both dimensions are zero or no ChunkSparsityPattern is associated. *[0.x.70] *Return the dimension of the codomain(or range) space. Note that the matrix is of dimension[2.x.19] . *[0.x.71] *Return the dimension of the domain space. Note that the matrix is of dimension[2.x.20] . *[0.x.72] *Return the number of nonzero elements of this matrix. Actually, it returns the number of entries in the sparsity pattern matrix</div><div class="ttdef"><b>Definition:</b> <a href="chunk__sparse__matrix__0_8txt_source.html#l00156">chunk_sparse_matrix_0.txt:156</a></div></div>
<div class="ttc" id="aclassFunctions_1_1ZeroFunction_html"><div class="ttname"><a href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2function_8h_source.html#l00516">function.h:516</a></div></div>
<div class="ttc" id="aclassTensor_html_a93ba01d979880b278cd4b573dd9c653b"><div class="ttname"><a href="classTensor.html#a93ba01d979880b278cd4b573dd9c653b">Tensor::l1_norm</a></div><div class="ttdeci">Number l1_norm(const Tensor&lt; 2, dim, Number &gt; &amp;t)</div><div class="ttdef"><b>Definition:</b> <a href="base_2tensor_8h_source.html#l02926">tensor.h:2926</a></div></div>
<div class="ttc" id="alac_2trilinos__sparse__matrix_8h_html"><div class="ttname"><a href="lac_2trilinos__sparse__matrix_8h.html">trilinos_sparse_matrix.h</a></div></div>
<div class="ttc" id="aclassQuadrature_html_af9f7d82770fa8126e19113f3e3db755b"><div class="ttname"><a href="classQuadrature.html#af9f7d82770fa8126e19113f3e3db755b">Quadrature::size</a></div><div class="ttdeci">unsigned int size() const</div></div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aauto__derivative__function__0_8txt_html_a870ed0ddfded063c8c8570352ef8c122"><div class="ttname"><a href="auto__derivative__function__0_8txt.html#a870ed0ddfded063c8c8570352ef8c122">vector_value</a></div><div class="ttdeci">*This class automatically computes the gradient of a function by employing numerical difference quotients This only if the user function does not provide the gradient function himself *The following example of an user defined function overloads and implements only the where the latter function employs numerical difference quotients *****If the user overloads and implements also the gradient of the users gradient function is called that the usage of the also applies to the see e g vector_value()</div></div>
<div class="ttc" id="anamespaceStep43_html_aa9d1d2a552ddb355d5871cbafc33c050"><div class="ttname"><a href="namespaceStep43.html#aa9d1d2a552ddb355d5871cbafc33c050">Step43::fractional_flow</a></div><div class="ttdeci">double fractional_flow(const double S, const double viscosity)</div><div class="ttdef"><b>Definition:</b> <a href="step-43_8cc_source.html#l00261">step-43.cc:261</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_adad35057b6e70ae37d4abe7878683d90"><div class="ttname"><a href="coding__conventions__0_8txt.html#adad35057b6e70ae37d4abe7878683d90">face</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per the child indices of the child cells adjacent to face</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="aclassStep43_1_1SaturationInitialValues_html_a523c8f9b3196dc1351e85af03e8ba1ad"><div class="ttname"><a href="classStep43_1_1SaturationInitialValues.html#a523c8f9b3196dc1351e85af03e8ba1ad">Step43::SaturationInitialValues::vector_value</a></div><div class="ttdeci">virtual void vector_value(const Point&lt; dim &gt; &amp;p, Vector&lt; double &gt; &amp;value) const override</div><div class="ttdef"><b>Definition:</b> <a href="step-43_8cc_source.html#l00143">step-43.cc:143</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeae4878b1e562785c1c196238a3f14e0">VectorTools::EvaluationFlags::min</a></div><div class="ttdeci">@ min</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00062">vector_tools_evaluate.h:62</a></div></div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2function_8h_source.html#l00140">function.h:140</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_ac639e1db0b03fc797eca55e266afa976"><div class="ttname"><a href="coding__conventions__0_8txt.html#ac639e1db0b03fc797eca55e266afa976">cell</a></div><div class="ttdeci">functions which clear bits or flags should be named[2.x.15] use[2.x.18] instead of *[2.x.19] In the implementation after each three empty lines are expected to enable better readability One empty line occurs in functions to group blocks of since two empty lines are not enough to visibly distinguish sufficiently that the code belongs to two different functions *[2.x.21] Whenever an integer variable can only assume nonnegative it is marked as unsigned The same applies to functions that can only return positive or zero values it should be marked even if passed by value we mark input parameters as const This aids as an additional documentation tool to clarify the intent of a which is often either involuntarily or poor style *[2.x.25] Whenever a function does not change any of the member variable of the embedding class it should be marked as const  *[2.x.27] Function and variable names may not consist of only one or two unless the variable is a pure counting index *[2.x.29] Type the number of children per cell</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00027">coding_conventions_0.txt:27</a></div></div>
<div class="ttc" id="anamespaceLAPACKSupport_html_a8edacd69ab93285f82b7f63c733a86b7"><div class="ttname"><a href="namespaceLAPACKSupport.html#a8edacd69ab93285f82b7f63c733a86b7">LAPACKSupport::N</a></div><div class="ttdeci">static const char N</div><div class="ttdef"><b>Definition:</b> <a href="lac_2lapack__support_8h_source.html#l00167">lapack_support.h:167</a></div></div>
<div class="ttc" id="anamespaceLinearAlgebraDealII_html_a571e5cecdb8196589b34055adb3d0293"><div class="ttname"><a href="namespaceLinearAlgebraDealII.html#a571e5cecdb8196589b34055adb3d0293">LinearAlgebraDealII::SparseMatrix</a></div><div class="ttdeci">SparseMatrix&lt; double &gt; SparseMatrix</div><div class="ttdef"><b>Definition:</b> <a href="lac_2generic__linear__algebra_8h_source.html#l00058">generic_linear_algebra.h:58</a></div></div>
<div class="ttc" id="aclassSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="lac_2solver__control_8h_source.html#l00052">solver_control.h:52</a></div></div>
<div class="ttc" id="aclassFEFaceValues_html"><div class="ttname"><a href="classFEFaceValues.html">FEFaceValues&lt; dim &gt;</a></div></div>
<div class="ttc" id="apolynomial__space__0_8txt_html_ac00ea19562c135512a6ff275a3cf0d8f"><div class="ttname"><a href="polynomial__space__0_8txt.html#ac00ea19562c135512a6ff275a3cf0d8f">j</a></div><div class="ttdeci">*Representation of the space of polynomials of degree at most n in higher dimensions *Given a vector of[1.x.0] one dimensional polynomials[1.x.1] where[1.x.3] has this class generates all dim dimensional polynomials of the where the sum and[1.x.8] is less than or equal *[1.x.9] The i e for each dim dimensional polynomial in the polynomial space it gives the indices j</div><div class="ttdef"><b>Definition:</b> <a href="polynomial__space__0_8txt_source.html#l00004">polynomial_space_0.txt:4</a></div></div>
<div class="ttc" id="abase_2vectorization_8h_html_aafbdfdd72b6cfe4eae5fa7a16385582f"><div class="ttname"><a href="base_2vectorization_8h.html#aafbdfdd72b6cfe4eae5fa7a16385582f">std::abs</a></div><div class="ttdeci">inline ::VectorizedArray&lt; Number, width &gt; abs(const ::VectorizedArray&lt; Number, width &gt; &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="base_2vectorization_8h_source.html#l05750">vectorization.h:5750</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdabaecdd1343aae63b652a2edeab0c19f9">VectorTools::EvaluationFlags::max</a></div><div class="ttdeci">@ max</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2vector__tools__evaluate_8h_source.html#l00056">vector_tools_evaluate.h:56</a></div></div>
<div class="ttc" id="aclassFunctions_1_1ConstantFunction_html_a6a3224d6e805fa73629130e021a7285b"><div class="ttname"><a href="classFunctions_1_1ConstantFunction.html#a6a3224d6e805fa73629130e021a7285b">Functions::ConstantFunction&lt; dim, double &gt;::value_list</a></div><div class="ttdeci">virtual void value_list(const std::vector&lt; Point&lt; dim &gt;&gt; &amp;points, std::vector&lt; double &gt; &amp;return_values, const unsigned int component=0) const override</div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut&lt; dim &gt;</a></div></div>
<div class="ttc" id="afunctions__0_8txt_html_af9f808a82e8c618e2e7a19dd08a9eae3"><div class="ttname"><a href="functions__0_8txt.html#af9f808a82e8c618e2e7a19dd08a9eae3">value</a></div><div class="ttdeci">****Functions are used in various places in deal for example to describe boundary coefficients in forcing or exact solutions Since closed form expressions for equations are often hard to pass along as function deal II uses the Function base class to describe these objects Essentially the interface of this base class requires derived classes to implement the ability to return the value of a function at one or a list of particular locations and function objects can then be used by algorithms like[2.x.1][2.x.2] and other functions *Some functions are needed again and and are therefore already provided in deal II This includes a function with a constant value</div><div class="ttdef"><b>Definition:</b> <a href="functions__0_8txt_source.html#l00007">functions_0.txt:7</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="avector__valued__0_8txt_html_aaee87206b92ccb284e9c77fa5d847637"><div class="ttname"><a href="vector__valued__0_8txt.html#aaee87206b92ccb284e9c77fa5d847637">velocities</a></div><div class="ttdeci">each of these vectors has[2.x.174] elements containing the values of the[2.x.175] velocities and the one pressure at a quadrature point *We can use these values to then construct other things like residuals the construct is a bit awkward we have a[2.x.176] which always looks strange It is also inefficient because it implies dynamic memory allocation for the outer vector as well as for all the inner vectors maybe we are only interested in the velocities</div><div class="ttdef"><b>Definition:</b> <a href="vector__valued__0_8txt_source.html#l00155">vector_valued_0.txt:155</a></div></div>
<div class="ttc" id="aclassLinearOperator_html_a030d8712cd4dbd814efbadca59c19bb3"><div class="ttname"><a href="classLinearOperator.html#a030d8712cd4dbd814efbadca59c19bb3">LinearOperator::vmult</a></div><div class="ttdeci">std::function&lt; void(Range &amp;v, const Domain &amp;u)&gt; vmult</div><div class="ttdef"><b>Definition:</b> <a href="lac_2linear__operator_8h_source.html#l00289">linear_operator.h:289</a></div></div>
<div class="ttc" id="aclassFESystem_html"><div class="ttname"><a href="classFESystem.html">FESystem&lt; dim &gt;</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gafc0ca7ad85b3ebd64e8e51689ac85caf"><div class="ttname"><a href="group__Exceptions.html#gafc0ca7ad85b3ebd64e8e51689ac85caf">AssertThrow</a></div><div class="ttdeci">#define AssertThrow(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01699">exceptions.h:1699</a></div></div>
<div class="ttc" id="alac_2trilinos__parallel__block__vector_8h_html"><div class="ttname"><a href="lac_2trilinos__parallel__block__vector_8h.html">trilinos_parallel_block_vector.h</a></div></div>
<div class="ttc" id="aclassIndexSet_html_ad28b2e725afda38ffdef1bf61d5cadd4"><div class="ttname"><a href="classIndexSet.html#ad28b2e725afda38ffdef1bf61d5cadd4">IndexSet::complete_index_set</a></div><div class="ttdeci">IndexSet complete_index_set(const IndexSet::size_type N)</div><div class="ttdef"><b>Definition:</b> <a href="base_2index__set_8h_source.html#l01094">index_set.h:1094</a></div></div>
<div class="ttc" id="anamespaceStep21_html_ae8b2203b16c46eea38479893233de7a1"><div class="ttname"><a href="namespaceStep21.html#ae8b2203b16c46eea38479893233de7a1">Step21::mobility_inverse</a></div><div class="ttdeci">double mobility_inverse(const double S, const double viscosity)</div><div class="ttdef"><b>Definition:</b> <a href="step-21_8cc_source.html#l00284">step-21.cc:284</a></div></div>
<div class="ttc" id="abase_2utilities__0_8txt_html_abdaf96304944a8787ae4488ed5461fac"><div class="ttname"><a href="base_2utilities__0_8txt.html#abdaf96304944a8787ae4488ed5461fac">rand</a></div><div class="ttdeci">for each remove leading and trailing spaces The default value of the delimiter is a so that the function splits comma separated lists of strings To make data input from tables if the input string ends in a then this last delimiter is ignored For **yields the same element list of output[2.x.37] as you would get if the input had been **or **As a consequence of this a call like **yields a one element list Because of the trimming of the single element is the empty string This function can digest the case that the delimiter is a space In this it returns all words in the string Combined with the rules this implies that **yields again the element list of output[2.x.38] from above despite the presence of space at the end of the string **yields an empty list regardless of the number of spaces in the string **Specialization of usually a documentation or and try to break it into individual lines of text at most[2.x.39] characters by breaking at positions marked by[2.x.40] in the text If this is not return the shortest lines that are longer than[2.x.41] The default value of the delimiter is a space character If original_text contains newline the string is split at these too **Return true if the given pattern string appears in the first position of the string **Read and return this integer as a pair together with how many characters it takes up in the string If no integer can be read at the indicated return *[2.x.43] *Return a string with all occurrences of[2.x.44] in[2.x.45] replaced by *[2.x.46] *Return a string with all standard whitespace i it can safely be called from multiple threads at the same time In each thread will get the same sequence of numbers every time On the other if you run[2.x.50] objects via the Threading Building then tasks will be assigned to mostly random and may get a different sequence of random numbers in different runs of the since a previous task may already have consumed the first few random numbers generated for the thread you re on If this is a you need to create your own random number generator objects every time you want to start from a defined point *Like the system function rand()</div></div>
<div class="ttc" id="afe_2fe__values__0_8txt_html_a15ff2e0c168966d6ae13c4faabcec165"><div class="ttname"><a href="fe_2fe__values__0_8txt.html#a15ff2e0c168966d6ae13c4faabcec165">dofs_per_cell</a></div><div class="ttdeci">we have to work a bit harder to compute this information **Default constructor Creates an invalid object **Constructor for an object that represents a single scalar component of a FEValuesBase for the shape function and quadrature point selected by the arguments[2.x.27] shape_function Number of the shape function to be evaluated Note that this number runs from zero to dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values__0_8txt_source.html#l00073">fe_values_0.txt:73</a></div></div>
<div class="ttc" id="aparsed__convergence__table__0_8txt_html_a8a90f5ba57a42a3fd4c067e00f8b8aea"><div class="ttname"><a href="parsed__convergence__table__0_8txt.html#a8a90f5ba57a42a3fd4c067e00f8b8aea">p</a></div><div class="ttdeci">****This class simplifies the construction of convergence tables reading the options for the generation of the table from a parameter file It provides a series of methods that can be used to compute the error given a reference exact solution or the difference between two numerical solutions or any other custom computation of the error given via[2.x.1] objects *An example usage of this class is given by ****The above code constructs a ParsedConvergenceTable that works for scalar and will produce an error table with and Linfty_norm norms of the error *Whenever a call to the methods the instance of this class inspects its parameters computes all norms specified by the parameter given at construction time possibly modified via a parameter file computes all extra column entries specified using the method and writes one row of the convergence table *Once you have finished with the a call to and to the the same code can be used to estimate the errors of mixed or multi physics e and one component for the pressure field p</div><div class="ttdef"><b>Definition:</b> <a href="parsed__convergence__table__0_8txt_source.html#l00020">parsed_convergence_table_0.txt:20</a></div></div>
<div class="ttc" id="agrid_2grid__generator_8h_html"><div class="ttname"><a href="grid_2grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="atable__0_8txt_html_aa889bb34debce4db8c9ace2f875bdf0d"><div class="ttname"><a href="table__0_8txt.html#aa889bb34debce4db8c9ace2f875bdf0d">component</a></div><div class="ttdeci">tables that store three or more dimensional then there is nothing you can do about the size of these if your program is parallelized via then a typical first implementation would create a table object on every process and fill it on every MPI process by reading the data from a file This is inefficient from two the data stored on every process is the and while every process needs to be able to read from a it is not necessary that every process stores its own either by re creating a copy of the table in the other processes memory space if by creating copies in shared memory once for all processes located on each of the machines used by the MPI job ******Integer type used to count the number of elements in this container **Default constructor Set all dimensions to zero **Constructor Initialize the array with the given dimensions in each index component **Constructor Initialize the array with the given dimensions in each index component</div><div class="ttdef"><b>Definition:</b> <a href="table__0_8txt_source.html#l00083">table_0.txt:83</a></div></div>
<div class="ttc" id="aclassUtilities_1_1MPI_1_1MPI__InitFinalize_html"><div class="ttname"><a href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2mpi_8h_source.html#l00836">mpi.h:836</a></div></div>
<div class="ttc" id="acoding__conventions__0_8txt_html_a02f5aa616d7b0799c538fe77d6c6c795"><div class="ttname"><a href="coding__conventions__0_8txt.html#a02f5aa616d7b0799c538fe77d6c6c795">e</a></div><div class="ttdeci">i e</div><div class="ttdef"><b>Definition:</b> <a href="coding__conventions__0_8txt_source.html#l00028">coding_conventions_0.txt:28</a></div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
